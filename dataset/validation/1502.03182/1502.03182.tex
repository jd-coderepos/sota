\section{Experiments} \label{sec:Experiments}

\subsection{Data collection} \label{sec:data-collection}
Our experiments required collecting real power consumption data from smartphone devices along
different routes. We developed the PowerSpy android application\footnote{Source code can be obtained from \newline
  \textcolor{blue}{\url{https://bitbucket.org/ymcrcat/powerspy}}.}
that collects various
measurements including signal strength, voltage, current, GPS coordinates, temperature,
state of discharge (battery level) and cell identifier.
The recordings were performed using Nexus 4, Nexus 5 and HTC mobile devices.

\subsection{Assumptions and limitations}

Exploring the limits of our attack, i.e.\ establishing the minimal necessary conditions for it to work,
is beyond our resources. For this reason, we state the assumptions on which we rely in our methods.

We assume there is enough variability in power consumption along a route to exhibit unique features.
Lack of variability may be due to high density of cellular antennas that flatten the signal strength profile.
We also assume that enough communication is occurring for the signal strength to have an effect on
power consumption.
This is a reasonable assumption, since background synchronization of data happens frequently in
smartphone devices. Moreover, the driver might be using navigation software or streaming music.
However, at this stage, it is difficult to determine how inconsistent phone usage across different rides will
affect our attacks.

Identifying which route the user took involves understanding which
power measurements collected from her mobile device occurred during
driving activity.  Here we simply assume that we can identify driving
activity.  Other works (e.g.,~\cite{Mohan2008}) address this question
by using data from other sensors that require no permissions, such as
gyroscopes and accelerometers.

Some events that occur while driving, such as an incoming phone call,
can have a significant effect on power consumption.
Figure~\ref{fig:phone-call} shows the power profile of a device at
rest when a phone call takes place (the part marked in red).  The peak
immediately after the phone call is caused by using the phone to
terminate the phone call and turn off the display.  We can see that
this event appears prominently in the power profile and can cope with
such transient effects by identifying and truncating peaks that stand
out in the profile.  In addition, smoothing the profile by a moving
average should mitigate these transient effects.

\begin{figure}
    \centering
    \includegraphics[width=0.4\textwidth]{figures/phone_call_profile}
    \caption{Power profile with a phone call occurring between 50-90 seconds.
        Profile region during phone call is marked in red.}
    \label{fig:phone-call}
\end{figure}
 
\subsection{Route distinguishability}
To evaluate the algorithm for distinguishing routes (\cref{sec:route-distinguishability})
we recorded reference profiles for multiple different routes.
The profiles include measurements from both Nexus 4 and Nexus 5 models.
In total we had a dataset of 294 profiles, representing 36 unique routes.
Driving in different directions along the same roads (from point A to B vs. from point B to A)
is considered two different routes.
We perform cross validation using multiple iterations (100 iterations),
each time using a random portion of the profiles as a training set, and requiring
equal number of samples for each possible class.
The sizes of the training and test sets depend on how many reference routes per profile we require
each time. Naturally, the more reference profiles we have, the higher the identification rate.

One evaluation round included 29 unique routes, with only 1 reference profile per route in the training
set, and 211 test routes. It resulted in correct identification rate of 40\%.
That is compared to the random guess probability of only 3\%.
Another round included 25 unique routes, with 2 reference profiles per route in the training set
and 182 routes in the test set, and resulted in correct identification rate of 53\%
(compared to the random guess probability of only 4\%).
Having 5 reference profiles per route (for 17 unique routes) raises the identification rate to 71\%,
compared to the random guess probability of 5.8\%. And finally, for 8 reference profiles per route we get
85\% correct identification.
The results are summarized in \cref{tab:route-distinguishability-eval}.

We can see that an attacker can have a significant advantage in guessing the route taken
by a user.

\begin{table*}
    \centering
    \begin{tabular}{cccccc}
     {\bf \# Unique Routes} &  {\bf \# Ref. Profiles/Route} &  {\bf \# Test Routes} &
     {\bf Correct Identification \%} &  {\bf Random Guess \%} \\
        \hline
          8 &           10 &          55 &       85 &           13 \\
         17 &            5 &         119 &       71 &            6 \\
         17 &            4 &         136 &       68 &            6 \\
         21 &            3 &         157 &       61 &            5 \\
         25 &            2 &         182 &       53 &            4 \\
         29 &            1 &         211 &       40 &            3 \\
    \end{tabular}
    \caption{Route distinguishability evaluation results. First column indicates the number of
    unique routes in the training set. Second column indicates the number of training samples per route
    at the attacker's disposal. Number of test routes indicates the number of power profiles
    the attacker is trying to classify.
    Correct identification percentage indicates the percentage of correctly identified routes as
    a fraction of the third column (test set size),
    which could be then compared to the expected success of random guessing in
    the last column.}
    \label{tab:route-distinguishability-eval}
\end{table*}



\subsection{Real-time mobile device tracking}
We evaluate the algorithm for real-time mobile device tracking (\cref{sec:mobile-device-tracking})
using a set of 10 training profiles and an additional test profile.
The evaluation simulates the conditions of real-time
tracking by serially feeding samples to the algorithm as if they are received
from an application installed on the device.
We calculate the estimation error, i.e.\ the distance between the estimated coordinates
and the true location of the mobile device at each step of the simulation.
We are interested in the \emph{convergence time}, i.e.\ the number of samples it takes
until the location estimate is close enough to the true location, as well as in the distribution
of the estimation errors given by a histogram of the absolute values of the distances.

Figure \ref{fig:tracking-error} illustrates the performance of our tracking algorithm for
one of the routes, which was about 19 kilometers long.
At the beginning, when there are very few power samples, the location estimation is extremely inaccurate,
but after two minutes we lock on the true location.
We obtained a precise estimate from 2 minutes up until 20 minutes on the route,
where our estimate slightly diverges, due to increased velocity on a freeway segment.
Around 26 minutes (in figure \ref{fig:est-error}) we have a large estimation error,
but as we mentioned earlier, these kind of errors are easy to prevent by imposing a simple motion model
(\cref{sec:improved-tracking}).
Most of the errors are small compared to the length of the route: 80\% of the estimation errors are less than 1 km.

\begin{figure*}
  \centering
  \begin{subfigure}{0.4\textwidth}
    \includegraphics[width=\textwidth]{figures/tracking_est_error}
    \caption{Convergence to true location.}
    \label{fig:est-error}
  \end{subfigure}
  \hspace{2cm}
  \begin{subfigure}{0.4\textwidth}
      \includegraphics[width=\textwidth]{figures/tracking_est_error_improved}
      \caption{Location estimation error for improved tracking algorithm.}
      \label{fig:tracking-error-improved}
  \end{subfigure}

  \caption{Location estimation error for online tracking.}
  \label{fig:tracking-error}
\end{figure*}

\begin{figure*}
    \centering

    \begin{subfigure}{0.4\textwidth}
      \includegraphics[width=\textwidth]{figures/tracking_est_err_hist_improved}
      \caption{Errors histogram. Almost 90\% of the errors are less than 1 km.}
    \end{subfigure}
    \hspace{2cm}
    \begin{subfigure}{0.4\textwidth}
      \includegraphics[width=\textwidth]{figures/tracking_est_err_cdf_improved}
      \caption{Error cumulative distribution.}
    \end{subfigure}

    \caption{Estimation errors distribution for motion-model tracking.}
    \label{fig:error-distribution}
\end{figure*}

We also tested the improved tracking algorithm explained in \cref{sec:improved-tracking}.
Figure \ref{fig:tracking-error-improved} presents the estimation error over time,
and we can see that the big errors towards the end of the route that appeared in
\ref{fig:est-error} are not present in \cref{fig:tracking-error-improved}. Moreover, now almost 90\% of the estimation
errors are below 1 km (\cref{fig:error-distribution}).

We provide animations visualizing our results for real-time tracking at the following links.
The animations, generated using our estimations of the target's location, depict
a moving target along the route and our estimation of its location.
The first one corresponds to the method described in \ref{sec:dtw-tracking},
and the second to the one described in \ref{sec:improved-tracking} that uses the
motion model based correction: \newline
\textcolor{blue}{\url{crypto.stanford.edu/powerspy/tracking1.mov}} \newline
\textcolor{blue}{\url{crypto.stanford.edu/powerspy/tracking2.mov}}

\subsubsection{OSB vs. DTW}
We compare the performance of Dynamic Time Warping to that of Optimal Subsequence Bijection (\cref{sec:osb}).
Figure \ref{fig:dtw_vs_osb} present such a comparison for the same route, using two different recordings.
The tracking was performed without compensating for errors using a motion model, to evaluate the performance
of the subsequence matching algorithms as they are.
We can see that, in both cases, Optimal Subsequence Bijection outperforms the standard Subsequence-DTW most of the time.
Therefore, we suggest that further experimentation with OSB could potentially be beneficial for this task.

\begin{figure}
   \centering
   \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\textwidth]{figures/osb_vs_dtw-20140619_190335}
   \end{subfigure}
   \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\textwidth]{figures/osb_vs_dtw-20140708_201626}
   \end{subfigure}
   \caption{Comparison of DTW and OSB for real-time tracking.}
   \label{fig:dtw_vs_osb}
\end{figure}

\subsection{Inference of new routes}
\subsubsection{Setup}

For the evaluation of the particle filter presented in Section~\ref{sec:newroutes} we considered an area
 depicted in Figure~\ref{fig:area}. The area has 13 intersections
having 35 road segments\footnote{Three of the segments are one way streets.}. The
average length of a road segment is about 400 meters. The average travel time over the segments is around 70
seconds. The area is located in the center of Haifa, a city located in northern Israel, having a population density comparable to Philadelphia or Miami. 
Traffic congestion in this area varies across segments and time of day.
For each power recording, the track traversed at least one congested segment.
Most of the 13 intersections have traffic lights, and about a quarter of the road segments pass through them.

We had three pre-recording sessions which in total covered all segments. Each road segment was entered from every possible direction to account for the hysteresis effects.
The pre-recording sessions were done using the same Nexus 4 phone.

\begin{figure}
    \centering
    \includegraphics[width=0.35\textwidth]{figures/area}
    \caption{Map of area and intersections for route inference.}
    \label{fig:area}
\end{figure}

We set the following  parameters of the HMM (as they are defined in Appendix~\ref{sec:model}):
\begin{enumerate}
    \item  -- This set defines the transition probabilities between the road segments.
    We set these probabilities to be uniformly distributed over all possible transitions.
    Namely, .
    \item  -- This set defines the distribution of power profile observations over each state.
    These probabilities depend on the road segments and their location relative to the nearby based stations.
    We do not need an explicit formulation of these probabilities to employ the particle filter.
    The likelihood of a a power profile to be associated with a road segment is estimated by the DTW distance of
    the power profile to prerecorded power profiles of that segment.
    \item  -- This set defines the initial state distribution.
    We assume that the starting intersection of the tracked device is known.
    This applies to scenarios where the tracking begins from well-known locations, such as the user's home,
    office, or another location the attacker knows in advance.
\end{enumerate}

For testing, we used 4 phones: two Nexus 4 (different from the one used for the pre-recordings), a \mbox{Nexus 5} and an HTC Desire.
Each phone was used to record the power profile of a different route.
The four routes combined cover almost all of the road segments in the area.
Table~\ref{tab:TestRoutes} details the routes by their corresponding sequences of intersection identifiers. 
These route recordings were done on different days, different time of day and varying weather conditions.

As noted, we can only measure the aggregate power consumption which can be significantly affected by applications that run continuously. 
To have a better sense of the effects of these applications the phones were run with different number of background applications. \mbox{Nexus 4 \#1}, 
\mbox{Nexus 5} and HTC Desire have a relatively modest number of applications which included (beyond the default Android apps): Email (corporate account), Gmail, and Google Calender. Nexus 4 \#2 has a much higher number of application which included on top of the applications of phone \#1: Facebook, Twitter, Skype, Waze, and WhatsApp. All those applications periodically send and receive traffic.

\begin{table}
	\centering
	\small
	\begin{tabular}{|c|c|}
		\hline
		Phone & Track \\
		\hline
		Nexus 4 \#1 & 8-5-6-7-1-2-3-4-5-6-4-3-2-1-7-8\\
		\hline
		Nexus 4 \#2 & 7-1-2-3-4-5-8-7-6-5-4-2-1-7-8\\
		\hline
		Nexus 5 & 3-2-4-9-10-12-11-9-4-5-6-4-3-2-1-7-6-5-8-7\\
		\hline
		HTC Desire & 10-12-11-9-4-2-1-7-6-5-8\\
    \hline
	\end{tabular}
	\normalsize
	\caption{Test Routes}
	\label{tab:TestRoutes}
\end{table}

For each of the four tracks we derived all possible sub-tracks having 3 to 7 road segments. We estimated each such sub-track.
In total we estimated around 200 sub-tracks. For each sub-track we
employed Algorithms~\ref{alg:new-route-particle-filter} and \ref{alg:iterative-majority-vote} to get two best
estimates for the sub-track.

\Cref{tab:DestinationLocalization,tab:LevenshteinDistance,tab:ExactFullRouteFit} summarize the results of route estimation for each of
the four phones. For each route we have two alternatives for picking an estimate (1) the most frequent route in
the particle set as output by Algorithm~\ref{alg:new-route-particle-filter}; (2) the route output by Algorithm~\ref{alg:iterative-majority-vote}.
For each alternative we note the road segment in which the phone is estimated to be after the completion of its track and compare it with the final road segment of the true route. This allows us to measure the accuracy of the algorithm for estimating the location of the user's destination (the end of the track). This is the most important metric for many attack scenarios where the attacker wishes to learn the destination of the victim.

In some cases it may also be beneficial for the attacker to know the actual route through which the victim traversed on his way to the destination.
For this purpose, we also calculate for each alternative estimate the Levenshtein distance between it and the true route. The Levenshtein distance is a standard metric for measuring the difference between two sequences~\cite{levenshtein1966binary}. It equals the minimum number of updates required in order to change one sequence to the next.
In this context, we treat a route as a sequence of intersections.
The distance is normalized by the length of the longer route of the two. This allows us to measure the accuracy of the algorithm for estimating the full track the user traversed.
For each estimate we also note whether it is an exact fit with the true route (i.e., zero distance).
The percentage of successful localization of destination, average Levenshtein distance and percentage of exact full route fits are calculated for each type of estimated route.
We also calculate these metrics for both estimates combined while taking into account for each track the best of the two estimates.
To benchmark the results we note in each table the performance of a random estimation algorithm which simply outputs a random, albeit feasible, route.


\begin{table}
	\centering
	\small
		\begin{tabular}{c|c|c|c|c|}
			\cline{2-5}
			& random & frequent & Alg.~\ref{alg:iterative-majority-vote} & combined \\
			\hline
			\multicolumn{1}{|c|}{Nexus 4 \#1} & 33\% & 65\% & 48\% & 80\% \\
			\hline
			\multicolumn{1}{|c|}{Nexus 4 \#2} & 31\% & 48\% & 56\% & 72\% \\
			\hline
			\multicolumn{1}{|c|}{Nexus 5} & 20\% & 33\% & 32\% & 55\% \\
			\hline
			\multicolumn{1}{|c|}{HTC Desire} & 22\% & 40\% & 41\% & 65\% \\
			\hline
		\end{tabular}
		\normalsize
	\caption{Destination localization}
	\label{tab:DestinationLocalization}
\end{table}

The results in Table~\ref{tab:DestinationLocalization} show the accuracy of destination identification. It is evident that the performance of the most frequent
route output by the particle filter is comparable to the performance of the best estimate output by
Algorithm~\ref{alg:iterative-majority-vote}.
However, their combined performance is significantly better than either estimates alone and predict more accurately the final destination of the phone.
This result suggests that Algorithm~\ref{alg:iterative-majority-vote} extracts significant amount of information from
the routes output by the particle filter beyond the information gleaned from the most frequent route.

Table~\ref{tab:DestinationLocalization}  indicates that for Nexus 4 \#1 the combined route estimates were able to identify the final road segment for
80\% of all scenarios. For Nexus 4 \#2 which was running many applications the final destination  estimates are somewhat less accurate (72\%). 
This is attributed to the more noisy measurements of the aggregate power consumption. 
The accuracy for the two models -- Nexus 5 and HTC Desire -- is lower than the accuracy achieved for Nexus 4. Remember that all our pre-recordings were done using a Nexus 4. These results may indicate that the power consumption profile of the cellular radio is dependent on the phone's model. Nonetheless, for both phones we achieve significantly higher accuracy of destination localization (55\% and 65\%) as compared to the random case (about 20\%).


\Cref{tab:LevenshteinDistance,tab:ExactFullRouteFit} present measures -- Levenshtein distance and exact full route fit -- of the accuracy of estimates for the full route the phone took to its destination. Here, again, the algorithm presented for Nexus 4 \#1 superior performance. It was able to exactly estimate 45\% of the full route to the destination. On the other hand, for the more busy Nexus 4 \#2 and the other model phones the performance was worse. It is evident from the results that for these three phones the algorithm had difficulties producing an accurate estimate of the full route. Nonetheless, in all cases the accuracy is always markedly higher than that of the random case.


\begin{table}
	\centering
	\small
		\begin{tabular}{c|c|c|c|c|}
			\cline{2-5}
			& random & frequent & Alg.~\ref{alg:iterative-majority-vote} & combined \\
			\hline
			\multicolumn{1}{|c|}{Nexus 4 \#1} & 0.61 & 0.38 & 0.27 & 0.24 \\
			\hline
			\multicolumn{1}{|c|}{Nexus 4 \#2} & 0.63 & 0.61 & 0.59 & 0.52 \\
			\hline
			\multicolumn{1}{|c|}{Nexus 5} & 0.68 & 0.6 & 0.55 & 0.45 \\
			\hline
			\multicolumn{1}{|c|}{HTC Desire} & 0.65 & 0.59 & 0.5 & 0.45 \\
			\hline
		\end{tabular}
		\normalsize
	\caption{Levenshtein distance}
	\label{tab:LevenshteinDistance}
\end{table}

\begin{table}
	\centering
	\small
		\begin{tabular}{c|c|c|c|c|}
			\cline{2-5}
			& random & frequent & Alg.~\ref{alg:iterative-majority-vote} & combined \\
			\hline
			\multicolumn{1}{|c|}{Nexus 4 \#1} & 4\% & 38\% & 22\% & 45\% \\
			\hline
			\multicolumn{1}{|c|}{Nexus 4 \#2} & 5\% & 8.5\% & 5\% & 15\% \\
			\hline
			\multicolumn{1}{|c|}{Nexus 5} & 3\% & 15\% & 9\% & 20\% \\
			\hline
			\multicolumn{1}{|c|}{HTC Desire} & 5\% & 10\% & 12\% & 17\% \\
			\hline
		\end{tabular}
		\normalsize
	\caption{Exact full route fit}
	\label{tab:ExactFullRouteFit}
\end{table}


To have a better sense of the distance metric used to evaluate the quality of the estimated routes Figure~\ref{fig:distance-error} depicts three cases of estimation errors and their corresponding distance values in increasing order. It can be seen that even  estimation error having relatively high distances can have a significant amount of information regarding the true route.

\begin{figure*}
  \centering
  \begin{subfigure}{0.3\textwidth}
    \includegraphics[width=\textwidth]{figures/dist0125map}
    \caption{Distance = 0.125}
  \end{subfigure}
  \hspace{0.1cm}
  \begin{subfigure}{0.3\textwidth}
    \includegraphics[width=\textwidth]{figures/dist025map}
    \caption{Distance = 0.25}
  \end{subfigure}
  \hspace{0.1cm}
  \begin{subfigure}{0.31\textwidth}
    \includegraphics[width=\textwidth]{figures/dist042map}
    \caption{Distance = 0.43}
  \end{subfigure}
  \caption{Examples of estimation errors and their corresponding distances (partial map is depicted). The true route is green and the
  estimated route is red.}
  \label{fig:distance-error}
\end{figure*}
