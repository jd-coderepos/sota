\documentclass[sigconf]{acmart}





\AtBeginDocument{\providecommand\BibTeX{{\normalfont B\kern-0.5em{\scshape i\kern-0.25em b}\kern-0.8em\TeX}}}



\copyrightyear{2021} 
\acmYear{2021} 
\setcopyright{acmcopyright}\acmConference[MM '21]{Proceedings of the 29th ACM International Conference on Multimedia}{October 20--24, 2021}{Virtual Event, China}
\acmBooktitle{Proceedings of the 29th ACM International Conference on Multimedia (MM '21), October 20--24, 2021, Virtual Event, China}
\acmPrice{15.00}
\acmDOI{10.1145/3474085.3475372}
\acmISBN{978-1-4503-8651-7/21/10}

\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{subfigure}
\usepackage{multirow}
\usepackage{color}
\usepackage{balance}







\acmSubmissionID{1218}


\settopmatter{printacmref=true}
\begin{document}
\fancyhead{}
\title{ASFD: Automatic and Scalable Face Detector}





\author{Jian Li}
\authornote{Both authors contributed equally to this research.}
\email{swordli@tencent.com}
\affiliation{\institution{Tencent Youtu Lab}
  \city{Shanghai}
  \country{China}
}

\author{Bin Zhang}
\authornotemark[1]
\email{z-bingo@seu.edu.cn}
\affiliation{\institution{Southeast University}
  \city{Nanjing}
  \country{China}
}

\author{Yabiao Wang}
\email{caseywang@tencent.com}
\affiliation{\institution{Tencent Youtu Lab}
  \city{Shanghai}
  \country{China}
}

\author{Ying Tai}
\email{yingtai@tencent.com}
\affiliation{\institution{Tencent Youtu Lab}
  \city{Shanghai}
  \country{China}
}

\author{Zhenyu Zhang}
\email{joeyzyzhang@tencent.com}
\affiliation{\institution{Tencent Youtu Lab}
  \city{Shanghai}
  \country{China}
}


\author{Chengjie Wang}
\email{jasoncjwang@tencent.com}
\affiliation{\institution{Tencent Youtu Lab}
  \city{Shanghai}
  \country{China}
}

\author{Jilin Li}
\email{jerolinli@tencent.com}
\affiliation{\institution{Tencent Youtu Lab}
  \city{Shanghai}
  \country{China}
}

\author{Xiaoming Huang}
\email{skyhuang@tencent.com}
\affiliation{\institution{Tencent Youtu Lab}
  \city{Shanghai}
  \country{China}
}


\author{Yili Xia}
\authornote{Correspondence author.}
\email{yili_xia@seu.edu.cn}
\affiliation{\institution{Southeast University}
  \city{Nanjing}
  \country{China}
}















\begin{abstract}
Along with current multi-scale based detectors, Feature Aggregation and Enhancement (FAE) modules have shown superior performance gains for cutting-edge object detection. However, these hand-crafted FAE modules show inconsistent improvements on face detection, which is mainly due to the significant distribution difference between its training and applying corpus, \textit{i.e.} COCO vs. WIDER Face.
To tackle this problem, we essentially analyse the effect of data distribution, and consequently propose to search an effective FAE architecture, termed AutoFAE by a differentiable architecture search, which outperforms all existing FAE modules in face detection with a considerable margin.
Upon the found AutoFAE and existing backbones, a supernet is further built and trained, which automatically obtains a family of detectors under the different complexity constraints.
Extensive experiments conducted on popular benchmarks, \textit{i.e.} WIDER Face and FDDB, demonstrate the state-of-the-art performance-efficiency trade-off for the proposed automatic and scalable face detector (ASFD) family. In particular, our strong ASFD-D outperforms the best competitor with AP  on WIDER Face test, and the lightweight ASFD-D costs about  ms, \textit{i.e.} more than  FPS, on the V100 GPU with VGA-resolution images.
\end{abstract}



\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10010147.10010178.10010224.10010245.10010250</concept_id>
<concept_desc>Computing methodologies~Object detection</concept_desc>
<concept_significance>500</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Computing methodologies~Object detection}

\keywords{face detection, neural architecture search, multi-task loss, compound scaling}



\maketitle

\section{Introduction}

\begin{figure}
    \centering
    \includegraphics[width=0.98\linewidth]{./pic/trade-off.pdf}
    \caption{Performance-efficiency trade-off on WIDER Face validation for different face detectors. The proposed ASFD outperforms a range of state-of-the-art methods.}
    \label{fig:trade_off}
\end{figure}

Face detection serves as a fundamental step towards various face-related applications, such as face alignment ~\cite{tai2019towards}, face recognition \cite{huang2020curricularface} and face analysis \cite{pan2018mean}. It aims locate the face region (if any) in a given image, which has been a long standing research topic ranging from \cite{viola2004robust} to deep learning based methods \cite{zhang2017s3fd,chi2019srn}.

Beyond the scope of face, general object detection has been significantly pushed by the development of deep convolution neural networks \cite{simonyan2014vgg,he2016resnet,ren2015faster,liu2016ssd}. Among one of the representative framework, single-stage anchor-based detector with pyramid features has been thoroughly studied recently \cite{liu2016ssd,lin2017focal} and is dominant for face detection \cite{zhang2017s3fd,chi2019selective,tang2018pyramidbox,li2019dsfd,zhang2020refineface}. In this framework, the regular and dense anchors with different scales and aspect ratios are tiled over all locations of the feature map, and the pyramid features are extracted by the backbone and enhanced by the neck, which is subsequently plugged with both classification and regression branches.


\begin{figure*}[!t]
    \centering
    \subfigure[]{\includegraphics[width=0.32\linewidth]{./pic/fae_comparison.pdf}}
    \subfigure[]{\includegraphics[width=0.32\linewidth]{./pic/scale_cdf.pdf}}
    \subfigure[]{\includegraphics[width=0.32\linewidth]{./pic/density_cdf.pdf}}
    \caption{(a) Comparison of our AutoFAE against other FAE modules on WIDER Face and COCO validation. The performance gaps with the baseline are indicated by blue and orange bars respectively, and RetinaNet is adopted as the baseline.
    (b) Cumulative distribution function (CDF) of the relative scale of bounding boxes.  of objects in COCO have a relative scale below . For the same scale, the proportion in WIDER Face is , while for a similar proportion,  of faces in WIDER Face are less than .
    (c) CDF of the number of boxes in each image. The distribution of images containing more than  boxes for WIDER Face is long-tailed, \textit{e.g.}  of images in COCO have less than  objects, while there are many images in WIDER Face that contain more than  faces.
    }
    \label{fig:gap_coco_widerface}
\end{figure*}

Towards the design of Feature Aggregation and Enhancement (FAE) modules for these methods, Feature Pyramid Network (FPN) and its variants aggregate hierarchical features via the preset pathway, \textit{e.g.} top-down and bottom-up path, to effectively fuse multi-scale features \cite{tang2018pyramidbox,tan2020efficientdet,liu2018pafpn,li2019dsfd,zhang2020acfd}. For another instance, ASPP \cite{chen2017aspp,qiao2020detectors}, RFB \cite{liu2018rfb} and RFE \cite{deng2019retinaface} modules are proposed to enhance the feature representation by adjusting the effective receptive fields. Recently, Neural Architecture Search (NAS) has been also investigated for object detection, which has achieved remarkable performance gains, such as NAS-FPN \cite{ghiasi2019nasfpn}, AutoFPN \cite{xu2019autofpn} and NAS-FCOS \cite{wang2019nasfcos}. However, such a gain is severely not generalized when applying to face detection.

Fig.~\ref{fig:gap_coco_widerface} (a) shows a quantitative investigation of the cutting-edge FAE modules discussed above, in which the significant drops have been shown when they are applied to face domain. Even the automatic learning based method, \textit{a.k.a.} NAS-FCOS \cite{wang2019nasfcos} that performs  lower than the baseline. This phenomenon highlights the domain gap between general object and face detection. To explain, we utilize cumulative distribution function to model the corresponding datasets, \textit{e.g.} WIDER Face \cite{yang2016wider} and COCO \cite{lin2014coco} in terms of the relative size of boxes and the number of boxes in each image, as presented in Fig.~\ref{fig:gap_coco_widerface} (b) and (c) respectively. As a result, the relative scale of faces is much smaller than objects in generic object detection, and there are more faces in each image than objects in COCO.
These characteristics also determine the design principles of modern face detectors. For instance, the shallower feature map is adopted to detect the small faces. And more predicted results are retained before and after the non-maximum-suppression for the high recall rate. Since FAE modules designed for generic object detectors are weak when dealing with small-scale and crowded objects, therefore, false positives inevitably exist when they are applied to face domain, resulting in performance degradation.





In this paper, a novel NAS based face detector framework termed Automatic and Scalable Face Detector (ASFD) is introduced, which is designed upon the basis of quantitative observations as above. 
The proposed ASFD is equipped with an effective FAE module, namely AutoFAE, which is discovered in a face-suitable search space, and then automatically scaled up/down to meet different requirements.
In particular, we first analyze why the domain gap between the generic object and face detection would cause such an impact as Fig.~\ref{fig:gap_coco_widerface} (a). The performance degradation in the face domain is caused by the large semantic differences and unreasonable receptive fields for aggregated features.
Then, we propose a face-suitable search space that aggregates a feature with similar-scale ones and enriches the feature presentation with different operations for different pyramid levels. And the AutoFAE module is searched by a gradient-NAS method \cite{liu2018darts,xu2019pcdarts}, and can achieve consistent gains on both face detection and generic object detection, as presented in Fig.~\ref{fig:gap_coco_widerface} (a). 
Finally, we build a supernet consisting of the found AutoFAE and a series of backbones, \textit{e.g.} ResNet \cite{he2016resnet}, and automatically obtain the proposed ASFD family to meet different complexity constraints via a one-shot NAS \cite{guo2019spos,chu2019fairnas}.
It is worth noting that the ASFD family achieves the state-of-the-art performance-efficiency trade-off, as presented in Fig.~\ref{fig:trade_off} \cite{yoo2019extd,chi2019srn,tang2018pyramidbox,li2019dsfd,zhang2020refineface}. Especially, the lightweight ASFD-D can run more than  FPS with VGA-resolution images on a V GPU, and the strong ASFD-D obtains the highest AP scores on popular benchmarks, \textit{i.e.} WIDER Face and FDDB. To sum up, this work makes following contributions:


\begin{itemize}
\item We observe an interesting phenomenon that some previous FAE modules perform well in generic object detection but fail in face detection, and conduct extensive experiments to illustrate why this phenomenon occurs.
    \item Based on the observations, we design a face-suitable search space for feature aggregation and enhancement modules, and discover an effective and generalized AutoFAE module via a joint searching method.
    \item Extensive experiments conducted on the popular benchmarks demonstrate the better performance-efficiency trade-off of the proposed ASFD.
\end{itemize}

\section{Related Work}
\subsection{Feature Aggregation and Enhancement.}
In recent years, generic object detection and face detection have been dominated by deep learning based methods. SSD \cite{liu2016ssd} is the first to predict objects using the multi-scale pyramid features, FPN \cite{lin2017fpn} proposes to enrich the feature presentation of multi-scale features by a top-down pathway. Recently, many works are devoted to how to aggregate and enhance multi-scale features effectively. \cite{liu2018pafpn} and \cite{tan2020efficientdet} enhance the entire feature hierarchy by the bottom-up path augmentation. \cite{qiao2020detectors} proposes a novel recursive FPN that incorporates extra feedback connections from FPN into the bottom-up backbone layers. 
Nowadays, NAS-based methods have demonstrated much success in exploring a better architecture for feature fusion and refinement \cite{xu2019autofpn,wang2019nasfcos,ghiasi2019nasfpn}.
Besides, feature enhancement modules are also be widely studied. Inception \cite{szegedy2017inception,szegedy2016rethinking} aims to capture different size of receptive fields via a multi-branch structure. \cite{zhang2020refineface} introduces rectangle receptive fields by a novel enhancement module. \cite{qiao2020detectors,li2019dsfd,liu2018rfb} adopt dilated convolution with different rates to enhance the feature discriminability and robustness. However, as illustrated in Fig.~\ref{fig:gap_coco_widerface}, some of them seem to be ineffective in face detection.


\begin{table}[!t]
    \centering
    \begin{tabular}{c|cccccc}
        \toprule[1pt]
        Pyramid Level & P2 & P3 & P4 & P5 & P6 & P7 \\
        \midrule[0.5pt]
        P2 &  & \textcolor{red}{} &  &  &  &  \\
        P3 & \textcolor{blue}{} &  & \textcolor{red}{} &  &  &  \\
        P4 &  & \textcolor{blue}{} &  & \textcolor{red}{} &  & \\
        P5 &  &  & \textcolor{blue}{} &  & \textcolor{red}{} &  \\
        P6 &  &  &  & \textcolor{blue}{} &  & \textcolor{red}{} \\
        P7 &  &  &  &  & \textcolor{blue}{} &  \\
        \bottomrule[1pt]
    \end{tabular}
\caption{ Performance of FPN on Hard subset of WIDER Face validation while a pyramid level (indicated by the row) is aggregated by a specific level (indicated by the column).}
    \label{tab:pyramid_fa}
\end{table}


\subsection{Neural Architecture Search.}
NAS first uses reinforcement learning to search for hyper-parameters in the structure or used in the training process \cite{zoph2016neural,zoph2018learning,tan2019efficientnet}. Recent researches focus on the automatic search of network architecture. Based on the idea of weight sharing, some works try to build the final structure by stacking a searched cell several times \cite{liu2018darts,xu2019pcdarts}, and other methods \cite{guo2019spos,chu2019fairnas,cai2019once,liu2020bfbox,chen2019detnas} decouple the training and searching process and directly train a supernet by randomly sampling a single-path network at each time.
As for their applications on object detection to fuse the multi-scale features, NAS-FPN \cite{ghiasi2019nasfpn} searches the irregular connections among pyramid layers with an RNN controller for aggregating the multi-scale features. AutoFPN \cite{xu2019autofpn} and NAS-FCOS \cite{wang2019nasfcos} discover the aggregation modules within a fully-connected search space densely connecting any two layers, in which features from some layers that damage the aggregated feature may be introduced causing accuracy degradation.
BFBox \cite{liu2020bfbox} is the first attempt of NAS on face detection and proposes a face-suitable search space. Although the novel backbone and neck networks are discovered among the search space, its performance is still worse than the state-of-the-art face detectors.






In this work, the sparse cross-scale connections of FA module are searched based on a face-suitable search space rather than in a violent fully-connected manner. And various FE modules with different operations and topologies are discovered for different pyramid levels.

\section{Problem Analysis}\label{sec:problem}
Fig.~\ref{fig:gap_coco_widerface} (a) is sufficient to illustrate the inconsistency between general object detection and face detection. In order to further analyze the reason why this phenomenon occurs, the effects of feature aggregation and enhancement modules are discussed respectively in this section.


\subsection{Feature Aggregation (FA).}
Firstly, extensive experiments are conducted to explore the relationship between performance and cross-connection of FA modules. These experiments are to add a FA module (for simplicity, FPN \cite{lin2017fpn}) in turn between any two pyramid features and aggregate one feature with another one after resizing to the same shape. Table~\ref{tab:pyramid_fa} shows the results on the diagonal indicating RetinaNet without FPN, and upper triangle and lower triangle representing top-down and bottom-up paths respectively, especially, red and blue fonts indicate top-down and bottom-up paths in FPN and PAFPN. it is clear to conclude that aggregating multi-scale features through top-down paths is superior to the bottom-up ones, especially these two layers used are close to each other. As the distance increasing, some connections even cause performance degradation, \textit{e.g.} AP drops  when P is aggregated by P.
Therefore, small faces only occur in the shallow features cannot be enhanced by semantic-rich features with large scale difference.
It reveals that NAS-FPN, AutoFPN and NAS-FCOS are sub-optimal to fuse features through a fully-connected or irregular connection in the face domain. 


 
\begin{table}[!t]
    \centering
    \begin{tabular}{l|cccccc}
        \toprule[1pt]
        Module & P2 & P3 & P4 & P5 & P6 & P7 \\
        \midrule[0.5pt]
        ASPP &  &  &  &  &  &  \\
        CPM &  &  &  &  &  &  \\
        RFB &  &  &  &  &  &  \\
        RFE &  &  &  &  &  &  \\
        \bottomrule[1pt]
    \end{tabular}
\caption{Performance of different feature enhancement modules when operated on different pyramid levels.}
    \label{tab:pyramid_fe}
\end{table}


\subsection{Feature Enhancement (FE).}
Similar experiments are conducted to demonstrate the effects of different feature enhancements modules. As shown in Table~\ref{tab:pyramid_fe}, there are significant performance differences when a FE module is applied to the different pyramid layers. 
In general, ASPP \cite{chen2017aspp,qiao2020detectors}, CPM \cite{li2019dsfd,tang2018pyramidbox} and RFB \cite{liu2018rfb} employ dilated convolution with different rates to enlarge the receptive fields, they can obtain the consistent performance when applied to different pyramid layers. Particularly, they would damage the shallow features especially the first two layers, and cause severe performance degradation.
RFE \cite{zhang2020refineface} aims to enrich the features by introducing the rectangle receptive fields and performs well on all pyramid layers especially the shallow layers. 
A meaningful conclusion can be drawn that the shallower features seem to prefer a more diverse receptive field while the deeper layers favor a larger one. 
This is mainly because detecting faces with occlusion or extreme-pose that appear in the shallow layers expect more robust features, and the large faces require features with large receptive fields to locate accurately.

In summary, reasons for the aforementioned problem are: (1) \textit{The unreasonable connection in FA modules would cause performance degradation}, (2) \textit{Features from different layers should be enhanced by different operations}.





\section{Methodology}
The framework of our ASFD is based on the simple and effective RetinaNet \cite{lin2017focal}, which contains three main components: the backbone for extracting pyramid features, the neck for fusing and enhancing the features, and the head for regression and classification. Our goal is to discover a \textit{better neck architecture} for RetinaNet and scale the ASFD to satisfy different complexity requirements automatically. 

\subsection{Search Space of AutoFA and AutoFE}
\subsubsection{AutoFA}
In order to address the limitation of previous NAS-based FPN \cite{wang2019nasfcos, xu2019autofpn,ghiasi2019nasfpn} when applied on the face domain, the above analysis motivates us to design a module that aggregates a feature by the similar-scale features instead of directly using those with large differences in scale.

To this end, we propose a fundamental building cell of AutoFA for aggregating the pyramid features sequentially, shown in Fig.~\ref{fig:fpn_uint}. Initially, the cell contains a pyramid feature pool with a specific one activated, and a candidate feature pool with aggregated features of previous steps. During the searching phase, the specific pyramid feature is selected sequentially, candidate features are chosen with the corresponding probability . Firstly, these candidate features are aggregated together after resizing to the same shape and weighting by ; then, it is fused with the pyramid feature and a convolution layer is performed to obtain the corresponding aggregated feature. At last, it is appended to the candidate feature pool for the later feature fusion.
Assume that a pyramid feature and the corresponding aggregated feature are  and , the basic cell can be formulated as,



in which ,  and  are two convolution operations for feature aggregation, and  is for resizing the feature to the same size, \textit{i.e.} bilinear interpolation for upsampling and maxpooling with stride  for downsampling. Once the searching process is done, the final discrete structure can be obtained according to the probability score  and importance score . For a given pyramid feature, it is aggregated by candidate features with probability , and  is retained as the initial value for weighting the pyramid feature and candidate feature. In this approach, aggregated features of the discrete cell can be denoted as,

where  equals  if the inner expression is true.

\begin{figure}[!t]
    \centering
    \includegraphics[width=0.95\linewidth]{./pic/fpn_unit.pdf}
    \caption{Illustration of the basic cell of AutoFA.  means the sum weighted by a factor.  indicates the probability to choose a candidate feature, and  is the score for weighting the importance of different features.}
    \label{fig:fpn_uint}
\end{figure}

Similar to PAFPN \cite{liu2018pafpn} and BiFPN \cite{tan2020efficientdet}, our AutoFA aggregates the pyramid features along a top-down path and a bottom-up path, each of them is comprised of several basic building cells. For the top-down path, pyramid features are selected in the order of decreasing resolution for aggregation, \textit{i.e.} from P with stride  to P with stride , same as Fig.~\ref{fig:fpn_uint}. As the counterpart, the aggregation along bottom-up path is in the reversed order.

\subsubsection{AutoFE.}
\begin{figure}[!t]
    \centering
    \includegraphics[width=0.99\linewidth]{./pic/fe_unit.pdf}
    \caption{Illustration of the basic structure of AutoFE with  nodes. The bold colored arrows have two states: not activated and activated, in which not activated arrows mean disconnecting,  indicates the probability. Thin colored arrows indicate different operations with probability .}
    \label{fig:fe_uint}
\end{figure}

The incompatibility of those FE modules for some pyramid levels has been revealed and an important conclusion has been drawn in the aforementioned analysis.
To discover the suitable enhancement module for each pyramid layer, we propose a basic cell for our AutoFE that includes several intermediate features transformed by the candidate operations, which include \{ conv,  conv,  conv,  conv,  conv,  conv,  conv \}. As presented in Fig.~\ref{fig:fe_uint}, the basic cell is conducted as a directed acyclic graph with several nodes, where node  is input and others are intermediate features. 
Each node  is connected to the previous node  with two status indicated by , \textit{i.e.} activated if and only if  is maximum among , otherwise not activated.
In this way, the previous feature is transformed by the different operations; otherwise, it is not activated. Assume that the feature of th node is , it can be formulated as follow,

where  is the sum weighted by  when processed by the activated operations. Different from \cite{liu2018darts,xu2019pcdarts}, the output of the cell is the sum of features of all leaf nodes, \textit{i.e.} the intermediate features who are not input to the other nodes, given by

In particular, the commonly used convolutions with different kernel shapes and dilation rates are adopted for .

However, during the search, Eq.~\ref{eq:illu_fe_unit} cannot be optimized because it is equivalent to discrete sampling, which is not differentiable. To allow back-propagation, we use the Gumbel-Max method \cite{dong2019gdas} to re-formulate Eq.~\ref{eq:illu_fe_unit} in an efficient way that samples a discrete probability as follow,

where  is the \textit{i.i.d.} sample drawn from Gumbel \cite{dong2019gdas}. Then, softmax function is used to relax the argmax function so as to make Eq.~\ref{eq:gumbel} being differentiable, in which  is for approximating , denoted by,

where  is the softmax temperature. In this way, argmax is used in the forward pass to achieve discrete sampling of connections between two nodes, but softmax in Eq.~\ref{eq:softmax} is adopted during backward pass to allow gradient back-propagation.

Finally, the discrete architecture of AutoFE is obtained by retaining the connections and operations among intermediate features according to the maximum of  and .

\subsection{Search Strategy of AutoFA and AutoFE}
We have transformed the discrete network structure into several architecture parameters through the design of face-suitable search space for AutoFA and AutoFE. In detail,  is adopted to make the decision on choosing candidate features for a pyramid feature,  is used to balance the importance of pyramid and candidate features. For AutoFE,  is employed for selecting the connection of intermediate nodes, and  indicates the probability of different operations. Similar to \cite{liu2018darts,chen2019pdarts,xu2019pcdarts}, we utilize the bi-level optimization method to alternately optimize the network parameters, \textit{e.g.} parameters of convolution layers, and architecture parameters in an end-to-end manner.

\begin{figure}[!t]
    \centering
    \includegraphics[width=0.9\linewidth]{./pic/supernet.pdf}
    \caption{The architecture of the supernet to automatically obtain a detector for different AI systems.}
    \label{fig:arch_supernet}
\end{figure}

\subsection{Auto Model Scaling}


We automatically obtain the ASFD family with different complexities on the basis of a supernet, as shown in Fig.~\ref{fig:arch_supernet}, which is comprised of the backbones in parallel, the stacked AutoFAE modules, and the stacked convolutions for prediction head. Our method aims to search for a better composition to meet different complexity requirements, \textit{i.e.} which backbone to pick, how many AutoFAE modules and convolutions in head to stack, whether to skip AutoFE for each AutoFAE, and what the number of feature channels.

\subsubsection{Training.}
Based on the idea of weight sharing, the supernet is trained by alternately training a single-path network through uniformly sampling \cite{guo2019spos,chu2019fairnas}.
For instance, as presented in Fig.~\ref{fig:arch_supernet}, the single-path is composed of backbone-, and AutoFAE and prediction convolutions, which are both stacked two layers. 
Furthermore, a scalable method is proposed for training the supernet compatible with different feature channels. The supernet is optimized with the maximal feature channels during a long warm-up period until it tends to converge. Then, the candidate feature channels are gradually added to be sampled in the descending order, in which the corresponding tensors are sliced out along each dimension to fit the calculations.


\subsubsection{Searching.}
The searching phase is based on the genetic algorithm \cite{guo2019spos,chen2019detnas,chu2019fairnas} and directly takes inference latency into fitness. At first, populations are randomly initialized with genes encoded by the  degrees of freedom of the supernet, which would be removed if against the constraints. After the initialization, they are evaluated on a mini validation set to obtain the fitness. At each iteration, only the top- populations with better finesses are retained to generate the next generation by mutation and crossover. By repeating this procedure several times, we can discover a single-path network with the best fitness.


\section{Experiments}
\subsection{Experimental Setup}
\subsubsection{Baseline.} If not specified, RetinaNet \cite{lin2017focal} with FPN is utilized as the baseline of the face detector. Compared to the original generic object detection application, it has the following differences: (1) 6 levels of pyramid features are used for predicting with anchor scales  and aspect ratio . (2) The IoU threshold for anchor matching is changed to  and the ignore-zone is not implemented. (3) Top-2000 predictions with confidence higher than  are processed by non-maximum suppression with a threshold  to produce at most  final detections. 
The results are reported using AP measured with a constant IoU threshold , as well as AP averaged under IoU thresholds from  to  with step  to demonstrate the performance at high IoU.


\subsubsection{Train Details.} We use the ImageNet-pretrained models to initialize the backbone parameters, and `kaiming' method for others. SGD algorithm is employed to optimize the network parameters with momentum , weight decay  and initial learning rate  per  images. For ablative studies, the learning rate is multiplied by factor  at ,  epochs and ended at  epochs.
For the main results, it is divided by  at ,  epochs and ended at  epochs.


\subsubsection{Search Details.} The training set of WIDER Face is divided into two mini training and a validating subsets, with a ratio of , they are used for updating network and architecture parameters, and evaluating the searched modules respectively.
Adam algorithm with learning rate  is adopted for optimizing the architecture parameters, which are frozen at the first  epochs and updated during  epochs, and other settings are same as training details. To determine the final AutoFAE module, we run the searching algorithm  times with different random seeds and pick the best one based on its performance on the mini validation. All training and searching experiments are conducted on 8 V100 GPUs. The AutoFA and AutoFE can be searched within 3 to 4 hours. The commonly used supernet takes about 12 hours for training, and the ASFD families could be sampled within 1.5 to 4 hours. 


\subsection{Ablation Study}

\begin{table}[!t]
    \centering
    \begin{tabular}{l|ccc|ccc}
        \toprule[1pt]
        \multirow{2}{*}{Module} & \multicolumn{3}{c|}{AP} & \multicolumn{3}{c}{AP} \\
        \cline{2-7}
        & Easy & Medium & Hard & Easy & Medium & Hard \\
        \midrule[0.5pt]
        Baseline &  &  &  &  &  &  \\
        NAS-FPN &  &  &  &  &  &  \\
        NAS-FCOS &  &  &  &  &  &  \\
        AutoFPN &  &  &  &  &  &  \\
        PAFPN &  &  &  &  &  &  \\
        BiFPN &  &  &  &  &  &  \\
        ABiFPN &  &  &  &  &  &  \\
        FEM-FPN &  &  &  &  &  &  \\
        DARTS &  &  &  &  &  &  \\
        PC-DARTS &  &  &  &  &  &  \\
        \bottomrule[0.5pt]
        AutoFA &  &  &  &  &  & \\
        \bottomrule[1pt]
    \end{tabular}
    \caption{Comparison with state-of-the-art feature aggregation modules on WIDER Face validation.}
    \label{tab:autofa}
\end{table}

\subsubsection{Effect of Search Space for AutoFA and AutoFE}
To demonstrate the effectiveness of our proposed face-suitable search space for feature aggregation and enhancement modules, the AutoFA and AutoFE modules are discovered and compared to the state-of-the-art modules respectively.

At the first stage, the AutoFA module is searched through a RetinaNet that replaces the FPN with several basic aggregation modules. 
As shown in Table~\ref{tab:autofa}, simulations are conducted by comparing to the commonly used FA modules, in which DARTS \cite{liu2018darts} and PC-DARTS \cite{xu2019pcdarts} illustrate the results based on a fully-connected search space \cite{wang2019nasfcos}. Our AutoFA manages to address the limitations of previous NAS-based methods and outperforms them with a large margin, which is more than  points on all three subsets indicated by AP. 
Besides, it is also significantly better than the hand-crafted ones composed of top-down and bottom-up paths, \textit{i.e.} PAFPN \cite{liu2018pafpn}, BiFPN \cite{tan2020efficientdet}, and ABiFPN \cite{zhang2020acfd}, demonstrating the superiority of connections between the multi-scale features of AutoFA.
Such the large improvement is mainly from predictions with the high IoU, which shows that the features of different scales are fully aggregated and it is helpful for more distinguishable classification and more accurate location.

\begin{table}[!t]
    \centering
    \begin{tabular}{l|ccc|ccc}
        \toprule[1pt]
        \multirow{2}{*}{Module} & \multicolumn{3}{c|}{AP} & \multicolumn{3}{c}{AP} \\
        \cline{2-7}
        & Easy & Medium & Hard & Easy & Medium & Hard \\
        \midrule[0.5pt]
        Baseline &  &  &  &  &  &  \\
        ASPP &  &  &  &  &  &  \\
        RFB &  &  &  &  &  &  \\
        CPM &  &  &  &  &  &  \\
        FEM-CPM &  &  &  &  &  &  \\
        RFE &  &  &  &  &  &  \\
        DARTS &  &  &  &  &  &  \\
        PC-DARTS &  &  &  &  &  &  \\
        \bottomrule[0.5pt]
        AutoFE &  &  &  &  &  &  \\
        \bottomrule[1pt]
    \end{tabular}
    \caption{Comparison with state-of-the-art feature enhancement modules on WIDER Face validation.}
    \label{tab:autofe}
\end{table}

Then, RetinaNet without FPN is adopted as the baseline to better highlight the effectiveness of FE modules. 
Different FE modules are placed between the backbone and detection head to refine the multi-scale features, as shown in Table~\ref{tab:autofe}. In particular, DARTS and PC-DARTS discover FE modules by following their original settings in image classification. However, they only improve the baseline by minor advantages.
With the specified face-suitable search space, the found AutoFE improves the baseline by  points of AP and  points of AP, far exceeding the other state-of-the-art modules and demonstrating the superiority of our face-suitable search space.


\subsubsection{Effect of Joint Searching AutoFAE}
The AutoFAE module is composed of AutoFA and AutoFE two modules, which can be obtained by cascading the discovered AutoFA and AutoFE modules or jointly searching in an end-to-end manner. 
As presented in Table~\ref{tab:joint_search}, only a minor improvement is achieved by cascading the discovered AutoFA and AutoFE directly. And AutoFAE found by the joint searching way can further improve AP and AP by clear margins, demonstrating the state-of-the-art performance of proposed AutoFAE.



\begin{table}[!t]
    \centering
    \resizebox{0.99\linewidth}{!}{
    \begin{tabular}{l|ccc|ccc}
        \toprule[1pt]
        \multirow{2}{*}{Method} & \multicolumn{3}{c|}{AP} & \multicolumn{3}{c}{AP} \\
        \cline{2-7}
        & Easy & Medium & Hard & Easy & Medium & Hard \\
        \midrule[0.5pt]
        Baseline &  &  &  &  &  &  \\
AutoFA+AutoFE &  &  &  &  &  &  \\
        Joint Search &  &  &  &  &  &  \\
        \bottomrule[1pt]
    \end{tabular}}
    \caption{The effect of searching method for the AutoFAE.}
    \label{tab:joint_search}
\end{table}


\subsubsection{Effect of Different Positions of AutoFE}
Review that our AutoFAE is built upon the top-down and bottom-up paths. Therefore, we have three ways to build the final AutoFAE module. In detail, the AutoFE module can be plugged before and after the AutoFA, as well as between the top-down and bottom-up paths. In this way, three modules are obtained by utilizing the joint searching method. As shown in Table~\ref{tab:different_position}, we observe that the best performance is achieved when AutoFE is in the middle position. This is mainly because similar presentation is generated after the top-down aggregation. Placing AutoFE before the bottom-up path can further enhance these features to carry different context information.


\begin{table}[!t]
    \centering
    \begin{tabular}{l|ccc|ccc}
        \toprule[1pt]
        \multirow{2}{*}{Position} & \multicolumn{3}{c|}{AP} & \multicolumn{3}{c}{AP} \\
        \cline{2-7}
        & Easy & Medium & Hard & Easy & Medium & Hard \\
        \midrule[0.5pt]
        Baseline &  &  &  &  &  &  \\
        Before &  &  &  &  &  &  \\
        Middle &  &  &  &  &  &  \\
        After &  &  &  &  &  &  \\
        \bottomrule[1pt]
    \end{tabular}
    \caption{The effect of the position of AutoFE and AutoFA.}
    \label{tab:different_position}
\end{table}



\begin{figure}[!t]
    \centering
    \includegraphics[width=0.7\linewidth]{./pic/autofae.pdf}
    \vspace{-2.5mm}
    \caption{The architecture of the discovered AutoFAE, in which FA-Cell is the basic cell indicated by Fig.~\ref{fig:fpn_uint},  denotes the convolution kernel size, and R is the dilated rate.}
    \vspace{-3.5mm}
    \label{fig:autofae}
\end{figure}

\begin{table}[!t]
    \centering
    \resizebox{1\linewidth}{!}{
    \begin{tabular}{l|l|ccc|ccc|c}
        \toprule[1pt]
         \multirow{2}{*}{Model} & \multirow{2}{*}{Single Path} & \multicolumn{3}{c|}{AP} & \multicolumn{3}{c|}{AP} & \multirow{2}{*}{Lat.} \\
         &  & Easy & Medium & Hard & Easy & Medium & Hard &   \\
        \midrule[0.5pt]
        D & R-FA-H- &  &  &  &  &  &  &  \\
        D & R-FA-H- &  &  &  &  &  &  &  \\
        D & R-FA-H- &  &  &  &  &  &  &  \\
        D & R-FAE-H- &  &  &  &  &  &  &  \\
        D & R-FAE-H- &  &  &  &  &  &  &  \\
        D & R-FAE-H- &  &  &  &  &  &  &  \\
        D & R-FAE-FA-FA-H- &  &  &  &  &  &  &  \\
        \bottomrule[1pt]
    \end{tabular}}
    \caption{The family of ASFD, where latency (ms) is measured with VGA-resolution images and on Nvidia V100 GPU.}
    \label{tab:trade_off}
\end{table}


\begin{figure}[!t]
    \centering
    \subfigure[WIDER Face: Hard Val]{
        \includegraphics[width=0.47\linewidth,height=0.35\linewidth]{./pic/widerface_val_hard.pdf}
    }
    \subfigure[WIDER Face: Hard Test]{
        \includegraphics[width=0.47\linewidth,height=0.35\linewidth]{./pic/widerface_test_hard.pdf}
    }
    \\
    \subfigure[FDDB: Discontinuous]{
        \includegraphics[width=0.47\linewidth,height=0.35\linewidth]{./pic/fddb_disc.JPG}
    }
    \subfigure[FDDB: Continuous]{
        \includegraphics[width=0.47\linewidth,height=0.35\linewidth]{./pic/fddb_cont.JPG}
    }
    \vspace{-2.5mm}
    \caption{Evaluation on the popular benchmarks of ASFD.}
    \vspace{-3.5mm}
    \label{fig:benchmarks}
\end{figure}


\begin{figure*}[!t]
    \centering
    \includegraphics[width=0.3\linewidth]{./pic/demo_1.jpg}
    \includegraphics[width=0.3\linewidth]{./pic/demo_2.jpg}
    \includegraphics[width=0.3\linewidth]{./pic/demo_3.jpg}
    \vfill
    \includegraphics[width=0.3\linewidth]{./pic/demo_4.jpg}
    \includegraphics[width=0.3\linewidth]{./pic/demo_5.jpg}
    \includegraphics[width=0.3\linewidth]{./pic/demo_6.jpg}
    \vfill
    \includegraphics[width=0.3\linewidth]{./pic/demo_7.jpg}
    \includegraphics[width=0.3\linewidth]{./pic/demo_8.jpg}
    \includegraphics[width=0.3\linewidth]{./pic/demo_9.jpg}
    \vfill
    \vspace{-2.5mm}
    \caption{Illustration of ASFD to various large variations. Red bounding boxes indicate the detection confidence is above .}
    \vspace{-3mm}
    \label{fig:visual_demo}
\end{figure*}


\subsection{Analysis on AutoFAE}
We visualize the architecture of AutoFAE in Fig.~\ref{fig:autofae}, which can match the previous conclusions drawn in the problem analysis section perfectly. 
In general, the AutoFA module aggregates pyramid features along with the sparse cross-scale and similar-scale connections instead of a fully connected manner like \cite{xu2019autofpn,wang2019nasfcos}, which avoids the performance degradation caused by large scale differences. 
Most of these cross-scale connections appear on the top-down path of AutoFA, in which the shallow features that lack semantic information are aggregated with not only the adjacent layer but also the others with rich context. 
Besides, AutoFE modules with different operations and topological structures are found for different pyramid layers. Particularly, dilated convolutions only appear in the later levels for enlarging the receptive fields, the others are almost rectangle convolutions for more diverse features. Thus, the large faces are located, and small faces in occlusion and with extreme-poses are well distinguished.


\subsection{Model Scaling}
Next, the supernet is trained on the basis of the final AutoFAE and backbone networks of ResNet series \cite{he2016resnet}. Then, the genetic algorithm is adopted to search the single-path networks with  populations and  iterations. We discover  single-path networks under the different GPU inference latencies, \textit{e.g.} ms, ms and so on. These networks are trained for  epochs with the commonly used pyramid anchors \cite{tang2018pyramidbox}, and multi-scale test is employed with factors . The detailed results are presented in Table~\ref{tab:trade_off}, in which the network architecture is indicated by single path. For instance, ``R-FAE-FA-FA-H-'' means ResNet101 is adopted as the backbone, AutoFAE modules are stacked  times and AutoFE module is skipped within the last two modules, convolution layers are repeated  times in prediction head, and the feature channel is . Obviously, our ASFD family makes a better trade-off between performance and efficiency by scaling the components and channels, especially the ASFD-D costs about  ms, \textit{i.e.} more than 320 FPS.


\subsection{Evaluation on Benchmarks}
We evaluate our ASFD-D on the popular benchmarks, \textit{i.e.} WIDER Face \cite{yang2016wider} and FDDB \cite{jain2010fddb}, which is trained only on the training set of WIDER Face and test on these benchmarks without any fine-tuning. 
Our ASFD-D obtains the highest AP scores with  on WIDER Face validation,  on WIDER Face test, and  and  on FDDB discontinuous and continuous curves, outperforming the prior competitors by a considerable margin and setting a new state-of-the-art face detector, shown as Fig.~\ref{fig:benchmarks} (Easy and Medium results of WIDER Face are ignored due to the space limitation). More examples of our ASFD on handling face with various variations are shown in Fig.~\ref{fig:visual_demo} to demonstrate its effectiveness.



\subsection{Generalization on Generic Object Detection}
To demonstrate the generalization ability of our AutoFAE module, we evaluate the final AutoFAE module with three typical detectors, RetinaNet \cite{lin2017focal}, FCOS \cite{tian2019fcos} and Faster RCNN \cite{ren2015faster} on COCO. In particular, the original FPN module is replaced with our AutoFAE by connecting the corresponding pyramid layers, as presented in Table~\ref{tab:object_detection}, our AutoFAE module can consistently adapt to the general object domain and different detectors, with AP improvements from  to  points.
\begin{table}[!t]
    \centering
    \resizebox{0.99\linewidth}{!}{
    \begin{tabular}{l|ccc|ccc}
        \bottomrule[1pt]
        \multirow{2}{*}{Model} & \multicolumn{3}{c|}{FPN} & \multicolumn{3}{c}{AutoFAE} \\
        \cline{2-7}
        & AP & AP & AP & AP & AP & AP \\
        \midrule[0.5pt]
        RetinaNet &  &  &  &  &  &  \\
        FCOS &  &  &  &  &  &  \\
        Faster RCNN &  &  &  &  &  &  \\
        \bottomrule[1pt]
    \end{tabular}}
    \caption{The generalization of AutoFAE on generic object detection dataset \textit{i.e.} COCO.}
    \label{tab:object_detection}
\end{table}


\section{Conclusion}
Neural architecture search has demonstrated its successes in generic object detection about feature aggregation and enhancement. However, they cannot adapt to the domain difference between face and generic object detection and cause severe performance drops when applied to the face domain. In this paper, we analyze the reason for this phenomenon occurs and propose a face-suitable search space for feature aggregation and enhancement modules. And a better FAE module termed as AutoFAE is discovered using bi-level optimization, which outperforms the current state-of-the-art FAE modules in face detection and can be generalized to general object tasks. Finally, we automatically obtain a family of detectors with different complexities based on a supernet that achieves a better performance-efficiency trade-off.

\bibliographystyle{ACM-Reference-Format}
\balance
\bibliography{sample-base}

\end{document}
