\nonstopmode
\documentclass[preliminary,copyright,creativecommons]{eptcs}

\newcommand{\AGDALATEX}[1]{#1}
\newcommand{\PLAINLATEX}[1]{}

\usepackage{amsfonts,amssymb,textgreek,stmaryrd}
\usepackage[postscript]{ucs}
\usepackage{pifont}
\usepackage[utf8x]{inputenc}


\AGDALATEX{\usepackage{latex/agda}
}
\PLAINLATEX{\usepackage{verbatim}
\newenvironment{code}{\verbatim}{\endverbatim}
\long\def\AgdaHide#1{} }
\DeclareUnicodeCharacter{8759}{::}
\DeclareUnicodeCharacter{9733}{}
\DeclareUnicodeCharacter{8718}{}
\DeclareUnicodeCharacter{10214}{}
\DeclareUnicodeCharacter{10215}{}
\DeclareUnicodeCharacter{10218}{} \DeclareUnicodeCharacter{10219}{}

\newcommand{\DelayI}{\AgdaDatatype{Delay}~\AgdaBound{i}}
\newcommand{\DelayA}[1]{\AgdaDatatype{Delay}~\AgdaBound{#1}~\AgdaBound{A}}
\newcommand{\DelayIA}{\DelayA{i}}
\newcommand{\IDelayA}[1]{\AgdaDatatype{∞Delay}~\AgdaBound{#1}~\AgdaBound{A}}
\newcommand{\IDelayIA}{\IDelayA{i}}
\newcommand{\force}{\AgdaField{force}}
\newcommand{\ainf}{\AgdaBound{a∞}}
\newcommand{\aq}{\AgdaBound{a?}}
\newcommand{\aqp}{\AgdaBound{a?′}}
\newcommand{\jlti}{\ensuremath{\AgdaBound{j} < \AgdaBound{i}}}
\newcommand{\RawMonad}{\AgdaFunction{RawMonad}}
\newcommand{\RawFunctor}{\AgdaFunction{RawFunctor}}
\newcommand{\fmap}{\ensuremath{\AgdaFunction{\_\ensuremath{{<}\\eta\beta\eta\beta\ainf : \IDelayIA\ainf : \DelayA{j}\ainf : \IDelayA{∞}\force\;\ainf : \DelayA{∞}\aq : \DelayA{∞}\AgdaBound{a?}\;\bind\;\AgdaBound{\,f\,}\AgdaBound{\,f\,}\;\AgdaBound{a}{>}}\_} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{i} \AgdaBound{A} \AgdaBound{B}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{\,f\,} \AgdaSymbol{:} \AgdaBound{A} \AgdaSymbol{→} \AgdaBound{B}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{∞a} \AgdaSymbol{:} \AgdaRecord{∞Delay} \AgdaBound{i} \AgdaBound{A}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaRecord{∞Delay} \AgdaBound{i} \AgdaBound{B}\<\\
\>\AgdaBound{\,f\,} \AgdaFunction{∞\ensuremath{{<}\{>}} ∞a) = f \ensuremath{{<}\\cong_n\congn=0n=1n=\omega{>}}} \AgdaSymbol{(}\AgdaBound{\,f\,} \AgdaFunction{\ensuremath{{<}\{>}}} \AgdaBound{a?}\AgdaSymbol{)}\<\\
\>\AgdaFunction{map-compose} \AgdaBound{a?} \<[16]\>[16]\AgdaSymbol{=} \<[19]\>[19]\AgdaFunction{bind-assoc} \AgdaBound{a?}\<\\
\\
\>\AgdaFunction{map-cong} \<[16]\>[16]\AgdaSymbol{:} \<[19]\>[19]\AgdaSymbol{∀\{}\AgdaBound{i} \AgdaBound{A} \AgdaBound{B}\AgdaSymbol{\}\{}\AgdaBound{a?} \AgdaBound{b?} \AgdaSymbol{:} \AgdaDatatype{Delay} \AgdaPostulate{∞} \AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{\,f\,} \AgdaSymbol{:} \AgdaBound{A} \AgdaSymbol{→} \AgdaBound{B}\AgdaSymbol{)} \AgdaSymbol{→}\<\\
\>[17]\AgdaIndent{19}{}\<[19]\>[19]\AgdaBound{a?} \AgdaFunction{∼⟨} \AgdaBound{i} \AgdaFunction{⟩∼} \AgdaBound{b?} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{\,f\,} \AgdaFunction{\ensuremath{{<}\{>}}} \AgdaBound{b?}\AgdaSymbol{)}\<\\
\>\AgdaFunction{map-cong} \AgdaBound{\,f\,} \AgdaBound{eq} \<[16]\>[16]\AgdaSymbol{=} \<[19]\>[19]\AgdaFunction{bind-cong-l} \AgdaBound{eq} \AgdaSymbol{(}\AgdaInductiveConstructor{now} \AgdaFunction{∘} \AgdaBound{\,f\,}\AgdaSymbol{)}\<\end{code} 

\subsection{Convergence}

We define convergence as a relation between delayed computations of
type \DelayA{∞} and values of type~\AgdaBound{A}.  If ,
then the delayed computation \aq{} eventually yields the value
\AgdaBound{a}. This is a central concept in this paper as we will write a
(productive) normalizer that produces delayed normal forms and then
prove that all such delayed normal forms converge to a value yielding
termination of the normalizer. Notice that convergence is an \emph{inductive}
relation defined on coinductive data.

\begin{code}\>\AgdaKeyword{data} \AgdaDatatype{\_⇓\_} \AgdaSymbol{\{}\AgdaBound{A} \AgdaSymbol{:} \AgdaPrimitiveType{Set}\AgdaSymbol{\}} \AgdaSymbol{:} \AgdaSymbol{(}\AgdaBound{a?} \AgdaSymbol{:} \AgdaDatatype{Delay} \AgdaPostulate{∞} \AgdaBound{A}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{a} \AgdaSymbol{:} \AgdaBound{A}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaPrimitiveType{Set} \AgdaKeyword{where}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaInductiveConstructor{now⇓} \<[10]\>[10]\AgdaSymbol{:} \<[13]\>[13]\AgdaSymbol{∀\{}\AgdaBound{a}\AgdaSymbol{\}} \<[52]\>[52]\AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaBound{a} \AgdaDatatype{⇓} \AgdaBound{a}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaInductiveConstructor{later⇓} \<[10]\>[10]\AgdaSymbol{:} \<[13]\>[13]\AgdaSymbol{∀\{}\AgdaBound{a}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{a∞} \AgdaSymbol{:} \AgdaRecord{∞Delay} \AgdaPostulate{∞} \AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaField{force} \AgdaBound{a∞} \AgdaDatatype{⇓} \AgdaBound{a} \<[52]\>[52]\AgdaSymbol{→} \AgdaInductiveConstructor{later} \AgdaBound{a∞} \AgdaDatatype{⇓} \AgdaBound{a}\<\\
\\
\>\AgdaFunction{\_⇓} \<[5]\>[5]\AgdaSymbol{:} \<[8]\>[8]\AgdaSymbol{\{}\AgdaBound{A} \AgdaSymbol{:} \AgdaPrimitiveType{Set}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{x} \AgdaSymbol{:} \AgdaDatatype{Delay} \AgdaPostulate{∞} \AgdaBound{A}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<\\
\>\AgdaBound{x} \AgdaFunction{⇓} \<[5]\>[5]\AgdaSymbol{=} \<[8]\>[8]\AgdaFunction{∃} \AgdaSymbol{λ} \AgdaBound{a} \AgdaSymbol{→} \AgdaBound{x} \AgdaDatatype{⇓} \AgdaBound{a}\<\end{code}

\noindent
We define some useful utilities about convergence: We can map
functions on values over a convergence relation (see \AgdaFunction{map⇓}).
If a delayed computation \aq{} converges
to a value \AgdaBound{a} then so does any strongly bisimilar computation
\aqp{} (see \AgdaFunction{subst∼⇓}).
If we apply a function \AgdaBound{\,f\,} to a delayed value
\aq{} using bind and we know that the delayed value converges to a
value \AgdaBound{a} then we can replace the bind with an ordinary
application  (see \AgdaFunction{bind⇓}).

\begin{code}\>\AgdaFunction{map⇓} \<[9]\>[9]\AgdaSymbol{:} \<[12]\>[12]\AgdaSymbol{∀\{}\AgdaBound{A} \AgdaBound{B}\AgdaSymbol{\}\{}\AgdaBound{a} \AgdaSymbol{:} \AgdaBound{A}\AgdaSymbol{\}\{}\AgdaBound{a?} \AgdaSymbol{:} \AgdaDatatype{Delay} \AgdaPostulate{∞} \AgdaBound{A}\AgdaSymbol{\}(}\AgdaBound{\,f\,} \AgdaSymbol{:} \AgdaBound{A} \AgdaSymbol{→} \AgdaBound{B}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaBound{a?} \AgdaDatatype{⇓} \AgdaBound{a} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{\,f\,} \AgdaFunction{\ensuremath{{<}\\AgdaBound{a}\;\AgdaInductiveConstructor{⇒}\;\AgdaBound{b}{>}}} \AgdaFunction{nereadback} \AgdaBound{w}\<\\
\>\AgdaFunction{readback} \AgdaSymbol{\{}\AgdaSymbol{a} \AgdaSymbol{=} \AgdaSymbol{\_} \AgdaInductiveConstructor{⇒} \AgdaSymbol{\_\}} \<[22]\>[22]\AgdaBound{v} \<[30]\>[30]\AgdaSymbol{=} \AgdaInductiveConstructor{lam} \<[37]\>[37]\AgdaFunction{\ensuremath{{<}\{>}}} \AgdaFunction{readback} \AgdaBound{v}\<\end{code} 

\noindent
The three functions are defined by an outer coinduction into the
\AgdaDatatype{Delay} monad and an inner local induction on neutral
values in \AgdaFunction{nereadback}.  Again, the sized typing of bind
and map are crucial to communicate the termination argument to Agda.


We define the identity environment by induction on the context.
\begin{code}\>\AgdaFunction{ide} \<[13]\>[13]\AgdaSymbol{:} \<[16]\>[16]\AgdaSymbol{∀} \AgdaBound{Γ} \AgdaSymbol{→} \AgdaDatatype{Env} \AgdaBound{Γ} \AgdaBound{Γ}\<\\
\>\AgdaFunction{ide} \AgdaInductiveConstructor{ε} \<[13]\>[13]\AgdaSymbol{=} \<[16]\>[16]\AgdaInductiveConstructor{ε}\<\\
\>\AgdaFunction{ide} \AgdaSymbol{(}\AgdaBound{Γ} \AgdaInductiveConstructor{,} \AgdaBound{a}\AgdaSymbol{)} \<[13]\>[13]\AgdaSymbol{=} \<[16]\>[16]\AgdaFunction{env≤} \AgdaFunction{wk} \AgdaSymbol{(}\AgdaFunction{ide} \AgdaBound{Γ}\AgdaSymbol{)} \AgdaInductiveConstructor{,} \AgdaInductiveConstructor{ne} \AgdaSymbol{(}\AgdaInductiveConstructor{var} \AgdaInductiveConstructor{zero}\AgdaSymbol{)}\<\end{code}

\noindent
Given \AgdaFunction{eval}, \AgdaFunction{ide} and \AgdaFunction{readback} we can define a
normalization function \AgdaFunction{nf} that for any term returns a delayed
normal form.

\begin{code}\>\AgdaFunction{nf} \<[10]\>[10]\AgdaSymbol{:} \<[13]\>[13]\AgdaSymbol{∀\{}\AgdaBound{Γ} \AgdaBound{a}\AgdaSymbol{\}(}\AgdaBound{t} \AgdaSymbol{:} \AgdaDatatype{Tm} \AgdaBound{Γ} \AgdaBound{a}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaDatatype{Delay} \AgdaPostulate{∞} \AgdaSymbol{(}\AgdaDatatype{Nf} \AgdaBound{Γ} \AgdaBound{a}\AgdaSymbol{)}\<\\
\>\AgdaFunction{nf} \AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}} \AgdaBound{t} \<[10]\>[10]\AgdaSymbol{=} \<[13]\>[13]\AgdaFunction{eval} \AgdaBound{t} \AgdaSymbol{(}\AgdaFunction{ide} \AgdaBound{Γ}\AgdaSymbol{)} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaFunction{readback}\<\end{code}

\section{Termination proof}

While we have managed to define the normalizer in a way acceptable to
Agda's termination checker, we have not established that simply-typed
lambda calculus is actually normalizing, \ie, that each well-typed
term reaches its normal form after a only final number of
\AgdaInductiveConstructor{delay}s have been issued.
To this end, 
we define a logical predicate \AgdaFunction{V⟦\_⟧\_}, corresponding to strong
computability on values. It is defined by induction on the type of the
value. At base type, when the value must be neutral, the relation
states that the neutral term is strongly computable if its readback
converges. At function type it states that the function is strongly
computable if, in any weakened context (in the general OPE sense) it
takes any value which is strongly computable to a delayed value which
converges to a strongly computable value. The predicate \AgdaFunction{C⟦\_⟧\_} on
delayed values \AgdaBound{v?} is shorthand for a triple

of a value \AgdaBound{v}, a proof \AgdaBound{v⇓} that the
delayed value converges to the value and a proof \AgdaBound{⟦v⟧} of strong
computability.

\begin{code}\>\AgdaFunction{V⟦\_⟧\_} \<[7]\>[7]\AgdaSymbol{:} \AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{a} \AgdaSymbol{:} \AgdaDatatype{Ty}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaDatatype{Val} \AgdaBound{Γ} \AgdaBound{a} \<[44]\>[44]\AgdaSymbol{→} \AgdaPrimitiveType{Set}\<\\
\>\AgdaFunction{C⟦\_⟧\_} \<[7]\>[7]\AgdaSymbol{:} \AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{a} \AgdaSymbol{:} \AgdaDatatype{Ty}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaDatatype{Delay} \AgdaPostulate{∞} \AgdaSymbol{(}\AgdaDatatype{Val} \AgdaBound{Γ} \AgdaBound{a}\AgdaSymbol{)} \<[44]\>[44]\AgdaSymbol{→} \AgdaPrimitiveType{Set}\<\\
\\
\>\AgdaFunction{V⟦} \AgdaInductiveConstructor{★} \<[9]\>[9]\AgdaFunction{⟧} \<[12]\>[12]\AgdaSymbol{(}\AgdaInductiveConstructor{ne} \AgdaBound{w}\AgdaSymbol{)} \<[20]\>[20]\AgdaSymbol{=} \AgdaFunction{nereadback} \AgdaBound{w} \AgdaFunction{⇓}\<\\
\>\AgdaFunction{V⟦} \AgdaBound{a} \AgdaInductiveConstructor{⇒} \AgdaBound{b} \AgdaFunction{⟧} \<[12]\>[12]\AgdaBound{\,f\,} \<[20]\>[20]\AgdaSymbol{=} \AgdaSymbol{∀\{}\AgdaBound{Δ}\AgdaSymbol{\}(}\AgdaBound{η} \AgdaSymbol{:} \AgdaBound{Δ} \AgdaDatatype{≤} \AgdaSymbol{\_)(}\AgdaBound{u} \AgdaSymbol{:} \AgdaDatatype{Val} \AgdaBound{Δ} \AgdaBound{a}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaFunction{V⟦} \AgdaBound{a} \AgdaFunction{⟧} \AgdaBound{u} \AgdaSymbol{→} \AgdaFunction{C⟦} \AgdaBound{b} \AgdaFunction{⟧} \AgdaSymbol{(}\AgdaFunction{apply} \AgdaSymbol{(}\AgdaFunction{val≤} \AgdaBound{η} \AgdaBound{\,f\,}\AgdaSymbol{)} \AgdaBound{u}\AgdaSymbol{)}\<\\
\\
\>\AgdaFunction{C⟦} \AgdaBound{a} \AgdaFunction{⟧} \<[12]\>[12]\AgdaBound{v?} \<[20]\>[20]\AgdaSymbol{=} \AgdaFunction{∃} \AgdaSymbol{λ} \AgdaBound{v} \AgdaSymbol{→} \AgdaBound{v?} \AgdaDatatype{⇓} \AgdaBound{v} \AgdaFunction{×} \AgdaFunction{V⟦} \AgdaBound{a} \AgdaFunction{⟧} \AgdaBound{v}\<\end{code}

\noindent
The notion of strongly computable value is easily extended to environments.

\begin{samepage}
\begin{code}\>\AgdaFunction{E⟦\_⟧\_} \<[21]\>[21]\AgdaSymbol{:} \<[24]\>[24]\AgdaSymbol{∀\{}\AgdaBound{Δ}\AgdaSymbol{\}(}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Cxt}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaDatatype{Env} \AgdaBound{Δ} \AgdaBound{Γ} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<\\
\>\AgdaFunction{E⟦} \AgdaInductiveConstructor{ε} \AgdaFunction{⟧} \<[12]\>[12]\AgdaInductiveConstructor{ε} \<[21]\>[21]\AgdaSymbol{=} \<[24]\>[24]\AgdaRecord{⊤}\<\\
\>\AgdaFunction{E⟦} \AgdaBound{Γ} \AgdaInductiveConstructor{,} \AgdaBound{a} \AgdaFunction{⟧} \<[12]\>[12]\AgdaSymbol{(}\AgdaBound{ρ} \AgdaInductiveConstructor{,} \AgdaBound{v}\AgdaSymbol{)} \<[21]\>[21]\AgdaSymbol{=} \<[24]\>[24]\AgdaFunction{E⟦} \AgdaBound{Γ} \AgdaFunction{⟧} \AgdaBound{ρ} \AgdaFunction{×} \AgdaFunction{V⟦} \AgdaBound{a} \AgdaFunction{⟧} \AgdaBound{v}\<\end{code}
\end{samepage}

\noindent
Later we will require weakening (applying an OPE) variables, values,
environments, etc.\ preserve identity and composition (respect functor
laws). We state these properties now but suppress the proofs.

\begin{code}\>\AgdaFunction{val≤-id} \<[9]\>[9]\AgdaSymbol{:} \AgdaSymbol{∀\{}\AgdaBound{Δ} \AgdaBound{a}\AgdaSymbol{\}} \<[19]\>[19]\AgdaSymbol{(}\AgdaBound{v} \AgdaSymbol{:} \AgdaDatatype{Val} \AgdaBound{Δ} \AgdaBound{a}\AgdaSymbol{)} \<[37]\>[37]\AgdaSymbol{→} \AgdaFunction{val≤} \AgdaInductiveConstructor{id} \AgdaBound{v} \AgdaDatatype{≡} \AgdaBound{v}\<\\
\\
\>\AgdaFunction{env≤-id} \<[9]\>[9]\AgdaSymbol{:} \AgdaSymbol{∀\{}\AgdaBound{Γ} \AgdaBound{Δ}\AgdaSymbol{\}} \<[19]\>[19]\AgdaSymbol{(}\AgdaBound{ρ} \AgdaSymbol{:} \AgdaDatatype{Env} \AgdaBound{Δ} \AgdaBound{Γ}\AgdaSymbol{)} \<[37]\>[37]\AgdaSymbol{→} \AgdaFunction{env≤} \AgdaInductiveConstructor{id} \AgdaBound{ρ} \AgdaDatatype{≡} \AgdaBound{ρ}\<\\
\\
\>\AgdaFunction{nev≤-id} \<[9]\>[9]\AgdaSymbol{:} \AgdaSymbol{∀\{}\AgdaBound{Δ} \AgdaBound{a}\AgdaSymbol{\}} \<[19]\>[19]\AgdaSymbol{(}\AgdaBound{t} \AgdaSymbol{:} \AgdaDatatype{Ne} \AgdaDatatype{Val} \AgdaBound{Δ} \AgdaBound{a}\AgdaSymbol{)} \<[37]\>[37]\AgdaSymbol{→} \AgdaFunction{nev≤} \AgdaInductiveConstructor{id} \AgdaBound{t} \AgdaDatatype{≡} \AgdaBound{t}\<\end{code}

\AgdaHide{
\begin{code}\>\AgdaFunction{env≤-id} \AgdaInductiveConstructor{ε} \<[18]\>[18]\AgdaSymbol{=} \AgdaInductiveConstructor{refl}\<\\
\>\AgdaFunction{env≤-id} \AgdaSymbol{(}\AgdaBound{ρ} \AgdaInductiveConstructor{,} \AgdaBound{v}\AgdaSymbol{)} \<[18]\>[18]\AgdaSymbol{=} \AgdaFunction{cong₂} \AgdaInductiveConstructor{\_,\_} \AgdaSymbol{(}\AgdaFunction{env≤-id} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{val≤-id} \AgdaBound{v}\AgdaSymbol{)}\<\\
\\
\>\AgdaFunction{val≤-id} \AgdaSymbol{(}\AgdaInductiveConstructor{ne} \AgdaBound{t}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaFunction{cong} \AgdaInductiveConstructor{ne} \AgdaSymbol{(}\AgdaFunction{nev≤-id} \AgdaBound{t}\AgdaSymbol{)}\<\\
\>\AgdaFunction{val≤-id} \AgdaSymbol{(}\AgdaInductiveConstructor{lam} \AgdaBound{t} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaFunction{cong} \AgdaSymbol{(}\AgdaInductiveConstructor{lam} \AgdaBound{t}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{env≤-id} \AgdaBound{ρ}\AgdaSymbol{)}\<\\
\\
\>\AgdaFunction{nev≤-id} \AgdaSymbol{(}\AgdaInductiveConstructor{var} \AgdaBound{x}\AgdaSymbol{)} \<[18]\>[18]\AgdaSymbol{=} \AgdaInductiveConstructor{refl}\<\\
\>\AgdaFunction{nev≤-id} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{t} \AgdaBound{u}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaFunction{cong₂} \AgdaInductiveConstructor{app} \AgdaSymbol{(}\AgdaFunction{nev≤-id} \AgdaBound{t}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{val≤-id} \AgdaBound{u}\AgdaSymbol{)}\<\end{code}}

\begin{code}\>\AgdaFunction{var≤-•} \<[8]\>[8]\AgdaSymbol{:} \<[11]\>[11]\AgdaSymbol{∀\{}\AgdaBound{Δ} \AgdaBound{Δ\kern-1pt′} \AgdaBound{Δ\kern-1pt″} \AgdaBound{a}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{η} \AgdaSymbol{:} \AgdaBound{Δ} \AgdaDatatype{≤} \AgdaBound{Δ\kern-1pt′}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{η′} \AgdaSymbol{:} \AgdaBound{Δ\kern-1pt′} \AgdaDatatype{≤} \AgdaBound{Δ\kern-1pt″}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{x} \AgdaSymbol{:} \AgdaDatatype{Var} \AgdaBound{Δ\kern-1pt″} \AgdaBound{a}\AgdaSymbol{)} \AgdaSymbol{→}\<\\
\>[2]\AgdaIndent{11}{}\<[11]\>[11]\AgdaFunction{var≤} \AgdaBound{η} \AgdaSymbol{(}\AgdaFunction{var≤} \AgdaBound{η′} \AgdaBound{x}\AgdaSymbol{)} \AgdaDatatype{≡} \AgdaFunction{var≤} \AgdaSymbol{(}\AgdaBound{η} \AgdaFunction{•} \AgdaBound{η′}\AgdaSymbol{)} \AgdaBound{x}\<\\
\\
\>\AgdaFunction{val≤-•} \<[8]\>[8]\AgdaSymbol{:} \<[11]\>[11]\AgdaSymbol{∀\{}\AgdaBound{Δ} \AgdaBound{Δ\kern-1pt′} \AgdaBound{Δ\kern-1pt″} \AgdaBound{a}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{η} \AgdaSymbol{:} \AgdaBound{Δ} \AgdaDatatype{≤} \AgdaBound{Δ\kern-1pt′}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{η′} \AgdaSymbol{:} \AgdaBound{Δ\kern-1pt′} \AgdaDatatype{≤} \AgdaBound{Δ\kern-1pt″}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{v} \AgdaSymbol{:} \AgdaDatatype{Val} \AgdaBound{Δ\kern-1pt″} \AgdaBound{a}\AgdaSymbol{)} \AgdaSymbol{→}\<\\
\>[2]\AgdaIndent{11}{}\<[11]\>[11]\AgdaFunction{val≤} \AgdaBound{η} \AgdaSymbol{(}\AgdaFunction{val≤} \AgdaBound{η′} \AgdaBound{v}\AgdaSymbol{)} \AgdaDatatype{≡} \AgdaFunction{val≤} \AgdaSymbol{(}\AgdaBound{η} \AgdaFunction{•} \AgdaBound{η′}\AgdaSymbol{)} \AgdaBound{v}\<\\
\\
\>\AgdaFunction{env≤-•} \<[8]\>[8]\AgdaSymbol{:} \<[11]\>[11]\AgdaSymbol{∀\{}\AgdaBound{Γ} \AgdaBound{Δ} \AgdaBound{Δ\kern-1pt′} \AgdaBound{Δ\kern-1pt″}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{η} \AgdaSymbol{:} \AgdaBound{Δ} \AgdaDatatype{≤} \AgdaBound{Δ\kern-1pt′}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{η′} \AgdaSymbol{:} \AgdaBound{Δ\kern-1pt′} \AgdaDatatype{≤} \AgdaBound{Δ\kern-1pt″}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{ρ} \AgdaSymbol{:} \AgdaDatatype{Env} \AgdaBound{Δ\kern-1pt″} \AgdaBound{Γ}\AgdaSymbol{)} \AgdaSymbol{→}\<\\
\>[2]\AgdaIndent{11}{}\<[11]\>[11]\AgdaFunction{env≤} \AgdaBound{η} \AgdaSymbol{(}\AgdaFunction{env≤} \AgdaBound{η′} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaDatatype{≡} \AgdaFunction{env≤} \AgdaSymbol{(}\AgdaBound{η} \AgdaFunction{•} \AgdaBound{η′}\AgdaSymbol{)} \AgdaBound{ρ}\<\\
\\
\>\AgdaFunction{nev≤-•} \<[8]\>[8]\AgdaSymbol{:} \<[11]\>[11]\AgdaSymbol{∀\{}\AgdaBound{Δ} \AgdaBound{Δ\kern-1pt′} \AgdaBound{Δ\kern-1pt″} \AgdaBound{a}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{η} \AgdaSymbol{:} \AgdaBound{Δ} \AgdaDatatype{≤} \AgdaBound{Δ\kern-1pt′}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{η′} \AgdaSymbol{:} \AgdaBound{Δ\kern-1pt′} \AgdaDatatype{≤} \AgdaBound{Δ\kern-1pt″}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{t} \AgdaSymbol{:} \AgdaDatatype{Ne} \AgdaDatatype{Val} \AgdaBound{Δ\kern-1pt″} \AgdaBound{a}\AgdaSymbol{)} \AgdaSymbol{→}\<\\
\>[2]\AgdaIndent{11}{}\<[11]\>[11]\AgdaFunction{nev≤} \AgdaBound{η} \AgdaSymbol{(}\AgdaFunction{nev≤} \AgdaBound{η′} \AgdaBound{t}\AgdaSymbol{)} \AgdaDatatype{≡} \AgdaFunction{nev≤} \AgdaSymbol{(}\AgdaBound{η} \AgdaFunction{•} \AgdaBound{η′}\AgdaSymbol{)} \AgdaBound{t}\<\end{code}

\AgdaHide{
\begin{code}\>\AgdaFunction{var≤-•} \AgdaInductiveConstructor{id} \<[16]\>[16]\AgdaBound{η′} \<[26]\>[26]\AgdaBound{x} \<[34]\>[34]\AgdaSymbol{=} \AgdaInductiveConstructor{refl}\<\\
\>\AgdaFunction{var≤-•} \AgdaSymbol{(}\AgdaInductiveConstructor{weak} \AgdaBound{η}\AgdaSymbol{)} \AgdaBound{η′} \<[26]\>[26]\AgdaBound{x} \<[34]\>[34]\AgdaSymbol{=} \AgdaFunction{cong} \AgdaInductiveConstructor{suc} \AgdaSymbol{(}\AgdaFunction{var≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaBound{x}\AgdaSymbol{)}\<\\
\>\AgdaFunction{var≤-•} \AgdaSymbol{(}\AgdaInductiveConstructor{lift} \AgdaBound{η}\AgdaSymbol{)} \AgdaInductiveConstructor{id} \<[26]\>[26]\AgdaBound{x} \<[34]\>[34]\AgdaSymbol{=} \AgdaInductiveConstructor{refl}\<\\
\>\AgdaFunction{var≤-•} \AgdaSymbol{(}\AgdaInductiveConstructor{lift} \AgdaBound{η}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{weak} \AgdaBound{η′}\AgdaSymbol{)} \AgdaBound{x} \<[34]\>[34]\AgdaSymbol{=} \AgdaFunction{cong} \AgdaInductiveConstructor{suc} \AgdaSymbol{(}\AgdaFunction{var≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaBound{x}\AgdaSymbol{)}\<\\
\>\AgdaFunction{var≤-•} \AgdaSymbol{(}\AgdaInductiveConstructor{lift} \AgdaBound{η}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{lift} \AgdaBound{η′}\AgdaSymbol{)} \AgdaInductiveConstructor{zero} \<[34]\>[34]\AgdaSymbol{=} \AgdaInductiveConstructor{refl}\<\\
\>\AgdaFunction{var≤-•} \AgdaSymbol{(}\AgdaInductiveConstructor{lift} \AgdaBound{η}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{lift} \AgdaBound{η′}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{suc} \AgdaBound{x}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaFunction{cong} \AgdaInductiveConstructor{suc} \AgdaSymbol{(}\AgdaFunction{var≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaBound{x}\AgdaSymbol{)}\<\\
\\
\>\AgdaFunction{env≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaInductiveConstructor{ε} \<[20]\>[20]\AgdaSymbol{=} \AgdaInductiveConstructor{refl}\<\\
\>\AgdaFunction{env≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaSymbol{(}\AgdaBound{ρ} \AgdaInductiveConstructor{,} \AgdaBound{v}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaFunction{cong₂} \AgdaInductiveConstructor{\_,\_} \AgdaSymbol{(}\AgdaFunction{env≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{val≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaBound{v}\AgdaSymbol{)}\<\\
\\
\>\AgdaFunction{val≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaSymbol{(}\AgdaInductiveConstructor{ne} \AgdaBound{w}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaFunction{cong} \AgdaInductiveConstructor{ne} \AgdaSymbol{(}\AgdaFunction{nev≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaBound{w}\AgdaSymbol{)}\<\\
\>\AgdaFunction{val≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaSymbol{(}\AgdaInductiveConstructor{lam} \AgdaBound{t} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaFunction{cong} \AgdaSymbol{(}\AgdaInductiveConstructor{lam} \AgdaBound{t}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{env≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaBound{ρ}\AgdaSymbol{)}\<\\
\\
\>\AgdaFunction{nev≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaSymbol{(}\AgdaInductiveConstructor{var} \AgdaBound{x}\AgdaSymbol{)} \<[22]\>[22]\AgdaSymbol{=} \AgdaFunction{cong} \AgdaInductiveConstructor{var} \AgdaSymbol{(}\AgdaFunction{var≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaBound{x}\AgdaSymbol{)}\<\\
\>\AgdaFunction{nev≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{w} \AgdaBound{v}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaFunction{cong₂} \AgdaInductiveConstructor{app} \AgdaSymbol{(}\AgdaFunction{nev≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaBound{w}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{val≤-•} \AgdaBound{η} \AgdaBound{η′} \AgdaBound{v}\AgdaSymbol{)}\<\end{code}}

\noindent
We also require that the operations that we introduce such as lookup,
eval, apply, readback etc.\ commute with weakening. We, again, state
these necessary properties but suppress the proofs.

\begin{code}\>\AgdaFunction{lookup≤} \<[9]\>[9]\AgdaSymbol{:} \<[12]\>[12]\AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaBound{Δ} \AgdaBound{Δ\kern-1pt′} \AgdaBound{a}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{x} \AgdaSymbol{:} \AgdaDatatype{Var} \AgdaBound{Γ} \AgdaBound{a}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{ρ} \AgdaSymbol{:} \AgdaDatatype{Env} \AgdaBound{Δ} \AgdaBound{Γ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{η} \AgdaSymbol{:} \AgdaBound{Δ\kern-1pt′} \AgdaDatatype{≤} \AgdaBound{Δ}\AgdaSymbol{)} \AgdaSymbol{→}\<\\
\>[11]\AgdaIndent{12}{}\<[12]\>[12]\AgdaFunction{val≤} \AgdaBound{η} \AgdaSymbol{(}\AgdaFunction{lookup} \AgdaBound{x} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaDatatype{≡} \AgdaFunction{lookup} \AgdaBound{x} \AgdaSymbol{(}\AgdaFunction{env≤} \AgdaBound{η} \AgdaBound{ρ}\AgdaSymbol{)}\<\\
\\
\>\AgdaFunction{eval≤} \<[9]\>[9]\AgdaSymbol{:} \<[12]\>[12]\AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{i} \AgdaBound{Γ} \AgdaBound{Δ} \AgdaBound{Δ\kern-1pt′} \AgdaBound{a}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{t} \AgdaSymbol{:} \AgdaDatatype{Tm} \AgdaBound{Γ} \AgdaBound{a}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{ρ} \AgdaSymbol{:} \AgdaDatatype{Env} \AgdaBound{Δ} \AgdaBound{Γ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{η} \AgdaSymbol{:} \AgdaBound{Δ\kern-1pt′} \AgdaDatatype{≤} \AgdaBound{Δ}\AgdaSymbol{)} \AgdaSymbol{→}\<\\
\>[11]\AgdaIndent{12}{}\<[12]\>[12]\AgdaSymbol{(}\AgdaFunction{val≤} \AgdaBound{η} \AgdaFunction{\ensuremath{{<}\{>}}} \AgdaFunction{apply} \AgdaBound{\,f\,} \AgdaBound{v}\AgdaSymbol{)} \AgdaFunction{∼⟨} \AgdaBound{i} \AgdaFunction{⟩∼} \AgdaSymbol{(}\AgdaFunction{apply} \AgdaSymbol{(}\AgdaFunction{val≤} \AgdaBound{η} \AgdaBound{\,f\,}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{val≤} \AgdaBound{η} \AgdaBound{v}\AgdaSymbol{))}\<\\
\\
\>\AgdaFunction{beta≤} \<[9]\>[9]\AgdaSymbol{:} \<[12]\>[12]\AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{i} \AgdaBound{Γ} \AgdaBound{Δ} \AgdaBound{E} \AgdaBound{a} \AgdaBound{b}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{t} \AgdaSymbol{:} \AgdaDatatype{Tm} \AgdaSymbol{(}\AgdaBound{Γ} \AgdaInductiveConstructor{,} \AgdaBound{a}\AgdaSymbol{)} \AgdaBound{b}\AgdaSymbol{)(}\AgdaBound{ρ} \AgdaSymbol{:} \AgdaDatatype{Env} \AgdaBound{Δ} \AgdaBound{Γ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{v} \AgdaSymbol{:} \AgdaDatatype{Val} \AgdaBound{Δ} \AgdaBound{a}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{η} \AgdaSymbol{:} \AgdaBound{E} \AgdaDatatype{≤} \AgdaBound{Δ}\AgdaSymbol{)} \AgdaSymbol{→}\<\\
\>[11]\AgdaIndent{12}{}\<[12]\>[12]\AgdaSymbol{(}\AgdaFunction{val≤} \AgdaBound{η} \AgdaFunction{∞\ensuremath{{<}\{>}}} \AgdaFunction{nereadback} \AgdaBound{t}\AgdaSymbol{)} \AgdaFunction{∼⟨} \AgdaBound{i} \AgdaFunction{⟩∼} \AgdaSymbol{(}\AgdaFunction{nereadback} \AgdaSymbol{(}\AgdaFunction{nev≤} \AgdaBound{η} \AgdaBound{t}\AgdaSymbol{))}\<\\
\\
\>\AgdaFunction{readback≤} \<[13]\>[13]\AgdaSymbol{:} \<[16]\>[16]\AgdaSymbol{∀\{}\AgdaBound{i} \AgdaBound{Γ} \AgdaBound{Δ}\AgdaSymbol{\}} \AgdaBound{a} \AgdaSymbol{(}\AgdaBound{η} \AgdaSymbol{:} \AgdaBound{Δ} \AgdaDatatype{≤} \AgdaBound{Γ}\AgdaSymbol{)(}\AgdaBound{v} \AgdaSymbol{:} \AgdaDatatype{Val} \AgdaBound{Γ} \AgdaBound{a}\AgdaSymbol{)} \AgdaSymbol{→}\<\\
\>[2]\AgdaIndent{16}{}\<[16]\>[16]\AgdaSymbol{(}\AgdaFunction{nf≤} \AgdaBound{η} \AgdaFunction{\ensuremath{{<}\{>}}} \AgdaFunction{eta} \AgdaBound{v}\AgdaSymbol{)} \AgdaRecord{∞∼⟨} \AgdaBound{i} \AgdaRecord{⟩∼} \AgdaSymbol{(}\AgdaFunction{eta} \AgdaSymbol{(}\AgdaFunction{val≤} \AgdaBound{η} \AgdaBound{v}\AgdaSymbol{))}\<\end{code} \end{samepage}

\AgdaHide{
\begin{code}\>\AgdaFunction{nereadback≤} \AgdaBound{η} \AgdaSymbol{(}\AgdaInductiveConstructor{var} \AgdaBound{x}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{∼now} \AgdaSymbol{\_}\<\\
\>\AgdaFunction{nereadback≤} \AgdaBound{η} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{t} \AgdaBound{u}\AgdaSymbol{)} \AgdaSymbol{=}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaFunction{proof}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaSymbol{((}\AgdaFunction{nereadback} \AgdaBound{t} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}}\<\\
\>[2]\AgdaIndent{4}{}\<[4]\>[4]\AgdaSymbol{(λ} \AgdaBound{t₁} \AgdaSymbol{→} \AgdaFunction{readback} \AgdaBound{u} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{n} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{t₁} \AgdaBound{n}\AgdaSymbol{))))}\<\\
\>[4]\AgdaIndent{33}{}\<[33]\>[33]\AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{x′} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaFunction{nen≤} \AgdaBound{η} \AgdaBound{x′}\AgdaSymbol{)))}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaFunction{\qquad∼⟨} \AgdaFunction{bind-assoc} \AgdaSymbol{(}\AgdaFunction{nereadback} \AgdaBound{t}\AgdaSymbol{)} \AgdaFunction{⟩}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaSymbol{(}\AgdaFunction{nereadback} \AgdaBound{t} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{x} \AgdaSymbol{→}\<\\
\>[2]\AgdaIndent{4}{}\<[4]\>[4]\AgdaSymbol{(}\AgdaFunction{readback} \AgdaBound{u} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{n} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{x} \AgdaBound{n}\AgdaSymbol{)))}\<\\
\>[4]\AgdaIndent{33}{}\<[33]\>[33]\AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{x′} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaFunction{nen≤} \AgdaBound{η} \AgdaBound{x′}\AgdaSymbol{))))}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaFunction{\qquad∼⟨} \AgdaFunction{bind-cong-r} \AgdaSymbol{(}\AgdaFunction{nereadback} \AgdaBound{t}\AgdaSymbol{)} \AgdaSymbol{(λ} \AgdaBound{x} \AgdaSymbol{→} \AgdaFunction{bind-assoc} \AgdaSymbol{(}\AgdaFunction{readback} \AgdaBound{u}\AgdaSymbol{))} \AgdaFunction{⟩}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaSymbol{(}\AgdaFunction{nereadback} \AgdaBound{t} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{x} \AgdaSymbol{→}\<\\
\>[2]\AgdaIndent{5}{}\<[5]\>[5]\AgdaFunction{readback} \AgdaBound{u} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{y} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{x} \AgdaBound{y}\AgdaSymbol{)} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{x′} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaFunction{nen≤} \AgdaBound{η} \AgdaBound{x′}\AgdaSymbol{)))))}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaFunction{\qquad≡⟨⟩}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaSymbol{(}\AgdaFunction{nereadback} \AgdaBound{t} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}}\<\\
\>[2]\AgdaIndent{4}{}\<[4]\>[4]\AgdaSymbol{(λ} \AgdaBound{x} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaFunction{readback} \AgdaBound{u} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{y} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaSymbol{(}\AgdaFunction{nen≤} \AgdaBound{η} \AgdaBound{x}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{nf≤} \AgdaBound{η} \AgdaBound{y}\AgdaSymbol{))))))}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaFunction{\qquad≡⟨⟩}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaSymbol{(}\AgdaFunction{nereadback} \AgdaBound{t} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}}\<\\
\>[2]\AgdaIndent{9}{}\<[9]\>[9]\AgdaSymbol{(λ} \AgdaBound{x} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaFunction{readback} \AgdaBound{u} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{x′} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaFunction{nf≤} \AgdaBound{η} \AgdaBound{x′}\AgdaSymbol{)} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}}\<\\
\>[9]\AgdaIndent{13}{}\<[13]\>[13]\AgdaSymbol{(λ} \AgdaBound{n} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaSymbol{(}\AgdaFunction{nen≤} \AgdaBound{η} \AgdaBound{x}\AgdaSymbol{)} \AgdaBound{n}\AgdaSymbol{))))))}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaFunction{\qquad∼⟨} \AgdaFunction{bind-cong-r} \AgdaSymbol{(}\AgdaFunction{nereadback} \AgdaBound{t}\AgdaSymbol{)} \AgdaSymbol{(λ} \AgdaBound{x} \AgdaSymbol{→} \AgdaFunction{∼sym} \AgdaSymbol{(}\AgdaFunction{bind-assoc} \AgdaSymbol{(}\AgdaFunction{readback} \AgdaBound{u}\AgdaSymbol{)))} \AgdaFunction{⟩}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaSymbol{(}\AgdaFunction{nereadback} \AgdaBound{t} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}}\<\\
\>[2]\AgdaIndent{9}{}\<[9]\>[9]\AgdaSymbol{(λ} \AgdaBound{x} \AgdaSymbol{→} \AgdaSymbol{((}\AgdaFunction{readback} \AgdaBound{u} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{x′} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaFunction{nf≤} \AgdaBound{η} \AgdaBound{x′}\AgdaSymbol{)))} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}}\<\\
\>[9]\AgdaIndent{13}{}\<[13]\>[13]\AgdaSymbol{(λ} \AgdaBound{n} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaSymbol{(}\AgdaFunction{nen≤} \AgdaBound{η} \AgdaBound{x}\AgdaSymbol{)} \AgdaBound{n}\AgdaSymbol{)))))}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaFunction{\qquad≡⟨⟩}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaSymbol{(}\AgdaFunction{nereadback} \AgdaBound{t} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{x} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaFunction{nen≤} \AgdaBound{η} \AgdaBound{x}\AgdaSymbol{)} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}}\<\\
\>[2]\AgdaIndent{4}{}\<[4]\>[4]\AgdaSymbol{(λ} \AgdaBound{t₁} \AgdaSymbol{→} \AgdaSymbol{((}\AgdaFunction{readback} \AgdaBound{u} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{x′} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaFunction{nf≤} \AgdaBound{η} \AgdaBound{x′}\AgdaSymbol{)))} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}}\<\\
\>[4]\AgdaIndent{8}{}\<[8]\>[8]\AgdaSymbol{(λ} \AgdaBound{n} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{t₁} \AgdaBound{n}\AgdaSymbol{))))))}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaFunction{\qquad∼⟨} \AgdaFunction{∼sym} \AgdaSymbol{(}\AgdaFunction{bind-assoc} \AgdaSymbol{(}\AgdaFunction{nereadback} \AgdaBound{t}\AgdaSymbol{))} \AgdaFunction{⟩}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaSymbol{((}\AgdaFunction{nereadback} \AgdaBound{t} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{x′} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaFunction{nen≤} \AgdaBound{η} \AgdaBound{x′}\AgdaSymbol{)))} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}}\<\\
\>[2]\AgdaIndent{4}{}\<[4]\>[4]\AgdaSymbol{(λ} \AgdaBound{t₁} \AgdaSymbol{→} \AgdaSymbol{((}\AgdaFunction{readback} \AgdaBound{u} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{x′} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaFunction{nf≤} \AgdaBound{η} \AgdaBound{x′}\AgdaSymbol{)))} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}}\<\\
\>[4]\AgdaIndent{8}{}\<[8]\>[8]\AgdaSymbol{(λ} \AgdaBound{n} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{t₁} \AgdaBound{n}\AgdaSymbol{)))))}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaFunction{\qquad≡⟨⟩}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaSymbol{(}\AgdaFunction{nen≤} \AgdaBound{η} \AgdaFunction{\ensuremath{{<}\{>}}} \AgdaFunction{readback} \AgdaBound{u} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{n} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{t₁} \AgdaBound{n}\AgdaSymbol{))))}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaFunction{\qquad∼⟨} \AgdaFunction{bind-cong-r} \AgdaSymbol{(}\AgdaFunction{nen≤} \AgdaBound{η} \AgdaFunction{\ensuremath{{<}\{>}}} \AgdaFunction{nereadback} \AgdaBound{t} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}}\<\\
\>[2]\AgdaIndent{5}{}\<[5]\>[5]\AgdaSymbol{(λ} \AgdaBound{t₁} \AgdaSymbol{→} \AgdaFunction{readback} \AgdaSymbol{(}\AgdaFunction{val≤} \AgdaBound{η} \AgdaBound{u}\AgdaSymbol{)} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{n} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{t₁} \AgdaBound{n}\AgdaSymbol{))))}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaFunction{\qquad∼⟨} \<[6]\>[6]\AgdaFunction{bind-cong-l} \AgdaSymbol{(}\AgdaFunction{nereadback≤} \AgdaBound{η} \AgdaBound{t}\AgdaSymbol{)} \AgdaSymbol{(λ} \AgdaBound{x} \AgdaSymbol{→} \AgdaSymbol{\_)} \AgdaFunction{⟩}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaSymbol{(}\AgdaFunction{nereadback} \AgdaSymbol{(}\AgdaFunction{nev≤} \AgdaBound{η} \AgdaBound{t}\AgdaSymbol{)} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}}\<\\
\>[2]\AgdaIndent{5}{}\<[5]\>[5]\AgdaSymbol{(λ} \AgdaBound{t₁} \AgdaSymbol{→} \AgdaFunction{readback} \AgdaSymbol{(}\AgdaFunction{val≤} \AgdaBound{η} \AgdaBound{u}\AgdaSymbol{)} \AgdaFunction{\ensuremath{\mathbin{{>}\mkern-8.5mu{>}\mkern-2mu{=}}}} \AgdaSymbol{(λ} \AgdaBound{n} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{t₁} \AgdaBound{n}\AgdaSymbol{))))}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaFunction{∎}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaKeyword{where} \AgdaKeyword{open} \AgdaModule{∼-Reasoning}\<\\
\>\<\end{code}}

\noindent
As an example of a commutivity lemma, we show the proofs of the base case (type \AgdaInductiveConstructor{★}) for
\AgdaFunction{readback≤}.  The proof is a chain of bisimulation equations (in
relation \presizedbisim{i}), and we use the preorder reasoning package of
Agda's standard library which provides nice syntax for equality
chains, following an idea of Augustsson~\cite{augustsson:equalityProofs}.
Justification for each step is provided in angle brackets, some steps
(\AgdaFunction{≡⟨⟩}) hold directly by definition.

\begin{code}\>\AgdaFunction{readback≤} \AgdaInductiveConstructor{★} \AgdaBound{η} \AgdaSymbol{(}\AgdaInductiveConstructor{ne} \AgdaBound{w}\AgdaSymbol{)} \AgdaSymbol{=}\<\\
\>[0]\AgdaIndent{2}{}\<[2]\>[2]\AgdaFunction{proof}\<\\
\>[2]\AgdaIndent{4}{}\<[4]\>[4]\AgdaFunction{nf≤} \AgdaBound{η} \<[11]\>[11]\AgdaFunction{\ensuremath{{<}\{>}}} \AgdaFunction{nereadback} \AgdaBound{w}\AgdaSymbol{)} \<[42]\>[42]\AgdaFunction{\qquad∼⟨} \AgdaFunction{map-compose} \AgdaSymbol{(}\AgdaFunction{nereadback} \AgdaBound{w}\AgdaSymbol{)} \AgdaFunction{⟩}\<\\
\>[2]\AgdaIndent{4}{}\<[4]\>[4]\AgdaSymbol{(}\AgdaFunction{nf≤} \AgdaBound{η} \AgdaFunction{∘} \AgdaInductiveConstructor{ne}\AgdaSymbol{)} \<[22]\>[22]\AgdaFunction{\ensuremath{{<}\{>}}} \AgdaFunction{nereadback} \AgdaBound{w} \<[43]\>[43]\AgdaFunction{\qquad∼⟨} \AgdaFunction{∼sym} \AgdaSymbol{(}\AgdaFunction{map-compose} \AgdaSymbol{(}\AgdaFunction{nereadback} \AgdaBound{w}\AgdaSymbol{))} \AgdaFunction{⟩}\<\\
\>[2]\AgdaIndent{4}{}\<[4]\>[4]\AgdaInductiveConstructor{ne} \AgdaFunction{\ensuremath{{<}\{>}}} \AgdaFunction{nereadback} \AgdaBound{w}\AgdaSymbol{)} \<[43]\>[43]\AgdaFunction{\qquad∼⟨} \AgdaFunction{map-cong} \AgdaInductiveConstructor{ne} \AgdaSymbol{(}\AgdaFunction{nereadback≤} \AgdaBound{η} \AgdaBound{w}\AgdaSymbol{)} \AgdaFunction{⟩}\<\\
\>[2]\AgdaIndent{4}{}\<[4]\>[4]\AgdaInductiveConstructor{ne} \AgdaFunction{\ensuremath{{<}\\beta\AgdaInductiveConstructor{var}\;\AgdaInductiveConstructor{zero}\AgdaBound{a}\;\AgdaInductiveConstructor{⇒}\;\AgdaBound{b}{>}}} \AgdaFunction{readback} \AgdaBound{u}\AgdaSymbol{)}\<\\
\>[33]\AgdaIndent{40}{}\<[40]\>[40]\AgdaBound{⇓m}\<\\
\>[33]\AgdaIndent{40}{}\<[40]\>[40]\AgdaSymbol{(}\AgdaFunction{bind⇓} \AgdaSymbol{(λ} \AgdaBound{n} \AgdaSymbol{→} \AgdaInductiveConstructor{now} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{m′} \AgdaBound{n}\AgdaSymbol{))} \AgdaBound{⇓n} \AgdaInductiveConstructor{now⇓}\AgdaSymbol{))}\<\\
\>[0]\AgdaIndent{4}{}\<[4]\>[4]\AgdaKeyword{in} \<[9]\>[9]\AgdaInductiveConstructor{ne} \AgdaBound{wu} \AgdaInductiveConstructor{,} \AgdaInductiveConstructor{now⇓} \AgdaInductiveConstructor{,} \AgdaBound{⟦wu⟧}\<\\
\>\<\end{code} 

\noindent
As immediate corollaries we get that all variables are strongly
computable and that the identity environment is strongly computable.

\begin{code}\>\AgdaFunction{var↑} \<[15]\>[15]\AgdaSymbol{:} \<[18]\>[18]\AgdaSymbol{∀\{}\AgdaBound{Γ} \AgdaBound{a}\AgdaSymbol{\}(}\AgdaBound{x} \AgdaSymbol{:} \AgdaDatatype{Var} \AgdaBound{Γ} \AgdaBound{a}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaFunction{V⟦} \AgdaBound{a} \AgdaFunction{⟧} \AgdaInductiveConstructor{ne} \AgdaSymbol{(}\AgdaInductiveConstructor{var} \AgdaBound{x}\AgdaSymbol{)}\<\\
\>\AgdaFunction{var↑} \AgdaBound{x} \<[15]\>[15]\AgdaSymbol{=} \<[18]\>[18]\AgdaFunction{reflect} \AgdaSymbol{\_} \AgdaSymbol{(}\AgdaInductiveConstructor{var} \AgdaBound{x}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{var} \AgdaBound{x} \AgdaInductiveConstructor{,} \AgdaInductiveConstructor{now⇓}\AgdaSymbol{)}\<\\
\\
\>\AgdaFunction{⟦ide⟧} \<[15]\>[15]\AgdaSymbol{:} \<[18]\>[18]\AgdaSymbol{∀} \AgdaBound{Γ} \AgdaSymbol{→} \AgdaFunction{E⟦} \AgdaBound{Γ} \AgdaFunction{⟧} \AgdaSymbol{(}\AgdaFunction{ide} \AgdaBound{Γ}\AgdaSymbol{)}\<\\
\>\AgdaFunction{⟦ide⟧} \AgdaInductiveConstructor{ε} \<[15]\>[15]\AgdaSymbol{=} \<[18]\>[18]\AgdaSymbol{\_}\<\\
\>\AgdaFunction{⟦ide⟧} \AgdaSymbol{(}\AgdaBound{Γ} \AgdaInductiveConstructor{,} \AgdaBound{a}\AgdaSymbol{)} \<[15]\>[15]\AgdaSymbol{=} \<[18]\>[18]\AgdaFunction{E⟦⟧≤} \AgdaFunction{wk} \AgdaSymbol{(}\AgdaFunction{ide} \AgdaBound{Γ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{⟦ide⟧} \AgdaBound{Γ}\AgdaSymbol{)} \AgdaInductiveConstructor{,} \AgdaFunction{var↑} \AgdaInductiveConstructor{zero}\<\end{code}

\noindent
Finally we can plug the termination of \AgdaFunction{eval} in the identity
environment to yield a strongly computable value and the termination
of \AgdaFunction{readback} give a strongly computable value to yield the
termination of \AgdaFunction{nf}.

\begin{code}\>\AgdaFunction{normalize} \<[17]\>[17]\AgdaSymbol{:} \<[20]\>[20]\AgdaSymbol{∀} \AgdaBound{Γ} \AgdaBound{a} \AgdaSymbol{(}\AgdaBound{t} \AgdaSymbol{:} \AgdaDatatype{Tm} \AgdaBound{Γ} \AgdaBound{a}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaFunction{∃} \AgdaSymbol{λ} \AgdaBound{n} \AgdaSymbol{→} \AgdaFunction{nf} \AgdaBound{t} \AgdaDatatype{⇓} \AgdaBound{n}\<\\
\>\AgdaFunction{normalize} \AgdaBound{Γ} \AgdaBound{a} \AgdaBound{t} \<[17]\>[17]\AgdaSymbol{=} \<[20]\>[20]\AgdaKeyword{let} \<[25]\>[25]\AgdaBound{v} \AgdaInductiveConstructor{,} \AgdaBound{v⇓} \AgdaInductiveConstructor{,} \AgdaBound{⟦v⟧} \<[39]\>[39]\AgdaSymbol{=} \AgdaFunction{term} \AgdaBound{t} \AgdaSymbol{(}\AgdaFunction{ide} \AgdaBound{Γ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{⟦ide⟧} \AgdaBound{Γ}\AgdaSymbol{)}\<\\
\>[4]\AgdaIndent{25}{}\<[25]\>[25]\AgdaBound{n} \AgdaInductiveConstructor{,} \AgdaBound{⇓n} \<[39]\>[39]\AgdaSymbol{=} \AgdaFunction{reify} \AgdaBound{a} \AgdaBound{v} \AgdaBound{⟦v⟧}\<\\
\>[0]\AgdaIndent{20}{}\<[20]\>[20]\AgdaKeyword{in} \<[25]\>[25]\AgdaBound{n} \AgdaInductiveConstructor{,} \AgdaFunction{bind⇓} \AgdaFunction{readback} \AgdaBound{v⇓} \AgdaBound{⇓n}\<\end{code}


\section{Conclusions}

We have presented a coinductive normalizer for
simply typed lambda calculus and proved that it terminates. The
combination of the coinductive normalizer and termination proof yield
a terminating normalizer function in type theory.

The successful formalization serves as a proof-of-concept for
coinductive programming and proving using sized types and copatterns,
a new and presently experimental feature of Agda. The approach we have
taken lifts easily to extensions such as G\"odel's System T.

\paragraph*{Acknowledgments}

The authors are grateful to Nils Anders Danielsson for discussions and
his talk at \emph{Shonan Meeting 026: Coinduction for computation
structures and programming} in October 2013 which inspired this
work. We also thank the anonymous referees for their helpful comments.

Andreas Abel has been supported by framework grant 254820104
of Vetenskapsr\aa{}det
to the Chalmers ProgLog group, held by Thierry Coquand.
James Chapman has been supported by the ERDF funded Estonian CoE project EXCS
and ICT National Programme project “Coinduction”, the Estonian
Ministry of Research and Education target-financed research theme
no.~0140007s12 and the Estonian Science Foundation grant no.~9219.

This article has been type set with the Stevan Andjelkovic's LaTeX backend for Agda.

\bibliographystyle{eptcs}
\bibliography{auto-eptcs14,byhand}

\end{document}
