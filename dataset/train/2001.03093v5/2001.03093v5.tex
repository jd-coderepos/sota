

\documentclass[runningheads]{llncs}
\usepackage[export]{adjustbox}
\usepackage{graphicx}
\usepackage[percent]{overpic}
\usepackage{comment}
\usepackage{amsmath,amssymb} \usepackage{booktabs}
\usepackage{multirow}
\usepackage{gensymb}

\newcommand{\algname}{\mbox{Trajectron++}}
\newcommand{\emphalgname}{\emph{\algname}}

\usepackage[pagebackref=true,breaklinks=true,colorlinks,bookmarks=false]{hyperref}
\usepackage[noabbrev,capitalise]{cleveref}

\usepackage{url}




\newcommand\Tstrut{\rule{0pt}{2.6ex}}       \newcommand\Bstrut{\rule[-0.9ex]{0pt}{0pt}} \newcommand{\TBstrut}{\Tstrut\Bstrut} 

\begin{document}
\pagestyle{headings}
\mainmatter
\def\ECCVSubNumber{3094}  

\title{
\algname{}: Dynamically-Feasible Trajectory Forecasting With Heterogeneous Data
}

\begin{comment}
\titlerunning{ECCV-20 submission ID \ECCVSubNumber} 
\authorrunning{ECCV-20 submission ID \ECCVSubNumber} 
\author{Anonymous ECCV submission}
\institute{Paper ID \ECCVSubNumber}
\end{comment}


\titlerunning{Trajectron++: Dynamically-Feasible Trajectory Forecasting}
\author{Tim Salzmann\thanks{Equal contribution.}\thanks{Work done as a visiting student in the Autonomous Systems Lab.}\inst{1} \and
Boris Ivanovic\inst{1} \and Punarjay Chakravarty\inst{2} \and \\Marco Pavone\inst{1}} \authorrunning{T. Salzmann, B. Ivanovic, et al.}
\institute{Autonomous Systems Lab, Stanford University\\
\email{\{timsal, borisi, pavone\}@stanford.edu} 
\and 
Ford Greenfield Labs\\
\email{pchakra5@ford.com}}
\maketitle
\setcounter{footnote}{0}
\begin{abstract}
   Reasoning about human motion is an important prerequisite to safe and socially-aware robotic navigation. 
   As a result, multi-agent behavior prediction has become a core component of modern human-robot interactive systems, such as self-driving cars. 
   While there exist many methods for trajectory forecasting, most do not enforce dynamic constraints and do not account for environmental information (e.g., maps). 
   Towards this end, we present \emphalgname{}, a modular, graph-structured recurrent model that forecasts the trajectories of a general number of diverse agents while incorporating agent dynamics and heterogeneous data (e.g., semantic maps).
   \emphalgname{} is designed to be tightly integrated with robotic planning and control frameworks; for example, it can produce predictions that are optionally conditioned on ego-agent motion plans. 
   We demonstrate its performance on several challenging real-world trajectory forecasting datasets, outperforming a wide array of state-of-the-art deterministic and generative methods.

   \keywords{Trajectory Forecasting, Spatiotemporal Graph Modeling, Human-Robot Interaction, Autonomous Driving}
\end{abstract}


\section{Introduction}

Predicting the future behavior of humans is a necessary part of developing safe human-interactive autonomous systems. Humans can naturally navigate through many social interaction scenarios because they have an intrinsic ``theory of mind,'' which is the capacity to reason about other people's actions in terms of their mental states \cite{GweonSaxe2013}.
As a result, imbuing autonomous systems with this capability
could enable more informed decision making and proactive actions to be taken in the presence of other intelligent agents, e.g., in human-robot interaction scenarios. \cref{fig:hero} illustrates a scenario where predicting the intent of other agents may inform an autonomous vehicle's path planning and decision making. Indeed, multi-agent behavior prediction has already become a core component of modern robotic systems, especially in safety-critical applications like self-driving vehicles which are currently being tested in the real world and targeting widespread deployment in the near future \cite{WaymoSafety2018}.

\begin{figure}[t]
    \centering
    \includegraphics[trim={0 23em 0 17em},clip,width=\linewidth]{figures/hero.pdf}
    \caption{Exemplary road scene depicting pedestrians crossing a road in front of a vehicle which may continue straight or turn right. The graph representation of the scene is shown on the ground, where each agent and their interactions are represented as nodes and edges, visualized as white circles and dashed black lines, respectively. Arrows depict potential future agent velocities, with colors representing different high-level future behavior modes.}
    \label{fig:hero}
\end{figure}

There are many existing methods for multi-agent behavior prediction, ranging from deterministic regressors to generative, probabilistic models. However, many of them were developed without directly accounting for real-world robotic use cases; in particular, they ignore agents' dynamics constraints, the ego-agent's own motion (important to capture the interactive aspect in human-robot interaction), and 
a plethora of environmental information (e.g., camera images, lidar, maps) to which modern robotic systems have access. \cref{tab:related_work} provides a summary of recent state-of-the-art approaches and their consideration of such desiderata.


Accordingly, in this work we are interested in developing a multi-agent behavior prediction model that 
(1)~accounts for the dynamics of the agents, and in particular of ground vehicles~\cite{KongPfeiferEtAl2015,PadenCapEtAl2016};
(2)~produces predictions possibly conditioned on potential future robot trajectories, useful for intelligent planning taking into account human responses; and
(3)~provides a generally-applicable, open, and extensible approach which can effectively use heterogeneous data about the surrounding environment.
Importantly, making use of such data would allow for the incorporation of environmental information, e.g., maps, which would enable producing predictions that differ depending on the structure of the scene (e.g., interactions at an urban intersection are very different from those in an open sports field!).
One method that comes close is the Trajectron~\cite{IvanovicPavone2019}, a multi-agent behavior model which can handle a time-varying number of agents, accounts for multimodality in human behavior (i.e., the potential for many high-level futures), and maintains a sense of interpretability in its outputs.
However, the Trajectron only reasons about relatively simple vehicle models (i.e., cascaded integrators) and past trajectory data (i.e., no considerations are made for added environmental information, if available).


In this work we present \emphalgname{}, an open and extensible approach built upon the Trajectron \cite{IvanovicPavone2019} framework which produces dynamically-feasible trajectory forecasts from heterogeneous input data for multiple interacting agents of distinct semantic types.
Our key contributions are twofold: First, we show how to effectively incorporate high-dimensional data
through the lens of encoding semantic maps. Second, we propose a general method of incorporating dynamics constraints into learning-based methods for multi-agent trajectory forecasting.
\emphalgname{} is designed to be tightly integrated with downstream robotic modules,
with the ability to produce trajectories
that are optionally conditioned on future ego-agent motion plans.
We present experimental results on a variety of datasets, which collectively demonstrate that \emphalgname{} outperforms an extensive selection of state-of-the-art deterministic and generative trajectory prediction methods, in some cases achieving  lower average prediction error.










\section{Related Work}

\begin{table}[t]
\fontsize{8}{8}\selectfont
\centering
\caption{A summary of recent state-of-the-art pedestrian (left) and vehicle (right) trajectory forecasting methods, indicating the desiderata addressed by each approach.}
\begin{tabular}{l|ccccc}
\toprule
\textbf{Method} & GNA & CD & HD & FCP & OS \TBstrut \\ \midrule
DESIRE \cite{LeeChoiEtAl2017} & \checkmark & & \checkmark & & \\
Trajectron \cite{IvanovicPavone2019} & \checkmark & & & & \checkmark\\ 
S-BiGAT \cite{KosarajuSadeghianEtAl2019} & \checkmark & & \checkmark & & \\
DRF-Net \cite{JainCasasEtAl2019} & \checkmark & & \checkmark & & \\
MATF \cite{ZhaoXuEtAl2019} & \checkmark & & \checkmark & & \checkmark \\
\midrule 
Our Work & \checkmark & \checkmark & \checkmark & \checkmark & \checkmark\\
\bottomrule
\end{tabular}
\begin{tabular}{l|ccccc}
\toprule
\textbf{Method} & GNA & CD & HD & FCP & OS \TBstrut \\ \midrule
IntentNet \cite{CasasLuoEtAl2018} & \checkmark & & \checkmark & & \\
PRECOG \cite{RhinehartMcAllisterEtAl2019} & & & \checkmark & \checkmark & \checkmark\\
MFP \cite{TangSalakhutdinov2019} & \checkmark & & \checkmark & & \checkmark \\
NMP \cite{ZengLuoEtAl2019} & \checkmark & & \checkmark & & \\
SpAGNN \cite{CasasGulinoEtAl2019} & \checkmark & & \checkmark & & \\
\midrule 
Our Work & \checkmark & \checkmark & \checkmark & \checkmark & \checkmark\\
\bottomrule
\end{tabular}

Legend: GNA = General Number of Agents, CD = Considers Dynamics, HD = Heterogeneous Data, FCP = Future-Conditional Predictions, OS = Open Source

\label{tab:related_work}
\end{table}

{\bf Deterministic Regressors.} Many earlier works in human trajectory forecasting were deterministic regression models. One of the earliest, the Social Forces model \cite{HelbingMolnar1995}, models humans as physical objects affected by Newtonian forces (e.g., with attractors at goals and repulsors at other agents). Since then, many approaches have been applied to the problem of trajectory forecasting, formulating it as a time-series regression problem and applying methods like Gaussian Process Regression (GPR) \cite{RasmussenWilliams2006,WangFleetEtAl2008}, Inverse Reinforcement Learning (IRL) \cite{LeeKitani2016}, and Recurrent Neural Networks (RNNs) \cite{AlahiGoelEtAl2016,MortonWheelerEtAl2017,VemulaMuellingEtAl2018} to good effect. An excellent review of such methods can be found in \cite{RudenkoPalmieriEtAl2019}.


{\bf Generative, Probabilistic Approaches.} Recently, generative approaches have emerged as state-of-the-art trajectory forecasting methods due to recent advancements in deep generative models \cite{SohnLeeEtAl2015,GoodfellowPouget-AbadieEtAl2014}. Notably, they have caused a shift from focusing on predicting the single best trajectory to producing a \textit{distribution} of potential future trajectories. This is advantageous in autonomous systems as full distribution information is more useful for downstream tasks, e.g., motion planning and decision making where information such as variance can be used to make safer decisions. Most works in this category use a deep recurrent backbone architecture with a latent variable model, such as a Conditional Variational Autoencoder (CVAE) \cite{SohnLeeEtAl2015}, to explicitly encode multimodality \cite{LeeChoiEtAl2017,IvanovicSchmerlingEtAl2018,DeoTrivedi2018,SadeghianLegrosEtAl2018,IvanovicPavone2019,RhinehartMcAllisterEtAl2019}, or a Generative Adversarial Network (GAN) \cite{GoodfellowPouget-AbadieEtAl2014} to implicitly do so \cite{GuptaJohnsonEtAl2018,SadeghianKosarajuEtAl2019,KosarajuSadeghianEtAl2019,ZhaoXuEtAl2019}. Common to both approach styles is the need to produce position distributions. GAN-based models can directly produce these and CVAE-based recurrent models usually rely on a bivariate Gaussian Mixture Model (GMM) to output position distributions. However, both of these output structures make it difficult to enforce dynamics constraints, e.g., non-holonomic constraints such as those arising from no side-slip conditions.
Of these, the Trajectron \cite{IvanovicPavone2019} and MATF \cite{ZhaoXuEtAl2019} are the best-performing CVAE-based and GAN-based models, respectively, on standard pedestrian trajectory forecasting benchmarks \cite{PellegriniEssEtAl2009,LernerChrysanthouEtAl2007}. 




{\bf Accounting for Dynamics and Heterogeneous Data.} There are few works that account for dynamics or make use of data modalities outside of prior trajectory information. This is mainly because standard trajectory forecasting benchmarks seldom include any other information, a fact that will surely change following the recent release of autonomous vehicle-based datasets with rich multi-sensor data \cite{waymo_open_dataset,CaesarBankitiEtAl2019,ChangLambertEtAl2019,lyft_dataset2019}.
As for dynamics, current methods almost exclusively reason about positional information. This does not capture dynamical constraints, however, which might lead to predictions in position space that are unrealizable by the underlying control variables (e.g., a car moving sideways).
\cref{tab:related_work} provides a detailed breakdown of recent state-of-the-art approaches and their consideration of these desiderata.



\section{Problem Formulation}
We aim to generate plausible trajectory distributions for a time-varying number  of interacting agents . Each agent  has a semantic class , e.g., Car, Bus, or Pedestrian. At time , given 
the state  of each agent
and all of their histories for the previous  timesteps, which we denote as , , as well as additional information available to each agent , we seek a distribution over all agents' future states for the next  timesteps , which we denote as .


We also assume that geometric semantic maps are available around 's position, , with context size , spatial resolution , and  semantic channels. Depending on the dataset, these maps can range in sophistication from simple obstacle occupancy grids to multiple layers of human-annotated semantic information (e.g., marking out sidewalks, road boundaries, and crosswalks). 

We also consider the setting where we condition on an ego-agent's future motion plan, for example when evaluating responses to a set of motion primitives. In this setting, we additionally assume that we know the ego-agent's future motion plan for the next  timesteps, .




\section{\algname{}} \label{sec:model}
Our approach\footnote{All of our source code, trained models, and data can be found online at\\ \url{https://github.com/StanfordASL/Trajectron-plus-plus}.} is visualized in \cref{fig:architecture}. At a high level, a spatiotemporal graph representation of the scene in question is created from its topology. Then, a similarly-structured deep learning architecture is generated that forecasts the evolution of node attributes, producing agent trajectories.

\begin{figure}[t]
    \centering
    \raisebox{-0.5\height}{\includegraphics[width=0.4\linewidth]{figures/frame_to_graph.png}}
    \raisebox{-0.5\height}{\includegraphics[width=0.5\linewidth]{figures/architecture.pdf}}
    \caption{\textbf{Left}: Our approach represents a scene as a directed spatiotemporal graph. Nodes and edges represent agents and their interactions, respectively. \textbf{Right}: The corresponding network architecture for Node 1.}
    \label{fig:frame_to_graph}
    \label{fig:architecture}
\end{figure}

{\bf Scene Representation.}
The current scene is abstracted as a spatiotemporal graph . Nodes represent agents and edges represent their interactions. As a result, in the rest of the paper we will use the terms ``node'' and ``agent'' interchangeably. Each node also has a semantic class matching the class of its agent (e.g., Car, Bus, Pedestrian). An edge  is present in  if  influences . In this work, the  distance is used as a proxy for whether agents are influencing each other or not. Formally, an edge is directed from  to  if  where  are the 2D world positions of agents , respectively, and  is a distance that encodes the perception range of agents of semantic class . While more sophisticated methods can be used to construct edges (e.g., \cite{VemulaMuellingEtAl2018}), they usually incur extra computational overhead by requiring a complete scene graph. \cref{fig:frame_to_graph} shows an example of this scene abstraction.

We specifically choose to model the scene as a directed graph, in contrast to an undirected one as in previous approaches \cite{JainZamirEtAl2016,AlahiGoelEtAl2016,GuptaJohnsonEtAl2018,VemulaMuellingEtAl2018,IvanovicSchmerlingEtAl2018,IvanovicPavone2019}, because a directed graph can represent a more general set of scenes and interaction types, e.g., asymmetric influence. This provides the additional benefit of being able to simultaneously model agents with different perception ranges, e.g., the driver of a car looks much farther ahead on the road than a pedestrian does while walking on the sidewalk.

{\bf Modeling Agent History.} Once a graph of the scene is constructed, the model needs to encode a node's current state, its history, and how it is influenced by its neighboring nodes. To encode the observed history of the modeled agent, their current and previous states are fed into a Long Short-Term Memory (LSTM) network \cite{HochreiterSchmidhuber1997} with 32 hidden dimensions. Since we are interested in modeling trajectories, the inputs  are the current and previous -dimensional states of the modeled agents. These are typically positions and velocities, which can be easily estimated online.


Ideally, agent models should be chosen to best match their semantic class . For example, one would usually model vehicles on the road using a bicycle model \cite{KongPfeiferEtAl2015,PadenCapEtAl2016}. However, estimating the bicycle model parameters of another vehicle from online observations is very difficult as it requires estimation of the vehicle's center of mass, wheelbase, and front wheel steer angle. As a result, in this work pedestrians are modeled as single integrators and wheeled vehicles are modeled as dynamically-extended unicycles~\cite{LaValle2006BetterUnicycle}, enabling us to account for key non-holonomic constraints (e.g., no side-slip constraints)~\cite{PadenCapEtAl2016} without requiring complex online parameter estimation procedures -- we will show through experiments that such a simplified model is already quite impactful on improving prediction accuracy.
While the dynamically-extended unicycle model serves as an important representative example, we note that our approach can also be generalized to other dynamics models, provided its parameters can either be assumed or quickly estimated online.


{\bf Encoding Agent Interactions.} To model neighboring agents' influence on the modeled agent, \emphalgname{} encodes graph edges in two steps. First, edge information is aggregated from neighboring agents of the same semantic class. In this work, an element-wise sum is used as the aggregation operation. We choose to combine features in this way rather than with concatenation or an average to handle a variable number of neighboring nodes with a fixed architecture while preserving count information \cite{BattagliaPascanuEtAl2016,IvanovicSchmerlingEtAl2018,JainZamirEtAl2016}. These aggregated states are then fed into an LSTM with 8 hidden dimensions whose weights are shared across all edge instances of the same type, e.g., all Pedestrian-Bus edge LSTMs share the same weights. Then, the encodings from all edge types that connect to the modeled node are aggregated to obtain one ``influence" representation vector, representing the effect that all neighboring nodes have. For this, an additive attention module is used~\cite{BahdanauChoEtAl2015}. Finally, the node history and edge influence encodings are concatenated to produce a single node representation vector, . 

{\bf Incorporating Heterogeneous Data.} Modern sensor suites are able to produce much more information than just tracked trajectories of other agents. Notably, HD maps are used by many real-world systems to aid localization as well as inform navigation. Depending on sensor availability and sophistication, maps can range in fidelity from simple binary obstacle maps, i.e., , to HD semantic maps, e.g.,  where each layer  corresponds to an area with semantic type (e.g., ``driveable area," ``road block," ``walkway," ``pedestrian crossing"). To make use of this information, for each modeled agent, \emphalgname{} encodes a local map, rotated to match the agent's heading, with a Convolutional Neural Network (CNN).
The CNN has 4 layers, with filters  and respective strides of . These are followed by a dense layer with 32 hidden dimensions, the output of which is concatenated with the node history and edge influence representation vectors.

More generally, one can include further additional information (e.g., raw LIDAR data, camera images, pedestrian skeleton or gaze direction estimates) in this framework by encoding it as a vector and adding it to this backbone of representation vectors, .

{\bf Encoding Future Ego-Agent Motion Plans.} Producing predictions which take into account future ego-agent motion is an important capability for robotic decision making and control. Specifically, it allows for the evaluation of a set of motion primitives with respect to possible responses from other agents. \textit{Trajectron++} can encode the future  timesteps of the ego-agent's motion plan  using a bi-directional LSTM with 32 hidden dimensions. A bi-directional LSTM is used due to its strong performance on other sequence summarization tasks \cite{BritzGoldieEtAl2017}. The final hidden states are then concatenated into the backbone of representation vectors, .

{\bf Explicitly Accounting for Multimodality.} \emphalgname{} explicitly handles multimodality by leveraging the CVAE latent variable framework \cite{SohnLeeEtAl2015}. It produces the target  distribution by introducing a discrete Categorical latent variable  which encodes high-level latent behavior and allows for  to be expressed as
,
where  and  are deep neural network weights that parameterize their respective distributions.  being discrete also aids in interpretability, as one can visualize which high-level behaviors belong to each  by sampling trajectories.

During training, a bi-directional LSTM with 32 hidden dimensions is used to encode a nodeâ€™s ground truth future trajectory, producing  \cite{SohnLeeEtAl2015}.

{\bf Producing Dynamically-Feasible Trajectories.} After obtaining a latent variable , it and the backbone representation vector  are fed into the decoder, a 128-dimensional Gated Recurrent Unit (GRU) \cite{ChoMerrienboerEtAl2014}. Each GRU cell outputs the parameters of a bivariate Gaussian distribution over control actions  (e.g., acceleration and steering rate).
The agent's system dynamics are then integrated with the produced control actions  to obtain trajectories in position space~\cite{Kalman1960,ThrunBurgardEtAl2005EKF}.
The only uncertainty at prediction time stems from \emphalgname{}'s output. Thus, in the case of linear dynamics (e.g., single integrators, used in this work to model pedestrians), the system dynamics are linear Gaussian. Explicitly, for a single integrator with control actions , the position mean at  is , where  is produced by \emphalgname{}.
In the case of nonlinear dynamics (e.g., unicycle models, used in this work to model vehicles), one can still (approximately) use this uncertainty propagation scheme by linearizing the dynamics about the agent's current state and control.
Full mean and covariance equations for the single integrator and dynamically-extended unicycle models are in the appendix. In contrast to existing methods which directly output positions, our approach is uniquely able to guarantee that its trajectory samples are dynamically feasible by integrating an agent's dynamics with the predicted controls.


{\bf Output Configurations.} Based on the desired use case, \emphalgname{} can produce many different outputs. The main four are outlined below.


    1. \emph{Most Likely (ML)}: 
    The model's deterministic and most-likely single output.
The high-level latent behavior mode and output trajectory are the modes of their respective distributions, where
    
    
    2. : Predictions from the model's most-likely high-level latent behavior mode, where 
    
    
    3. \emph{Full}: The model's full sampled output, where  and  are sampled sequentially according to 
    
    
    4. \emph{Distribution}: Due to the use of a discrete latent variable and Gaussian output structure, the model can provide an analytic output distribution by directly computing .

{\bf Training the Model.} We adopt the InfoVAE \cite{ZhaoSongEtAl2019} objective function, and modify it to use discrete latent states in a conditional formulation (since the model uses a CVAE). Formally, we aim to solve

where  is the mutual information between  and  under the distribution . To compute , we follow \cite{ZhaoSongEtAl2019} and approximate  with \mbox{}, obtaining the unconditioned latent distribution by summing out  over the batch.
Notably, the Gumbel-Softmax reparameterization \cite{JangGuEtAl2017} is not used to backpropagate through the Categorical latent variable  because it is not sampled during training time. Instead, the first term of \cref{eqn:loss_fn} is directly computed since the latent space has only  discrete elements. Additional training details can be found in the appendix.








\section{Experiments}

Our method is evaluated on three publicly-available datasets: The ETH \cite{PellegriniEssEtAl2009}, UCY \cite{LernerChrysanthouEtAl2007}, and nuScenes \cite{CaesarBankitiEtAl2019} datasets. The ETH and UCY datasets consist of real pedestrian trajectories with rich multi-human interaction scenarios captured at 2.5 Hz (). In total, there are 5 sets of data, 4 unique scenes, and 1536 unique pedestrians. They are a standard benchmark in the field, containing challenging behaviors such as couples walking together, groups crossing each other, and groups forming and dispersing. However, they only contain pedestrians,
so we also evaluate on the recently-released nuScenes dataset. It is a large-scale dataset for autonomous driving with 1000 scenes in Boston and Singapore. Each scene is annotated at 2 Hz () and is 20s long, containing up to 23 semantic object classes as well as HD semantic maps with 11 annotated layers. 


\emphalgname{} was implemented in PyTorch \cite{PaszkeGrossEtAl2017}
on a desktop computer running Ubuntu 18.04 containing an AMD Ryzen 1800X CPU and two NVIDIA GTX 1080 Ti GPUs.
We trained the model for 100 epochs ( hours) on the pedestrian datasets and 12 epochs ( hours) on the nuScenes dataset.

{\bf Evaluation Metrics.} As in prior work \cite{AlahiGoelEtAl2016,GuptaJohnsonEtAl2018,IvanovicPavone2019,SadeghianKosarajuEtAl2019,KosarajuSadeghianEtAl2019,ZhaoXuEtAl2019}, our method for trajectory forecasting is evaluated with the following four error metrics:


    1. \textit{Average Displacement Error (ADE)}: Mean  distance between the ground truth and predicted trajectories.
    
    2. \textit{Final Displacement Error (FDE)}:  distance between the predicted final position and the ground truth final position at the prediction horizon .
    
    3. \textit{Kernel Density Estimate-based Negative Log Likelihood (KDE NLL)}: Mean NLL of the ground truth trajectory under a distribution created by fitting a kernel density estimate on trajectory samples~\cite{IvanovicPavone2019,ThiedeBrahma2019}.
    
    4. \textit{Best-of-N (BoN)}: The minimum ADE and FDE from  randomly-sampled trajectories.
We compare our method to an exhaustive set of state-of-the art deterministic and generative approaches.


{\bf Deterministic Baselines.} Our method is compared against the following deterministic baselines: (1) \textit{Linear}: A linear regressor with parameters estimated by minimizing least square error. (2) \textit{LSTM}: An LSTM network with only agent history information. (3) \textit{Social LSTM} \cite{AlahiGoelEtAl2016}: Each agent is modeled with an LSTM and nearby agents' hidden states are pooled at each timestep using a proposed social pooling operation. (4) \textit{Social Attention} \cite{VemulaMuellingEtAl2018}: Same as \cite{AlahiGoelEtAl2016}, but all other agents' hidden states are incorporated via a proposed social attention operation.

{\bf Generative Baselines.} On the ETH and UCY datasets, our method is compared against the following generative baselines: 
(1) \textit{S-GAN} \cite{GuptaJohnsonEtAl2018}: Each agent is modeled with an LSTM-GAN, which is an LSTM encoder-decoder whose outputs are the generator of a GAN. The generated trajectories are then evaluated against the ground truth trajectories with a discriminator. 
(2) \textit{SoPhie} \cite{SadeghianKosarajuEtAl2019}: An LSTM-GAN with the addition of a proposed physical and social attention module. 
(3) \textit{MATF} \cite{ZhaoXuEtAl2019}: An LSTM-GAN model that leverages CNNs to fuse agent relationships and encode environmental information. 
(4) \textit{Trajectron}~\cite{IvanovicPavone2019}: An LSTM-CVAE encoder-decoder which is explicitly constructed to match the spatiotemporal structure of the scene. Its scene abstraction is similar to ours, but uses undirected edges.

On the nuScenes dataset, the following methods are also compared against: 
(5) \textit{Convolutional Social Pooling (CSP)} \cite{DeoTrivedi2018}: An LSTM-based approach which explicitly considers a fixed number of movement classes and predicts which of those the modeled agent is likely to take. 
(6) \textit{CAR-Net} \cite{SadeghianLegrosEtAl2018}: An LSTM-based approach which encodes scene context with visual attention. 
(7) \textit{SpAGNN} \cite{CasasGulinoEtAl2019}: A CNN encodes raw LIDAR and semantic map data to produce object detections, from which a Graph Neural Network (GNN) produces probabilistic, interaction-aware trajectories.

{\bf Evaluation Methodology.} For the ETH and UCY datasets, a leave-one-out strategy is used for evaluation, similar to previous works~\cite{AlahiGoelEtAl2016,GuptaJohnsonEtAl2018,IvanovicPavone2019,KosarajuSadeghianEtAl2019,SadeghianKosarajuEtAl2019,ZhaoXuEtAl2019}, where the model is trained on four datasets and evaluated on the held-out fifth. An observation length of 8 timesteps (3.2s) and a prediction horizon of 12 timesteps (4.8s) is used for evaluation. 
For the nuScenes dataset, we split off 15\% of the train set for hyperparameter tuning and test on the provided validation set.


Throughout the following, we report the performance of \emphalgname{} in multiple configurations. Specifically, \textit{Ours} refers to the base model using only node and edge encoding, trained to predict agent velocities and Euler integrating velocity to produce positions; 
\textit{Ours}+ is the base model with dynamics integration, trained to predict control actions and integrating the agent's dynamics with the control actions to produce positions; 
\textit{Ours}+ additionally includes the map encoding CNN; and \textit{Ours}+ adds the robot future encoder.

\begin{table}[t]
\fontsize{8}{8}\selectfont
\centering
\caption{
\textbf{(a)} Our model's deterministic Most Likely output outperforms other deterministic methods on displacement error metrics, even if it was not originally trained to do so.
\textbf{(b)} Our model's probabilistic Full output significantly outperforms other methods, yielding accurate predictions even in a small number of samples.
Lower is better. Bold indicates best.}
\begin{tabular}{l|cccc|cc}
\toprule
\multicolumn{1}{c|}{\multirow{2}{*}{\textbf{Dataset}}} & \multicolumn{6}{c}{(a) \textbf{ADE/FDE (m)}} \Bstrut \\ \cline{2-7} 
\multicolumn{1}{c|}{}                         & Linear      & LSTM        & S-LSTM \cite{GuptaJohnsonEtAl2018} & S-ATTN \cite{VemulaMuellingEtAl2018} & Ours (ML) & Ours+ (ML) \TBstrut \\ \midrule
ETH                                           & / & / & / & /      & /  & /             \\
Hotel                                         & / & / & / & /      & /  & /             \\
Univ                                          & / & / & / & /      & /  & /             \\
Zara 1                                        & / & / & / & /      &  / & /             \\
Zara 2                                        & / & / & / & /      & /  & /             \\ \midrule
Average                                       & / & / & / & /      &  / & /  \Bstrut   \\ \hline
\hline
\multicolumn{1}{c|}{\multirow{2}{*}{\textbf{Dataset}}} & \multicolumn{6}{c}{(b) \textbf{ADE/FDE, Best of 20 Samples (m)}}  \TBstrut \\ \cline{2-7} 
\multicolumn{1}{c|}{}                         & S-GAN \cite{GuptaJohnsonEtAl2018} & SoPhie \cite{SadeghianKosarajuEtAl2019} & Trajectron \cite{IvanovicPavone2019} & MATF \cite{ZhaoXuEtAl2019} & Ours (Full) & Ours+ (Full) \TBstrut \\ \midrule
ETH                                           & /  & /   & /  & / & / & /  \\
Hotel                                         & /  & /   & /  & / & / & /  \\
Univ                                          & /  & /   & /  & / & / & / \\
Zara 1                                        & /  & /   & /  & / & / & / \\
Zara 2                                        & /  & /   & /  & / & / & /  \\ \midrule
Average                                       & /  & /   & /  & / & / & /  \\ \bottomrule
\end{tabular}
\label{tab:deterministic_fde}
\label{tab:generative_BoN}

Legend:  = Integration via Dynamics,  = Map Encoding,  = Robot Future Encoding
\end{table}

\subsection{ETH and UCY Datasets}

Our approach is first evaluated on the ETH \cite{PellegriniEssEtAl2009} and UCY \cite{LernerChrysanthouEtAl2007} Pedestrian Datasets, against deterministic methods on standard trajectory forecasting metrics. It is difficult to determine the current state-of-the-art in deterministic methods as there are contradictions between the results reported by the same authors in \cite{GuptaJohnsonEtAl2018} and \cite{AlahiGoelEtAl2016}. In Table 1 of \cite{AlahiGoelEtAl2016}, Social LSTM \textit{convincingly} outperforms a baseline LSTM without pooling. However, in Table 1 of \cite{GuptaJohnsonEtAl2018}, Social LSTM is actually \textit{worse} than the same baseline on average. Thus, when comparing against Social LSTM we report the results summarized in Table 1 of \cite{GuptaJohnsonEtAl2018} as it is the most recent work by the same authors. Further, the values reported by Social Attention in \cite{VemulaMuellingEtAl2018} seem to have unusually high ratios of FDE to ADE.
Nearly every other method (including ours) has FDE/ADE ratios around  whereas Social Attention's are around . Social Attention's errors on the Univ dataset are especially striking, as its FDE of  is  its ADE of , meaning its prediction error on the other 11 timesteps is essentially zero. We still compare against the values reported in \cite{VemulaMuellingEtAl2018} as there is no publicly-released code, but this raises doubts of their validity. To fairly compare against prior work, neither map encoding nor future motion plan encoding is used.
Only the node history and edge encoders are used in the model's encoder. Additionally, the model's deterministic ML output scheme is employed, which produces the model's most likely single trajectory. \cref{tab:deterministic_fde}~(a) summarizes these results and shows that our approach is competitive with state-of-the-art deterministic regressors on displacement error metrics (outperforming existing approaches by  on mean FDE), even though our method was not originally trained to minimize this.
It makes sense that the model performs similarly with and without dynamics integration for pedestrians, since they are modeled as single integrators. Thus, their control actions are velocities which matches the base model's output structure.

\begin{table}[t]
\fontsize{8}{8}\selectfont
\centering
\caption{Mean KDE-based NLL for each dataset. Lower is better. 2000 trajectories were sampled per model at each prediction timestep. Bold indicates the best values.}
\begin{tabular}{l|cc|cc}
\toprule
\multicolumn{1}{c|}{\multirow{2}{*}{\textbf{Dataset}}} & \multicolumn{4}{c}{\textbf{KDE NLL}} \\ \cline{2-5} 
\multicolumn{1}{c|}{}                         & S-GAN \cite{GuptaJohnsonEtAl2018}       & Trajectron \cite{IvanovicPavone2019}     & Ours (Full)  & Ours+ (Full) \Tstrut  \\ \midrule
ETH                                           &        &             &  &       \\ 
Hotel                                         &         &             &  &      \\ 
Univ                                          &         &             &  &       \\ 
Zara 1                                        &         &             &   &       \\ 
Zara 2                                        &         &             &  &       \\ \midrule
Average                                       &         &             &  &       \\ \bottomrule
\end{tabular}
\label{tab:kde_nll}

Legend:  = Integration via Dynamics,  = Map Encoding,  = Robot Future Encoding
\end{table}

To more concretely compare generative methods, we use the KDE-based NLL metric proposed in \cite{IvanovicPavone2019,ThiedeBrahma2019}, an approach that maintains full output distributions and compares the log-likelihood of the ground truth under different methods' outputs. \cref{tab:kde_nll} summarizes these results and shows that our method significantly outperforms others. This is also where the performance improvements brought by the dynamics integration scheme are clear. It yields the best performance because the model is now explicitly trained on the distribution it is seeking to output (the loss function term  is now directly over positions), whereas the base model is trained on velocity distributions, the integration of which (with no accounting for system dynamics) introduces errors.
Unfortunately, at this time there are no publicly-released models for SoPhie~\cite{SadeghianKosarajuEtAl2019} or MATF~\cite{ZhaoXuEtAl2019}, so they cannot be evaluated with the KDE-based NLL metric. Instead, we evaluate \emphalgname{} with the Best-of- metric used in their works.
\cref{tab:generative_BoN}~(b) summarizes these results, and shows that our method \textit{significantly} ourperforms the state-of-the-art \cite{ZhaoXuEtAl2019}, achieving  lower average errors.

{\bf Map Encoding.} To evaluate the effect of incorporating heterogeneous data, we compare the performance of \emphalgname{} with and without the map encoder. Specifically, we compare the frequency of obstacle violations in 2000 trajectory samples from the Full model output on the ETH - University scene, which provides a simple binary obstacle map. Overall, our approach generates colliding predictions  of the time with map encoding, compared to  without map encoding.
We also study how much of a reduction there is for pedestrians that are especially close to an obstacle (i.e. they have at least one obstacle-violating trajectory in their Full output), an example of which is shown in the appendix.
In this regime, our approach generates colliding predictions  of the time with map encoding, compared to  without map encoding.




\subsection{nuScenes Dataset}

\begin{table}[t]
\fontsize{6.5}{6.5}\selectfont
\centering
\caption{\textbf{[nuScenes]} \textbf{(a)}: Vehicle-only FDE across time for \emphalgname{}
compared to that of other single-trajectory and probabilistic approaches. Bold indicates best. \textbf{(b)}:~Pedestrian-only FDE and KDE NLL across time for \emphalgname{}.
}
\begin{tabular}{l|cccc}
\toprule
\multicolumn{5}{c}{(a) \textbf{Vehicle-only}}\\
\midrule
\multicolumn{1}{c|}{\multirow{2}{*}{\textbf{Method}}} & \multicolumn{4}{c}{\textbf{FDE (m)}} \Bstrut \\
\cline{2-5} & @1s & @2s & @3s & @4s \Tstrut \\
\midrule
Const. Velocity &  &  &  & \\
S-LSTM~\cite{AlahiGoelEtAl2016,CasasGulinoEtAl2019} &  & - &  & - \\
CSP~\cite{DeoTrivedi2018,CasasGulinoEtAl2019} &  & - &  & - \\
CAR-Net~\cite{SadeghianLegrosEtAl2018,CasasGulinoEtAl2019} &  & - &  & - \\
SpAGNN~\cite{CasasGulinoEtAl2019} &  & - &  & - \\
\midrule
Ours (ML) &  &  &  & \\
Ours+, (ML) &  &  &  & \\
\bottomrule
\end{tabular}
\hfill \begin{tabular}{l|cccc|cccc}
\toprule
\multicolumn{9}{c}{(b) \textbf{Pedestrian-only}}\\
\midrule
\multicolumn{1}{c|}{\multirow{2}{*}{\textbf{Method}}} & \multicolumn{4}{c|}{\textbf{KDE NLL}} & \multicolumn{4}{c}{\textbf{FDE (m)}} \Bstrut \\
\cline{2-9} & @1s & @2s & @3s & @4s & @1s & @2s & @3s & @4s \Tstrut \\
\midrule
Ours (ML) &  &  &  &  &  &  &  & \\
Ours+, (ML) &   &  &   &  &  &  &  &  \\
\bottomrule
\end{tabular}
\label{tab:nuscenes_fde}
\label{tab:nuscenes_ped}

\fontsize{7}{7}\selectfont
We subtracted - from these reported values (their detection/tracking error~\cite{CasasGulinoEtAl2019}), as we do not use a detector/tracker. This is done to establish a fair comparison.

Legend:  = Integration via Dynamics,  = Map Encoding,  = Robot Future Encoding.
\end{table}



To further evaluate the model's ability to use heterogeneous data and simultaneously model multiple semantic classes of agents, we evaluate it on the nuScenes dataset~\cite{CaesarBankitiEtAl2019}. Again, the deterministic ML output scheme is used to fairly compare with other single-trajectory predictors.
The trajectories of both Pedestrians and Cars are forecasted, two semantic object classes which 
account for most of the 23 possible object classes present in the dataset. To obtain an estimate of prediction quality degradation over time, we compute the model's FDE at  for all tracked objects with at least  of available future data. We also implement a constant velocity baseline, which simply maintains the agent's heading and speed for the prediction horizon. \cref{tab:nuscenes_fde} (a) summarizes the model's performance in comparison with state-of-the-art vehicle trajectory prediction models. Since other methods use a detection/tracking module (whereas ours does not), to establish a fair comparison we subtracted other methods' detection and tracking error from their reported values.
The dynamics integration scheme and map encoding yield a noticeable improvement with vehicles, as their dynamically-extended unicycle dynamics now differ from the single integrator assumption made by the base model.
Note that our method was only trained to predict  into the future, thus its performance at  also provides a measure of its capability to generalize beyond its training configuration. Other methods do not report values at s and s. As can be seen, \emphalgname{} outperforms existing approaches without facing a sharp degradation in performance after .
Our approach's performance on pedestrians is reported in \cref{tab:nuscenes_ped} (b), where the inclusion of HD maps and dynamics integration similarly improve performance as in the pedestrian datasets.

\begin{table}[t]
\fontsize{8}{8}\selectfont
\centering
\caption{\textbf{[nuScenes]} 
\textbf{(a)}: Vehicle-only prediction performance
for ablated versions of our model. \textbf{(b)}: The same, but excluding the ego-robot from consideration (as it is being conditioned on). This shows that our model's robot future conditional performance does not arise from merely removing the ego-vehicle.
}
\begin{tabular}{ccc|rrrr|cccc|cccc}
\toprule
 \multicolumn{15}{c}{(a) \textbf{Including the Ego-Vehicle}} \\
 \midrule
\multicolumn{3}{c|}{\textbf{Ablation}}   & \multicolumn{4}{c|}{\textbf{KDE NLL}}  & \multicolumn{4}{c|}{\textbf{FDE ML (m)}}  & \multicolumn{4}{c}{\textbf{B. Viol. (\%)}} \\
      &          &  & @1s & @2s  & @3s  & @4s   & @1s   & @2s  & @3s   & @4s   & @1s & @2s   & @3s  & @4s \\ \midrule
    -       &      -      &     -          &     &    &      &       &       &      &       &       &    &      &     &    \\
 \checkmark &      -      &     -          &     &       &      &      &       &      &       &       &     &       &      &     \\
 \checkmark & \checkmark  &     -          &     &      &      &       &       &      &       &       &     &       &      &     \\
 \hline
 \hline 
 \multicolumn{15}{c}{(b) \textbf{Excluding the Ego-Vehicle}} \Tstrut \\
 \midrule
\multicolumn{3}{c|}{\textbf{Ablation}}   & \multicolumn{4}{c|}{\textbf{KDE NLL}}  & \multicolumn{4}{c|}{\textbf{FDE ML (m)}}  & \multicolumn{4}{c}{\textbf{B. Viol. (\%)}} \\
      &          &  & @1s & @2s  & @3s  & @4s   & @1s  & @2s  & @3s & @4s & @1s & @2s  & @3s  & @4s \\ \midrule
\checkmark  & \checkmark  &   -            &     &      &      &       &      &      &     &     &     &      &      &     \\
\checkmark  & \checkmark  &   \checkmark   &     &      &      &       &       &      &       &       &     &       &      &     \\
\bottomrule
\end{tabular}\label{tab:nuscenes_abl}


Legend:  = Integration via Dynamics,  = Map Encoding,  = Robot Future Encoding
\end{table}

{\bf Ablation Study.} To develop an understanding of which model components influence performance, a comprehensive ablation study is performed in \cref{tab:nuscenes_abl}.
As can be seen in the first row,
even the base model's deterministic ML output performs strongly relative to current state-of-the-art approaches for vehicle trajectory forecasting~\cite{CasasGulinoEtAl2019}. 
Adding the dynamics integration scheme yields a drastic reduction in NLL as well as FDE at all prediction horizons. There is also an associated slight increase in the frequency of road boundary-violating predictions. This is a consequence of training in position (as opposed to velocity) space, which yields more variability in the corresponding predictions.
Additionally including map encoding maintains prediction accuracy while reducing the frequency of boundary-violating predictions.


The effect of conditioning on the ego-vehicle's future motion plan is also studied, with results summarized in \cref{tab:nuscenes_abl} (b). 
As one would expect, providing the model with future motion plans of the ego-vehicle yields significant reductions in error and road boundary violations. 
This use-case is common throughout autonomous driving as the ego-vehicle repeatedly produces future motion plans at every timestep by evaluating motion primitives. Overall, dynamics integration is the dominant performance-improving module.



\begin{figure}[t]
    \centering
\raisebox{-0.5\height}{\begin{overpic}[width=0.29\linewidth,frame]{figures/qual_nuScenes_no_map_vel}\put (45, 5) {(a) Ours}\end{overpic}}
\raisebox{-0.5\height}{\begin{overpic}[width=0.29\linewidth,frame]{figures/qual_nuScenes_no_map_pos}\put (45, 5) {(b)+}\end{overpic}}
\raisebox{-0.5\height}{\begin{overpic}[width=0.29\linewidth,,frame]{figures/qual_nuScenes_map_pos.pdf}\put (45, 5) {(c)+}\end{overpic}}
\raisebox{-0.5\height}{\begin{overpic}[width=0.1\linewidth,]{figures/qual_nuScenes_legend.pdf}\end{overpic}}
\caption{\textbf{[nuScenes]} The same scene as forecast by three versions of \emphalgname{}. \textbf{(a)}~The base model tends to under-shoot turns, and makes overly-confident predictions. 
    \textbf{(b)}~Our approach better captures position uncertainty with dynamics integration, producing well-calibrated probabilities.
    \textbf{(c)}~The model is able to leverage the additional information that a map provides, yielding accurate predictions.}
\label{fig:nuscenes_map_quali}
    \label{fig:nuscenes_robot_quali}
\end{figure}

{\bf Qualitative Comparison.} \cref{fig:nuscenes_map_quali} shows trajectory predictions from the base model, with dynamics integration, and with dynamics integration + map encoding. 
In it, one can see that the base model (predicting in velocity space) undershoots the turn for the red car, predicting that it will end up in oncoming traffic. 
With the integration of dynamics, the model captures multimodality in the agent's action, predicting both the possibility of a right turn and continuing straight.
With the addition of map encoding, the predictions are not only more accurate, but nearly all probability mass now lies within the correct side of the road. This is in contrast to versions of the model without map encoding which predict that the red car might move into oncoming traffic.

{\bf Online Runtime.} A key consideration in 
robotics is runtime complexity. As a result, we evaluate the time it takes \emphalgname{} to perform forward inference on commodity hardware. The results are summarized in the appendix, and confirm that our model scales well to scenes with many agents and interactions.



\section{Conclusion}
In this work, we present \emphalgname{}, a generative multi-agent trajectory forecasting approach which uniquely addresses our desiderata for an open, generally-applicable, and extensible framework. It can incorporate heterogeneous data beyond prior trajectory information and is able to produce future-conditional predictions that respect dynamics constraints, all
while producing full probability distributions, which are especially useful in downstream robotic tasks such as motion planning, decision making, and control. 
It achieves state-of-the-art prediction performance in a variety of metrics on standard and new real-world multi-agent human behavior datasets.



{\bf Acknowledgment.} 
Tim Salzmann is supported by a fellowship within the IFI programme of the German Academic Exchange Service (DAAD). We thank Matteo Zallio for his help in visually communicating our work and Amine Elhafsi for sharing his dynamics knowledge and proofreading. We also thank Brian Yao for improving our pedestrian dataset evaluation script, Osama Makansi for improving our result reporting, and Lu Zhang for correcting typos in our references. This work was supported in part by the Ford-Stanford Alliance. This article solely reflects the opinions and conclusions of its authors.

\nocite{HigginsMattheyEtAl2017,BowmanVilnisEtAl2015,HallacLeskovecEtAl2015,LaValle2006Unicycle,SchollerAravantinosEtAl2020}

\bibliographystyle{splncs04}
\bibliography{ASL_papers,main}



\appendix

\section{Single Integrator Distribution Integration} \label{sec:si_integration}
For a single integrator, we define the state to be the position vector , the control to be the velocity vector , and write the linear discrete-time dynamics as

At each timestep, and for a specific latent value , \emphalgname{} produces a Gaussian distribution over control actions . Specifically, it outputs

where  and  are the respective mean velocities in the agent's longitudinal and lateral directions,  and  are the respective longitudinal and lateral velocity standard deviations, and  is the correlation between  and . Since  is the only source of uncertainty in the prediction model, \cref{eqn:supp_SI} is a linear Gaussian system.

\subsection{Mean Derivation\protect\footnote{These equations are also found in the Kalman Filter prediction step~\cite{Kalman1960}.}}
Following the sum of Gaussian random variables~\cite{Kalman1960}, the output mean positions are obtained by \cref{eqn:supp_SI}. Thus, at test time, \emphalgname{} produces  which is passed through \cref{eqn:supp_SI} alongside the current agent position  to produce the predicted position mean .


\subsection{Covariance Derivation\protect\footnotemark[2]}
The position covariance is obtained via the covariance of a sum of Gaussian random variables~\cite{Kalman1960}


\section{Dynamically-Extended Unicycle Distribution Integration}\label{sec:unicycle_integration}
Usually, unicycle models have velocity and heading rate as control inputs \cite{LaValle2006Unicycle,PadenCapEtAl2016}. However, vehicles in the real world are controlled by accelerator pedals and so we instead adopt the dynamically-extended unicycle model which instead uses acceleration  and heading rate  as control inputs \cite{LaValle2006BetterUnicycle}. The dynamically-extended unicycle model has the following nonlinear continuous-time dynamics

where  defines the position,  the speed, and  the heading. As mentioned above, the control inputs are . To discretize this, we assume a zero-order hold on the controls between each sampling step (i.e. control actions are piece-wise constant). This yields the following zero-order hold discrete equivalent dynamics

We will refer to these dynamics in short with . We adopt a slightly different set of dynamics when  to avoid singularities in \cref{eqn:supp_unicycle}. With a small , we instead use the following dynamics, obtained by evaluating the limit as .

Thus, the full discrete-time dynamics are



At each timestep, and for a specific latent value , \emphalgname{} produces a Gaussian distribution over control actions . Specifically, it outputs

where  is the mean rate of change of the agent's heading,  is the mean acceleration in the agent's heading direction,  is the standard deviation of the heading rate of change,  is the acceleration standard deviation, and  is the correlation between  and . The controls  and uncertainties  are then integrated through the dynamics to obtain the following mean and covariance integration equations~\cite{ThrunBurgardEtAl2005EKF}.



\subsection{Mean Derivation\protect\footnote{These equations are also found in the Extended Kalman Filter prediction step~\cite{ThrunBurgardEtAl2005EKF}.}}
The output mean positions are obtained by applying the mean control actions to \cref{eqn:supp_unicycle_full}~\cite{ThrunBurgardEtAl2005EKF}.

\subsection{Covariance Derivation\protect\footnotemark[3]}
Since  is the only source of uncertainty in the prediction model, \cref{eqn:supp_unicycle_full} can be made a linear Gaussian system by linearizing about a specific state and control. For instance, the Jacobians  and  of the system dynamics in \cref{eqn:supp_unicycle} are

Then, applying the equations for the covariance of a sum of Gaussian random variables~\cite{ThrunBurgardEtAl2005EKF} yields


\section{Average and Final Displacement Error Evaluation} \label{sec:supp_ADE}

\begin{figure}[t]
    \centering
    \includegraphics[width=0.495\linewidth]{figures/ade_boxplots.pdf}
    \includegraphics[width=0.495\linewidth]{figures/fde_boxplots}
    \caption{\textbf{Left}: ADE results of all methods per dataset, as well as their average performance. Boxplots are shown for all generative models since they produce distributions of trajectories. 2000 trajectories were sampled per model at each prediction timestep, with each sampleâ€™s ADE included in the boxplots. Our approach with dynamics integration is compared here, specifically its  output configuration. X markers indicate the mean ADE. Mean ADE from deterministic baselines are visualized as horizontal lines. \textbf{Right}: The same analysis for FDE.}
    \label{fig:supp_ADE}
    \label{fig:supp_FDE}
    \vspace{3mm}
\end{figure}

While ADE and FDE are important metrics for deterministic, single-trajectory methods, any deeper probabilistic information available from generative methods is destroyed when taking the mean over the dataset. Instead, in the main body of the paper we focus on evaluation methods which maintain such information. However, we can somewhat directly compare deterministic and generative methods using ADE and FDE by directly plotting the full error distributions for any generative methods, as in \cite{IvanovicPavone2019}. This provides an idea as to how close and concentrated the predictions are around the ground truth. \cref{fig:supp_ADE} shows both generative and deterministic methods' ADE and FDE performance. In both metrics, our method's error distribution is lower and more concentrated than other generative approaches, even outperforming state-of-the-art deterministic methods. 







\section{Additional Training Information}

\subsection{Choosing  in \cref{eqn:loss_fn}}

As shown in \cite{HigginsMattheyEtAl2017}, the  parameter weighting the KL penalty term is important to disentangle the latent space and encourage multimodality. A good value for this hyperparameter varies with the the size of input , condition , and latent space . Therefore, we adjust  depending on the size of the encoder's output . For example, we increase the value of  when encoding map information in the condition. Additionally,  is annealed following an increasing sigmoid \cite{BowmanVilnisEtAl2015}. Thus, a low  factor is used during early training iterations so that the model learns to encode as much information in  as possible. As training continues,  is gradually increased to shift the role of information encoding from  to . For , we found that a constant value of  works well.

\subsection{Separate Map Encoder Learning Rate}
When used, we train the map encoding CNN with a smaller learning rate compared to the rest of the model, to prevent large gradients in early training iterations. We use leaky ReLU activation functions with  to prevent saturation during early training iterations (when the CNN does not provide useful encodings to the rest of the model). We found that regular ReLU, sigmoid, and tanh activation functions saturate during early training and fail to recover.

\subsection{Data Augmentation}

To avoid overfitting to environment-specific characteristics, such as the general directions that agents move, we augment the data from each scene. We rotate all trajectories in a scene around the scene's origin by , where  varies from  to  (exclusive) in  intervals. The benefits of dataset augmentation by trajectory rotation have already been studied for pedestrians \cite{SchollerAravantinosEtAl2020}. We apply this same augmentation to autonomous driving datasets as most of them are recorded in cities whose streets are roughly orthogonal and separated by blocks.

\section{ETH Pedestrians Map Encoding}

\begin{figure}[t]
    \centering
    \includegraphics[height=2.6cm,frame]{figures/1-82.png}
    \includegraphics[height=2.6cm,frame]{figures/1-82_mapenc.png}
    \raisebox{0.65cm}{\includegraphics[height=1.25cm]{figures/1-82_legend.png}}
    \caption{\textbf{Left:} When only using trajectory data, \emphalgname{} does not know of obstacles and makes predictions into walls (in red). \textbf{Right:} Encoding a local map of the agent's surroundings significantly reduces the frequency of obstacle-violating predictions.}
    \label{fig:supp_eth_map_quali}
\end{figure}

\cref{fig:supp_eth_map_quali} shows an example of the reduction in the number of obstacle violations for pedestrians in the ETH - University scene that are especially close to an obstacle (i.e. they have at least one obstacle-violating trajectory in their Full output).

\section{Online Runtime}

\begin{figure}[t]
    \centering
    \includegraphics[width=\linewidth]{figures/smoothed_runtime_plot.pdf}
    \caption{Mean time for \emphalgname{} to generate future trajectory distributions on a laptop with a 2.7 GHz Intel Core i5 (Broadwell) CPU and 8 GB of RAM. None of the runtimes exceed  (with most at or below ), enabling the model to run  per prediction horizon for all tested datasets.}
    \label{fig:supp_runtime}
    \vspace{3mm}
\end{figure}

\cref{fig:supp_runtime} illustrates how \emphalgname{}'s runtime scales with respect to problem size. In particular, a heatmap is used as there are two major factors that affect the model's runtime: number of agents and amount of interactions. For points with insufficient data, e.g., the rare case of 50 agents in a scene with only 3 interactions, we impute values using an optimization-based scheme~\cite{HallacLeskovecEtAl2015}.
To achieve this real-time performance, we leverage the stateful representation that spatiotemporal graphs provide. Specifically, \emphalgname{} is updated online with new information without fully executing a forward pass. This is possible due to our method's use of LSTMs, as only the last LSTM cells in the encoder need to be fed the newly-observed data. The rest of the model can then be executed using the updated encoder representation.
 

\end{document}
