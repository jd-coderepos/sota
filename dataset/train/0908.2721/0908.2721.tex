 \documentclass[a4paper,oneside, 11pt]{article}
\usepackage{orange}
\usepackage{amssymb,amsfonts,amsmath, bbm,amstext}
\usepackage{graphicx,times,latexsym,makeidx,xspace,url,comment,subfigure,cite, multirow}
\usepackage{algorithm, algorithmic}
\usepackage{color}
\usepackage{epstopdf}

\newcommand{\I}[1]{  \mathbbm{1}_{ \left\{  #1 \right\} }   }
\newcommand{\N}[1]{\mathbbm{N}}
\newcommand{\SF}[1]{ \mbox{\fontsize{6}{6}\selectfont #1 }}
\newcommand{\A}{ {\mathcal{A}} }
\newcommand{\Q}{ {\mathcal{Q}} }


\newtheorem{Def}{Definition}
\newtheorem{lemma}{Lemma}
\newtheorem{theorem}{theorem}[section]
\newtheorem{prop}[theorem]{Proposition}
\newtheorem{lem}[theorem]{Lemma}
\newtheorem{cor}[theorem]{Corollary}
\newtheorem{ex}[theorem]{Example}
\newtheorem{rem}[theorem]{Remark}
\newtheorem{res}[theorem]{Result}
\newtheorem{obs}[theorem]{Observation}
\newtheorem{remark}[theorem]{Remark}


\begin{document}

\title{On the impact of TCP and per-flow scheduling on Internet performance (extended version)}

\author{Giovanna Carofiglio and Luca Muscariello\\
 Bell Labs, Alcatel-Lucent, France,  Orange Labs Paris\\}

\email{giovanna.carofiglio@alcatel-lucent.com,  luca.muscariello@orange-ftgroup.com}

\version{1.0 ORC1}

\date{31/07/2009}

\keywords{Congestion control; TCP; Per-flow scheduling}

\maketitle

\abstract{
Internet performance is tightly related to the properties of TCP and UDP protocols,
jointly responsible for the delivery of the great majority of Internet traffic.
It is well understood how these protocols behave under FIFO queuing
and what the network congestion effects. However, no comprehensive analysis
is available when flow-aware mechanisms such as per-flow scheduling and dropping policies
are deployed. Previous simulation and experimental results leave a number of unanswered questions.
In the paper, we tackle this issue by modeling via a set of fluid non-linear ODEs
the instantaneous throughput and the buffer occupancy of  long-lived TCP sources under three per-flow scheduling
disciplines (Fair Queuing, Longest Queue First, Shortest Queue First) and with longest queue drop buffer management.
We study the system evolution and analytically characterize the stationary regime:
closed-form expressions are derived for the stationary throughput/sending
rate and buffer occupancy which give thorough understanding of short/long-term fairness for TCP traffic.
Similarly, we provide the characterization of the loss rate experienced by UDP flows
in presence of TCP traffic.
As a result, the analysis allows to quantify benefits and drawbacks related to the deployment of
flow-aware scheduling mechanisms in different networking contexts.
The model accuracy is confirmed by a set of  simulations and by the evaluation
of the three scheduling disciplines in a real implementation in the Linux kernel.}




\section{Introduction}\label{sec:intro}

\subsection{Congestion control and per-flow scheduling}
Most of the previous work on rate controlled sources, namely TCP, has considered networks
employing FIFO queuing and implementing a buffer management scheme like drop tail or AQM (e.g. RED \cite{misra}).\\
As flow-aware networking gains momentum in the future Internet arena (see \cite{nick09}), per-flow scheduling
already holds a relevant position in today networks:  it is often deployed in
radio HDR/HSDPA \cite{umts}, home gateways \cite{ostallo,sqf-demo}, border IP routers \cite{hpsr,ancs05},
IEEE 802.11 access points \cite{tan}, but also ADSL aggregation networks.
Even if TCP behavior has been mostly  investigated under FIFO queuing, in
a large number of
significant network scenarios the adopted queuing scheme is not FIFO.\\
It is rather fundamental, then, to explore the performance of TCP in these less studied
cases and the potential benefits that may originate by the application of per-flow scheduling
in more general settings, e.g. in presence of rate
uncontrolled sources, say UDP traffic.\\
In this paper we focus on some per-flow schedulers with applications in wired networks:
\begin{itemize}
\item
\textit{Fair queuing} (FQ) is a well-known mechanism to impose fairness into a network link and it has
already been proved to be feasible and scalable on high rate links (\hspace{-0.1mm}\cite{suter, korte04, korte05}).
However, FQ is mostly deployed in access networks, because
of the common belief that per-flow schedulers are not scalable, as the number of running flows
grows in the network core.
\item
\textit{Longest Queue First} (LQF).
In the context of switch scheduling for core routers with virtual output queuing (VOQ),
throughput maximization has motivated the introduction of
an optimal input-output ports matching algorithm, maximum weight matching (MWM, see \cite{nick}),
that, in the case of a N-inputs-1-output router, reduces to selecting longest queues first.
Due to its computational complexity, MWM has been replaced by a number of heuristics, all equivalent
to a LQF scheduler in a multiplexer.
All results on the optimality of MWM refer to rate uncontrolled sources,
leaving open questions on its performance in more general traffic scenarios.

\item
\textit{Shortest Queue First} (SQF).
The third per-flow scheduler under study is a more peculiar and less explored scheduling discipline
that gives priority to flows generating little queuing.
Good properties of SQF  have been experimentally observed in \cite{ostallo,sqf-demo} in the context of home gateways
regarding the implicit differentiation provided for UDP traffic.
In radio access networks, as HDR/HSDPA, SQF has been shown, via simulations, to improve TCP completion times (e.g.\cite{umts}).
However, a proper understanding of the interaction between SQF and TCP/UDP traffic still lacks.

\end{itemize}

Multiple objectives may be achieved through per-flow scheduling such as fairness,
throughput maximization, implicit service differentiation. Therefore, explanatory models are necessary
to give a comprehensive view of the problem under general traffic patterns.
\subsection{Previous Models}
A vast amount of analytical models is behind the progressive understanding of the many facets of Internet congestion control
and has successfully contributed to the solution of
a number of networking problems. To cite a few, fair rate allocation \cite{Kelly98, massoulie}, TCP throughput evaluation
(see \cite{padhye,misra,altman,baccelli,ajmone}) and maximization (Split TCP \cite{carofiglioSplit}, multi-path TCP \cite{multipathTCP}),
buffer sizing \cite{Wischik}, etc.
Only recently, some works have started modeling
TCP under per-flow scheduling in the context of switch scheduling (\hspace{-0.2mm}\cite{giaccone, keslassyTCP}),
once made the necessary distinction between per-flow and switch scheduling, the latter being aware of input/output ports and not
of single user's flows.
More precisely, the authors focus on the case of one flow per port, where both problems basically fall into the same.
In \cite{giaccone} a discrete-time representation of the interaction between
rate controlled sources and LQF scheduling is given,
under the assumption of a per-flow RED-like buffer management policy that distributes early losses
among flows proportionally to their input rate (as in \cite{fred, afd}).
Packets are supposed to be chopped in fixed sized cells as commonly done
in high speed switching architectures.
\\In \cite{keslassyTCP} a similar discrete-time representation of scheduling dynamics is adopted for LQF and FQ,
with the substantial difference of separate queues of fixed size, instead of
virtual queues sharing a common memory.
Undesirable effects of flow's stall are observed in \cite{keslassyTCP}
and not in \cite{giaccone} due to the different buffer management policy.
Indeed, the assumption of separate physical queues is not of minor importance, since it may lead to flow  stall
as a consequence of tail drop on each separate queue.
Such unfair and unwanted effects
can be avoided using virtual queues with a shared memory jointly with \textit{Longest Queue Drop} (LQD)  buffer management
(see\cite{suter}).
Such phenomenon is known and it has been noticed for the first time in \cite{suter}.
In this way, in case of congestion, sources with little queuing are not penalized by packet drops,
allocated, instead, to more greedy flows.
Both works (\hspace{-0.1mm}\cite{giaccone},\cite{keslassyTCP}) are centered on TCP modeling, while considering UDP
(\hspace{-0.1mm}\cite{keslassyTCP}) only
as background traffic for TCP without any evaluation of its performance.
Finally, none of the aforementioned models has been solved analytically,
but only numerically and compared with network simulations.
\subsection{Contribution}
The paper tackles the issue of modeling the three above mentioned
flow-aware scheduling disciplines in presence of TCP/UDP traffic in a comprehensive
analytical framework based on a fluid representation of system dynamics.
We first collect some experimental results in Sec.\ref{sec:exp-rem}.
In order to address the questions left open,
we develop in Sec.\ref{sec:model} a fluid deterministic model
describing through ordinary differential equations either TCP sources behavior either virtual
queues occupancy over time.
Model accuracy is assessed in Sec.\ref{sec:accuracy} via the comparison against  simulations.
In presence of  TCP flows, the system of ODEs presented in Sec.\ref{sec:model} is
analytically solved in steady state and
closed-form expressions for mean sending rates and throughputs are provided in Sec.\ref{sec:Analytical-results}
for the three scheduling disciplines under study (SQF, LQF and FQ).
The model is, then, generalized to the case of  flows and
in presence of UDP traffic in Sec.\ref{sec:extensions}.
Interesting results on the UDP loss rate are derived in a mixed TCP/UDP scenario.
A numerical evaluation of analytical formulas  is carried out in Sec.\ref{sec:numerics} in comparison with packet-level simulations.
Finally, Sec.\ref{sec:discussion} summarizes the paper contribution and sheds light on potential applications of per-flow scheduling and
particularly SQF.

\section{Experimental remarks}\label{sec:exp-rem}
In this section we consider a simple testbed as a starting point of our analysis.
An implementation of FQ is available in Linux and, in addition, we have developed
the two missing modules needed in our context, LQF and SQF.
All three per-flow schedulers have similar implementations: a common memory is shared by virtual queues,
one per flow.
Packets belong to the same flow if they share the same
5-tuple (IP src and dst, port numbers, protocol) and in case of memory
saturation the flow with the longest queue gets a packet drop (LQD).
Our small testbed is depicted in Fig.\ref{fig:graph-test} where sender and receiver
employ the Linux implementation of TCP Reno. Different round trip times (RTTs) on each flow are obtained adding
emulated delays through netem and iptables (\hspace{-0.2mm}\cite{lartc}).
Three TCP flows with different RTTs  of 10, 100 and 200ms are run in parallel in the testbed,
and their long term throughput is measured at the receiver. Each test lasts 5 minutes and
the throughput is averaged over 10 runs. The result is reported in Fig.\ref{fig:graph-test}
but they can also be seen through the Jain index fairness J (\hspace{-0.2mm}\cite{jain})
in Tab.\ref{tab:fairness}.
About the long term throughput, we observe that
FQ is fair and the throughput is not affected by RTTs. On the contrary, LQF and SQF
suffer from a RTT bias: LQF favors flows with small RTT, while SQF favors flows with large RTT.
Moreover Tab.\ref{tab:fairness} shows that, while FQ and LQF show no difference between long and short term,
SQF is much more unfair at short time scales as J reduces to 0.55 in the short term, while being  0.735 in the long term
(J=1/N means that one flow out N gets all the resource over the
time window, J=1 is for perfect sharing).
\begin{figure}[htbp]
\centering

\caption{On the left: the experimental scenario. On the right: throughput's allocations.}
\label{fig:graph-test}
\end{figure}
Another interesting metric is the ratio between the received rate (throughput) and
the sending rate  which is equal to 99\% for FQ,
and  LQF and 95\% for SQF. In fact, SQF induces more losses w.r.t. the other two schedulers.
Link utilization is not affected by the scheduler employed and is always about 100\%.
All these phenomena are difficult to study and explain properly through a testbed and should
preferably be analyzed through an explanatory model.
A number of questions should find an answer through the analysis:
\begin{itemize}
\item[i)] what is the instantaneous sending rate/throughput of TCP under these three schedulers?
\item[ii)] what is the long term throughput?
\item[iii)] in a general network traffic scenario, including also UDP flows, what
is the performance of the whole system?
\end{itemize}
\begin{table}
\centering
\begin{tabular}{|cc|cc|cc|}
\hline
 \multicolumn{2}{|c}{{FQ}} & \multicolumn{2}{|c}{{LQF}} &\multicolumn{2}{|c|}{{SQF}} \\
\hline
\hline
ST & LT  & ST  & LT & ST & LT \\
0.999 & 0.999 & 0.734  & 0.736 & 0.55 & 0.735 \\
\hline
\end{tabular}
\caption{Jain index of fairness on short (0.5s) and long term (5min).}
\label{tab:fairness}
\end{table}

\section{Fluid Model}\label{sec:model}
The network scenario under study is a single bottleneck link of capacity  shared by a finite number  of
long-lived traffic sources of rate controlled (TCP) and rate uncontrolled (UDP) kind.
We first consider the case of rate controlled TCP sources only. The mixed TCP/UDP scenario is studied
in sec.\ref{sec:UDP}.


\subsection{Assumptions}\label{subsec:assumptions}
Each traffic source is modeled at the flow timescale through a  deterministic fluid model where the discrete packet
representation is replaced by a continuous one, either in space and in time.
Previous examples of fluid models of TCP/UDP traffic can be found in \cite{misra,ajmone,baccelli}.
Let us summarize the assumptions behind the model and give the notation (reported in Tab.\ref{tab:notation}).
\begin{itemize}
\item  A rate controlled source is modeled by a TCP Reno flows in \textit{congestion avoidance phase}, driven
by the AIMD (Additive Increase Multiplicative Decrease) rule, thus neglecting initial slow start phase and fast recovery.
\item  The \textit{round-trip delay},  of TCP flow , with  , is defined as the sum of two terms:
where  is the constant round-trip propagation delay, (which includes the transmission delay) and  is the queuing delay,
with  denoting the instantaneous virtual queue associated to flow .
Remark that in presence of a `per-flow' scheduler  each flow  is mapped into a virtual queue . The total queue occupancy,
denoted as , is limited to .
\item \textit{Sending rate.}  The
instantaneous sending rate of flow , , denoted by , is assumed proportional to the congestion window (in virtue of Little's law), 
\item \textit{Buffer management mechanism.} Under the assumption of \textit{ longest queue drop}
(LQD) as buffer management mechanism, whenever the total queue saturates, the TCP flow with the longest
virtual queue is affected by  packet losses and consequent window halvings.
\end{itemize}
\subsection{Source equations}\label{subsec:sources}
According to the usual fluid deterministic representation
(\cite{ajmone,baccelli,carofiglioSplit}),
the sending rate linearly increase as  in absence of packet losses.
Such representation usually employed for FIFO schedulers has to be modified in presence of per-flow schedulers when flows are not all simultaneously in service.
More precisely, it is reasonable to assume that flows do not increase their sending rate when not in service. It follows that in absence of packet losses, the increase
of the sending rate is given by 
The last expression accounts for linear increase whenever the total queue is empty and also for the reduction of the increase factor when multiple flows are simultaneously in service, proportional to their own departure rate,
.\\
Whenever a congestion event takes place (i.e. when the total queue  reaches saturation, ) and the virtual queue  is the largest one, flow  starts loosing packets in the queue at a rate proportional to the exceeding input rate at the queue, that is .
In addition, it halves its sending rate  proportionally to  (we use the convention ).
Therefore, the instantaneous sending rate of flow , , satisfies the following ODE (ordinary differential equation):

where
  denotes the departure rate for virtual queue  at time  (the additive increase takes place only when the
corresponding virtual queue is in service) and
 denotes the loss rate of flow  defined by
The loss rate is proportional to the fraction of the total arrival rate  that
exceeds link capacity when there exists only one longest queue. In presence of multiple longest queues, the allocation of losses among flows is made according to the difference between the input and the output rate of each flow.
Of course, the reaction of TCP to the losses is delayed according to the round trip time .\begin{obs}
Note that the assumption of zero rate increase for non-in-service flows is a consequence of the fact that the acknowledgement's rate is null in such phase. On the contrary, for FIFO schedulers, all flows are likely to loose packets and adjust their sending rate simultaneously, so  one can reasonably argue that the acknowledgment rate is never zero.
\end{obs}
\begin{table}[tb]
\begin{footnotesize}
\centering
\begin{tabular}{|l|l|}
\hline
  & Link capacity   \\
  & Number of TCP flows  \\
  & Round trip delay of flow ,  \\
  & Virtual queue of flow ,  \\
  & Total queue of finite size  \\
  & Sending rate of flow , \\
  & Departure rate (or throughput) of flow , \\
  & Loss rate of flow , \\
  & Set of longest queues ( similarly defined)\\
   & Set of bottlenecked flows, i.e. ,  \\
\hline
\end{tabular}
\caption{Notation}\label{tab:notation}
\end{footnotesize}
\end{table}
\subsection{Queue disciplines}\label{subsec:queues}
The instantaneous occupation of virtual queue , , obeys to the fluid ODE:

In this paper we consider three different work-conserving service disciplines (for which ):
FQ (Fair Queuing), LQF (Longest Queue First), SQF (Shortest Queue First).
The departure rate  varies according to the chosen service discipline:
\begin{itemize}
\item FQ:
\item LQF: 
\item SQF:
\end{itemize}
The total loss rate is denoted by .	
The instantaneous occupation of the total queue  is, hence, given by

\section{Model accuracy}\label{sec:accuracy}
Before solving the model presented in Sec.\ref{sec:model}, we present some
packet level simulations using  (\hspace{-0.2mm}\cite{ns2}) to show the accuracy of the
model.
We have implemented LQF and SQF in addition to FQ which is already available in ;
all implemented schedulers use shared memory and LQD buffer management.
Network simulations allow to monitor some variables more precisely than in a test-bed
as TCP congestion window (cwnd), and virtual queues time evolutions.
ending rate evolution is then evaluated as the ratio cwnd/RTT and queue evolution is
measured at every packet arrival, departure and drop.
This section includes some samples of the large number of simulations
run to assess model accuracy.
We present a simple scenario than counts two TCP flows with , 
sharing the same bottleneck of capacity Mbps, with a line card
using a memory of size kB.  simulates IP packets of fixed MTU size
equal to 1500B.
In Figg. \ref{fig:sqf},\ref{fig:fq-lqf} we compare the system evolution
predicted by (\ref{eqn:ODEsource})-(\ref{eqn:ODEqueue}) against
queue and rate evolution estimated in  as the ratio cwnd/RTT (congestion window over round trip time, variable in time).
Besides the intrinsic and known limitations of fluid models,  not able to
capture the burstiness at packet-level (visible in the sudden changes of queue occupancy),
the match between packet level simulations
and model prediction is remarkable.
The short timescale oscillations
observed in SQF will be better explained in Sec.\ref{sec:Analytical-results}.
\begin{figure*}[!htb]
\centering
\hspace{-2mm}\includegraphics[width=0.8\textwidth]{fig/SQF.pdf}
\caption{Time evolution of rates (top) and queues (bottom) under SQF: the model on the left,   on the right.}
\label{fig:sqf}
\end{figure*}
\begin{figure*}[!htb]
\includegraphics[width=0.8\textwidth]{fig/FQ-LQF.pdf}
\centering
\caption{Time evolution of rates and queues under FQ (top) and LQF (bottom): the model on the left,   on the right.}
\label{fig:fq-lqf}
\end{figure*}
\section{Analytical results}\label{sec:Analytical-results}
\vspace{-1mm}
Let us focus on the system of ODEs  (\ref{eqn:ODEsource})-(\ref{eqn:ODEqueue}) under the simplifying
assumption of instantaneous congestion detection
(the same assumption as in \cite{baccelli},\cite{carofiglioSplit}) and of constant round trip delay,

The last assumption is reasonable when the propagation delay term is predominant.
In addition, the numerical solution of (\ref{eqn:ODEsource})-(\ref{eqn:ODEqueue}) and
 simulations confirm that the system behavior in presence of variable  and
delayed congestion detection appears to be not significantly different.
Eq.(\ref{eqn:ODEsource}) becomes
In the following, we analytically characterize the solution of the system of ODEs
(\ref{eqn:ODEqueue})-(\ref{eqn:ODEsource2}) in presence of  flows and
for the three scheduling disciplines under study. We first focus on SQF scheduling
discipline, before
studying the more intuitive behavior of the system under LQF and FQ in Sec.\ref{sec:LQF}, Sec.\ref{sec:FQ}.
\subsection{Shortest Queue First (SQF) scheduling discipline}\label{sec:SQF}
For the ease of exposition, denote  and  and take  (the same arguments hold in the dual case  where replacing  with  and viceversa).
\begin{lem}
 The dynamical system described by (\ref{eqn:ODEqueue})-(\ref{eqn:ODEsource2}) under SQF scheduling discipline admits as unique stationary solution the limit-cycle composed by:\begin{itemize}
 \item \textit{phase  }:
  phase  (when  the origin coincides with the beginning of the phase)

where  denotes the limiting composition of  functions,
 and

 \item \textit{phase }:
  phase  (when  the origin coincides with the beginning of the phase)

where  is defined by symmetry w.r.t.  and

\end{itemize}
The duration of phase  is , while that of phase  is .
The period to the limit cycle is, therefore, equal to\\

\end{lem}
\begin{proof}
The proof is structured into three steps: \textbf{1)} we  study the transient regime
and analyze how the system reaches the first \textit{saturation point},
i.e. the time instant denoted by  at which total queue occupancy  attains saturation (),

\textbf{2)} We show that once reached this state, the system does not leave the \textit{saturation regime}, where the buffer remains full.
\textbf{3)} Under the condition , we characterize the cyclic evolution of virtual queues and rate and eventually
show the existence of a unique limit-cycle in steady state whose characterization is provided analytically.\\
\textbf{1)} With no loss of generality, assume  the system starts with  empty at , i.e.  and initial rates, ,.
At , TCP rates, ,  start increasing  according to (\ref{eqn:ODEsource2}) and the virtual queues are simultaneously served at rate ,  until it holds .
Hence, the queue  remains empty until the input rate to the buffer, \\

exceeds the link capacity , in .
From this point on, the total queue starts filling in and TCP rates keep increase in time (with , .
The system faces no packet losses until the first saturation point.
Departing from a non-empty queue clearly accelerates the attainment of buffer saturation, but it is always true that
at , the buffer is full () and .In general one can state that independently of the state of the system at , the rate increase in absence of packet losses guarantees that the system reaches in a finite time  the total queue saturation. When this happens, at , the total input rate is greater than the output link capacity, i.e. , which is equivalent to say that .
\\\textbf{2)} Once reached the saturation, the auxiliary result in appendix \ref{app:1} proves that the system remains in the \textit{saturation regime}, that is , .\begin{obs}
 One can argue that in practice the condition of full buffer is only verified within limited time intervals, and that the queue occupancy goes periodically under , when the buffer is emptying. Actually,  simulations and experimental tests confirm that the queue occupancy can instantaneously be smaller than , but overall the  average queue occupancy is approximately equal to . Indeed,
the difference w.r.t. a Drop Tail/FIFO queue is that SQF with LQD  mechanism eliminates the loss synchronization induced by drop tail under FIFO scheduling discipline, so that in our setting when a flow experiments packet losses, the other one still increases and feeds the buffer.
\end{obs}\textbf{3)}
Suppose  is the longest queue at  (the dual case is completely symmetric).
The rate  sees a multiplicative decrease according to (\ref{eqn:ODEsource2})
as  and  is the longest virtual queue. By solving (\ref{eqn:ODEsource2}), the resulting rate decay of  is 

where  is defined in (\ref{def:f}).
At the same time,  keeps increasing linearly.
In terms of queue occupation, since we proved that  from  on, it means that the decrease
due to packet drops in   is compensated by
the increase of .
In fact, no matter the values of  and  in , the rate at which  decreases is a function of the rate at which  increases.
Indeed, ,
It follows that the two queues become equal when .
We can denote by  the first \textit{queue meeting point},

The state of the system in  is,

where we defined , the value  given by (\ref{A1*_after}), which we recall is a function of .
From  on, the two flows and thus the two virtual queues invert their roles:  enters in service, whereas  suffers from packet losses and, consequently,  observes a multiplicative rate decrease, while  increases linearly.
Since , ,

and , if we denote by  the next queue meeting point,

The state of the system in  is,

where  ( is a function of ) and
 is defined in (\ref{def:g}).
\begin{figure}[htb]
\begin{center}
\includegraphics[width=0.8\textwidth,height=0.35\textwidth]{fig/epsilon-gamma.pdf}
\end{center}
\caption{Cyclic time evolution of TCP rates under SQF scheduling.}
 \label{fig:rates-cycle}
\end{figure}
\\Iteratively, one can construct a cycle for the virtual queue  ()  composed by two phases:
\begin{itemize}
 \item \textit{phase  }: when  () goes from  to  remaining smaller (greater) than  at a rate  (respectively );
 \item \textit{phase }:  when  () goes from  to  remaining greater (smaller) than  at a rate  (respectively ).
\end{itemize}
The duration of these phases depends on the values of  and  respectively at the beginning of phase  and phase .
As in Fig.\ref{fig:rates-cycle}, denote by  and  the initial values of  and  at the beginning of the  phase  and  respectively.
Thanks to the auxiliary result  in appendix \ref{app:2}, we prove that in steady state such initial values are zero and easily conclude the proof.
Let us now provide analytical expressions for the mean stationary values of sending rate and throughput. As a consequence, one can also compute the mean values of the stationary queues,
,  (one smaller, the other greater than ).
\end{proof}
\begin{cor}\label{cor:SQF}
The \textit{mean sending rates} in steady state are given by:


The \textit{mean throughput values} in steady state are given by:

\end{cor}
The mean virtual queues in steady state are given by:

\begin{proof}
The proof is reported in appendix \ref{app:3}.
\end{proof}
\subsection{Longest Queue First (LQF) scheduling discipline}\label{sec:LQF}
\begin{lem}
 The dynamical system described by (\ref{eqn:ODEqueue})-(\ref{eqn:ODEsource2}) under LQF scheduling discipline admits as unique stationary solution,

\end{lem}
\begin{proof}
As in the case of SQF, no matter the initial condition the system reaches the first saturation point,

with  and the buffer enters the \textit{saturation regime}, that is , .
As an example, we can consider the case of initial condition , .
At ,  start increasing as for SQF while  remains empty
until the input rate to the buffer, 
exceeds the link capacity , in .
From this point on, the total queue starts filling in and TCP rates keep increasing in time according to (\ref{eqn:ODEsource2}) with the only difference, w.r.t. the case of SQF, that
 is the longest queue served until buffer saturation and  only gets the remaining service capacity, when there is one.
The system faces no packet losses and  remains in service until  .\\
At ,
suppose with no loss of generality (the other case is symmetrical) that  is the longest virtual queue. The rate of ,  sees a multiplicative decrease according to (\ref{eqn:ODEsource2}).
By solving (\ref{eqn:ODEsource2}), the resulting rate decay of  is 

where  is defined in (\ref{def:f}).
At the same time,  increases linearly.
Once proved that ,  (see Appendix \ref{app:1}), no matter the values of  and  in , it holds

Thus, the two queues meet when , at
what we can denote by , the first \textit{queue meeting point}.
Once the queues reach the state , they cannot exit this state. Indeed, if we rewrite (\ref{eqn:ODEqueuek}), it gives:

with  independently of the rate values.
It implies that,

This can be explained by the following consideration: in presence of two longest queues , both queues are served proportionally
to the input rates  and , and loose packets in the same proportion, so preventing each queue to become greater (smaller) than the other.\\
About rates evolution, we now have two ODEs not anymore coupled with the queue evolution,
where we recall that we proved in appendix \ref{app:1} that , .
The system of ODEs can be easily solved and it admits one stationary solution:

In order to compute the mean throughput values in steady state, it suffices to observe
that , ,
which concludes the proof. Note that in practice, , that implies , .
\end{proof}
\subsection{Fair Queuing (FQ) scheduling discipline}\label{sec:FQ}
\begin{lem}
 The dynamical system described by (\ref{eqn:ODEqueue})-(\ref{eqn:ODEsource2}) under FQ scheduling discipline admits a unique stationary solution,

\end{lem}
\begin{proof}
As for SQF or LQF, no matter the initial condition the system reaches the first saturation point,

with 
and the buffer enters  the \textit{saturation regime}, that is , .
The evolution of the system until  differs from that of  or ,
as the two flows are allocated the fair rate until the virtual queues start filling in (when  exceeds ) and then they are served at capacity  independently of  and .
At , the system suffers from packet losses at rate  and the virtual queues ,  evolve towards the state
, 
Once the queues reach the state , ,  (otherwise one of the virtual queue would be empty) and the queues cannot exit this state.
Indeed, if we rewrite the ODE (\ref{eqn:ODEqueuek}), it gives:
with  independently of the rate values.
It implies that,

About the rates evolution, we now have two ODEs not anymore coupled with the queue evolution,

The system of ODEs can be easily solved and it admits one stationary solution:

In order to compute the mean throughput values in steady state, it suffices to observe that virtual queues are not empty and , ,
therefore ,
 . In addition,
note that, if , condition usually verified in practice, , .
\end{proof}









\section{Model Extensions}\label{sec:extensions}
\subsection{Extension to  flows}
In Sec.\ref{sec:Analytical-results} we studied the case of  TCP flows and analytically characterize
the stationary regime. For the case of  flows,
one can generalize the analytical results obtained in the two-flows scenario.
More precisely, under the SQF scheduling discipline, the resulting steady state
solution of (\ref{eqn:ODEqueue})-(\ref{eqn:ODEsource2}) is a limit-cycle
composed by  phases,
each one denoted as  phase (where flow  is in service) and of duration , with .
The mean stationary throughput associated to flow  is:

\\Under  scheduling discipline, one gets a generalization of (\ref{mean_rates_LQF}), where the mean stationary throughput associated to flow  is:\\

\\Similary, under FQ sheduling disciplines, it can be easily verified that there is still a fair allocation of the capacity  among flows:\\

\subsection{Extension to UDP traffic}\label{sec:UDP}
In this section we extend the analysis to the case of rate uncontrolled sources (UDP)
competing with TCP traffic. We simply model a UDP source as a CBR flow
with constant rate .
Consider the mixed scenario with one TCP source and one UDP source traversing a single bottleneck link
of capacity . The system is described by a set of ODEs:
with  the sending rate of the TCP flow, and  the sending rate of the UDP flow.
The definition of  is the same as in (\ref{def:L}).\\
The interesting metric to observe in the mixed TCP/UDP	 scenario is the loss rate experienced by UDP in steady state, ,
which allows one to evaluate the performance of streaming applications against those carried by TCP.\\
Under SQF scheduling discipline, independently of the initial condition, the system reaches a first saturation point, , where . After , the flow with the longest queue suffers from packet losses. Depending on the initial condition, it may be the UDP flow to first loose (if ) and in this case its virtual queue decreases until , where  before entering in service and finally emptying.
Indeed, for ,

and for ,

Whether it is TCP to loose in , virtual queues both decrease until  empties, i.e. ,

Once emptied,  remains equal to zero, since it is fed at rate .
The remaining service capacity  is allocated to the TCP flow, that behaves as a TCP flow in isolation on a bottleneck link of reduced capacity, equal to .
Thus, the loss rate of UDP is zero in steady state,When SQF is replaced by LQF, the outcome is the opposite. In fact, once the system reaches the first buffer saturation in , one can easily observe that virtual queues
tend to equalize, either when TCP or UDP is the flow affected by packet losses. When  in , virtual queues do not change anymore, since
, with  equal to  or  depending on the initial condition, and the
smaller one equal to .
The first ODE in (\ref{ODE_TCP-UDP}) related to  admits one stationary solution, that is,

Hence, the loss rate of UDP results to be By replacing the expression of  in (\ref{eq:A1-UDP}), we get

and 

It follows that:
under the condition , usually verified in practice.
It implies that the UDP loss rate is almost equal to its sending rate, and so the UDP throughput
is almost zero, exactly the opposite result w.r.t. SQF.
Finally, under FQ as scheduling discipline, it is easy to observe that both flows tend to the \textit{fair rate},
, 
and the loss rate of UDP is, hence, given by the difference

\section{Numerical results}\label{sec:numerics}
This section presents numerical evaluations of formulas obtained
in Sec.\ref{sec:Analytical-results} and Sec.\ref{sec:extensions}
and comparisons with packet level simulations.
We focus on TCP sending rates, TCP throughputs and UDP loss rates
for a selected scenario among a larger set.
We consider a Mbps bottleneck link for three TCP flows with different
RTTs. Tab.\ref{tab:notation} reports the numerical values of the
comparison, showing a good agreement between model and .
In  the link is almost fully utilized, although the model predicts
100\% utilization, this mirroring the model condition  in steady state.
The largest deviation
is registered for the TCP sending rate in presence of SQF while
the throughput is correctly predicted. We recall that while the throughput
formula is exact, the sending rate formula is approximated.
\begin{table}
\centering
\begin{tabular}{|l|rr|rr|rr|}
\hline
& \multicolumn{2}{|c}{{FQ [Mbps]}} & \multicolumn{2}{|c}{{LQF [Mbps]}} &\multicolumn{2}{|c|}{{SQF [Mbps]}} \\
\hline
\hline
&  & Model&  & Model&  & Model\\
  & 5.26 & 5.00 & 7.48 & 7.35 & 5.8 & 6.32 \\
  & 4.93 & 5.00 & 2.63 & 2.65 & 8.1 & 8.68 \\
    & 10.2 & 10.01 & 10.01 & 10.00 & 13.90 &  15.00\\
 & 5.12 & 5.00 & 7.37 & 7.35 & 2.90 & 2.65 \\
 & 4.79 & 5.00 & 2.47 & 2.65 & 7.08 & 7.35 \\
 & 9.91 & 10.00  & 9.85 & 10.00 & 9.99 & 10.00 \\
\hline
\end{tabular}
\caption{Numerical comparison between  and the model: Mbit/sec, , .}
\label{tab:numerics}
\end{table}
We also present, in Tab.\ref{tab:numerics2}, a scenario on the performance of TCP and UDP  sharing a common bottleneck
of Mbps, where the stream rate of UDP  is taken first smaller than the fair rate () and then
larger. Results highlight that UDP stalls under LQF, while
it gets prioritized under FQ as long as the stream rate is smaller than
the fair rate.
The possibility to implicitly differentiate traffic through FQ has been exploited in \cite{hpsr,ancs05} for backbone
and border routers where the fair rate is supposed to be very large. SQF appears to be much more effective
to fulfill this task as shown in Tab.\ref{tab:numerics2} (and through experimentation in \cite{ostallo}),
since it gives priority to UDP flows with any stream rate and allocates the rest of the bandwidth to TCP
(see Fig.\ref{fig:sqf-tcp-dup} on top, for the time evolution).
Hence, SQF turns out to be a promising per-flow scheduler to implement implicit service differentiation for UDP flows
with large stream rates.
\begin{table}
\centering
\begin{tabular}{|l|rr|rr|rr|}
\hline
& \multicolumn{2}{|c}{{FQ [Mbps]}} & \multicolumn{2}{|c}{{LQF [Mbps]}} &\multicolumn{2}{|c|}{{SQF [Mbps]}} \\
\hline
\hline
&  & Model&  & Model&  & Model\\
& \multicolumn{6}{c|}{{UDP rate  }}  \\
  & 0.01 & 0 &2.98  & 3 & 0.1 & 0 \\
  & 6.69 & 7 & 9.99& 10 & 6.97 & 7 \\
\hline
& \multicolumn{6}{c|}{{UDP rate  }}  \\
  & 1.96 & 2 & 6.95 & 7 & 0.1 & 0 \\
  & 4.98 & 5 & 9.87 & 10 & 2.98 & 3 \\
\hline
\end{tabular}
\caption{Scenario TCP/UDP: Mbit/sec, .}
\label{tab:numerics2}
\end{table}

\begin{figure}[htbp]
\centering
\includegraphics[width=0.8\textwidth]{fig/SQF-TCP-UDP.pdf}
\includegraphics[width=0.8\textwidth, height=0.25\textwidth]{fig/NSQF.pdf}
\caption{Top plots: TCP and UDP under SQF scheduling. Bottom plot: 3 TCP flows under SQF with RTTs=2ms,5ms,10ms, B=30kB.}
\label{fig:sqf-tcp-dup}
\end{figure}
Short-term fairness in SQF can also be observed in Fig.\ref{fig:sqf-tcp-dup}, on the bottom,
where three TCP flows share a common bottleneck of Mbps.
SQF allocates resources to TCP as a time division multiplexer with timeslots of variable size
proportional to RTTs. This is the reason why UDP traffic is prioritized
over TCP.
\section{Discussion and Conclusions}\label{sec:discussion}
The main contribution of this paper is given by the set of analytical
results gathered in Sec.\ref{sec:Analytical-results},\ref{sec:extensions}
that allow to capture and predict, in a relatively simple framework, the system evolution,
even in scenarios that would be difficult to study through simulation or experiments.
An additional, non marginal, contribution of the analysis is that we can now give a solid justification of many feasible
applications of such per-flow schedulers in today networks.\\
\textbf{\textit{FQ and LQF}.}
The absence of a limit-cycle for FQ and LQF in the stationary regime
explains the expected insensitivity of fairness w.r.t. the timescale.
In LQF, throughput is biased in favor of flows with small RTTs (the opposite
behavior is observed in SQF).
FQ, on the contrary, provides no biased allocations.
LQF has clearly applications in switching architectures to maximize global throughput. However,
the throughput maximization in switching fabrics in high speed routers
does not take into account the nature of Internet traffic, whose performance are closely related to TCP rate control.
As a consequence, flows that are bottlenecked elsewhere in the upstream path stall, and UDP streams
stall as well.\\
\textbf{\textit{SQF}.}
The analysis of SQF deserves particular attention. This per-flow scheduler has shown to have the attractive
property to implicitly differentiate streaming and data traffic, performing as a priority
scheduler for applications with low loss rate and delay constraints. Implicit service differentiation
is a great feature since it does not rely on the explicit knowledge of a specific application and preserves
network neutrality.
Recent literature on this subject has exploited FQ in order to achieve this goal
through the cross-protect concept (\hspace{-0.1mm}\cite{hpsr,ancs05}). Cross-protect gives priority to flows with
a rate below the fair rate and keeps the fair rate reasonably high through flow admission control
to limit the number of flows in progress. SQF achieves the same goal of cross-protect with no need of admission control as it differentiates
applications with rate much larger than the fair rate.
FQ is satisfactory on backbone links where the fair
rate can be assumed to be sufficiently high, whereas SQF has the ability to successfully replace it in access networks.
Furthermore,
SQF has a very different behavior from the other per-flow schedulers considered in this paper.
The instantaneous rate admits a limit cycle in the stationary regime, both for queues and rates,
in which flows are served in pseudo round-robin phases of duration proportional to the link capacity and to RTTs, so that long term throughput is biased in favor of flows with large RTTs.
Note that this oscillatory behavior, already observed for TCP under drop tail queue management and due to flow synchronization, here is due to the short term unfairness of SQF: the flow associated to the smallest queue is allocated
all the resources without suffering from  packet drops caused by congestion.
For instance, in LQF such phases do not exist because the flow with the longest queue is at the same time in service and penalized by
congestion packet drops.
Additional desired effects of SQF on TCP traffic, not accounted for by the model, derive
by the induced acceleration of the slow start phase (when a flow generates little queuing),
with the consequent global effect that small data transfers get prioritized on larger ones.
As a future work, we intend to investigate the effect of UDP burstiness, not captured by fluid models, on SQF implicit differentiation
capability, via a more realistic stochastic model.

\thebibliography{99}

\bibitem{ns2}
The Network Simulator - ,
http://www.isi.edu/nsnam/ns/

\bibitem{lartc}
Linux advanced routing and traffic control \url{http://lartc.org}

\bibitem{ajmone}
Ajmone Marsan M.;  Garetto M.; Giaccone P; Leonardi E;  Schiattarella E. and Tarello A.
Using partial differential equations to model TCP mice and elephants in large IP networks.
IEEE/ACM Transactions on Networking, vol. 13, no. 6, Dec. 2005, 1289-1301.

\bibitem{altman}
Altman E.; Barakat C. and Avratchenkov K.
TCP in presence of bursty losses.
In Proc. of ACM SIGMETRICS 2000.

\bibitem{baccelli}
Baccelli F. and Hong, D.
AIMD, Fairness and Fractal Scaling of TCP Traffic.	
In Proc of IEEE INFOCOM 2002.

\bibitem{carofiglioSplit}
Baccelli F.; Carofiglio G and Foss S.
Proxy Caching in Split TCP: Dynamics, Stability and Tail Asymptotics.
In Proc. of IEEE INFOCOM 2008.

\bibitem{sqf-demo}
Bonald T. and Muscariello L.
Shortest queue first: implicit service differentiation through per-flow scheduling.
Demo at IEEE LCN 2009.



\bibitem{giaccone}
Giaccone P.; Leonardi E. and Neri F.
On the behavior of optimal scheduling algorithms under TCP sources.
In Proc. of the International Zurich Seminar on Communications 2006.

\bibitem{multipathTCP}
Han H; Shakkottai S; Hollot C.V.; Srikant R; Towsley D.
Multi-path TCP: a joint congestion control and routing scheme to exploit path diversity in the internet.
IEEE/ACM Transaction on Networking vol. 14, no. 8, Dec. 2006, 1260-1271.

\bibitem{jain}
Jain R.; Chiu D.  and  Hawe W.
A Quantitative Measure Of Fairness And Discrimination For Resource Allocation In Shared Computer Systems.
DEC Research Report TR-301, Sep.1984

\bibitem{Kelly98}
Kelly F.; Maulloo A. and Tan D.
Rate control in communication networks: shadow prices, proportional fairness and stability.
Journal of the Operational Research Society 49 (1998) 237-252.

\bibitem{hpsr}
Kortebi A.;  Oueslati S. and  Roberts J.
Cross-protect: implicit service differentiation and admission control.
In Proc. of IEEE HPSR 2004.
	
\bibitem{korte04}
Kortebi A.; Muscariello L.; Oueslati S. and  Roberts J.
On the Scalability of Fair Queueing.
In Proc. of  ACM SIGCOMM  HotNets III, 2004.

\bibitem{korte05}
Kortebi A.; Muscariello L.; Oueslati S. and  Roberts J.
Evaluating the number of active flows in a scheduler realizing fair statistical bandwidth
sharing. In  Proc. of ACM SIGMETRICS  2005.

\bibitem{ancs05}
Kortebi A.; Muscariello L.; Oueslati S. and  Roberts J.
Minimizing the overhead in implementing flow-aware networking,
In Proc. of IEEE/ACM  ANCS 2005.

\bibitem{fred}
Lin D and Morris R.
Dynamics of Random early detection.
In Proc. of ACM SIGCOMM 97.

\bibitem{massoulie}
Massouli\'{e}, L. and Roberts, J.;
Bandwidth sharing: Objectives and algorithms,
IEEE/ACM Transactions on Networking, Vol. 10, no. 3, pp 320-328, June 2002.

\bibitem{nick09}
McKeown N. Software-defined Networking. Keynote Talk at IEEE INFOCOM 2009.
Available at \url{http://tiny-tera.stanford.edu/~nickm/talks/}

\bibitem{nick}
McKeown N.; Anantharam V and  Walrand J.  Achieving 100\% throughput in an input-queued switch.
In Proc. of IEEE INFOCOM 1996.

\bibitem{misra}
Misra V.; Gong W. and Towsley D.
Fluid-based analysis of a network of AQM routers supporting TCP flows with an application to RED.
In Proc. of ACM  SIGCOMM  2000.

\bibitem{umts}
Nasser N.;  Al-Manthari B.; Hassanein H.S.
A performance comparison of class-based scheduling algorithms in future UMTS access.
In Proc of IPCCC 2005.

\bibitem{ostallo}
Ostallo N. Service differentiation by means of packet scheduling.
Master Thesis, Institut Eur\'{e}com Sophia Antipolis, September 2008.
\url{http://perso.rd.francetelecom.fr/muscariello/master-ostallo.pdf}

\bibitem{padhye}
Padhye J.; Firoiu V.; Towsley D. and Kurose, J.
Modeling TCP Throughput: a Simple Model and its Empirical Validation.
In Proc. of ACM SIGCOMM 1998.

\bibitem{afd}
Pan R.; Breslau L.; Prabhakar B. and Shenker S.
Approximate fairness through differential dropping.
ACM SIGCOMM CCR 2003.

\bibitem{Wischik}
Raina G.; Towsley. D and  Wischik D.
Part II: Control theory for buffer sizing.
ACM SIGCOMM CCR 2005.

\bibitem{keslassyTCP}
Shpiner A and Keslassy I
Modeling the interaction of congestion control and switch scheduling.
In Proc of IEEE IWQOS 2009.

\bibitem{varghese}
Shreedhar M. and Varghese G.
Efficient fair queueing using deficit round robin.
In Proc. of ACM SIGCOMM 1995.

\bibitem{suter}
Suter B.; Lakshman T.V.; Stiliadis D.  and  Choudhury,A.K.
Design considerations for supporting tcp with per-flow queueing.
In Proc. of IEEE INFOCOM  1998.

\bibitem{tan}
Tan G. and Guttag J.
Time-based Fairness Improves Performance in Multi-rate Wireless LANs.
In Proc. of Usenix 2004.
\begin{appendix}
\section{Auxiliary result }\label{app:1}
\begin{prop}Given  and , , the total queue remains full, i.e. .
\end{prop}
\begin{proof}
To prove the statement is equivalent to prove that , .
In fact, under the condition , .
Let us take eq.(\ref{eqn:ODEsource2}) and write it for :

Since the derivative of  is lower-bounded by  and becomes zero when ,  it is clear that starting from  the total rate will remain
greater or equal to , , which is enough to prevent , initially full in , from decreasing.
\end{proof}
\section{Auxiliary result }\label{app:2}
The following result is the proof of the existence of the limit
the sequences , ,  and by symmetry .\begin{prop}The positive sequences  ,  , with
\begin{enumerate}
 \item ,  defined by the recursion
where

\item ,  defined by the recursion

\end{enumerate}
are convergent and their limits are , .
\end{prop}
\begin{proof}
Take the sequence . It holds:

where we defined  .\\
It follows that Indeed, it results , since the link capacity satisfies .
Since we assumed , , it implies that , that is the sequence converges to zero.
By symmetry, , which concludes the proof.
\end{proof}
\section{Proof of Corollary \ref{cor:SQF}}\label{app:3}
\begin{proof}
We denoted by  and  the mean values of the sending rates in steady state, that is

Decompose the integral over the limit cycle  in the sum of the integral over phase  and .
It results:

where we approximated  with .
Similarly, one gets the approximate expression for .
It is worth observing that the above approximation is justified by the numerical comparison of mean sending rates against .
In addition, it is important to distinguish among TCP \textit{sending rates} ,  (where  stands for the stationary version) and throughputs, , :
during phase ,  is served at capacity , so  and , as all packets sent by flow  are lost.
On the contrary, during phase , , whereas .
It results that:

In order to compute the value of the virtual queues in steady state, it suffices to recall that  and over phase , .
Hence,

where  denotes the limit-cycle duration, i.e. .
Similarly, one gets

Under the assumption , it results that, as expected, , while .\\
Note in addition that the approximation  in (\ref{eq:mean_sending_rates_SQF}) has no impact neither on the mean throughput nor on the virtual queue formulas.

\end{proof}

\end{appendix}


\end{document}
