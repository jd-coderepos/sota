\documentclass{article}



\usepackage[final, nonatbib]{nips_2017}

\usepackage[utf8]{inputenc} \usepackage[T1]{fontenc}    \usepackage{url}            \usepackage{epsfig}
\usepackage{booktabs}       \usepackage{amsfonts}       \usepackage{nicefrac}       \usepackage{microtype}      \usepackage{bbm}      \usepackage{graphicx}
\usepackage{amsmath,bm}
\usepackage{color}
\usepackage{caption}
\usepackage[font=footnotesize,labelfont=bf]{caption}
\usepackage{times}
\usepackage{epsfig}
\usepackage{wrapfig,lipsum,booktabs}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{csquotes}
\usepackage[british]{babel}
\usepackage{multirow}
\usepackage{color}
\usepackage{xcolor}
\usepackage{bm}
\usepackage{xcolor}
\usepackage{subcaption}
\usepackage{booktabs}
\usepackage{enumitem}
\usepackage{lipsum}
\usepackage{algpseudocode,algorithm,algorithmicx}
\usepackage{comment}
\newcommand*\Let[2]{\State #1  #2}
\setlist[itemize]{leftmargin=20 pt}
\usepackage[sans]{dsfont} \usepackage{wrapfig}
\usepackage{enumitem}
\usepackage[olditem,oldenum]{paralist}
\usepackage{hyperref}

\usepackage{multirow}
\usepackage{rotating}
\usepackage{booktabs}

\usepackage{alltt}
\usepackage{listings}

\usepackage{paralist}
\parindent=0pt
\parskip=5pt

\usepackage{mysymbols}
\newcommand{\haty}{\hat{y}}

\newcommand{\Qbot}{\textsc{Q-bot}\xspace}
\newcommand{\Abot}{\textsc{A-bot}\xspace}

\newcommand{\tnt}{Task \& Talk\xspace}

\newcommand{\fq}{\texttt{Frozen-Q}}
\newcommand{\fqm}{\texttt{Frozen-Q-multi}}
\newcommand{\fa}{\texttt{Frozen-A}}
\newcommand{\ff}{\texttt{Frozen-f}}
\newcommand{\slp}{\texttt{SL-pretrained}\xspace}
\newcommand{\rl}{\texttt{RL-full-QAf}\xspace}

\newcommand{\dialog}{dialog\xspace}
\newcommand{\Dialog}{Dialog\xspace}
\newcommand{\dialogs}{dialogs\xspace}
\newcommand{\Dialogs}{Dialogs\xspace}

\newcommand{\vd}{VisDial\xspace}
\newcommand{\vdfull}{Visual \Dialog}
\newcommand{\vqa}{VQA\xspace}

\newcommand{\myquote}[1]{\emph{`#1'}}

\newcommand{\seqtoseq}{Seq2Seq\xspace}

\newcommand{\lffull}{Late Fusion\xspace}
\newcommand{\lf}{LF\xspace}
\newcommand{\hrefull}{Hierarchical Recurrent Encoder\xspace}
\newcommand{\hre}{HRE\xspace}
\newcommand{\mn}{MN\xspace}
\newcommand{\mnfull}{Memory Network\xspace}
\newcommand{\vqaenc}{VQA-Enc\xspace}

\newcommand{\ourenc}{HCIAE\xspace}

\newcommand{\reffig}[1]{Fig.~\ref{#1}}
\newcommand{\refsec}[1]{Sec.~\ref{#1}}
\newcommand{\reftab}[1]{Tab.~\ref{#1}}


\newcommand{\train}{\texttt{train}\xspace}
\newcommand{\val}{\texttt{val}\xspace}
\newcommand{\test}{\texttt{test}\xspace}
 \parskip=3pt
\abovedisplayskip 3.0pt plus2pt minus2pt\belowdisplayskip \abovedisplayskip
\renewcommand{\baselinestretch}{0.98}



\newenvironment{packed_enum}{
\begin{enumerate}
  \setlength{\itemsep}{1pt}
  \setlength{\parskip}{0pt}
  \setlength{\parsep}{0pt}
}
{\end{enumerate}}

\newenvironment{packed_item}{
\begin{itemize}
  \setlength{\itemsep}{1pt}
  \setlength{\parskip}{0pt}
  \setlength{\parsep}{0pt}
}{\end{itemize}}

\newlength{\sectionReduceTop}
\newlength{\sectionReduceBot}
\newlength{\subsectionReduceTop}
\newlength{\subsectionReduceBot}
\newlength{\abstractReduceTop}
\newlength{\abstractReduceBot}
\newlength{\captionReduceTop}
\newlength{\captionReduceBot}
\newlength{\subsubsectionReduceTop}
\newlength{\subsubsectionReduceBot}

\newlength{\eqnReduceTop}
\newlength{\eqnReduceBot}

\newlength{\horSkip}
\newlength{\verSkip}

\newlength{\figureHeight}
\setlength{\figureHeight}{1.7in}

\setlength{\horSkip}{-.09in}
\setlength{\verSkip}{-.1in}



\setlength{\subsectionReduceTop}{-0.09in}
\setlength{\subsectionReduceBot}{-0.09in}
\setlength{\sectionReduceTop}{-0.10in}
\setlength{\sectionReduceBot}{-0.10in}
\setlength{\subsubsectionReduceTop}{-0.06in}
\setlength{\subsubsectionReduceBot}{-0.05in}
\setlength{\abstractReduceTop}{-0.05in}
\setlength{\abstractReduceBot}{-0.10in}


\setlength{\eqnReduceTop}{-0.05in}
\setlength{\eqnReduceBot}{-0.05in}




\setlength{\captionReduceTop}{-0.14in}
\setlength{\captionReduceBot}{-0.12in}
 
\newcommand{\devi}[1]{\textcolor{red}{DP: #1}}
\newcommand{\anitha}[1]{\textcolor{red}{AK: #1}}
\newcommand{\jiasen}[1]{\textcolor{blue}{JL: #1}}
\newcommand{\dhruv}[1]{\textcolor{teal}{DB: #1}}
\newcommand{\jianwei}[1]{\textcolor{brown}{JY: #1}}
\newcommand{\TODO}[1]{\textcolor{red}{TODO: #1}}


\title{Best of Both Worlds: Transferring Knowledge from Discriminative Learning to a Generative Visual Dialog Model}



\author{
  Jiasen Lu\thanks{Work was done while at Facebook AI Research.}  , Anitha Kannan\footnotemark[1]  , Jianwei Yang, Devi Parikh, Dhruv Batra\\
   Georgia Institute of Technology,  Curai,  Facebook AI Research \\
{\tt\small \{jiasenlu, jw2yang, parikh, dbatra\}@gatech.edu}
}

\begin{document}


\maketitle
\begin{abstract}
We present a novel training framework for neural sequence models, particularly for grounded dialog generation. 
The standard training paradigm 
for these models is maximum likelihood estimation (MLE), or minimizing the cross-entropy of the human responses.
Across a variety of domains, a recurring problem with MLE trained generative neural dialog models () is that 
they tend to produce  `safe' and generic responses (\myquote{I don't know}, \myquote{I can't tell}). 
In contrast, discriminative dialog models () that are trained to rank a list of candidate human responses outperform their generative counterparts; 
in terms of automatic metrics, diversity, \emph{and} informativeness of the responses. 
However,  is not useful in practice since it can not be deployed to have real conversations with users. 

Our work aims to achieve the best of both worlds -- the practical usefulness of  and the strong performance of  -- via knowledge transfer from  to .
Our primary contribution is  an end-to-end trainable generative visual dialog model, where  receives gradients from  as a \emph{perceptual} (not adversarial) loss
of the sequence sampled from . 
We leverage the recently proposed Gumbel-Softmax (GS) approximation to the discrete distribution -- 
specifically, a RNN augmented with a sequence of GS samplers, coupled with the straight-through gradient estimator to enable end-to-end differentiability.
We also introduce a stronger encoder for visual dialog, and employ a self-attention mechanism for answer encoding along with a metric learning loss to aid  in better capturing semantic similarities in answer responses. 
Overall, our proposed model outperforms state-of-the-art on the VisDial dataset by a significant margin (2.67\% on recall@10). The source code can be downloaded from \href{url}{\textcolor{blue}{https://github.com/jiasenlu/visDial.pytorch}}

\end{abstract}
\section{Introduction}
\label{sec:intro}




One fundamental goal of artificial intelligence (AI) is the development of perceptually-grounded dialog agents --
specifically, agents that can perceive or understand their environment (through vision, audio, or other sensors),
and communicate their understanding with humans or other agents in natural language. 
Over the last few years, neural sequence models (\eg \cite{sutskever2014sequence, sordoni2015neural, sukhbaatar2015end}) 
have emerged as the dominant paradigm 
across a variety of setting and datasets -- from text-only dialog \cite{sordoni2015neural, serban2017hierarchical, li2017adversarial, bordes2016learning} to more recently, 
visual dialog \cite{visdial,de2016guesswhat, das2017learning, mostafazadeh2017image, strub2017end},
where an agent must answer a sequence of questions grounded in an image, requiring it to reason about both visual 
content and the dialog history. 



The standard training paradigm for neural dialog models is maximum likelihood estimation (MLE) or equivalently, 
minimizing the cross-entropy (under the model) of a `ground-truth' human response. Across a variety of domains, a recurring problem with MLE trained neural dialog models is that they tend to produce 
`safe' generic responses, such as \myquote{Not sure} or \myquote{I don't know} 
in text-only dialog \cite{li2017adversarial}, and \myquote{I can't see} or \myquote{I can't tell} in visual dialog \cite{visdial,das2017learning}.
One reason for this emergent behavior is that the space of possible next utterances in a dialog is \emph{highly} multi-modal (there are many possible paths a dialog may take in the future). 
In the face of such highly multi-modal output distributions, models `game' MLE by latching on to the head of the distribution or the frequent responses, 
which by nature tend to be generic and widely applicable. 
Such safe generic responses break the flow of a dialog and tend to disengage the human conversing with the agent, 
ultimately rendering the agent useless. It is clear that novel training paradigms are needed; that is the focus of this paper. 



One promising alternative to MLE training proposed by recent work \cite{ranzato2015sequence, liu2016optimization}
is \emph{sequence-level training} of neural sequence models, specifically, using reinforcement learning 
to optimize task-specific sequence metrics such as BLEU~\cite{papineni2002bleu}, ROUGE~\cite{lin2004rouge}, CIDEr~\cite{vedantam2015cider}. Unfortunately, in the case of dialog, \emph{all existing} automatic metrics correlate poorly with human judgment \cite{liu2016not}, which renders this alternative infeasible for dialog models. 

In this paper, inspired by the success of adversarial training \cite{goodfellow2014generative}, we propose to train a \emph{generative} visual dialog model () to produce sequences that score highly under a \emph{discriminative} visual dialog model (). A discriminative dialog model receives as input a candidate list of possible responses and learns to sort this list from the training dataset. The generative dialog model () aims to produce a sequence that  will rank the highest in the list, as shown in Fig.~\ref{fig:teaser}.

Note that while our proposed approach is inspired by adversarial training, there are a number of subtle but crucial differences over generative adversarial networks (GANs). 
Unlike traditional GANs, one novelty in our setup is that our discriminator receives a list of candidate responses and explicitly learns to 
reason about similarities and differences across candidates.
In this process, 
 learns a task-dependent perceptual similarity \cite{dosovitskiy2016generating, johnson2016perceptual, gatys2015neural} and learns to recognize 
multiple correct responses in the feature space. For example, as shown in  Fig.~\ref{fig:teaser} right, given the image, dialog history, and question 
\myquote{Do you see any bird?}, besides the ground-truth answer \myquote{No, I do not},  can also assign high scores to other options that are 
valid responses to the question, including the one generated by : \myquote{Not that I can see}. 
The interaction between responses is captured via the similarity between the learned embeddings. This similarity gives an additional signal that  can leverage in addition to the MLE loss.
In that sense, our proposed approach may be viewed as an instance of `knowledge transfer' \cite{hinton2015distilling, chen2015net2net} from  to . 
We employ a metric-learning loss function and a self-attention answer encoding mechanism for  that makes 
it particularly conducive to this knowledge transfer 
by encouraging perceptually meaningful similarities to emerge. 
This is especially fruitful since prior work has demonstrated that discriminative dialog models significantly 
outperform their generative counterparts, but are not as useful since they necessarily need a list of candidate responses to rank, 
which is only available in a dialog dataset, not in real conversations with a user. In that context, our work aims to 
achieve the best of both worlds -- the practical usefulness of  and the strong performance of  -- via this knowledge transfer. 



Our primary technical contribution is an end-to-end trainable generative visual dialog model, 
where the generator receives gradients from the discriminator loss of the sequence sampled from . 
Note that this is challenging because the output of  is a sequence of discrete symbols, which \naively is not amenable to gradient-based training. 
We propose to leverage the recently proposed Gumbel-Softmax (GS) approximation to the discrete distribution \cite{jang2016categorical, maddison2016concrete} -- 
specifically, a Recurrent Neural Network (RNN) augmented with a sequence of GS samplers, which when coupled with the straight-through gradient estimator 
\cite{BengioLC13, jang2016categorical} enables end-to-end differentiability. 



Our results show that our `knowledge transfer' approach is indeed successful. Specifically, our discriminator-trained 
 outperforms the MLE-trained  by 1.7\% on recall@5 on the VisDial dataset, essentially improving over state-of-the-art~\cite{visdial} by 2.43\% recall@5 and 2.67\% recall@10. Moreover, our generative model produces more diverse and informative responses (see Table~\ref{table:qualititve}). 

As a side contribution specific to this application, we introduce a novel encoder 
for neural visual dialog models, which maintains two 
separate memory banks -- one for visual memory (where do we look in the image?) and another 
for textual memory (what facts do we know from the dialog history?), and outperforms the encoders used in prior work. 


 \section{Related Work}
\label{sec:related}



{\bf GANs for sequence generation.}
Generative Adversarial Networks (GANs) \cite{goodfellow2014generative} have shown to be effective models for a wide range of 
applications involving continuous variables (\eg images) {\it c.f} ~\cite{DentonCSF15,dcgan,LedigTHCATTWS16,CycleGAN2017}. 
More recently, they have also been used for discrete
output spaces such as language generation -- \eg image 
captioning \cite{dai2017towards,ShettyRHFS17}, dialog generation 
 \cite{li2017adversarial}, or text generation \cite{yu2017seqgan} -- by either viewing the generative model 
as a stochastic parametrized policy that is updated using REINFORCE with the discriminator providing 
the reward~\cite{yu2017seqgan,dai2017towards,ShettyRHFS17,li2017adversarial}, or (closer to our approach) through continuous
relaxation of discrete variables through Gumbel-Softmax to enable backpropagating the response from 
the discriminator \cite{Kusner16, ShettyRHFS17}.

There are a few subtle but significant differences \wrt to our application, motivation, and approach. 
In these prior works, both the discriminator and the 
generator are trained in tandem, and from scratch.
The goal of the discriminator in those settings has primarily been to 
discriminate `fake' samples (\ie generator's outputs) from `real' samples 
(\ie from training data). In contrast, we would like to  transfer 
knowledge from the discriminator to the generator. We start with pre-trained  and  models 
suited for the task, and then transfer knowledge from  to 
 to further improve , while keeping  fixed. 
As we show in our experiments, this procedure results in 
 producing diverse samples that are close in the embedding space to the ground truth, 
due to perceptual similarity learned in .  
One can also draw connections between our work and Energy Based GAN (EBGAN)~\cite{ebgan} -- 
without the adversarial training aspect. The ``energy'' in our case is a deep metric-learning based scoring mechanism, 
instantiated in the visual dialog application.


{\bf Modeling image and text attention.} 
Models for tasks at the intersection of vision and language -- \eg, image captioning 
\cite{donahue_cvpr15, fang_cvpr15, karpathy_cvpr15, vinyals2015show}, visual question 
answering \cite{antol2015vqa, gao2015you, malinowski2015ask, ren2015exploring},
visual dialog \cite{visdial, de2016guesswhat, das2017learning, strub2017end,mostafazadeh2017image} -- typically 
involve attention mechanisms. For image captioning, this may be attending to relevant 
regions in the image \cite{vinyals2015show,showattendtell15,LuXPS16}. 
For VQA, this may be attending to relevant image regions alone \cite{chen2015abc, xu2016ask,yang2016stacked} or 
co-attending to image regions and question words/phrases \cite{lu2016hierarchical}. 

In the context of visual dialog, \cite{visdial} uses attention to identify utterances in 
the dialog history that may be useful for answering the current question. However, when 
modeling the image, the entire image embedding is used to obtain the answer. In contrast, 
our proposed encoder \ourenc (\secref{sec:encoder}) localizes the region in the image that can help  
reliably answer the question. In particular, in addition to the history and the question guiding the image 
attention, our visual dialog encoder also reasons about 
the history when identifying relevant regions of the image. 
This allows the model to implicitly resolve co-references in the text and ground them back in the image.
 \section{Preliminaries: Visual Dialog}


\begin{figure}[t]
 \centering 
 \includegraphics[width=1\linewidth, scale=0.8, trim={0.5in 0 0.5in 0in}]{Fig1.pdf}
 \caption{Model architecture of the proposed model. Given the image, history, and question, the discriminator receives as additional input a candidate list of possible responses and learns to sort this list. The generator aims to produce a sequence that discriminator will rank the highest in the list. The right most block is 's score for different candidate answers. Note that the multiple plausible responses all score high. Image from the COCO dataset~\cite{lin2014microsoft}.}
 \label{fig:teaser}
 \vspace{-4mm}
\end{figure}

We begin by formally describing the visual dialog task setup as introduced by Das \etal~\cite{visdial}.
The machine learning task is as follows. A visual dialog model is given as input an image , caption  describing the image, 
a dialog history till round ,  
 ,  
and the followup question  at round . The visual dialog agent needs to return a valid response to the question. 

Given the problem setup, there are two broad classes of methods -- generative and discriminative models. 
Generative models for visual dialog are trained by maximizing the log-likelihood of the ground truth answer sequence 
given the encoded representation of the input (. 

On the other hand, discriminative models  receive both an encoding of the input ( 
\emph{and} as additional input a list of 100 candidate answers . These models effectively learn to sort the list. Thus, by design, they cannot be used 
at test time without a list of candidates available. 


 \vspace{-1mm}
\section{Approach: Backprop Through Discriminative Losses for Generative Training}
\vspace{-1mm}
In this section, we describe our approach to transfer knowledge from a discriminative visual dialog model () 
to generative visual dialog model ().  
Fig.~\ref{fig:teaser} (a) shows the overview of our approach.  
Given the input image , dialog history , and question , the encoder converts the inputs into a joint representation 
. 
The generator  takes  as input, and produces a distribution over answer sequences via a recurrent 
neural network (specifically an LSTM).  
At each word in the answer sequence, we use a Gumbel-Softmax sampler  to sample the answer token from that distribution. 
The discriminator  in it's standard form takes , ground-truth answer  and  ``negative'' answers 
 as input, and learns an embedding space such that 
, 
where  is the embedding function. 
When we enable the communication between  and , 
we feed the sampled answer  into discriminator, 
and optimize the generator  to produce samples that get higher scores in 's metric space. 

We now describe each component of our approach in detail. 

\subsection{History-Conditioned Image Attentive Encoder (\ourenc)}
\label{sec:encoder}

An important characteristic in dialogs is the use of co-reference to avoid repeating entities that can be contextually resolved. In fact, in the 
\vd dataset \cite{visdial} nearly all (98\%) dialogs involve at least one pronoun. 
This means that for a model to correctly answer a question, it would require a reliable mechanism for co-reference resolution. 

A common approach is to use an encoder architecture with an attention mechanism that implicitly performs co-reference resolution 
by identifying the portion of the dialog history that can help in answering the current question \cite{visdial, serban2015building, serban2016hierarchical, mei2016coherent}. 
while using a holistic representation for the image. Intuitively, one would also expect that the answer is also localized to regions in the image, and be consistent with the attended history. 

With this motivation, we propose a novel encoder architecture (called \ourenc) shown in \figref{fig:encoder_model}. 
Our encoder first uses the current question to attend to the exchanges in the history, 
and then use the question and attended history to attend to the image, so as to obtain the final encoding.  

\begin{wrapfigure}{r}{0.45\textwidth}
\vspace{-5mm}
  \begin{center}
    \includegraphics[width=0.45\textwidth, trim={1mm 1mm 1mm 1mm},clip]{Fig2.pdf}
  \end{center}
\caption{Structure of the proposed encoder. }\label{fig:encoder_model}  
 \vspace{-5mm}
\end{wrapfigure}


Specifically, we use the spatial image features  from a convolution layer of a CNN. 
 is encoded with an LSTM to get a vector . Simultaneously, each previous round of history  is encoded separately with another LSTM as . Conditioned on the question embedding, the model attends to the history. The attended representation of the history and the question embedding are concatenated, and used as input to attend to the image: 

where  is a vector with all elements set to 1.  and  are parameters to be
learned.  is the attention weight over history.  The attended history feature  is a convex combination of columns of , weighted appropriately by the elements of .
We further concatenate  and  as the query 
vector and get the attended image feature  in the similar manner. 
Subsequently,  all three components are used to obtain the final embedding :

where  is weight parameters and  is the concatenation operation.  
\subsection{Discriminator Loss}
\label{sec:discloss}
Discriminative visual dialog models produce a distribution over the candidate answer list 
and maximize the log-likelihood of the correct option . 
The loss function for  needs to be conducive for knowledge transfer. In particular, it needs to encourage 
perceptually meaningful similarities. Therefore, we use a metric-learning multi-class N-pair loss \cite{sohn2016improved} defined as: 

\vspace{-10pt}

where  is an attention based LSTM encoder for the answer. This attention can help the discriminator better deal with paraphrases across answers. The attention weight is learnt through a 1-layer MLP over LSTM output at each time step.
The N-pair loss objective encourages learning a space in which the ground truth answer is scored higher than other options, and at the same time, encourages options similar to ground truth answers to score better than dissimilar ones.  
This  means that, unlike the multiclass logistic loss, the options that are correct but 
different from the correct option may not be overly penalized, and thus can be useful in providing a reliable signal to the generator.  See Fig.~\ref{fig:teaser} for an example. 
Follwing \cite{sohn2016improved}, we regularize the L2 norm of the embedding vectors to be small.


\subsection{Discriminant Perceptual Loss and Knowledge Transfer from  to } 
\label{sec:transfer}


At a high-level, our approach for transferring knowledge from  to  is as follows: 
 repeatedly queries  with answers  that it generates for an input embedding   
to get feedback and update itself. 
In each such update, 's goal is to update its parameters to try and have  score higher than the correct answer, , under 's learned embedding and scoring function. 
Formally, the perceptual loss that  aims to optimize is given by:

where  is the embedding function learned by the discriminator as in \eqnref{eq:n-pair}. 
Intuitively, updating generator parameters to minimize  can be interpreted as 
learning to produce an answer sequence  that `fools' the discriminator into believing 
that this answer should score higher than the human response

under the discriminator's learned 
embedding  and scoring function. 

While it is straightforward to sample an answer   from the generator and perform a forward pass 
through the discriminator, \naively, it is not possible to backpropagate the gradients to the generator parameters 
since sampling discrete symbols results in zero gradients \wrt the generator parameters. 
To overcome this, we leverage the recently introduced 
continuous relaxation of the categorical distribution -- the Gumbel-softmax distribution or the Concrete distribution 
\cite{jang2016categorical, maddison2016concrete}. 

At an intuitive level, the Gumbel-Softmax (GS) approximation uses the so called `Gumbel-Max trick' to reparametrize sampling 
from a categorical distribution and replaces argmax with softmax to obtain a continuous relaxation of the discrete random 
variable. Formally, let  denote a -ary categorical random variable with parameters denoted by 
, or . Let  denote  IID samples from the standard Gumbel distribution, 
. Now, a sample from the Concrete distribution can be produced via the following transformation: 

where  is a temperature parameter that control how close samples  from this Concrete distribution approximate the 
one-hot encoding of the categorical variable . 

As illustrated in \figref{fig:teaser}, we augment the LSTM in  with a sequence of GS samplers. 
Specifically, at each position in the answer sequence, we use a GS sampler to sample an answer token from that conditional 
distribution. 
When coupled with the straight-through gradient estimator 
\cite{BengioLC13, jang2016categorical} this enables end-to-end differentiability. 
Specifically, 
during the forward pass we discretize the GS samples into discrete samples, 
and in the backward pass use the continuous relaxation to compute gradients.  In our experiments, we held the temperature parameter fixed at 0.5. 
\section{Experiments}
\label{sec:exp}
\vspace{-1mm}


\textbf{Dataset and Setup.}
We evaluate our proposed approach on the \vd dataset \cite{visdial}, 
which was collected by Das~\etal by pairing two subjects on Amazon Mechanical Turk to chat about an image. 
One person was assigned the role of a `questioner' and the other of `answerer'.
One worker (the questioner) sees only a single line of text describing an image (caption from COCO~\cite{lin2014microsoft}); 
the image remains hidden to the questioner. 
Their task is to ask questions about this hidden image to ``imagine the scene better''. 
The second worker (the answerer) sees the image and caption and answers the questions. 
The two workers take turns asking and answering questions for 10 rounds. 
We perform experiments on \vd v0.9 (the latest available release) containing 83k dialogs on COCO-train and 
40k on COCO-val images, for a total of 1.2M dialog question-answer pairs.  
We split the 83k into 82k for \train, 1k for \val, and use the 40k as \test, in a manner consistent with \cite{visdial}. 
The caption is considered to be the first round in the dialog history. 
 
\textbf{Evaluation Protocol.} Following the evaluation protocol established in \cite{visdial}, 
we use a retrieval setting to evaluate the responses at each round in the dialog. 
Specifically, every question in \vd is coupled with a list of 100 candidate answer options, which the models are asked to sort for evaluation purposes. 
 uses its score to rank these answer options, and  uses the log-likelihood of these options for ranking. 
Models are evaluated on standard retrieval metrics -- (1) mean rank, 
(2) recall , and (3) mean reciprocal rank (MRR) -- of the human response in the returned sorted list.  

\textbf{Pre-processing.} We truncate captions/questions/answers longer than 24/16/8 words respectively. 
We then build a vocabulary of words that occur at least 5 times in \train, resulting in 8964 words. 

\textbf{Training Details}
In our experiments, all 3 LSTMs are single layer with  hidden state. 
We use VGG-19 \cite{simonyan2014very} to get the representation of image. We first rescale the images to be  pixels, and take the output of last pooling layer () as image feature.
We use the Adam optimizer with a base learning rate of 4e-4. We pre-train  using standard MLE 
for 20 epochs, and  with supervised training based on Eq (\ref{eq:n-pair}) for 30 epochs. Following \cite{sohn2016improved}, we regularize the  norm of the embedding vectors to be small. Subsequently, we train  with , which is a combination of discriminative perceptual loss and MLE loss. We set  to be 0.5. 
We found that including  (with teacher-forcing) is important for encouraging  to generate grammatically correct responses. 

\subsection{Results and Analysis}
\label{exp:result}


\textbf{Baselines.}
We compare our proposed techniques to the current state-of-art generative and discriminative models developed in \cite{visdial}. 
Specifically, \cite{visdial} introduced 3 encoding architectures --  
Late Fusion (\textbf{LF}), Hierarchical Recurrent Encoder (\textbf{HRE}), Memory Network (\textbf{MN}) -- 
each trained with a generative (\textbf{-G}) and discriminative (\textbf{-D}) decoder. We compare to all 6 models. 

\textbf{Our approaches.}
We present a few variants of our approach to systematically study the individual contributions of our training procedure, novel encoder (\ourenc), self-attentive answer encoding (ATT), and metric-loss (NP). 

\begin{itemize}
\item \textbf{\ourenc-G-MLE} is a generative model with our proposed encoder trained under the MLE objective. Comparing 
this variant to the generative baselines from \cite{visdial} establishes the improvement due to our encoder (\ourenc). 

\item \textbf{\ourenc-G-DIS} is a generative model with our proposed encoder trained under the mixed MLE and discriminator loss
(knowledge transfer). This forms our best generative model. Comparing this model to \textbf{\ourenc-G-MLE} establishes the improvement 
due to our discriminative training. 

\item \textbf{\ourenc-D-MLE} is a discriminative model with our proposed encoder, trained under the standard discriminative 
cross-entropy loss. The answer candidates are encoded using an LSTM (no attention). Comparing this variant to the discriminative baselines from \cite{visdial} establishes the improvement due 
to our encoder (\ourenc) in the discriminative setting. 

\item \textbf{\ourenc-D-NP} is a discriminative model with our proposed encoder, trained under the n-pair discriminative loss 
(as described in \secref{sec:discloss}). The answer candidates are encoded using an LSTM (no attention). Comparing this variant to \textbf{\ourenc-D-MLE} establishes the improvement 
due to the n-pair loss. 

\item \textbf{\ourenc-D-NP-ATT} is a discriminative model with our proposed encoder, trained under the n-pair discriminative loss 
(as described in \secref{sec:discloss}), and using the self-attentive answer encoding. Comparing this variant to \textbf{\ourenc-D-NP} establishes the improvement 
due to the self-attention mechanism while encoding the answers.

\end{itemize}

\textbf{Results.} 
Tables \ref{tab:gen}, \ref{tab:disc} present results for all our models and baselines in generative and discriminative settings. 
The key observations are: 
\begin{enumerate}
\item {\bf Main Results for \ourenc-G-DIS:} Our final generative model with all `bells and whistles', \textbf{\ourenc-G-DIS}, 
uniformly performs the best under all the metrics, outperforming the previous state-of-art model \textbf{MN-G} by 2.43\% on R@5. 
This shows the importance of the knowledge transfer from the discriminator and the benefit from our encoder architecture. 

\item {\bf Knowledge transfer \vs encoder for :} To understand the relative importance of the proposed history 
conditioned image attentive encoder (\ourenc) and the knowledge transfer, we compared the performance of \textbf{\ourenc-G-DIS} 
with \textbf{\ourenc-G-MLE}, 
which uses our proposed encoder but without any feedback from the discriminator. 
This comparison highlights two points: first, \textbf{\ourenc-G-MLE} improves R@5 by 0.7\% over the current 
state-of-art method (\textbf{MN-D}) confirming the benefits of our encoder. Secondly, and importantly,  its performance 
is lower than \textbf{\ourenc-G-DIS} by 1.7\% on R@5, confirming that the modifications to encoder alone will not be sufficient to gain 
improvements in answer generation; knowledge transfer from  greatly improves . 

\item {\bf Metric loss {\it vs.} self-attentive answer encoding}: In the purely discriminative setting, our final discriminative 
model (\textbf{\ourenc-D-NP-ATT}) also beats the performance of the corresponding state-of-art models \cite{visdial} by 2.53\% on R@5. 
The n-pair loss used in the discriminator is not only helpful for knowledge transfer but it also improves the performance 
of the discriminator by 0.85\% on R@5 (compare \textbf{\ourenc-D-NP} to 
\textbf{\ourenc-D-MLE}).
The improvements obtained by using the 
answer attention mechanism leads to an additional, albeit small,
gains of 0.4\%  on R@5 to the discriminator performance (compare \textbf{\ourenc-D-NP} to \textbf{\ourenc-D-NP-ATT}). 
\end{enumerate}

\begin{table}
\setlength{\tabcolsep}{2.0pt} 
\begin{minipage}{\textwidth}
  \begin{minipage}{0.50\textwidth} \small
    \centering
    \captionof{table}{Results (generative) on VisDial dataset. ``MRR'' is mean reciprocal rank and ``Mean'' is mean rank.}
    \label{tab:generative}
    \begin{tabular}{@{}l c c c c c@{}}
      \toprule
      Model  & MRR & R@1 & R@5 & R@10 & Mean \\
      \midrule	    
      LF-G \cite{visdial} & 0.5199 & 41.83 & 61.78 & 67.59 & 17.07 \\
      HREA-G \cite{visdial} & 0.5242 & 42.28 & 62.33 & 68.17 & 16.79 \\
      MN-G \cite{visdial} & 0.5259 & 42.29 & 62.85 & 68.88 & 17.06 \\
      \midrule	    	 
      \ourenc-G-MLE & 0.5386 & 44.06 & 63.55 & 69.24 & 16.01 \\
      \ourenc-G-DIS & \textbf{0.5467} &  \textbf{44.35} &  \textbf{65.28} &  \textbf{71.55} &  \textbf{14.23}\\
     \bottomrule
    \end{tabular}        
    \label{tab:gen}
  \end{minipage}
  \begin{minipage}{0.50\textwidth} \small
    \centering
    \captionof{table}{Results (discriminative) on VisDial dataset.}
    \label{tab:discriminative}
    \begin{tabular}{@{}l c c c c c@{}}
      \toprule
      Model  & MRR & R@1 & R@5 & R@10 & Mean \\
      \midrule	    
      LF-D \cite{visdial} & 0.5807 & 43.82 & 74.68 & 84.07 & 5.78 \\
      HREA-D \cite{visdial} & 0.5868 & 44.82 & 74.81 & 84.36 & 5.66 \\
      MN-D \cite{visdial} & 0.5965 & 45.55 & 76.22 & 85.37 & 5.46 \\
      \midrule	    	 
      \ourenc-D-MLE & 0.6140 & 47.73 & 77.50 & 86.35 & 5.15 \\
      \ourenc-D-NP & 0.6182 & 47.98 & 78.35 & 87.16 & 4.92 \\
      \ourenc-D-NP-ATT & \textbf{0.6222} & \textbf{48.48} & \textbf{78.75} & \textbf{87.59} & \textbf{4.81}\\
     \bottomrule
    \end{tabular}             
    \label{tab:disc}
  \end{minipage}
\end{minipage}
\vspace{-3mm}
\end{table}

\subsection{Does updating discriminator help?}


Recall that our model training happens as follows: we independently train the generative model \textbf{\ourenc-G-MLE} 
and the discriminative model \textbf{\ourenc-D-NP-ATT}. With \textbf{\ourenc-G-MLE} as the initialization, 
the generative model is updated based on the feedback from \textbf{\ourenc-D-NP-ATT} and this results in our final \textbf{\ourenc-G-DIS}. 

We performed two further experiments to answer the following questions:
\begin{itemize}
\item What happens if we continue training \textbf{\ourenc-D-NP-ATT} in an adversarial setting? 
In particular, we continue training by maximizing the score of the ground truth answer 
and minimizing the score 
of the generated answer , effectively setting up an adversarial training regime 
. The resulting 
discriminator \textbf{\ourenc-GAN1} has significant drop in performance, as can be seen in 
Table.~\ref{tab:gan} (32.97\% R@5). This is perhaps expected because \textbf{\ourenc-GAN1} 
updates its parameters based on only two answers, the ground truth and the generated 
sample (which is likely to be similar to ground truth). This wrecks the structure that 
\textbf{\ourenc-D-NP-ATT} had previously learned by leveraging additional incorrect options.

\item What happens if we continue structure-preserving training of \textbf{\ourenc-D-NP-ATT}? 
In addition to providing \textbf{\ourenc-D-NP-ATT} samples from  as fake answers, we also include 
incorrect options as negative answers so that the structure learned by the discriminator 
is preserved. \textbf{\ourenc-D-NP-ATT} continues to train under loss .  
In this case (\textbf{\ourenc-GAN2} in  Table.~\ref{tab:gan}), we find that there is a small 
improvement in the performance of . The additional computational overhead to training 
the discriminator supersedes the performance improvement. Also note that \textbf{\ourenc-D-NP-ATT} 
itself gets worse at the dialog task. 
\end{itemize}

One might wonder, why not train a GAN for visual dialog? Formulating the task in a GAN setting would involve  and   
training in tandem with  providing feedback as to  whether a response that  generates is real or fake.  We found this to be a particularly unstable setting, for two main reasons: 
First, consider the case when the ground truth answer and the generated answers are the same. This happens for answers that are typically  short or `cryptic' 
(e.g. \myquote{yes}). In this case,  can not train itself or provide 
feedback, as the answer is labeled both positive and negative. Second, in cases where the  ground truth answer is descriptive but the generator provides a short answer,  can  quickly become powerful enough to discard generated samples as fake. In this case,  is  not able to provide any information to  to get better at the task.  
Our experience suggests that the discriminator, if one were to consider a `GANs for visual dialog' setting, can not merely be focused on differentiating fake from real. It  needs to be able to score similarity between the ground truth and other answers. Such a scoring mechanism provides a more reliable feedback to .  In fact, as we show in the previous two results, a pre-trained  that captures this structure is the key ingredient in sharing knowledge with . The adversarial training of  is not central. 
\subsection{Qualitative Comparison}
\label{sec:quality-result}
In Table~\ref{table:qualititve} we present a couple of qualitative examples that compares the responses generated by G-MLE and G-DIS. G-MLE predominantly 
produces `safe' and less informative answers, such as \myquote{Yes} and or \myquote{I can't tell}. In contrast, our proposed model G-DIS does so less frequently, and often generates more diverse yet informative responses.

\begin{table}[t]
    \vspace{-6pt}
	\renewcommand*{\arraystretch}{0.8}
    \setlength{\tabcolsep}{6px}
    \caption{Qualitative comparison. ``Ours'' are samples from G-DIS model with different gumbel noise . Images from the COCO dataset~\cite{lin2014microsoft}.}
    \label{table:qualititve} 
    \begin{center}\hspace{-5.5pt}
    \begin{tabular}{p{3.0cm} p{3.0cm} p{3.0cm} p{3.0cm} p{2.5cm}}
    \toprule
\vspace{-10pt}
    \center
    \includegraphics[height=2cm]{figure/fig1}
    \newline\vspace{-10pt}
    \begin{minipage}{2.8cm}
    \begin{compactenum}[\hspace{-6pt}]
    \tiny
    \item \tiny \textbf{Q}: Is it a home or restaurant?
    \item \tiny \textbf{A}: I think restaurant. 
	\item \tiny \textbf{G-MLE}: I can't tell.
	\item \tiny \textbf{Ours ()}: Hard to say.
	\item \tiny \textbf{Ours ()}: It looks like a restaurant.
	\item \tiny \textbf{Ours ()}: I can't tell because it is too close.
    \end{compactenum}
    \end{minipage}
    &
    \vspace{-10pt}
    \center
    \includegraphics[height=2cm]{figure/fig2}
    \newline\vspace{-10pt}
    \begin{minipage}{2.8cm}
    \begin{compactenum}[\hspace{-6pt}]
    \tiny
    \item \tiny \textbf{Q}: Can you see his face?
    \item \tiny \textbf{A}: I am not sure.
	\item \tiny \textbf{G-MLE}: Yes.
	\item \tiny \textbf{Ours ()}: I can only see the back of his body.
	\item \tiny \textbf{Ours ()}: No.
	\item \tiny \textbf{Ours ()}: No , he's too far away.
    \end{compactenum}
    \end{minipage}
    &
    \vspace{-10pt}
    \center
    \includegraphics[height=2cm]{figure/fig5}
    \newline\vspace{-10pt}    
    \begin{minipage}{2.8cm}
    \begin{compactenum}[\hspace{-6pt}]
    \tiny
    \item \tiny \textbf{Q}: How old does the man seem to be?
    \item \tiny \textbf{A}: 20's.
	\item \tiny \textbf{G-MLE}: Late teens.
	\item \tiny \textbf{Ours ()}: On his 20s.
	\item \tiny \textbf{Ours ()}: In his twenties.
	\item \tiny \textbf{Ours ()}: Mid 20's.
    \end{compactenum}
    \end{minipage}
    &
    \vspace{-10pt}
    \center
    \includegraphics[height=2cm]{figure/fig4}
    \newline\vspace{-10pt}    
    \begin{minipage}{2.8cm}
    \begin{compactenum}[\hspace{-6pt}]
    \tiny
    \item \tiny \textbf{Q}: Can you see broccoli?
    \item \tiny \textbf{A}: Yes, 3 larger pieces and some small.
	\item \tiny \textbf{G-MLE}: No, just the broccoli.
	\item \tiny \textbf{Ours ()}: I can see broccoli, slightly butter.
	\item \tiny \textbf{Ours ()}: Yes, there is broccoli.
	\item \tiny \textbf{Ours ()}: Yes, broccoli is green.
    \end{compactenum}
    \end{minipage}
	\vspace{3mm}
	\tabularnewline
    \bottomrule
    \end{tabular}\\\end{center}
    \vspace{-4mm}
\end{table} 
\begin{table}[t]\footnotesize
\setlength{\tabcolsep}{5.2pt}
  \caption{Adversarial training results on \vd dataset. }
  \label{tab:gan}
  \centering
  \begin{tabular}{l c c c c c c c c c c}
    \toprule
    \multicolumn{1}{c}{} & \multicolumn{5}{c}{Discriminative}  & \multicolumn{5}{c}{Generative}\\    
   \cmidrule(r){2-6}
   \cmidrule(r){7-11}    
    Model  & MRR & R@1 & R@5 & R@10 & Mean & MRR & R@1 & R@5 & R@10 & Mean\\
    \midrule	    
	\ourenc-D-NP-ATT & 0.6222 & 48.48 & 78.75 & 87.59 & 4.81 & - & - & - & - & -\\
	\ourenc-G-DIS & - & - & - & - & - & 0.5467 &  44.35 &  65.28 &  71.55 & 14.23\\
    \midrule	    
    \ourenc-GAN1 & 0.2177 & 8.82 & 32.97 & 52.14 & 18.53 & 0.5298 & 43.12 & 62.74 & 68.58 & 16.25 \\
    \ourenc-GAN2 &  0.6050 & 46.20 & 77.92 & 87.20 & 4.97 & 0.5459 & 44.33 & 65.05 & 71.40 & 14.34\\
   \bottomrule
  \end{tabular}
  \vspace{-3mm}
\end{table} \section{Conclusion}
\label{sec:con}
\vspace{-1mm}
Generative models for (visual) dialog are typically trained with an MLE objective.
As a result, they tend to latch on to safe and generic responses.
Discriminative (or retrieval) models on the other hand have been shown to significantly outperform 
their generative counterparts. However, discriminative models can not be deployed as dialog agents 
with a real user where canned candidate responses are not available. 
In this work, we propose transferring knowledge from a powerful discriminative visual dialog model to 
a generative model. 
We leverage the Gumbel-Softmax (GS) approximation to the discrete distribution --specifically, a RNN augmented with a sequence of GS samplers, coupled with a ST gradient estimator for end-to-end differentiability.
We also propose a novel visual dialog encoder that reasons about image-attention 
informed by the history of the dialog; and employ a metric learning loss along with a self-attentive answer encoding to enable the discriminator 
to learn meaningful structure in dialog responses.
The result is a generative visual dialog model that significantly outperforms state-of-the-art. 

%
 {\footnotesize
\bibliographystyle{plain}
\bibliography{strings,egref}
}
\end{document}
