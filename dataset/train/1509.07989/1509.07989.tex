


\documentclass[journal]{IEEEtran}


 \usepackage{amsmath,amsthm}
\usepackage{algorithmic}
  \usepackage{algorithm}
  \usepackage{stmaryrd}
  \usepackage{pxfonts}
  \usepackage{graphicx}
  \usepackage{array}
\usepackage[nocompress]{cite}
  








\begin{document}

\title{Resource Allocation in Peer-to-Peer Networks: A Control Theoretical Perspective}


\author{Nitin~Singha,~Ruchir~Gupta,~\IEEEmembership{Member~IEEE,}
        ~Yatindra~Nath~Singh,~\IEEEmembership{Senior~Member,~IEEE}\thanks{Nitin Singha and Yatindra Nath Singh are with the Department of Electrical Engineering,
	Indian Institute of Technology, Kanpur, India.\protect\\
E-mail:{{nitinss}@iitk.ac.in}}\thanks{Ruchir Gupta is with Department of Computer Science,
IIITDM Jabalpur }}


\maketitle


\begin{abstract}
P2P system rely on voluntary allocation of resources by its members due to absence of any central controlling authority. This resource allocation can be viewed as classical control problem where feedback is the amount of resource received, which controls the output i.e. the amount of resources shared back to the network by the node. The motivation behind the use of control system in resource allocation is to exploit already existing tools in control theory to improve the overall allocation process and thereby solving the problem of freeriding and whitewashing in the network. At the outset, we have derived the transfer function to model the P2P system. Subsequently, through the simulation results we have shown that transfer function was able to provide optimal value of resource sharing for the peers during the normal as well as high degree of overloading in the network. Thereafter we verified the accuracy of the transfer function derived by comparing its output with the simulated P2P network. To demonstrate how control system reduces free riding it has been shown through simulations how the control systems penalizes the nodes indulging in different levels of freeriding. Our proposed control system shows considerable gain over existing state of art algorithm. This improvement is achieved through PI action of controller. Since low reputation peers usually subvert reputation system by whitewashing. We propose and substantiate a technique modifying transfer function such that systems' sluggishness becomes adaptive in such a way that it encourage genuine new comers to enter network and discourages member peers to whitewash.
\end{abstract}













\section{Introduction}

\IEEEPARstart{I}n recent years, the popularity of the {P}{eer}-to-peer (P2P) system is on the rise, which is  evident from the traffic measurement records of ISP's \cite{eMule}\cite{Kazza}\cite{BitTorrent}. P2P systems follow decentralized network model, where individual users, also referred as peers perform the job of  both server as well as client. Peers share certain portion of their resources  viz. bandwidth, disk storage or processing power with other members. A P2P application combines the resources available across the network and thereafter peers can assist each other in terms of various services like file-sharing \cite{FileSharing}, content lookout \cite{content_search_1}\cite{content_search_2}\cite{content_search_3}\cite{content_search_4}, data storage in distributed manner \cite{DataStorage}, digital content delivery \cite{ContentDelivery}, grid computing \cite{GridComputing} and content transfer \cite{anonymous_transfer}. The term node and peer is used interchangeably in this paper.


The cooperative model of resource exchange in P2P network poses fundamental and challenging research issues. The potential of the P2P system, especially file sharing \cite{FileSharing} and grid computing \cite{GridComputing}, is dependent mainly on the amount of resources contributed by peers. Peers usually are reluctant in sharing resources because there are inherent costs attached with sharing viz. payment for the upload bandwidth. Therefore, natural tendency of peers is to free ride i.e. consume resources without making any contribution back to the network. In worst case, P2P network will fail if nobody shares any resource. Several studies done in past have shown the aforesaid free riding behavior of the member peers in a P2P systems.  Study performed on the Gnutella file sharing system in 2000 \cite{Adar} showed that as many as  of its users were free rider and their percentage further increased to 85\% \cite{Hughes} in year . Nearly half of the total file search responses in network came from 1\% of total nodes. This leads to congestion in these serving nodes thereby leading to the "tragedy of the commons" \cite{tragedyofcommon}. Hence "free riding" and "tragedy of commons" are the two important issues in implementing the cooperative model of information exchange and require immediate attention for increasing the efficiency of the P2P network.

Many solutions such as  micro payment based schemes \cite{karma} \cite{bitcoin}, game theoretic approaches  \cite{Feldman}\cite{MaKiGame}\cite{Huiye} and trust or reputation approaches \cite{TrustEstimation}\cite{Satsiou}\cite{Eigen_Trust}\cite{Peer_Trust}\cite{Power_Trust}\cite{Gossip_Trust} have been proposed in the past which provide incentive to the cooperating peers to solve the above mentioned problems, like. The monetary gain based schemes require   virtual banks or credible authorities for implementation. The mathematical modeling using the game theoretic approaches is  not accurate \cite{Satsiou} because of reliance on some unrealistic assumptions like every node is aware of the link capacity of every other node in the network. Trust or reputation based approaches being simpler and easy to implement are extensively used to encourage the cooperation among users to share their resources in the network. 

In reputation based systems, the incentive is in terms of the service differentiation provided to the requesting node on the basis of its past co-operative behavior. Co-operation level is quantified in terms of peers' reputation. Many resource distribution protocols such as resource bidding mechanism with incentive \cite{MaKiGame}, reputation based resource allocation \cite{Satsiou} and probabilistic resource allocation \cite{probabilistic_allocation} have been proposed in the past, which give preference in service  to the nodes with greater co-operation level. 

The resource allocation by a node based upon the requesters' reputation in the P2P system can be viewed as classical feedback control problem. The output of the control system is the download capacity that overall network offers to the peer. The output of control system follows a set point or reference. In our case, the reference corresponds to an utilization value, which is fixed and equal to .  signifies the optimal case for the peer where it can utilize whole of its download capacity with minimum upload contribution.This proposal is in accordance with tendency of rational peers  \cite{Meo} to adopt a strategy which provides them maximum benefit from the network at minimum cost. Therefore resource allocation at every peer can be implemented using the  control system which always leads to some resource contributes back to network, thereby curbing the peers' free riding tendency. The  is explained in detail in section \ref{SetPoint}. The difference between observed  and the reference is called error. It changes the upload bandwidth offered by the node which subsequently modifies the nodes' reputation, thereby changing the bandwidth offered ot it by the network. The change in the output is always directed such that it minimizes the error. This results in nodes sharing minimum upload capacity to get the required download capacity from the network. 

The proposed control system can also be used to solve the problem of whitewashing \cite{Feldman}\cite{gupta_whitewashing}, where users leave the current system and rejoin it with new identities to avoid low reputation penalties due to their uncooperative behavior in the past and exploit the incentives provided by network to the newcomers on joining the network. Providing no incentive to newcomers will discourage peers to whitewash, however it will also discourage genuine newcomers to join the network. Therefore incentive provided to newcomers is made adaptive, which decreases with increase in whitewashing level. As whitewashing level increases, the control system behaves more sluggish i.e. new entrants require more time to reach optimal state of resource sharing.  

The main purpose of studying the reputation systems  using the control theoretical approach is to use the already existing tools available in the literature in control systems for solving the problem of the free riding and whitewashing.  The main contribution of this paper are listed below 
\begin{enumerate}
	\item We demonstrate, how the whole P2P system can be approximated as linear time-varying model for the purpose of performance control. We also derive and describe in detail the various components of the overall control system viz.~controller,~actuator,~plant and monitor.
	\item  A resource allocation mechanism  is implemented using the control system.  At every node, control system automates the whole process of maintaining a minimum upload bandwidth for getting the requisite download bandwidth from the network.
	\item The transfer function of the proposed control system has been derived. The results obtained from it clearly show that classical control theory can address the problem of the free riding. 
	\item The overall network performance under varying degree of loading at the serving nodes has also been studied and simulation results clearly show that the proposed control system is able to handle these changes.
	\item The equivalent transfer function and the original network with the control system were simulated independently and the results were compared to validate the accuracy of the derived transfer function. The simulation results clearly verify that the transfer function closely models the network in steady state. Acceptable variations were observed during transient state which can be attributed to the linearizion \cite{Ogata} and other assumptions taken during derivation of transfer function. For details please refer to section \ref{The Controlled Software System Model}.
	\item It has been shown through simulation results sharing less than what is instructed by the control system are unable to utilize their complete download capacity. Therefore they they are at loss and consequently don't freeride.
	\item The resource allocation performance with control system  and then  with the existing resource allocation algorithm (R.A.) \cite{Satsiou} was compared. In simulation results it has been observed that the network with control system is able to achieve steady state faster and control system appreciably reduces the steady state error (i.e. difference between the actually shared and the optimal upload capacity). This happens due to the PI controller present in control system.
\item Finally, the proposed control system has been shown to considerably reduce the whitewashing in the network. First, we propose a method to determine whitewashing level. Afterwards depending upon the current whitewashing level, the transfer function updates itself which changes the speed at which a peer achieves the optimal level of resource sharing i.e. .
\end{enumerate}
Rest of the paper is organized as follows. The section \ref{Related_Work} summarizes and compares the related work, whereas the system model is described in section \ref{nwk_model}. In section \ref{Reputation_model}, reputation management system along with the resource allocation is discussed in detail. In section \ref{C_sys}, we model the overall P2P network as control system and derive its transfer function. The section \ref{Performance_Evaluation} presents performance evaluation of the proposed control system in achieving optimality and controlling free riding, simulation results to verify accuracy of transfer function and finally comparison with the existing (R.A.) \cite{Satsiou} allocation algorithm. Discussion about whitewashing problem and its solution using control system is provided in section \ref{Whitewashing}. Finally paper concludes with section \ref{conclusion}.



\section{Related Work}
\label{Related_Work}
Resource allocation strategies to prevent free riding have been proposed by many authors in the past. Satsiou and Tassiulas \cite{Satsiou} put forward Reputation based resource allocation (R.A.), which gives preference to the requesting nodes having higher reputation during the allocation. Higher reputation implies greater contribution level, therefore R.A. strategy motivates users to co-operate. In R.A. strategy requesting peers are sorted by the corresponding serving peer in the decreasing order of their reputation to demand ratio. The serving peer, first satisfies the request of the peer highest in the list, afterwards if the resources are left then it will be distributed to the next highest peer in the list and so on. A peer increases or decreases its capacity in fixed step sizes to manipulate its reputation based on the amount of the resource it wants from the overall network. The model in \cite{Satsiou} is limited to the single capacity link i.e. sum of the upload and download bandwidth will be constant and nodes will decide the partitioning of bandwidth between upload and download. 
Gupta \emph{et al.} proposed probabilistic resource allocation \cite{probabilistic_allocation} where nodes are selected probabilistically for resource allocation. Probability of the requesting node getting selected for the resource allocation increases with increase in its reputation. However the lower reputation nodes still have some finite probability of getting selected and therefore they don't get completely disconnected from the allocating node.
In both  R.A. \cite{Satsiou} and probabilistic resource allocation \cite{probabilistic_allocation},  the bandwidth is increased or decreased  in fixed step size therefore it is very difficult to achieve the convergence of the upload bandwidth. During the steady state upload bandwidth will keep on oscillating with amplitude of oscillation proportional to the step size. Transient response of the network can be improved if the step size is kept variable. Both the problems mentioned above are addressed and described in detail in section \ref{comparison_RA}.

Among the other related work \cite{Meo} Meo \emph{et al.}, contemplated network as market and proposed that second auction strategy leads to the optimality. However the study is limited to the homogeneous peers with the single capacity. Another serious limitation with this scheme is that the member node can perform only single upload and download at a given time. Ma \emph{et al.} \cite{MaKiGame} put forward a modified version of the progressive water filling algorithm, where requesting nodes are provided resources at the rates proportional to their reputation. Ma \emph{et al.} made an analogy of the resource allocation with filling a bucket, where base of the bucket is directly proportional to the reputation of the node. The author theoretically  proved that such kind of allocation maximizes the marginal utility. However author has not supported his hypothesis with simulation analysis. Yan \emph{et al.} \cite{Yan} presented a theoretical framework for the optimal resource allocation. Peers' ranking and the utility are the basis for the resource allocation such that resource distribution achieves max-min fairness. The theoretical analysis done in  \cite{MaKiGame}\cite{Yan} considers only stationary competing peers. Dynamics of competing peers like variation in the demand of requesters is absent in their study.

Various papers have suggested array of techniques in past to prevent free riding in P2P network. Direct reciprocity schemes like "tit for tat" \cite{tit_for_tat} employed in Bit Torrent file systems \cite{Cohen} encourage co-operative behavior among the member peers. In direct reciprocity schemes service provided by the node  to the node  will solely depend on service  has provided to  in the past, while completely ignoring 's contribution to the other users in the system. However such kind of schemes  are effective when members remain in the system for long time so that there are ample opportunities for reciprocation among them. In the current P2P networks where there is large population size, high churn rate \cite{Stutzbach} and infrequent repeat transactions, the reputation systems are more effective than the direct reciprocity schemes. Feldman \emph{et al.} \cite{Feldman} gave the concept of the generosity of a node, which is the ratio of the service provided to the service received by the node from the network. Based upon the estimated generosity, the node will be imparted service from the network. However no mathematical analysis was provided by Feldman \emph{et al.} for countering the problem of the free riding in the P2P network. In the same context Kung \emph{et al.} \cite{Kung} advocated that nodes' usage of the resources and contribution back to the network should be the basis of the selection of the nodes for the resource distribution. Nodes are expected to contribute above a certain threshold level to be eligible for the resource allocation. Banerjee \emph{et al.} \cite{Banerjee} proposed that serving peer will compute the expected utility function of the requesting nodes. The decision to share by the serving peer will be based upon this expected utility function. Gupta \emph{et al.} \cite{TrustEstimation} put forward a reputation based system that takes into account various uncertainties at the serving node to arrive at more accurate estimate of the reputation. It also carries out the exponential moving average of the present and past reputation values to provide appropriate weightage to the past behavior of the node. However solution proposed in \cite{Feldman}\cite{Kung}\cite{Banerjee}\cite{TrustEstimation} do not discuss about mechanism to distribute resources among the requesting nodes. 

Friedaman \emph{et al.} \cite{Friedman} pointed out that whitewashing takes place in P2P networks due to availability of the free identities or cheap pseudonyms. Many authors \cite{Castro}\cite{Izhak-Ratzin} in the past have suggested that whitewasher in a network can be completely removed by assigning permanent identities to its members. However John R. Doucher \cite{Sybil_Attack} asserted  that it is possible for members in decentralized network like P2P networks to have multiple identities. Therefore P2P network suffers from the problem of free riding. Yang \emph{et al.} \cite{Yang_Whitewashing} studied Maze file sharing system and came to conclusion that incentives encourage whitewashing. Friedaman \emph{et al.} \cite{Friedman} proved that considering every new comer as a potential whitewasher is always a better policy over any other static stranger policy for avoiding whitewashing. Grolimund \emph{et al.} \cite{Grolimund} proposed to assign low initial reputation to the new comers in the network for preventing free riding. However assigning low reputation to newcomers will discourage legitimate newcomers from joining the network. Therefore initial reputation needs to be adjusted periodically on the basis of level of whitewashing so that there are enough incentives which motivate new users to join the network and at the same time degree of whitewashing can be reduced.

A control system is proposed in this paper to avoid free riding for both stationary and dynamically competing peers. It employs PI controller \cite{Ogata} which reduces the steady state error of the P2P system and at same time helps the system to achieve steady state faster. On modifying the initial reputation (which is granted to the newcomer at the time of joining the network) on the basis of the level of whitewashing, the control system can successfully counter the problem of the whitewashing in the network.

\section{P2P Network Model}
\label{nwk_model}
We analyze a unstructured P2P network of N nodes, where nodes consume and share the bandwidth on demand. There is no centralized server and every peer acts as both client and server concurrently. Each peer in the network is connected to backbone network through an access link. In this way peers are connected to each other as shown in Fig. \ref{p2pnetwork}.
\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{p2pnetwork}
	\caption{The P2P Network Model}
	\label{p2pnetwork}
\end{figure}  

In this paper we study an overloaded network as considered in \cite{Satsiou}\cite{RationalMalicious} where at any given node, there are always requests pending to download data and content are present for downloading. Segmentation of content into chunks and their distribution across the network is out of scope for this paper.

The network is assumed to consist of symmetric links only i.e. for a link between two nodes  and , the feasible data rate and the bandwidth required to support it, is same  in both the directions. Download requirements at the node  are assumed greater than or equal to maximum download capacity of the node . This assumption is taken to model the worst case  of maximum overloading in the network. It is further assumed that the total upload bandwidth  available at the node  is sufficient, such that when it is bartered with other requesting nodes in the network, the download requirement at the node  will always be fulfilled. 

For the purpose of modeling, time is divided into discrete time slot. Each time slot signifies a period. We have considered unstructured P2P network for simulation but the proposed control system is applicable for structured P2P networks also. However we have not performed any simulations  to substantiate this claim. Every time slot is termed as a round. The nodes send the requests at the starting of the round and if they gets selected for the service allocation then their request are fulfilled by the serving nodes within the same round. For the next round the whole process is repeated again.  

\section{Reputation model}
\label{Reputation_model}
Any P2P network is meaningful only when nodes cooperate and fulfill each others' requirements. Network under consideration, contains selfish peers who are rational i.e they are interested in maximizing their own benefit without caring about the other members. Selfish nodes never want to contribute back to the network. Therefore they will always try to become a free rider, unless their is some incentive attached in sharing of their resources. This leads to the overloading at the few nodes which are contributing back to the network also known as \emph{tragedy of commons}. In the worst case, the network will collapse  when  every node becomes a free rider. For avoiding the problems of \emph{free riding} and \emph{tragedy of commons}, a reputation management system can be used in P2P network. Every node's reputation is evaluated at the end of the each round based upon its performance in that round. 	
\subsection{Reputation Calculation}
The trust is measure of the cooperative behaviour of the node. The trust model used in this paper is similar to the one proposed by Satsiou and Tassiulas \cite{Satsiou}. The trust calculated by the requesting node  for the serving node   during the  period is defined as the ratio of the bandwidth () received by the node  to what it has actually demanded () from the node   during the  period i.e.
 
For ease of reading, the important notations are listed in Table~\ref{rep_tab}.
\begin{table}[]
	\caption{Notations with their Description}
	\centering
	\begin{tabular}{ |c|c|}
		\hline
		\textbf{Notation}  &\textbf{Description} \\
		
		\hline
		 &Reputation of node   at the end of   time slot\\
		\hline
		 &Trust of  as measured by   for   time slot\\
		\hline
		 &Bandwidth received by  from  for  time slot\\
		\hline
		 &Bandwidth demanded  by  from   for  time slot\\
		\hline
		 &The maximum download capacity of the node   \\
		\hline
		 &No. of requests received by the node  in  slot \\ 
		\hline
		 &No. of requests generated by the node  in  slot \\ 
		\hline
		 &The minimum amount of bandwidth required to  \\
		& support feasible data rate practically possible on the  \\   
		& link between  and \\
		\hline
		 &The minimum value of the , among all the\\ 
		&   possible values of  and  in the network \\ 
		\hline
		 &Proportionality constant for handling change in \\
		& bandwidth received by  due to overloading at \\ 
		\hline
		   & Set of serving nodes for the node  during  period\\
		\hline
		   & Set of requesting nodes, requesting resources from \\
		
		&   node  during  period\\
		\hline
		 & Reputation threshold below which node does not \\
		& receive any service from network\\
		\hline
		         & Level of Whitewashing during  period\\
		\hline
		      & Total nodes in network during  period\\
		\hline
		 & Maximum initial reputation that can be assigned \\ 
		& to newcomers\\
		\hline 
		  &  Initial reputation assigned to newcomers during \\
		&  period\\  
		\hline
	\end{tabular}
	\label{rep_tab}
\end{table}       
Reputation of the node  for the  time slot is calculated using the exponential moving average \cite{EMA} of reputation up to the  period with the average of trust values for the current time period as give below

In the above equation  is the reputation of the node  at the end of the  period and  is the set of nodes which have requested the node  for resources during  period. The cardinality of the set  i.e () is equal to . Here  is the number of the requests received by the node  during the  period. Using reputation aggregation algorithm \cite{Gossip_Trust}\cite{DifferentialGossip},  reputation tables are updated periodically by every node so as to maintain identical reputation tables across the network.  determines how the exponential average forgets the contribution of the past values and maintains its value in between . Higher  discounts the older observations faster and  completely ignores the  older values. We take value of  as  in the equation (\ref{reput_g}) so that equal\footnote{In this way nodes are discouraged to abruptly change their behavior during one time period so as to gain advantage in the reputation for the future transactions. The nodes need to be co-operative over a period of time for getting better quality of services than the existing services.} priority is given to the present as well as past reputation values.Therefore the reputation of the node  in this paper is calculated as

The reputation of a node is the measure of its cooperative behavior. The service or bandwidth allocated to a node in a network increases with the reputation of the node and vice versa. Therefore for acquiring more download capacity from the network, the node has to share more bandwidth towards the network. 
\subsection{Reputation Based Resource Distribution }
\label{allocation}
The resources are distributed among the requesting nodes using weighted water filling algorithm \cite{MaKiGame}. In our proposed model, the reputation of the node is used as its weight during the resource assignment. The source node  distributes the resources among the requesting nodes at the same time but with rates equal to the their reputation.  If reputation of a requesting node is below a certain threshold say  then it will not be allocated any resource. This is done to discourage malicious behavior of nodes. During the resource allocation, a requesting node  will be taken out of allocation process if either resources at the source gets exhausted or assigned resources to  become equal to what  had demanded for the current round. Let  be the M requesting nodes sorted in non-decreasing order of their .   and  are the reputation and bandwidth requested by the node . The bandwidth allocation is done in the order as per the sorted list. Let  denote the bandwidth allocated to node . It is given as
 
Here  is the total upload bandwidth of the serving node. Suppose  is the bandwidth demand of the requesting nodes in  from the source with upload capacity of . Let the reputations of the requesting nodes be  , then the bandwidth allocated in  using weighted water filling algorithm is given by . 

The bandwidth allocated to any requesting node  from  during the  time period is proportional to its reputation  in the  previous period\footnote{The reputation of the requesting node during current round will be evaluated at the end of time period and will be used as weight in the next round.}, bandwidth demanded  from  and a proportionality constant  which caters for change in received bandwidth due to overloading at .
Therefore bandwidth received by  from  during  period is given

The value of  lies in between .  denotes the worst case of overloading at serving node , where the receiving node  will not receive any bandwidth. When  then the bandwidth requirement of node  will be completely satisfied by the node . The value of proportionality constant  varies in each round depending upon the degree of the overloading at the serving node. At the same time for another requester say , requesting the same serving node, the value of  will vary depending upon its reputations. 


The total bandwidth received by the node  during  period is given by

where  is the set of the nodes from which node  has demanded resources during the  round. We assume reputation aggregation so that  estimated is same for all the nodes.
\section{P2P network modeling as Control System}
\label{C_sys}
The objective of the control system is to enable each peer to maintain the minimum upload so as to maintain the just enough  reputation, to get the desired download capacity. The control theoretic modeling can improve the performance of the reputation management system as a peer can adapt and derive maximum utility from the network. The design of a control system  involves determining the equivalent components i.e. controller, actuator, plant and monitoring unit. A mathematical model has been developed for this purpose. Finally the overall performance of the devised control system model need to be evaluated to determine the amount of the improvement achieved. The additional overhead incurred in this process also needs to be carefully analyzed. The following subsections discusses the set point determination and  various other components which constitute this control system. 

\subsection{Determination of the Set Point}
\label{SetPoint}
The proportion of the  requesting peer  demand which is fulfilled by the network in the  round in comparison to its download bandwidth is given by 

Here   is the total data rate agreed by all the serving peers to be given to the requesting node   and   is the maximum download capacity of the requesting node  from the nodes in the network .The serving peers will never give wrong information about the  because their reputation is calculated on the basis of actual data rate delivered and not the data rate they are willing to provide i.e. . We assume that all the peers are rational, therefore there are no malicious peer. When a peer is assumed  rational then it will  not act maliciously \cite{RationalMalicious}, as rational peers gain nothing by harming other peers. Therefore a node will not receive incorrect .

When the requesting node  increases its upload capacity then its reputation increases consequently making  eligible for more download capacity  from the network. Hence  of the requesting node increases. Three cases may arise in the equation (\ref{satisfaction}). When  then satisfaction derived by the peer  from the network increases with increase in . The satisfaction attains its maximum values at  i.e. . After , higher value of  will actually not be useful to the node because it exceeds the maximum data rate the requesting node can handle.  Node is at loss when  because it has to pay more in terms of the greater upload capacity for the download rate limited by . Therefore to derive the maximum benefit from the network, a node should maintain , while keeping the upload rate to minimum, so that it can full-fill all of its download requirement at the minimum cost.

Hence the set point or reference point for our control system is . The feedback monitor in the loop will estimate function ; this value will be compared with the reference point () and the error is fed to the controller. It is assumed in the system model proposed in section \ref{p2pnetwork}, that every node  has adequate upload capacity, such that when it is bartered with other requesting nodes in the network, then download requirement of  node  will always be satisfied. In other words upload capacity available  at node  is adequate enough to make the  at the node  equal to the  of the control system.

The  discussed above is different from the concept of utility  \cite{Shenker}. The utility corresponds to the degree of the satisfaction received by the node from the network whereas  is dependent upon the total resources that are available to the node from the network. Some time the nodes' capacity may not be sufficient to utilize all the resources. Therefore these extra resources which are considered in  are useless for the node and don't contribute in overall satisfaction and consequently in the utility derived by the node. 
\subsection{The Controller}
The controller \cite{Ogata} stabilizes the system output to a particular value called set point. It compares the difference between the desired and the actual  in the proposed control system. Based upon this comparison, the controller drives the actuator to regulate the output. Generally PID controller is preferred as a controller in control system. However when the P2P network reaches the steady state, nodes generally share in proportion to their requirement so as to preserve their reputation. Therefore total shared capacity in network does not change abruptly and consequently so does . The differential action is used to counter sudden changes in output thus it is not required in our system. Therefore the PI controller with transfer function  \cite{Ogata} is used  in this paper to model the control system.  and  are  the proportional and integral gain respectively  of the PI controller.
\subsection{The Actuator}
\label{act}
The role of the actuator \cite{Ogata} in the control loop is to update physical entity based upon the controller output. In our case, the actuator modifies the upload capacity of node in response to the controller output . If  is the input to the actuator then  is the the upload capacity shared by the node in the next round. The change in the upload capacity by the actuator modifies the reputation of the node, thereby adjusting the download data rate, the node receives from the network.  is taken in accordance with the existing allocation algorithms \cite{Satsiou}\cite{probabilistic_allocation} for ease of comparison with them.



\subsection{The Monitor}
The function of the monitor at the node  is to sense the current data rate  offered to the node , for evaluating the . The evaluated  is compared with the set point to calculate the error and drive the controller which in turn decides how much resources are shared by the node  to the other nodes. Let  corresponds to amount of resources allocated by the node  to the requesting node  during   round. The trust calculated by the requesting node  for the serving node  in the  round is given by

Using equation (\ref{reput}) the reputation of the node after the  period is given by 

The symbols have been defined along with the equation (\ref{reput}). The total bandwidth received by the node   during  time period  is calculated using equation (\ref{capacity}) as 

Putting the value of  from equation (\ref{Rep}) into the above equation we get

The  serving peers  allocate resources in proportion to the demands of the requesting peers.The requesting peers may receive much less bandwidth then what they had requested because of the overloading at the serving peer. In order to optimize for themselves, the requesting peers will demands more than their actual capacity. Normally the requesting peer should be requesting whatever is its download capacity. To overcome the problem of nodes demanding more than their actual capacity, the serving peers can estimate the feasible capacity of the links to the requesting peers and use it instead of what is demanded if the demand is more than the feasible capacity. Feasible capacity is the minimum amount of the bandwidth required to support the feasible service rate across the link. Feasible service rate is the maximum achievable throughput via underlying path in the network with packet loss probability
. It can be estimated for the TCP Reno algorithm \cite{feasible_rate} as

Here  is the feasible service rate which is the function of the packet loss probability ,  is the maximum transmit window that the receiver indicates to the sender and RTT the round trip time between the two nodes.  is the retransmission time out in seconds and  is the number of packets acknowledged by each acknowledgment message.  

The serving peer will never give more than feasible bandwidth as it knows  that remaining bandwidth will be wasted.  Hence the equation (\ref{C_i}) becomes 

Here  is the maximum download capacity of the node  and  is the minimum amount of the bandwidth required to support the feasible data rate, as derived from the equation (\ref{feasible_rate}), on the link between node  and . We assume symmetric links in the system model in the  section \ref{nwk_model}. Therefore  i.e feasible data rate while transferring data from node  to  is same as that from  to .

Using equation (\ref{satisfaction}), the measured variable  corresponding to the node  for the  time period is given by

\subsection{The Controlled Software System Model}
\label{The Controlled Software System Model}
\begin{figure}
	\centering
	\includegraphics[scale=0.45]{controller.eps}
	\caption{The Block Diagram of Control System at the Peer}
\label{control block}
\end{figure}  
Fig. \ref{control block} shows the block diagram of the control system which measures the data rate received by the node and maintains it at the desired level by regulating the upload bandwidth of the node. Let  denotes the controlled software system (which includes actuator and P2P network) as shown in Fig. \ref{Transfer_Function}. For simplicity we neglect the process dynamics\footnote{Process dynamics play significant part during transient phase of the system. We assume network has reached steady state and its behaviour is virtually constant with time} and consequently  is equal to static gain . On linearizing \footnote{If any non linear system involves small signals and operates around the equilibrium point then it can be approximated as linear system within a limited range of the operation.}, the gain  \cite{Ogata} around the reference point , we obtain gain as the  derivative of the output () with respect to the input  as shown in the Fig. \ref{control block}. Using equation (\ref{utility_1}), the static gain of the requesting node  is given by 

The maximum gain\footnote{The system is designed for the maximum gain. If system is stable for the maximum gain then it will also be stable for the lesser.}  occurs when  i.e. node  receives only one request during given time slot and  . Where  is the minimum value of the , among all the possible values of  and , i.e. 


Another factor  as discussed in section \ref{allocation} attains its maximum value when reputation of node is minimum.  is the minimum value of the reputation at which a node is eligible for resource allocation in the P2P network .
Therefore the maximum possible value of ) such that node can receive data from network is .  Hence the equation (\ref{S_gain}) reduces to

, represents the cardinality of the set  and is equal to , the number of the nodes from which resources have been requested by the node  during  time slot. As peers are rational so to maximize their chances of getting content from the network they will try to generate maximum amount of data requests hence  . Therefore equation (\ref{max_gain}) becomes


The maximum static gain  on differentiation is given as

Change in upload capacity induced by actuator is observed in the next period. This results in  dead time (delay) of one period .  Therefore the overall transfer function of the controlled system is given by

The equation (\ref{Sgain}) does not contain any term related to the node  so it is a generic expression applicable to any of the receiving node. Thus, the transfer function of the controlled software system is given by

\begin{figure}
	\centering
	\includegraphics[scale=0.5]{transfer_function.eps}
	\caption{The control loop }
	\label{Transfer_Function}
\end{figure}  

The overall transfer function of the control loop as shown in Fig. \ref{Transfer_Function} is given by 
 
\subsubsection{Deriving Model Parameters} 
When the frequency of the operation is the natural frequency of oscillation, then the transfer function\footnote{We substitute  in the overall transfer function of the control loop } of the control loop given by equation (\ref{T(s)}) becomes

The gain margin  specifies the stability of the control system and is set by the designer. Therefore using equation (\ref{Ngain}), the gain and the phase equations for closed loop at natural frequency becomes

and

In industrial PI controller it is common practice to tune the controller phase i.e  to  \cite{Pcontrol}\cite{cntrol}, hence taking

The parameter  and  are set by the designer and  is calculated using equation (\ref{Sgain}). Using equation (\ref{S3}) in (\ref{S2}) we get the value of  as
 
The parameter  of controller is calculated by substituting above computed value of  in equation (\ref{S3}). The simple algebraic manipulations gives

The above computed values of  and  are used in equation (\ref{S1}) for obtaining the expression for  as

\begin{table}[]
	\caption{Simulation Parameters along with their Values}
	\centering
	\begin{tabular}{ |c|c|c|}
		\hline
		\textbf{Parameter}  &\textbf{Description} &\textbf{Value} \\
		\hline
		&Number of the nodes in   & \\ 
		    &network  during  period & \\ 
		\hline
		   &Proportional Gain     & \\
		\hline
		   &Integral Gain     & \\
		\hline
		   &Gain Margin     & \\
		\hline
		&Maximum number of  requests   & \\
		 &generated by the node in     & \\
		& a given time period     & \\
		\hline
		   &Exponential moving     & \\
		&average constant & \\
		\hline
		& Maximum initial reputation that can  &0.01\\ 
		               & be assigned to newcomers &  \\
		\hline 
		&  Initial reputation assigned to   &\\
		& newcomers during  period, except  &0.01  \\  
		       &  during  whitewashing scenario , &\\
		&   where its value is calculated   & \\
		& using  equation (\ref{whitewash}) &\\
		
		\hline
		& Reputation threshold below which &\\
		& node does not receive any service  &\\
		    & from network, except for  &0.01\\
		&  whitewashing scenario  simulation,  &\\
		&  where its value is equal to   &\\
		\hline
		   &Step Size     &Mbps \\
		\hline
		&  The minimum amount of bandwidth    & \\
		& required to support feasible data rate  & \\   
		              & practically possible on the link&2Mbps\\
		&  between nodes  and  &\\
		\hline
	\end{tabular}
	\label{sim_tab}
\end{table}       
\section{Performance Evaluation}
\label{Performance_Evaluation}
The current section examines the performance of proposed control framework through simulations.The various simulation parameters along with their values are listed under table \ref{sim_tab}. The values of parameters , , and  are evaluated from the equations given in this paper and parameter  values is taken from \cite{cntrol} and the remaining parameters value are taken from \cite{Satsiou} for the ease of comparison. During simulation time is taken as discrete and each discrete time slot signifies a period. The network gets initialized  at . Before  the  of every node present in network is . The simulation analysis of the transfer function, actual P2P network and the RA \cite{Satsiou} an existing state of art algorithm has been undertaken in this section.
\subsection{Study of Control System Performance}
Fig. \ref{Control_Performance} demonstrate how the control system is able to assist a node  in the P2P network in attaining a stable value of the utilization  around the reference point i.e . Initially the utilization of a node will be  as it has not shared anything, afterwards it changes and  stabilizes around . To achieve the target utilization (i.e ) the node adjusts its upload bandwidth, which causes the change in the reputation of the node further leading to the change in the download bandwidth received by the node. The experimental results show that above discussed adjustments pushes the utilization of the node to the target utilization.
\begin{figure}[!t]
	\centering
	\includegraphics[scale=0.45]{Control_Response.eps}
	\caption{Control System performance in a P2P network}
	\label{Control_Performance}
\end{figure}  



When P2P network enters steady almost every user has settled down in terms of demand, therefore requirement of the user doesn't change abruptly. Consequently download capacity received by a node for a given amount of shared upload capacity remains almost constant. This fact is also demonstrated by the simulation results in Fig. \ref{Control_Performance} where  remains around  during steady state operation. For checking the performance of proposed control system during worse case scenario we artificially induce high level of loading in the network during steady state. Loading at serving node is determined by number of requests coming to a serving node. Overloading implies that amount of bandwidth demanded from the serving node is more than the what it has shared. Due to variation in loading the total download capacity promised by the serving node changes with time. The amount of bandwidth received by a node is directly proportional to the download capacity promised by the serving node. Therefore increase in the level of loading at the server results in the receiving node getting promise of lesser bandwidth and consequently smaller resources for the same level of the reputation.
Simulation results in Fig. \ref{ServiceRate} clearly demonstrate that fluctuations in the level of loading at the serving node is successfully handled by the proposed control system model. \begin{figure}[!t]
	\begin{center}
		\includegraphics[scale=0.45]{noise_output.eps}
		\caption{System performance under artificially induced loading in P2P network}
		\label{ServiceRate}
	\end{center}
\end{figure}
\subsection{Veracity evaluation of the Transfer Function}
\label{TF}

To verify and show that the derived transfer function in section \ref{The Controlled Software System Model} closely models the proposed P2P network, we simulate the various components of the control system i.e. controller, actuator, plant and monitor. Thereafter results obtained for both the systems discussed above are compared and presented in Fig. \ref{transfer_function}. 
\begin{figure}[!t]
	\begin{center}
		\includegraphics[scale=0.43]{Transfer_VS_Actual}
		\caption{Transfer Function comparison with actual network }
		\label{transfer_function}
	\end{center}
\end{figure}

While deriving transfer function in section \ref{The Controlled Software System Model}, we assumed that system has already attained steady state. Therefore the steady state response is same for the both, whereas there is slight variation in the transient response. We had considered worst case during the derivation of transfer function i.e. maximum overloading at the serving node. This results in a sluggish transient response of the transfer function compared to the actual system.

These small deviations in the systems' transient response obtained by the transfer function, from the actual system's response can be tolerated because almost all  P2P systems most of the time operate in steady state. At the same time, without linearizion \cite{Ogata} (i.e assuming system operation in steady state), actual system analysis becomes very complex due to consideration of non-linearities. For considering non-reality, we need detailed information about the network parameters such as link capacities. Consequently it will be very difficult to obtain a generalized control system model for the P2P network.  

\section{Whitewashing}
\label{Whitewashing}
Whitewashing in a network can be reduced by providing low initial reputation \cite{Grolimund} to the newcomers. However this will also discourage newcomers from joining the network.  To make P2P system lucrative for newcomers, we need to increase initial reputation at the cost of higher level of whitewashing. The contradictory requirement for both high level of initial reputation for newcomers and low level for controlling whitewashing can be taken care of by making initial reputation adaptive i.e. it gets modified on the basis of the level of whitewashing in the network. When level of the whitewashing in the network is very high, we can decrease the initial reputation to counter whitewashing. If level of whitewashing is low than initial reputation to newcomers can be increased so as to motivate new comers for joining the network. 

The level of whitewashing in the network is calculated by observing the departing nodes. There are two types of departing nodes in the network. One who have reputation greater than or equal to the initial reputation provided to the newcomers in the network. These nodes will definitely not whitewash because they do not gain any advantage by whitewashing. The remaining departing nodes whose reputation is less than the initial reputation provided to new comers are the prospective whitewashers. We define level of whitewashing  during  period as the number of departing nodes in that period which can be possible whitewashers (i.e. have their current reputation less than the initial reputation). 
The initial reputation during the  period, on the basis of level of whitewashing can be calculated as follows

where  are the number of nodes during  period. The value of  is taken as  based on earlier work \cite{Satsiou} on whitewashing.

To discourage nodes from leaving the network, the threshold below which node becomes ineligible for service i.e.  is made equal to the initial reputation of the joining node ().  The reputation threshold is calculated at the beginning of every period. The change in  modifies the gain  of the controller as shown by equation (\ref{Sgain}). The node if disregard the formulae and parameter value, then can choose different  value, though it may not be optimal for it. From the Fig. \ref{whitewashing}, it is evident that as the initial reputation awarded to the node is made smaller, the system becomes more sluggish while discouraging the nodes to leave the network. Sluggishness signifies delay incurred by a node in reaching the optimal level of the resource sharing. More sluggish the system is, greater the time for which the newcomer nodes'  remain less than . If , then the node will be at loss, because it will be getting  lesser resources from the network than what it can actually consume. However if white washing level is lower in the network than the value of the initial reputation awarded can be increased so that system becomes faster and genuine new nodes entering the system are not unnecessarily penalized. 
\begin{figure}[!t]
	\begin{center}
		\includegraphics[scale=0.45]{churn2.eps}
		\caption{System performance for different level of whitewashing }
		\label{whitewashing}
	\end{center}
\end{figure}  













\section{Conclusions}
\label{conclusion}
In this paper, we have used the control theory to solve the problem of freeriding and whitewashing in the P2P networks. We have derived the transfer function of a P2P network which provides a more structured and efficient approach to analyse the P2P networks through use of already existing tools in the control theory. We were able to automate the whole resource allocation process using the control system. We have also demonstrated through simulation that the proposed system is able to help the nodes in sharing optimal level of resources even in the case of high degree of overload in the network. The nodes sharing less than what control system recommends are at loss because they are not able to utilize their total download capacity which discourages the nodes to freeride. Further, we have used PI controller which improves the overall allocation process. The proportional action helps a node in reaching optimal value of resource sharing faster, whereas integral action reduces the steady state error. These improvements are clearly visible when compared with the already existing RA \cite{Satsiou} algorithm. Finally, through the simulations, it has been demonstrated that proposed system can also be used to control whitewashing.











\ifCLASSOPTIONcaptionsoff
  \newpage
\fi





\bibliographystyle{IEEEtran}
\bibliography{ref}











\end{document}
