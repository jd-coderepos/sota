ISPs typically pay a number of different costs for traffic entering
and leaving their network their network.  These may include fixed 
costs such as provisioning a link of fixed capacity on their 
internal network, or to an Internet eXchange Point (IXP) and 
variable costs, for example a transit
link which is charged according to the volume of traffic used.
Of particular importance is the 95th percentile pricing scheme,
described in section \ref{sec:percentile}.  The nature of
the 95th percentile pricing scheme makes it difficult to
deal with analytically (as will be explained in the next section).  
In previous work \cite{stanojevic2010heavy} 
the Shapley value has been used to estimate the price of a particular
time and link.  

Through this section the words ``price" and ``cost" will be used with
very specific meanings.  The cost of a traffic pattern is an outcome of
the shape of the traffic and the pricing scheme imposed -- it is the
monetary value which would actually be paid for that traffic using
that scheme.  The price
will be used in this section to mean a notional marker for a given
traffic slot which indicates the likely cost impact of assigning traffic
to that slot.  This price is used as an internal mechanism to work out
which traffic slots should be avoided.  If small amounts of traffic are
moved from a high price slot to a low price slot then it would be
expected that the cost would drop.  

The following properties are useful for the price  
chosen:
\begin{enumerate}
\item The price can be quickly calculated.
\item An increase of traffic in a slot never causes the price of
that slot to fall (monotonic with traffic).
\item The price is differentiable with respect to traffic.
\end{enumerate}
The first condition is for practicality.  The second condition simply
says adding traffic never makes the price go down.
The second and third conditions are used in the stability proof in section 
\ref{sec:dynamics}.

In this paper the Shapley
gradient is introduced to solve this problem.  
This can be considered to answer the question
``what is the likely increase in cost which would be caused by adding
traffic to this link?" in a robust way which can account for a wide
variety of pricing schemes
including, naturally, the 95th percentile.

\subsection{95th percentile pricing in brief}
\label{sec:percentile}

For transit traffic, ISPs are commonly charged for
the 95th percentile of their traffic.  This works as follows.
For each TPG
the 95th percentile cost is set to some fixed value
e.g. $r$ dollars per GBps (note that this is a rate not an
absolute value). For the charging
period $T$ (a typical
value is a month)
the traffic is divided into smaller  
time windows of length $t$ (often 5 minutes is used).
For each window $i$ the average traffic rate $f_i$ is calculated 
(it is the total traffic in that window divided by $t$ the window
length).
Define $f^{(95)}$ to
be the traffic rate $f_i$ such that only $5\%$ of the 
$f_i$ are larger than $f^{(95)}$.
The price charged for the period $T$ is then simply $r f^{(95)}$.
It is usual that inbound and outbound traffic are tracked
separately, and only the largest charged (see \cite{dimitr2009perc}).
For eyeball ISPs this will almost always be the inbound traffic as this
is larger in volume than the outbound traffic.
The 95th percentile pricing provides a particular challenge for any scheme 
which aims to reassign traffic.  In particular the question ``how
does adding traffic to this slot affect the amount paid?" becomes
problematic.  Adding or taking away a small amount of traffic to any
slot has no affect on the cost unless that slot is one with 
traffic level $f^{(95)}$ for that TPG.  A more subtle analysis is
required and this is provided by building on the Shapley value as
studied in \cite{stanojevic2010heavy}.  

\subsection{Calculating prices using the Shapley gradient}
\label{sec:shapleygradient}

Consider the traffic in a single TPG with a known pricing scheme and
with $N$ users.
Let
$v(\mS)$ be the total cost which would be paid using
this scheme for the traffic 
generated by a some set of users $\mS$.  Define $\mN$ as the
set of all $N$ users.
The Shapley value is a concept from game theory which assesses the
contribution of a user's strategy to an overall cost/benefit.  The
Shapley value 
(see \cite{stanojevic2010heavy}) of
the $i$th user is defined as 
\begin{equation}
\phi_i = \frac{1}{N!} \sum_{\pi \in \mS_{\mN}} [v(\mS(\pi,i)) - 
v(\mS(\pi,i) \backslash i)] \mbox{,}
\label{eqn:shapley}
\end{equation}
where $\mS_{\mN}$ is the set of all $N!$ possible permutations of $\mN$,
$\pi$ is one such permutation, and $\mS(\pi,i)$ is the set of users who 
arrive not later than $i$ in the permutation $\pi$. 
Intuitively, \eqref{eqn:shapley} can be interpreted as randomising the order of users,
estimating the cost incurred by each user $i$ and averaging this cost over all possible 
user orderings. 
In \cite{stanojevic2010heavy} the Shapley value of a user's traffic
is used to assign a cost to each hour of the day which reflects the possibility
of traffic in that slot contributing to an increased price.
The full calculation of the Shapley
value \eqref{eqn:shapley} requires considering $N!$ combinations
of user traffic to analyse traffic from $N$ users but
\cite{stanojevic2010heavy} shows that a relatively 
small sampling gives
an efficient, unbiased estimator (in their work 1,000 orderings produced
a low error estimate) and this sampling technique is used here.

In \cite{stanojevic2010heavy} this value (that differs for every user)
is combined with a least squares fit to get an average cost to assign
to each hour.  However, this procedure is computationally intensive 
(calculating the Shapley value for every user and then doing a least
squares fit) and does not produce a cost which can be compared 
to other pricing schemes.
What is required is some measure of the cost of adding a small amount
of traffic on a given TPG at a given time.  This is achieved by
considering the gradient of the Shapley value.

Define the \emph{Shapley gradient} as the rate of
increase in cost when a fictitious user $N + 1$
injects an additional small amount of traffic $du$ in slot $j$.  
The Shapley gradient is therefore,  
\begin{align}
\nonumber G_j  &=  
\frac{1}{du\,(N+1)!} \\ 
& \sum_{\pi \in \mS_{\mN'}} [v(\mS(\pi,N+1)) - 
v(\mS(\pi,N+1) \backslash N+1) ],
\label{eqn:Gjgeneral}
\end{align}
where 
$\mS_{\mN'}$ is the set of arrangements of the
users $\mN$ plus the fictitious $(N+1)$th user and 
$\mS(\pi,N+1)$ is the set of all users arriving
not later than user $N+1$ in the permutation $\pi$.

Define the Shapley gradient for an individual user $i$ and
slot $j$ as 
$\phi'_{ij}= (\phi_i(d_{ij}) - \phi_i) / du$ where
$\phi_i(d_{ij})$ is the Shapley value for user $i$ with
extra traffic $du$ in slot $j$. For the traffic schemes considered
here this can be shown to be approximately
the mean of $\phi'_{ij}$ over all users $i$ with 
the error term O(1/N).  In
all but the 95th percentile case $\phi'_{ij} = G_j$ for all
$i$.  Details are given in appendix \ref{sec:shap_indep}.

\subsection{Costs for various pricing schemes}


In this section the Shapley gradient is calculated for various
pricing schemes.  The Shapley gradient is a quite general
concept and works for any scheme where the Shapley value
is differentiable.  This condition amounts to saying that the
pricing scheme is such that there is no step change with
induced traffic.  This would not be the case with, for example,
a scheme which charged a fixed rate up to a given amount of
traffic and then a higher rate above that amount.
In the section \ref{sec:dynamics} it will also be useful
that schemes are differnentiable with respect to added traffic.

\subsubsection{Shapley gradient for linear pricing}
\label{sec:linear_price}

For traffic in a slot $j$ charged with 
linear pricing at rate $r_j$ then 
\eqref{eqn:Gjgeneral} reduces to simply $G_j = r_j$ as
would be expected.  
The equation becomes 
$G_j = \frac{1}{du \, (N+1)!} 
\sum_{\pi \in \mS_{\mN'}}  r_j du$
since the cost of adding $du$ traffic to a slot $j$ which
is priced linearly at $r_j$ is $r_j \, du$ and hence
$v(\mS(\pi,N+1)) - 
v(\mS(\pi,N+1) \backslash N+1) = r_j \, du$.
Since there are
$(N+1)!$ members of $\mS_{\mN}$ the equation reduces
to $G_j = r_j$.  

\subsubsection{Shapley gradient for 95th percentile pricing}
\label{sec:shap95}

Let $\mT^{(95)}(\mS'(\pi))$ be the set of all
time periods which have a value equal to the 95th percentile value
of the traffic up to and including user $N+1$ in arrangement $\pi$.
Let $I(X)$ be an indicator variable -- that is a variable which takes
the value $1$ if X is true and $0$ if X is false.
Consider a slot $j$ charged at
95th percentile at rate $r_j$.  
For some arrangement of traffic $\mS(\pi,N+1)$ then there are two
possibilities.  If, for the traffic profile $\mS(\pi,N+1)$, then 
the flow in slot $j$ is equal to $f^{(95)}$ then adding $du$ to
slot $j$ increased the cost by $r_j \, du$.  In all other cases
then adding $du$ did not increase the cost.  Therefore,
$v(\mS(\pi,N+1)) - 
v(\mS(\pi,N+1) \backslash N+1) = I (j \in \mT^{(95)}(\mS(\pi)) r_j \, du$.
Intuitively this says that adding traffic $du$ to slot $j$ in
an arrangement of traffic increases the 95th percentile 
cost excactly when the traffic has been added to the 95th percentile
slot and at no other times.
Hence,  
\eqref{eqn:Gjgeneral} can be rewritten as
$$
G_j = \frac{1}{du\, (N+1)!}  
\sum_{\pi \in \mS_{\mN'}} [I (j \in \mT^{(95)}(\mS'(\pi)) r_j \, du ].
$$ 
This then gives
\begin{equation}
G_j = \frac{r_j}{ (N+1)!} \sum_{\pi \in \mS_{\mN'}} 
[I (j \in \mT^{(95)}(\mS'(\pi))) ].
\label{eqn:Gj}
\end{equation}
As in \cite{stanojevic2010heavy}, only a small sample
of all combinations in $\mS_{\mN'}$ need be calculated and
this can be computed efficiently see \cite{stanojevic2010heavy}
and \cite{lakhina_cost_2012} for further information on the
performance of the estimation.

The expression \eqref{eqn:Gj} has the following properties useful to construct the 
slot prices $p_j$.
\begin{itemize}
\item When summed over all time windows associated with a TPG, 
the result is the 95th percentile price actually paid for that TPG
with that traffic.
\item It reflects the likelihood of adding traffic in a given time
slot increasing the 95th percentile cost.
\item Off-peak slots have near zero $G_j$.
\end{itemize}

\subsubsection{A useful approximation for 95th percentile pricing}

A problem remains with the 95th percentile $G_j$ as defined in \eqref{eqn:Gj}.  
Moving traffic to a very busy period is just as valid a strategy for 
cost reduction as moving it to a quiet period.  
This follows because shifting traffic from busy time periods to quiet
ones will lead to a lower 95th percentile, and hence, to a reduction in costs.  
However, shifting traffic to the busiest time periods, so that it 
falls in the top 5\%, could also reduce costs.
In practice such a policy would impact end-to-end performance adversely.
The price function is therefore modified by changing $\mT^{(95)}$ 
in \eqref{eqn:Gj} to $\mT^{(>95)}$, the set of slots with a traffic 
level equal to or greater than the 95th percentile level and 
normalisting by the size of this set.
$$
G_j = \frac{r_j}{ (N+1)!} \sum_{\pi \in \mS_{\mN'}} 
\left[\frac{I (j \in \mT^{(>95)}(\mS'(\pi)))}
{|\mT^{(>95)}|}
\right].
$$

  
This alteration has the added benefit of making the slot price $p_j$ 
monotone as a function of the traffic in that slot.  The results
for TARDIS use this as the price function but use the unmodified 
95th percentile as the cost function.  This has the benefit of not
inducing unrealistic traffic profiles although it means that cost
reduction is not sought as aggressively as it might be.

It will later be a useful property that the price
of a slot is monotonically non decreasing but also that it is continuously 
differentiable.  This can be achieved by constructing the following
approximation 
\begin{equation}
G'_j = \frac{r_j}{ (N+1)!} \sum_{\pi \in \mS_{\mN'}}
\frac{A(j,\pi)}{\sum_{k} A(k,\pi)},
\label{eqn:Gjdash}
\end{equation}
where the $k$ sum is over all time windows and
$A(j,\pi) = 1$
if $t(j,\pi) > f^{(95)}(\pi)$ and
$\exp[(-(t(j,\pi)- f^{(95)}(\pi))^2/\sigma^2]$ otherwise.
Here $t(j,\pi)$ is the traffic level in slot $j$ counting traffic up to the $N+1$th user in arrangement $\pi$ and $f^{(95)}(\pi)$ is the 95th percentile level for the traffic up to this user.
The parameter $\sigma \geq 0$ is akin to variance.  This effectively fits a Gaussian shape to the price for traffic below the 95th percentile level.  The fall off is controlled by $\sigma$ and as $\sigma \rightarrow 0$ the approximation 
to the previous formula becomes exact. 

\subsubsection{Shapley gradient for fixed pricing with a maximum bandwidth}
\label{sec:fixed_price}

A common cost model on links is to pay a fixed cost for bandwidth
up to a given cap.  This could occur, for example, if the ISP pays
for a link to an IXP with a given rate.  Another situation where this
would occur is an internal link within the ISP which has fixed capacity
and must not be overloaded.  As the fixed cost is already paid, the
price for putting traffic on the link is zero as long as the traffic
remains below the cap.

A naive approach to this cost system presents a problem for the
TARDIS system as the cost would be zero up to the capacity
then an infinite cost at that capacity when
the link fails (more realistically, the cost would approach
infinity, link failure, as the link approaches its maximum utilisation). 
Fortunately, a number of 
pricing schemes are possible which allow modelling an approximation
to this cost function.  The following scheme is inspired by the
well-known result from queueing theory that the mean queue length
for an M/M/1 queue with utilisation $\rho \in (0,1)$ is given by
$\E{N} = \rho/(1-\rho)$.

Let $m$ be the maximum traffic rate allowed on a link and 
$\alpha \in (0,1)$ be some
proportion of that rate which can always be tolerated (for example
if $\alpha = 0.8$ the link is considered unpriced until
its utilisation is 80\%).  The cost for
a slot $j$ carrying flow $f_j$ could be approximated by
$$
c_j = 
\begin{cases}
0 & 0 \leq f_j < \alpha m \\
\frac{f_j-\alpha m}{m-f_j} &  \alpha m \leq f_j < m.
\end{cases}
$$
This function gives a cost 0 up to $\alpha m$ and then rising
until the cost approaches infinity as the traffic in the
slot approaches $m$.
The Shapley gradient will simply be the differential of this.
If $f_j$ is the flow on slot $j$ then the price of that slot
is given by the Shapley gradient
$$
G_j =
\begin{cases}
0 & 0 \leq f_j < \alpha m \\
\frac{(1-\alpha)m}{(m-f_j)^2} &  \alpha m \leq f_j < m.
\end{cases}
$$
This is equivalent to a price which is zero (or fixed and finite)
for traffic less than $\alpha m$ and rising rapidly to infinity as
$f_j$ approaches $m$.

\subsubsection{Shapley gradient for other pricing schemes}
\label{sec:other_price}

It is important to consider the case where more than one
cost constraint affects traffic.  For example, in figure 
\ref{fig:network} traffic must cross the ISP internal network
after the transit links.  The ISP internal network may have bandwidth
constraints on links which form an additional part of the problem in
addition to minimising the cost from external links.  In this case
the cost of using the external link could be modelled as the sum of
the cost from transit or peering plus a fixed price weight as in 
the previous section when the associated internal link is running 
near capacity.  If it was known that a certain transit link experienced
congestion at some times then this scheme could also be used to limit
such assignment.  The TARDIS system is relatively flexible in the
cost/pricing which can be assigned as long as the cost can be 
approximated by a differentiable non decreasing function of the
traffic.

The previous sections cover a large number of pricing schemes, however
one practice not yet dealt with is the idea of pricing bands.
For example, traffic might be charged at a particular rate (either 
linearly, fixed cost or at 95th percentile) up to a given level and then at a
lower rate beyond this level.  This presents a problem for the
TARDIS system in two ways: firstly, the cost is no longer non-decreasing,
at a certain point adding traffic reduces the cost; secondly these
pricing bands are often pre-agreed, it would not be realistic to have
an automated system switch between pricing tiers according to changing 
traffic patterns.  Therefore such a cost model would be dealt with
within TARDIS by assuming that the current price band is an input and
the decision to move up or down a price band is an externally made
engineering decision (made by humans or by expert systems) which can
be fed into the TARDIS system if the decision is made to change the 
price band.


