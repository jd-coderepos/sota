\newif\iffullversion
\newif\ifnotfullversion
\fullversiontrue
\notfullversionfalse

\iffullversion
\documentclass{article}
\usepackage{kpfonts,baskervald}
\setlength{\parindent}{0pt}
\setlength{\parskip}{5pt}
\else
\documentclass[conference]{IEEEtran}
\fi

\usepackage{amsmath, amssymb, amsthm}
\usepackage{comment}
\usepackage{varwidth}
\usepackage{rotating}
\usepackage{relsize}
\usepackage{tikz}
\usetikzlibrary{positioning}

\iffullversion
  \usepackage{authblk}
\fi

\theoremstyle{definition}
\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{example}[theorem]{Example}
\newcommand{\DCESHi}{DCESH}
\newcommand{\DCESHn}{DCESH}

\newcommand{\removecodespace}{\vspace{-0.8cm}}




 
\makeatletter
\@ifundefined{lhs2tex.lhs2tex.sty.read}{\@namedef{lhs2tex.lhs2tex.sty.read}{}\newcommand\SkipToFmtEnd{}\newcommand\EndFmtInput{}\long\def\SkipToFmtEnd#1\EndFmtInput{}}\SkipToFmtEnd

\newcommand\ReadOnlyOnce[1]{\@ifundefined{#1}{\@namedef{#1}{}}\SkipToFmtEnd}
\usepackage{amstext}
\usepackage{amssymb}
\usepackage{stmaryrd}
\DeclareFontFamily{OT1}{cmtex}{}
\DeclareFontShape{OT1}{cmtex}{m}{n}
  {<5><6><7><8>cmtex8
   <9>cmtex9
   <10><10.95><12><14.4><17.28><20.74><24.88>cmtex10}{}
\DeclareFontShape{OT1}{cmtex}{m}{it}
  {<-> ssub * cmtt/m/it}{}
\newcommand{\texfamily}{\fontfamily{cmtex}\selectfont}
\DeclareFontShape{OT1}{cmtt}{bx}{n}
  {<5><6><7><8>cmtt8
   <9>cmbtt9
   <10><10.95><12><14.4><17.28><20.74><24.88>cmbtt10}{}
\DeclareFontShape{OT1}{cmtex}{bx}{n}
  {<-> ssub * cmtt/bx/n}{}
\newcommand{\tex}[1]{\text{\texfamily#1}}	

\newcommand{\Sp}{\hskip.33334em\relax}


\newcommand{\Conid}[1]{\mathit{#1}}
\newcommand{\Varid}[1]{\mathit{#1}}
\newcommand{\anonymous}{\kern0.06em \vbox{\hrule\@width.5em}}
\newcommand{\plus}{\mathbin{+\!\!\!+}}
\newcommand{\bind}{\mathbin{>\!\!\!>\mkern-6.7mu=}}
\newcommand{\rbind}{\mathbin{=\mkern-6.7mu<\!\!\!<}}\newcommand{\sequ}{\mathbin{>\!\!\!>}}
\renewcommand{\leq}{\leqslant}
\renewcommand{\geq}{\geqslant}
\usepackage{polytable}

\@ifundefined{mathindent}{\newdimen\mathindent\mathindent\leftmargini}{}

\def\resethooks{\global\let\SaveRestoreHook\empty
  \global\let\ColumnHook\empty}
\newcommand*{\savecolumns}[1][default]{\g@addto@macro\SaveRestoreHook{\savecolumns[#1]}}
\newcommand*{\restorecolumns}[1][default]{\g@addto@macro\SaveRestoreHook{\restorecolumns[#1]}}
\newcommand*{\aligncolumn}[2]{\g@addto@macro\ColumnHook{\column{#1}{#2}}}

\resethooks

\newcommand{\onelinecommentchars}{\quad-{}- }
\newcommand{\commentbeginchars}{\enskip\{-}
\newcommand{\commentendchars}{-\}\enskip}

\newcommand{\visiblecomments}{\let\onelinecomment=\onelinecommentchars
  \let\commentbegin=\commentbeginchars
  \let\commentend=\commentendchars}

\newcommand{\invisiblecomments}{\let\onelinecomment=\empty
  \let\commentbegin=\empty
  \let\commentend=\empty}

\visiblecomments

\newlength{\blanklineskip}
\setlength{\blanklineskip}{0.66084ex}

\newcommand{\hsindent}[1]{\quad}\let\hspre\empty
\let\hspost\empty
\newcommand{\NB}{\textbf{NB}}
\newcommand{\Todo}[1]{\textbf{To do:}~#1}

\EndFmtInput
\makeatother
\ReadOnlyOnce{polycode.fmt}\makeatletter

\newcommand{\hsnewpar}[1]{{\parskip=0pt\parindent=0pt\par\vskip #1\noindent}}

\newcommand{\hscodestyle}{}



\newcommand{\sethscode}[1]{\expandafter\let\expandafter\hscode\csname #1\endcsname
   \expandafter\let\expandafter\endhscode\csname end#1\endcsname}



\newenvironment{compathscode}{\par\noindent
   \advance\leftskip\mathindent
   \hscodestyle
   \let\\=\@normalcr
   \let\hspre\pboxed}{\endpboxed\let\hspost\pboxed}{\endpboxed\parray}{\endparray\parray}{\endparray\pboxed}{\endpboxed\def\column##1##2{}\let\>\undefined\let\<\undefined\let\\\undefined
   \newcommand\>[1][]{}\newcommand\<[1][]{}\newcommand\ }

\newcommand{\inlinehs}{\sethscode{inlinehscode}}



\newenvironment{joincode}{\let\orighscode=\hscode
   \let\origendhscode=\endhscode
   \def\endhscode{\def\hscode{\endgroup\def\@currenvir{hscode}\\}\begingroup}
\orighscode\def\hscode{\endgroup\def\@currenvir{hscode}}}{\origendhscode
   \global\let\hscode=\orighscode
   \global\let\endhscode=\origendhscode}

\makeatother
\EndFmtInput
\ReadOnlyOnce{agda.fmt}


\RequirePackage[T1]{fontenc}
\RequirePackage[utf8x]{inputenc}
\RequirePackage{ucs}
\RequirePackage{amsfonts}

\providecommand\mathbbm{\mathbb}

\DeclareUnicodeCharacter{737}{\textsuperscript{l}}
\DeclareUnicodeCharacter{8718}{\ensuremath{\blacksquare}}
\DeclareUnicodeCharacter{8759}{::}
\DeclareUnicodeCharacter{9669}{\ensuremath{\triangleleft}}
\DeclareUnicodeCharacter{8799}{\ensuremath{\stackrel{\scriptscriptstyle ?}{=}}}
\DeclareUnicodeCharacter{10214}{\ensuremath{\llbracket}}
\DeclareUnicodeCharacter{10215}{\ensuremath{\rrbracket}}
\DeclareUnicodeCharacter{10230}{\ensuremath{\longrightarrow}}
\DeclareUnicodeCharacter{8614}{\ensuremath{\mapsto}}

\providecommand\textepsilon{}
\providecommand\textmu{}






\renewcommand\Varid[1]{\mathord{\textsf{#1}}}
\let\Conid\Varid
\newcommand\Keyword[1]{\textsf{\textbf{#1}}}
\EndFmtInput

\renewcommand{\hscodestyle}{\smaller[.5]}

\newcommand{\indentcolumn}[1]{\aligncolumn{#1}{@{}>{\hspre \quad}l<{\hspost}@{}}}
\newcommand{\rightaligncolumn}[1]{\aligncolumn{#1}{@{}>{\hspre}r<{\hspost}@{}}}
\newcommand{\centeraligncolumn}[1]{\aligncolumn{#1}{@{}>{\hspre}c<{\hspost}@{}}}
\newcommand\MyConid[1]{\mathord{\textsf{\textbf{#1}}}}
\renewcommand\Keyword[1]{\textsf{\underline{#1}}}
\renewcommand\Varid[1]{\textsf{#1}}

\DeclareUnicodeCharacter{411}{\ensuremath{\lambda}}
\DeclareUnicodeCharacter{8343}{\ensuremath{\lambda}}
\DeclareUnicodeCharacter{9656}{\ensuremath{\blacktriangleright}}
\newcommand{\textGamma}{\ensuremath{\Gamma}}
\newcommand{\textlambda}{\ensuremath{\lambda}}
\newcommand{\dummy}{\Varid{\_}}



\iffullversion
\title{Distributed call-by-value machines}
\else
\title{Distributed call-by-value machines \\ {\large Extended abstract}}
\fi

\newcommand\theauthor{Olle Fredriksson}
\newcommand\theaffiliation{University of Birmingham, UK}

\iffullversion
  \author\theauthor
  \affil\theaffiliation
\else
  \author{\IEEEauthorblockN\theauthor
          \IEEEauthorblockA\theaffiliation
  }
\fi

\begin{document}
\iffullversion
\date{}
\fi
\maketitle



\begin{abstract}
We present a new abstract machine, called \DCESHn{}, which describes the
execution of higher-order programs running in distributed architectures.
\DCESHn{} implements a generalised form of Remote Procedure Call that supports
calling higher-order functions across node boundaries, without sending actual
code.  Our starting point is a variant of the SECD machine that we call the CES
machine, which implements reduction for untyped call-by-value PCF.  We
successively add the features that we need for distributed execution and show
the correctness of each addition.  First we add heaps, forming the CESH
machine, which provides features necessary for more efficient execution, and
show that there is a bisimulation between the CES and the CESH machine.  Then
we construct a two-level operational semantics, where the high level is a
network of communicating machines, and the low level is given by local machine
transitions.  Using these networks, we arrive at our final system, the
distributed CESH machine (\DCESHn{}).  We show that there is a bisimulation
relation also between the CESH machine and the \DCESHn{} machine.
All the technical results have been formalised and proved correct
in Agda, and a prototype compiler has been developed.

\end{abstract}

\iffullversion
  \newpage
  \tableofcontents
  \newpage
\fi

\section{Seamless computing}
Suppose we need to program a system in which the function {\textsmaller[.5]{\ensuremath{\Conid{F}}}} runs on node {\textsmaller[.5]{\ensuremath{\Conid{A}}}}
in a distributed system, for instance because {\textsmaller[.5]{\ensuremath{\Conid{F}}}} depends on a local resource
residing on node {\textsmaller[.5]{\ensuremath{\Conid{A}}}}. Suppose further that we need to write a program
{\textsmaller[.5]{\ensuremath{\Conid{G}}}}, running on node {\textsmaller[.5]{\ensuremath{\Conid{B}}}}, that uses {\textsmaller[.5]{\ensuremath{\Conid{F}}}}.  How to achieve this depends on what
programming language or library for distributed computing we choose. One of the
most prominent ways to do it is using message passing, for instance with the
Message-Passing Interface \cite{gropp1999using}.  This involves writing {\textsmaller[.5]{\ensuremath{\Conid{F}}}} and
{\textsmaller[.5]{\ensuremath{\Conid{G}}}} as separate processes, and explicitly constructing messages that are sent
between them.

Suppose now that our specification changes: A part {\textsmaller[.5]{\ensuremath{\Conid{F'}}}} of {\textsmaller[.5]{\ensuremath{\Conid{F}}}} actually needs
to run on a \emph{third} node {\textsmaller[.5]{\ensuremath{\Conid{C}}}}. Using conventional languages or libraries,
this means that we have to rewrite big parts of the program since a substantial
part of it deals with the architecture-specific details of the problem.
Languages with support for Remote Procedure
Calls~\cite{DBLP:journals/tocs/BirrelN84} can help mitigate this, since
such a call has the same syntax as a local procedure call, but will
not work if {\textsmaller[.5]{\ensuremath{\Conid{F'}}}} is a higher-order function that is invoked with a function
as its argument.
In previous
papers~\cite{DBLP:conf/lics/FredrikssonG13,DBLP:conf/tgc/FredrikssonG12} we
suggest the following alternative way to express the two programs above:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{17}{@{}>{\hspre}l<{\hspost}@{}}\column{28}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{let}\;\Conid{F}\;\mathrel{=}\;\{\mskip1.5mu \Varid{...}\;{}\<[17]\>[17]{}\Conid{F'}\;{}\<[28]\>[28]{}\Varid{...}\mskip1.5mu\}\;\MyConid{}\;\Conid{A}\;\Keyword{in}\;\{\mskip1.5mu \Conid{G}\mskip1.5mu\}\;\MyConid{}\;\Conid{B}{}\<[E]\\
\>[B]{}\Keyword{let}\;\Conid{F}\;\mathrel{=}\;\{\mskip1.5mu \Varid{...}\;\{\mskip1.5mu {}\<[17]\>[17]{}\Conid{F'}\mskip1.5mu\}\;\MyConid{}\;\Conid{C}\;{}\<[28]\>[28]{}\Varid{...}\mskip1.5mu\}\;\MyConid{}\;\Conid{A}\;\Keyword{in}\;\{\mskip1.5mu \Conid{G}\mskip1.5mu\}\;\MyConid{}\;\Conid{B}{}\<[E]\ColumnHook
\end{hscode}\resethooks
Here we write the whole program as if it was running on a single computer, and
use pragma-like annotations, written {\textsmaller[.5]{\ensuremath{\{\mskip1.5mu \Varid{x}\mskip1.5mu\}\;\MyConid{}\;\Conid{A}}}}, to indicate the node of
execution. We call such annotations \emph{locus specifiers}. The compiler uses
the annotations to automatically handle architecture-specific details like
communication. We call this \emph{seamless computing}.  A key feature is full
support for higher-order functions, even across node boundaries, without
sending actual code (in contrast to e.g. Remote
Evaluation~\cite{DBLP:journals/toplas/StamosG90}). This is important for full
generality, since it is not always the case that all code is meaningful on all
nodes (for example because of resource locality or platform differences).

Our previous work enables writing these programs but uses an execution model
based on game semantics that is vastly different from conventional compilation
techniques.  In this paper we instead develop an approach which is a conservative
extension of existing abstract machines. This means that the vast literature on
compiler optimisation more readily applies, and makes it possible to interface
with legacy code.  The key idea in this work, like in our previous work, is
that computational phenomena like function calls can be subsumed by simple
communication protocols. We assume that a run-time infrastructure can handle
system-level aspects associated with distribution such as failure, load
balancing, global reset, and so on.

\paragraph*{Technical outline}
To achieve the goal of an abstract machine for seamless computing, we make
gradual refinements to a machine, based on Landin's SECD
machine~\cite{Landin64}, that we call the \emph{CES machine}
(Sec.~\ref{section:CES}). The first change is to add heaps 
\iffullversion 
(Sec.~\ref{section:Heaps})
\fi
for dynamically allocating closures, forming the \emph{CESH machine}
(Sec.~\ref{section:CESH}), which provides features necessary for more efficient
execution, and we show the CES and CESH machines to be
\iffullversion
bisimilar (Sec.~\ref{section:CESH-bisim}).
\else
bisimilar.
\fi
We then add communication primitives (synchronous and asynchronous) by defining
a general form of networks of nodes that run an instance of an underlying abstract
machine (Sec.~\ref{section:Networks}).  Using these networks, we illustrate the
idea of subsuming function calls by communication protocols by constructing a
degenerate distributed machine, \DCESHi{} (Sec.~\ref{section:ADCESH}), that decomposes
some machine instructions into message passing, but only runs on one node.
Finally, the main contribution is the fully distributed CESH machine (\DCESHn{}, Sec.~\ref{section:DCESH}), which is shown to be bisimilar to the CESH
\iffullversion
machine (Sec.~\ref{section:DCESH-bisim}).
\else
machine.
\fi

\paragraph*{Formalisation in Agda}
The theorems that we present in this paper have been proved correct in
Agda~\cite{norell:thesis}, an interactive proof assistant and programming
language based on intuitionistic type theory.  The definitions and proofs in
this paper are intricate and often consist of many cases, so carrying them out manually would
be error-prone and arduous.  Agda has been a helpful tool in producing these
proofs, and also allows us to easily play with alternative definitions (even wrong
ones). To eliminate another source of error, we do not adopt the usual practice
of writing up the results in informal mathematics; in fact, the paper is built
from a collection of literate Agda source files and the code blocks come
directly from the
\ifnotfullversion
formalisation \cite{SourceCode}.
\else
formalisation.
\fi
Although our work is not
about Agda \emph{per se}, we believe that this presentation is beneficial also
to you, the reader, since you can trust that the propositions do not contain
mistakes.
Since Agda builds on a constructive foundation, it also means that the
formalisation of an abstract machine in Agda can act as a verified prototype
implementation.
\iffullversion
\paragraph*{Syntax and notation for code}
We assume a certain familiarity with the syntax of Agda, but since it is close
to that of several popular functional programming languages we believe that
this will not cause much difficulty for the audience.
We will use {\textsmaller[.5]{\ensuremath{\star}}} for the type of types.
We will use \emph{implicit parameters}, written e.g. {\textsmaller[.5]{\ensuremath{\Varid{f}\;\mathbin{:}\;\{\mskip1.5mu \Conid{A}\;\mathbin{:}\;\star\mskip1.5mu\}\;\Varid{→}\;\Varid{...}}}}
which means that {\textsmaller[.5]{\ensuremath{\Varid{f}}}} takes, as its first argument, a type {\textsmaller[.5]{\ensuremath{\Conid{A}}}} that does not
need to be explicitly spelled out when it can be inferred from other
arguments.
We will sometimes use the same name for constructors of different types, and
rely on context for disambiguation.
Constructors will be written in  and keywords .
We make liberal use of Agda's ability to define \emph{mixfix} operators like
{\textsmaller[.5]{\ensuremath{{\MyConid{if0}\dummy\MyConid{then}\dummy\MyConid{else}\dummy}}}} which is a constructor that accepts arguments
in the positions of the underscores, as in {\textsmaller[.5]{\ensuremath{\MyConid{if0}\;\Varid{b}\;\MyConid{then}\;\Varid{t}\;\MyConid{else}\;\Varid{f}}}}.
\fi

This paper is organised as
follows, where the arrows denote dependence, the lines with
 symbols bisimulations, and the parenthesised numerals section numbers:
\begin{center}
\begin{tikzpicture}[node distance=2.0cm, on grid,every node/.style={scale=0.8}]
  \node[label=below:(\ref{section:CES})]   (CES) {CES};
  \node[label=below:(\ref{section:CESH})]  (CESH) [right=of CES] {CESH};
  \node[label=below:(\ref{section:DCESH})] (DCESH) [right=of CESH] {\DCESHn};
\iffullversion
  \node[label=below:(\ref{section:Heaps})] (Heaps) [below left=1.0cm and 1.00cm of CESH] {Heaps};
\else
  \node (Heaps) [below left=1.0cm and 1.00cm of CESH] {Heaps};
\fi
  \node[label=below:(\ref{section:Networks})] (Networks) [below right=1.0cm and 1.00cm of CESH] {Networks};
  \node[label=below:(\ref{section:ADCESH})] (ADCESH) [below=of CESH] {\DCESHi};
\draw (CES) to node[above] {}
                 node[below] {(\ref{section:CESH-bisim})}
                 (CESH);
  \draw (CESH) to node[above] {}
                  node[below] {(\ref{section:DCESH-bisim})}
                  (DCESH);
\draw[->] (CESH) to[bend right=10] (Heaps);
  \draw[->] (DCESH) to[bend left=10] (Heaps);
  \draw[->] (DCESH) to (Networks);
  \draw[->] (ADCESH) to (Heaps);
  \draw[->] (ADCESH) to (Networks);
\end{tikzpicture}
\end{center}


\section{The CES machine} \label{section:CES}
Our goal is to make a compiler for a programming language with
locus specifiers that is based on conventional compilation techniques.
A very common technique is the usage of \emph{abstract machines} to describe
the evaluation at a level low enough to be used as a basis for compilation.
The starting point for our work is based on a variation of Landin's
well-studied SECD machine~\cite{Landin64} called Modern SECD~\cite{ModernSECD}.
Modern SECD itself can be traced back to the SECD machine of
Henderson~\cite{DBLP:books/daglib/0068837}, in that both use bytecode for the
control component of the 
\iffullversion
machine
(and so use explicit return instructions);
\else
machine;
\fi
and
to the CEK machine of Felleisen~\cite{Felleisen:1986:CEK}, in that they both
place the continuations that originally resided in the dump
\iffullversion
(the D component)
\fi
directly on the
\iffullversion
stack (the S component),
\else
stack,
\fi
simplifying the machine configurations.

We choose to call this variation the \emph{CES machine} because of its three
configuration constituents. This machine is important for us since it will be
used as the \emph{specification} for the elaborated machines that we later
construct. We will show that their termination and divergence behaviour is the
same as that of CES by constructing bisimulation relations.

A CES configuration ({\textsmaller[.5]{\ensuremath{\Conid{Config}}}}) is a tuple consisting of a fragment of code
({\textsmaller[.5]{\ensuremath{\Conid{Code}}}}), an environment ({\textsmaller[.5]{\ensuremath{\Conid{Env}}}}), and a stack ({\textsmaller[.5]{\ensuremath{\Conid{Stack}}}}).  Evaluation begins
with an empty stack and environment, and then follows a \emph{stack
discipline}. Sub-terms push their result on the stack so that their super-terms
can consume them. When (and if) the evaluation terminates, the program's result
is the sole stack element.
\paragraph*{Source language}
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{module}\;\Conid{Lambda}\;(\Conid{Node}\;\mathbin{:}\;\star)\;\Keyword{where}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{GeneralLemmas}{}\<[E]\\blanklineskip]\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{Data.List.Any}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Conid{Membership-≡}{}\<[E]\\blanklineskip]\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{GeneralLemmas}{}\<[E]\\blanklineskip]\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{MachineCode}\;\Conid{Node}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{CES}\;\Conid{Node}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{Relation}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}

\begin{lemma}[{\textsmaller[.5]{\ensuremath{\Varid{determinism}_{\Varid{CES}}}}}] {\textsmaller[.5]{\ensuremath{\xrightarrow[\Varid{CES}]{}}}} is deterministic.
\iffullversion
In the formalisation this means that we can construct the following term:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Varid{determinism}_{\Varid{CES}}\;\mathbin{:}\;{\dummy\xrightarrow[\Varid{CES}]{}\dummy}\;\Varid{is-deterministic}{}\<[E]\ColumnHook
\end{hscode}\resethooks
where the type {\textsmaller[.5]{\ensuremath{\Varid{\char95 is-deterministic}}}} is defined as follows:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Varid{\char95 is-deterministic}\;\mathbin{:}\;\{\mskip1.5mu \Conid{A}\;\Conid{B}\;\mathbin{:}\;\star\mskip1.5mu\}\;\Varid{→}\;\Conid{Rel}\;\Conid{A}\;\Conid{B}\;\Varid{→}\;\star{}\<[E]\\
\>[B]{}\Conid{R}\;\Varid{is-deterministic}\;\mathrel{=}\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{∀}\;\{\mskip1.5mu \Varid{a}\;\Varid{b}\;\Varid{b'}\mskip1.5mu\}\;\Varid{→}\;\Conid{R}\;\Varid{a}\;\Varid{b}\;\Varid{→}\;\Conid{R}\;\Varid{a}\;\Varid{b'}\;\Varid{→}\;\Varid{b}\;\Varid{≡}\;\Varid{b'}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\fi
\end{lemma}
This is a key property that is useful when constructing a compiler
implementation of the CES machine. Note that we write the name
of the definition containing this proof in parentheses.

\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{9}{@{}>{\hspre}l<{\hspost}@{}}\column{26}{@{}>{\hspre}l<{\hspost}@{}}\column{36}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Varid{determinism}_{\Varid{CES}}\;(\MyConid{VAR}\;\Varid{x})\;(\MyConid{VAR}\;\Varid{y})\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\mathrel{=}\;\Varid{cong}\;(\Varid{λ}\;\Varid{v}\;\Varid{→}\;\anonymous ,\anonymous ,\MyConid{val}\;\Varid{v}\;\Varid{∷}\;\anonymous )\;(\Varid{just-inj}\;(\Varid{trans}\;(\Varid{sym}\;\Varid{x})\;\Varid{y})){}\<[E]\\
\>[B]{}\Varid{determinism}_{\Varid{CES}}\;\MyConid{CLOS}\;{}\<[26]\>[26]{}\MyConid{CLOS}\;{}\<[36]\>[36]{}\mathrel{=}\;\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{determinism}_{\Varid{CES}}\;\MyConid{APPL}\;{}\<[26]\>[26]{}\MyConid{APPL}\;{}\<[36]\>[36]{}\mathrel{=}\;\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{determinism}_{\Varid{CES}}\;\MyConid{RET}\;{}\<[26]\>[26]{}\MyConid{RET}\;{}\<[36]\>[36]{}\mathrel{=}\;\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{determinism}_{\Varid{CES}}\;\MyConid{REMOTE}\;{}\<[26]\>[26]{}\MyConid{REMOTE}\;{}\<[36]\>[36]{}\mathrel{=}\;\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{determinism}_{\Varid{CES}}\;\MyConid{LIT}\;{}\<[26]\>[26]{}\MyConid{LIT}\;{}\<[36]\>[36]{}\mathrel{=}\;\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{determinism}_{\Varid{CES}}\;\MyConid{OP}\;{}\<[26]\>[26]{}\MyConid{OP}\;{}\<[36]\>[36]{}\mathrel{=}\;\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{determinism}_{\Varid{CES}}\;\MyConid{COND-0}\;{}\<[26]\>[26]{}\MyConid{COND-0}\;{}\<[36]\>[36]{}\mathrel{=}\;\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{determinism}_{\Varid{CES}}\;\MyConid{COND-1+n}\;\MyConid{COND-1+n}\;{}\<[36]\>[36]{}\mathrel{=}\;\Varid{refl}{}\<[E]\\blanklineskip]\>[B]{}\Keyword{infix}\;\Varid{5}\;{\dummy\downarrow_{\Varid{CES}}\dummy}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}

The CES machine \emph{terminates with a value {\textsmaller[.5]{\ensuremath{\Varid{v}}}}}, written {\textsmaller[.5]{\ensuremath{\Varid{cfg}\;\downarrow_{\Varid{CES}}\;\Varid{v}}}} if it, through the reflexive transitive closure of {\textsmaller[.5]{\ensuremath{\xrightarrow[\Varid{CES}]{}}}},
reaches the end of its code fragment with an empty environment, and
{\textsmaller[.5]{\ensuremath{\Varid{v}}}} as its sole stack element.
\iffullversion
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}{\dummy\downarrow_{\Varid{CES}}\dummy}\;\mathbin{:}\;\Conid{Config}\;\Varid{→}\;\Conid{Value}\;\Varid{→}\;\star{}\<[E]\\
\>[B]{}\Varid{cfg}\;\downarrow_{\Varid{CES}}\;\Varid{v}\;\mathrel{=}\;\Varid{cfg}\;\xrightarrow[\Varid{CES}]{}^*\;(\MyConid{END},[\mskip1.5mu \mskip1.5mu],\MyConid{val}\;\Varid{v}\;\Varid{∷}\;[\mskip1.5mu \mskip1.5mu]){}\<[E]\ColumnHook
\end{hscode}\resethooks
where the reflexive transitive closure of a relation is defined as follows:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{8}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{data}\;\Varid{\char95 *}\;\{\mskip1.5mu \Conid{A}\;\mathbin{:}\;\star\mskip1.5mu\}\;(\Conid{R}\;\mathbin{:}\;\Conid{Rel}\;\Conid{A}\;\Conid{A})\;(\Varid{a}\;\mathbin{:}\;\Conid{A})\;\mathbin{:}\;\Conid{A}\;\Varid{→}\;\star\;\Keyword{where}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}[\mskip1.5mu \mskip1.5mu]\;{}\<[8]\>[8]{}\mathbin{:}\;(\Conid{R}\;\Varid{*})\;\Varid{a}\;\Varid{a}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{\char95 ∷\char95 }\;{}\<[8]\>[8]{}\mathbin{:}\;\{\mskip1.5mu \Varid{b}\;\Varid{c}\;\mathbin{:}\;\Conid{A}\mskip1.5mu\}\;\Varid{→}\;\Conid{R}\;\Varid{a}\;\Varid{b}\;\Varid{→}\;(\Conid{R}\;\Varid{*})\;\Varid{b}\;\Varid{c}\;\Varid{→}\;(\Conid{R}\;\Varid{*})\;\Varid{a}\;\Varid{c}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\fi
It \emph{terminates}, written {\textsmaller[.5]{\ensuremath{\Varid{cfg}\;\downarrow_{\Varid{CES}}}}} if there exists a value {\textsmaller[.5]{\ensuremath{\Varid{v}}}} such
that it terminates with the value {\textsmaller[.5]{\ensuremath{\Varid{v}}}}.
\iffullversion
The Agda syntax for the existential quantifier normally
written as  is {\textsmaller[.5]{\ensuremath{\Varid{∃}\;\Varid{λ}\;\Varid{x}\;\Varid{→}\;\Conid{P}\;\Varid{x}}}}. Using this syntax, the
definition of termination with value {\textsmaller[.5]{\ensuremath{\Varid{v}}}} is:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}{\dummy\downarrow_{\Varid{CES}}}\;\mathbin{:}\;\Conid{Config}\;\Varid{→}\;\star{}\<[E]\\
\>[B]{}\Varid{cfg}\;\downarrow_{\Varid{CES}}\;\mathrel{=}\;\Varid{∃}\;\Varid{λ}\;\Varid{v}\;\Varid{→}\;\Varid{cfg}\;\downarrow_{\Varid{CES}}\;\Varid{v}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\fi
It \emph{diverges}, written {\textsmaller[.5]{\ensuremath{\Varid{cfg}\;\uparrow_{\Varid{CES}}}}} if it is possible to take
another step from any configuration reachable from the reflexive transitive
closure of {\textsmaller[.5]{\ensuremath{\xrightarrow[\Varid{CES}]{}}}}.
\iffullversion
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}{\dummy\uparrow_{\Varid{CES}}}\;\mathbin{:}\;\Conid{Config}\;\Varid{→}\;\star{}\<[E]\\
\>[B]{}{\dummy\uparrow_{\Varid{CES}}}\;\mathrel{=}\;\Varid{↑}\;{\dummy\xrightarrow[\Varid{CES}]{}\dummy}{}\<[E]\ColumnHook
\end{hscode}\resethooks
where
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Varid{↑}\;\mathbin{:}\;\{\mskip1.5mu \Conid{A}\;\mathbin{:}\;\star\mskip1.5mu\}\;(\Conid{R}\;\mathbin{:}\;\Conid{Rel}\;\Conid{A}\;\Conid{A})\;\Varid{→}\;\Conid{A}\;\Varid{→}\;\star{}\<[E]\\
\>[B]{}\Varid{↑}\;\Conid{R}\;\Varid{a}\;\mathrel{=}\;\Varid{∀}\;\Varid{b}\;\Varid{→}\;(\Conid{R}\;\Varid{*})\;\Varid{a}\;\Varid{b}\;\Varid{→}\;\Varid{∃}\;\Varid{λ}\;\Varid{c}\;\Varid{→}\;\Conid{R}\;\Varid{b}\;\Varid{c}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\fi

\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{5}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Varid{convergent-cfg-doesn't-diverge}\;\mathbin{:}\;\Varid{∀}\;\Varid{cfg}\;\Varid{→}\;\Varid{cfg}\;\downarrow_{\Varid{CES}}\;\Varid{→}\;\Varid{¬}\;(\Varid{cfg}\;\uparrow_{\Varid{CES}}){}\<[E]\\
\>[B]{}\Varid{convergent-cfg-doesn't-diverge}\;\Varid{cfg}\;(\Varid{v},\Varid{cfg⟶*v})\;\Varid{cfg↑}\;\mathrel{=}\;\Varid{lemma}\;(\Varid{cfg↑}\;(\MyConid{END},[\mskip1.5mu \mskip1.5mu],\MyConid{val}\;\Varid{v}\;\Varid{∷}\;[\mskip1.5mu \mskip1.5mu])\;\Varid{cfg⟶*v}){}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Keyword{where}{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}\Varid{lemma}\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{v}\mskip1.5mu\}\;\Varid{→}\;\Varid{¬}\;(\Varid{∃}\;\Varid{λ}\;\Varid{cfg}\;\Varid{→}\;(\MyConid{END},[\mskip1.5mu \mskip1.5mu],\MyConid{val}\;\Varid{v}\;\Varid{∷}\;[\mskip1.5mu \mskip1.5mu])\;\xrightarrow[\Varid{CES}]{}\;\Varid{cfg}){}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}\Varid{lemma}\;(\Varid{cfg},()){}\<[E]\\blanklineskip]\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{GeneralLemmas}{}\<[E]\\blanklineskip]\>[B]{}\Conid{Stack}\;\mathrel{=}\;\Conid{List}\;\Conid{StackElem}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\fi
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Conid{ClosHeap}\;\mathrel{=}\;\Conid{Heap}\;\Conid{Closure}{}\<[E]\\
\>[B]{}\Conid{Config}\;\mathrel{=}\;\Conid{Code}\;\Varid{×}\;\Conid{Env}\;\Varid{×}\;\Conid{Stack}\;\Varid{×}\;\Conid{ClosHeap}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}

\iffullversion
\begin{sidewaysfigure}
\else
\begin{figure*}[!t]
\fi
\centering
\begin{varwidth}[t]{\textwidth}
\iffullversion
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{data}\;{\dummy\xrightarrow[\Varid{CESH}]{}\dummy}\;\mathbin{:}\;\Conid{Rel}\;\Conid{Config}\;\Conid{Config}\;\Keyword{where}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\removecodespace
\fi
\savecolumns
\rightaligncolumn{40}
\indentcolumn{3}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{13}{@{}>{\hspre}l<{\hspost}@{}}\column{40}{@{}>{\hspre}l<{\hspost}@{}}\column{100}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}\MyConid{CLOS}\;{}\<[13]\>[13]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{c'}\;\Varid{c}\;\Varid{e}\;\Varid{s}\;\Varid{h}\mskip1.5mu\}\;\Varid{→}\;\Keyword{let}\;(\Varid{h'},\Varid{ptr}_{\Varid{cl}})\;\mathrel{=}\;\Varid{h}\;\Varid{▸}\;(\Varid{c'},\Varid{e})\;\Keyword{in}{}\<[E]\\
\>[13]{}\hsindent{27}{}\<[40]\>[40]{}(\MyConid{CLOS}\;\Varid{c'}\;\MyConid{;}\;\Varid{c},\Varid{e},\Varid{s},\Varid{h})\;{}\<[100]\>[100]{}\xrightarrow[\Varid{CESH}]{}\;(\Varid{c},\Varid{e},\MyConid{val}\;(\MyConid{clos}\;\Varid{ptr}_{\Varid{cl}})\;\Varid{∷}\;\Varid{s},\Varid{h'}){}\<[E]\\
\>[3]{}\MyConid{APPL}\;{}\<[13]\>[13]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{c}\;\Varid{e}\;\Varid{v}\;\Varid{ptr}_{\Varid{cl}}\;\Varid{c'}\;\Varid{e'}\;\Varid{s}\;\Varid{h}\mskip1.5mu\}\;\Varid{→}\;\Varid{h}\;\mathbin{!}\;\Varid{ptr}_{\Varid{cl}}\;\Varid{≡}\;\MyConid{just}\;(\Varid{c'},\Varid{e'})\;\Varid{→}\;{}\<[E]\\
\>[13]{}\hsindent{27}{}\<[40]\>[40]{}(\MyConid{APPL}\;\MyConid{;}\;\Varid{c},\Varid{e},\MyConid{val}\;\Varid{v}\;\Varid{∷}\;\MyConid{val}\;(\MyConid{clos}\;\Varid{ptr}_{\Varid{cl}})\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[100]\>[100]{}\xrightarrow[\Varid{CESH}]{}\;(\Varid{c'},\Varid{v}\;\Varid{∷}\;\Varid{e'},\MyConid{cont}\;(\Varid{c},\Varid{e})\;\Varid{∷}\;\Varid{s},\Varid{h}){}\<[E]\ColumnHook
\end{hscode}\resethooks
\iffullversion
\removecodespace
\restorecolumns
\indentcolumn{3}
\rightaligncolumn{40}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{13}{@{}>{\hspre}l<{\hspost}@{}}\column{40}{@{}>{\hspre}l<{\hspost}@{}}\column{100}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}\MyConid{VAR}\;{}\<[13]\>[13]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{n}\;\Varid{c}\;\Varid{e}\;\Varid{s}\;\Varid{h}\;\Varid{v}\mskip1.5mu\}\;\Varid{→}\;\Varid{lookup}\;\Varid{n}\;\Varid{e}\;\Varid{≡}\;\MyConid{just}\;\Varid{v}\;\Varid{→}\;{}\<[E]\\
\>[13]{}\hsindent{27}{}\<[40]\>[40]{}(\MyConid{VAR}\;\Varid{n}\;\MyConid{;}\;\Varid{c},\Varid{e},\Varid{s},\Varid{h})\;{}\<[100]\>[100]{}\xrightarrow[\Varid{CESH}]{}\;(\Varid{c},\Varid{e},\MyConid{val}\;\Varid{v}\;\Varid{∷}\;\Varid{s},\Varid{h}){}\<[E]\\
\>[3]{}\MyConid{RET}\;{}\<[13]\>[13]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{e}\;\Varid{v}\;\Varid{c}\;\Varid{e'}\;\Varid{s}\;\Varid{h}\mskip1.5mu\}\;\Varid{→}\;{}\<[40]\>[40]{}(\MyConid{RET},\Varid{e},\MyConid{val}\;\Varid{v}\;\Varid{∷}\;\MyConid{cont}\;(\Varid{c},\Varid{e'})\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[100]\>[100]{}\xrightarrow[\Varid{CESH}]{}\;(\Varid{c},\Varid{e'},\MyConid{val}\;\Varid{v}\;\Varid{∷}\;\Varid{s},\Varid{h}){}\<[E]\\
\>[3]{}\MyConid{LIT}\;{}\<[13]\>[13]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{l}\;\Varid{c}\;\Varid{e}\;\Varid{s}\;\Varid{h}\mskip1.5mu\}\;\Varid{→}\;{}\<[40]\>[40]{}(\MyConid{LIT}\;\Varid{l}\;\MyConid{;}\;\Varid{c},\Varid{e},\Varid{s},\Varid{h})\;{}\<[100]\>[100]{}\xrightarrow[\Varid{CESH}]{}\;(\Varid{c},\Varid{e},\MyConid{val}\;(\MyConid{nat}\;\Varid{l})\;\Varid{∷}\;\Varid{s},\Varid{h}){}\<[E]\\
\>[3]{}\MyConid{OP}\;{}\<[13]\>[13]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{f}\;\Varid{c}\;\Varid{e}\;\Varid{l₁}\;\Varid{l₂}\;\Varid{s}\;\Varid{h}\mskip1.5mu\}\;\Varid{→}\;{}\<[40]\>[40]{}(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{c},\Varid{e},\MyConid{val}\;(\MyConid{nat}\;\Varid{l₁})\;\Varid{∷}\;\MyConid{val}\;(\MyConid{nat}\;\Varid{l₂})\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[100]\>[100]{}\xrightarrow[\Varid{CESH}]{}\;(\Varid{c},\Varid{e},\MyConid{val}\;(\MyConid{nat}\;(\Varid{f}\;\Varid{l₁}\;\Varid{l₂}))\;\Varid{∷}\;\Varid{s},\Varid{h}){}\<[E]\\
\>[3]{}\MyConid{COND-0}\;{}\<[13]\>[13]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{c}\;\Varid{c'}\;\Varid{e}\;\Varid{s}\;\Varid{h}\mskip1.5mu\}\;\Varid{→}\;{}\<[40]\>[40]{}(\MyConid{COND}\;\Varid{c}\;\Varid{c'},\Varid{e},\MyConid{val}\;(\MyConid{nat}\;\Varid{0})\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[100]\>[100]{}\xrightarrow[\Varid{CESH}]{}\;(\Varid{c},\Varid{e},\Varid{s},\Varid{h}){}\<[E]\\
\>[3]{}\MyConid{COND-1+n}\;{}\<[13]\>[13]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{c}\;\Varid{c'}\;\Varid{e}\;\Varid{n}\;\Varid{s}\;\Varid{h}\mskip1.5mu\}\;\Varid{→}\;{}\<[40]\>[40]{}(\MyConid{COND}\;\Varid{c}\;\Varid{c'},\Varid{e},\MyConid{val}\;(\MyConid{nat}\;(1+\;\Varid{n}))\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[100]\>[100]{}\xrightarrow[\Varid{CESH}]{}\;(\Varid{c'},\Varid{e},\Varid{s},\Varid{h}){}\<[E]\ColumnHook
\end{hscode}\resethooks
\fi
\end{varwidth}
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{12}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}\MyConid{REMOTE}\;{}\<[12]\>[12]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{c'}\;\Varid{i}\;\Varid{c}\;\Varid{e}\;\Varid{s}\;\Varid{h}\mskip1.5mu\}\;\Varid{→}\;(\MyConid{REMOTE}\;\Varid{c'}\;\Varid{i}\;\MyConid{;}\;\Varid{c},\Varid{e},\Varid{s},\Varid{h})\;\xrightarrow[\Varid{CESH}]{}\;(\Varid{c'},[\mskip1.5mu \mskip1.5mu],\MyConid{cont}\;(\Varid{c},\Varid{e})\;\Varid{∷}\;\Varid{s},\Varid{h}){}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}
\iffullversion
\caption{The definition of the transition relation of the CESH machine.}
\else
\caption{The definition of the transition relation of the CESH machine (excerpt).}
\fi
\label{figure:CESH-step}
\iffullversion
\end{sidewaysfigure}
\else
\end{figure*}
\fi

Fig.~\ref{figure:CESH-step} shows the definition of the transition
relation of the CESH machine.
\iffullversion
It is largely the same as that of the CES
machine, but with the added heap component.
\else
It is largely the same as that of the CES
machine, but with the added heap component, so we elide most of the rules.
\fi
The difference appears in the {\textsmaller[.5]{\ensuremath{\MyConid{CLOS}}}} and {\textsmaller[.5]{\ensuremath{\MyConid{APPL}}}} instructions. To
build a closure, the machine allocates it in the heap using the {\textsmaller[.5]{\ensuremath{\Varid{\char95 ▸\char95 }}}}
function, which, given a heap and an element, gives back an
updated heap and a pointer to the element.  When performing an
application, the machine has a \emph{pointer} to a closure, so it
looks it up in the heap using the {\textsmaller[.5]{\ensuremath{\Varid{\char95 !\char95 }}}} function, which, given a heap
and a pointer, gives back the element that the pointer points to (if
it exists).
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{module}\;\Conid{CESH.Properties}\;(\Conid{Node}\;\mathbin{:}\;\star)\;\Keyword{where}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{GeneralLemmas}\;\Keyword{hiding}\;([\mskip1.5mu \anonymous \mskip1.5mu]){}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{MachineCode}\;\Conid{Node}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{Relation}\;\Keyword{hiding}\;([\mskip1.5mu \anonymous \mskip1.5mu]){}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{Data.List}\;\Keyword{using}\;([\mskip1.5mu \anonymous \mskip1.5mu]){}\<[E]\\blanklineskip]\>[B]{}{\dummy\xrightarrow[\Varid{CESH}]{}^*\dummy}\;\mathrel{=}\;{\dummy\xrightarrow[\Varid{CESH}]{}\dummy}\;\Varid{*}{}\<[E]\\blanklineskip]\>[B]{}\Varid{divergent-cfg-doesn't-converge}\;\mathbin{:}\;\Varid{∀}\;\Varid{cfg}\;\Varid{→}\;\Varid{cfg}\;\uparrow_{\Varid{CESH}}\;\Varid{→}\;\Varid{¬}\;(\Varid{cfg}\;\downarrow_{\Varid{CESH}}){}\<[E]\\
\>[B]{}\Varid{divergent-cfg-doesn't-converge}\;\Varid{cfg}\;\Varid{cfg↑}\;\Varid{cfg↓}\;\mathrel{=}\;\Varid{convergent-cfg-doesn't-diverge}\;\Varid{cfg}\;\Varid{cfg↓}\;\Varid{cfg↑}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}
\iffullversion
\subsection{An interface for heaps} \label{section:Heaps}
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{module}\;\Conid{Heap}\;\Keyword{where}{}\<[E]\\blanklineskip]\>[B]{}\Keyword{infix}\;\Varid{8}\;\Varid{\char95 ▸\char95 }{}\<[E]\\
\>[B]{}\Keyword{infix}\;\Varid{7}\;\Varid{\char95 ⊆\char95 }{}\<[E]\\
\>[B]{}\Keyword{infix}\;\Varid{10}\;\Varid{\char95 !\char95 }{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}

In this section we formally define an abstract interface for the type
constructor {\textsmaller[.5]{\ensuremath{\Conid{Heap}}}} and its associated functions that we use to model
the dynamic memory allocation that we will need in our system.  We
will leave the details unspecified, requiring instead that it captures
certain algebraic properties that should be fulfilled by any
reasonable implementation.

The type {\textsmaller[.5]{\ensuremath{\Conid{Heap}\;\Conid{A}}}} models heaps with memory cells of type {\textsmaller[.5]{\ensuremath{\Conid{A}}}}, and
{\textsmaller[.5]{\ensuremath{\Conid{Ptr}}}} pointers into some heap. We require the existence of a heap {\textsmaller[.5]{\ensuremath{\Varid{∅}}}}
without any other requirements.
\savecolumns
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{13}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{abstract}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Conid{Heap}\;{}\<[13]\>[13]{}\mathbin{:}\;\star\;\Varid{→}\;\star{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Conid{Ptr}\;{}\<[13]\>[13]{}\mathbin{:}\;\star{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{∅}\;{}\<[13]\>[13]{}\mathbin{:}\;\{\mskip1.5mu \Conid{A}\;\mathbin{:}\;\star\mskip1.5mu\}\;\Varid{→}\;\Conid{Heap}\;\Conid{A}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}\Conid{Heap}\;\mathrel{=}\;\Conid{List}{}\<[E]\\
\>[3]{}\Conid{Ptr}\;\mathrel{=}\;\Conid{ℕ}{}\<[E]\\
\>[3]{}\Varid{∅}\;\mathrel{=}\;[\mskip1.5mu \mskip1.5mu]{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}
\restorecolumns
We need to be able to attempt to lookup (or dereference) pointers,
and allocate new items. Allocating gives back a new heap and a pointer.
\restorecolumns
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{13}{@{}>{\hspre}l<{\hspost}@{}}\column{16}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}\Varid{\char95 !\char95 }\;{}\<[13]\>[13]{}\mathbin{:}\;\{\mskip1.5mu \Conid{A}\;\mathbin{:}\;\star\mskip1.5mu\}\;\Varid{→}\;\Conid{Heap}\;\Conid{A}\;\Varid{→}\;\Conid{Ptr}\;\Varid{→}\;\Conid{Maybe}\;\Conid{A}{}\<[E]\\
\>[3]{}\Varid{\char95 ▸\char95 }\;{}\<[13]\>[13]{}\mathbin{:}\;{}\<[16]\>[16]{}\{\mskip1.5mu \Conid{A}\;\mathbin{:}\;\star\mskip1.5mu\}\;\Varid{→}\;\Conid{Heap}\;\Conid{A}\;\Varid{→}\;\Conid{A}\;\Varid{→}\;\Conid{Heap}\;\Conid{A}\;\Varid{×}\;\Conid{Ptr}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}[\mskip1.5mu \mskip1.5mu]\;\mathbin{!}\;\Varid{n}\;\mathrel{=}\;\MyConid{nothing}{}\<[E]\\
\>[3]{}(\Varid{x}\;\Varid{∷}\;\Varid{h})\;\mathbin{!}\;\Varid{zero}\;\mathrel{=}\;\MyConid{just}\;\Varid{x}{}\<[E]\\
\>[3]{}(\Varid{x}\;\Varid{∷}\;\Varid{h})\;\mathbin{!}\;1+\;\Varid{ptr}\;\mathrel{=}\;\Varid{h}\;\mathbin{!}\;\Varid{ptr}{}\<[E]\\
\>[3]{}\Varid{h}\;\Varid{▸}\;\Varid{a}\;\mathrel{=}\;(\Varid{h}\;\plus \;\Varid{a}\;\Varid{∷}\;[\mskip1.5mu \mskip1.5mu],\Varid{length}\;\Varid{h}){}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}
We require the following relationship between dereferencing and
allocation: if we dereference a pointer that was obtained from
allocating a memory cell with value {\textsmaller[.5]{\ensuremath{\Varid{x}}}}, we get {\textsmaller[.5]{\ensuremath{\Varid{x}}}} back:
\restorecolumns
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{13}{@{}>{\hspre}l<{\hspost}@{}}\column{16}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}\Varid{!-▸}\;{}\<[13]\>[13]{}\mathbin{:}\;\{\mskip1.5mu \Conid{A}\;\mathbin{:}\;\star\mskip1.5mu\}\;(\Varid{h}\;\mathbin{:}\;\Conid{Heap}\;\Conid{A})\;(\Varid{x}\;\mathbin{:}\;\Conid{A})\;\Varid{→}{}\<[E]\\
\>[13]{}\hsindent{3}{}\<[16]\>[16]{}\Keyword{let}\;(\Varid{h'},\Varid{ptr})\;\mathrel{=}\;\Varid{h}\;\Varid{▸}\;\Varid{x}\;\Keyword{in}\;\Varid{h'}\;\mathbin{!}\;\Varid{ptr}\;\Varid{≡}\;\MyConid{just}\;\Varid{x}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}\Varid{!-▸}\;[\mskip1.5mu \mskip1.5mu]\;\Varid{x}\;\mathrel{=}\;\Varid{refl}{}\<[E]\\
\>[3]{}\Varid{!-▸}\;(\anonymous \;\Varid{∷}\;\Varid{h})\;\Varid{x}\;\mathrel{=}\;\Varid{!-▸}\;\Varid{h}\;\Varid{x}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}
We define a preorder {\textsmaller[.5]{\ensuremath{\Varid{⊆}}}} for \emph{sub-heaps}. The intuitive reading
for {\textsmaller[.5]{\ensuremath{\Varid{h}\;\Varid{⊆}\;\Varid{h'}}}} is that {\textsmaller[.5]{\ensuremath{\Varid{h'}}}} can be used where {\textsmaller[.5]{\ensuremath{\Varid{h}}}} can, i.e. that {\textsmaller[.5]{\ensuremath{\Varid{h'}}}}
contains at least the allocations of {\textsmaller[.5]{\ensuremath{\Varid{h}}}}.
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{10}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Varid{\char95 ⊆\char95 }\;{}\<[10]\>[10]{}\mathbin{:}\;\{\mskip1.5mu \Conid{A}\;\mathbin{:}\;\star\mskip1.5mu\}\;\Varid{→}\;\Conid{Heap}\;\Conid{A}\;\Varid{→}\;\Conid{Heap}\;\Conid{A}\;\Varid{→}\;\star{}\<[E]\\
\>[B]{}\Varid{h₁}\;\Varid{⊆}\;\Varid{h₂}\;\mathrel{=}\;\Varid{∀}\;\Varid{ptr}\;\{\mskip1.5mu \Varid{x}\mskip1.5mu\}\;\Varid{→}\;\Varid{h₁}\;\mathbin{!}\;\Varid{ptr}\;\Varid{≡}\;\MyConid{just}\;\Varid{x}\;\Varid{→}\;\Varid{h₂}\;\mathbin{!}\;\Varid{ptr}\;\Varid{≡}\;\MyConid{just}\;\Varid{x}{}\<[E]\\blanklineskip]\>[B]{}\Varid{⊆-trans}\;{}\<[10]\>[10]{}\mathbin{:}\;\{\mskip1.5mu \Conid{A}\;\mathbin{:}\;\star\mskip1.5mu\}\;\{\mskip1.5mu \Varid{h₁}\;\Varid{h₂}\;\Varid{h₃}\;\mathbin{:}\;\Conid{Heap}\;\Conid{A}\mskip1.5mu\}\;{}\<[E]\\
\>[10]{}\Varid{→}\;\Varid{h₁}\;\Varid{⊆}\;\Varid{h₂}\;\Varid{→}\;\Varid{h₂}\;\Varid{⊆}\;\Varid{h₃}\;\Varid{→}\;\Varid{h₁}\;\Varid{⊆}\;\Varid{h₃}{}\<[E]\\
\>[B]{}\Varid{⊆-trans}\;\Varid{h₁⊆h₂}\;\Varid{h₂⊆h₃}\;\Varid{ptr}\;\Varid{eq}\;\mathrel{=}\;\Varid{h₂⊆h₃}\;\Varid{ptr}\;(\Varid{h₁⊆h₂}\;\Varid{ptr}\;\Varid{eq}){}\<[E]\ColumnHook
\end{hscode}\resethooks
Our last requirement is that allocation does not overwrite any memory
cells that were previously allocated ({\textsmaller[.5]{\ensuremath{\Varid{proj₁}}}} means first projection):
\restorecolumns
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{13}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{abstract}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{h⊆h▸x}\;{}\<[13]\>[13]{}\mathbin{:}\;\{\mskip1.5mu \Conid{A}\;\mathbin{:}\;\star\mskip1.5mu\}\;(\Varid{h}\;\mathbin{:}\;\Conid{Heap}\;\Conid{A})\;\{\mskip1.5mu \Varid{x}\;\mathbin{:}\;\Conid{A}\mskip1.5mu\}\;\Varid{→}\;\Varid{h}\;\Varid{⊆}\;\Varid{proj₁}\;(\Varid{h}\;\Varid{▸}\;\Varid{x}){}\<[E]\ColumnHook
\end{hscode}\resethooks
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}\Varid{h⊆h▸x}\;[\mskip1.5mu \mskip1.5mu]\;\Varid{ptr}\;(){}\<[E]\\
\>[3]{}\Varid{h⊆h▸x}\;(\Varid{x}\;\Varid{∷}\;\Varid{h})\;\Varid{zero}\;\Varid{eq}\;\mathrel{=}\;\Varid{eq}{}\<[E]\\
\>[3]{}\Varid{h⊆h▸x}\;(\Varid{x}\;\Varid{∷}\;\Varid{h})\;(1+\;\Varid{ptr})\;\Varid{eq}\;\mathrel{=}\;\Varid{h⊆h▸x}\;\Varid{h}\;\Varid{ptr}\;\Varid{eq}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}
\fi
\subsection{Correctness} \label{section:CESH-bisim}
To show that our definition of the machine is correct, we construct
a bisimulation between the CES and CESH machines.
Since the configurations of the machines are very similar, the
intuition for the relation that we construct is simply that it is
almost equality. The only place where it is not equality is for
closure values, where the CESH machine stores pointers instead of
closures directly.  To construct a relation for closure values we need
to to \emph{parameterise} it by the heap of the CESH configuration,
and then make sure that the closure pointer points to a closure
related to the CES closure.

\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{29}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{module}\;\Conid{CESH.Simulation}\;(\Conid{Node}\;\mathbin{:}\;\star)\;\Keyword{where}{}\<[E]\\blanklineskip]\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{env}\;\mathbin{:}\;\Varid{∀}\;\Varid{e}\;\Varid{he}\;\Varid{→}\;\Varid{R}_{\Varid{Env}}\;\Varid{h}\;\Varid{e}\;\Varid{he}\;\Varid{→}\;\Varid{R}_{\Varid{Env}}\;\Varid{h'}\;\Varid{e}\;\Varid{he}{}\<[E]\\blanklineskip]\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{value}\;\mathbin{:}\;\Varid{∀}\;\Varid{v}\;\Varid{hv}\;\Varid{→}\;\Varid{R}_{\Varid{Val}}\;\Varid{h}\;\Varid{v}\;\Varid{hv}\;\Varid{→}\;\Varid{R}_{\Varid{Val}}\;\Varid{h'}\;\Varid{v}\;\Varid{hv}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{value}\;(\MyConid{nat}\;\Varid{n₁})\;(\MyConid{nat}\;\Varid{n₂})\;\Conid{Rvhv}\;\mathrel{=}\;\Conid{Rvhv}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{value}\;(\MyConid{nat}\;\anonymous )\;(\MyConid{clos}\;\anonymous )\;(){}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{value}\;(\MyConid{clos}\;\anonymous )\;(\MyConid{nat}\;\anonymous )\;(){}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{value}\;(\MyConid{clos}\;\Varid{cl})\;(\MyConid{clos}\;\Varid{ptr})\;\Conid{Rvhv}\;\mathrel{=}\;\Varid{lookup-clptr-fmap}\;\Varid{h'}\;\Varid{ptr}\;(\Varid{closure}\;\Varid{cl}\;\anonymous )\;(\Varid{lu-clptr}\;\Varid{ptr}\;\Conid{Rvhv}){}\<[E]\\blanklineskip]\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{stackelem}\;\mathbin{:}\;\Varid{∀}\;\Varid{e}\;\Varid{he}\;\Varid{→}\;\Varid{R}_{\Varid{StackElem}}\;\Varid{h}\;\Varid{e}\;\Varid{he}\;\Varid{→}\;\Varid{R}_{\Varid{StackElem}}\;\Varid{h'}\;\Varid{e}\;\Varid{he}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{stackelem}\;(\MyConid{val}\;\Varid{v})\;(\MyConid{val}\;\Varid{hv})\;\Conid{Rehe}\;\mathrel{=}\;\Varid{value}\;\Varid{v}\;\Varid{hv}\;\Conid{Rehe}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{stackelem}\;(\MyConid{val}\;\anonymous )\;(\MyConid{cont}\;\anonymous )\;(){}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{stackelem}\;(\MyConid{cont}\;\anonymous )\;(\MyConid{val}\;\anonymous )\;(){}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{stackelem}\;(\MyConid{cont}\;\Varid{cl})\;(\MyConid{cont}\;\Varid{hcl})\;\Conid{Rehe}\;\mathrel{=}\;\Varid{closure}\;\Varid{cl}\;\Varid{hcl}\;\Conid{Rehe}{}\<[E]\\blanklineskip]\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{GeneralLemmas}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{CES}\;{}\<[29]\>[29]{}\Conid{Node}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{CESH}\;{}\<[29]\>[29]{}\Conid{Node}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{CESH.Properties}\;\Conid{Node}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{CESH.Simulation}\;\Conid{Node}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{Heap}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{MachineCode}\;\Conid{Node}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{Relation}{}\<[E]\\blanklineskip]\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{GeneralLemmas}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{CES}\;{}\<[32]\>[32]{}\Conid{Node}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{CES.Properties}\;{}\<[32]\>[32]{}\Conid{Node}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{CESH}\;{}\<[32]\>[32]{}\Conid{Node}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{CESH.Presimulation}\;\Conid{Node}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{CESH.Properties}\;{}\<[32]\>[32]{}\Conid{Node}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{CESH.Simulation}\;{}\<[32]\>[32]{}\Conid{Node}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{Heap}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{MachineCode}\;{}\<[32]\>[32]{}\Conid{Node}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{Relation}{}\<[E]\\blanklineskip]\>[B]{}\Varid{initial-divergence-agrees}\;\mathbin{:}\;\Varid{∀}\;\Varid{c}\;\Varid{→}\;(\Varid{c},[\mskip1.5mu \mskip1.5mu],[\mskip1.5mu \mskip1.5mu])\;\uparrow_{\Varid{CES}}\;\Varid{↔}\;(\Varid{c},[\mskip1.5mu \mskip1.5mu],[\mskip1.5mu \mskip1.5mu],\Varid{∅})\;\uparrow_{\Varid{CESH}}{}\<[E]\\
\>[B]{}\Varid{initial-divergence-agrees}\;\Varid{c}\;\mathrel{=}\;\Varid{divergence-agrees}\;(\Varid{c},[\mskip1.5mu \mskip1.5mu],[\mskip1.5mu \mskip1.5mu])\;(\Varid{c},[\mskip1.5mu \mskip1.5mu],[\mskip1.5mu \mskip1.5mu],\Varid{∅})\;(\Varid{initial-related}\;\Varid{c}){}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}

\section{Synchronous and asynchronous networks} \label{section:Networks}
Since we are later going to define two distributed abstract machines, it would
save us some work if we could make a network model that is general enough to be
used for both. In this section we will define models for synchronous
and asynchronous networks, that are parameterised by an underlying labelled
transition system. Both kinds of networks are modelled by two-level transition
systems, which is common in operational semantics for concurrent and parallel
languages. The idea is that the global level describes the transitions of the
system as a whole, and the low level the local transitions of the nodes in the
system.
Synchronous communication is modelled by \emph{rendezvous}, i.e.\ that two
nodes have to be ready to send and receive a message at a single point in time.
Asynchronous communication is modelled using a ``message soup'', representing
messages currently in transit, that nodes can add and remove messages from,
reminiscent of the Chemical Abstract Machine~\cite{DBLP:conf/popl/BerryB90}.

\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{Tagged}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{GeneralLemmas}\;\Keyword{using}\;(\Conid{Dec};\Varid{\char95 ≡\char95 }){}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}
We construct an Agda module {\textsmaller[.5]{\ensuremath{\Conid{Network}}}}, parameterised by the underlying
transition relation, {\textsmaller[.5]{\ensuremath{{\dummy ⊢ \dummy \xrightarrow[\Varid{Machine}]{\dummy} \dummy}\;\mathbin{:}\;\Conid{Node}\;\Varid{→}\;\Conid{Machine}\;\Varid{→}\;\Conid{Tagged}\;\Conid{Msg}\;\Varid{→}\;\Conid{Machine}\;\Varid{→}\;\star}}}.  The sets {\textsmaller[.5]{\ensuremath{\Conid{Node}}}}, {\textsmaller[.5]{\ensuremath{\Conid{Machine}}}}, and {\textsmaller[.5]{\ensuremath{\Conid{Msg}}}} are additional
parameters.  Elements of {\textsmaller[.5]{\ensuremath{\Conid{Node}}}} will act as node identifiers, and we
assume that these enjoy decidable equality. If we were using MPI, they
would correspond to the so called node ranks, which are just machine
integers.  The type {\textsmaller[.5]{\ensuremath{\Conid{Machine}}}} is the type of the nodes'
configurations, and {\textsmaller[.5]{\ensuremath{\Conid{Msg}}}} the type of messages that the machines can
send. The {\textsmaller[.5]{\ensuremath{\Conid{Node}}}} in the type of {\textsmaller[.5]{\ensuremath{{\dummy ⊢ \dummy \xrightarrow[\Varid{Machine}]{\dummy} \dummy}}}} means, intuitively, that
the configuration of a node knows about and can depend on its own
identifier. The type constructor {\textsmaller[.5]{\ensuremath{\Conid{Tagged}}}} is used to separate
different kinds of local transitions: A {\textsmaller[.5]{\ensuremath{\Conid{Tagged}\;\Conid{Msg}}}} can be {\textsmaller[.5]{\ensuremath{\MyConid{silent}}}} (i.e. a 
transition), {\textsmaller[.5]{\ensuremath{\MyConid{send}\;\Varid{msg}}}}, or {\textsmaller[.5]{\ensuremath{\MyConid{receive}\;\Varid{msg}}}} (for {\textsmaller[.5]{\ensuremath{\Varid{msg}\;\mathbin{:}\;\Conid{Msg}}}}).
\iffullversion
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{11}{@{}>{\hspre}l<{\hspost}@{}}\column{16}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{module}\;\Conid{Network}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}(\Conid{Node}\;\mathbin{:}\;\star){}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}(\Varid{\char95 ≟\char95 }\;\mathbin{:}\;{}\<[11]\>[11]{}(\Varid{n}\;\Varid{n'}\;\mathbin{:}\;\Conid{Node})\;\Varid{→}\;\Conid{Dec}\;(\Varid{n}\;\Varid{≡}\;\Varid{n'})){}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\{\mskip1.5mu \Conid{Machine}\;\Conid{Msg}\;\mathbin{:}\;\star\mskip1.5mu\}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}({\dummy ⊢ \dummy \xrightarrow[\Varid{Machine}]{\dummy} \dummy}\;\mathbin{:}\;{}\<[16]\>[16]{}\Conid{Node}\;\Varid{→}\;\Conid{Machine}\;\Varid{→}\;{}\<[E]\\
\>[16]{}\Conid{Tagged}\;\Conid{Msg}\;\Varid{→}\;\Conid{Machine}\;\Varid{→}\;\star){}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Keyword{where}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\fi

\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{GeneralLemmas}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{Relation}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}

A synchronous network ({\textsmaller[.5]{\ensuremath{\Conid{SyncNetwork}}}}) is an indexed family of machines,
{\textsmaller[.5]{\ensuremath{\Conid{Node}\;\Varid{→}\;\Conid{Machine}}}}, representing the nodes of the system.
An asynchronous network ({\textsmaller[.5]{\ensuremath{\Conid{AsyncNetwork}}}}) is an indexed family of machines together with
a list of messages representing the messages currently
in transit, {\textsmaller[.5]{\ensuremath{(\Conid{Node}\;\Varid{→}\;\Conid{Machine})\;\Varid{×}\;\Conid{List}\;\Conid{Msg}}}}.
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{15}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Conid{SyncNetwork}\;{}\<[15]\>[15]{}\mathrel{=}\;\Conid{Node}\;\Varid{→}\;\Conid{Machine}{}\<[E]\\
\>[B]{}\Conid{AsyncNetwork}\;{}\<[15]\>[15]{}\mathrel{=}\;(\Conid{Node}\;\Varid{→}\;\Conid{Machine})\;\Varid{×}\;\Conid{List}\;\Conid{Msg}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}

\iffullversion
The following function updates an element in a set indexed by node
identifiers, and will be used in defining the transition relations for
networks:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{30}{@{}>{\hspre}l<{\hspost}@{}}\column{34}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Varid{update}\;\mathbin{:}\;\{\mskip1.5mu \Conid{A}\;\mathbin{:}\;\star\mskip1.5mu\}\;\Varid{→}\;(\Conid{Node}\;\Varid{→}\;\Conid{A})\;{}\<[34]\>[34]{}\Varid{→}\;\Conid{Node}\;\Varid{→}\;\Conid{A}\;\Varid{→}\;\Conid{Node}\;\Varid{→}\;\Conid{A}{}\<[E]\\
\>[B]{}\Varid{update}\;\Varid{nodes}\;\Varid{n}\;\Varid{m}\;\Varid{n'}\;\Keyword{with}\;\Varid{n'}\;\Varid{≟}\;\Varid{n}{}\<[E]\\
\>[B]{}\Varid{update}\;\Varid{nodes}\;\Varid{n}\;\Varid{m}\;\Varid{n'}\;\mid \;\Varid{yes}\;\Varid{p}\;{}\<[30]\>[30]{}\mathrel{=}\;\Varid{m}{}\<[E]\\
\>[B]{}\Varid{update}\;\Varid{nodes}\;\Varid{n}\;\Varid{m}\;\Varid{n'}\;\mid \;\Varid{no}\;\Varid{¬p}\;{}\<[30]\>[30]{}\mathrel{=}\;\Varid{nodes}\;\Varid{n'}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\fi
\iffullversion
\begin{sidewaysfigure}
\else
\begin{figure*}[!t]
\fi
\centering
\begin{varwidth}[t]{\textwidth}
\iffullversion
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{24}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{data}\;{\dummy\xrightarrow[\Varid{Sync}]{}\dummy}\;(\Varid{nodes}\;\mathbin{:}\;{}\<[24]\>[24]{}\Conid{SyncNetwork})\;\mathbin{:}\;\Conid{SyncNetwork}\;\Varid{→}\;\star\;\Keyword{where}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\removecodespace
\indentcolumn{3}
\fi
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{5}{@{}>{\hspre}l<{\hspost}@{}}\column{16}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}\MyConid{silent-step}\;{}\<[16]\>[16]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{i}\;\Varid{m'}\mskip1.5mu\}\;\Varid{→}\;\Varid{i}⊢\Varid{nodes}\;\Varid{i}\xrightarrow[\Varid{Machine}]{\MyConid{silent}}\Varid{m'}\;\Varid{→}\;\Varid{nodes}\;\xrightarrow[\Varid{Sync}]{}\;\Varid{update}\;\Varid{nodes}\;\Varid{i}\;\Varid{m'}{}\<[E]\\
\>[3]{}\MyConid{comm-step}\;{}\<[16]\>[16]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{s}\;\Varid{r}\;\Varid{msg}\;\Varid{sender'}\;\Varid{receiver'}\mskip1.5mu\}\;\Varid{→}\;\Keyword{let}\;\Varid{nodes'}\;\mathrel{=}\;\Varid{update}\;\Varid{nodes}\;\Varid{s}\;\Varid{sender'}\;\Keyword{in}{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}\Varid{s}⊢\Varid{nodes}\;\Varid{s}\xrightarrow[\Varid{Machine}]{\MyConid{send}\;\Varid{msg}}\Varid{sender'}\;\Varid{→}\;\Varid{r}⊢\Varid{nodes'}\;\Varid{r}\xrightarrow[\Varid{Machine}]{\MyConid{receive}\;\Varid{msg}}\Varid{receiver'}\;\Varid{→}{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}\Varid{nodes}\;\xrightarrow[\Varid{Sync}]{}\;\Varid{update}\;\Varid{nodes'}\;\Varid{r}\;\Varid{receiver'}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\iffullversion
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{18}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{data}\;{\dummy\xrightarrow[\Varid{Async}]{}\dummy}\;\mathbin{:}\;{}\<[18]\>[18]{}\Conid{AsyncNetwork}\;\Varid{→}\;\Conid{AsyncNetwork}\;\Varid{→}\;\star\;\Keyword{where}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\removecodespace
\indentcolumn{3}
\fi
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{5}{@{}>{\hspre}l<{\hspost}@{}}\column{41}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}\MyConid{step}\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{nodes}\mskip1.5mu\}\;\Varid{msgs}_{\Varid{l}}\;\Varid{msgs}_{\Varid{r}}\;\{\mskip1.5mu \Varid{tmsg}\;\Varid{m'}\;\Varid{i}\mskip1.5mu\}\;\Varid{→}\;\Keyword{let}\;(\Varid{msgs}_{\Varid{in}},\Varid{msgs}_{\Varid{out}})\;\mathrel{=}\;\Varid{detag}\;\Varid{tmsg}\;\Keyword{in}{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}\Varid{i}⊢\Varid{nodes}\;\Varid{i}\xrightarrow[\Varid{Machine}]{\Varid{tmsg}}\Varid{m'}\;\Varid{→}{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}(\Varid{nodes},\Varid{msgs}_{\Varid{l}}\;\plus \;\Varid{msgs}_{\Varid{in}}\;\plus \;\Varid{msgs}_{\Varid{r}})\;{}\<[41]\>[41]{}\xrightarrow[\Varid{Async}]{}\;(\Varid{update}\;\Varid{nodes}\;\Varid{i}\;\Varid{m'},\Varid{msgs}_{\Varid{l}}\;\plus \;\Varid{msgs}_{\Varid{out}}\;\plus \;\Varid{msgs}_{\Varid{r}}){}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{varwidth}
\caption{The definition of the transition relations for synchronous and asynchronous networks.}
\label{figure:Networks-step}
\iffullversion
\end{sidewaysfigure}
\else
\end{figure*}
\fi

Fig.~\ref{figure:Networks-step} shows the definition of the transition
relation for synchronous and asynchronous networks.
\ifnotfullversion
It uses
the {\textsmaller[.5]{\ensuremath{\Varid{update}}}} function which updates an element of a family indexed by
nodes (using decidable equality).
\fi

There are two ways for a synchronous network to make a transition. The
first, {\textsmaller[.5]{\ensuremath{\MyConid{silent-step}}}}, occurs when a machine in the network makes a transition
tagged with {\textsmaller[.5]{\ensuremath{\MyConid{silent}}}}, and is allowed at any time.
The second, {\textsmaller[.5]{\ensuremath{\MyConid{comm-step}}}}, is the aforementioned rendezvous. A node {\textsmaller[.5]{\ensuremath{\Varid{s}}}}
first takes a step sending a message, and afterwards a node {\textsmaller[.5]{\ensuremath{\Varid{r}}}} takes a step
receiving the same message. Note that {\textsmaller[.5]{\ensuremath{\Varid{s}}}} and {\textsmaller[.5]{\ensuremath{\Varid{r}}}} are not necessarily
different, i.e. nodes can send messages to themselves.
Asynchronous networks only have one rule, {\textsmaller[.5]{\ensuremath{\MyConid{step}}}}, which can be used if
a node steps with a tagged message that ``agrees''
with the list of messages in transit. The definition is fairly involved, but
the intuition is that if the node \emph{receives} a message, the message has to
be in the list \emph{before} the transition. If the node \emph{sends}
a message, it has to be there \emph{after}. If the node takes a
\emph{silent} step, the list stays the same before and after.
This is what the usage of the {\textsmaller[.5]{\ensuremath{\Varid{detag}}}} function, which creates lists of
input and output messages from a tagged message, achieves:
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{12}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{module}\;\Conid{Tagged}\;\Keyword{where}{}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{GeneralLemmas}\;\Keyword{hiding}\;([\mskip1.5mu \anonymous \mskip1.5mu]){}\<[E]\\
\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{Data.List}\;\Keyword{using}\;([\mskip1.5mu \anonymous \mskip1.5mu]){}\<[E]\\blanklineskip]\>[B]{}\Varid{\char95 invisible\char95 invisible\char95 }\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{a}\;\Varid{b}\;\Varid{c}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{A}\;\mathbin{:}\;\star\;\Varid{a}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{B}\;\mathbin{:}\;\star\;\Varid{b}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{C}\;\mathbin{:}\;\star\;\Varid{c}\mskip1.5mu\}\;{}\<[E]\\
\>[B]{}\hsindent{23}{}\<[23]\>[23]{}\Varid{→}\;\Conid{A}\;\Varid{→}\;(\Conid{A}\;\Varid{→}\;\Conid{B}\;\Varid{→}\;\Conid{C})\;\Varid{→}\;\Conid{B}\;\Varid{→}\;\Conid{C}{}\<[E]\\
\>[B]{}\Varid{a}\;\;\Varid{b}\;\;\Varid{c}\;\mathrel{=}\;\Varid{b}\;\Varid{a}\;\Varid{c}{}\<[E]\\
\>[B]{}\Keyword{data}\;{}\<[7]\>[7]{}\dummy\xrightarrow{\dummy}\dummy\;\Keyword{where}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}
\removecodespace
\iffullversion
\indentcolumn{3}
\rightaligncolumn{5}
\centeraligncolumn{83}
\savecolumns
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{5}{@{}>{\hspre}l<{\hspost}@{}}\column{19}{@{}>{\hspre}l<{\hspost}@{}}\column{83}{@{}>{\hspre}l<{\hspost}@{}}\column{143}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}\MyConid{VAR}\;{}\<[19]\>[19]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{n}\;\Varid{c}\;\Varid{e}\;\Varid{s}\;\Varid{v}\;\Varid{r}\;\Varid{h}_{\Varid{cl}}\;\Varid{h}_{\Varid{cnt}}\mskip1.5mu\}\;\Varid{→}\;\Varid{lookup}\;\Varid{n}\;\Varid{e}\;\Varid{≡}\;\MyConid{just}\;\Varid{v}\;\Varid{→}\;{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}(\MyConid{just}\;(\MyConid{VAR}\;\Varid{n}\;\MyConid{;}\;\Varid{c},\Varid{e},\Varid{s},\Varid{r}),\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}})\;\;{}\<[83]\>[83]{}\xrightarrow{\MyConid{silent}}\;\;{}\<[143]\>[143]{}(\MyConid{just}\;(\Varid{c},\Varid{e},\Varid{v}\;\Varid{∷}\;\Varid{s},\Varid{r}),\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}}){}\<[E]\\
\>[3]{}\MyConid{CLOS}\;{}\<[19]\>[19]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{c'}\;\Varid{c}\;\Varid{e}\;\Varid{s}\;\Varid{r}\;\Varid{h}_{\Varid{cl}}\;\Varid{h}_{\Varid{cnt}}\mskip1.5mu\}\;\Varid{→}\;\Keyword{let}\;(\Varid{h'}_{\Varid{cl}},\Varid{ptr}_{\Varid{cl}})\;\mathrel{=}\;\Varid{h}_{\Varid{cl}}\;\Varid{▸}\;(\Varid{c'},\Varid{e})\;\Keyword{in}{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}(\MyConid{just}\;(\MyConid{CLOS}\;\Varid{c'}\;\MyConid{;}\;\Varid{c},\Varid{e},\Varid{s},\Varid{r}),\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}})\;\;{}\<[83]\>[83]{}\xrightarrow{\MyConid{silent}}\;\;{}\<[143]\>[143]{}(\MyConid{just}\;(\Varid{c},\Varid{e},\MyConid{clos}\;\Varid{ptr}_{\Varid{cl}}\;\Varid{∷}\;\Varid{s},\Varid{r}),\Varid{h'}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}}){}\<[E]\ColumnHook
\end{hscode}\resethooks
\removecodespace
\restorecolumns
\fi
\rightaligncolumn{5}
\centeraligncolumn{83}
\indentcolumn{3}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{5}{@{}>{\hspre}l<{\hspost}@{}}\column{19}{@{}>{\hspre}l<{\hspost}@{}}\column{83}{@{}>{\hspre}l<{\hspost}@{}}\column{143}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}\MyConid{APPL-send}\;{}\<[19]\>[19]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{c}\;\Varid{e}\;\Varid{v}\;\Varid{ptr}_{\Varid{cl}}\;\Varid{s}\;\Varid{r}\;\Varid{h}_{\Varid{cl}}\;\Varid{h}_{\Varid{cnt}}\mskip1.5mu\}\;\Varid{→}\;\Keyword{let}\;(\Varid{h'}_{\Varid{cnt}},\Varid{ptr}_{\Varid{cnt}})\;\mathrel{=}\;\Varid{h}_{\Varid{cnt}}\;\Varid{▸}\;((\Varid{c},\Varid{e}),\Varid{s},\Varid{r})\;\Keyword{in}{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}(\MyConid{just}\;(\MyConid{APPL}\;\MyConid{;}\;\Varid{c},\Varid{e},\Varid{v}\;\Varid{∷}\;\MyConid{clos}\;\Varid{ptr}_{\Varid{cl}}\;\Varid{∷}\;\Varid{s},\Varid{r}),\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}})\;\;{}\<[83]\>[83]{}\xrightarrow{\MyConid{send}\;(\MyConid{APPL}\;\Varid{ptr}_{\Varid{cl}}\;\Varid{v}\;\Varid{ptr}_{\Varid{cnt}})}\;\;{}\<[143]\>[143]{}(\MyConid{nothing},\Varid{h}_{\Varid{cl}},\Varid{h'}_{\Varid{cnt}}){}\<[E]\\
\>[3]{}\MyConid{APPL-receive}\;{}\<[19]\>[19]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{h}_{\Varid{cl}}\;\Varid{h}_{\Varid{cnt}}\;\Varid{ptr}_{\Varid{cl}}\;\Varid{v}\;\Varid{ptr}_{\Varid{cnt}}\;\Varid{c}\;\Varid{e}\mskip1.5mu\}\;\Varid{→}\;\Varid{h}_{\Varid{cl}}\;\mathbin{!}\;\Varid{ptr}_{\Varid{cl}}\;\Varid{≡}\;\MyConid{just}\;(\Varid{c},\Varid{e})\;\Varid{→}\;{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}(\MyConid{nothing},\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}})\;\;{}\<[83]\>[83]{}\xrightarrow{\MyConid{receive}\;(\MyConid{APPL}\;\Varid{ptr}_{\Varid{cl}}\;\Varid{v}\;\Varid{ptr}_{\Varid{cnt}})}\;\;{}\<[143]\>[143]{}(\MyConid{just}\;(\Varid{c},\Varid{v}\;\Varid{∷}\;\Varid{e},[\mskip1.5mu \mskip1.5mu],\MyConid{just}\;\Varid{ptr}_{\Varid{cnt}}),\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}}){}\<[E]\\
\>[3]{}\MyConid{RET-send}\;{}\<[19]\>[19]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{e}\;\Varid{v}\;\Varid{ptr}_{\Varid{cnt}}\;\Varid{h}_{\Varid{cl}}\;\Varid{h}_{\Varid{cnt}}\mskip1.5mu\}\;\Varid{→}\;{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}(\MyConid{just}\;(\MyConid{RET},\Varid{e},\Varid{v}\;\Varid{∷}\;[\mskip1.5mu \mskip1.5mu],\MyConid{just}\;\Varid{ptr}_{\Varid{cnt}}),\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}})\;\;{}\<[83]\>[83]{}\xrightarrow{\MyConid{send}\;(\MyConid{RET}\;\Varid{ptr}_{\Varid{cnt}}\;\Varid{v})}\;\;{}\<[143]\>[143]{}(\MyConid{nothing},\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}}){}\<[E]\\
\>[3]{}\MyConid{RET-receive}\;{}\<[19]\>[19]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{h}_{\Varid{cl}}\;\Varid{h}_{\Varid{cnt}}\;\Varid{ptr}_{\Varid{cnt}}\;\Varid{v}\;\Varid{c}\;\Varid{e}\;\Varid{s}\;\Varid{r}\mskip1.5mu\}\;\Varid{→}\;\Varid{h}_{\Varid{cnt}}\;\mathbin{!}\;\Varid{ptr}_{\Varid{cnt}}\;\Varid{≡}\;\MyConid{just}\;((\Varid{c},\Varid{e}),\Varid{s},\Varid{r})\;\Varid{→}\;{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}(\MyConid{nothing},\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}})\;\;{}\<[83]\>[83]{}\xrightarrow{\MyConid{receive}\;(\MyConid{RET}\;\Varid{ptr}_{\Varid{cnt}}\;\Varid{v})}\;\;{}\<[143]\>[143]{}(\MyConid{just}\;(\Varid{c},\Varid{e},\Varid{v}\;\Varid{∷}\;\Varid{s},\Varid{r}),\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}}){}\<[E]\ColumnHook
\end{hscode}\resethooks
\iffullversion
\removecodespace
\restorecolumns
\rightaligncolumn{5}
\centeraligncolumn{83}
\indentcolumn{3}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{5}{@{}>{\hspre}l<{\hspost}@{}}\column{6}{@{}>{\hspre}l<{\hspost}@{}}\column{19}{@{}>{\hspre}l<{\hspost}@{}}\column{83}{@{}>{\hspre}l<{\hspost}@{}}\column{143}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}\MyConid{COND-0}\;{}\<[19]\>[19]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{c}\;\Varid{c'}\;\Varid{e}\;\Varid{s}\;\Varid{r}\;\Varid{h}_{\Varid{cl}}\;\Varid{h}_{\Varid{cnt}}\mskip1.5mu\}\;\Varid{→}\;{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}(\MyConid{just}\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'},\Varid{e},\MyConid{nat}\;\Varid{0}\;\Varid{∷}\;\Varid{s},\Varid{r}),\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}})\;\;{}\<[83]\>[83]{}\xrightarrow{\MyConid{silent}}\;\;{}\<[143]\>[143]{}(\MyConid{just}\;(\Varid{c},\Varid{e},\Varid{s},\Varid{r}),\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}}){}\<[E]\\
\>[3]{}\MyConid{COND-1+n}\;{}\<[19]\>[19]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{c}\;\Varid{c'}\;\Varid{e}\;\Varid{n}\;\Varid{s}\;\Varid{r}\;\Varid{h}_{\Varid{cl}}\;\Varid{h}_{\Varid{cnt}}\mskip1.5mu\}\;\Varid{→}\;{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}(\MyConid{just}\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'},\Varid{e},\MyConid{nat}\;(1+\;\Varid{n})\;\Varid{∷}\;\Varid{s},\Varid{r}),\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}})\;\;{}\<[83]\>[83]{}\xrightarrow{\MyConid{silent}}\;\;{}\<[143]\>[143]{}(\MyConid{just}\;(\Varid{c'},\Varid{e},\Varid{s},\Varid{r}),\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}}){}\<[E]\\
\>[3]{}\MyConid{LIT}\;{}\<[19]\>[19]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{l}\;\Varid{c}\;\Varid{e}\;\Varid{s}\;\Varid{r}\;\Varid{h}_{\Varid{cl}}\;\Varid{h}_{\Varid{cnt}}\mskip1.5mu\}\;\Varid{→}\;{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}(\MyConid{just}\;(\MyConid{LIT}\;\Varid{l}\;\MyConid{;}\;\Varid{c},\Varid{e},\Varid{s},\Varid{r}),\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}})\;\;{}\<[83]\>[83]{}\xrightarrow{\MyConid{silent}}\;\;{}\<[143]\>[143]{}(\MyConid{just}\;(\Varid{c},\Varid{e},\MyConid{nat}\;\Varid{l}\;\Varid{∷}\;\Varid{s},\Varid{r}),\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}}){}\<[E]\\
\>[3]{}\MyConid{OP}\;{}\<[19]\>[19]{}\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{f}\;\Varid{c}\;\Varid{e}\;\Varid{l₁}\;\Varid{l₂}\;\Varid{s}\;\Varid{r}\;\Varid{h}_{\Varid{cl}}\;\Varid{h}_{\Varid{cnt}}\mskip1.5mu\}\;\Varid{→}\;{}\<[E]\\
\>[3]{}\hsindent{3}{}\<[6]\>[6]{}(\MyConid{just}\;(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{c},\Varid{e},\MyConid{nat}\;\Varid{l₁}\;\Varid{∷}\;\MyConid{nat}\;\Varid{l₂}\;\Varid{∷}\;\Varid{s},\Varid{r}),\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}})\;\;{}\<[83]\>[83]{}\xrightarrow{\MyConid{silent}}\;\;{}\<[143]\>[143]{}(\MyConid{just}\;(\Varid{c},\Varid{e},\MyConid{nat}\;(\Varid{f}\;\Varid{l₁}\;\Varid{l₂})\;\Varid{∷}\;\Varid{s},\Varid{r}),\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}}){}\<[E]\ColumnHook
\end{hscode}\resethooks
\fi
\removecodespace
\iffullversion
\caption{The definition of the transition relation of the \DCESHi{} machine.}
\else
\caption{The definition of the transition relation of the \DCESHi{} machine (excerpt).}
\fi
\label{figure:ADCESH-step}
\end{varwidth}
\iffullversion
\end{sidewaysfigure}
\else
\end{figure*}
\fi

Fig.~\ref{figure:ADCESH-step} defines the transition relation for the
\DCESHi{} machine, written {\textsmaller[.5]{\ensuremath{\Varid{m}\;\;\xrightarrow{\Varid{tmsg}}\;\;\Varid{m'}}}}
for a tagged message {\textsmaller[.5]{\ensuremath{\Varid{tmsg}}}} and machine configurations {\textsmaller[.5]{\ensuremath{\Varid{m}}}} and {\textsmaller[.5]{\ensuremath{\Varid{m'}}}}.
Most transitions are the same as in the CESH machine, just
framed with the additional heaps and the {\textsmaller[.5]{\ensuremath{\MyConid{just}}}} meaning that
the thread is running.
\ifnotfullversion
  We elide them for brevity.
\fi
The interesting rules are the decomposed application and return rules.  When an
application is performed, an {\textsmaller[.5]{\ensuremath{\MyConid{APPL}}}} message containing a pointer
to the closure to apply, the argument value and a pointer to a return continuation (which
is first allocated) is sent, and the thread is stopped (represented by the {\textsmaller[.5]{\ensuremath{\MyConid{nothing}}}}).
The machine can receive an application message if the thread is not running.
When that happens, the closure pointer is dereferenced and
entered, adding the received argument to the
environment. The stack is left empty apart from the continuation
pointer of the received message.
When returning from a function application, the machine sends a return
message containing the continuation pointer and the value to return.
On the receiving end of that communication, it dereferences the
continuation pointer and enters it, putting the result value on top of
the stack.

\begin{example}
We show what happens when we have instantiated the asynchronous networks of
the {\textsmaller[.5]{\ensuremath{\Conid{Network}}}} module with this transition relation, using the unit (one-element)
type for the {\textsmaller[.5]{\ensuremath{\Conid{Node}}}} set. Once again we trace the execution of our
running example, {\textsmaller[.5]{\ensuremath{\Varid{codeExample}}}}.
For readability, we write heaps with pointer mappings like {\textsmaller[.5]{\ensuremath{\{\mskip1.5mu \Varid{ptr}\;\Varid{↦}\;\Varid{element}\mskip1.5mu\}}}}.  The last list shown in each step is the message list of
the asynchronous network.
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{6}{@{}>{\hspre}l<{\hspost}@{}}\column{10}{@{}>{\hspre}l<{\hspost}@{}}\column{13}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{let}\;{}\<[6]\>[6]{}\Varid{h}_{\Varid{cl}}\;{}\<[13]\>[13]{}\mathrel{=}\;\{\mskip1.5mu \Varid{ptr₁}\;\Varid{↦}\;(\Varid{c₁},[\mskip1.5mu \mskip1.5mu])\mskip1.5mu\}{}\<[E]\\
\>[6]{}\Varid{h'}_{\Varid{cl}}\;{}\<[13]\>[13]{}\mathrel{=}\;\{\mskip1.5mu \Varid{ptr₁}\;\Varid{↦}\;(\Varid{c₁},[\mskip1.5mu \mskip1.5mu]),\Varid{ptr₂}\;\Varid{↦}\;(\Varid{c₂},[\mskip1.5mu \mskip1.5mu])\mskip1.5mu\}{}\<[E]\\
\>[6]{}\Varid{h}_{\Varid{cnt}}\;{}\<[13]\>[13]{}\mathrel{=}\;\{\mskip1.5mu \Varid{ptr}_{\Varid{cnt}}\;\Varid{↦}\;((\MyConid{END},[\mskip1.5mu \mskip1.5mu]),[\mskip1.5mu \mskip1.5mu],\MyConid{nothing})\mskip1.5mu\}{}\<[E]\\
\>[B]{}\Keyword{in}\;(\MyConid{just}\;({}\<[13]\>[13]{}\MyConid{CLOS}\;\Varid{c₁}\;\MyConid{;}\;\MyConid{CLOS}\;\Varid{c₂}\;\MyConid{;}\;\MyConid{APPL}\;\MyConid{;}\;\MyConid{END},[\mskip1.5mu \mskip1.5mu],[\mskip1.5mu \mskip1.5mu],{}\<[E]\\
\>[13]{}\MyConid{nothing}),\Varid{∅},\Varid{∅}),[\mskip1.5mu \mskip1.5mu]{}\<[E]\\
\>[B]{}\Varid{⟶⟨}\;\MyConid{step}\;\MyConid{CLOS}\;\Varid{⟩}{}\<[E]\\
\>[B]{}(\MyConid{just}\;({}\<[10]\>[10]{}\MyConid{CLOS}\;\Varid{c₂}\;\MyConid{;}\;\MyConid{APPL}\;\MyConid{;}\;\MyConid{END},[\mskip1.5mu \mskip1.5mu],[\mskip1.5mu \MyConid{clos}\;\Varid{ptr₁}\mskip1.5mu],{}\<[E]\\
\>[10]{}\MyConid{nothing}),\Varid{h}_{\Varid{cl}},\Varid{∅}),[\mskip1.5mu \mskip1.5mu]{}\<[E]\\
\>[B]{}\Varid{⟶⟨}\;\MyConid{step}\;\MyConid{CLOS}\;\Varid{⟩}{}\<[E]\\
\>[B]{}(\MyConid{just}\;({}\<[10]\>[10]{}\MyConid{APPL}\;\MyConid{;}\;\MyConid{END},[\mskip1.5mu \mskip1.5mu],[\mskip1.5mu \MyConid{clos}\;\Varid{ptr₂},\MyConid{clos}\;\Varid{ptr₁}\mskip1.5mu],{}\<[E]\\
\>[10]{}\MyConid{nothing}),\Varid{h'}_{\Varid{cl}},\Varid{∅}),[\mskip1.5mu \mskip1.5mu]{}\<[E]\\
\>[B]{}\Varid{⟶⟨}\;\MyConid{step}\;\MyConid{APPL-send}\;\Varid{⟩}{}\<[E]\\
\>[B]{}(\MyConid{nothing},\Varid{h'}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}}),[\mskip1.5mu \MyConid{APPL}\;\Varid{ptr₁}\;(\MyConid{clos}\;\Varid{ptr₂})\;\Varid{ptr}_{\Varid{cnt}}\mskip1.5mu]{}\<[E]\\
\>[B]{}\Varid{⟶⟨}\;\MyConid{step}\;\MyConid{APPL-receive}\;\Varid{⟩}{}\<[E]\\
\>[B]{}(\MyConid{just}\;({}\<[10]\>[10]{}\MyConid{VAR}\;\Varid{0}\;\MyConid{;}\;\MyConid{RET},[\mskip1.5mu \MyConid{clos}\;\Varid{ptr₂}\mskip1.5mu],[\mskip1.5mu \mskip1.5mu],{}\<[E]\\
\>[10]{}\MyConid{just}\;\Varid{ptr}_{\Varid{cnt}}),\Varid{h'}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}}),[\mskip1.5mu \mskip1.5mu]{}\<[E]\\
\>[B]{}\Varid{⟶⟨}\;\MyConid{step}\;(\MyConid{VAR}\;\Varid{refl})\;\Varid{⟩}{}\<[E]\\
\>[B]{}(\MyConid{just}\;({}\<[10]\>[10]{}\MyConid{RET},[\mskip1.5mu \MyConid{clos}\;\Varid{ptr₂}\mskip1.5mu],[\mskip1.5mu \MyConid{clos}\;\Varid{ptr₂}\mskip1.5mu],{}\<[E]\\
\>[10]{}\MyConid{just}\;\Varid{ptr}_{\Varid{cnt}}),\Varid{h'}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}}),[\mskip1.5mu \mskip1.5mu]{}\<[E]\\
\>[B]{}\Varid{⟶⟨}\;\MyConid{step}\;\MyConid{RET-send}\;\Varid{⟩}{}\<[E]\\
\>[B]{}(\MyConid{nothing},\Varid{h'}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}}),[\mskip1.5mu \MyConid{RET}\;\Varid{ptr}_{\Varid{cnt}}\;(\MyConid{clos}\;\Varid{ptr₂})\mskip1.5mu]{}\<[E]\\
\>[B]{}\Varid{⟶⟨}\;\MyConid{step}\;\MyConid{RET-receive}\;\Varid{⟩}{}\<[E]\\
\>[B]{}(\MyConid{just}\;(\MyConid{END},[\mskip1.5mu \mskip1.5mu],[\mskip1.5mu \MyConid{clos}\;\Varid{ptr₂}\mskip1.5mu],\MyConid{nothing}),\Varid{h'}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}}),[\mskip1.5mu \mskip1.5mu]{}\<[E]\ColumnHook
\end{hscode}\resethooks
  Comparing this to Example~\ref{example:CES} we can see that an
  {\textsmaller[.5]{\ensuremath{\MyConid{APPL-send}}}} followed by an {\textsmaller[.5]{\ensuremath{\MyConid{APPL-receive}}}} amounts to the same
  thing as the {\textsmaller[.5]{\ensuremath{\MyConid{APPL}}}} rule in the CES machine, and similarly for the
  {\textsmaller[.5]{\ensuremath{\MyConid{RET}}}} instruction.
\end{example}

\section{\DCESHn: The distributed CESH machine} \label{section:DCESH}

\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{GeneralLemmas}\;\Keyword{using}\;(\Conid{Dec};\Varid{\char95 ≡\char95 }){}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}

We have so far seen two extensions of the CES machine. We have seen
CESH, that adds heaps, and \DCESHi{}, that decomposes instructions
into communication in a degenerate network of only one node.
Our final extension is a machine, \DCESHn{}, that supports multiple nodes.
The main problem that we now face is that there is no centralised heap,
but each node has its own local heap. This means that, for
supporting higher-order functions across node boundaries, we have to
somehow keep references to closures in the heaps of \emph{other} nodes.
Another problem is efficiency; we would like a system where we do
not pay the higher price of communication for locally running code.
The main idea for solving these two problems is to use
\emph{remote pointers}, {\textsmaller[.5]{\ensuremath{\Conid{RPtr}\;\mathrel{=}\;\Conid{Ptr}\;\Varid{×}\;\Conid{Node}}}}, pointers paired with node
identifiers signifying on what node's heap the pointer is located.
This solves the heap problem because we always know
where a pointer comes from. It can also be used to solve the
efficiency problem since we can choose what instructions to run based on
whether a pointer is local or remote. If it is local, we run the
rules of the CESH machine. If it is remote, we run the
decomposed rules of the \DCESHi{} machine.

The final extension to the term language and bytecode will
add support for locus specifiers.
\ifnotfullversion
We add a term construct {\textsmaller[.5]{\ensuremath{\Varid{t}\;\MyConid{}\;\Varid{i}}}},
and an instruction {\textsmaller[.5]{\ensuremath{\MyConid{REMOTE}\;\Varid{c}\;\Varid{i}}}} for its compilation.
\else
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{9}{@{}>{\hspre}l<{\hspost}@{}}\column{12}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{data}\;\Conid{Term}\;\mathbin{:}\;\star\;\Keyword{where}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{...}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}{\dummy\MyConid{}\dummy}\;{}\<[9]\>[9]{}\mathbin{:}\;\Conid{Term}\;\Varid{→}\;\Conid{Node}\;\Varid{→}\;\Conid{Term}{}\<[E]\\
\>[B]{}\Keyword{data}\;\Conid{Instr}\;\mathbin{:}\;\star\;\Keyword{where}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{...}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\MyConid{REMOTE}\;{}\<[12]\>[12]{}\mathbin{:}\;\Conid{Code}\;\Varid{→}\;\Conid{Node}\;\Varid{→}\;\Conid{Instr}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\fi
The locus specifiers, {\textsmaller[.5]{\ensuremath{\Varid{t}\;\MyConid{}\;\Varid{i}}}}, are taken to mean that the
term {\textsmaller[.5]{\ensuremath{\Varid{t}}}} should be evaluated on node {\textsmaller[.5]{\ensuremath{\Varid{i}}}}.  For simplicity, we assume
that the terms {\textsmaller[.5]{\ensuremath{\Varid{t}}}} in all locus specification sub-terms {\textsmaller[.5]{\ensuremath{\Varid{t}\;\MyConid{}\;\Varid{i}}}} are
\emph{closed}.  This is a reasonable
assumption, since a term where this does not hold can be transformed
into one where it does with roughly similar behaviour, using
e.g. lambda lifting~\cite{DBLP:conf/fpca/Johnsson85}
\iffullversion
\footnote{Transform every sub-term {\textsmaller[.5]{\ensuremath{\Varid{t}\;\MyConid{}\;\Varid{i}}}} to {\textsmaller[.5]{\ensuremath{\Varid{t'}\;\mathrel{=}\;((\Varid{λ}\;\Varid{fv}\;\Varid{t.}\;\Varid{t})\;\MyConid{}\;\Varid{i})\;(\Varid{fv}\;\Varid{t})}}}.
These have ``roughly similar behaviour'' in that the semantics of
{\textsmaller[.5]{\ensuremath{\Varid{t}}}} and {\textsmaller[.5]{\ensuremath{\Varid{t'}}}} are identical under the assumption that locus specifiers
do not change the meaning of a program.
}.
\else
(transform every sub-term {\textsmaller[.5]{\ensuremath{\Varid{t}\;\MyConid{}\;\Varid{i}}}} to {\textsmaller[.5]{\ensuremath{\Varid{t'}\;\mathrel{=}\;((\Varid{λ}\;\Varid{fv}\;\Varid{t.}\;\Varid{t})\;\MyConid{}\;\Varid{i})\;(\Varid{fv}\;\Varid{t})}}}).
\fi
The {\textsmaller[.5]{\ensuremath{\MyConid{REMOTE}\;\Varid{c}\;\Varid{i}}}}
instruction will be used to start running a code fragment {\textsmaller[.5]{\ensuremath{\Varid{c}}}} on node
{\textsmaller[.5]{\ensuremath{\Varid{i}}}} in the network.  We also extend the {\textsmaller[.5]{\ensuremath{\Varid{compile'}}}} function to handle
the new term construct:
\iffullversion
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Varid{compile'}\;\mathbin{:}\;\Conid{Term}\;\Varid{→}\;\Conid{Code}\;\Varid{→}\;\Conid{Code}{}\<[E]\\
\>[B]{}\Varid{...}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\removecodespace
\fi
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{20}{@{}>{\hspre}l<{\hspost}@{}}\column{23}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Varid{compile'}\;(\Varid{t}\;\MyConid{}\;\Varid{i})\;{}\<[20]\>[20]{}\Varid{c}\;{}\<[23]\>[23]{}\mathrel{=}\;\MyConid{REMOTE}\;(\Varid{compile'}\;\Varid{t}\;\MyConid{RET})\;\Varid{i}\;\MyConid{;}\;\Varid{c}{}\<[E]\ColumnHook
\end{hscode}\resethooks
Note that we reuse the {\textsmaller[.5]{\ensuremath{\MyConid{RET}}}} instruction to return from a remote
computation.

\iffullversion
Once again we assume that we are given a set {\textsmaller[.5]{\ensuremath{\Conid{Node}}}} with decidable
equality:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{module}\;\Conid{DCESH}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}(\Conid{Node}\;\mathbin{:}\;\star){}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}(\Varid{\char95 ≟\char95 }\;\mathbin{:}\;(\Varid{n}\;\Varid{n'}\;\mathbin{:}\;\Conid{Node})\;\Varid{→}\;\Conid{Dec}\;(\Varid{n}\;\Varid{≡}\;\Varid{n'})){}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Keyword{where}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\fi

\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{GeneralLemmas}{}\<[E]\\blanklineskip]\>[B]{}\Keyword{data}\;{}\<[7]\>[7]{}\Varid{⟶Machine}\;(\Varid{i}\;\mathbin{:}\;\Conid{Node})\;\mathbin{:}\;\Conid{Machine}\;\Varid{→}\;\Conid{Tagged}\;\Conid{Msg}\;\Varid{→}\;\Conid{Machine}\;\Varid{→}\;\star{}\<[E]\\
\>[B]{}\Varid{⟶Machineformat\char95 }\;\mathbin{:}\;\Conid{Tagged}\;\Conid{Msg}\;\Varid{→}\;\Conid{Node}\;\Varid{→}\;\Conid{Machine}\;\Varid{→}\;\Conid{Machine}\;\Varid{→}\;\star{}\<[E]\\
\>[B]{}\xrightarrow{\Varid{msg}}\;\Varid{i}\;\Varid{a}\;\Varid{b}\;\mathrel{=}\;\Varid{⟶Machine}\;\Varid{i}\;\Varid{a}\;\Varid{msg}\;\Varid{b}{}\<[E]\\
\>[B]{}\Varid{\char95 ⊢\char95 invisible\char95 invisible\char95 }\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{a}\;\Varid{b}\;\Varid{c}\;\Varid{d}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{A}\;\mathbin{:}\;\star\;\Varid{a}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{B}\;\mathbin{:}\;\star\;\Varid{b}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{C}\;\mathbin{:}\;\star\;\Varid{c}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{D}\;\mathbin{:}\;\star\;\Varid{d}\mskip1.5mu\}\;{}\<[E]\\
\>[B]{}\hsindent{23}{}\<[23]\>[23]{}\Varid{→}\;\Conid{A}\;\Varid{→}\;\Conid{B}\;\Varid{→}\;(\Conid{A}\;\Varid{→}\;\Conid{B}\;\Varid{→}\;\Conid{C}\;\Varid{→}\;\Conid{D})\;\Varid{→}\;\Conid{C}\;\Varid{→}\;\Conid{D}{}\<[E]\\
\>[B]{}\Varid{a}\;\Varid{⊢}\;\Varid{b}\;\;\Varid{c}\;\;\Varid{d}\;\mathrel{=}\;\Varid{c}\;\Varid{a}\;\Varid{b}\;\Varid{d}{}\<[E]\\blanklineskip]\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{GeneralLemmas}{}\<[E]\\blanklineskip]\>[B]{}\Varid{⟶<send>-deterministic}\;\mathbin{:}\;\Varid{∀}\;\Varid{n}\;\Varid{→}\;(\Varid{λ}\;\Varid{m}\;\Varid{msg},\Varid{m'}\;\Varid{→}\;\Varid{⟶Machine}\;\Varid{n}\;\Varid{m}\;(\MyConid{send}\;(\Varid{proj₁}\;\Varid{msg},\Varid{m'}))\;(\Varid{proj₂}\;\Varid{msg},\Varid{m'}))\;\Varid{is-deterministic}{}\<[E]\\
\>[B]{}\Varid{⟶<send>-deterministic}\;\Varid{n}\;\MyConid{REMOTE-send}\;\MyConid{REMOTE-send}\;\mathrel{=}\;\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{⟶<send>-deterministic}\;\Varid{n}\;(\MyConid{APPL-send}\;\anonymous )\;(\MyConid{APPL-send}\;\anonymous )\;\mathrel{=}\;\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{⟶<send>-deterministic}\;\Varid{n}\;\MyConid{RET-send}\;\MyConid{RET-send}\;\mathrel{=}\;\Varid{refl}{}\<[E]\\blanklineskip]\>[B]{}\Varid{⟶<tmsg>-deterministic}\;\mathbin{:}\;\Varid{∀}\;\Varid{n}\;\Varid{tmsg}\;\Varid{→}\;(\Varid{λ}\;\Varid{m}\;\Varid{m'}\;\Varid{→}\;\Varid{⟶Machine}\;\Varid{n}\;\Varid{m}\;\Varid{tmsg}\;\Varid{m'})\;\Varid{is-deterministic}{}\<[E]\\
\>[B]{}\Varid{⟶<tmsg>-deterministic}\;\Varid{n}\;\MyConid{silent}\;{}\<[39]\>[39]{}\Varid{st}\;\Varid{st'}\;\mathrel{=}\;\Varid{⟶<silent>-deterministic}\;\Varid{n}\;\Varid{st}\;\Varid{st'}{}\<[E]\\
\>[B]{}\Varid{⟶<tmsg>-deterministic}\;\Varid{n}\;(\MyConid{send}\;\Varid{msg})\;{}\<[39]\>[39]{}\Varid{st}\;\Varid{st'}\;\mathrel{=}\;\Varid{proj₂}\;(,\Varid{-inj}\;(\Varid{⟶<send>-deterministic}\;\Varid{n}\;\Varid{st}\;\Varid{st'})){}\<[E]\\
\>[B]{}\Varid{⟶<tmsg>-deterministic}\;\Varid{n}\;(\MyConid{receive}\;\Varid{msg})\;\Varid{st}\;\Varid{st'}\;\mathrel{=}\;\Varid{⟶<receive>-deterministic}\;\Varid{n}\;\Varid{msg}\;\Varid{st}\;\Varid{st'}{}\<[E]\\blanklineskip]\>[B]{}\mbox{\onelinecomment  Lemmas for updating}{}\<[E]\\
\>[B]{}\Varid{update-look}\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Conid{A}\mskip1.5mu\}\;(\Varid{nodes}\;\mathbin{:}\;\Conid{Node}\;\Varid{→}\;\Conid{A})\;\Varid{n}\;\Varid{a}\;\Varid{→}\;\Varid{update}\;\Varid{nodes}\;\Varid{n}\;\Varid{a}\;\Varid{n}\;\Varid{≡}\;\Varid{a}{}\<[E]\\
\>[B]{}\Varid{update-look}\;\Varid{nodes}\;\Varid{n}\;\Varid{a}\;\Keyword{with}\;\Varid{n}\;\Varid{≟}\;\Varid{n}{}\<[E]\\
\>[B]{}\Varid{update-look}\;\Varid{nodes}\;\Varid{n}\;\Varid{a}\;\mid \;\Varid{yes}\;\Varid{p}\;\mathrel{=}\;\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{update-look}\;\Varid{nodes}\;\Varid{n}\;\Varid{a}\;\mid \;\Varid{no}\;\Varid{¬p}\;\mathrel{=}\;\Varid{⊥-elim}\;(\Varid{¬p}\;\Varid{refl}){}\<[E]\\blanklineskip]\>[B]{}\Varid{m⟶<send>nothing}\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{n}\;\Varid{m}\;\Varid{msg}\;\Varid{m'}\mskip1.5mu\}\;\Varid{→}\;\Varid{⟶Machine}\;\Varid{n}\;\Varid{m}\;(\MyConid{send}\;\Varid{msg})\;\Varid{m'}\;\Varid{→}\;\Varid{m'}\;\Varid{≡}\;\MyConid{nothing},\Varid{proj₂}\;\Varid{m'}{}\<[E]\\
\>[B]{}\Varid{m⟶<send>nothing}\;\MyConid{REMOTE-send}\;\mathrel{=}\;\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{m⟶<send>nothing}\;(\MyConid{APPL-send}\;\anonymous )\;\mathrel{=}\;\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{m⟶<send>nothing}\;\MyConid{RET-send}\;\mathrel{=}\;\Varid{refl}{}\<[E]\\blanklineskip]\>[B]{}\Varid{m⟶<silent>just}\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{n}\;\Varid{m}\;\Varid{m'}\mskip1.5mu\}\;\Varid{→}\;\Varid{⟶Machine}\;\Varid{n}\;\Varid{m}\;\MyConid{silent}\;\Varid{m'}\;\Varid{→}\;\Varid{∃}\;\Varid{λ}\;\Varid{m''}\;\Varid{→}\;\Varid{m'}\;\Varid{≡}\;\MyConid{just}\;\Varid{m''},\Varid{proj₂}\;\Varid{m'}{}\<[E]\\
\>[B]{}\Varid{m⟶<silent>just}\;(\MyConid{VAR}\;\Varid{x})\;\mathrel{=}\;\anonymous ,\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{m⟶<silent>just}\;\MyConid{CLOS}\;\mathrel{=}\;\anonymous ,\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{m⟶<silent>just}\;(\MyConid{APPL}\;\anonymous )\;\mathrel{=}\;\anonymous ,\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{m⟶<silent>just}\;\MyConid{RET}\;\mathrel{=}\;\anonymous ,\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{m⟶<silent>just}\;\MyConid{LIT}\;\mathrel{=}\;\anonymous ,\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{m⟶<silent>just}\;\MyConid{OP}\;\mathrel{=}\;\anonymous ,\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{m⟶<silent>just}\;\MyConid{COND-0}\;\mathrel{=}\;\anonymous ,\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{m⟶<silent>just}\;\MyConid{COND-1+n}\;\mathrel{=}\;\anonymous ,\Varid{refl}{}\<[E]\\blanklineskip]\>[B]{}\Varid{m⟶<receive>just}\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{n}\;\Varid{m}\;\Varid{m'}\;\Varid{msg}\mskip1.5mu\}\;\Varid{→}\;\Varid{⟶Machine}\;\Varid{n}\;\Varid{m}\;(\MyConid{receive}\;\Varid{msg})\;\Varid{m'}\;\Varid{→}\;\Varid{∃}\;\Varid{λ}\;\Varid{m''}\;\Varid{→}\;\Varid{m'}\;\Varid{≡}\;\MyConid{just}\;\Varid{m''},\Varid{proj₂}\;\Varid{m'}{}\<[E]\\
\>[B]{}\Varid{m⟶<receive>just}\;\MyConid{REMOTE-receive}\;\mathrel{=}\;\anonymous ,\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{m⟶<receive>just}\;(\MyConid{APPL-receive}\;\Varid{x})\;\mathrel{=}\;\anonymous ,\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{m⟶<receive>just}\;(\MyConid{RET-receive}\;\Varid{x})\;\mathrel{=}\;\anonymous ,\Varid{refl}{}\<[E]\\blanklineskip]\>[B]{}\Varid{all-inactive-¬just}\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Conid{A}\mskip1.5mu\}\;\Varid{ms}\;(\Varid{n}\;\mathbin{:}\;\Conid{A})\;\{\mskip1.5mu \Varid{x}\;\Varid{hs}\mskip1.5mu\}\;\Varid{→}\;\Varid{all}\;\Varid{ms}\;\Varid{are}\;\Varid{inactive}\;\Varid{→}\;\Varid{ms}\;\Varid{n}\;\Varid{≢}\;\MyConid{just}\;\Varid{x},\Varid{hs}{}\<[E]\\
\>[B]{}\Varid{all-inactive-¬just}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\Varid{eq}\;\mathrel{=}\;\Varid{nothing≠just}\;(\Varid{trans}\;(\Varid{sym}\;(\Varid{ia}\;\Varid{n}))\;(\Varid{proj₁}\;(,\Varid{-inj}\;\Varid{eq}))){}\<[E]\\blanklineskip]\>[B]{}\Varid{all-inactive-¬silent}\;\mathbin{:}\;\Varid{∀}\;\Varid{ms}\;\Varid{n}\;\{\mskip1.5mu \Varid{msn'}\mskip1.5mu\}\;\Varid{→}\;\Varid{all}\;\Varid{ms}\;\Varid{are}\;\Varid{inactive}\;\Varid{→}\;\Varid{¬}\;(\Varid{⟶Machine}\;\Varid{n}\;(\Varid{ms}\;\Varid{n})\;\MyConid{silent}\;\Varid{msn'}){}\<[E]\\
\>[B]{}\Varid{all-inactive-¬silent}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\Varid{st}\;\Keyword{with}\;\Varid{ms}\;\Varid{n}\;\mid \;\Varid{inspect}\;\Varid{ms}\;\Varid{n}{}\<[E]\\
\>[B]{}\Varid{all-inactive-¬silent}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;(\MyConid{VAR}\;\Varid{x})\;{}\<[41]\>[41]{}\mid \;\Varid{.\char95 }\;\mid \;[\mskip1.5mu \Varid{eq}\mskip1.5mu]\;\mathrel{=}\;\Varid{all-inactive-¬just}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\Varid{eq}{}\<[E]\\
\>[B]{}\Varid{all-inactive-¬silent}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\MyConid{CLOS}\;{}\<[41]\>[41]{}\mid \;\Varid{.\char95 }\;\mid \;[\mskip1.5mu \Varid{eq}\mskip1.5mu]\;\mathrel{=}\;\Varid{all-inactive-¬just}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\Varid{eq}{}\<[E]\\
\>[B]{}\Varid{all-inactive-¬silent}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;(\MyConid{APPL}\;\anonymous )\;{}\<[41]\>[41]{}\mid \;\Varid{.\char95 }\;\mid \;[\mskip1.5mu \Varid{eq}\mskip1.5mu]\;\mathrel{=}\;\Varid{all-inactive-¬just}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\Varid{eq}{}\<[E]\\
\>[B]{}\Varid{all-inactive-¬silent}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\MyConid{RET}\;{}\<[41]\>[41]{}\mid \;\Varid{.\char95 }\;\mid \;[\mskip1.5mu \Varid{eq}\mskip1.5mu]\;\mathrel{=}\;\Varid{all-inactive-¬just}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\Varid{eq}{}\<[E]\\
\>[B]{}\Varid{all-inactive-¬silent}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\MyConid{LIT}\;{}\<[41]\>[41]{}\mid \;\Varid{.\char95 }\;\mid \;[\mskip1.5mu \Varid{eq}\mskip1.5mu]\;\mathrel{=}\;\Varid{all-inactive-¬just}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\Varid{eq}{}\<[E]\\
\>[B]{}\Varid{all-inactive-¬silent}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\MyConid{OP}\;{}\<[41]\>[41]{}\mid \;\Varid{.\char95 }\;\mid \;[\mskip1.5mu \Varid{eq}\mskip1.5mu]\;\mathrel{=}\;\Varid{all-inactive-¬just}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\Varid{eq}{}\<[E]\\
\>[B]{}\Varid{all-inactive-¬silent}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\MyConid{COND-0}\;{}\<[41]\>[41]{}\mid \;\Varid{.\char95 }\;\mid \;[\mskip1.5mu \Varid{eq}\mskip1.5mu]\;\mathrel{=}\;\Varid{all-inactive-¬just}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\Varid{eq}{}\<[E]\\
\>[B]{}\Varid{all-inactive-¬silent}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\MyConid{COND-1+n}\;{}\<[41]\>[41]{}\mid \;\Varid{.\char95 }\;\mid \;[\mskip1.5mu \Varid{eq}\mskip1.5mu]\;\mathrel{=}\;\Varid{all-inactive-¬just}\;\Varid{ms}\;\Varid{n}\;\Varid{ia}\;\Varid{eq}{}\<[E]\\blanklineskip]\>[B]{}\Varid{all-to-all-except}\;\mathbin{:}\;\Varid{∀}\;\Varid{nodes}\;\Varid{n}\;\{\mskip1.5mu \Varid{x}\;\Varid{hs}\mskip1.5mu\}\;\Varid{→}\;\Varid{all}\;\Varid{nodes}\;\Varid{are}\;\Varid{inactive}\;\Varid{→}\;\Varid{all}\;(\Varid{update}\;\Varid{nodes}\;\Varid{n}\;(\MyConid{just}\;\Varid{x},\Varid{hs}))\;\Varid{except}\;\Varid{n}\;\Varid{are}\;\Varid{inactive}{}\<[E]\\
\>[B]{}\Varid{all-to-all-except}\;\Varid{nodes}\;\Varid{n}\;\Varid{ia}\;\Varid{n'}\;\Varid{n'≠n}\;\Keyword{with}\;\Varid{n'}\;\Varid{≟}\;\Varid{n}{}\<[E]\\
\>[B]{}\Varid{...}\;\mid \;\Varid{yes}\;\Varid{p}\;\mathrel{=}\;\Varid{⊥-elim}\;(\Varid{n'≠n}\;\Varid{p}){}\<[E]\\
\>[B]{}\Varid{...}\;\mid \;\Varid{no}\;\Varid{¬p}\;\mathrel{=}\;\Varid{ia}\;\Varid{n'}{}\<[E]\\blanklineskip]\>[B]{}\Varid{all-except-find}\;\mathbin{:}\;\Varid{∀}\;\Varid{nodes}\;\Varid{n}\;\Varid{n'}\;\{\mskip1.5mu \Varid{x}\mskip1.5mu\}\;\Varid{→}\;\Varid{all}\;\Varid{nodes}\;\Varid{except}\;\Varid{n}\;\Varid{are}\;\Varid{inactive}\;\Varid{→}\;\Varid{proj₁}\;(\Varid{nodes}\;\Varid{n'})\;\Varid{≡}\;\MyConid{just}\;\Varid{x}\;\Varid{→}\;\Varid{n'}\;\Varid{≡}\;\Varid{n}{}\<[E]\\
\>[B]{}\Varid{all-except-find}\;\Varid{nodes}\;\Varid{n}\;\Varid{n'}\;\Varid{ia}\;\Varid{eq}\;\Keyword{with}\;\Varid{n'}\;\Varid{≟}\;\Varid{n}{}\<[E]\\
\>[B]{}\Varid{...}\;\mid \;\Varid{yes}\;\Varid{p}\;\mathrel{=}\;\Varid{p}{}\<[E]\\
\>[B]{}\Varid{...}\;\mid \;\Varid{no}\;\Varid{¬p}\;\mathrel{=}\;\Varid{⊥-elim}\;(\Varid{nothing≠just}\;(\Varid{trans}\;(\Varid{sym}\;(\Varid{ia}\;\Varid{n'}\;\Varid{¬p}))\;\Varid{eq})){}\<[E]\\blanklineskip]\>[B]{}\Varid{all-except-find-⟶<send>}\;\mathbin{:}\;\Varid{∀}\;\Varid{nodes}\;\Varid{n}\;\Varid{n'}\;\{\mskip1.5mu \Varid{nodesn''}\;\Varid{msg}\mskip1.5mu\}\;\Varid{→}\;\Varid{all}\;\Varid{nodes}\;\Varid{except}\;\Varid{n}\;\Varid{are}\;\Varid{inactive}\;\Varid{→}\;\Varid{⟶Machine}\;\Varid{n'}\;(\Varid{nodes}\;\Varid{n'})\;(\MyConid{send}\;\Varid{msg})\;\Varid{nodesn''}\;\Varid{→}\;\Varid{n'}\;\Varid{≡}\;\Varid{n}{}\<[E]\\
\>[B]{}\Varid{all-except-find-⟶<send>}\;\Varid{nodes}\;\Varid{n}\;\Varid{n'}\;\Varid{ia}\;\Varid{st}\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\mathrel{=}\;\Keyword{let}\;(\anonymous ,\Varid{eq})\;\mathrel{=}\;\Varid{just⟶<send>m}\;\Varid{st}{}\<[E]\\
\>[3]{}\hsindent{3}{}\<[6]\>[6]{}\Keyword{in}\;\Varid{all-except-find}\;\Varid{nodes}\;\Varid{n}\;\Varid{n'}\;\Varid{ia}\;(\Varid{proj₁}\;(,\Varid{-inj}\;\Varid{eq})){}\<[E]\\blanklineskip]\>[B]{}\Varid{⟶<send>-one-active-to-all-inactive}\;\mathbin{:}\;\Varid{∀}\;\Varid{ms}\;\Varid{sender}\;\{\mskip1.5mu \Varid{sender'}\;\Varid{msg}\mskip1.5mu\}\;\Varid{n}\;{}\<[E]\\
\>[B]{}\hsindent{37}{}\<[37]\>[37]{}\Varid{→}\;\Varid{⟶Machine}\;\Varid{sender}\;(\Varid{ms}\;\Varid{sender})\;(\MyConid{send}\;\Varid{msg})\;\Varid{sender'}\;{}\<[E]\\
\>[B]{}\hsindent{37}{}\<[37]\>[37]{}\Varid{→}\;\Varid{all}\;\Varid{ms}\;\Varid{except}\;\Varid{n}\;\Varid{are}\;\Varid{inactive}\;{}\<[E]\\
\>[B]{}\hsindent{37}{}\<[37]\>[37]{}\Varid{→}\;\Varid{all}\;(\Varid{update}\;\Varid{ms}\;\Varid{sender}\;\Varid{sender'})\;\Varid{are}\;\Varid{inactive}{}\<[E]\\
\>[B]{}\Varid{⟶<send>-one-active-to-all-inactive}\;\Varid{ms}\;\Varid{sender}\;\Varid{n}\;\Varid{st}\;\Varid{ia}\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\mathrel{=}\;\Keyword{let}\;\Varid{sender≡n}\;{}\<[35]\>[35]{}\mathrel{=}\;\Varid{all-except-find-⟶<send>}\;\Varid{ms}\;\Varid{n}\;\Varid{sender}\;\Varid{ia}\;\Varid{st}{}\<[E]\\
\>[3]{}\hsindent{6}{}\<[9]\>[9]{}\Varid{sender'≡nothing}\;{}\<[35]\>[35]{}\mathrel{=}\;\Varid{m⟶<send>nothing}\;\Varid{st}{}\<[E]\\
\>[3]{}\hsindent{1}{}\<[4]\>[4]{}\Keyword{in}\;\Varid{subst}\;(\Varid{λ}\;\Varid{p}\;\Varid{→}\;\Varid{all}\;\Varid{update}\;\Varid{ms}\;\Varid{sender}\;\Varid{p}\;\Varid{are}\;\Varid{inactive})\;(\Varid{sym}\;\Varid{sender'≡nothing})\;{}\<[E]\\
\>[4]{}\hsindent{9}{}\<[13]\>[13]{}(\Varid{all-except-to-all}\;\Varid{ms}\;\Varid{sender}\;(\Varid{subst}\;(\Varid{λ}\;\Varid{p}\;\Varid{→}\;\Varid{all}\;\Varid{ms}\;\Varid{except}\;\Varid{p}\;\Varid{are}\;\Varid{inactive})\;(\Varid{sym}\;\Varid{sender≡n})\;\Varid{ia})){}\<[E]\\blanklineskip]\>[B]{}\Varid{⟶<send>⟶<receive>-preserves-one-active}\;\mathbin{:}\;\Varid{∀}\;\Varid{ms}\;\Varid{sender}\;\{\mskip1.5mu \Varid{sender'}\mskip1.5mu\}\;\Varid{receiver}\;\{\mskip1.5mu \Varid{receiver'}\mskip1.5mu\}\;\{\mskip1.5mu \Varid{msg}\mskip1.5mu\}\;\Varid{n}\;{}\<[E]\\
\>[B]{}\hsindent{42}{}\<[42]\>[42]{}\Varid{→}\;\Varid{⟶Machine}\;\Varid{sender}\;(\Varid{ms}\;\Varid{sender})\;(\MyConid{send}\;\Varid{msg})\;\Varid{sender'}\;{}\<[E]\\
\>[B]{}\hsindent{42}{}\<[42]\>[42]{}\Varid{→}\;\Keyword{let}\;\Varid{ms'}\;\mathrel{=}\;\Varid{update}\;\Varid{ms}\;\Varid{sender}\;\Varid{sender'}{}\<[E]\\
\>[42]{}\hsindent{1}{}\<[43]\>[43]{}\Keyword{in}\;\Varid{⟶Machine}\;\Varid{receiver}\;(\Varid{ms'}\;\Varid{receiver})\;(\MyConid{receive}\;\Varid{msg})\;\Varid{receiver'}{}\<[E]\\
\>[B]{}\hsindent{42}{}\<[42]\>[42]{}\Varid{→}\;\Keyword{let}\;\Varid{ms''}\;\mathrel{=}\;\Varid{update}\;\Varid{ms'}\;\Varid{receiver}\;\Varid{receiver'}{}\<[E]\\
\>[42]{}\hsindent{1}{}\<[43]\>[43]{}\Keyword{in}\;\Varid{all}\;\Varid{ms}\;\Varid{except}\;\Varid{n}\;\Varid{are}\;\Varid{inactive}{}\<[E]\\
\>[B]{}\hsindent{42}{}\<[42]\>[42]{}\Varid{→}\;\Varid{all}\;\Varid{ms''}\;\Varid{except}\;\Varid{receiver}\;\Varid{are}\;\Varid{inactive}{}\<[E]\\
\>[B]{}\Varid{⟶<send>⟶<receive>-preserves-one-active}\;\Varid{ms}\;\Varid{sender}\;\Varid{receiver}\;\Varid{n}\;\Varid{sendstep}\;\Varid{receivestep}\;\Varid{ia}\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\mathrel{=}\;\Keyword{let}\;\Varid{ia'}\;{}\<[14]\>[14]{}\mathrel{=}\;\Varid{⟶<send>-one-active-to-all-inactive}\;\Varid{ms}\;\Varid{sender}\;\Varid{n}\;\Varid{sendstep}\;\Varid{ia}{}\<[E]\\
\>[3]{}\hsindent{6}{}\<[9]\>[9]{}\Varid{ia''}\;\mathrel{=}\;\Varid{⟶<receive>-all-inactive-to-one-active}\;(\Varid{update}\;\Varid{ms}\;\Varid{sender}\;\anonymous )\;\Varid{receiver}\;\Varid{receivestep}\;\Varid{ia'}{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}\Keyword{in}\;\Varid{ia''}{}\<[E]\\blanklineskip]\>[B]{}\mbox{\onelinecomment  For some reason these lemmas cannot be in a where clause...}{}\<[E]\\
\>[B]{}\Varid{⟶Async⁺-to-⟶Sync⁺-lemma-receive}\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{msgs₂}\;\Varid{msgs₃}\;\Varid{msg}\mskip1.5mu\}\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{→}\;\Varid{msgs₂}\;\Varid{≡}\;\Varid{msg}\;\Varid{∷}\;[\mskip1.5mu \mskip1.5mu]\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{→}\;\Varid{msgs₃}\;\Varid{≡}\;[\mskip1.5mu \mskip1.5mu]\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{→}\;\Varid{∀}\;\{\mskip1.5mu \Varid{ms₁}\;\Varid{sender}\;\Varid{sender'}\;\Varid{ms₃}\mskip1.5mu\}\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{→}\;\Varid{⟶Machine}\;\Varid{sender}\;(\Varid{ms₁}\;\Varid{sender})\;(\MyConid{send}\;\Varid{msg})\;\Varid{sender'}\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{→}\;\Keyword{let}\;\Varid{ms₂}\;\mathrel{=}\;\Varid{update}\;\Varid{ms₁}\;\Varid{sender}\;\Varid{sender'}{}\<[E]\\
\>[3]{}\hsindent{1}{}\<[4]\>[4]{}\Keyword{in}\;\Varid{all}\;\Varid{ms₂}\;\Varid{are}\;\Varid{inactive}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{→}\;(\Varid{ms₂},\Varid{msgs₂})\;{\xrightarrow[\Varid{Async}]{}\Varid{⁺}}\;(\Varid{ms₃},\Varid{msgs₃}){}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{→}\;\Varid{ms₁}\;\xrightarrow[\Varid{Sync}]{}\Varid{⁺}\;\Varid{ms₃}{}\<[E]\\blanklineskip]\>[B]{}{\dummy{\xrightarrow[\Varid{Sync}]{}^*}\dummy}\;\mathrel{=}\;{\dummy\xrightarrow[\Varid{Sync}]{}\dummy}\;\Varid{*}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}

We define what it means for a synchronous \DCESHn{} network {\textsmaller[.5]{\ensuremath{\Varid{nodes}}}} to
\emph{terminate with a value {\textsmaller[.5]{\ensuremath{\Varid{v}}}}} ({\textsmaller[.5]{\ensuremath{\Varid{nodes}\;\downarrow_{\Varid{Sync}}\;\Varid{v}}}}), \emph{terminate}
({\textsmaller[.5]{\ensuremath{\Varid{nodes}\;\downarrow_{\Varid{Sync}}}}}), and \emph{diverge} ({\textsmaller[.5]{\ensuremath{\Varid{nodes}\;\uparrow_{\Varid{Sync}}}}}).  A network
terminates with a value {\textsmaller[.5]{\ensuremath{\Varid{v}}}} if it can step to a network where only one
node is active, and that node has reached the {\textsmaller[.5]{\ensuremath{\MyConid{END}}}} instruction with
the value {\textsmaller[.5]{\ensuremath{\Varid{v}}}} on top of its stack. The other definitions are analogous to
those of the CES(H) machine.
\iffullversion
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}{\dummy\downarrow_{\Varid{Sync}}\dummy}\;\mathbin{:}\;\Conid{SyncNetwork}\;\Varid{→}\;\Conid{Value}\;\Varid{→}\;\star{}\<[E]\ColumnHook
\end{hscode}\resethooks
\removecodespace
\fi
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{12}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Varid{nodes}\;\downarrow_{\Varid{Sync}}\;\Varid{v}\;\mathrel{=}\;\Varid{∃}\;\Varid{λ}\;\Varid{nodes'}\;\Varid{→}\;\Varid{nodes}\;{\xrightarrow[\Varid{Sync}]{}^*}\;\Varid{nodes'}\;\Varid{×}\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{∃}\;\Varid{λ}\;\Varid{i}\;\Varid{→}\;{}\<[12]\>[12]{}\Varid{all}\;\Varid{nodes'}\;\Varid{except}\;\Varid{i}\;\Varid{are}\;\Varid{inactive}\;\Varid{×}\;\Varid{∃}\;\Varid{λ}\;\Varid{heaps}\;\Varid{→}\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{nodes'}\;\Varid{i}\;\Varid{≡}\;(\MyConid{just}\;(\MyConid{END},[\mskip1.5mu \mskip1.5mu],\MyConid{val}\;\Varid{v}\;\Varid{∷}\;[\mskip1.5mu \mskip1.5mu],\MyConid{nothing}),\Varid{heaps}){}\<[E]\ColumnHook
\end{hscode}\resethooks
\iffullversion
\removecodespace
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}{\dummy\downarrow_{\Varid{Sync}}}\;\mathbin{:}\;\Varid{∀}\;\Varid{nodes}\;\Varid{→}\;\star{}\<[E]\\
\>[B]{}\Varid{nodes}\;\downarrow_{\Varid{Sync}}\;\mathrel{=}\;\Varid{∃}\;\Varid{λ}\;\Varid{v}\;\Varid{→}\;\Varid{nodes}\;\downarrow_{\Varid{Sync}}\;\Varid{v}{}\<[E]\\
\>[B]{}{\dummy\uparrow_{\Varid{Sync}}}\;\mathbin{:}\;\Varid{∀}\;\Varid{nodes}\;\Varid{→}\;\star{}\<[E]\\
\>[B]{}{\dummy\uparrow_{\Varid{Sync}}}\;\mathrel{=}\;\Varid{↑}\;{\dummy\xrightarrow[\Varid{Sync}]{}\dummy}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\fi

\subsection{Correctness} \label{section:DCESH-bisim}
To prove the correctness of the machine, we will now establish a
bisimulation between the CESH and the \DCESHn{} machines.

To simplify this development, we extend the CESH machine with
a rule for the {\textsmaller[.5]{\ensuremath{\MyConid{REMOTE}\;\Varid{c}\;\Varid{i}}}} instruction so that both machines run the
same bytecode. This rule is almost a no-op, but since we are assuming
that the code we run remotely is closed, the environment is emptied,
and since the compiled code {\textsmaller[.5]{\ensuremath{\Varid{c}}}} will end in a {\textsmaller[.5]{\ensuremath{\MyConid{RET}}}} instruction
a return continuation is pushed on the stack.
\iffullversion
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{5}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{data}\;{\dummy\xrightarrow[\Varid{CESH}]{}\dummy}\;\mathbin{:}\;\Conid{Rel}\;\Conid{Config}\;\Conid{Config}\;\Keyword{where}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{...}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\MyConid{REMOTE}\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{c'}\;\Varid{i}\;\Varid{c}\;\Varid{e}\;\Varid{s}\;\Varid{h}\mskip1.5mu\}\;\Varid{→}\;{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}(\MyConid{REMOTE}\;\Varid{c'}\;\Varid{i}\;\MyConid{;}\;\Varid{c},\Varid{e},\Varid{s},\Varid{h})\;\xrightarrow[\Varid{CESH}]{}\;(\Varid{c'},[\mskip1.5mu \mskip1.5mu],\MyConid{cont}\;(\Varid{c},\Varid{e})\;\Varid{∷}\;\Varid{s},\Varid{h}){}\<[E]\ColumnHook
\end{hscode}\resethooks
\else
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}(\MyConid{REMOTE}\;\Varid{c'}\;\Varid{i}\;\MyConid{;}\;\Varid{c},\Varid{e},\Varid{s},\Varid{h})\;\xrightarrow[\Varid{CESH}]{}\;(\Varid{c'},[\mskip1.5mu \mskip1.5mu],\MyConid{cont}\;(\Varid{c},\Varid{e})\;\Varid{∷}\;\Varid{s},\Varid{h}){}\<[E]\ColumnHook
\end{hscode}\resethooks
\fi

\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{GeneralLemmas}\;\Keyword{using}\;(\Varid{\char95 ≡\char95 };\Conid{Dec}){}\<[E]\\
\>[B]{}\Keyword{module}\;\Conid{DCESH.Simulation-CESH}\;(\Conid{Node}\;\mathbin{:}\;\star)\;(\Varid{\char95 ≟\char95 }\;\mathbin{:}\;(\Varid{n}\;\Varid{n'}\;\mathbin{:}\;\Conid{Node})\;\Varid{→}\;\Conid{Dec}\;(\Varid{n}\;\Varid{≡}\;\Varid{n'}))\;\Keyword{where}{}\<[E]\\blanklineskip]\>[B]{}\Varid{update-update-heaps-⊆s}\;\mathbin{:}\;\Varid{∀}\;(\Varid{nodes}\;\mathbin{:}\;\Conid{SyncNetwork})\;\Varid{n}\;\{\mskip1.5mu \Varid{x}\;\Varid{x'}\;\Varid{h}_{\Varid{cl}}\;\Varid{h'}_{\Varid{cl}}\;\Varid{h}_{\Varid{cnt}}\;\Varid{h'}_{\Varid{cnt}}\mskip1.5mu\}\;{}\<[E]\\
\>[B]{}\hsindent{19}{}\<[19]\>[19]{}\Varid{→}\;\Varid{h}_{\Varid{cl}}\;\Varid{⊆}\;\Varid{h'}_{\Varid{cl}}\;\Varid{→}\;\Varid{h}_{\Varid{cnt}}\;\Varid{⊆}\;\Varid{h'}_{\Varid{cnt}}\;\Varid{→}\;\Varid{proj₂}\;\Varid{∘}\;\Varid{update}\;\Varid{nodes}\;\Varid{n}\;(\Varid{x},\Varid{h}_{\Varid{cl}},\Varid{h}_{\Varid{cnt}})\;\Varid{⊆s}\;\Varid{proj₂}\;\Varid{∘}\;\Varid{update}\;\Varid{nodes}\;\Varid{n}\;(\Varid{x'},\Varid{h'}_{\Varid{cl}},\Varid{h'}_{\Varid{cnt}}){}\<[E]\\
\>[B]{}\Varid{update-update-heaps-⊆s}\;\Varid{nodes}\;\Varid{n}\;\Varid{clh⊆clh'}\;\Varid{conth⊆conth'}\;\Varid{n'}\;\Keyword{with}\;\Varid{n'}\;\Varid{≟}\;\Varid{n}{}\<[E]\\
\>[B]{}\Varid{update-update-heaps-⊆s}\;\Varid{nodes}\;\Varid{n}\;\Varid{clh⊆clh'}\;\Varid{conth⊆conth'}\;\Varid{.n}\;\mid \;\Varid{yes}\;\Varid{refl}\;\mathrel{=}\;\Varid{clh⊆clh'},\Varid{conth⊆conth'}{}\<[E]\\
\>[B]{}\Varid{update-update-heaps-⊆s}\;\Varid{nodes}\;\Varid{n}\;\Varid{clh⊆clh'}\;\Varid{conth⊆conth'}\;\Varid{n'}\;\mid \;\Varid{no}\;\Varid{¬p}\;\mathrel{=}\;\Varid{⊆-refl}\;(\Varid{proj₁}\;(\Varid{proj₂}\;(\Varid{nodes}\;\Varid{n'}))),\Varid{⊆-refl}\;(\Varid{proj₂}\;(\Varid{proj₂}\;(\Varid{nodes}\;\Varid{n'}))){}\<[E]\\blanklineskip]\>[B]{}\Varid{lookup-rcontptr-fmap}\;\mathbin{:}\;\Varid{∀}\;\Varid{hs}\;\Varid{r}\;\{\mskip1.5mu \Conid{P}\;\Conid{Q}\mskip1.5mu\}\;\Varid{→}\;(\Varid{∀}\;\{\mskip1.5mu \Varid{c}\;\Varid{s}\mskip1.5mu\}\;\Varid{→}\;\Conid{P}\;\Varid{c}\;\Varid{s}\;\Varid{→}\;\Conid{Q}\;\Varid{c}\;\Varid{s})\;\Varid{→}\;\Varid{lookup-rptr}_{\Varid{cnt}}\;\Varid{hs}\;\Varid{r}\;\Conid{P}\;\Varid{→}\;\Varid{lookup-rptr}_{\Varid{cnt}}\;\Varid{hs}\;\Varid{r}\;\Conid{Q}{}\<[E]\\
\>[B]{}\Varid{lookup-rcontptr-fmap}\;\Varid{hs}\;\Varid{r}\;\Varid{f}\;(\Varid{c},\Varid{s},\Varid{lucont},\Conid{Pcs})\;\mathrel{=}\;\Varid{c},\Varid{s},\Varid{lucont},\Varid{f}\;\Conid{Pcs}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{5}{@{}>{\hspre}l<{\hspost}@{}}\column{27}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{module}\;\Conid{HeapUpdate}\;(\Varid{h}\;\Varid{h'}\;\mathbin{:}\;\Conid{Heap}\;\Conid{CESH.Closure})\;(\Varid{hs}\;\Varid{hs'}\;\mathbin{:}\;\Conid{Heaps})\;(\Varid{h⊆h'}\;\mathbin{:}\;\Varid{h}\;\Varid{⊆}\;\Varid{h'})\;(\Varid{hs⊆shs'}\;\mathbin{:}\;\Varid{hs}\;\Varid{⊆s}\;\Varid{hs'})\;\Keyword{where}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{lu-contptr}\;\mathbin{:}\;\Varid{∀}\;\Varid{r}\;\{\mskip1.5mu \Conid{P}\mskip1.5mu\}\;\Varid{→}\;{}\<[27]\>[27]{}\Varid{lookup-rptr}_{\Varid{cnt}}\;\Varid{hs}\;\Varid{r}\;\Conid{P}\;\Varid{→}\;\Varid{lookup-rptr}_{\Varid{cnt}}\;\Varid{hs'}\;\Varid{r}\;\Conid{P}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Varid{lu-contptr}\;(\Varid{ptr},\Varid{loc})\;(\Varid{c},\Varid{s},\Varid{luconth},\Conid{Pcs})\;\mathrel{=}{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}\Keyword{let}\;(\Varid{clh⊆clh'},\Varid{conth⊆conth'})\;\mathrel{=}\;\Varid{hs⊆shs'}\;\Varid{loc}\;\Keyword{in}\;\Varid{c},\Varid{s},\Varid{conth⊆conth'}\;\Varid{ptr}\;\Varid{luconth},\Conid{Pcs}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}
\begin{lemma}[{\textsmaller[.5]{\ensuremath{\Conid{HeapUpdate.env}}}}, {\textsmaller[.5]{\ensuremath{\Conid{HeapUpdate.stack}}}}]
Given CESH closure heaps {\textsmaller[.5]{\ensuremath{\Varid{h}}}} and {\textsmaller[.5]{\ensuremath{\Varid{h'}}}} such that {\textsmaller[.5]{\ensuremath{\Varid{h}\;\Varid{⊆}\;\Varid{h'}}}} and families of \DCESHn{} heaps {\textsmaller[.5]{\ensuremath{\Varid{hs}}}} and {\textsmaller[.5]{\ensuremath{\Varid{hs'}}}}
such that {\textsmaller[.5]{\ensuremath{\Varid{hs}\;\Varid{⊆s}\;\Varid{hs'}}}},
\ifnotfullversion
then {\textsmaller[.5]{\ensuremath{\Varid{R}_{\Varid{Env}}\;\Varid{n}\;\Varid{h}\;\Varid{hs}\;\Varid{e₁}\;\Varid{e₂}}}} implies {\textsmaller[.5]{\ensuremath{\Varid{R}_{\Varid{Env}}\;\Varid{n}\;\Varid{h'}\;\Varid{hs'}\;\Varid{e₁}\;\Varid{e₂}}}} and {\textsmaller[.5]{\ensuremath{\Varid{R}_{\Varid{Stack}}\;\Varid{h}\;\Varid{hs}\;\Varid{s₁}\;\Varid{s₂}}}} implies {\textsmaller[.5]{\ensuremath{\Varid{R}_{\Varid{Stack}}\;\Varid{h'}\;\Varid{hs'}\;\Varid{s₁}\;\Varid{s₂}}}}.
\else
then we can prove the following:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{24}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}\Varid{env}\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{n}\mskip1.5mu\}\;\Varid{e₁}\;\Varid{e₂}\;\Varid{→}\;{}\<[24]\>[24]{}\Varid{R}_{\Varid{Env}}\;\Varid{n}\;\Varid{h}\;\Varid{hs}\;\Varid{e₁}\;\Varid{e₂}\;\Varid{→}\;\Varid{R}_{\Varid{Env}}\;\Varid{n}\;\Varid{h'}\;\Varid{hs'}\;\Varid{e₁}\;\Varid{e₂}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{5}{@{}>{\hspre}l<{\hspost}@{}}\column{18}{@{}>{\hspre}l<{\hspost}@{}}\column{22}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[3]{}\Varid{closure}\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{n}\mskip1.5mu\}\;\Varid{cl}\;\Varid{dcl}\;\Varid{→}\;\Varid{R}_{\Varid{Clos}}\;\Varid{n}\;\Varid{h}\;\Varid{hs}\;\Varid{cl}\;\Varid{dcl}\;\Varid{→}\;\Varid{R}_{\Varid{Clos}}\;\Varid{n}\;\Varid{h'}\;\Varid{hs'}\;\Varid{cl}\;\Varid{dcl}{}\<[E]\\
\>[3]{}\Varid{closure}\;(\Varid{c},\Varid{e})\;(\Varid{dc},\Varid{de})\;(\Conid{Rcdc},\Conid{Rede})\;\mathrel{=}\;\Conid{Rcdc},\Varid{env}\;\Varid{e}\;\Varid{de}\;\Conid{Rede}{}\<[E]\\blanklineskip]\>[3]{}\Varid{value}\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{n}\mskip1.5mu\}\;\Varid{v}\;\Varid{dv}\;\Varid{→}\;\Varid{R}_{\Varid{Val}}\;\Varid{n}\;\Varid{h}\;\Varid{hs}\;\Varid{v}\;\Varid{dv}\;\Varid{→}\;\Varid{R}_{\Varid{Val}}\;\Varid{n}\;\Varid{h'}\;\Varid{hs'}\;\Varid{v}\;\Varid{dv}{}\<[E]\\
\>[3]{}\Varid{value}\;(\MyConid{nat}\;\Varid{n})\;{}\<[18]\>[18]{}(\MyConid{nat}\;\Varid{n'})\;\Conid{Rvdv}\;\mathrel{=}\;\Conid{Rvdv}{}\<[E]\\
\>[3]{}\Varid{value}\;(\MyConid{nat}\;\anonymous )\;{}\<[18]\>[18]{}(\MyConid{clos}\;\anonymous )\;(){}\<[E]\\
\>[3]{}\Varid{value}\;(\MyConid{clos}\;\anonymous )\;(\MyConid{nat}\;\anonymous )\;(){}\<[E]\\
\>[3]{}\Varid{value}\;(\MyConid{clos}\;\Varid{ptr})\;(\MyConid{clos}\;\Varid{dptr})\;\Conid{Rvdv}\;\mathrel{=}\;\Varid{ptr}_{\Varid{cl}}\;\Varid{ptr}\;\Varid{dptr}\;\Conid{Rvdv}{}\<[E]\\blanklineskip]\>[3]{}\Varid{env}\;[\mskip1.5mu \mskip1.5mu]\;[\mskip1.5mu \mskip1.5mu]\;\Conid{Rede}\;\mathrel{=}\;\Varid{tt}{}\<[E]\\
\>[3]{}\Varid{env}\;[\mskip1.5mu \mskip1.5mu]\;(\anonymous \;\Varid{∷}\;\Varid{de})\;(){}\<[E]\\
\>[3]{}\Varid{env}\;(\anonymous \;\Varid{∷}\;\Varid{e})\;[\mskip1.5mu \mskip1.5mu]\;(){}\<[E]\\
\>[3]{}\Varid{env}\;(\Varid{v}\;\Varid{∷}\;\Varid{e})\;(\Varid{dv}\;\Varid{∷}\;\Varid{de})\;(\Conid{Rvdv},\Conid{Rede})\;\mathrel{=}\;\Varid{value}\;\Varid{v}\;\Varid{dv}\;\Conid{Rvdv},\Varid{env}\;\Varid{e}\;\Varid{de}\;\Conid{Rede}{}\<[E]\\blanklineskip]\>[B]{}\Varid{nodes-ia-update-ia}\;\mathbin{:}\;\Varid{∀}\;\Varid{nodes}\;\Varid{n}\;\Varid{loc}\;\{\mskip1.5mu \Varid{hs}\mskip1.5mu\}\;\Varid{→}\;\Varid{all}\;\Varid{nodes}\;\Varid{except}\;\Varid{n}\;\Varid{are}\;\Varid{inactive}\;{}\<[E]\\
\>[B]{}\hsindent{16}{}\<[16]\>[16]{}\Varid{→}\;\Keyword{let}\;\Varid{nodes'}\;\mathrel{=}\;\Varid{update}\;\Varid{nodes}\;\Varid{n}\;(\MyConid{nothing},\Varid{hs})\;\Keyword{in}{}\<[E]\\
\>[16]{}\hsindent{3}{}\<[19]\>[19]{}\Keyword{let}\;\Varid{heaps'}\;\mathrel{=}\;\Varid{proj₂}\;\Varid{∘}\;\Varid{nodes'}{}\<[E]\\
\>[19]{}\hsindent{1}{}\<[20]\>[20]{}\Keyword{in}\;\MyConid{nothing},\Varid{heaps'}\;\Varid{loc}\;\Varid{≡}\;\Varid{nodes'}\;\Varid{loc}{}\<[E]\\
\>[B]{}\Varid{nodes-ia-update-ia}\;\Varid{nodes}\;\Varid{n}\;\Varid{loc}\;\Varid{ia}\;\Keyword{with}\;\Varid{loc}\;\Varid{≟}\;\Varid{n}{}\<[E]\\
\>[B]{}\Varid{...}\;\mid \;\Varid{yes}\;\Varid{p}\;\mathrel{=}\;\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{...}\;\mid \;\Varid{no}\;\Varid{¬p}\;\mathrel{=}\;\Varid{cong}\;(\Varid{λ}\;\Varid{p}\;\Varid{→}\;\Varid{p},\Varid{proj₂}\;(\Varid{nodes}\;\Varid{loc}))\;(\Varid{sym}\;(\Varid{ia}\;\Varid{loc}\;\Varid{¬p})){}\<[E]\\blanklineskip]\>[B]{}\Varid{lookup-var}\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{h}\;\Varid{hs}\;\Varid{v}\mskip1.5mu\}\;\Varid{e}\;\Varid{de}\;\Varid{x}\;\Varid{→}\;(\Varid{∀}\;\Varid{n}\;\Varid{→}\;\Varid{R}_{\Varid{Env}}\;\Varid{n}\;\Varid{h}\;\Varid{hs}\;\Varid{e}\;\Varid{de})\;\Varid{→}\;\Varid{lookup}\;\Varid{x}\;\Varid{e}\;\Varid{≡}\;\MyConid{just}\;\Varid{v}\;\Varid{→}\;\Varid{∃}\;\Varid{λ}\;\Varid{dv}\;\Varid{→}\;\Varid{lookup}\;\Varid{x}\;\Varid{de}\;\Varid{≡}\;\MyConid{just}\;\Varid{dv}\;\Varid{×}\;(\Varid{∀}\;\Varid{n}\;\Varid{→}\;\Varid{R}_{\Varid{Val}}\;\Varid{n}\;\Varid{h}\;\Varid{hs}\;\Varid{v}\;\Varid{dv}){}\<[E]\\
\>[B]{}\Varid{lookup-var}\;[\mskip1.5mu \mskip1.5mu]\;\Varid{de}\;\Varid{x}\;\Conid{Rede}\;(){}\<[E]\\
\>[B]{}\Varid{lookup-var}\;(\Varid{v}\;\Varid{∷}\;\Varid{e})\;[\mskip1.5mu \mskip1.5mu]\;\Varid{x}\;\Conid{Rede}\;\Varid{look}\;\mathrel{=}\;\Varid{⊥-elim}\;(\Conid{Rede}\;\Varid{0}){}\<[E]\\
\>[B]{}\Varid{lookup-var}\;(\Varid{v}\;\Varid{∷}\;\Varid{e})\;(\Varid{dv}\;\Varid{∷}\;\Varid{de})\;\Varid{zero}\;\Conid{Rede}\;\Varid{refl}\;\mathrel{=}\;\Varid{dv},(\Varid{refl},\Varid{proj₁}\;\Varid{∘}\;\Conid{Rede}){}\<[E]\\
\>[B]{}\Varid{lookup-var}\;(\Varid{v}\;\Varid{∷}\;\Varid{e})\;(\Varid{dv}\;\Varid{∷}\;\Varid{de})\;(1+\;\Varid{x})\;\Conid{Rede}\;\Varid{look}\;\mathrel{=}\;\Varid{lookup-var}\;\Varid{e}\;\Varid{de}\;\Varid{x}\;(\Varid{proj₂}\;\Varid{∘}\;\Conid{Rede})\;\Varid{look}{}\<[E]\\blanklineskip]\>[B]{}\Conid{R-machine-node}\;\mathbin{:}\;\Varid{∀}\;\Varid{nodes}\;\Varid{n}\;\{\mskip1.5mu \Varid{m}\mskip1.5mu\}\;\{\mskip1.5mu \Varid{node}\mskip1.5mu\}\;{}\<[E]\\
\>[B]{}\hsindent{16}{}\<[16]\>[16]{}\Varid{→}\;\Keyword{let}\;\Varid{heaps}\;\mathrel{=}\;\Varid{proj₂}\;\Varid{∘}\;\Varid{update}\;\Varid{nodes}\;\Varid{n}\;\Varid{node}{}\<[E]\\
\>[16]{}\hsindent{4}{}\<[20]\>[20]{}\Keyword{in}\;\Varid{R}_{\Varid{Thread}}\;\Varid{heaps}\;\Varid{m}\;(\Varid{proj₁}\;\Varid{node}){}\<[E]\\
\>[B]{}\hsindent{16}{}\<[16]\>[16]{}\Varid{→}\;\Varid{R}_{\Varid{Thread}}\;\Varid{heaps}\;\Varid{m}\;(\Varid{proj₁}\;(\Varid{update}\;\Varid{nodes}\;\Varid{n}\;\Varid{node}\;\Varid{n})){}\<[E]\\
\>[B]{}\Conid{R-machine-node}\;\Varid{nodes}\;\Varid{n}\;\{\mskip1.5mu \Varid{m}\mskip1.5mu\}\;\{\mskip1.5mu \Varid{node}\mskip1.5mu\}\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\mathrel{=}\;\Conid{R-machine-node-eq}\;(\Varid{update}\;\Varid{nodes}\;\Varid{n}\;\Varid{node})\;\Varid{n}\;(\Varid{update-look}\;\Varid{nodes}\;\Varid{n}\;\Varid{node}){}\<[E]\\blanklineskip]\>[B]{}\Varid{node-step-silent-thread}\;\mathbin{:}\;\Varid{∀}\;\Varid{nodes}\;\Varid{n}\;\{\mskip1.5mu \Varid{hs}\;\Varid{thread}\;\Varid{machine}\mskip1.5mu\}\;{}\<[E]\\
\>[B]{}\hsindent{11}{}\<[11]\>[11]{}\Varid{→}\;\Varid{nodes}\;\Varid{n}\;\Varid{≡}\;\MyConid{just}\;\Varid{thread},\Varid{hs}{}\<[E]\\
\>[B]{}\hsindent{11}{}\<[11]\>[11]{}\Varid{→}\;\Varid{⟶Machine}\;\Varid{n}\;(\MyConid{just}\;\Varid{thread},\Varid{proj₂}\;(\Varid{nodes}\;\Varid{n}))\;\MyConid{silent}\;\Varid{machine}{}\<[E]\\
\>[B]{}\hsindent{11}{}\<[11]\>[11]{}\Varid{→}\;\Varid{nodes}\;\xrightarrow[\Varid{Sync}]{}\;\Varid{update}\;\Varid{nodes}\;\Varid{n}\;\Varid{machine}{}\<[E]\\
\>[B]{}\Varid{node-step-silent-thread}\;\Varid{nodes}\;\Varid{n}\;\{\mskip1.5mu \Varid{hs}\mskip1.5mu\}\;\{\mskip1.5mu \Varid{thread}\mskip1.5mu\}\;\{\mskip1.5mu \Varid{machine}\mskip1.5mu\}\;\Varid{eq}\;\Varid{st}\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\mathrel{=}\;\MyConid{silent-step}\;(\Varid{subst}\;(\Varid{λ}\;\Varid{p}\;\Varid{→}\;\Varid{⟶Machine}\;\Varid{n}\;(\Varid{p},\Varid{proj₂}\;(\Varid{nodes}\;\Varid{n}))\;\MyConid{silent}\;\Varid{machine})\;{}\<[E]\\
\>[3]{}\hsindent{21}{}\<[24]\>[24]{}(\Varid{sym}\;(\Varid{proj₁}\;(,\Varid{-inj}\;\Varid{eq})))\;{}\<[E]\\
\>[3]{}\hsindent{21}{}\<[24]\>[24]{}\Varid{st}){}\<[E]\\blanklineskip]\>[B]{}\Conid{R-val-pred}\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{h}\;\Varid{heaps}\;\Varid{v}\;\Varid{dv}\mskip1.5mu\}\;{}\<[E]\\
\>[B]{}\hsindent{12}{}\<[12]\>[12]{}\Varid{→}\;(\Varid{∀}\;\Varid{n}\;\Varid{→}\;\Varid{R}_{\Varid{Val}}\;(1+\;\Varid{n})\;\Varid{h}\;\Varid{heaps}\;(\MyConid{clos}\;\Varid{v})\;(\MyConid{clos}\;\Varid{dv}))\;{}\<[E]\\
\>[B]{}\hsindent{12}{}\<[12]\>[12]{}\Varid{→}\;\Varid{∀}\;\Varid{n}\;\Varid{→}\;\Varid{R}_{\Varid{Val}}\;\Varid{n}\;\Varid{h}\;\Varid{heaps}\;(\MyConid{clos}\;\Varid{v})\;(\MyConid{clos}\;\Varid{dv}){}\<[E]\\
\>[B]{}\Conid{R-val-pred}\;\Conid{Rvdv}\;\Varid{0}\;\mathrel{=}\;\Varid{tt}{}\<[E]\\
\>[B]{}\Conid{R-val-pred}\;\Conid{Rvdv}\;(1+\;\Varid{n})\;\mathrel{=}\;\Conid{Rvdv}\;\Varid{n}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}

\begin{theorem}[{\textsmaller[.5]{\ensuremath{\Varid{simulation}_{\Varid{Sync}}}}}]
{\textsmaller[.5]{\ensuremath{\Varid{R}_{\Varid{Sync}}}}} is a simulation relation.
\iffullversion
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Varid{simulation}_{\Varid{Sync}}\;\mathbin{:}\;\Conid{Simulation}\;{\dummy\xrightarrow[\Varid{CESH}]{}\dummy}\;{\dummy\xrightarrow[\Varid{Sync}]{}\dummy}\;\Varid{R}_{\Varid{Sync}}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\fi
\end{theorem}
\begin{proof}
By cases on the CESH transition. In each case, the \DCESHn{}
network can make analogous transitions. Use the {\textsmaller[.5]{\ensuremath{\Conid{HeapUpdate}}}} lemmas to
show that {\textsmaller[.5]{\ensuremath{\Varid{R}_{\Varid{Sync}}}}} is preserved.
\end{proof}
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{4}{@{}>{\hspre}l<{\hspost}@{}}\column{5}{@{}>{\hspre}l<{\hspost}@{}}\column{6}{@{}>{\hspre}l<{\hspost}@{}}\column{7}{@{}>{\hspre}l<{\hspost}@{}}\column{9}{@{}>{\hspre}l<{\hspost}@{}}\column{14}{@{}>{\hspre}l<{\hspost}@{}}\column{17}{@{}>{\hspre}l<{\hspost}@{}}\column{19}{@{}>{\hspre}l<{\hspost}@{}}\column{20}{@{}>{\hspre}l<{\hspost}@{}}\column{21}{@{}>{\hspre}l<{\hspost}@{}}\column{32}{@{}>{\hspre}l<{\hspost}@{}}\column{36}{@{}>{\hspre}l<{\hspost}@{}}\column{37}{@{}>{\hspre}l<{\hspost}@{}}\column{46}{@{}>{\hspre}l<{\hspost}@{}}\column{54}{@{}>{\hspre}l<{\hspost}@{}}\column{85}{@{}>{\hspre}l<{\hspost}@{}}\column{90}{@{}>{\hspre}l<{\hspost}@{}}\column{92}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Varid{simulation}_{\Varid{Sync}}\;\Varid{cfg}\;\Varid{cfg'}\;\Varid{nodes}\;\Varid{st}\;(\Varid{i},\Varid{ia},\Conid{Rcfgn})\;\Keyword{with}\;\Varid{nodes}\;\Varid{i}\;\mid \;\Varid{inspect}\;\Varid{nodes}\;\Varid{i}{}\<[E]\\
\>[B]{}\mbox{\onelinecomment  Node n must be active}{}\<[E]\\
\>[B]{}\Varid{simulation}_{\Varid{Sync}}\;\Varid{cfg}\;\Varid{cfg'}\;\Varid{nodes}\;\Varid{st}\;(\Varid{i},\Varid{ia},())\;\mid \;\MyConid{nothing},\Varid{hs}\;\mid \;\Varid{eq}{}\<[E]\\
\>[B]{}\Varid{simulation}_{\Varid{Sync}}\;(\MyConid{VAR}\;\Varid{n}\;\MyConid{;}\;\Varid{c},\Varid{e},\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{17}{}\<[17]\>[17]{}(\Varid{.c},\Varid{.e},\MyConid{val}\;\Varid{v}\;\Varid{∷}\;\Varid{.s},\Varid{.h})\;{}\<[E]\\
\>[B]{}\hsindent{17}{}\<[17]\>[17]{}\Varid{nodes}\;{}\<[E]\\
\>[B]{}\hsindent{17}{}\<[17]\>[17]{}(\MyConid{VAR}\;\Varid{x})\;{}\<[E]\\
\>[B]{}\hsindent{17}{}\<[17]\>[17]{}(\Varid{i},\Varid{ia},\Varid{refl},\Conid{Rede},\Conid{Rsds})\;{}\<[E]\\
\>[B]{}\hsindent{17}{}\<[17]\>[17]{}\mid \;\MyConid{just}\;(.\;(\MyConid{VAR}\;\Varid{n}\;\MyConid{;}\;\Varid{c}),\Varid{de},\Varid{ds},\Varid{r}),\Varid{hs}\;\mid \;[\mskip1.5mu \Varid{eq}\mskip1.5mu]{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\mathrel{=}\;\Keyword{let}{}\<[E]\\
\>[3]{}\hsindent{4}{}\<[7]\>[7]{}(\Varid{dv},\Varid{look},\Conid{Rvdv})\;\mathrel{=}\;\Varid{lookup-var}\;\Varid{e}\;\Varid{de}\;\Varid{n}\;\Conid{Rede}\;\Varid{x}{}\<[E]\\
\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Varid{dcfg'}\;\mathrel{=}\;\MyConid{just}\;(\Varid{c},\Varid{de},\MyConid{val}\;\Varid{dv}\;\Varid{∷}\;\Varid{ds},\Varid{r}),\Varid{hs}{}\<[E]\\
\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Varid{heaps}\;\mathrel{=}\;\Varid{proj₂}\;\Varid{∘}\;\Varid{nodes}{}\<[E]\\
\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Varid{nodes'}\;\mathrel{=}\;\Varid{update}\;\Varid{nodes}\;\Varid{i}\;\Varid{dcfg'}{}\<[E]\\
\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Varid{heaps'}\;\mathrel{=}\;\Varid{proj₂}\;\Varid{∘}\;\Varid{nodes'}{}\<[E]\\
\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Varid{h⊆h}\;\mathrel{=}\;\Varid{⊆-refl}\;\Varid{h}{}\<[E]\\
\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Varid{heaps⊆sheaps'}\;\mathrel{=}\;\Varid{update-heaps-⊆s-same}\;\Varid{nodes}\;\Varid{i}\;\Varid{eq}{}\<[E]\\
\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Conid{Rmachine'}\;\mathrel{=}\;\Conid{HeapUpdate-machine}\;\Varid{heaps}\;\Varid{heaps'}\;\Varid{heaps⊆sheaps'}\;(\Varid{c},\Varid{e},\MyConid{val}\;\Varid{v}\;\Varid{∷}\;\Varid{s},\Varid{h})\;(\Varid{proj₁}\;\Varid{dcfg'})\;{}\<[E]\\
\>[7]{}\hsindent{30}{}\<[37]\>[37]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},\Conid{Rsds}){}\<[E]\\blanklineskip]\>[3]{}\hsindent{4}{}\<[7]\>[7]{}(\Varid{h'},\Varid{closptr})\;\mathrel{=}\;\Varid{h}\;\Varid{▸}\;(\Varid{c'},\Varid{e}){}\<[E]\\
\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Varid{h⊆h'}\;\mathrel{=}\;\Varid{h⊆h▸x}\;\Varid{h}{}\<[E]\\blanklineskip]\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Varid{nodes'i≡dcfg'}\;\mathbin{:}\;\Varid{nodes'}\;\Varid{i}\;\Varid{≡}\;\Varid{dcfg'}{}\<[E]\\
\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Varid{nodes'i≡dcfg'}\;\mathrel{=}\;\Varid{update-look}\;\Varid{nodes}\;\Varid{i}\;\Varid{dcfg'}{}\<[E]\\blanklineskip]\>[4]{}\hsindent{2}{}\<[6]\>[6]{}\Varid{luptr₂}\;\mathbin{:}\;\Varid{proj₂}\;(\Varid{heaps₂}\;\Varid{i})\;\mathbin{!}\;\Varid{ptr}_{\Varid{cnt}}\;\Varid{≡}\;\MyConid{just}\;((\Varid{c},\Varid{de}),\Varid{ds},\Varid{r}){}\<[E]\\
\>[4]{}\hsindent{2}{}\<[6]\>[6]{}\Varid{luptr₂}\;\mathrel{=}\;\Varid{trans}\;(\Varid{cong}\;(\Varid{λ}\;\Varid{p}\;\Varid{→}\;\Varid{proj₂}\;(\Varid{proj₂}\;\Varid{p})\;\mathbin{!}\;\Varid{ptr}_{\Varid{cnt}})\;(\Varid{update-look}\;\Varid{nodes₁}\;\Varid{i}\;\Varid{i-cfg₂}))\;{}\<[E]\\
\>[6]{}\hsindent{15}{}\<[21]\>[21]{}(\Varid{!-▸}\;(\Varid{proj₂}\;(\Varid{proj₂}\;(\Varid{nodes₁}\;\Varid{i})))\;((\Varid{c},\Varid{de}),\Varid{ds},\Varid{r})){}\<[E]\\blanklineskip]\>[4]{}\hsindent{2}{}\<[6]\>[6]{}\Varid{nodes₃}\;\mathrel{=}\;\Varid{update}\;\Varid{nodes₂}\;\Varid{loc}\;\Varid{loc-cfg₃}{}\<[E]\\
\>[4]{}\hsindent{2}{}\<[6]\>[6]{}\Varid{heaps₃}\;\mathrel{=}\;\Varid{proj₂}\;\Varid{∘}\;\Varid{nodes₃}{}\<[E]\\blanklineskip]\>[4]{}\hsindent{2}{}\<[6]\>[6]{}\Varid{heaps₁⊆sheaps₂}\;\mathrel{=}\;\Varid{update-heaps-⊆s}\;\Varid{nodes₁}\;\Varid{i}\;(\Varid{⊆-refl}\;\anonymous )\;(\Varid{h⊆h▸x}\;\Varid{i-conth₁}){}\<[E]\\
\>[4]{}\hsindent{2}{}\<[6]\>[6]{}\Varid{heaps₂⊆sheaps₃}\;\mathrel{=}\;\Varid{update-heaps-⊆s-same}\;\Varid{nodes₂}\;\Varid{loc}\;\Varid{refl}{}\<[E]\\
\>[4]{}\hsindent{2}{}\<[6]\>[6]{}\Varid{heaps₁⊆sheaps₃}\;\mathrel{=}\;\Varid{⊆s-trans}\;\Varid{heaps₁⊆sheaps₂}\;\Varid{heaps₂⊆sheaps₃}{}\<[E]\\blanklineskip]\>[3]{}\hsindent{4}{}\<[7]\>[7]{}((\Varid{dc},\Varid{de'}),(\Varid{ds},\Varid{r}),\Varid{lucontptr₂},\Conid{Rcdce'de'₁},\Conid{Rsds₁})\;{}\<[E]\\
\>[7]{}\hsindent{2}{}\<[9]\>[9]{}\mathrel{=}\;\Conid{HeapUpdate.lu-contptr}\;\Varid{h}\;\Varid{h}\;\Varid{heaps₁}\;\Varid{heaps₂}\;(\Varid{⊆-refl}\;\anonymous )\;\Varid{heaps₁⊆sheaps₂}\;(\Varid{ptr}_{\Varid{cnt}},\Varid{loc})\;\Conid{Rcont₁}{}\<[E]\\blanklineskip]\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Varid{nodes₃loc≡loc-cfg₃}\;\mathrel{=}\;\Varid{update-look}\;\Varid{nodes₂}\;\Varid{loc}\;\Varid{loc-cfg₃}{}\<[E]\\
\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Conid{Rmachine₃}\;\mathrel{=}\;\Conid{HeapUpdate-machine}\;\Varid{heaps₁}\;\Varid{heaps₃}\;\Varid{heaps₁⊆sheaps₃}\;\Varid{cfg'}\;(\Varid{proj₁}\;\Varid{loc-cfg₃})\;{}\<[E]\\
\>[7]{}\hsindent{30}{}\<[37]\>[37]{}(\Varid{proj₁}\;(\Conid{Rcdce'de'₁}\;\Varid{0}),\Varid{proj₂}\;\Varid{∘}\;\Conid{Rcdce'de'₁},\Conid{Rvdv₁},\Conid{Rsds₁}){}\<[E]\\blanklineskip]\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Varid{luptr₂}\;\mathbin{:}\;\Varid{proj₂}\;(\Varid{heaps₂}\;\Varid{i})\;\mathbin{!}\;\Varid{ptr}\;\Varid{≡}\;\MyConid{just}\;((\Varid{c},\Varid{de}),\Varid{ds},\Varid{r}){}\<[E]\\
\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Varid{luptr₂}\;\mathrel{=}\;\Varid{trans}\;{}\<[E]\\
\>[7]{}\hsindent{2}{}\<[9]\>[9]{}(\Varid{cong}\;(\Varid{λ}\;\Varid{p}\;\Varid{→}\;\Varid{proj₂}\;(\Varid{proj₂}\;\Varid{p})\;\mathbin{!}\;\Varid{ptr})\;(\Varid{update-look}\;\Varid{nodes₁}\;\Varid{i}\;\Varid{i-cfg₂}))\;{}\<[E]\\
\>[7]{}\hsindent{2}{}\<[9]\>[9]{}(\Varid{!-▸}\;(\Varid{proj₂}\;(\Varid{heaps₁}\;\Varid{i}))\;((\Varid{c},\Varid{de}),\Varid{ds},\Varid{r})){}\<[E]\\blanklineskip]\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Varid{heaps₂⊆sheaps₃}\;\mathrel{=}\;\Varid{update-heaps-⊆s-same}\;\Varid{nodes₂}\;\Varid{loc}\;\Varid{refl}{}\<[E]\\
\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Varid{heaps₁⊆sheaps₃}\;\mathrel{=}\;\Varid{⊆s-trans}\;\Varid{heaps₁⊆sheaps₂}\;\Varid{heaps₂⊆sheaps₃}{}\<[E]\\blanklineskip]\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Conid{Rede₃}\;\mathrel{=}\;\Conid{HeapUpdate.env}\;{}\<[32]\>[32]{}\Varid{h}\;\Varid{h}\;\Varid{heaps₁}\;\Varid{heaps₃}\;(\Varid{⊆-refl}\;\anonymous )\;\Varid{heaps₁⊆sheaps₃}\;\Varid{e}\;\Varid{de}\;{}\<[85]\>[85]{}\Varid{∘}\;\Conid{Rede₁}{}\<[E]\\
\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Conid{Rsds₃}\;\mathrel{=}\;\Conid{HeapUpdate.stack}\;\Varid{h}\;\Varid{h}\;\Varid{heaps₁}\;\Varid{heaps₃}\;(\Varid{⊆-refl}\;\anonymous )\;\Varid{heaps₁⊆sheaps₃}\;\Varid{s}\;(\Varid{ds},\Varid{r})\;\Conid{Rsds₁}{}\<[E]\\blanklineskip]\>[3]{}\hsindent{4}{}\<[7]\>[7]{}\Conid{Rmachine₃}\;\mathrel{=}\;\Varid{refl},(\Varid{λ}\;\Varid{n}\;\Varid{→}\;\Varid{tt}),(\Varid{c},\Varid{de}),(\Varid{ds},\Varid{r}),\Varid{luptr₃},(\Varid{λ}\;\Varid{n}\;\Varid{→}\;\Varid{refl},\Conid{Rede₃}\;\Varid{n}),\Conid{Rsds₃}{}\<[E]\\
\>[3]{}\hsindent{3}{}\<[6]\>[6]{}\Keyword{in}\;\Varid{nodes₃}{}\<[E]\\
\>[6]{}\hsindent{1}{}\<[7]\>[7]{},\Varid{node-step-comm}\;\Varid{nodes₁}\;\Varid{i}\;\Varid{loc}\;\Varid{ia}\;\Varid{eq}\;\MyConid{REMOTE-send}\;\MyConid{REMOTE-receive}{}\<[E]\\
\>[6]{}\hsindent{1}{}\<[7]\>[7]{},\Varid{loc},\Varid{nodes-ia-update}\;\Varid{nodes₁}\;\Varid{i}\;\Varid{loc}\;\Varid{ia}{}\<[E]\\
\>[6]{}\hsindent{1}{}\<[7]\>[7]{},\Conid{R-machine-node-eq}\;\Varid{nodes₃}\;\Varid{loc}\;\Varid{nodes₃loc≡loc-cfg₃}\;\Conid{Rmachine₃}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{6}{@{}>{\hspre}l<{\hspost}@{}}\column{21}{@{}>{\hspre}l<{\hspost}@{}}\column{23}{@{}>{\hspre}l<{\hspost}@{}}\column{25}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{GeneralLemmas}\;\Keyword{using}\;(\Varid{\char95 ≡\char95 };\Conid{Dec}){}\<[E]\\
\>[B]{}\Keyword{module}\;\Conid{DCESH.Presimulation-CESH}\;(\Conid{Node}\;\mathbin{:}\;\star)\;(\Varid{\char95 ≟\char95 }\;\mathbin{:}\;(\Varid{n}\;\Varid{n'}\;\mathbin{:}\;\Conid{Node})\;\Varid{→}\;\Conid{Dec}\;(\Varid{n}\;\Varid{≡}\;\Varid{n'}))\;\Keyword{where}{}\<[E]\\blanklineskip]\>[B]{}\Varid{lookup-var'}\;\mathbin{:}\;\Varid{∀}\;\{\mskip1.5mu \Varid{h}\;\Varid{hs}\;\Varid{v}\mskip1.5mu\}\;\Varid{e}\;\Varid{de}\;\Varid{x}\;\Varid{→}\;(\Varid{∀}\;\Varid{n}\;\Varid{→}\;\Varid{R}_{\Varid{Env}}\;\Varid{n}\;\Varid{h}\;\Varid{hs}\;\Varid{e}\;\Varid{de})\;\Varid{→}\;\Varid{lookup}\;\Varid{x}\;\Varid{de}\;\Varid{≡}\;\MyConid{just}\;\Varid{v}\;\Varid{→}\;\Varid{∃}\;\Varid{λ}\;\Varid{v'}\;\Varid{→}\;\Varid{lookup}\;\Varid{x}\;\Varid{e}\;\Varid{≡}\;\MyConid{just}\;\Varid{v'}{}\<[E]\\
\>[B]{}\Varid{lookup-var'}\;\Varid{e}\;[\mskip1.5mu \mskip1.5mu]\;\Varid{zero}\;\Conid{Rede}\;(){}\<[E]\\
\>[B]{}\Varid{lookup-var'}\;\Varid{e}\;[\mskip1.5mu \mskip1.5mu]\;(1+\;\Varid{x})\;\Conid{Rede}\;(){}\<[E]\\
\>[B]{}\Varid{lookup-var'}\;[\mskip1.5mu \mskip1.5mu]\;(\Varid{x}\;\Varid{∷}\;\Varid{de})\;\Varid{zero}\;\Conid{Rede}\;\Varid{look}\;\mathrel{=}\;\Varid{⊥-elim}\;(\Conid{Rede}\;\Varid{0}){}\<[E]\\
\>[B]{}\Varid{lookup-var'}\;(\Varid{x}\;\Varid{∷}\;\Varid{e})\;(\Varid{dx}\;\Varid{∷}\;\Varid{de})\;\Varid{zero}\;\Conid{Rede}\;\Varid{look}\;\mathrel{=}\;\Varid{x},\Varid{refl}{}\<[E]\\
\>[B]{}\Varid{lookup-var'}\;[\mskip1.5mu \mskip1.5mu]\;(\Varid{x}\;\Varid{∷}\;\Varid{de})\;(1+\;\Varid{x₁})\;\Conid{Rede}\;\Varid{look}\;\mathrel{=}\;\Varid{⊥-elim}\;(\Conid{Rede}\;\Varid{0}){}\<[E]\\
\>[B]{}\Varid{lookup-var'}\;(\Varid{x}\;\Varid{∷}\;\Varid{e})\;(\Varid{x₁}\;\Varid{∷}\;\Varid{de})\;(1+\;\Varid{x₂})\;\Conid{Rede}\;\Varid{look}\;\mathrel{=}\;\Varid{lookup-var'}\;\Varid{e}\;\Varid{de}\;\Varid{x₂}\;(\Varid{proj₂}\;\Varid{∘}\;\Conid{Rede})\;\Varid{look}{}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;\mathbin{:}\;\Varid{∀}\;\Varid{thread}\;\{\mskip1.5mu \Varid{n}\;\Varid{heaps}\;\Varid{hs}\;\Varid{hs'}\;\Varid{dcfg'}\mskip1.5mu\}\;\Varid{cfg}\;{}\<[E]\\
\>[B]{}\hsindent{21}{}\<[21]\>[21]{}\Varid{→}\;\Varid{⟶Machine}\;\Varid{n}\;(\MyConid{just}\;\Varid{thread},\Varid{hs})\;\MyConid{silent}\;(\Varid{dcfg'},\Varid{hs'})\;{}\<[E]\\
\>[B]{}\hsindent{21}{}\<[21]\>[21]{}\Varid{→}\;\Varid{R}_{\Varid{Thread}}\;\Varid{heaps}\;\Varid{cfg}\;(\MyConid{just}\;\Varid{thread})\;\Varid{→}\;\Varid{∃}\;\Varid{λ}\;\Varid{cfg'}\;\Varid{→}\;\Varid{cfg}\;\xrightarrow[\Varid{CESH}]{}\;\Varid{cfg'}{}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{VAR}\;\MyConid{var}\;\MyConid{;}\;\Varid{dc},\Varid{de},\Varid{ds},\Varid{r})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{VAR}\;\MyConid{var}\;\MyConid{;}\;\Varid{dc}),\Varid{e},\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\MyConid{VAR}\;\Varid{x})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rsds})\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\mathrel{=}\;\Keyword{let}\;(\Varid{v'},\Varid{y})\;\mathrel{=}\;\Varid{lookup-var'}\;\Varid{e}\;\Varid{de}\;\MyConid{var}\;\Conid{Rede}\;\Varid{x}{}\<[E]\\
\>[3]{}\hsindent{3}{}\<[6]\>[6]{}\Keyword{in}\;(\Varid{dc},\Varid{e},\MyConid{val}\;\Varid{v'}\;\Varid{∷}\;\Varid{s},\Varid{h}),\MyConid{VAR}\;\Varid{y}{}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{CLOS}\;\Varid{dc'}\;\MyConid{;}\;\Varid{dc},\Varid{de},\Varid{ds},\Varid{r})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{CLOS}\;\Varid{dc'}\;\MyConid{;}\;\Varid{dc}),\Varid{e},\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{CLOS}\;(\Varid{refl},\Conid{Rede},\Conid{Rsds})\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\mathrel{=}\;\Keyword{let}\;(\Varid{h'},\Varid{closptr})\;\mathrel{=}\;\Varid{h}\;\Varid{▸}\;(\Varid{dc'},\Varid{e}){}\<[E]\\
\>[3]{}\hsindent{3}{}\<[6]\>[6]{}\Keyword{in}\;(\Varid{dc},\Varid{e},\MyConid{val}\;(\MyConid{clos}\;\Varid{closptr})\;\Varid{∷}\;\Varid{s},\Varid{h'}),\MyConid{CLOS}{}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{APPL}\;\MyConid{;}\;\Varid{dc},\Varid{de},\MyConid{val}\;\Varid{dv}\;\Varid{∷}\;\MyConid{val}\;(\MyConid{clos}\;(\Varid{dc'},\Varid{de'}))\;\Varid{∷}\;\Varid{ds},\Varid{r})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{c},\Varid{e},[\mskip1.5mu \mskip1.5mu],\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\MyConid{APPL}\;\Varid{p})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Conid{Rcdc},\Conid{Rede},()){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{APPL}\;\MyConid{;}\;\Varid{dc},\Varid{de},\MyConid{val}\;\Varid{dv}\;\Varid{∷}\;\MyConid{val}\;(\MyConid{clos}\;(\Varid{dc'},\Varid{de'}))\;\Varid{∷}\;\Varid{ds},\Varid{r})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{c},\Varid{e},\MyConid{cont}\;\Varid{x}\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\MyConid{APPL}\;\Varid{p})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Conid{Rcdc},\Conid{Rede},(),\Conid{Rsds}){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{APPL}\;\MyConid{;}\;\Varid{dc},\Varid{de},\MyConid{val}\;\Varid{dv}\;\Varid{∷}\;\MyConid{val}\;(\MyConid{clos}\;(\Varid{dc'},\Varid{de'}))\;\Varid{∷}\;\Varid{ds},\Varid{r})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{c},\Varid{e},\MyConid{val}\;\Varid{v'}\;\Varid{∷}\;[\mskip1.5mu \mskip1.5mu],\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\MyConid{APPL}\;\Varid{p})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Conid{Rcdc},\Conid{Rede},\Conid{Rvdv},()){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{APPL}\;\MyConid{;}\;\Varid{dc},\Varid{de},\MyConid{val}\;\Varid{dv}\;\Varid{∷}\;\MyConid{val}\;(\MyConid{clos}\;(\Varid{dc'},\Varid{de'}))\;\Varid{∷}\;\Varid{ds},\Varid{r})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{c},\Varid{e},\MyConid{val}\;\Varid{v'}\;\Varid{∷}\;\MyConid{cont}\;\anonymous \;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\MyConid{APPL}\;\Varid{p})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Conid{Rcdc},\Conid{Rede},\Conid{Rvdv},(),\Conid{Rsds}){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{APPL}\;\MyConid{;}\;\Varid{dc},\Varid{de},\MyConid{val}\;\Varid{dv}\;\Varid{∷}\;\MyConid{val}\;(\MyConid{clos}\;(\Varid{dc'},\Varid{de'}))\;\Varid{∷}\;\Varid{ds},\Varid{r})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{c},\Varid{e},\MyConid{val}\;\Varid{v'}\;\Varid{∷}\;\MyConid{val}\;(\MyConid{nat}\;\Varid{n})\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\MyConid{APPL}\;\Varid{p})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Conid{Rcdc},\Conid{Rede},\Conid{Rvdv},\Conid{Rv'dv'},\Conid{Rsds})\;\mathrel{=}\;\Varid{⊥-elim}\;(\Conid{Rv'dv'}\;\Varid{0}){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{APPL}\;\MyConid{;}\;\Varid{dc},\Varid{de},\MyConid{val}\;\Varid{dv}\;\Varid{∷}\;\MyConid{val}\;(\MyConid{clos}\;(\Varid{dc'},\Varid{de'}))\;\Varid{∷}\;\Varid{ds},\Varid{r})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{APPL}\;\MyConid{;}\;\Varid{dc}),\Varid{e},\MyConid{val}\;\Varid{v'}\;\Varid{∷}\;\MyConid{val}\;(\MyConid{clos}\;\Varid{closptr})\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\MyConid{APPL}\;\Varid{p})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},\Conid{Rcldcl},\Conid{Rsds})\;\Keyword{with}\;\Conid{Rcldcl}\;\Varid{1}{}\<[E]\\
\>[B]{}\Varid{...}\;\mid \;((\Varid{c'},\Varid{e'}),\anonymous ,\Varid{lu},\anonymous )\;\mathrel{=}\;(\Varid{c'},\Varid{v'}\;\Varid{∷}\;\Varid{e'},\MyConid{cont}\;(\Varid{dc},\Varid{e})\;\Varid{∷}\;\Varid{s},\Varid{h}),\MyConid{APPL}\;\Varid{lu}{}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\Varid{.RETURN},\Varid{de},(\MyConid{val}\;\Varid{dv}\;\Varid{∷}\;\MyConid{cont}\;(\Varid{dc},\Varid{de'})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{.RETURN},\Varid{e},[\mskip1.5mu \mskip1.5mu],\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{RET}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},()){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\Varid{.RETURN},\Varid{de},(\MyConid{val}\;\Varid{dv}\;\Varid{∷}\;\MyConid{cont}\;(\Varid{dc},\Varid{de'})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{.RETURN},\Varid{e},\MyConid{cont}\;\anonymous \;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{RET}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},(),\Conid{Rsds}){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\Varid{.RETURN},\Varid{de},(\MyConid{val}\;\Varid{dv}\;\Varid{∷}\;\MyConid{cont}\;(\Varid{dc},\Varid{de'})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{.RETURN},\Varid{e},\MyConid{val}\;\Varid{v}\;\Varid{∷}\;[\mskip1.5mu \mskip1.5mu],\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{RET}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},()){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\Varid{.RETURN},\Varid{de},(\MyConid{val}\;\Varid{dv}\;\Varid{∷}\;\MyConid{cont}\;(\Varid{dc},\Varid{de'})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{.RETURN},\Varid{e},\MyConid{val}\;\Varid{v}\;\Varid{∷}\;\MyConid{val}\;\anonymous \;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{RET}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},(),\Conid{Rsds}){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\Varid{.RETURN},\Varid{de},(\MyConid{val}\;\Varid{dv}\;\Varid{∷}\;\MyConid{cont}\;(\Varid{dc},\Varid{de'})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{.RETURN},\Varid{e},\MyConid{val}\;\Varid{v}\;\Varid{∷}\;\MyConid{cont}\;(\Varid{c},\Varid{e'})\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{RET}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},\Conid{Rcont},\Conid{Rsds})\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\mathrel{=}\;(\Varid{c},\Varid{e'},\MyConid{val}\;\Varid{v}\;\Varid{∷}\;\Varid{s},\Varid{h}),\MyConid{RET}{}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{LIT}\;\Varid{n}\;\MyConid{;}\;\Varid{dc},\Varid{de},(\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{LIT}\;\Varid{n}\;\MyConid{;}\;\Varid{dc}),\Varid{e},\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{LIT}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rsds})\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\mathrel{=}\;(\Varid{dc},\Varid{e},\MyConid{val}\;(\MyConid{nat}\;\Varid{n})\;\Varid{∷}\;\Varid{s},\Varid{h}),\MyConid{LIT}{}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{dc},\Varid{de},(\MyConid{val}\;(\MyConid{nat}\;\Varid{l₁})\;\Varid{∷}\;\MyConid{val}\;(\MyConid{nat}\;\Varid{l₂})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{dc}),\Varid{e},[\mskip1.5mu \mskip1.5mu],\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{OP}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},()){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{dc},\Varid{de},(\MyConid{val}\;(\MyConid{nat}\;\Varid{l₁})\;\Varid{∷}\;\MyConid{val}\;(\MyConid{nat}\;\Varid{l₂})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{dc}),\Varid{e},\MyConid{cont}\;\anonymous \;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{OP}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},(),\Conid{Rsds}){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{dc},\Varid{de},(\MyConid{val}\;(\MyConid{nat}\;\Varid{l₁})\;\Varid{∷}\;\MyConid{val}\;(\MyConid{nat}\;\Varid{l₂})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{dc}),\Varid{e},\MyConid{val}\;(\MyConid{clos}\;\Varid{c})\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{OP}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},\Conid{Rsds})\;\mathrel{=}\;\Varid{⊥-elim}\;(\Conid{Rvdv}\;\Varid{0}){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{dc},\Varid{de},(\MyConid{val}\;(\MyConid{nat}\;\Varid{l₁})\;\Varid{∷}\;\MyConid{val}\;(\MyConid{nat}\;\Varid{l₂})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{dc}),\Varid{e},\MyConid{val}\;(\MyConid{nat}\;\Varid{l₁'})\;\Varid{∷}\;[\mskip1.5mu \mskip1.5mu],\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{OP}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},()){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{dc},\Varid{de},(\MyConid{val}\;(\MyConid{nat}\;\Varid{l₁})\;\Varid{∷}\;\MyConid{val}\;(\MyConid{nat}\;\Varid{l₂})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{dc}),\Varid{e},\MyConid{val}\;(\MyConid{nat}\;\Varid{l₁'})\;\Varid{∷}\;\MyConid{cont}\;\anonymous \;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{OP}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},(),\Conid{Rsds}){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{dc},\Varid{de},(\MyConid{val}\;(\MyConid{nat}\;\Varid{l₁})\;\Varid{∷}\;\MyConid{val}\;(\MyConid{nat}\;\Varid{l₂})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{dc}),\Varid{e},\MyConid{val}\;(\MyConid{nat}\;\Varid{l₁'})\;\Varid{∷}\;\MyConid{val}\;(\MyConid{clos}\;\anonymous )\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{OP}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},\Conid{Rvdv'},\Conid{Rsds})\;\mathrel{=}\;\Varid{⊥-elim}\;(\Conid{Rvdv'}\;\Varid{0}){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{dc},\Varid{de},(\MyConid{val}\;(\MyConid{nat}\;\Varid{l₁})\;\Varid{∷}\;\MyConid{val}\;(\MyConid{nat}\;\Varid{l₂})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{OP}\;\Varid{f}\;\MyConid{;}\;\Varid{dc}),\Varid{e},\MyConid{val}\;(\MyConid{nat}\;\Varid{l₁'})\;\Varid{∷}\;\MyConid{val}\;(\MyConid{nat}\;\Varid{l₂'})\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{OP}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},\Conid{Rvdv'},\Conid{Rsds})\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\mathrel{=}\;(\Varid{dc},\Varid{e},\MyConid{val}\;(\MyConid{nat}\;(\Varid{f}\;\Varid{l₁'}\;\Varid{l₂'}))\;\Varid{∷}\;\Varid{s},\Varid{h}),\MyConid{OP}{}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'},\Varid{de},(\MyConid{val}\;(\MyConid{nat}\;\Varid{.0})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'}),\Varid{e},[\mskip1.5mu \mskip1.5mu],\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{COND-0}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},()){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'},\Varid{de},(\MyConid{val}\;(\MyConid{nat}\;\Varid{.0})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'}),\Varid{e},\MyConid{cont}\;\anonymous \;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{COND-0}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},(),\Conid{Rsds}){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'},\Varid{de},(\MyConid{val}\;(\MyConid{nat}\;\Varid{.0})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'}),\Varid{e},\MyConid{val}\;(\MyConid{clos}\;\anonymous )\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{COND-0}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},\Conid{Rsds})\;\mathrel{=}\;\Varid{⊥-elim}\;(\Conid{Rvdv}\;\Varid{0}){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'},\Varid{de},(\MyConid{val}\;(\MyConid{nat}\;\Varid{.0})\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'}),\Varid{e},\MyConid{val}\;(\MyConid{nat}\;\Varid{n})\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{COND-0}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},\Conid{Rsds})\;\Keyword{with}\;\Conid{Rvdv}\;\Varid{0}{}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'},\Varid{de},\MyConid{val}\;(\MyConid{nat}\;\Varid{.\char95 })\;\Varid{∷}\;\Varid{ds},\Varid{r})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'}),\Varid{e},\MyConid{val}\;(\MyConid{nat}\;\Varid{.0})\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{COND-0}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},\Conid{Rsds})\;\mid \;\Varid{refl}\;\mathrel{=}\;(\Varid{c},\Varid{e},\Varid{s},\Varid{h}),\MyConid{COND-0}{}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'},\Varid{de},(\MyConid{val}\;(\MyConid{nat}\;(1+\;\Varid{l}))\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'}),\Varid{e},[\mskip1.5mu \mskip1.5mu],\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{COND-1+n}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},()){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'},\Varid{de},(\MyConid{val}\;(\MyConid{nat}\;(1+\;\Varid{l}))\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'}),\Varid{e},\MyConid{cont}\;\anonymous \;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{COND-1+n}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},(),\Conid{Rsds}){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'},\Varid{de},(\MyConid{val}\;(\MyConid{nat}\;(1+\;\Varid{l}))\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'}),\Varid{e},\MyConid{val}\;(\MyConid{clos}\;\anonymous )\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{COND-1+n}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},\Conid{Rsds})\;\mathrel{=}\;\Varid{⊥-elim}\;(\Conid{Rvdv}\;\Varid{0}){}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'},\Varid{de},(\MyConid{val}\;(\MyConid{nat}\;(1+\;\Varid{l}))\;\Varid{∷}\;\Varid{ds},\Varid{r}))\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'}),\Varid{e},\MyConid{val}\;(\MyConid{nat}\;\Varid{l'})\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{COND-1+n}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},\Conid{Rsds})\;\Keyword{with}\;\Conid{Rvdv}\;\Varid{0}{}\<[E]\\
\>[B]{}\Varid{presimulation-sync-<silent>}\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'},\Varid{de},\MyConid{val}\;(\MyConid{nat}\;(1+\;\Varid{l}))\;\Varid{∷}\;\Varid{ds},\Varid{r})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(.\;(\MyConid{COND}\;\Varid{c}\;\Varid{c'}),\Varid{e},\MyConid{val}\;(\MyConid{nat}\;.\;(1+\;\Varid{l}))\;\Varid{∷}\;\Varid{s},\Varid{h})\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}\MyConid{COND-1+n}\;{}\<[E]\\
\>[B]{}\hsindent{25}{}\<[25]\>[25]{}(\Varid{refl},\Conid{Rede},\Conid{Rvdv},\Conid{Rsds})\;\mid \;\Varid{refl}\;{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\mathrel{=}\;(\Varid{c'},\Varid{e},\Varid{s},\Varid{h}),\MyConid{COND-1+n}{}\<[E]\\blanklineskip]\>[B]{}\Keyword{open}\;\Keyword{import}\;\Conid{GeneralLemmas}{}\<[E]\\blanklineskip]\>[B]{}\Keyword{open}\;\Conid{Bisimulation}\;{\dummy\xrightarrow[\Varid{CESH}]{}\dummy}\;{\dummy\xrightarrow[\Varid{Sync}]{}\dummy}\;\Keyword{hiding}\;(\Conid{Bisimulation}){}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}

\begin{theorem}[{\textsmaller[.5]{\ensuremath{\Varid{bisimulation}_{\Varid{Sync}}}}}]
{\textsmaller[.5]{\ensuremath{\Varid{R}_{\Varid{Sync}}}}} is a bisimulation.
\iffullversion
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Varid{bisimulation}_{\Varid{Sync}}\;\mathbin{:}\;\Conid{Bisimulation}\;{\dummy\xrightarrow[\Varid{CESH}]{}\dummy}\;{\dummy\xrightarrow[\Varid{Sync}]{}\dummy}\;\Varid{R}_{\Varid{Sync}}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\fi
\end{theorem}
\begin{proof}
Theorem {\textsmaller[.5]{\ensuremath{\Varid{presimulation-to-simulation}}}} applied to
{\textsmaller[.5]{\ensuremath{\Varid{determinism}_{\Varid{Sync}}}}} and {\textsmaller[.5]{\ensuremath{\Varid{simulation}_{\Varid{Sync}}}}} implies that {\textsmaller[.5]{\ensuremath{\Varid{R}_{\Varid{Sync}}\;\Varid{⁻¹}}}} is a simulation, which together with {\textsmaller[.5]{\ensuremath{\Varid{simulation}_{\Varid{Sync}}}}} shows that
{\textsmaller[.5]{\ensuremath{\Varid{R}_{\Varid{Sync}}}}} is a bisimulation.
\end{proof}
\begin{comment}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}\column{3}{@{}>{\hspre}l<{\hspost}@{}}\column{5}{@{}>{\hspre}l<{\hspost}@{}}\column{E}{@{}>{\hspre}l<{\hspost}@{}}\>[B]{}\Varid{bisimulation}_{\Varid{Sync}}\;\mathrel{=}\;\Varid{simulation-to-bisimulation}\;\Varid{R}_{\Varid{Sync}}\;\Varid{simulation}_{\Varid{Sync}}\;\Varid{presimulation}_{\Varid{Sync}}\;\Varid{det}{}\<[E]\\
\>[B]{}\hsindent{3}{}\<[3]\>[3]{}\Keyword{where}{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}\Varid{det}\;\mathbin{:}\;\Varid{∀}\;\Varid{a}\;\Varid{b}\;\Varid{→}\;\Varid{R}_{\Varid{Sync}}\;\Varid{a}\;\Varid{b}\;\Varid{→}\;{\dummy\xrightarrow[\Varid{Sync}]{}\dummy}\;\Varid{is-deterministic-at}\;\Varid{b}{}\<[E]\\
\>[3]{}\hsindent{2}{}\<[5]\>[5]{}\Varid{det}\;\Varid{a}\;\Varid{b}\;(\Varid{n},\Varid{ia},\Conid{Rmachine})\;\mathrel{=}\;\Varid{determinism}_{\Varid{Sync}}\;\Varid{b}\;\Varid{n}\;\Varid{ia}{}\<[E]\\blanklineskip]\>[B]{}\Varid{initial-related}_{\Varid{Async}}\;\mathbin{:}\;\Varid{∀}\;\Varid{code}\;\Varid{root}\;\Varid{→}\;\Varid{R}_{\Varid{Async}}\;(\Varid{code},[\mskip1.5mu \mskip1.5mu],[\mskip1.5mu \mskip1.5mu],\Varid{∅})\;(\Varid{initial-network}_{\Varid{Async}}\;\Varid{code}\;\Varid{root}){}\<[E]\\
\>[B]{}\Varid{initial-related}_{\Varid{Async}}\;\Varid{code}\;\Varid{root}\;\mathrel{=}\;\Varid{initial-related}_{\Varid{Sync}}\;\Varid{code}\;\Varid{root}{}\<[E]\\blanklineskip]\>[B]{}\Varid{bisimilarity}\;\mathbin{:}\;\Varid{∀}\;\Varid{code}\;\Varid{root}\;\Varid{→}\;(\Varid{code},[\mskip1.5mu \mskip1.5mu],[\mskip1.5mu \mskip1.5mu],\Varid{∅})\;\mathord{\sim}\;\Varid{initial-network}_{\Varid{Sync}}\;\Varid{code}\;\Varid{root}{}\<[E]\\
\>[B]{}\Varid{bisimilarity}\;\Varid{code}\;\Varid{root}\;\mathrel{=}\;\Varid{R}_{\Varid{Sync}},\Varid{bisimulation}_{\Varid{Sync}},\Varid{initial-related}_{\Varid{Sync}}\;\Varid{code}\;\Varid{root}{}\<[E]\ColumnHook
\end{hscode}\resethooks
\end{comment}

These final results complete the picture for the \DCESHn{} machine. We
have established that we get the same final result regardless of
whether we choose to run a fragment of code using the CES, the CESH,
or the \DCESHn{} machine.

\section{Related work}

There is a multitude of programming languages and libraries for distributed
computing. We focus mostly on those with a functional flavour. For surveys, see
\cite{DBLP:journals/jfp/TrinderLP02, DBLP:journals/lisp/LoidlRSHHKLMPPPT03}.
Broadly speaking, we can divide them into those that use some form of explicit
message passing, and those that have more implicit mechanisms for distribution
and communication.

\paragraph*{Explicit}
A prime example of a language for distributed computing that uses explicit
message passing is Erlang~\cite{DBLP:books/daglib/0073501}. Erlang is a very
successful language used prominently in the telecommunication industry.
Conceptually similar solutions include MPI~\cite{gropp1999using} and Cloud
Haskell~\cite{DBLP:conf/haskell/EpsteinBJ11}.
The theoretically advanced projects Nomadic
Pict~\cite{DBLP:journals/ieeecc/WojciechowskiS00} and the distributed join
calculus~\cite{DBLP:conf/concur/FournetGLMR96} both support a notion of
mobility for distributed agents, which enables more expressivity for the
distribution of a program than the fairly static networks that our work uses.
In general, explicit languages are well-proven, but far away in the language
design-space from the seamless distributed computing that we envision because
they place the burden of explicit communication on the programmer.


\paragraph*{Implicit}
Our work can be seen as a generalised Remote Procedure
Call (RPC)~\cite{DBLP:journals/tocs/BirrelN84}.  In \emph{loc. cit.} it is argued
that emulating a shared address space is infeasible since it requires each
pointer to also contain location information, and that it is questionable
whether acceptable efficiency can be achieved.  These arguments certainly apply
to our work, where we do just this. With the goal of expressivity in mind,
however, we believe that we should \emph{enable} the programmer to write the
potentially inefficient programs that (internally) use remote pointers, because
not all programs are performance critical. Furthermore, using a tagged pointer
representation~\cite{DBLP:conf/icfp/MarlowYJ07} for closure pointers means that
we can tag pointers that are remote, and pay a very low, if any, performance
penalty for local pointers.

Remote Evaluation (REV)~\cite{DBLP:journals/toplas/StamosG90} is another
generalisation of RPC, siding with us on enabling the use of
higher-order functions across node boundaries. The main differences between REV
and our work is that REV relies on sending code and that it has a more general
distribution mechanism.

The well-researched project Eden~\cite{DBLP:journals/jfp/LoogenOP05}, which
builds on Haskell, is a semi-implicit language. Eden allows expressing
distributed algorithms at a high level of abstraction, and is mostly implicit
about communication, but explicit about process creation. Eden is specified
operationally using a two-level semantics similar to ours.

Hop~\cite{DBLP:conf/oopsla/SerranoGL06}, Links~\cite{DBLP:conf/fmco/CooperLWY06},
and ML5~\cite{DBLP:conf/tgc/VIICH07}
are examples of so called
\emph{tierless} languages that allow writing (for instance) the client and
server code of web applications in unified languages with more or less
seamless interoperability between them. We believe that our work shows
how a principled back-end and semantics can work for such languages.


\section{Conclusion and further work}
We have seen the definition and correctness proofs of \DCESHn{}, a distributed
abstract machine. Previously we have argued that distributed and heterogeneous
programming would benefit from languages that are architecture-independent,
using compilation based on the idea of seamless
computing~\cite{DBLP:conf/lics/FredrikssonG13}. This would allow the programmer
to focus on solving algorithmic problems without having to worry about the
low-level details of the underlying computational system. Our previous work
shows how to achieve this, but is very different from conventional compilation
techniques, relying on game semantics. This means that the vast literature on compiler optimisation does
not generally apply to it, and that it is difficult to interface with legacy
code.  We believe that the current work alleviates these issues, since it shows
a way to do distributed execution as a conservative extension of existing
abstract machines.  Additionally, \DCESHn{} adds very little overhead, if any,
for \emph{local} execution, while permitting any sub-terms to be seamlessly
distributed.



\paragraph*{Implementation}
An implementation of the \DCESHn{} machine can be constructed by 
\iffullversion
either a bytecode
interpreter or 
\fi
compiling the bytecode into a low-level language by macro expansion.  We have a
prototype implementation that does
\iffullversion
the latter,
\else
this,
\fi
illustrating the potential for
using \DCESHn{} as a basis for a usable 
\ifnotfullversion
compiler \cite{SourceCode}.
\else
compiler.
\fi

\paragraph*{Outstanding questions}
\begin{itemize}
  \item Do the proofs generalise to a language with parallelism?
  \item Can we efficiently do distributed garbage collection
  \cite{DBLP:conf/iwmm/PlainfosseS95}? This is necessary, since \DCESHn{}, in
  contrast to our previous work, never reclaims heap garbage. 
  \iffullversion
  It would also be interesting to find out if parts of programs can use
  \emph{local} garbage collection for better performance.
  \fi
  \item Can we find a way to express more complicated distribution patterns
  than those made possible by locus specifiers? From our experience, locus
  specifiers are excellent for simple programs (especially those with
  client-server disciplines), but due to the static nature of the specifiers,
  it is hard to express dynamic distributed algorithms.
  We believe that our work can be extended with dynamic locus specifiers to
  handle this.
  \iffullversion
  A simple first step would be to add support for compiling parts of a program
  for more than one node at a time, making it possible to pass (references to)
  functions already existing on some remote node to it.
  \item Can we add support for sending code code (like
  REV~\cite{DBLP:journals/toplas/StamosG90}) when the code is location-independent?
  \fi
\end{itemize}
\iffullversion
Two other language features that our abstract machines currently do not handle,
but that we would like to implement are abstract data types and mutable
references.
\fi

\section*{Acknowledgements}
\iffullversion
The author would like to thank
Mart\'{i}n Escard\'{o} for assistance with Agda,
Fredrik Nordvall Forsberg for rubber ducking,
Dan Ghica for fruitful discussions and supervision,
and Paul Blain Levy for simplifying some of the definitions.

\else
The author would like to thank
Mart\'{i}n Escard\'{o},
Fredrik Nordvall Forsberg,
Dan Ghica,
and Paul Blain Levy.
\fi
This work was supported by Microsoft Research through its PhD Scholarship
Programme.



\bibliographystyle{IEEEtran}
\iffullversion
\bibliography{IEEEabrv,\jobname,dblprefs}
\else
\bibliography{IEEEabrv,\jobname,shortdblp}
\fi

\end{document}
