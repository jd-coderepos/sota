\section{Experiments}
\label{exp}
\begin{figure*}[t]
	\centering
\setlength{\abovecaptionskip}{0cm}
	\centering
	\setlength{\tabcolsep}{0.05em}
	\setlength{\fboxrule}{1pt}
	\setlength{\fboxsep}{0pt}
	\begin{tabular}{cccccccc}
		PSNR / SSIM& 17.16 / 0.8792  & 23.12 / 0.9598 & 26.64 / 0.9757 & 27.39 / 0.9718 & 29.94 / 0.9758 & 31.10 / 0.9859 &  / 1 \\	   		
		\includegraphics[width=.12\linewidth]{fig/outdoor/rect/hazy.jpg} &
		\includegraphics[width=.12\linewidth]{fig/outdoor/rect/aod.jpg} &
		\includegraphics[width=.12\linewidth]{fig/outdoor/rect/gdn.png} &
		\includegraphics[width=.12\linewidth]{fig/outdoor/rect/ffa.png} &
		\includegraphics[width=.12\linewidth]{fig/outdoor/rect/maxim.png} &
		\includegraphics[width=.12\linewidth]{fig/outdoor/rect/dehamer.png} &
		\includegraphics[width=.12\linewidth]{fig/outdoor/rect/ours.png}&
		\includegraphics[width=.12\linewidth]{fig/outdoor/rect/clear.png}\\	
		\fcolorbox{red}{red}{\includegraphics[width=.117\linewidth]{fig/outdoor/crop/hazy.jpg}} &
		\fcolorbox{red}{red}{\includegraphics[width=.117\linewidth]{fig/outdoor/crop/aod.jpg}} &
		\fcolorbox{red}{red}{\includegraphics[width=.117\linewidth]{fig/outdoor/crop/gdn.png}} &
		\fcolorbox{red}{red}{\includegraphics[width=.117\linewidth]{fig/outdoor/crop/ffa.png}}&
		\fcolorbox{red}{red}{\includegraphics[width=.117\linewidth]{fig/outdoor/crop/maxim.png}} &
		\fcolorbox{red}{red}{\includegraphics[width=.117\linewidth]{fig/outdoor/crop/dehamer.png}}&
		\fcolorbox{red}{red}{\includegraphics[width=.117\linewidth]{fig/outdoor/crop/ours.png}}&
		\fcolorbox{red}{red}{\includegraphics[width=.117\linewidth]{fig/outdoor/crop/clear.png}}\\
		Hazy Image &AODNet~\cite{li2017aod}&GDN~\cite{liu2019griddehazenet}&FFA-Net~\cite{qin2020ffa}&MAXIM~\cite{tu2022maxim}&DeHamer~\cite{guo2022image}&CPNet (Ours)&GT
	\end{tabular}
	\caption{Visual results of SOTS-outdoor dataset by different methods. (Zoom in for better view.)
	}
	\label{fig:outdoor}
\end{figure*}









\subsection{Experimental Settings}
\textbf{Implementation Details.} We implement CPNet using Pytorch 1.11.0 on an NVIDIA RTX 3090 GPU. Adam optimizer is used with exponential decay rates  and . The initial learning rate is set to 0.0001 and is scheduled by cosine annealing strategy~\cite{he2019bag}. The batch size is set to 2. We empirically set the penalty parameters  to 0.2, and  to 0.25 for 200 epochs. We follow CR~\cite{wu2021contrastive} that set the L1 distance in Eq.\eqref{equ:R} after the latent features of the 1st, 3rd, 5th, 9th and 13th layers from the fixed pre-trained VGG-19, and their corresponding weights  to  and 1, respectively.


\textbf{Datasets.} For fair comparisons, we evaluate the proposed method on synthetic datasets and real-world datasets. RESIDE~\cite{li2018benchmarking} is a widely used benchmark dataset. Among the five subsets, we select ITS and OTS as our training datasets and SOTS-indoor and SOTS-outdoor as our testing datasets for synthetic image dehazing. We also use two real-world datasets: Dense-Haze~\cite{ancuti2019dense} and NH-Haze2~\cite{ancuti2021ntire} for real image dehazing.


\textbf{Competitors and Evaluation Metrics.} We compare our method with the prior-based method (\eg, DCP~\cite{he2010single}), physical model based methods(\eg, DehazeNet~\cite{cai2016dehazenet}, AOD-Net~\cite{li2017aod}, and DM2F-Net~\cite{Deng2019}), and hazy-to-clear image translation based methods (\eg, GDN~\cite{liu2019griddehazenet}, GCANet~\cite{chen2019gated}, FFA-Net~\cite{qin2020ffa}, MSBDN~\cite{dong2020multi}, AECR-Net~\cite{wu2021contrastive}, MAXIM-2S~\cite{tu2022maxim}, DeHamer~\cite{guo2022image}, and UDN~\cite{hong2022uncertainty}). We utilize the peak signal-to-noise ratio (PSNR) and structural similarity (SSIM) to evaluate the performance.
\begin{figure*}[t]
	\centering
	\setlength{\abovecaptionskip}{0cm}
	\setlength{\fboxrule}{1pt}
	\setlength{\fboxsep}{0pt}
	\setlength{\tabcolsep}{0.05em}	
	\begin{tabular}{cccccccc}
		PSNR / SSIM& 11.56 / 0.4480  &17.81 / 0.5828 & 19.35 / 0.6666 & 19.83 / 0.6114 & 22.82 / 0.6312 & 22.94 / 0.6776 &  / 1 \\	   		
		\includegraphics[width=.12\linewidth]{fig/NH19/hazy.jpg} &
		\includegraphics[width=.12\linewidth]{fig/NH19/AODNet.jpg} &
		\includegraphics[width=.12\linewidth]{fig/NH19/GDN.jpg} &
		\includegraphics[width=.12\linewidth]{fig/NH19/FFANet.jpg} &
		\includegraphics[width=.12\linewidth]{fig/NH19/AECRNet.jpg} &
		\includegraphics[width=.12\linewidth]{fig/NH19/Dehamer.jpg} &
		\includegraphics[width=.12\linewidth]{fig/NH19/ours.jpg}&
		\includegraphics[width=.12\linewidth]{fig/NH19/GT.jpg}\\			
\end{tabular}	
	\label{fig:NH19}
	
	\centering
	\setlength{\tabcolsep}{0.05em}	
	\begin{tabular}{cccccccc}
		PSNR / SSIM& 12.22 / 0.5895  &19.30 / 0.7741 & 18.09 / 0.8145 & 19.74 / 0.8312 & 17.21 / 0.7673 & 20.09 / 0.8281 &  / 1 \\	   		
		\includegraphics[width=.12\linewidth]{fig/NH21/hazy.jpg} &
		\includegraphics[width=.12\linewidth]{fig/NH21/AODNet.jpg} &
		\includegraphics[width=.12\linewidth]{fig/NH21/GDN.jpg} &
		\includegraphics[width=.12\linewidth]{fig/NH21/FFANet.jpg} &
		\includegraphics[width=.12\linewidth]{fig/NH21/AECRNet.jpg} &
		\includegraphics[width=.12\linewidth]{fig/NH21/Dehamer.jpg} &
		\includegraphics[width=.12\linewidth]{fig/NH21/ours.jpg}&
		\includegraphics[width=.12\linewidth]{fig/NH21/GT.jpg}\\			
		Hazy Image &AODNet~\cite{li2017aod}&GDN~\cite{liu2019griddehazenet}&FFA-Net~\cite{qin2020ffa}&AECRNet~\cite{wu2021contrastive}&DeHamer~\cite{guo2022image}&CPNet (Ours)&GT
	\end{tabular}	
	\caption{Visual results of Dense-Haze (top) and NH-Haze2 (bottom) datasets by different methods. (Zoom in for better view.)}\vspace{-2mm}
	\label{fig:NH21}
\end{figure*}

\subsection{Comparison with SOTAs}
\textbf{Results on Synthetic Datasets.}
Regarding the evaluation of synthetic datasets, Table.~\ref{tab:quantitative} reports the average PSNR and SSIM values of different competitors for SOTS-indoor and SOTS-outdoor datasets. Our CPNet achieves the best performance on both datasets compared to other SOTAs, with 42.56dB PSNR and 0.9954 SSIM in SOTS-indoor, and 36.68dB PSNR and 0.9900 SSIM in SOTS-outdoor. Specifically, our method outperforms the second-best method UDN by a significant margin on SOTS-indoor, \ie, 3.94dB PSNR and 0.0045 SSIM. Moreover, our method achieves at least 1.50dB PSNR and 0.0029 SSIM performance gains on SOTS-outdoor. In addition, we respectively visualize the recovered images from the SOTS-indoor and the SOTS-outdoor datasets by different methods in Fig.~\ref{fig:indoor} and Fig.~\ref{fig:outdoor}. It can be observed that AODNet and GDN fail to remove most of the haze, while FFA-Net, MAXIM-2S, and DeHamer suffer from severe color distortion, and their results still contain some artifacts. Instead, our method generates the most natural restoration that preserves more details and involves fewer color distortions. Note that we can adjust the number of blocks in our network to balance the performance and the number of parameters. More details are included in the supplementary.


\textbf{Results on Real-world Datasets.}
We also evaluate the proposed CPNet on real-world datasets including Dense-Haze and NH-Haze2 datasets, summarizing the quantitative results in Table~\ref{tab:quantitative}. It is worth noting that removing haze from real-world images is much more challenging than from synthetic images. Nevertheless, our method outperforms all the other competitors on both datasets in terms of PSNR and SSIM. We also visualize the results in Fig.~\ref{fig:NH21}. Despite the reconstructions of all the comparisons generally being far from good, our method produces the most desired image that succeeded in removing most of the haze. 

\vspace{-2mm}\subsection{Ablation Study}\vspace{-2mm}
\begin{table}[t]
	\caption{Ablation study on CPNet with different modules and regularizations on SOTS-indoor dataset.}
	\centering
	\small
	\begin{tabular}{c||c|c}
		\toprule
		Model&PSNR&SSIM\\	
		\midrule
		base (FFA-Net) &36.39&0.9886\\
		
		base+FDU&36.59&0.9894\\
		
		base+PDU  &38.30&0.9914\\		
		
		base+PDU+CR(non-consensual,1:10)  &41.32&0.9947\\	
		
		base+PDU+CR(consensual,1:7)+w/o CL  &42.09&0.9951\\		
		\midrule
		\textbf{Ours (1:7)} &\textbf{42.56}&\textbf{0.9954}\\
		\bottomrule
	\end{tabular}\vspace{-5mm}
	\label{tab:ablation}
\end{table}

\begin{table*}[t]
	\caption{Evaluation of applying curricular contrastive regularization into SOTAs.}\vspace{-2mm}
	\centering	
	\resizebox{0.85\textwidth}{!}{
		\begin{tabular}{c|c|c|c||c||c|c|c|c|c}
			\toprule
			\multicolumn{4}{c||}{Regularization}&\multirow{2}*{Metric}&\multicolumn{5}{c}{Method}\\
			\cmidrule(lr){1-4}		
			\cmidrule(lr){6-10}
			CR&Space&CL&Rate&&GCANet~\cite{chen2019gated}&GDN~\cite{liu2019griddehazenet}&MSBDN~\cite{dong2020multi}&FFANet~\cite{qin2020ffa}&DMTNet~\cite{liu2021synthetic}\\
			\midrule
			\multirow{2}*{\XSolidBrush}&\multirow{2}*{N/A}&\multirow{2}*{N/A}&\multirow{2}*{N/A}&PSNR&30.06&32.16&33.79&36.39&28.53\\
			
			&&&&SSIM&0.9596&0.9836&0.9835&0.9886&0.96\\
			\midrule
			\multirow{2}*{\Checkmark}&\multirow{2}*{\footnotesize{non-consensual}}&\multirow{2}*{\XSolidBrush}&\multirow{2}*{1:10}&PSNR&29.83&33.36&34.74&37.21&30.88\\
			&&&&SSIM&0.9611&0.9867&0.9859&0.9920&0.9785\\
			\midrule
			\multirow{2}*{\Checkmark}&\multirow{2}*{\footnotesize{consensual}}&\multirow{2}*{\XSolidBrush}&\multirow{2}*{1:7}&PSNR&29.91&34.91& 34.95&38.93&31.16\\
			&&&&SSIM&0.9612&\textbf{0.9892}&0.9865&0.9936&0.9772\\
			\midrule
			\multirow{2}*{\Checkmark}&\multirow{2}*{\footnotesize{consensual}}&\multirow{2}*{\footnotesize{self-paced}}&\multirow{2}*{1:7}&PSNR&30.05&35.20&35.17&38.98&31.56\\
			&&&&SSIM&0.9596&0.9889&0.9861&0.9936&0.9776\\
			\midrule
			\multirow{2}*{\Checkmark}&\multirow{2}*{\footnotesize{\textbf{consensual}}}&\multirow{2}*{\footnotesize{\textbf{ours}}}&\multirow{2}*{\textbf{1:7}}&PSNR&\textbf{30.76}&\textbf{35.46}&\textbf{35.31}&\textbf{39.24}&\textbf{31.63}\\
			&&&&SSIM&\textbf{0.9668}&0.9880&\textbf{0.9875}&\textbf{0.9937}&\textbf{0.9791}\\ 		
			\bottomrule
	\end{tabular}}\vspace{-2mm}
	\label{tab:generality}
\end{table*}
In this section, we analyze the effectiveness of the different components of the proposed CPNet, including PDU, consensual negatives-based contrastive regularization (consensual CR), and curricular contrastive regularization (CR). Our \textit{base} network is FFA-Net, and subsequently, we establish five variants including 1) \textbf{base+FDU}: Replacing the PA module with FDU in the FA block. 2) \textbf{base+PDU}: Replacing the PA module with PDU in the FA block. 3) \textbf{base+PDU+CR(non-consensual, 1:10)}: Adding canonical contrastive regularization to base+PDU, with the rate between positive and negative samples being 1:10. 4) \textbf{base+PDU+CR(consensual, 1:7)+w/o CL}: Adding consensual CR without our curriculum strategy (CL) to base+PDU, with the rate between positive and negative samples being 1:7. 5) \textbf{Ours}: The full model of our CPNet. We list the results in Table~\ref{tab:ablation}, using the ITS dataset for training and SOTS-indoor for testing.


\textbf{Effectiveness of PDU.} The architecture of PDU is derived from Eq.~\eqref{equ:final} with a consideration of the physical characteristics of  and , which introduces a dual-branch interaction for the prediction of both factors. Since the features corresponding to  and  are disentangled by our PDU, the latent structural feature-level information is excavated more accurately. As a result, in Table~\ref{tab:ablation} we can see that the PDU achieves 1.71dB and 1.91dB gains over base+FDU and the base network, respectively. 

\textbf{Effectiveness of consensual CR.} 
We follow the same setting as non-consensual CR that considers at most 10 negatives due to the practicability towards training time and GPU memory limitations, and we use the optimal numbers of negatives for a fair comparison, \ie, 7 (consensual CR) vs. 10 (non-consensual CR). It can be observed that consensual CR remarkably boosts the performance against base+PDU and base+PDU+CR (non-consensual, 1:10) with PSNR improvements of 3.79dB and 0.77dB, respectively. Note that our training time is accelerated to 137 hours in contrast to 200 hours for non-consensual CR (1:10). These facts reinforce the superiority of consensual CR. More analysis can be found in the supplementary. 



\textbf{Effectiveness of CR.} Our full network employs the proposed CL strategy into consensual CR during training and performs the best in comparison with all the variants. Compared to base+PDU+CR(consensual, 1:7)+w/o CL, CPNet achieves an increase of 0.57dB in PSNR, revealing the effectiveness of the proposed CR.




\subsection{Generality Analysis for CR}
\vspace{-2mm}To further verify the generality of our CR, we apply it to different SOTA methods and compare it with several other universal regularizations. The results are summarized in Table~\ref{tab:generality}. Our method achieves significant improvements in PSNR and SSIM on all five SOTAs compared to other regularizations, except for a slight decrease of 0.0012 in SSIM compared to consensual CR on GDN. Specifically, our CR enhances the performances of the five baseline models with average PSNR improvements of 0.70-3.30dB, and is superior to CR (non-consensual,1:10) as a regularization term by average PSNR improvements of 0.93-2.10dB. In particular, compared to the popular self-paced CL strategy~\cite{Kumar2010}, our CL method yields a maximum increase of 0.71dB in PSNR. The possible reason is that using the self-paced strategy will feed the negatives into the regularization stage by stage, leading to 1) a two-level split of difficulty without considering the ultra-hard negatives and 2) all the introduced negatives share the same weight. However, as we analyzed before, both hard and ultra-hard samples can provide useful information for regularization during training, and the corresponding weights need to be delicately assigned separately.

\vspace{-2mm}\section{Discussion and Limitation}\vspace{-2mm}
An important advantage of negatives from existing dehazing models is the post-dehazing priors embedded in the recoveries, such as the distribution of the haze residue, which can indicate a more challenging pattern that is difficult to remove. This can provide valuable information to the model during training. However, as most existing methods perform poorly in real-world scenarios, it is hard to collect high-quality images as the non-easy (especially ultra-hard) negatives. This may limit the capacity of our model, despite achieving promising performance on real-world dehazing.



















