
\documentclass[12 pt]{article}
\usepackage[pdftex]{graphicx}
\usepackage{epstopdf}
\usepackage{amsmath}
\usepackage{epic}
\usepackage{eepic}
\usepackage{subfigure}
\usepackage{enumitem}









\newenvironment{slides}[1]{}{}    \newenvironment{report}[1]{#1}{}




\newcommand{\debug}[1]{\mbox{\tt #1}}
\renewcommand{\debug}[1]{}              \newcommand{\cmd}[1]{}
\newcommand{\finput}[1]{\input{#1}}
\newcommand{\daddcontentsline}[3]{\addcontentsline{#1}{#2}{#3}}
\newcommand{\dinclude}[1]{\include{#1}}




\newcommand{\nc}{\newcommand}
\nc{\bk}{\backslash}
\newcommand{\yes}[1]{\fbox{\tt \tiny #1}}
\nc{\vb}{\verb}
\nc{\fix}[1]{\fbox{\sc #1}}
\newcommand{\beginline}{\vspace{10pt}}
\newcommand{\sizeof}[1]{{\left|{#1}\right|}}
\newcommand{\half}{\frac{1}{2}}
\newcommand{\infinity}{\infty}
\newcommand{\noteq}{\neq}
\newcommand{\sk}{\\cmd{EB}}
\newcommand{\EE}[1]{ \debug{\fbox{\sname #1}}\label{\sname #1} \cmd{EAB}}
\newcommand{\EAE}[1]{ \debug{\fbox{\sname #1}}\label{\sname #1} \cmd{EABs}}
\nc{\EAEs}{10pt]{\sf Messages}\dBa}{\dE}

\nc{\SE}{}

\newcommand{\timers}{\dE\prntvar{\sf Timers}\dBa}
\newcommand{\fun}{\dE\prntvar{\sf Functions}\dBa}
\newcommand{\var}{\dE\prntvar{\sf Variables}\dBa}
\newcommand{\ini}{\dE\prntvar{\sf Initialization}\10pt]\begin{algo}{#2}}
\newcommand{\aEz}{\end{algoz}}
\nc{\aE}{\end{algo}}
\newcommand{\mE}{\end{minipage}\ls{1.2}}
\newcommand{\pE}{\end{pream}}
\nc{\mB}{\begin{minipage}}

\newenvironment{algoz}{\ls{0.3}
\begin{tabbing}0000\debug{000} \= 111 \= 222 \= 333 \= 444 \= 555 \= 666 \= 777
\= 888 \= 999 \= 000 \kill
\prntvar\\}{\end{tabbing}}
\newenvironment{algo}[1]{\ls{0.3}\setcounter{line}{0}\begin{tabbing}0000\debug{000} \= 111 \= 222 \= 333 \= 444 \= 555 \= 666 \= 777
\= 888 \= 999 \= 000 \kill
\prntvar\\{\em Algorithm for node {#1}}\\}{\end{tabbing}}
\newenvironment{algoproc}[1]{\ls{0.3}\setcounter{line}{0}\begin{tabbing}0000\debug{000} \= 111 \= 222 \= 333 \= 444 \= 555 \= 666 \= 777
\= 888 \= 999 \= 000 \kill
\prntvar\\{\em {#1}}\\}{\end{tabbing}}
\newenvironment{algoamir}{\begin{figure*}[t]
\begin{center}
\begin{minipage}{\textwidth}
\begin{tabbing}
0000\debug{11} \= 111 \= 211 \= 311 \= 411 \= 555 \= 666 \= 777 \kill }{\end{tabbing}
\end{minipage}
\caption[]{  \bf Design of a \ffi for .}
\dlabel{designF}
\end{center}
\end{figure*}}


\newcommand{\prntvar}{\verb + itemsep = + \the\itemsep \verb + leftmargin = + \the\leftmargin \verb + leftskip = + \the\leftskip \verb + parindent = + \the\parindent \verb + leftmargini = + \the\leftmargini}


\renewcommand{\prntvar}{}
\newcommand{\textstretch}{1.2}  \renewcommand{\baselinestretch}{\textstretch}




\newcommand{\FB}{\begin{figure}[hbtp]\centering}
\newcommand{\FE}[3]{\caption{#3\debug{\fbox{\sname #2}}\debug{\fbox{#1}}}\label{\sname #2} \end{figure}}
\newcommand{\tB}{\begin{table}[hbtp]\centering}
\newcommand{\tE}[3]{\caption{#3
	\debug{\fbox{\sname #2}}\debug{\fbox{#1}}}\label{\sname #2}\end{table}}
\newcommand{\FIGa}[5]{\FB\finput{#1}\FE{#1}{#2}{#3}}
\newcommand{\FIGb}[9]{\FB\finput{#1}\begin{center}#2\end{center}\finput{#3}\begin{center}#4\end{center}\FE{#1}{#5}{#6}}
\newcommand{\FIG}[5]{\FB\finput{#1}\FE{#1}{#2}{#3}}
\newcommand{\TBL}[3]{\tB\cmd{TBL}\input{#1}\tE{#1}{#2}{#3}}

\newcommand{\msec}[2]{\renewcommand{\sname}{}\section[#1
	\debug{\fbox {#2}}]{#1 \cmd{msec} \dlabelx{#2}}\markboth{\today}{Sec. \thesection}}
\newcommand{\msubsection}[2]{\subsection[#1 \debug{\fbox {#2}}]
	{#1 \cmd{msubsection} \dlabelx{#2}}\markboth{\today}{Sec. \thesection}}
\newcommand{\msubsubsection}[2]{\subsubsection[#1 \debug{\fbox {#2}}]
	{#1 \cmd{msubsubsection} \dlabelx{#2}}\markboth{\today}{Sec. \thesection}}





\newtheorem{definition}{Definition}
\newtheorem{notation}{Notation}
\newtheorem{property}{Property}
\newtheorem{claim}{Claim}
\newtheorem{fact}{Fact}
\newtheorem{axiom}{Axiom}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{cor}{Corollary}
\newtheorem{corollary}{Corollary}[theorem]





\renewcommand{\PE}{{\hfill qed}{\cmd{PE}}}

\renewcommand{\dB}{\begin{description}}


\input{tcilatex}






\renewcommand{\dB}{\begin{description}}
\nc{\mathbb}{\textbf}
\nc{\centerdot}{\cdot}

\begin{document}

\pagenumbering{gobble}
\clearpage
\thispagestyle{empty}

\title{
HDR - A Hysteresis-Driven Routing Algorithm for Energy Harvesting Tag Networks\footnote{Thanks are due to Maria Gorlatova and Gil Zussman for many discussions in the initial stages of this research and to Alexander Lavzin for useful comments.} \\
}
\author{Adrian Segall}

\maketitle


\begin{abstract}
The work contains a first attempt to treat the problem of routing in networks with energy harvesting units.  We propose HDR - a Hysteresis Based Routing Algorithm and analyse it in a simple diamond network.  We also consider a network with three forwarding nodes.  The results are used to give insight into its application in general topology networks and to general harvesting patterns.
\end{abstract}

\newpage
\clearpage
\tableofcontents
\clearpage
\pagenumbering{arabic}



\newpage

\newcommand{\fname}{consensus.tex}





\msec{Introduction}{Introduction}


Recent advances in the design of ultra-low power transceivers and solar cells has made it possible to develop and implement networks with self sustainable energy harvesting devices (\emph{EnHANTs}) that communicate with neighboring devices over wireless links (see e.g. \dcite{GWZ}, \dcite{GMSplus} and references therein).  In such networks, node energy increases via harvesting, in addition to it being spent by data transmission and reception.  As a result, the algorithms in \emph{EnHANTs} networks differ considerably from the ones in legacy sensor and ad-hoc networks.  Moreover, with the devices we are considering, the available energy for control and processing is extremely low and thus the employed algorithms must be simple and the amount of transmitted control data must be minimized.

The present work is the first attempt to design routing protocols for \emph{EnHANTs} networks.  We shall analyse the performance of a routing protocol for a very simple network.  Then we indicate how this simple analysis can be employed to provide insight into the design of routing algorithms in larger networks.

\msec{The Model}{Model}

Consider a diamond network with 4 nodes as in Fig. \dref{fig-Model}.  Nodes  are respectively the source and destination nodes.  Node  generates data to be transferred via the energy-harvesting nodes 1 and 2 to the destination .
Data is included in packets of fixed size. Time is divided in slots, where all nodes can change activity only at the end of a slot. Therefore, throughout this paper, we shall interchangeably use the terms \emph{"time"} and \emph{"end of slot"}.  Each wireless transmission by the source is overheard by both forwarding nodes, but in any given slot only one of them, referred to as \emph{the active node} and denoted by , is forwarding the packets to the destination.  Only the active node spends energy in receiving the packet and forwarding it.  The other node is said to be \emph{inactive} and is denoted by .  If node 1,2 is \emph{active}, we also say that we use \emph{route} 1,2 respectively.

At the end of each slot, the intermediate nodes inform the destination node of their current energy levels.  The active node can do this by piggy-backing the information to the last data packet in the given slot, whereas the inactive node needs to use a control message, referred to as a \emph{status message}.  Based on this information, the destination node decides what route to use and informs the forwarding nodes accordingly.  The decision is sent by the destination node just after having received the status messages, in a control message referred to as a \emph{switch-command message}.  We assume that it takes negligible time, but not negligible energy, to send the status messages, to receive the switch command and to apply it by the forwarding nodes.

For the first part of this work we assume that the energy harvesting rates at the two forwarding nodes is constant over a sufficiently long time, at the rate of   respectively.  We also assume for most of this work that the source generates and transmits data at a fixed rate of .  The source and the destination are assumed to be energy unlimited.
If we momentarily disregard the energy spent by control messages, the maximal data rate that can be transmitted from source to destination in this network is
\SB
g_{max} = (e_1 + e_2)/c\text{   ;    } packets/slot
\SE
where  is the total combined energy required to receive and send a data packet.  This is consistent with the results in many works that treat conditions for maximum flow, for example \dcite{MSZ}, as applied to this simple network.  In order to achieve the maximal flow, the traffic must be split between the two routes at average rates  and  respectively.  Obviously, measurement of the harvesting rates and splitting the traffic accordingly are not easy tasks.  The purpose of this work is to design a simple routing protocol that hopefully achieves this split without the need to measure the harvesting rates.  We may mention in addition that if this goal is indeed achieved, the split will automatically adapt to (slow) changes in the harvesting rates.


\begin{figure}[hbtp]
\begin{center}
\includegraphics[scale=1]{Fig1.jpg}
\caption{The Model\debug{\fbox{fig-Model}}\label{fig-Model}}
\end{center}
\end{figure}

The proposed algorithm, referred to as the \emph{Hysteresis-Driven Routing(HDR) Algorithm} is as follows.  The destination assigns as \emph{active} the node with the \emph{higher energy level}, except that, in order to avoid fast oscillations and high control overhead, it switches routes only when the energy level at the inactive node exceeds the level at the active node by a certain \emph{threshold}.  The threshold for switching in one direction may be different from the one in the opposite direction.  Since activity can change only at the end of a slot, if the threshold is reached during a slot, the \emph{actual switch time is at the end of that slot}.

\msubsection{Notations and assumptions}{notations}

For simplicity, we shall take the transmission energy for each status message to be the same, whether the information is piggybacked on a data message or sent separately.  We need to distinguish between the time \emph{just before} the transfer of the control messages and the time \emph{just after}.  We shall refer to the former as \emph{the time just before the end of the slot} and to the latter as \emph{the time at the end of the slot}.


We shall use the following notations.  The period between two consecutive switches in the same direction is referred to as a \emph{cycle}.

\begin{description}
\item{} - energy harvested by node  in each slot  (slot)
\item{} - number of data packets generated by the source node in each slot (packets/slot)
\item{} = combined energy to receive and transmit a data packet (packet)
\item{} = energy to transmit a status control packet or status information piggybacked on a data packet()
\item{} = energy to receive a switch command packet ()
\item{} - battery level at node  \emph{just before} the end of slot  in units of energy()
\item{} - battery level at node  \emph{at} the end of slot , in units of energy ()
\item{} - maximum battery level ()
\item{} =  - minimum battery level that allows transmission of control messages ()
\item{} - threshold to switch from route 1 to route 2 ()
\item{} - threshold to switch from route 2 to route 1 ()
\item {} =  ()
\item {} = \emph{node cycle throughput} = number of data packets transferred via node  in each cycle (packets/cycle)
\item {} = \emph{total cycle throughput} = 
\item{} = 1 if  is true and  otherwise
\end{description}



\msec{Energy equations}{energy}

In the sequel, we develop formulas for the battery level at each node just before the end of each slot and at the end of each slot.  We also determine the maximal steady state flow   of data.
Since the harvesting rates are not known and they may, hopefully slowly, change with time, we shall also examine the behaviour of the system for arbitrary input rates , both larger and smaller than .
In order to avoid the treatment of too many cases however, we shall restrict the input rate to be larger than .  In fact, if for example, , then the energy of node 1 always increases, even when node 1 is active; not a very interesting scenario.  We shall also assume that .

With the above assumptions, when the battery levels are away from the boundaries  and , the battery level at the inactive node  increases from \emph{the end} of a slot until \emph{just before} the end of the next slot by .  The battery level at the active node  decreases from \emph{the end} of some slot until \emph{just before the end} of the next slot by .  If the battery at the inactive node reaches , its harvesting stops.  For input rate , when the battery level at the active node  is away from , it transfers  packets/slot.

It remains to consider the activity of the active node when it is close to the boundary .  If the active node battery reaches  \emph{during} a slot, say a fraction  of the slot period into the slot time, then it will transfer  packets before it reaches   and   packets afterwards\footnote{For simplicity of notation and analysis, we disregard the fact that we only send whole packets.  The simulation does take this fact into account.}.
Next consider the situation at the end of some slot .  Recall the order of transmissions starting just before the end of a slot time: first the status messages and then, if necessary, the switch command.  If just before the end of the slot, node  is at ,  it may run into a problem.  If we allow it to send the status message, thereby spending  for control, it will not have sufficient energy to receive the switch command, if any.  Thus in order to be safe, in this case we instruct the node \emph{to refrain from sending the status message} at the end of slot .  The destination will assume that the node is at  when it does not hear the status message and will act accordingly\footnote{Here, as well as throughout this work, we assume no lost messages.}.
Finally, consider data transmission.  If after sending the status message, the energy is less than , we do not allow transfer of data messages in the next slot, with the hope that the harvested energy will sufficiently increase the battery level to allow it to send the status message at the end of the next slot.  Otherwise, the normal algorithm applies.

With the above considerations, we can write down the dynamics of the system.

\ls{0.3}\renewcommand{\pname}{B}\daddcontentsline{lot}{table}{\debug{\fbox{\pname}}}



\begin{minipage}{\textwidtha}\ls{0.3}\setcounter{line}{0}\begin{tabbing}0000\debug{000} \= 111 \= 222 \= 333 \= 444 \= 555 \= 666 \= 777
\= 888 \= 999 \= 000 \kill
\prntvar\\\\\stepcounter{protblock}
\nl{bc}\>switch = 0
\nl{aa}\>
\nl{ab}\2   switch = 1
\nl{bx}\>
\nl{ac}\>
\nl{m}\> 
\nl{a}\>\>		
\nl{d}\> 		
\nl{e}\>\>      
\nl{f}\> 
\nl{y}\> (switch == 1)
\nl{b}\2        
\nl{g}\2         and  switch
\nl{ag}\2       
\nl{ad}\2       
\nl{ae}\2       
\nl{x}\>
\nl{ax}\2       
\nl{n}\2        
\nl{j}\3            
\nl{i}\3            
\nl{p}\2        
\nl{k}\3            
\nl{ak}\3           
\nl{u}\3            
\nl{w}\2        
\nl{z}\>
\end{tabbing}
\end{minipage}
\ls{1.2}

It is easy to see that the energy just after the transmission of the status control message, if any, is no smaller than , so there is always energy to receive the switch message (see lines \dref{Bb} and \dref{Bab} in the Code above).  To avoid confusion, we point out that the code above is not performed by any node.  It merely describes the dynamics of the system.

Assume that we have just switched at a slot, referred to as slot , from route 2 to route 1.
This happens because the threshold  is reached during slot  or just before its end and was not reached during the previous slot, namely
\EB
h_2 + e_1 - e_2 + c\,g > B^{-}_1(0) -  B^{-}_2(0) \geq h_2
\EE{eq-sw1}
The condition that we switch again  slots afterwards is
\EB
h_1 + e_2 - e_1 + c\,g >  B^{-}_2(I_1) -  B^{-}_1(I_1) \geq h_1
\EE{eq-caps}

The differences in battery levels are calculated as sums of the expressions in lines \dref{Ba}, \dref{Be}, \dref{Bb}, \dref{Bk} in the Code above.
We have a similar condition for the next switch from route 2 to route 1.

\msec{Operation away from the boundaries}{away2}

Denote by
\dB
\item{} = number of slots when node 1 is active in a given cycle , when the system is away from the boundaries
\item{} = number of slots when node 2 is active in a given cycle , when the system is away from the boundaries
\item{} = 
\item{} =  = average throughput per slot in cycle  (packets/slot)
\dE

When the system operates away from the boundaries, all \emph{max} and \emph{min} operands in the Code above do not apply.  Thus we have
\EB
h_1 + e_2 - e_1 + c\,g > B^{-}_2(I_1^a) - B^{-}_1(I_1^a) = I_1^a\,\, e_2    + I_1^a\,(c\,g - e_1)\, + B^{-}_2(0) - B^{-}_1(0) \geq h_1
\EE{eq-Iaax}
or
\EB
I_1^a = \lceil\frac{(h_1 + B^{-}_1(0) - B^{-}_2(0))}{(c\,g -e_1 + e_2)}\rceil
\EE{eq-Iaa}
where  denotes \emph{the smallest integer larger than or equal to }.
Similarly
\EB
I_2^a = \lceil\frac{(h_2 + B^{-}_2(I_1^a) - B^{-}_1(I_1^a))}{(c\,g -e_2 + e_1)}\rceil
\EE{eq-Iaay}

We shall be interested in the drift in total energy of the system  during a cycle .   The energy harvested during a cycle is .  Since  packets are sent in each slot, the energy spent is .  At the end of each slot, each node spends  for control.  There are 2 switch times in a cycle and at every switch time each node spends .  The total drift in energy of both nodes per cycle is given by the difference between the harvested energy and the spent one:
\EB
\Delta_{total} = -4\,c_r + (e_1 + e_2 - 2\,c_t -c\,g)\,I^a \,\,mJ/cycle
\EE{eq-BDtotal}


This is how far we can get analytically with arbitrary parameters.  A useful approximation is to select thresholds as multiples of the net slot energy change.  This implies that the thresholds are reached exactly at slot time, a fact that considerably simplifies the analysis .

\msec{Thresholds divide slot energies - Operation away from the boundaries}{divide}

Suppose a switch from route 2 to route 1 occurs at the end of slot  and at that time, the energy level difference exactly matches the threshold value.  This means .  Then, with , we have
\EB
I_1^a=\lceil\frac{h}{ c\,g+(e_2-e_1)}\rceil
\EE{eq-I1aaa}
and a similar expression for .
If  divides evenly the slot energies  and , then
\EB
I_1^a=\frac{h}{ c\,g+(e_2-e_1)}\text{     ;     }
I_2^a=\frac{h}{ c\,g+(e_1-e_2)}
\EE{eq-Ia}
\EB
I^a = \frac{2c\,g\,h}{(c\,g)^2 - (e_2 - e_1)^2}
\EE{eq-away}
Moreover, the battery level difference returns to its initial value at the end of a cycle, namely
.

In each slot  packets are transferred, thus the average throughput is
\EB
\gamma = g \text{      packets/slot}
\EE{throughput}
independently of the thresholds.
The split ratio between the two routes is
\EB
\frac{\gamma_1^c}{\gamma_2^c} = \frac{g\,I_1^a}{g\,I_2^a} = \frac{c\,g+e_1-e_2}{c\,g+e_2-e_1}
\EE{eq-split0}

In the sequel, we shall also need the following quantities.
Let  denote the change in the battery level at node  during an interval of  slots.  Then
\EB
\delta B_1(I_1^a) = -\frac{h\,(c\,g -e_1)}{ c\,g+(e_2-e_1)} \text{        ;         }
\delta B_2(I_1^a) = \frac{h\, e_2}{ c\,g+(e_2-e_1)}
\EE{eq-Delta}
and
\EB
\delta B_1(I_2^a) = \frac{h\, e_1}{ c\,g+(e_1-e_2)} \text{        ;         }
\delta B_2(I_2^a) = -\frac{h(c\, g - e_2)}{ c\,g+(e_1-e_2)}
\EE{eq-Delta1}

The drift  is half the total drift (\dref{eq-BDtotal}), namely
\EB
\Delta = -2\,c_r   + \frac{(e_1 + e_2 -2\,c_t-c\,g)\,I^a}{2}\,\,mJ/cycle
\EE{eq-B}

\msec{Negligible Control - Thresholds divide slot energies}{negli}

If the energy spent for sending and receiving control messages is negligible, we have
.

\msubsection{Operation away from the boundaries}{awayq}

For negligible control, the drift is .
Let  denote the input that induces steady state, namely .  We get .  If , then the condition for the switches to occur at exactly battery level differences  and  becomes that  and  are integers.  For example for , any two threshold values  that add up to 4.8 or its multiples will do the job.

We conclude that if , then the \emph{HDR Algorithm} indeed transfers in dynamic steady state the entire input rate .   For other values of the input rate , the behavior is transient:  the battery levels will drift up if  until they reach steady state close to  and down if  until they reach steady state close to .  The steady state behavior in these cases is treated in the following sections.


\subsection{Drifts and Operation close to boundaries}\dlabel{close}

As before, the analysis here is for negligible control and thresholds evenly dividing the slot energies.  Since in practice, the harvesting rates vary, it is important to investigate the behavior of the system  when  is not necessarily equal to .

If , then the battery levels drift up, until at least one of them reaches .  Similarly, if , the drift is down, until at least one of the batteries reaches the lower bound .  Before reaching the boundary, the switch times are as before Eq. (\dref{eq-Ia}).  The drift per slot is , with  and  given in Eq. (\dref{eq-B}) and (\dref{eq-away}).

When a node is \emph{inactive}, its battery charges. Recall that we have assumed , so the battery level at the \emph{active} node goes down.  Thus, only the inactive node can reach the boundary  and only the active node can reach the lower boundary .  We assume that  is much larger than the thresholds, so that if one of the nodes reaches some boundary, the other does not reach the opposite boundary in the same cycle.

In addition to the assumption of switching with differences in battery levels equal to the thresholds, in the analysis below we shall also assume that boundaries are reached by nodes exactly at slot times.  As before, we point out that the simulation is performed without these assumptions.

Take  to indicate the time of a switch when node  becomes \emph{actiVe}.  Recall that we denote by   the other node, namely the one that will become active \emph{neXt}.  The condition for the next switch (from route  to route ) to occur after slot  is given by Eq. (\dref{eq-caps}).  Note that the switch time  when boundaries are reached may not be the same as , the switch time when no boundary is met.
If neither node reaches a boundary (0 or ), then the switch time is as before .

Let
\begin{description}
  \item[] = slot at the end of which node  reaches 0 before a switch, where 
  \item[] = slot at the end of which node  reaches  before a switch, where 
\end{description}
If the corresponding boundary is not reached before a switch, then  respectively is defined to be equal to .  Note that if either node reaches some boundary before a switch, it stays at that boundary until the next switch, and the other node cannot reach the opposite boundary.  Also note that until a boundary is reached, both the  and the  operands in the Code above are inactive.
The switch condition (\dref{eq-caps}) becomes:
\EB
e_x\,\cdot I''_v + (\, c\, g\, - e_v)\,I'_v = h
\EE{eq-swCC}



The cycle dynamics is given below.




\ls{0.3}\renewcommand{\pname}{X}\daddcontentsline{lot}{table}{\debug{\fbox{\pname}}}



\begin{minipage}{\textwidtha}\ls{0.3}\setcounter{line}{0}\begin{tabbing}0000\debug{000} \= 111 \= 222 \= 333 \= 444 \= 555 \= 666 \= 777
\= 888 \= 999 \= 000 \kill
\prntvar\\{\em Node v is actiVe, node x is neXt} \` /*  \\\stepcounter{protblock}
\nl{m}\> 
\nl{s}\> \{   \` /*node  reaches boundary 
\nl{a}\>\>		
\nl{x}\>\>		
\nl{r}\>\>      
\nl{f}\>\>       \\
	\>\>	\}
\nl{y}\>\{   \`/*node  reaches boundary 
\nl{b}\2        
\nl{g}\2        
\nl{c}\2        
\nl{h}\2         \\
    \2       \}
\nl{i}\> \{      \` neither node reaches boundary
\nl{j}\3            
\nl{p}\3            
\nl{k}\3             \\
    \2       \} \\



\end{tabbing}
\end{minipage}
\ls{1.2}






\msubsection{System Throughput and Operation close to the boundaries}{low}


In this Section we examine the operation of the system in terms of throughput and split ratio, at low and high battery level.

We start with low level.  If , the battery levels will drift down while seesawing.  An example appears in Fig. \dref{fig-case1}.

\begin{figure}[hbtp]
\begin{center}
\includegraphics[scale=0.5]{Fig2.jpg}
\caption{Only node 1 is at boundary 0 for a non-zero period of time\debug{\fbox{fig-case1}}\label{fig-case1}}
\end{center}
\end{figure}

As we shall see in the sequel, after the time when one of the nodes reaches the boundary 0, the system operates in a periodic dynamic steady state.  There are two cases: i) only one node is ever empty for a non-zero period of time ; ii) both nodes alternately reach 0.  The condition for these to happen is given below.

\LB{lemma-0}
If , then  is never empty for a non-zero period of time and the throughput during a cycle, the cycle length, and the average throughput are as in Eq. (\dref{eq-cycle}) below.
\LE

\PB
The condition above is equivalent to .
The switch from route 1 to route 2 occurs after slot 
when .
Afterwards,  goes down at a rate .
Node  will reach 0 only if during the next  slots (namely before the next switch) it will do so.
Thus if , the battery  will never be at  for a non-zero period.
Substituting for  from Eq. (\dref{eq-away}), we obtain the condition above.

Since the system drifts down, at least one battery must hit 0 and if the condition in the Lemma holds, only  can do so.  After the first time it hits 0, it waits for  to reach , at which time a switch from route 1 to route 2 occurs.  Rename the slot at the end of which this occurs as .  From this slot on, the system is in dynamic steady state.

The next switch, from 2 to 1, occurs at time  , and the battery levels are
\EB
B_1(I_2^a) = I_2^a\cdot e_1=\frac{e_1\,h}{c\,g + (e_1-e_2)}
\EE{eq-bat1}
and
\EB
B_2(I_2^a) = B_2(0)+ \delta B_2(I_2^a) =
h_1-\frac{(h_1+h_2)(c\,g-e_2)}{c\,g +(e_1-e_2)} =
\frac{h_1\,e_1 - h_2\,(c\,g -e_2)}{c\,g +(e_1-e_2)}
\EE{eq-bat2}
If we again rename the slot after which the switch from route 2 to route 1 occurs as , the battery  drains out at time
\SB
I'_1=  \frac{e_1\,h}{(c\,g + (e_1-e_2))(c\,g - e_1)}
\SE
and then node 1 waits for  to charge to level  at time
\SB
(h-\frac{e_1\,h}{c\,g + (e_1-e_2)})/e_2=\frac{h(c\,g-e_2)}{e_2 \cdot (c\,g+(e_1-e_2))}\text{   ,  }
\SE
where the switch from 1 to 2 occurs at battery levels (\dref{eq-bat1}) , (\dref{eq-bat2}).  The scenario repeats from now on.

While active and in dynamic steady state, node 2 transfers a total of
 , and node 1 transfers
.  The split ratio is
\SB
\gamma_1/\gamma_2 =e_1/e_2
\SE
The total throughput in a cycle , the number of slots in a cycle  and the average throughput  are:
\EB
\gamma^c = \frac{g\,(e_1+e_2)\,h}{e_2\,(e_1-e_2+c\,g)}\text {   ;   }
I = \frac{c\,g\,h}{e_2\cdot(c\,g + e_1 - e_2)}\text{   ;    }
\gamma = \frac{e_1+e_2}{c} \text{     packets/slot}
\EE{eq-cycle}
Note that, since , the average throughput above is the maximal possible.



\LB{lemma-2}
If   , then  never empties out and the throughput during a cycle, the cycle length and the average throughput are as in Eq. (\dref{eq-cycle}) with indexes 1 and 2 interchanged.
\LE


\LB{lemma-1}
If   , then both batteries alternately reach level 0 and stay there for non-zero numbers of slots, and the throughput during a cycle, the cycle length and the average throughput are as in Eq. (\dref{eq-cycle1}).
\LE

\PB
An example appears in Fig. \dref{fig-case2}.
Since the system drifts down, at least one battery must eventually drain out.  Suppose node 1 is the \textbf{first} that hits battery level 0 at a time \emph{that is not its lower tip} .  Then it waits for  to reach , at which time a switch from route 1 to route 2 occurs.  Let  indicate the slot after which this happens.  From this time on, the system is in dynamic steady state.

\begin{figure}[hbtp]
\begin{center}
\includegraphics[scale=0.5]{Fig3.jpg}
\caption{Both nodes empty out alternately\debug{\fbox{fig-case2}}\label{fig-case2}}
\end{center}
\end{figure}

At time , the battery  reaches 0.  It waits for  to reach  at time , at which time the switch from node 2 to node 1 occurs (see Fig. \dref{fig-case2}).  The battery levels at this time are
\EB
B_1(I_2) = h_2\text{      ;      } B_2(I_2) =  0
\EE{eq-bat3}
Counting slots after that switch,  drains out at time , waits for  to charge to level  at time , where the switch from 1 to 2 occurs at battery levels corresponding to (\dref{eq-bat3}) with  exchanged indices.

While active, node 2 transfers a total of

packets, and node 1 transfers
.  The split ratio is
.
The total throughput in a cycle , the total number of slots in a cycle  and the average throughput  are
\EB
\gamma^c = \frac{(e_1+e_2)(e_1\,h_1 + e_2\,h_2)}{c\,e_1\,e_2}\text{    ;    }
I = \frac{h_1\,e_1+h_2\,e_2}{e_1 \,e_2}\text{    ;    }
\gamma  =  \frac{e_1 + e_2}{c} \text{     packets/slot}
\EE{eq-cycle1}


Next we consider the case when the input rate is less that the total harvesting rates, namely .  In this case the battery levels will drift up while seesawing.  The operation here is similar to the one at low-level batteries. An example when only node 2 reaches  appears in Fig. \dref{fig-case3}.  The properties for all cases are stated in the summary section below without proofs.  The proofs are similar to the ones above.

\begin{figure}[hbtp]
\begin{center}
\includegraphics[scale=0.5]{Fig4.jpg}
\caption{Node 2 reaches \debug{\fbox{fig-case3}}\label{fig-case3}}
\end{center}
\end{figure}

\msubsection{Summary of Analytic Results}{summary}

\TB{T-Summary}

Under the assumptions that:
\eB
\item the energies  spent for control  are negligible
\item all switches occur at times when the difference in battery levels is exactly equal to the thresholds
\item boundaries are reached at slot time
\eE
the system behaves as follows
\eB
\item
While away from the boundaries
\SB
I_1=I_1^a =\frac{h}{c\,g + e_2-e_1}\text{  slots  ;    }
I_2=I_2^a=\frac{h}{c\,g + e_1-e_2}\text{     slots }
\SE
\SB
\gamma^c_1 = \frac{g\,h}{c\,g + e_2-e_1}\text{ packets   ;    }
\gamma^c_2 = \frac{g\,h}{c\,g + e_1-e_2}\text{    packets}
\SE
\SB
\frac{\gamma^c_1}{\gamma^c_2} = \frac{c\,g + e_1-e_2}{c\,g + e_2-e_1} \text{    ;    }
\gamma^c = \frac{2\,c\,g^2\,h}{(c\,g)^2 - (e_1-e_2)^2 }\text{ packets   ;   }
\SE
\SB
I = \frac{2\,c\,g\,h}{(c\,g)^2 - (e_1-e_2)^2 } \text{   slots   ;   }
\gamma = g\text{    packets/slot  ; }
\text{Drift per cycle} = \frac{e_1 + e_2 - c\,g}{2}\,\,\mu J
\SE
\item
If  and the battery levels are initially far from the boundaries, then they are in dynamic steady state with the following:
\SB
I_1=I_1^a =\frac{h}{2\,e_2}\text{  slots  ;    }
I_2=I_2^a=\frac{h}{2\,e_1}\text{     slots }
\SE
\SB
\gamma^c_1 = \frac{g\,h}{2\,e_2}\text{ packets   ;    }
\gamma^c_2 = \frac{g\,h}{2\,e_1}\text{    packets}
\SE
\SB
\frac{\gamma^c_1}{\gamma^c_2} = \frac{e_1}{e_2} \text{    ;    }
\gamma^c = \frac{c\,g^2\,h}{2\,e_1\,e_2}\text{ packets   ;   }
\SE
\SB
I = \frac{c\,g\,h}{2\,e_1\,e_2} \text{   slots   ;   }
\gamma = g\text{    packets/slot  ; }
\text{Drift per cycle} = 0
\SE
\item
If , then the battery levels will drift down while seesawing and
\dB
\item{(a)} If   , then  is never at level zero level for a non-zero amount of time and in steady state:
\SB
I_1 = \frac{h}{c\,g + (e_2-e_1)}\text{  slots   ;    }
I_2= \frac{h(c\,g-e_1)}{e_1 \cdot (c\,g+(e_2-e_1))}\text{  slots  ;   }
\SE
\SB
\gamma^c_1 = \frac{g\,h}{e_2 - e_1 + c\,g}\text{   packets ;   }
\gamma^c_2 = \frac{e_2\, g\,h}{e_1\,(e_2 - e_1 + c\,g)}\text{    packets  ;   }
\SE
\SB
\frac{\gamma^c_1}{\gamma^c_2} =\frac{e_1}{e_2}{      ;      }
\gamma^c = \frac{g\,(e_2+e_1)\,h}{e_1\,(e_2-e_1+c\,g)}\text {   ;   }
I = \frac{c\,g\,h}{e_1\cdot(c\,g + e_2 - e_1)}\text{   ;    }
\gamma = \frac{e_1+e_2}{c} \text{     packets/slot}
\SE
\item{(b)}
If  , then  is never at level zero for a non-zero amount of time and in steady state (see Eq. (\dref{eq-cycle})):
\SB
I_1= \frac{h(c\,g-e_2)}{e_2 \cdot (c\,g+(e_1-e_2))}\text{    ;   }
I_2 = \frac{h}{c\,g + (e_1-e_2)}\text{    ;   }
\gamma^c_1 = \frac{e_1\, g\,h}{e_2\,(e_1 - e_2 + c\,g)}\text{    ;   }
\gamma^c_2 = \frac{g\,h}{e_1 - e_2 + c\,g}
\SE
\SB
\frac{\gamma^c_1}{\gamma^c_2} =\frac{e_1}{e_2}\text{     ;     }
\gamma^c = \frac{g\,(e_1+e_2)\,h}{e_2\,(e_1-e_2+c\,g)}\text {   ;   }
I = \frac{c\,g\,h}{e_2\cdot(c\,g + e_1 - e_2)}\text{   ;    }
\gamma = \frac{e_1+e_2}{c} \text{     packets/slot}
\SE
\item{(c)}
If  , then in steady state both batteries alternately reach level 0 for non-zero amounts of time and (see Eq. (\dref{eq-cycle1})):
\SB
I_1 = \frac{h(c\,g - e_2)}{e_2 ( c\,g +e_1 - e_2)}\text {   ;   }
I_2 = \frac{h}{c\,g +e_1-e_2}\text {   ;   }
\gamma^c_2 = \frac{e_1\,h_1+e_2\,h_2}{c\,e_1}\text {   ;   }
\gamma^c_1 = \frac{e_1\,h_1+e_2\,h_2}{c\,e_2}
\SE
\SB
\frac{\gamma^c_1}{\gamma^c_2} =\frac{e_1}{e_2}\text{    ;    }
\gamma^c = \frac{(e_1+e_2)(e_1\,h_1 + e_2\,h_2)}{c\,e_1\,e_2}{    ;    }
I = \frac{h_1\,e_1+h_2\,e_2}{e_1 \,e_2}\text{    ;    }
\gamma  =  \frac{e_1 + e_2}{c} \text{     packets/slot}
\SE
\dE
\item
If , then the battery levels will drift up while seesawing\footnote{In a previous version of this report, the conditions below were wrongly stated.  Now they are correct - thanks to Alex Lavzin for perceiving the error.}
\dB
\item{(a)} If  , then  is never at  for a non-zero amount of time and in steady state:
    \SB
    I_1 = \frac{e_1 \,h }{(c\,g - e_1)(c\,g +e_1-e_2)}\text{    ;    }
    I_2 = \frac{h}{c\,g +e_1 - e_2}\text{    ;    }
    \gamma^c_1 = \frac{e_1 \,h\,g }{(c\,g - e_1)(c\,g +e_1-e_2)}\text{    ;    }
    \SE
    \SB
    \gamma^c_2 = \frac{h\,g}{c\,g +e_1 - e_2}\text{    ;   }
    \gamma^c = \frac{ c\, g^2\, h }{ (c\,g - e_1) (c\,g + e_1 - e_2 )}\text{    ;   }
    \frac{\gamma^c_1}{\gamma^c_2} = \frac{e_1}{c\,g - e_1}
    \SE
    \SB
    I = \frac{c\,g\,h }{(c\,g - e_1)(c\,g + e_1 -e_2)}\text{    ;        }
    \gamma = g
    \SE
\item{(b)} If  , then  is never at  for a non-zero amount of time and in steady state:
    \SB
    I_1 = \frac{h}{c\,g +e_2 - e_1}\text{    ;    }
    I_2 = \frac{e_2 \,h }{(c\,g - e_2)(c\,g +e_2-e_1)}\text{    ;    }
    \gamma^c_1 = \frac{h\,g}{c\,g +e_2 - e_1}
    \SE
    \SB
    \gamma^c_2 = \frac{e_2 \,h\,g }{(c\,g - e_2)(c\,g +e_2-e_1)}\text{    ;    }
    \gamma^c = \frac{ c\, g^2\, h }{ (c\,g - e_2) (c\,g + e_2 - e_1 )}\text{    ;   }
    \frac{\gamma^c_1}{\gamma^c_2} = \frac{c\,g - e_2}{e_2}
    \SE
    \SB
    I = \frac{c\,g\,h }{(c\,g - e_2)(c\,g + e_2 -e_1)}\text{    ;   }
    \gamma = g
    \SE
\item{(c)} If   , then both  and  alternately reach  and stay there for non-zero amounts of time and in steady state:
    \SB
    I_1 = \frac{h_1}{c\,g - e_1}\text{    ;   }
    I_2 = \frac{h_2}{c\,g - e_2}\text{    ;   }
    \gamma^c_1 = \frac{g\,h_1}{c\,g - e_1}\text{    ;   }
    \gamma^c_2 = \frac{g\,h_2}{c\,g - e_2}
    \SE
    \SB
    \gamma^c = \frac{  g\,(c\,g\,h -e_1\,h_2 - e_2\,h_1) }{ (c\,g - e_2) (c\,g - e_1 )}\text{    ;   }
    \frac{\gamma^c_1}{\gamma^c_2} = \frac{h_1\,(c\,g - e_2)}{h_2\,(c\,g - e_1)}\text{    ;   }
    I = \frac{  c\,g\,h -e_1\,h_2 - e_2\,h_1 }{ (c\,g - e_2) (c\,g - e_1 )}\text{    ;   }
    \gamma = g
    \SE
\dE

\eE
\TE
In words, we can summarize the dynamic steady state activity as follows:
\eB
\item If , steady state occurs at all battery levels away from the boundaries. The throughput is , with split ratio , independent of the thresholds.  The thresholds affect only the frequency of switching.
\item If , steady state occurs close to empty battery levels.  The throughput is , with split ratio , independent of the thresholds.  The thresholds affect only the frequency of switching.
\item If , steady state occurs close to full battery levels.  The throughput is  with split ratio .  The thresholds affect the split ratio, as well as the frequency of switching.
\eE

\msec{Case when differences in battery levels at switch time do not exactly match the thresholds}{relax}

The switch from route 1 to route 2 (and viceversa) occurs at the end of the slot during which  (respectively ) is reached.  If  or  is reached during a slot (as opposed to just before the end of the slot), the difference in battery levels at switch time is larger than the corresponding threshold.

Consider the case , namely steady state when away from the boundaries.   If the system starts with  and if  is a multiple of both  and , then all switches will occur with battery level differences equal to the thresholds. Moreover, the battery levels at the end of each cycle are the same as the ones at the beginning of the cycle.  Namely the dynamic steady state has \emph{a period of one cycle}.

If  is not a multiple of   and , then thresholds will be reached not necessarily at the end of slots.  As a result, the difference in battery levels at switch time will be larger than the threshold values.  On the other hand, since , the battery levels do not drift and thus the system must be in dynamic steady state.  The behavior is now that the battery levels do not return to their initial values after each cycle, but rather after more than one cycle.  As a topic for future research, it will be interesting to find conditions for periods containing 1,2,3,.. cycles.  We present in Table \dref{Table-Patterns} a few numerical examples for , , , .  The third column is the number of cycles in each period.  The first row in each entry are the switch times, namely the slots at the end of which the switch occurs. The second row represents the battery level differences at switch time.


\begin{table}[hbtp]
\begin{center}
\begin{tabular}{|l|l|c|c|c|c|c|c|c|c|}
  \hline
  & & period & \multicolumn{7}{c|}{switch at slot ;  }\\ \hline
   4  &0.8 & 1 & 0   & 3    & 7  & & & &\\
      &    &   & 0.8 & -4 & 0.8  & &  & &\\ \hline
  2   & 1  & 1 & 0   & 3    & 7  & & & &\\
      &    &   & 1.4 & -3.4 & 1.4  & &  & &\\ \hline
  6.2 & 5  & 2 &  0  &  7   & 17  & 25  & 35 & & \\
      &    &   &  5  & -6.2 & 5.8 & -7 & 5 & &  \\ \hline
  5   & 5  & 3 &  0  & 7    & 17  & 24 & 33 &40 &49 \\
      &    &   &  5  & -6.2 & 5.8 & -5.4 & 5.4 & -5.8& 5\\
  \hline
\end{tabular}
\caption{Switching Patterns \debug{\fbox{Table-Patterns}}\label{Table-Patterns}}
\end{center}
\end{table}

\msec{Non-negligible Power Consumption for Control Messages}{nonnegligible}

Here we consider the situation with non-zero  and  and look only at the operation away from the boundaries.  If  evenly divides the slot energies, the drift  and the cycle length are as in \dref{eq-B}, (\dref{eq-away})

Substituting  into , we get
\EB
\Delta = -2\,c_r + \frac{c\,g\,h\,(\tilde{e} - c\,g)}{(c\,g)^2 - (e_2 - e_1)^2}\,\,mJ/cycle
\EE{eq-BD1}
where .
The condition for dynamic steady state is .  We obtain a quadratic equation for , whose solution, denoted by , is given by
\EB
g_s = \frac{h\,\tilde{e}+\sqrt{h^2\,\tilde{e}^2 + 8\,c_r\,(2\,c_r+h)\,(e_2 - e_1)^2}}{2\,c\,(2\,c_r+h)}
\EE{eq-g}
The throughput  as a function of the thresholds is shown in Fig. \dref{fig-g}.  As expected, the higher the thresholds the less energy is spent on control, since the inter-switch period goes up, and thus more energy is left for data messages.  However, high thresholds can lead to the batteries reaching the boundary.  With the values of  as in the graph, the value of  for negligible control is .

\begin{figure}[hbtp]
\begin{center}
\includegraphics[scale=0.5]{g.jpg}
\caption{ as a function of \debug{\fbox{fig-g}}\label{fig-g}}
\end{center}
\end{figure}

At this point, recall that the analysis is correct if  and  are integers.
It is difficult to get explicit conditions for this to hold for arbitrary control values  and  and we have to resort to numerical simulations.
Consider for example the situation in Fig. \dref{fig-crct}, where .
We get .  The plot shows a drift of about  in 1000 slots.
This is due to the fact that an average cycle length turns out to be 18.72 slots, as opposed to the theoretical 16.73 slots given by Eq. (\dref{eq-away}).
As an exercise, we have performed the same simulation, but at each step we estimate the current average cycle length and adjust the input rate  so that  given by Eq. (\dref{eq-B}) is zero.
Not surprisingly, with this feedback, there is no drift (see Fig.\dref{fig-crctFeedback}).

\begin{figure}[hbtp]
\begin{center}
\includegraphics[scale=0.5]{crct.jpg}
\caption{Behavior of system with  \debug{\fbox{fig-crct}}\label{fig-crct}}
\end{center}
\end{figure}

\begin{figure}[hbtp]
\begin{center}
\includegraphics[scale=0.5]{crctFeedback.jpg}
\caption{Behavior of system with  obtained by estimating   \debug{\fbox{fig-crctFeedback}}\label{fig-crctFeedback}}
\end{center}
\end{figure}







\msec{Summary so far}{Implications}

The analysis above is performed for a simple system with several helpful assumptions.  We have extended it in several directions, like non-negligible power spent on control messages, but we can look at its implications to more general practical systems.  In practice, the harvesting rates are time varying, according to various parameters, like time of day and illumination conditions.  Our discussion here assumes that those variations are relatively slow. If the pattern is known, the source can try to adapt to the current parameters.  For example, it should increase the input rate  when the harvesting rates increase.  Also, in this simple network, the wireless transmissions of the intermediate nodes are overheard at the source.  The latter can use this information in order to adapt the input rate.

Consider now extensions of the \emph{HDR Algorithm} to larger networks, either with one data collection point (several sources, one destination) or with several source-destination pairs.  Many routing procedures have been proposed for legacy ad-hoc and sensor networks with a variety of performance criteria, like maximum lifetime or maximum total throughput (see e.g. \dcite{AY}, \dcite{ASSC}, \dcite{KK}, \dcite{LS} and references therein).  In such networks the units spend energy and thus the battery level only goes down.  Those algorithms do not seem to be applicable to networks with energy harvesting units, where energy also increases via harvesting.  In networks with harvesting nodes, lifetime and total throughput have no meaning.

The analysis in this first work on the topic of routing in harvesting node networks can provide an insight for larger networks.  Assuming that the topology of the network does not change often (e.g. tags on books in a library, static tags in a room or building), two or more paths can be established in advance for every source-destination pair.  If all units have similar harvesting rates, it makes sense to select node-disjoint paths.  If there are units with significantly larger harvesting rates than the others, they can participate in more than one path.  One can think of several simple centralized or distributed algorithms to select the paths, but this topic is outside the scope of the present work.  The energy levels of the nodes on the path can be periodically collected, either piggy-backed on data messages or via control messages.   Using a threshold mechanism as given by the \emph{HDR Algorithm} on the maximum battery level along the path, the destination can decide which path to use.  Again, the exact procedures for collecting data and for informing nodes in the network upon the path selection are topics for future research.  For instance, one can also consider situations when the collection node has a powerful transmitter that can be simultaneously heard by all nodes.  In this case, it can directly communicate routes and switching decisions to all nodes.

\msec{Three Forwarding Nodes}{three}

Having extensively discussed the diamond configuration and having obtained detailed results for its behavior, we can now adventure into looking at larger networks.
In this section we analyze the behaviour of the \emph{HDR Algorithm} in a network with three parallel paths (see Fig. \dref{fig-3nodes}).

\begin{figure}[hbtp]
\begin{center}
\includegraphics[scale=1]{Fig5.jpg}
\caption{Three Forwarding Nodes\debug{\fbox{fig-3nodes}}\label{fig-3nodes}}
\end{center}
\end{figure}

We first consider a simple switching policy, whereby the routes are switched in a round-robin fashion, with thresholds , ,  for the switches (1,2),(2,3),(3,1) respectively.

\msubsection{Operation away from the boundaries}{away3}

Let  denote the current actiVe node and  denote the neXt active node.  Let  denote the number of slots when the destination employs route  while the batteries \emph{are away from the boundaries}.  We also assume as before that switching occurs at battery level differences exactly matching the value of the thresholds.

If we denote  and refer to  as a \emph{cycle}, then the operation away from the boundaries is:

We also require that we are in dynamic steady state, namely that the change in battery level during a cycle is the same for all three batteries (denoted by ):
\SB
\Delta = B_1(I^a)-B_1(0) = B_2(I^a)-B_2(0) = B_3(I^a) - B_3(0)
\SE
Substituting above, and selecting the initial condition , the system of linear equations has a unique solution.  We give here explicitly only the expressions for , ,  and for the drift.



The throughput is  packets/slot and the split ratio is
\SB
\gamma_1 : \gamma_2 : \gamma_3 = (c\,g + 2\,e_1 -e_2 -e_3) : (c\,g + 2\,e_2 -e_1 -e_3) : (c\,g + 2\,e_3 -e_1 -e_2)
\SE

The cycle length and the drift are
\SB
I^a = \frac{3\,c\,g\,(h_1 + h_2 + h_3)}{2\,(c^2\,g^2 -e_1^2 - e_2^2 -e_3^2 +e_1\,e_2+e_2\,e_3 +e_2\,e_3)}
\SE
\EB
\Delta = -3c_r - \frac{c\,g\,h\,(c\,g - \tilde{e})}{2\,(c^2\,g^2 -E )}
\EE{eq-3drift}
where  and .

The system is in steady state if , which occurs at input rate  given by the solution of the corresponding quadratic equation
\EB
g_s = \frac{h\,\tilde{e}+\sqrt{h^2\,\tilde{e}^2 + 24\,c_r\,(6\,c_r+h)\,E}}{2\,c\,(6\,c_r+h)}
\EE{eq-steady}

\begin{figure}[hbtp]
\begin{center}
\includegraphics[scale=0.5]{g3.jpg}
\caption{ as a function of  for a system with 3 forwarding nodes\debug{\fbox{fig-g3}}\label{fig-g3}}
\end{center}
\end{figure}

For , the drift is zero if  , and then , namely there is no drift and the throughput through each node is proportional to its harvesting rate.


\msubsection{Operation close to the boundaries - negligible control}{close3}

Here we assume negligible energy spending for control messages.  If , the battery levels drift up, until at least one of them reaches .  Similarly, if , then the drift is down, until at least one of the batteries empties out.  Before reaching the boundary, the switch times are as before Eq. (\dref{eq-away3}).  The drift is .

Obviously, when a node is inactive, its battery charges. As before, we assume
, so the battery level at the active node goes down.  Thus, only the inactive nodes can reach the boundary  and only the active node can reach the boundary 0.

\emph{We look first at the system just after a switch from route 3 to route 1.}  We shall temporarily refer to the time when this occurs as slot 0.  The condition for the next switch (from route 1 to route 2) to occur at the end of slot  is given by Eq. (\dref{eq-caps}), which here translates to

\EB
\sum\limits_{0<j\le I_1}( e_2\,1_{( B_2(j-1) < B_{max})}- e_1\,1_{(0< B_1(j-1) )} )+\sum\limits_{0<j\le I_1}c\,g\,1_{(0< B_1(j-1) )}=h_1+ B_1(0) - B_2(0)
\EE{eq-sw3}

Note that since the switch at time 0 is from node 3 and not from node 2, in general .
Note that the switch time  when boundaries may be reached for a non-zero amount of time may not be the same as , the switch time when no boundary is met.

Since nodes 2 and 3 are inactive during , their battery level increases, at rates  respectively.  On the other hand, since , the battery level at the active node decreases, at a rate /slot.  For now we assume that  is large and hence only one of the boundaries can be reached in a given cycle.  If none of the three nodes reaches a boundary, then the switch time is at time
\SB
I_1^b = max\left(0,\frac{h_1 + B_1(0) - B_2(0)}{c\,g +e_2 -e_1}\right)
\SE
Let
\begin{description}
  \item[] = slot when node 1 reaches  for a non-zero amount of time, where 
  \item[] = slot when node 2 reaches  for a non-zero amount of time, where 
  \end{description}

Each of the two quantities above are defined to equal  if the corresponding boundary is not reached for a non-zero amount of time.  Note that if any node reaches some boundary, it stays at that boundary until the next switch.
Therefore the switch condition (\dref{eq-sw3}) becomes:
\EB
e_2\cdot I''_1 + (\, c\, g\, - e_1\,)I'_1 = h_1 + B_1(0) - B_2(0)
\EE{eq-swCC3}
if  and  otherwise.
The  total number of packets transferred  is  if  and  otherwise.
The operation of the system is similar upon the switch from 2 to 3 and then from 3 to 1 (with a round robin substitution).


The evolution of the system is given below, where  are the battery levels at their respective time 0:

\vspace{1cm}



\ls{0.3}\renewcommand{\pname}{X3}\daddcontentsline{lot}{table}{\debug{\fbox{\pname}}}



\begin{minipage}{\textwidtha}\ls{0.3}\setcounter{line}{0}\begin{tabbing}0000\debug{000} \= 111 \= 222 \= 333 \= 444 \= 555 \= 666 \= 777
\= 888 \= 999 \= 000 \kill
\prntvar\\{\em Node v is active, node x is next} \` /*  \\\stepcounter{protblock}
\nl{m}\> 
\nl{s}\> \{   \` /*node  reaches limit 
\nl{a}\>\>		
\nl{d}\>\>		
\nl{e}\>\>      
\nl{n}\>\>      \`/*  is the third node
\nl{f}\>\>       \\
	\>\>	\}
\nl{y}\>\{   \`/*node  reaches limit 0
\nl{b}\2        
\nl{g}\3        
\nl{r}\3        
\nl{c}\3        \`/*  is the third node
\nl{h}\3         \\
    \2       \}
\nl{i}\> \{      \` neither node reaches limit
\nl{j}\3            
\nl{p}\3            
\nl{o}\3            \`/*  is the third node
\nl{k}\3             \\
    \2       \} \\



\end{tabbing}
\end{minipage}
\ls{1.2}




\msubsection{The Earliest Switch schedule}{ES}

In the Round Robin (RR) switching policy, the active routes are pre-assigned.  Suppose node 1 is active.  A switch will occur only when the battery level at node 2 exceeds the battery level at node 1 by the corresponding threshold.  On the other hand, the battery level at node 3 may exceed the corresponding threshold much earlier.  If we allow switches from 1 to 3 as well, the performance of the algorithm might improve.  To investigate this possibility, we consider here the \emph{Earliest Switch (ES) schedule}.  In \emph{ES}, routes are switched to the node that first reaches the corresponding threshold.  For simplicity, we look only at the case when the thresholds  for the switch from 1 to 2 and from 1 to 3 respectively, are the same, namely .  Similarly  and
.  Also, we assume negligible  and  and take /packet.

We have selected a series of sets of parameters as in Table \dref{Table-Param}.  We have run all simulations for a duration of 2000 slots, with statistics gathered only beginning at slot 301, to allow for the system to reach dynamic steady state.

\begin{table}[hbtp]
\begin{center}
\begin{tabular}{|c|c|c|c|c|c|c|c|c|l|}
\hline
Config &  &    &      &  &  &     &  & Bmax & Comment \\ \hline
A &  1.6 & 0.1 & 0.7 & 0.8 & 5 & 10 & 10 & 100 &    \\  \hline
B & 1.6 & 0.1 & 0.7 & 0.8 & 5 & 10 & 10 & 12 &     \\  \hline
C & 2.4 & 0.1 & 0.7 & 0.8 & 5 & 10 & 10 & 100 &     \\  \hline
D & 1.2 & 0.1 & 0.7 & 0.8 & 5 & 10 & 10 & 100 &      \\  \hline
E & 0.2  & 0.1 & 0.01 & 0.01 & 5 & 10 & 10 & 60 &    \\  \hline
F & 1.2 & 0.1 & 0.7 & 0.8 & 10 & 10 & 10 & 100 &      \\  \hline
G & 1.6 & 0.1 & 0.7 & 0.8 & 5 & 10 & 10 & 60 &       \\  \hline
\end{tabular}
\caption{Parameters\debug{\fbox{Table-Param}}\label{Table-Param}}
\end{center}
\end{table}

The results are given in the Table \dref{Table-Results}.  We could not find a conclusive statement as to when does the ES schedule perform significantly better then RR.  In general, when  is low, it seems that RR waists time in waiting for the corresponding threshold to be reached.

\begin{table}[hbtp]
\begin{center}
\begin{tabular}{|c|c|c|c|}
  \hline
Config  &                     & RR        & ES        \\ \hline
  A & Thruput                      & 20        & 20        \\ \cline{2-4}
    & ave cycle (slots)             & 32        & 34        \\ \cline{2-4}
    &  of switches             & 163       & 156        \\ \hline
  B & Thruput                      & 18.75     & 19.91      \\ \cline{2-4}
    & ave cycle (slots)             & 13.3      & 28.03      \\ \cline{2-4}
    &  of switches              & 163       & 157        \\  \hline
  C & Thruput                    & 20        & 20         \\ \cline{2-4}
    & ave cycle (slots)          & 46        & 18.52      \\ \cline{2-4}
    &  of switches           & 109       & 152        \\  \hline
  D & Thruput                       & 15        & 15        \\ \cline{2-4}
    & ave cycle (slots)          & 31.3      & 28.8      \\ \cline{2-4}
    &  of switches                & 100       & 91        \\  \hline
  E & Thruput                      & 20        & 20      \\ \cline{2-4}
    & ave cycle (slots)           & 32        & 34      \\ \cline{2-4}
    &  of switches              & 163       & 156        \\  \hline
  F & Thruput                     & 15        & 15      \\ \cline{2-4}
    & ave cycle (slots)          & 36        & 33      \\ \cline{2-4}
    &  of switches            & 82        & 85        \\  \hline
  G & Thruput                     & 20        & 20      \\ \cline{2-4}
    & ave cycle (slots)          & 30.8      & 33      \\ \cline{2-4}
    &  of switches            & 163       & 153        \\  \hline
\end{tabular}
\caption{Comparison of Throughputs\debug{\fbox{Table-Results}}\label{Table-Results}}
\end{center}
\end{table}

In the scenario of Fig. \dref{fig-case6}, node 2 becomes active starting at the end of slot 8 and its threshold is . It reaches boundary 0 at end of slot 12 and waits for the other nodes to gather sufficient energy.  In RR (not depicted), it would wait for the battery level at node 3, its pre-assigned successor, to reach value 10, which would happen during slot 21.   However, the battery level at node 1 reaches value 10 earlier, during slot 17 and in ES, the destination will reroute to node 1 at the end of that slot.  The number of packets forwarded from end of slot 17 until the end of slot 21 is the following. In RR, node 2 is active at level 0 and thus it forwards data at rate , whereas in ES, node 1 is active away from boundaries and thus it transmits at rate , for a total gain of .

\begin{figure}[hbtp]
\begin{center}
\includegraphics[scale= 0.5]{SwitchToEarliest.jpg}
\caption{Node 1 becomes active after node 2\debug{\fbox{fig-case6}}\label{fig-case6}}
\end{center}
\end{figure}


\msec{Variable Harvesting Rates and Inputs}{variableV}

Practical systems cannot guarantee time invariant harvesting rates.  When harvesting rates and inputs are time varying, the energy equations are the same as in the Algorithm in Sec. \dref{energy}, except that the parameters  are time dependent.
Fig.\dref{fig-Harvest} approximates the pattern of harvesting of two nodes over 8,000 slots that appears in \dcite{GMSplus}.  We have investigated the behavior of the system with  and two types of inputs, each totaling 48,000 packets over 8,000 slots.  With these parameters the total energy required to transfer the packets is 48,000 * 0.08 = 3,840 mJ.  During the period under consideration, the nodes harvest 2,553 and 1,595 mJ respectively, for a total of 4,148 mJ.  With transmission status messages requiring 160 mJ and receipt of switch commands requiring about 10 mJ, if the harvest and inputs were uniformly distributed, the harvest would have been more than sufficient to transfer all packets.

\begin{figure}[hbtp]
\begin{center}
\includegraphics[scale=1]{Harvest.eps}
\caption{Variable harvesting and input\debug{\fbox{fig-Harvest}}\label{fig-Harvest}}
\end{center}
\end{figure}



In our time-varying scenarios, the harvest changes with time.  In the first scenario, the input is uniformly distributed at level of .  The contents of the batteries over the 8,000 slots is shown in Fig. \dref{fig-Variable1} and the inputs vs. the throughput over periods of 1000 slots each appears in Table \dref{Table-Thru1}.

\begin{table}[hbtp]
\begin{center}
\begin{tabular}{|c|c|c|c|c|c|c|c|c|}
  \hline
input &  6000 & 6000 &  6000 &  6000& 6000 & 6000  & 6000  & 6000  \\ \hline
throughput & 1072 & 4150 &  5983 & 5994 & 5994  & 5994 & 5994 & 5994  \\ \hline


\end{tabular}
\caption{Inputs vs. Throughput in Scenario 1\debug{\fbox{Table-Thru1}}\label{Table-Thru1}}
\end{center}
\end{table}


During the first 1000 slots, node 1 has no harvesting and, except for the first few slots where it uses the initial battery energy (10 mJ), it cannot transfer any packets.  Node 2 harvests 0.086 mJ/slot and thus can transfer roughly .
The total transfer during the first 1000 slots is 1072 packets.  During this period, the source tries to send  packets.
During the rest of the scenario, the system behaves, for the periods when the harvesting parameters are constant, roughly as predicted in Sec. \dref{low}.
For example, during the period from 3000 to 3500, the approximate cycle length is  slots with drift
.  The simulation shows an 88 slot cycle with drift .  We recall that the analytic results are just approximations calculated under the assumptions that  and that the thresholds are exact multiples of the slot energies.

\begin{figure}[hbtp]
\begin{center}
\includegraphics[scale=0.35]{Variable1.eps}
\caption{Behavior of the System with Fixed Input \debug{\fbox{fig-Variable1}}\label{fig-Variable1}}
\end{center}
\end{figure}


It is often the case that the node harvesting patterns are roughly known.  In this case one can design an appropriate schedule for the input.  Assuming that the destination has a transmitter that can be heard at the source, one way to implement this is for it to monitor the transfer and from time to time to transmit desirable input rates to the source.  An example of a variable input rate is  of Fig. \dref{fig-Harvest}, so that the total input over the 8000 slots is the same as in the first example.  In the second scenario depicted in Fig. \dref{fig-Variable2}, the total transfer in the first 1000 slots is 977 packets, but the total input attempt is for 1000 packets only.  The final result is that the total throughput in the second scenario is 46,353 packets, whereas in the first scenario is only 41,175 packets.

\begin{figure}[hbtp]
\begin{center}
\includegraphics[scale=0.35]{Variable2.eps}
\caption{Behavior of the System with Variable Input \debug{\fbox{fig-Variable2}}\dlabel{fig-Variable2}}
\end{center}
\end{figure}

\begin{table}[hbtp]
\begin{center}
\begin{tabular}{|c|c|c|c|c|c|c|c|c|}
  \hline
input & 1000 &  5000  &  8000 & 8000 & 8000 & 8000 & 5000 &5000 \\ \hline
throughput &977 &    3830 & 7580 & 7992 & 7992 & 7992 & 4995 & 4995 \\ \hline
\end{tabular}
\caption{Inputs vs. Throughput in Scenario 2\debug{\fbox{Table-Thru2}}\dlabel{Table-Thru2}}
\end{center}
\end{table}







\newpage
\renewcommand{\fname}{} \renewcommand{\sname}{}
\bibliographystyle{alpha}
\addcontentsline{toc}{section}{References}
\begin{thebibliography}{RMME09}

\bibitem[AY]{AY} K. Akkaya and M. Younis, \emph{A survey on routing protocols for wireless sensor networks}, Ad Hoc Networks Vol.3 (2005) pp. 325349 \debug{[survey3]}

\bibitem[ASSC]{ASSC} I.F. Akyildiz, W. Su, Y. Sankarasubramaniam, E. Cayirci, \emph{Wireless sensor networks: a survey}, Computer Networks Vol.38 (2002), pp. 393422 \debug{[Survey1]}

\bibitem[GMSplus]{GMSplus} M.Gorlatova, R. Margolies, J. Sarik, G. Stanje, J.Zhu , B. Vigraham, M. Szczodrak, L. Carloni, P. Kinget, I. Kymissis, G. Zussman, \emph{Energy Harvesting Active Networked Tags (EnHANTs): Prototyping and Experimentation}, Columbia University, Electrical Engineering Technical Report \#2012-07-27, July 2012, available at http://enhants.ee.columbia.edu/images/papers/cu-ee-2012-07-27.pdf \debug{[Columbia Tech Report]}

\bibitem[GWZ]{GWZ}M. Gorlatova, A. Wallwater, G. Zussman,
\emph{Networking Low-Power Energy Harvesting Devices: Measurements and
  Algorithms},  Proc. IEEE INFOCOM'11, April, 2011 \debug{ [Infocom 2011]}

\bibitem[KK]{KK} J. N. Al-Karaki and A. E. Kamal, \emph{Routing Techniques in Wireless Sensor Networks: A Survey}, IEEE Wireless Communications, Dec. 2004 \debug{[survey2]}

\bibitem[LS]{LS} I. Ledvich and A. Segall, \emph{Threshold-related throughput  A new criterion for evaluation of sensor network performance}, Ad Hoc Networks, Special Issue on Recent Research Directions in Wireless Ad Hoc Networking, Vol. 5, Issue 8, November 2007, Pages 13291348 \debug{[Segall Ledvich]}

\bibitem[MSZ]{MSZ}  J. Marasevic, C. Stein, G. Zussman, \emph{Max-min Fair Rate Allocation and Routing in Energy Harvesting Networks: Algorithmic Analysis}, Proc. ACM MOBIHOC'14, 2014 \debug{ [MSZ- MaxMin]}














\end{thebibliography}


\iffalse

[1] 	Power Scavenging Networked Nodes (PoSNeNs):
Design, Prototyping, and Experimentation
ACM SenSys12 Submission #195

\fi



\end{document}
