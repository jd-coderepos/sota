\documentclass{article}

\PassOptionsToPackage{numbers, compress}{natbib}

\usepackage[preprint]{neurips_2019}




\usepackage[utf8]{inputenc} \usepackage[T1]{fontenc}    \usepackage{hyperref}       \usepackage{url}            \usepackage{amsfonts}       \usepackage{nicefrac}       \usepackage{microtype}      \usepackage{bm}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage{booktabs}       \usepackage{makecell}
\usepackage{multirow}
\usepackage{footmisc}
\usepackage{float}
\usepackage[affil-it]{authblk}
\setlength{\affilsep}{1em}

\renewcommand\Authands{, } 
\date{}
\newcommand{\PreserveBackslash}[1]{\let\temp=\\#1\let\\=\temp}
\newcolumntype{C}[1]{>{\PreserveBackslash\centering}p{#1}}
\newcolumntype{R}[1]{>{\PreserveBackslash\raggedleft}p{#1}}
\newcolumntype{L}[1]{>{\PreserveBackslash\raggedright}p{#1}}
\newenvironment{shrinkeq}[2]
{ \bgroup
  \addtolength\abovedisplayshortskip{#1}
  \addtolength\abovedisplayskip{#1}
  \addtolength\belowdisplayshortskip{#2}
  \addtolength\belowdisplayskip{#2}}
{\egroup\ignorespacesafterend}
\bibliographystyle{plain}
 
\title{Variational Denoising Network: Toward Blind Noise Modeling and Removal}



\author[1,2]{Zongsheng Yue}
\author[2]{Hongwei Yong}
\author[1]{Qian Zhao} 
\author[2,3]{Lei Zhang}
\author[1,4,*]{Deyu Meng}
\affil[1]{ School of Mathematics and Statistics, Xi'an Jiaotong University, Shaanxi, China}
\affil[2]{Department of Computing, Hong Kong Polytechnic University, Kowloon, Hong Kong}
\affil[3]{DAMO Academy, Alibaba Group, Shenzhen, China}
\affil[4]{Faculty of Information Technology, The Macau University of Science and Technology, Macau, China}
\affil[*]{Corresponding author: dymeng@mail.xjtu.edu.cn}

 
\begin{document}

\maketitle

\vspace{-6mm}\begin{abstract}
Blind image denoising is an important yet very challenging problem in computer vision due to the complicated
acquisition process of real images. In this work we propose a new variational inference method, which
integrates both noise estimation and image denoising into a unique Bayesian framework, for blind image denoising.
Specifically, an approximate posterior, parameterized by deep neural networks, is presented by taking the intrinsic
clean image and noise variances as latent variables conditioned on the input noisy image. This posterior provides
explicit parametric forms for all its involved hyper-parameters, and thus can be easily implemented for blind
image denoising with automatic noise estimation for the test noisy image. On one hand, as other data-driven deep
learning methods, our method, namely variational denoising network (VDN), can perform denoising efficiently due to
its explicit form of posterior expression. On the other hand, VDN inherits the advantages of traditional model-driven
approaches, especially the good generalization capability of generative models. VDN has good interpretability
and can be flexibly utilized to estimate and remove complicated non-i.i.d. noise collected in real scenarios.
Comprehensive experiments are performed to substantiate the superiority of our method in blind image denoising.
\end{abstract}

\vspace{-3mm}\section{Introduction}\vspace{-3mm}
Image denoising is an important research topic in computer vision, aiming at
recovering the underlying clean image from an observed noisy one. The noise contained in a real noisy image is
generally accumulated from multiple different sources, e.g., capturing instruments, data transmission media,
image quantization, etc.~\cite{tsin2001statistical}. Such complicated
generation process makes it fairly difficult to access the noise information accurately and
recover the underlying clean image from the noisy one. This constitutes the main aim of blind image denoising.

There are two main categories of image denoising methods. Most classical methods belong to the first category, mainly focusing on constructing a rational maximum a posteriori (MAP) model, involving
the fidelity (loss) and regularization terms, from a Bayesian perspective~\cite{bishop2006pattern}.
An understanding for data generation mechanism is required for designing a rational MAP objective, especially
better image priors like sparsity~\cite{aharon2006k},
low-rankness~\cite{gu2014weighted,zhu2016noise,Xu_2018_ECCV}, and non-local
similarity~\cite{buades2005non,maggioni2013nonlocal}.
These methods are superior mainly in their interpretability naturally led by the Bayesian framework.
They, however, still exist critical limitations due to their assumptions on both
image prior and noise (generally i.i.d. Gaussian), possibly deviating from real
spatially variant (i.e.,non-i.i.d.) noise,
and their relatively low implementation speed
since the algorithm needs to be re-implemented for any
new coming image. Recently, deep learning approaches represent a new trend along this research line.
The main idea is to firstly collect large amount of noisy-clean image pairs
and then train a deep neural network denoiser
on these training data in an end-to-end learning manner. This approach is
especially superior in its effective accumulation of knowledge from large datasets and
fast denoising speed for test images.
They, however,  are easy to overfit
to the training data with certain noisy types, and still could not be generalized well on test
images with unknown but complicated noises.

Thus, blind image denoising especially for real images is still a challenging task, since the real noise
distribution is difficult to be pre-known (for model-driven MAP approaches)
and hard to be comprehensively simulated by training data (for data-driven deep learning approaches).

Against this issue, this paper proposes a new variational inference method, aiming at directly inferring both
the underlying clean image and the noise distribution from an observed noisy image in a unique Bayesian framework.
Specifically, an approximate posterior is presented by taking the intrinsic clean image and noise variances as
latent variables conditioned on the input noisy image. This posterior provides explicit parametric forms for all
its involved hyper-parameters, and thus can be efficiently implemented for blind image denoising with automatic
noise estimation for test noisy images.

In summary, this paper mainly makes following contributions: 1) The proposed method is capable of simultaneously
implementing both noise estimation and blind image denoising tasks in a unique Bayesian framework.
The noise distribution is modeled as a general non-i.i.d. configurations with spatial relevance across the image,
which evidently better complies with the heterogeneous real noise beyond the conventional i.i.d. noise assumption.
2) Succeeded from the fine generalization capability of the generative model, the proposed method is verified to
be able to effectively estimate and remove complicated non-i.i.d. noises in test images even though such noise types
have never appeared in training data, as clearly shown in Fig.~\ref{fig:butterfly_case2}. 3) The proposed method is
a generative approach outputted a complete distribution revealing how the noisy image is generated. This not only
makes the result with more comprehensive interpretability beyond traditional methods purely aiming at obtaining
a clean image, but also naturally leads to a learnable likelihood (fidelity) term according to the data-self. 4) The
most commonly utilized deep learning paradigm, i.e., taking MSE as loss function and training on large noisy-clean
image pairs, can be understood as a degenerated form of the proposed generative approach. Their overfitting issue
can then be easily explained under this variational inference perspective: these methods intrinsically put dominant
emphasis on fitting the priors of the latent clean image, while almost neglects the effect of noise variations. This
makes them incline to overfit noise bias on training data and sensitive to the distinct noises in test noisy images.

The paper is organized as follows: Section 2 introduces related work. Sections 3 presents the 
proposed full Bayesion model,
the deep variational inference algorithm, the network architecture and some discussions. Section 4
demonstrates experimental results and the paper is finally concluded.

\vspace{-3mm}\section{Related Work}\vspace{-3mm}
We present a brief review for the two main categories of image denoising methods, i.e., model-driven MAP based methods
and data-driven deep learning based methods.

\textbf{Model-driven MAP based Methods:} Most classical image denoising methods belong to this category, through
designing a MAP model with a fidelity/loss term and a regularization one delivering the pre-known
image prior. Along this line, total variation denoising~\cite{rudin1992nonlinear},
anisotropic diffusion~\cite{perona1990scale} and wavelet coring~\cite{simoncelli1996noise} use the statistical
regularities of images to remove the image noise. Later, the nonlocal similarity prior, meaning many small patches
in a non-local image area possess similar configurations, was widely used in image denoising.
Typical ones include CBM3D~\cite{4271520} and non-local means~\cite{buades2005non}. Some dictionary learning
methods~\cite{gu2014weighted,dong2013nonlocal,Xu_2018_ECCV} and Field-of-Experts (FoE)~\cite{roth2009fields},
also revealing certain prior knowledge of image patches, had also been attempted for the task. Several other
approaches focusing on the fidelity term, which are mainly determined by the noise assumption on data. E.g.,
Mulitscale~\cite{lebrun2015multiscale} assumed the noise of each patch and its similar patches in the same
image to be correlated Gaussian distribution, and LR-MoG~\cite{zhu2016noise}, DP-GMM~\cite{yue2018hyperspectral}
and DDPT~\cite{zhu2017blind} fitted the image noise by using Mixture of Gaussian (MoG) as an approximator for noises.

\textbf{Data-driven Deep Learning based Methods:} Instead of pre-setting image prior, deep learning methods
directly learn a denoiser (formed as a deep neural network) from noisy to clean ones on a large collection
of noisy-clean image pairs. Jain and Seung~\cite{jain2009natural} firstly adopted a five layer convolution neural
network (CNN) for the task. Then some auto-encoder based methods~\cite{xie2012image,agostinelli2013adaptive} were
applied. Meantime, Burger et al.~\cite{burger2012image} achieved the comparable performance with
BM3D using plain multi-layer perceptron (MLP). Zhang et al.~\cite{zhang2017beyond} further proposed the denoising
convolution network (DnCNN) and achieved state-of-the-art performance on Gaussian denoising tasks.
Mao et al.~\cite{mao2016image} proposed a deep fully convolution encoding-decoding network with symmetric
skip connection. Tai et al.~\cite{tai2017memnet} preposed a very deep persistent memory network (MemNet) to
explicitly mine persistent memory through an adaptive learning process. Recently, NLRN~\cite{liu2018non}, N3Net~\cite{plotz2018neural}
and UDNet~\cite{lefkimmiatis2018universal} all embedded the non-local property of image into DNN to 
facilitate the denoising task. In order to boost the flexibility against
spatial variant noise, FFDNet~\cite{zhang2018ffdnet} was proposed by pre-evaluating the noise level and inputting it to
the network together with the noisy image. Guo et al.~\cite{guo2018toward} and
Brooks et al.~\cite{brooks2018unprocessing} both attempted to simulate the generation process of the images in camera.

\vspace{-2mm}\section{Variational Denoising Network for Blind Noise Modeling}\vspace{-2mm}
Given training set , where  denote the  training
pair of noisy and the expected clean images,  represents the number of training images,
 our aim is to construct a variational parametric
approximation to the posterior of the latent variables, including the latent clean image and the noise variances,
conditioned on the noisy image. Note that for the noisy image , its training pair  is
generally a simulated ``clean'' one obtained as the average of many noisy ones taken under similar camera
conditions~\cite{anaya2014renoir,Abdelhamed_2018_CVPR}, and thus is always not the exact latent clean image .
This explicit parametric posterior can then be used to directly infer the clean image and noise
distribution from any test noisy image. To this aim, we first need to formulate a rational full Bayesian
model of the problem based on the knowledge delivered by the training image pairs.

\vspace{-2mm}\subsection{Constructing Full Bayesian Model Based on Training Data}\vspace{-2mm}
Denote  and  as any training pair in ,
where  (width*height) is the size of a training image\footnote{We use  and
 to express the indexes of training data and data dimension, respectively, throughout
the entire paper.}. We can then construct the following model to express the generation process
of the noisy image :

where  is the latent clean image underlying ,  denotes
the Gaussian distribution with mean  and variance .
Instead of assuming i.i.d. distribution for the noise as
conventional~\cite{mairal2008sparse,dong2013nonlocal,gu2014weighted,Xu_2018_ECCV}, which largely deviates the
spatial variant and signal-depend characteristics of the real noise~\cite{zhang2018ffdnet,brooks2018unprocessing},
we models the noise as a non-i.i.d. and pixel-wise Gaussian distribution in Eq.~\eqref{Eq:generate_noisy_im}.

The simulated ``clean'' image  evidently provides a strong prior to the latent variable . Accordingly
we impose the following conjugate Gaussian prior on :

where  is a hyper-parameter and can be easily set as a small value.

Besides, for , we also introduce a rational
conjugate prior as follows:

where  is the inverse Gamma distribution with parameter  and ,
 represents the filtering output of the
variance map  by a Gaussian filter with  window,
and ,  are the matrix (image) forms of ,
, respectively. Note that the mode of above
IG distribution is ~\cite{bishop2006pattern,yong2017robust}, which is a approximate evaluation of  in  window.

Combining Eqs.~\eqref{Eq:generate_noisy_im}-\eqref{Eq:prior-sigma}, a full Bayesian model for the problem can be obtained.
The goal then turns to
infer the posterior of latent variables  and
 from noisy image , i.e., .

\begin{figure}[t]
    \centering
\includegraphics[scale=0.38]{net_loss}
    \vspace{-3mm}
    \caption{\small{The architecture of the proposed deep variational inference network.
    The red solid lines denote the forward process, and the blue dotted lines mark the gradient
    flow direction in the BP algorithm.}}
    \label{fig:net-loss}\vspace{-4mm}
\end{figure}

\vspace{-2mm}\subsection{Variational Form of Posterior}\vspace{-2mm}
We first construct a variational distribution  to approximate the
posterior  led by Eqs.~\eqref{Eq:generate_noisy_im}-\eqref{Eq:prior-sigma}. Similar to
the commonly used mean-field variation inference techniques, we assume
conditional independence between variables  and , i.e.,

Based on the conjugate priors in Eqs. \eqref{Eq:prior-z} and \eqref{Eq:prior-sigma}, it is natural to
formulate variational posterior forms of  and  as follows:

where  and  are designed as the prediction functions for getting
posterior parameters of latent variable  directly from . The function is represented as a network,
called denoising network or \textit{D-Net}, with parameters . Similarly,  and
 denote the prediction functions for evaluating posterior parameters of
 from , where  represents the parameters of the network, called Sigma network or \textit{S-Net}.
The aforementioned is illustrated in Fig. \ref{fig:net-loss}. Our aim is then to optimize
these network parameters  and  so as to get the explicit functions for predicting clean image
 as well as noise knowledge  from any test noisy image . A rational objective
function with respect to  and  is thus necessary
to train both the networks.

Note that the network parameters  and  are shared by posteriors calculated on all training data, and
thus if we train them on the entire training set, the method is expected to induce the general statistical inference
insight from noisy image to its underlying clean image and noise level.

\vspace{-2mm}\subsection{Variational Lower Bound of Marginal Data Likelihood}\vspace{-2mm}
For notation convenience, we simply write , ,
,  as , , ,  in
the following calculations. For any noisy image  and its simulated ``clean'' image  in the
training set, we can decompose its marginal likelihood as the following form~\cite{blei2006variational}:

where

Here  represents the exception of  w.r.t. stochastic variable  with probability density
function . The second term of Eq.~\eqref{Eq:lower_decomposition} is a KL divergence between the variational
approximate posterior  and the true posterior  with
non-negative value. Thus the first term  constitutes a
\textit{variational lower bound} on the logarithm of marginal likelihood , i.e.,

According to Eqs.~\eqref{Eq:posterior-factor-asumption}, \eqref{Eq:distribution_z_sigma} and \eqref{Eq:lower_bound}, the
lower bound can then be rewritten as:

It's pleased that all the three terms in Eq~\eqref{Eq:lower_bound_factor} can be integrated
analytically as follows:
\begin{footnotesize}



\end{footnotesize}
where  denotes the digamma function. Calculation details are listed in supplementary material.

We can then easily get the expected objective function (i.e., a negtive lower bound of the marginal likelihood on
entire training set) for optimizing the network parameters of \textit{D-Net} and \textit{S-Net} as follows:


\vspace{-4mm}\subsection{Network Learning} \label{sec:inference}\vspace{-2mm}
As aforementioned, we use \textit{D-Net} and \textit{S-Net} together to infer
the variational parameters ,  and ,  from the input
noisy image , respectively, as shown in Fig.~\ref{fig:net-loss}. It is critical to consider how to
calculate derivatives of this objective with respect to  involved in , ,
 and  to facilitate an easy use of stochastic gradient varitional inference. Fortunately,
different from other related variational inference techniques
like VAE \cite{kingma2013auto}, all three terms of Eqs.~\eqref{Eq:lower_bound_likeli}-\eqref{Eq:lower_bound_group_kl2}
in the lower bound Eq.~\eqref{Eq:lower_bound_factor} are differentiable and their derivatives can be calculated
analytically without the need of any reparameterization trick, largely reducing the difficulty of network
training.

At the training stage of our method, the network parameters can be easily updated with backpropagation (BP)
algorithm~\cite{goodfellow2016deep} through Eq.~\eqref{Eq:Objective}. The function of each term in this objective can
be intuitively explained: the first term represents the likelihood of the observed noisy images in training set,
and the last two terms control the discrepancy between the variational posterior and the corresponding prior.
During the BP training process, the gradient information from the likelihood term of Eq.~\eqref{Eq:lower_bound_likeli}
is used for updating both the parameters of \textit{D-Net} and \textit{S-Net} simultaneously, implying that the
inference for the latent clean image  and  is guided to be learned from each other.

At the test stage, for any test noisy image, through feeding it into \textit{D-Net}, the final denoising
result can be directly obtained by . Additionally, through inputting the noisy image to the \textit{S-Net},
the noise distribution knowledge (i.e., ) is easily inferred. Specifically, the noise variance in
each pixel can be directly obtained by using the mode of the inferred inverse Gamma
distribution: .

\vspace{-2mm}\subsection{Network Architecture}\vspace{-2mm}
The D-Net in Fig.~\ref{fig:net-loss} takes the noisy image  as input to infer the variational
parameters  and  in  of Eq.~\eqref{Eq:distribution_z_sigma},
and performs the denoising task in the proposed variational inference algorithm. In order to capture
multi-scale information of the image, we use a U-Net~\cite{ronneberger2015u} with depth 4 as the D-Net,
which contains 4 encoder blocks ([\textit{Conv}+\textit{ReLU}]2+\textit{Average pooling}), 3 decoder
blocks (\textit{Transpose Conv}+[\textit{Conv}+\textit{ReLU}]2) and symmetric skip connection under
each scale. For parameter , the residual learning strategy is adopted as in~\cite{zhang2017beyond}, i.e.,
, where  denotes the \textit{D-Net} with parameters .
As for the \textit{S-Net}, which takes the noisy image  as input and outputs the predicted variational
parameters  and  in  of Eq~\eqref{Eq:distribution_z_sigma},
we use the DnCNN~\cite{zhang2017beyond} architecture with five layers, and the feature channels of each layer
is set as 64. It should be noted that our proposed method is a general framework, most of the commonly used network
architectures~\cite{zhang2018ffdnet,Ploetz2018,lefkimmiatis2018universal,zhang2018residual} in image restoration can
also be easily substituted.

\vspace{-2mm}\subsection{Some Discussions}\label{sec:discussion}\vspace{-2mm}
It can be seen that the proposed method succeeds advantages of both model-driven MAP and data-driven deep learning methods.
On one hand, our method is a generative approach and possesses fine interpretability to the data generation mechanism;
and on the other hand it conducts an explicit prediction function, facilitating efficient image denoising as well as
noise estimation directly through an input noisy image. Furthermore, beyond current methods, our method can finely
evaluate and remove non-i.i.d. noises embedded in images, and has a good generalization capability to images with
complicated noises, as evaluated in our experiments. This complies with the main requirement of the blind image
denoising task.

If we set the hyper-parameter  in Eq.\eqref{Eq:prior-z} as an extremely small value close to , it is
easy to see that the objective of the proposed method is dominated by the second term of Eq.~\eqref{Eq:lower_bound_likeli},
which makes the objective degenerate as the MSE loss generally used in traditional deep learning
methods (i.e., minimizing . This provides a new understanding to
explain why they incline to overfit noise bias in training data. The posterior inference process puts dominant
emphasis on fitting priors imposed on the latent clean image, while almost neglects the effect of noise variations. This
naturally leads to its sensitiveness to unseen complicated noises contained in test images.

Very recently, both CBDNet~\cite{guo2018toward} and FFDNet~\cite{zhang2018ffdnet} are presented for the
denoising task by feeding the noisy image integrated with the pre-estimated noise level into the deep network to
make it better generalize to distinct noise types in training stage. Albeit more or less improving
the generalization capability of network, such strategy is still too heuristic and is not easy to interpret
how the input noise level intrinsically influence the final denoising result. Comparatively, our method is
constructed in a sound Bayesian manner to estimate clean image and noise distribution together from the input
noisy image, and its generalization can be easily explained from the perspective of generative model.
\begin{figure}[t]
    \centering\vspace{-3mm}
    \includegraphics[scale=0.54]{sigmaMap}\vspace{-3mm}
    \caption{\small{(a) The spatially variant map  for noise generation in training data. (b1)-(d1):
        Three different s on testing data in Cases 1-3.
        (b2)-(d2): Correspondingly predicted s by our method on the testing data.}}
    \vspace{-2mm}
    \label{fig:sigma_train_test}
\end{figure}
\begin{table}[t]
    \centering
    \caption{\small{The PSNR(dB) results of all competing methods on the three groups of test datasets. The best and second
    best results are highlighted in bold and Italic, respectively.}}\tiny \vspace{-2mm}
    \begin{tabular}{@{}C{1.0cm}@{}|@{}C{1.2cm}@{}|@{}C{1.1cm}@{}@{}C{1.1cm}@{}@{}C{1.1cm}@{}
        @{}C{1.0cm}@{}@{}C{1.0cm}@{}@{}C{1.5cm}@{}@{}C{1.3cm}@{}@{}C{1.3cm}@{}@{}C{1.1cm}@{}@{}C{1.2cm}@{}}
        \Xhline{0.8pt}
        \multirow{2}*{Cases}&\multirow{2}*{Datasets} & \multicolumn{8}{c}{Methods} \\
        \Xcline{3-12}{0.4pt}
        & & \tiny{CBM3D} &\tiny{WNNM}    &\tiny{NCSR}  &\tiny{MLP}  &\tiny{DnCNN-B} &\tiny{MemNet}  &\tiny{FFDNet}
        &\tiny{} &\tiny{UDNet} &\tiny{VDN} \\
        \Xhline{0.4pt}
        \multirow{3}*{Case 1} & Set5
                    & 27.76 &26.53   &26.62  &27.26  &29.85     & 30.10   &\textit{30.16}  &30.15  &28.13  &\textbf{30.39} \\
        \Xcline{2-12}{0.4pt}                                             
          &  LIVE1  & 26.58 &25.27   &24.96  &25.71  &28.81     & 28.96   &\textit{28.99}  &28.96  &27.19  &\textbf{29.22} \\
        \Xcline{2-12}{0.4pt}                                             
          &  BSD68  & 26.51 &25.13   &24.96  &25.58  &28.73     & 28.74   &\textit{28.78}  &28.77  &27.13  &\textbf{29.02}  \\
        \Xhline{0.4pt}                                                   
        \multirow{3}*{Case 2} & Set5                                     
                    & 26.34 &24.61   &25.76  &25.73  &29.04     & 29.55   &\textit{29.60}  &29.56  &26.01  &\textbf{29.80}  \\
        \Xcline{2-12}{0.4pt}                                             
          &  LIVE1  & 25.18 &23.52   &24.08  &24.31  &28.18     & 28.56   &\textit{28.58}  &28.56  &25.25  &\textbf{28.82} \\
        \Xcline{2-12}{0.4pt}                                             
          &  BSD68  & 25.28 &23.52   &24.27  &24.30  &28.15     & 28.36   &\textit{28.43}  &28.42  &25.13  &\textbf{28.67} \\
        \Xhline{0.4pt}                                                   
        \multirow{3}*{Case 3} & Set5                                     
                    & 27.88 &26.07   &26.84  &26.88  &29.13     & 29.51   &\textit{29.54}  &29.49  &27.54  &\textbf{29.74} \\
        \Xcline{2-12}{0.4pt}                                             
        &  LIVE1    & 26.50 &24.67   &24.96  &25.26  &28.17     & 28.37   &\textit{28.39}  &28.38  &26.48  &\textbf{28.65}   \\
        \Xcline{2-12}{0.4pt}                                             
        &  BSD68    & 26.44 &24.60   &24.95  &25.10  &28.11     & 28.20   &\textit{28.22}  &28.20  &26.44  &\textbf{28.46}   \\
        \Xhline{0.8pt}
    \end{tabular}
    \label{tab:psnr_noniid}
    \vspace{-2mm}
\end{table}

\vspace{-2mm}\section{Experimental Results}\vspace{-2mm}
We evaluate the performance of our method on synthetic and real datasets in this section. All experiments
are evaluated in the sRGB space. We briefly denote our method as VDN in the following. The training and
testing codes of our VDN is available at \url{https://github.com/zsyOAOA/VDNet}.

\vspace{-2mm}\subsection{Experimental Setting}\vspace{-2mm}
\textbf{Network training and parameter setting:} The weights of \textit{D-Net} and \textit{S-Net} in our variational
algorithm were initialized according to~\cite{he2015delving}. In each epoch, we randomly crop  patches
with size  from the images for training. The Adam algorithm~\cite{Kingma2015} is adopted to
optimize the network parameters through minimizing the proposed negative lower bound objective. The initial learning
rate is set as  and linearly decayed in half every 10 epochs until to .
The window size  in Eq.~\eqref{Eq:prior-sigma} is set as 7. The hyper-parameter  is set as
 and  in the following synthetic and real-world image denoising experiments, respectively.

\textbf{Comparison methods:} Several state-of-the-art denoising methods are adopted for performance comparison,
including CBM3D~\cite{4271520}, WNNM~\cite{gu2014weighted}, NCSR~\cite{dong2012nonlocally}, MLP~\cite{burger2012image},
DnCNN-B~\cite{zhang2017beyond}, MemNet~\cite{tai2017memnet}, FFDNet~\cite{zhang2018ffdnet}, UDNet~\cite{lefkimmiatis2018universal}
and CBDNet~\cite{guo2018toward}. Note that CBDNet is mainly designed for blind denoising task, and thus we only
compared CBDNet on the real noise removal experiments.

\vspace{-2mm}\subsection{Experiments on Synthetic Non-I.I.D. Gaussian Noise Cases}\vspace{-2mm}
Similar to~\cite{zhang2018ffdnet}, we collected a set of source images to train the network,
including 432 images from BSD~\cite{amfm_pami2011}, 400 images from the validation set of ImageNet~\cite{DengCHI14} and
4744 images from the Waterloo Exploration Database~\cite{ma2017waterloo}. Three commonly used datasets
in image restoration (Set5, LIVE1 and BSD68 in~\cite{kim2016accurate}) were adopted as test datasets to
evaluate the performance of different methods.
In order to evaluate the effectiveness and robustness of VDN under the non-i.i.d. noise configuration,
we simulated the non-i.i.d. Gaussian noise as following,

where  is a spatially variant map with the same size as the source image.
We totally generated four kinds of s as shown in Fig.~\ref{fig:sigma_train_test}.
The first (Fig.~\ref{fig:sigma_train_test} (a)) is used for generating noisy images of training data
and the others (Fig.~\ref{fig:sigma_train_test} (b)-(d)) generating three groups of testing data (denotes as
Cases 1-3). Under this noise generation manner, the noises in training data and testing data are
with evident difference, suitable to verify the robustness and generalization capability of competing
methods.

\textbf{Comparson with the State-of-the-art:}
Table~\ref{tab:psnr_noniid} lists the average PSNR results of all competing methods on three groups of testing data.
From Table~\ref{tab:psnr_noniid}, it can be easily observed that: 1) The VDN outperforms
other competing methods in all cases, indicating that VDN is able to handle such
complicated non-i.i.d. noise; 2) VDN surpasses FFDNet about 0.25dB averagely even though
FFDNet depends on the true noise level information instead of automatically inferring noise
distribution as our method;
3) the discriminative methods MLP, DnCNN-B and UDNet seem to evidently overfit on training noise bias;
4) the classical model-driven method CBM3D performs more stably than WNNM and NCSR, possibly due to the latter's
improper i.i.d. Gaussian
noise assumption. Fig.~\ref{fig:butterfly_case2} shows the denoising results of different competing methods on
one typical image in testing set of Case 2, and more denoising results can be found in the supplementary material.
Note that we only display the top four best results from all due to page limitation. It can be seen
that the denoised images by CBM3D and DnCNN-B still contain obvious noise, and FFDNet over-smoothes the image and
loses some edge information, while our proposed VDN removes most of the noise and preserves more details.
\begin{figure}[t]
    \centering
    \includegraphics[scale=0.46]{butterfly_case2_part}
    \vspace{-3mm}
    \caption{\small{Image denoising results of a typical test image in Case 2. (a) Noisy image, (b) Groundtruth,
    (c) CBM3D (24.63dB), (d) DnCNN-B (27.83dB), (e) FFDNet (28.06dB), (f) VDN (28.32dB).}}
    \label{fig:butterfly_case2} 
\end{figure}
\begin{table}[t]
    \centering
    \caption{\small{The PSNR(dB) results of all competing methods on AWGN noise cases of three
    test datasets.}}\tiny\vspace{-2mm}
    \begin{tabular}{@{}C{1.1cm}@{}|@{}C{1.1cm}@{}|@{}C{1.1cm}@{}@{}C{1.1cm}@{}@{}C{1.1cm}@{}
        @{}C{1.0cm}@{}@{}C{1.0cm}@{}@{}C{1.5cm}@{}@{}C{1.3cm}@{}@{}C{1.3cm}@{}@{}C{1.2cm}@{}@{}C{1.2cm}@{}}
        \Xhline{0.8pt}
        \multirow{2}*{Sigma}&\multirow{2}*{Datasets} & \multicolumn{8}{c}{Methods} \\
        \Xcline{3-12}{0.4pt}
                  & & CBM3D  &WNNM    &NCSR  &MLP   &DnCNN-B         &MemNet      &FFDNet            & &UDNet &VDN \\
        \Xhline{0.4pt}                                                        
        \multirow{3}*{} & Set5                                     
                     &33.42  &32.92   &32.57 &-     &34.04           &34.18       &34.30             &\textit{34.31}    &34.19 &\textbf{34.34} \\
        \Xcline{2-12}{0.4pt}                                                  
           &  LIVE1  &32.85  &31.70   &31.46 &-     & 33.72          &33.84       &\textbf{33.96}    &\textbf{33.96}    &33.74 &33.94 \\
        \Xcline{2-12}{0.4pt}                                                  
           &  BSD68  &32.67  &31.27   &30.84 &-     &\textit{33.87}  &33.76       &33.85             &33.68             &33.76 &\textbf{33.90}  \\
        \Xhline{0.4pt}                                                        
        \multirow{3}*{} & Set5                                     
                     &30.92  &30.61   &30.33 &30.55 &31.88           &31.98       &\textit{32.10}    &32.09             &31.82 &\textbf{32.24}  \\
        \Xcline{2-12}{0.4pt}                                                  
           &  LIVE1  &30.05  &29.15   &29.05 &29.16 &31.23           &31.26       &\textit{31.37}    &\textit{31.37}    &31.09 &\textbf{31.50} \\
        \Xcline{2-12}{0.4pt}                                                  
           &  BSD68  &29.83  &28.62   &28.35 &28.93 &\textit{31.22}  &31.17       &31.21             &31.20             &31.02 &\textbf{31.35} \\
        \Xhline{0.4pt}                                                        
        \multirow{3}*{} & Set5                                     
                     &28.16  &27.58   &27.20 &27.59 &28.95           &29.10       &\textit{29.25}    &\textit{29.25}    &28.87 &\textbf{29.47} \\
        \Xcline{2-12}{0.4pt}                                                  
           &  LIVE1  &26.98  &26.07   &26.06 &26.12 &27.95           &27.99       &\textit{28.10}    &\textit{28.10}    &27.82 &\textbf{28.36}   \\
        \Xcline{2-12}{0.4pt}                                                  
           &  BSD68  &26.81  &25.86   &25.75 &26.01 &27.91           &27.91       &\textit{27.95}    &\textit{27.95}    &27.76 &\textbf{28.19}   \\
        \Xhline{0.8pt}
    \end{tabular}
    \label{tab:psnr_iidgauss}
\end{table}

Even though our VDN is designed based on the non-i.i.d. noise assumption and trained on the non-i.i.d. noise data,
it also performs well on additive white Gaussian noise (AWGN) removal task.
Table~\ref{tab:psnr_iidgauss} lists the average PSNR results under three noise levels () of AWGN.
It is easy to see that our method obtains the best or at least comparable performance with the state-of-the-art
method FFDNet.
Combining Table~\ref{tab:psnr_noniid} and Table~\ref{tab:psnr_iidgauss}, it
should be rational to say that our VDN is robust and able to handle a wide range of noise types, due to its better
noise modeling manner.

\textbf{Noise Variance Prediction:} The \textit{S-Net} plays the role of noise modeling and is
able to infer the noise distribution from the noisy image. To verify the fitting capability of \textit{S-Net}, we
provided the  predicted by \textit{S-Net} as the input of FFDNet, and the denoising results are listed
in Table~\ref{tab:psnr_noniid} (denoted as ).
It is obvious that FFDNet under the real noise level and  almost have the same performance,
indicating that the \textit{S-Net} effectively captures proper noise information. 
The predicted noise variance Maps on three groups of testing data are shown in
Fig.~\ref{fig:sigma_train_test}~(b2-d2) for easy observation.
\begin{figure}[t]
    \centering\vspace{-3mm}
    \includegraphics[scale=0.48]{SIDD_validataion}
    \vspace{-2mm}
    \caption{\small{Denoising results on one typical image in the validation set of SIDD. (a) Noisy image,
    (b) Simulated ``clean'' image, (c) WNNM(21.80dB), (d) DnCNN (34.48dB), (e) CBDNet (34.84dB),
    (d) VDN (35.50dB).}}
    \label{fig:SIDD_validation}
\end{figure}
\begin{table}
    \centering
    \caption{The comparison results of different methods on SIDD benchmark and validation dataset.}
    \centering\vspace{-2mm}
    \scriptsize
    \begin{tabular}{@{}C{1.5cm}@{}|@{}C{1.4cm}@{}@{}C{1.4cm}@{}@{}C{1.1cm}@{}@{}C{1.7cm}@{}@{}C{1.4cm}@{}@{}C{1.1cm}@{}|@{}C{1.7cm}@{}@{}C{1.5cm}@{}@{}C{1.1cm}@{}}
        \Xhline{0.8pt}
        Datasets  & \multicolumn{6}{c|}{SIDD Benchmark} & \multicolumn{3}{c}{SIDD Validation} \\
        \Xhline{0.4pt}
        Methods   & CBM3D  & WNNM  & MLP   & DnCNN-B & CBDNet & VDN              & DnCNN-B          & CBDNet & VDN           \\
        \Xhline{0.4pt}
        PSNR      & 25.65  & 25.78 & 24.71 & 23.66   & 33.28  & \textbf{39.23}   & 38.41            &38.68   &\textbf{39.28} \\
        \Xhline{0.4pt}
        SSIM      & 0.685  & 0.809 & 0.641 & 0.583   & 0.868  & \textbf{0.971}   &\textbf{0.909}    &0.901   &\textbf{0.909}        \\
        \Xhline{0.8pt}
    \end{tabular}
    \label{tab:PSNR-SSIM-SIDD}
\end{table}
\begin{table}[!t]
    \centering\vspace{-1mm}
    \caption{\small{The comparison results of all competing methods on DND benchmark dataset.}}\vspace{-2mm}
    \scriptsize
    \begin{tabular}{@{}C{1.5cm}@{}|@{}C{1.6cm}@{}@{}C{1.5cm}@{}@{}C{1.5cm}@{}@{}C{1.3cm}@{}@{}C{1.5cm}@{}@{}C{1.5cm}@{}
        @{}C{1.6cm}@{}@{}C{1.8cm}@{}}
        \Xhline{0.8pt}
        Methods & CBM3D    & WNNM    & NCSR   & MLP    & DnCNN-B          & FFDNet & CBDNet          & VDN \\
        \Xhline{0.4pt}
        PSNR    &34.51     & 34.67   & 34.05  & 34.23  & 37.90            & 37.61  &38.06            & \textbf{39.38}  \\
        \Xhline{0.4pt}     
        SSIM    &0.8507    & 0.8646  & 0.8351 & 0.8331 &0.9430            & 0.9415 &0.9421           & \textbf{0.9518}  \\
        \Xhline{0.8pt}
    \end{tabular}
    \label{tab:PSNR-DND}
    \vspace{-3mm}
\end{table}

\vspace{-4mm}\subsection{Experiments on Real-World Noise}\vspace{-2mm}
In this part, we evaluate the performance of VDN on real blind denoising task, including two banchmark
datasets: DND~\cite{plotz2017benchmarking} and SIDD~\cite{Abdelhamed_2018_CVPR}. DND consists of 50
high-resolution images with realistic noise from 50 scenes taken by 4 consumer cameras.
However, it does not provide any other additional noisy and clean image pairs to train the network.
SIDD~\cite{Abdelhamed_2018_CVPR} is another real-world denoising benchmark, containing  real noisy images captured
by 5 cameras under 10 scenes. For each noisy image, it estimates one simulated ``clean'' image through
some statistical methods~\cite{Abdelhamed_2018_CVPR}.
About 80 ( pairs) of this dataset are provided for training purpose, and the rest as held for benchmark.
And 320 image pairs selected from them are packaged together as a medium version of SIDD, called SIDD Medium
Dataset\footnote{\label{foot:SIDD}https://www.eecs.yorku.ca/~kamel/sidd/index.php},
for fast training of a denoiser.
We employed this medium vesion dataset to train a real-world image denoiser, and test the performance on the two benchmarks.

Table~\ref{tab:PSNR-SSIM-SIDD} lists PSNR results of different methods on
SIDD benchmark\footnote{We employed the function 'compare\_ssim' in scikit-image library to calculate
the SSIM value, which is a little difference with the SIDD official results}.
Note that we only list the results of the competing methods that are available
on the official benchmark website\footref{foot:SIDD}.
It is evident that VDN outperforms other methods.
However, note that neither DnCNN-B nor CBDNet performs well, possibly because they were trained
on the other datasets, whose noise type is different from SIDD. For fair comparison, we retrained DnCNN-B and CBDNet
based on the SIDD dataset. The performance on the SIDD validation
set is also listed in Table~\ref{tab:PSNR-SSIM-SIDD}. Under same training conditions, VDN still outperforms DnCNN-B 0.87 PSNR
and CBDNet 0.60dB PSNR, indicating the effectiveness and significance of our non-i.i.d. noise modeling manner.
For easy visualization, on one typical denoising example, results of the best four competing methods are displayed
in Fig.~\ref{fig:SIDD_validation}

Table~\ref{tab:PSNR-DND} lists the performance of all competing methods
on the DND benchmark\footnote{https://noise.visinf.tu-darmstadt.de/}.
From the table, it is easy to be seen that our proposed VDN surpasses all the competing methods.
It is worth noting that CBDNet has the same optimized network with us, containing a \textit{S-Net} designed
for estimating the noise distribution and a \textit{D-Net} for denoising. The superiority of VDN compared
with CBDNet mainly benefits from the deep variational inference optimization.

For easy visualization, on one typical denoising example, results of the best four competing methods are displayed
in Fig.~\ref{fig:SIDD_validation}. Obviously, WNNM is ubable to remove the complex real noise, maybe because
the low-rankness prior is insufficient to describe all the image information and the IID Gaussian noise
assumption is in conflict with the real noise. With the powerful feature extraction ability of CNN, DnCNN and
CBDNet obtain much better denoising results than WNNM, but still with a little noise.
However, the denoising result of 
our proposed VDN has almost no noise and is very close to the groundtruth.

In Fig.~\ref{fig:sigmamap_benchmark}, we displayed the noise variance map predicted by \textit{S-Net} on the two real
benchmarks. The variance maps had been enlarged several times for easy visualization. It is easy to see that the
predicted noise variance map relates to the image content,
which is consistent with the well-known signal-depend
property of real noise to some extent.

\begin{figure}[t]
    \centering\vspace{-1mm}
    \includegraphics[scale=0.51]{sigmaMap_benchmark}
    \vspace{-2mm}
    \caption{\small{The noise variance map predicted by our proposed VDN on SIDD and DND benchmarks. (a1-a3): The noisy image, real noise
    () and noise variance map of one typical image of SIDD validation dataset. (b1-b2): The noisy image and predicted
    noise variance map of one typical image of DND dataset.}}
    \label{fig:sigmamap_benchmark}
\end{figure}
\begin{table}[t]
    \parbox[b]{.55\textwidth}{
    \raggedright
    \caption{\scriptsize Performance of VDN under different  values on SIDD validation
    dataset ().} \label{tab:eps_comparison}
    \scriptsize \vspace{-2mm}
    \begin{tabular}{C{0.75cm}|C{0.65cm}C{0.65cm}C{0.65cm}C{0.65cm}C{0.65cm}C{0.75cm}}
        \Xhline{0.8pt}
          &1e-4     &1e-5   &1e-6            &1e-7    &1e-8      &MSE     \\
        \Xhline{0.4pt}
        PSNR               &38.89    &39.20  &\textbf{39.28}  &39.05   &39.03     &39.01   \\
        \Xhline{0.4pt}
        SSIM               &0.9046   &0.9079 &\textbf{0.9086} &0.9064  &0.9063     &0.9061  \\
        \Xhline{0.8pt}
    \end{tabular}} \hspace{0.2cm} 
    \parbox[b]{.43\textwidth}{
    \raggedleft
    \caption{\scriptsize Performance of VDN under different  values on SIDD validation
    dataset ().} \label{tab:hyper_p}
    \scriptsize \vspace{-2mm}
    \begin{tabular}{C{0.7cm}|C{0.55cm}C{0.55cm}C{0.55cm}C{0.55cm}C{0.55cm}}
        \Xhline{0.8pt}
                        &5                &7                         &11               &15        &19      \\
        \Xhline{0.4pt}
        PSNR               &39.26            &\textbf{39.28}            &39.26            &39.24     &39.24       \\
        \Xhline{0.4pt}             
        SSIM               &\textbf{0.9089}  &0.9086                    &0.9086           &0.9079    &0.9079       \\
        \Xhline{0.8pt}
    \end{tabular}}
    \vspace{-3mm}
\end{table}
\vspace{-1mm}\subsection{Hyper-parameters Analysis}\vspace{-1mm}
The hyper-parameter  in Eq.~\eqref{Eq:prior-z} determines how much does the desired latent clean
image  depend on the simulated groundtruth . As discussed in Section~\ref{sec:discussion}, the
negative variational lower bound degenerates into MSE loss when  is setted as an extremely small
value close to 0. The performance of VDN under different  values on the SIDD validation dataset
is listed in Table~\ref{tab:eps_comparison}. For explicit comparison, we also directly trained the \textit{D-Net} 
under MSE loss as baseline. From Table~\ref{tab:eps_comparison}, we can see that: 1) when  is too
large, the proposed VDN obtains relatively worse results since the prior constraint on  by simulated
groundtruth  becomes weak; 2) with  decreasing, the performance of VDN tends to be similar
with MSE loss as analysised in theory; 3) the results of VDN surpasses MSE loss about 0.3 dB PSNR
when , which verifies the importantance of noise modeling in our method. Therefore, 
we suggest that the  is set as  or  in the real-world denoising task.

In Eq.~\eqref{Eq:prior-sigma}, we introduced a conjugate inverse gamma distribution as prior for .
The mode of this inverse gamma distribution  provides a rational approximate evaluation for ,
which is a local estimation in a  window centered at the  pixel. We compared the performance
of VDN under different  values on the SIDD validation dataset in Table~\ref{tab:hyper_p}. Empirically, VDN
performs consistently well for the hyper-parameter .

\vspace{-2mm}\section{Conclusion}\vspace{-2mm}
We have proposed a new variational inference algorithm, namely varitional denoising network (VDN),
for blind image denoising. The main idea is to learn an approximate posterior to the true posterior
with the latent variables (including clean image and noise variances) conditioned on the input noisy image.
Using this variational posterior expression, both tasks of blind image denoising and noise estimation can
be naturally attained in a unique Bayesian framework. The proposed VDN is a generative method, which can easily
estimate the noise distribution from the input data. Comprehensive experiments have demonstrated the superiority
of VDN to previous works on blind image denoising. Our method can also facilitate the study of other low-level
vision tasks, such as super-resolution and deblurring. Specifically, the fidelity term in these tasks can be
more faithfully set under the estimated non-i.i.d. noise distribution by VDN, instead of the traditional
i.i.d. Gaussian noise assumption.

\vspace{1mm}
\noindent\textbf{Acknowledgements}:This research was supported by National Key R\&D Program of China (2018YFB1004300), the China NSFC project
under contract 61661166011, 11690011, 61603292, 61721002 and U1811461, and Kong Kong RGC General Research Fund
(PolyU 152216/18E).

\bibliography{nips_reference}
\end{document}
