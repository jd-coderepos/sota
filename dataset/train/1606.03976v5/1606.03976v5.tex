

\documentclass{article}

\usepackage{times}
\usepackage{graphicx} \usepackage{subcaption}

\usepackage{natbib}

\usepackage{algorithm}
\usepackage{algorithmic}

\usepackage{hyperref}

\newcommand{\theHalgorithm}{\arabic{algorithm}}



\usepackage[accepted]{icml2016}

\usepackage[draft]{fixme}
\fxsetup{inline,nomargin,theme=color}
\FXRegisterAuthor{ufx}{uanfx}{\color{blue}Uri}

\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amsfonts}
\usepackage{comment}
\usepackage{todonotes}


\newtheorem{thmdef}{Definition}
\newtheorem{thmlem}{Lemma}
\newtheorem{thmcol}{Corollary}
\newtheorem{thmprop}{Proposition}
\newtheorem{thmthm}{Theorem}
\newtheorem{thmappthm}{Theorem}
\newtheorem{thmasmp}{Assumption}
\newtheorem{thmcorr}{Corollary}

\newtheorem{thmappdef}{Definition}
\renewcommand{\thethmappdef}{A\arabic{thmappdef}}
\newtheorem{thmappasmp}{Assumption}
\renewcommand{\thethmappasmp}{A\arabic{thmappasmp}}
\newtheorem{thmapplem}{Lemma}
\renewcommand{\thethmapplem}{A\arabic{thmapplem}}
\newtheorem{thmappcol}{Corollary}
\renewcommand{\thethmappcol}{A\arabic{thmappcol}}



\newenvironment{thmproof}[1][Proof]{\begin{trivlist}
\item[\hskip \labelsep {\textit{#1.}}]}{\end{trivlist}}
\newenvironment{thmproofsketch}[1][Proof sketch]{\begin{trivlist}
\item[\hskip \labelsep {\textit{#1.}}]}{\end{trivlist}}
\newtheorem{proposition}{Proposition}

\def\bff{\boldsymbol{f}}
\def\bu{\mathbf{u}}
\def\bx{\mathbf{x}}
\def\by{\mathbf{y}}
\def\bz{\mathbf{z}}
\def\bE{\mathbf{E}}
\def\bw{\mathbf{w}}
\def\cP{\mathcal{P}}
\def\bv{\mathbf{v}}
\def\hbu{\hat{\bu}}
\def\hbv{\hat{\bv}}
\def\balpha{\boldsymbol{\alpha}}
\def\bbeta{\boldsymbol{\beta}}
\def\bmu{\boldsymbol{\mu}}
\def\bgamma{\boldsymbol{\gamma}}
\def\bdelta{\boldsymbol{\delta}}
\def\E{\mathbb{E}}
\def\cN{\mathcal{N}}
\def\cL{\mathcal L}
\def\cD{\mathcal D}
\def\cC{\mathcal C}
\def\cT{\mathcal T}
\def\cX{\mathcal X}
\def\cY{\mathcal Y}
\def\cH{\mathcal H}
\def\cU{\mathcal U}
\def\cS{\mathcal S}
\def\cF{\mathrm{G}}
\def\cFL{\mathrm{F}_{Lip(1)}}
\def\cx{\mathcal x}
\def\cR{\mathcal{R}}
\def \R{\mathbb{R}}
\def \pFr {p^{F}_\Phi(r,t)}
\def \pCr {p^{CF}_\Phi(r,t)}
\def \epehe{\epsilon_{\text{PEHE}}}
\def \eate{\epsilon_{\text{ATE}}}
\def \eatt{\epsilon_{\text{ATT}}}
\def \eclass{\epsilon_{\text{Class}}}
\def \epehenn{{\epehe}_{nn}}

\def\tarnet{{TARNet}}

\newcommand\indep{\protect\mathpalette{\protect\independenT}{\perp}}
\def\independenT#1#2{\mathrel{\rlap{}\mkern2mu{#1#2}}}

\newcommand{\pc}{p^{t=0}}
\newcommand{\pt}{p^{t=1}}
\newcommand{\ptr}{â€¢}
\newcommand{\dPhi}{\frac{\partial \Phi(x)}{\partial x}}
\newcommand{\dPsi}{\frac{\partial \Psi(r)}{\partial r}}



\newcommand{\errTC}{\mathbb{E}_T \left[\text{err}_C(\Phi,h)\right]}
\newcommand{\errTT}{\mathbb{E}_T \left[\text{err}_T(\Phi,h)\right]}
\newcommand{\errCC}{\mathbb{E}_C \left[\text{err}_C(\Phi,h)\right]}
\newcommand{\errCT}{\mathbb{E}_C \left[\text{err}_T(\Phi,h)\right]}

\newcommand{\lyth}{\ell_{h,\Phi}(x,t)}
\newcommand{\lythr}{\ell_{h,\Phi}(\Psi(r),t)}
\newcommand{\lyxzeroh}{\ell_{h,\Phi}(x,0)}
\newcommand{\lyxoneh}{\ell_{h,\Phi}(x,1)}
\newcommand{\lyzeroh}{\ell_{h,\Phi}(r,0)}
\newcommand{\lyoneh}{\ell_{h,\Phi}(r,1)}
\newcommand{\lyzerohpsi}{\ell_{h,\Phi}(\Psi(r),0)}
\newcommand{\lyonehpsi}{\ell_{h,\Phi}(\Psi(r),1)}

\newcommand{\Jphix}{\frac{\partial \Phi (x)}{\partial x}}
\newcommand{\GP}{\Gamma_\Phi}
\def\mmd{\mbox{\sc mmd}}
\def\diag{\mbox{diag}}

\DeclareMathOperator*{\disc}{disc}
\DeclareMathOperator*{\expect}{E}

\def\transu{\Delta\bu}
\def\transv{\Delta\bv}
\def\pr{\mbox{Pr}}

\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator*{\argmax}{arg\,max}
 

\icmltitlerunning{Estimating individual treatment effect: generalization bounds and algorithms}

\begin{document}

\twocolumn[
\icmltitle{Estimating individual treatment effect: generalization bounds and algorithms}

\icmlauthor{Uri Shalit*}{shalit@cs.nyu.edu}
\icmladdress{CIMS,
            New York University, New York, NY 10003}
\icmlauthor{Fredrik D. Johansson*}{fredrikj@mit.edu}
\icmladdress{IMES, MIT, Cambridge, MA 02142}
\icmlauthor{David Sontag}{dsontag@csail.mit.edu}
\icmladdress{CSAIL \& IMES, MIT, Cambridge, MA 02139}


\icmlkeywords{counterfactual inference, causal effects}

]

\begin{abstract}
There is intense interest in applying machine learning to problems of causal inference in fields such as healthcare, economics and education. In particular, individual-level causal inference has important applications such as precision medicine. We give a new theoretical analysis and family of algorithms for predicting individual treatment effect (ITE) from observational data, under the assumption known as strong ignorability. The algorithms learn a ``balanced'' representation such that the induced treated and control distributions look similar. We give a novel, simple and intuitive generalization-error bound showing that the expected ITE estimation error of a representation is bounded by a sum of the standard generalization-error of that representation and the distance between the treated and control distributions induced by the representation. We use Integral Probability Metrics to measure distances between distributions, deriving explicit bounds for the Wasserstein and Maximum Mean Discrepancy (MMD) distances. Experiments on real and simulated data show the new algorithms match or outperform the state-of-the-art.
\end{abstract}

\section{Introduction}\label{sec:intro}

Making predictions about causal effects of actions is a central problem in many domains. For example, a doctor deciding which medication will cause better outcomes for a patient; a government deciding who would benefit most from subsidized job training; or a teacher deciding which study program would most benefit a specific student. In this paper we focus on the problem of making these predictions based on \emph{observational data}. Observational data is data which contains past actions, their outcomes, and possibly more context, but without direct access to the mechanism which gave rise to the action. For example we might have access to records of patients (context), their medications (actions), and outcomes, but we do not have complete knowledge of why a specific action was applied to a patient.

The hallmark of learning from observational data is that the actions observed in the data depend on variables which might also affect the outcome, resulting in \emph{confounding}: For example, richer patients might better afford certain medications, and job training might only be given to those motivated enough to seek it. The challenge is how to untangle these confounding factors and make valid predictions. Specifically, we work under the common simplifying assumption of ``no-hidden confounding'', assuming that all the factors determining which actions were taken are observed. In the examples above, it would mean that we have measured a patient's wealth or an employee's motivation.

As a learning problem, estimating causal effects from observational data is different from classic learning in that in our training data we never see the individual-level effect. For each unit, we only see their response to one of the possible actions - the one they had actually received. This is close to what is known in the machine learning literature as ``learning from logged bandit feedback'' \citep{strehl2010learning,swaminathan2015batch}, with the distinction that we do not have access to the model generating the action.


Our work differs from much work in causal inference in that we focus on the individual-level causal effect (also known as ``c-specific treatment effects'' \citet{shpitser2006ident,pearl2015detecting}), rather that the average or population level. Our main contribution is to give what is, to the best of our knowledge, the first generalization-error\footnote{Our use of the term generalization is different from its use in the study of \emph{transportability}, where the goal is to generalize causal conclusion across distributions \citep{bareinboim2016causal}.} bound for estimating individual-level causal effect, where each individual is identified by its features . The bound leads naturally to a new family of representation-learning based algorithms \cite{bengio2013representation}, which we show to match or outperform state-of-the-art methods on several causal effect inference tasks.


We frame our results using the Rubin-Neyman potential outcomes framework \cite{rubin2011causal}, as follows. We assume that for a unit with features , and an action (also known as treatment or intervention) , there are two potential outcomes:  and . In our data, for each unit we only see one of the potential outcomes, depending on the treatment assignment: if  we observe , if , we observe ; this is known as the \emph{Consistency} assumption. For example,  can denote the set of lab tests and demographic factors of a diabetic patient,  denote the standard medication for controlling blood sugar,  denotes a new medication, and  and  indicate the patient's blood sugar level if they were to be given medications  and , respectively.

We will denote , .
We are interested in learning the function .  is the expected \emph{treatment effect} of  relative to  on an individual unit with characteristics , or the Individual Treatment Effect (ITE) \footnote{Sometimes known as the Conditional Average Treatment Effect, CATE.}. For example, for a patient with features , we can use this to predict which of two treatments will have a better outcome. The fundamental problem of causal inference is that for any  in our data we only observe  or , but never both. 

As mentioned above, we make an important ``no-hidden confounders'' assumption, in order to make the conditional causal effect identifiable. We formalize this assumption by using the standard \emph{strong ignorability} condition: , and  for all . Strong ignorability is a sufficient condition for the ITE function  to be identifiable \cite{imbens2009recent,pearl2015detecting,rolling2014estimation}: see proof in the supplement. The validity of strong ignorability cannot be assessed from data, and must be determined by domain knowledge and understanding of the causal relationships between the variables.

One approach to the problem of estimating the function  is by learning the two functions  and  using samples from . This is similar to a standard machine learning problem of learning from finite samples. However, there is an additional source of variance at work here: For example, if mostly rich patients received treatment , and mostly poor patients received treatment , we might have an unreliable estimation of  for poor patients. In this paper we upper bound this additional source of variance using an Integral Probability Metric (IPM) measure of distance between two distributions , and , also known as the \emph{control} and \emph{treated} distributions. In practice we use two specific IPMs: the Maximum Mean Discrepancy \cite{gretton2012mmd}, and the Wasserstein distance \cite{villani2008optimal,cuturi2014fast}. We show that the expected error in learning the individual treatment effect function  is upper bounded by the error of learning  and , plus the IPM term. In the randomized controlled trial setting, where , the IPM term is , and our bound naturally reduces to a standard learning problem of learning two functions.

The bound we derive points the way to a family of algorithms based on the idea of representation learning \cite{bengio2013representation}: Jointly learn  hypotheses for both treated and control on top of a representation which minimizes a weighted sum of the factual loss (the standard supervised machine learning objective), and the IPM distance between the control and treated distributions induced by the representation. This can be viewed as learning the functions  and  under a constraint that encourages better generalization across the treated and control populations.
In the Experiments section we apply algorithms based on multi-layer neural nets as representations and hypotheses, along with MMD or Wasserstein distributional distances over the representation layer; see Figure \ref{fig:neuralnet} for the basic architecture.





In his foundational text about causality, \citet{pearl2009causality} writes: ``Whereas in traditional learning tasks we attempt to generalize from one set of instances to another, the causal modeling task is to generalize from behavior under one set of conditions to behavior under another set. \emph{Causal models should therefore be chosen by a criterion that challenges their stability against changing conditions...}'' [emphasis ours]. We believe our work points the way to one such stability criterion, for causal inference in the strongly ignorable case.




\begin{figure}[t!]
  \centering
  \includegraphics[width=1.0\columnwidth]{fig/neuralnet_split_var.pdf}
  \caption{\label{fig:neuralnet}Neural network architecture for ITE estimation.  is a loss function,  is an integral probability metric. Note that only one of  and  is updated for each sample during training. }
\end{figure}

\section{Related work}

Much recent work in machine learning for causal inference focuses on \emph{causal discovery}, with the goal of discovering the underlying causal graph or causal direction from data \citep{hoyer2009nonlinear,maathuis2010predicting,triantafillou2015constraint,mooij2016distinguishing}. We focus on the case when the causal graph is simple and known to be of the form , with no hidden confounders.

Under the causal model we assume, the most common goal of causal effect inference as used in the applied sciences is to obtain the average treatment effect: . We will briefly discuss how some standard statistical causal effect inference methods relate to our proposed method. Note that most of these approaches assume some form of ignorability.

One of the most widely used approaches to estimating ATE is covariate adjustment, also known as back-door adjustment or the G-computation formula \citep{pearl2009causality,rubin2011causal}. In its basic version, covariate adjustment amounts to estimating the functions , . Therefore, covariate adjustment methods are the most natural candidates for estimating ITE as well as ATE, using the estimates of . However, most previous work on this subject focused on asymptotic consistency \citep{belloni2014inference,athey2016efficient,chernozhukov2016double}, and so far there has not been much work on the generalization-error of such a procedure. One way to view our results is that we point out a previously unaccounted for source of variance when using covariate adjustment to estimate ITE. We suggest a new type of regularization, by learning representations with reduced IPM distance between treated and control, enabling a new type of bias-variance trade-off.

Another widely used family of statistical methods used in causal effect inference are weighting methods. Methods such as propensity score weighting \citep{austin2011introduction} re-weight the units in the observational data so as to make the treated and control populations more comparable. These methods do not yield themselves immediately to estimating an individual level effect, and adapting them for that purpose is an interesting research question.
Doubly robust methods combine re-weighting the samples and covariate adjustment in clever ways to reduce model bias \citep{funk2011doubly}. Again, we believe that finding how to adapt the concept of double robustness to the problem of effectively estimating ITE is an interesting open question.


Adapting machine learning methods for causal effect inference, and in particular for individual level treatment effect, has gained much interest recently. For example \citet{wager2015estimation,athey2016recursive} discuss how tree-based methods can be adapted to obtain a consistent estimator with semi-parametric asymptotic convergence rate. Recent work has also looked into how machine learning method can help detect heterogeneous treatment effects when some data from randomized experiments is available \citep{taddy2016nonparametric,peysakhovich2016combining}.
Neural nets have also been used for this purpose, exemplified in early work by \citet{beck2000improving}, and more recently by \citet{hartford2016counterfactual}'s work on deep instrumental variables.
Our work differs from all the above by focusing on the generalization-error aspects of estimating individual treatment effect, as opposed to asymptotic consistency, and by focusing solely on the observational study case, with no randomized components or instrumental variables.

Another line of work in the causal inference community relates to bounding the estimate of the average treatment effect given an instrumental variable \citep{balke1997bounds,bareinboim2012controlling}, or under hidden confounding, for example when the ignorability assumption does not hold \citep{pearl2009causality,cai2008bounds}. Our work differs, in that we only deal with the ignorable case, and in that we bound a very different quantity: the generalization-error of estimating individual level treatment effect.

Our work has strong connections with work on domain adaptation. In particular, estimating ITE requires prediction of outcomes over a different distribution from the observed one. Our ITE error upper bound has similarities with generalization bounds in domain adaptation given by \citet{ben2007analysis,mansour2009bdomain,bendavid2010theory,cortes2014domain}.
These bounds employ distribution distance metrics such as the A-distance or the discrepancy metric, which are related to the IPM distance we use. Our algorithm is similar to a recent algorithm for domain adaptation by \citet{JMLR:v17:15-239}, and in principle other domain adaptation methods (e.g. \citet{daume2009frustratingly,pan2011domain,sun2016return}) could be adapted for use in ITE estimation as presented here.

Finally, our paper builds on work by \citet{johansson2016counterfactual}, where the authors show a connection between covariate shift and the task of estimating the counterfactual outcome in a causal inference scenario. They proposed learning a representation of the data that makes the treated and control distributions more similar, and fitting a linear ridge-regression model on top of it. They then bounded the relative error of fitting a ridge-regression using the distribution with reverse treatment  assignment versus fitting a ridge-regression using the factual distribution. Unfortunately, the relative error bound is not at all informative regarding the absolute quality of the representation. In this paper we focus on a related but more substantive task: estimating the individual treatment effect, building on top of the counterfactual error term. We further provide an informative bound on the absolute quality of the representation. We also derive a much more flexible family of algorithms, including non-linear hypotheses and much more powerful distribution metrics in the form of IPMs such as the Wasserstein and MMD distances. Finally, we conduct significantly more thorough experiments including a real-world dataset and out-of-sample performance, and show our methods outperform previously proposed ones.
 
\section{Estimating ITE: Error bounds}\label{sec:theory}

In this section we prove a bound on the expected error in estimating the individual treatment effect for a given representation, and a hypothesis defined over that representation.
The bound is expressed in terms of (1) the expected loss of the model when learning the observed outcomes  as a function of  and , denoted ,  standing for ``Factual''; (2) an Integral Probability Metric (IPM) distance between the distribution of treated and control units. The term  is the classic machine learning generalization-error, and in turn can be upper bounded using the empirical error and model complexity terms, applying standard machine learning theory \citep{shalev2014understanding}.

\subsection{Problem setup}
We will employ the following assumptions and notations. The most important notations are in the Notation box in the supplement.
The space of covariates is a bounded subset . The outcome space is . Treatment  is a binary variable. We assume there exists a joint distribution , such that  and  for all  (strong ignorability).
The treated and control distributions are the distribution of the features  conditioned on treatment: , and , respectively.







Throughout this paper we will discuss \emph{representation functions} of the form
 , where  is the representation space. We make the following assumption about :
\begin{thmasmp}\label{asmp:inv}
The representation  is a twice-differentiable, one-to-one function. Without loss of generality we will assume that  is the image of  under . We then have  as the inverse of , such that  for all .
\end{thmasmp}
The representation  pushes forward the treated and control distributions into the new space ; we denote the induced distribution by .
\begin{thmdef}\label{def:phit}
Define , , to be the treated and control distributions induced over .
For a one-to-one , the distributions  and  can be obtained by the standard change of variables formula, using the determinant of the Jacobian of .
\end{thmdef} 

Let  be a representation function, and  be an hypothesis defined over the representation space . Let  be a loss function. We define two complimentary loss functions: one is the standard machine learning loss, which we will call the factual loss and denote . The other is the expected loss with respect to the distribution where the treatment assignment is flipped, which we call the counterfactual loss, .


\begin{thmdef}\label{def:perunitloss}
The expected loss for the unit and treatment pair  is:

The expected factual and counterfactual losses of  and  are:

\end{thmdef}

If  denotes patients' features,  a treatment, and  a potential outcome such as mortality, we think of  as measuring how well do  and  predict mortality for the patients and doctors' actions sampled from the same distribution as our data sample.  measures how well our prediction with  and  would do in a ``topsy-turvy'' world where the patients are the same but the doctors are inclined to prescribe exactly the opposite treatment than the one the real-world doctors would prescribe.

\begin{thmdef}\label{def:decompef}
The expected factual \emph{treated} and \emph{control} losses are:

\end{thmdef}
For , it is immediate to show that .


\begin{thmdef}\label{def:te}
The treatment effect (ITE) for unit  is:

\end{thmdef}


Let  by an hypothesis. For example, we could have that .
\begin{thmdef}\label{def:inditeerr}
The treatment effect estimate of the hypothesis  for unit  is:

\end{thmdef}


\begin{thmdef}
The expected Precision in Estimation of Heterogeneous Effect (PEHE,  \citet{hill2011bayesian}) loss of  is:

When , we will also use the notation .
\end{thmdef}

Our proof relies on the notion of an \emph{Integral Probability Metric} (IPM), which is a class of metrics between probability distributions \citep{sriperumbudur2012empirical,muller1997integral}.
For two probability density functions ,  defined over , and for a function family  of functions , we have that 
Integral probability metrics are always symmetric and obey the triangle inequality, and trivially satisfy . For rich enough function families , we also have that  and then  is a true metric over the corresponding set of probabilities. Examples of function families  for which  is a true metric are the family of bounded continuous functions, the family of -Lipschitz functions \citep{sriperumbudur2012empirical}, and the unit-ball of functions in a universal reproducing Hilbert kernel space \citep{gretton2012mmd}.



\begin{thmdef}
Recall that .
The expected variance of  with respect to a distribution :

We define:

\end{thmdef}
\subsection{Bounds}

We first state a Lemma bounding the counterfactual loss, a key step in obtaining the bound on the error in estimating individual treatment effect. We then give the main Thoerem. The proofs and details are in the supplement.

Let  be the marginal probability of treatment. By the strong ignorability assumption, .

\begin{thmlem}\label{lem:gen}
Let  be a one-to-one representation function, with inverse .
Let  be an hypothesis. Let  be a family of functions . Assume there exists a constant , such that for fixed , the per-unit expected loss functions  (Definition \ref{def:perunitloss}) obey . We have:

where ,  and  are as in Definitions \ref{def:perunitloss} and \ref{def:decompef}.
\end{thmlem}


\begin{thmthm}\label{thm:gen}
Under the conditions of Lemma \ref{lem:gen}, and assuming the loss  used to define  in Definitions \ref{def:perunitloss} and \ref{def:decompef} is the squared loss, we have:

where  and  are defined w.r.t. the squared loss.
\end{thmthm}

The main idea of the proof is showing that  is upper bounded by the sum of the expected factual loss  and expected counterfactual loss .  However, we cannot estimate , since we only have samples relevant to .  We therefore bound the difference  using an IPM.


Choosing a small function family  will make the bound tighter. However, choosing too small a family could result in an incomputable bound. For example, for the minimal choice , we will have to evaluate an expectation term of  over , and of  over . We cannot in general evaluate these expectations, since by assumption when  we only observe , and the same for  and . In addition, for some function families there is no known way to efficiently compute the IPM distance or its gradients. In this paper we use two function families for which there are available optimization tools. The first is the family of -Lipschitz functions, which leads to IPM being the Wasserstein distance \citep{villani2008optimal,sriperumbudur2012empirical}, denoted . The second is the family of norm- reproducing kernel Hilbert space (RKHS) functions, leading to the MMD metric \citep{gretton2012mmd,sriperumbudur2012empirical}, denoted . Both the Wasserstein and MMD metrics have consistent estimators which can be efficiently computed in the finite sample case \citep{sriperumbudur2012empirical}. Both have been used for various machine learning tasks in recent years \citep{gretton2009covariate,gretton2012mmd,cuturi2014fast}.


In order to explicitly evaluate the constant  in Theorem \ref{thm:gen}, we have to make some assumptions about the elements of the problem. For the Wasserstein case these are the loss , the Lipschitz constants of  and , and the condition number of the Jacobian of . For the MMD case, we make assumptions about the RKHS representability and RKHS norms of  , , and the standard deviation of . The full details are given in the supplement, with the major results stated in Theorems 2 and 3. In all cases we obtain that making  smaller increases the constant  precluding trivial solutions such as making  arbitrarily small.


For an empirical sample, and a \emph{family} of representations and hypotheses, we can further upper bound  and  by their respective empirical losses and a model complexity term using standard arguments \citep{shalev2014understanding}. The IPMs we use can be consistently estimated from finite samples \citep{sriperumbudur2012empirical}. The negative variance term  arises from the fact that, following \citet{hill2011bayesian,athey2016recursive}, we define the error  in terms of the conditional mean functions , as opposed to fitting the random variables .

Our results hold for any given  and  obeying the Theorem conditions. This immediately suggest an algorithm in which we minimize the upper bound in Eq. \eqref{eq:thm_gen} with respect to  and  and either the Wasserstein or MMD IPM, in order to minimize the error in estimating the individual treatment effect. This leads us to Algorithm \ref{alg:model} below.
 
\section{Algorithm for estimating ITE}\label{sec:model}

We propose a general framework called CFR (for Counterfactual Regression) for ITE estimation based on the theoretical results above. Our algorithm is an end-to-end, regularized minimization procedure which simultaneously fits both a balanced representation of the data and a hypothesis for the outcome.
CFR draws on the same intuition as the approach proposed by  \citet{johansson2016counterfactual}, but \emph{overcomes} the following limitations of their method: a) Their theory requires a two-step optimization procedure and is specific to \emph{linear} hypotheses of the learned representation (and does not support e.g. deep neural networks), b) The treatment indicator might get lost if the learned representation is high-dimensional (see discussion below).



We assume there exists a distribution  over , such that strong ignorability holds. We further assume we have a sample from that distribution , where  if ,  if . This standard assumption means that the treatment assignment determines which potential outcome we see. Our goal is to find a representation  and hypothesis  that will minimize  for .

In this work, we let  and  be parameterized by deep neural networks trained jointly in an end-to-end fashion, see Figure~\ref{fig:neuralnet}. This model allows for learning complex non-linear representations and hypotheses with large flexibility. \citet{johansson2016counterfactual} parameterized  with a single network using the concatenation of  and  as input. When the dimension of  is high, this risks losing the influence of  on  during training. To combat this, our first contribution is to parameterize  and  as two separate ``heads'' of the joint network, the former used to estimate the outcome under treatment, and the latter under control. This means that statistical power is shared in the representation layers of the network, while the effect of treatment is retained in the separate heads. Note that each sample is used to update only the head corresponding to the observed treatment; for example, an observation  is only used to update .

Our second contribution is to excplicitly account and adjust for the bias induced by treatment group imbalance. To this end, we seek a representation  and hypothesis  that minimizes a trade-off between predictive accuracy and imbalance in the representation space, using the following objective:

Note that  in the definition of  is simply the proportion of treated units in the population. The weights  compensate for the difference in treatment group size in our sample, see Theorem~\ref{thm:gen}.  is the (empirical) integral probability metric defined by the function family . For most IPMs, we cannot compute the factor  in Equation~\ref{eq:thm_gen}, but treat it as part of the hyperparameter . This makes our objective sensitive to the scaling of , even for a constant . We therefore normalize  through either projection or batch-normalization with fixed scale. We refer to the model minimizing \eqref{eq:overallalg} with  as Counterfactual Regression (CFR) and the variant without balance regularization () as Treatment-Agnostic Representation Network (\tarnet{}).

We train our models by minimizing \eqref{eq:overallalg} using stochastic gradient descent, where we backpropagate the error through both the hypothesis and representation networks, as described in Algorithm~\ref{alg:model}. Both the prediction loss and the penalty term  are computed for one mini-batch at a time. Details of how to obtain the gradient  with respect to the empirical IPMs are in the supplement.

\begin{algorithm}[tbp]
\caption{CFR: Counterfactual regression with integral probability metrics}
\label{alg:model}
\begin{algorithmic}[1]
  \STATE \textbf{Input:} Factual sample , scaling parameter , loss function , representation network  with initial weights , outcome network  with initial weights , function family  for IPM.
\STATE Compute 
 \STATE Compute  for 
  \WHILE{not converged}
\STATE Sample mini-batch  
    \STATE Calculate the gradient of the IPM term:\\
    {\small }
    \STATE Calculate the gradients of the empirical loss: \\
     \\
    
    \STATE Obtain step size scalar or matrix  with standard neural net methods e.g. Adam~\citep{kingma2014adam}
\STATE  
    \STATE Check convergence criterion
  \ENDWHILE
\end{algorithmic}
\end{algorithm}
 
\section{Experiments}
\label{sec:experiments}

Evaluating causal inference algorithms is more difficult than many machine learning tasks, since for real-world data we rarely have access to the ground truth treatment effect. Existing literature mostly deals with this in two ways. One is by using synthetic or semi-synthetic datasets, where the outcome or treatment assignment are fully known; we use the semi-synthetic IHDP dataset from \citet{hill2011bayesian}. The other is using real-world data from randomized controlled trials (RCT). The problem in using data from RCTs is that there is no imbalance between the treated and control distributions, making our method redundant. We partially overcome this problem by using the Jobs dataset from \citet{lalonde1986evaluating}, which includes both a randomized and a non-randomized component. We use both for training, but can only use the randomized component for evaluation. This alleviates, but does not solve, the issue of a completely balanced dataset being unsuited for our method.

We evaluate our framework CFR, and its variant without balancing regularization (\tarnet{}), in the task of estimating ITE and ATE. CFR is implemented as a feed-forward neural network with 3 fully-connected exponential-linear layers for the representation and 3 for the hypothesis. Layer sizes were 200 for all layers used for Jobs and 200 and 100 for the representation and hypothesis used for IHDP. The model is trained using Adam~\citep{kingma2014adam}. For an overview, see Figure~\ref{fig:neuralnet}. Layers corresponding to the hypothesis are regularized with a small  weight decay.  For continuous data we use mean squared loss and for binary data, we use log-loss. While our theory does not immediately apply to log-loss, we were curious to see how our model performs with it. 

We compare our method to Ordinary Least Squares with treatment as a feature (OLS-1), OLS with separate regressors for each treatment (OLS-2), -nearest neighbor (-NN), Targeted Maximum Likelihood, which is a doubly robust method (TMLE)~\citep{gruber2011tmle}, Bayesian Additive Regression Trees (BART)~\citep{chipman2010bart,bayestree}, Random Forests (Rand. For.)~\citep{breiman2001random}, Causal Forests  (Caus. For.)~\citep{wager2015estimation} as well as the Balancing Linear Regression (BLR) and Balancing Neural Network (BNN) by \citet{johansson2016counterfactual}.
For classification tasks we substitute Logistic Regression (LR) for OLS.  Choosing hyperparameters for estimating PEHE is non-trivial; we detail our selection procedure, applied to all methods, in subsection C.1 of the supplement.



We evaluate our model in two different settings. One is \emph{within-sample}, where the task is to estimate ITE for all units in a sample for which the (factual) outcome of \emph{one} treatment is observed. This corresponds to the common scenario in which a cohort is selected once and not changed. This task is non-trivial, as we never observe the ITE for any unit. The other is the \emph{out-of-sample} setting, where the goal is to estimate ITE for units with no observed outcomes. This corresponds to the case where a new patient arrives and the goal is to select the best possible treatment. Within-sample error is computed over both the training and validation sets, and out-of-sample error over the test set.

\vskip -7pt
\subsection{Simulated outcome: IHDP}\vskip -5pt
\citet{hill2011bayesian} compiled a dataset for causal effect estimation based on the Infant Health and Development Program (IHDP), in which the covariates come from a randomized experiment studying the effects of specialist home visits on future cognitive test scores. The treatment groups have been made imbalanced by removing a biased subset of the treated population. The dataset comprises 747 units (139 treated, 608 control) and 25 covariates measuring aspects of children and their mothers. We use the simulated outcome implemented as setting ``A'' in the NPCI package~\citep{npci}. Following \citet{hill2011bayesian}, we use the \emph{noiseless} outcome to compute the true effect. We report the estimated (finite-sample) PEHE loss  (Eq. ~\ref{eq:pehe}), and the absolute error in average treatment effect .
The results of the experiments on IHDP are presented in Table~\ref{tbl:ihdp_jobs_results} (left). We average over 1000 realizations of the outcomes with 63/27/10 train/validation/test splits.

\begin{table}[t!]
  \caption{\label{tbl:ihdp_jobs_results}Results on IHDP (left) and Jobs (right). MMD is squared linear MMD. Lower is better. \vspace{-1.3em}}
  \begin{center}
    \begin{small}
      \begin{sc}
      \begin{tabular}{l|cc|cc}
        \multicolumn{5}{l}{\bf{Within-sample}} \\
        \hline
        & \multicolumn{2}{c|}{IHDP} & \multicolumn{2}{c}{Jobs} \\
        &  &  &   & \\
        \hline
        OLS/LR-1 &  &  &  &  \\
        OLS/LR-2  &  &  &  &  \\
        BLR  &  &  &  &  \\
        -NN &  &  &  &  \\
		    TMLE  &  &  &  &  \\
BART  &  &  &  &  \\
        Rand.For.  &  &  &  &  \\
        Caus.For.  &  &  &  &  \\
        BNN  &  &  &  &  \\
\tarnet{}  &  &  &  &  \\
        CFR MMD &  &  &  &  \\
        CFR Wass &  &  &  &  \\
        \hline
        \multicolumn{5}{l}{\bf{Out-of-sample}} \\
        \hline
        & \multicolumn{2}{c|}{IHDP} & \multicolumn{2}{c}{Jobs} \\
        &  &  &   & \\
        \hline
        OLS/LR-1  &  &  &  &  \\
        OLS/LR-2  &  &  &  &  \\
        BLR  &  &  &  &  \\
        -NN &  &  &  &  \\
BART  &  &  &  &  \\
        Rand.For.  &  &  &  &  \\
        Caus.For.  &  &  &  &  \\
BNN  &  &  &  &  \\
\tarnet{}  &  &  &  &  \\
        CFR MMD &  &  &  &  \\
        CFR Wass &  &  &  &   \\
        \hline
      \end{tabular}
    \end{sc}
    \end{small}
  \end{center}
  \vspace{-1em}
\end{table}

\begin{figure}[t]
  \centering
  \includegraphics[width=0.85\columnwidth]{fig/Imb_RelPEHEVsAlpha.pdf}\vspace{-1em}
  \caption{\label{fig:ihdp_rel_imb}Out-of-sample ITE error versus IPM regularization for CFR Wass, relative to the error at , on 500 realizations of IHDP, with high (), medium and low (artificial) imbalance between control and treated.}
  \vspace{-1.2em}
\end{figure}

\vskip -5pt
We investigate the effects of increasing imbalance between the original treatment groups by constructing biased subsamples of the IHDP dataset. A logistic-regression propensity score model is fit to form estimates  of the conditional treatment probability. Then, repeatedly, with probability  we remove the remaining \emph{control} observation  that has  closest to , and with probability , we remove a random control observation. The higher , the more imbalance. For each value of , we remove  observations from each set, leaving .

\begin{figure}[t]
  \centering
  \includegraphics[width=0.85\columnwidth]{fig/policy_curve_comp_test.pdf}\vspace{-0.5em}
  \caption{\label{fig:policy_curve}Policy risk on Jobs as a function of treatment inclusion rate. Lower is better. Subjects are included in treatment in order of their estimated treatment effect given by the various methods. CFR Wass is similar to CFR and is omitted to avoid clutter. }
  \vspace{-1.2em}
\end{figure}

\subsection{Real-world outcome: Jobs}
\label{sec:nsw}
The study by \citet{lalonde1986evaluating} is a widely used benchmark in the causal inference community, where the treatment is job training and the outcomes are income and employment status after training. This dataset combines a randomized study based on the National Supported Work program with observational data to form a larger dataset~\citep{smith2005does}. The presence of the randomized subgroup gives a way to estimate the ``ground truth'' causal effect. The study includes 8 covariates such as age and education, as well as previous earnings. We construct a \emph{binary} classification task, called \emph{Jobs}, where the goal is to predict unemployment, using the feature set of \citet{dehejia2002propensity}. Following \citet{smith2005does}, we use the LaLonde experimental sample (297 treated, 425 control) and the PSID comparison group (2490 control). There were 482 (15\%) subjects unemployed by the end of the study. We average over 10 train/validation/test splits with ratios 56/24/20.

Because all the treated subjects  were part of the original randomized sample , we can compute the true average treatment effect on the treated by , where  is the control group. We report the error .
We cannot evaluate  on this dataset, since there is no ground truth for the ITE. Instead, in order to evaluate the quality of ITE estimation, we use a measure we call \emph{policy risk}. The policy risk is defined as the average loss in value when treating according to the policy implied by an ITE estimator. In our case, for a model , we let the policy be to treat, , if , and to not treat,  otherwise. The policy risk is  which we can estimate for the randomized trial subset of Jobs by . See figure~\ref{fig:policy_curve} for risk as a function of treatment threshold , aligned by proportion of treated, and Table \ref{tbl:ihdp_jobs_results} for the risk when .
\vskip -5pt
\subsection{Results}
We begin by noting that indeed imbalance confers an advantage to using the IPM regularization term, as our theoretical results indicate, see e.g. the results for CFR Wass () and \tarnet{} () on IHDP in Table~\ref{tbl:ihdp_jobs_results}. We also see in Figure~\ref{fig:ihdp_rel_imb} that even for the harder case of increased imbalance () between treated and control, the relative gain from using our method remains significant. On Jobs, we see a smaller gain from using IPM penalties than on IHDP. We believe this is the case because, while we are minimizing our bound over observational data and accounting for this bias, we are evaluating the predictions only on a randomized subset, where the treatment groups are distributed identically.
For both IHDP, non-linear estimators do significantly better than linear ones in terms of individual effect (). On the Jobs dataset, straightforward logistic regression does remarkably well in estimating the ATT. However, being a linear model, LR can only ascribe a uniform policy - in this case, ``treat everyone''. The more nuanced policies offered by non-linear methods achieve lower policy risk in the case of Causal Forests and CFR. This emphasizes the fact that estimating average effect and individual effect can require different models. Specifically, while smoothing over many units may yield a good ATE estimate, this might significantly hurt ITE estimation. -nearest neighbors has very good within-sample results on Jobs, because evaluation is performed over the randomized component, but suffers heavily in generalizing out of sample, as expected.




 
\vskip -10pt
\section{Conclusion}
In this paper we give a meaningful and intuitive error bound for the problem of estimating individual treatment effect. Our bound relates ITE estimation to the classic machine learning problem of learning from finite samples, along with methods for measuring distributional distances from finite samples. The bound lends itself naturally to the creation of learning algorithms; we focus on using neural nets as representations and hypotheses. We apply our theory-guided approach to both synthetic and real-world tasks, showing that in every case our method matches or outperforms the state-of-the-art. Important open questions are theoretical considerations in choosing the IPM weight , how to best derive confidence intervals for our model's predictions, and how to integrate our work with more complicated causal models such as those with hidden confounding or instrumental variables. 
\subsubsection*{Acknowledgments}
We wish to thank Aahlad Manas for his assistance with the experiments. We also thank Jennifer Hill, Marco Cuturi, Esteban Tabak and Sanjong Misra for fruitful conversations, and Stefan Wager for his help with the code for Causal Forests. DS and US were supported by NSF CAREER award \#1350965.

{\small
\bibliographystyle{icml2016}
\bibliography{cfr}
}
\newpage

\appendix

\section{Proofs}\label{sec:proof}

\subsection{Definitions, assumptions, and auxiliary lemmas}
\begin{figure*}
\begin{minipage}{\textwidth}\noindent\fbox{\parbox{\textwidth}
    {{\bf{Notation:}} \\
     : distribution on \\
     : the marginal probability of treatment.\\
     : treated distribution. : control distribution.\\
     : representation function mapping from  to  .\\
     : the inverse function of , mapping from  to .\\
     : the distribution induced by  on .\\
       , : treated and control distributions induced by  on .\\
     : loss function, from  to .\\
     : the expected loss of  for the unit  and treatment .\\
     , : expected factual and counterfactual loss of .\\
     , the expected treatment effect for unit .\\
     : expected error in estimating the individual treatment effect of a function . \\
     : the integral probability metric distance induced by function family  between distributions  and .
\vskip 0pt
    }}
\end{minipage}
\end{figure*}


We first define the necessary distributions and prove some simple results about them. We assume a joint distribution function , such that , and  for all . 
Recall that we assume \emph{Consistency}, that is we assume that we observe  and .

\begin{thmappdef}\label{def:teA}
The treatment effect for unit  is:

\end{thmappdef}

We first show that under consistency and strong ignorability, the ITE function  is identifiable:
\begin{thmapplem}
We have:

Equality \eqref{eq:useig} is because we assume that  and  are independent conditioned on .
Equality \eqref{eq:useconsistency} follows from the consistency assumption.
Finally, the last equation is composed entirely of observable quantities and can be estimated from data since we assume  for all .
\end{thmapplem}




\begin{thmappdef}
Let , and  denote respectively the treatment and control distributions.
\end{thmappdef}



Let  be a \emph{representation function}. We will assume that  is differentiable.

\begin{thmappasmp}\label{asmp:invA}
The representation function  is one-to-one. Without loss of generality we will assume that  is the image of  under , and define  to be the inverse of , such that  for all .
\end{thmappasmp}

\begin{thmappdef}\label{def:pphiA}
For a representation function , and for a distribution  defined over , let  be the distribution induced by  over . Define , , to be the treatment and control distributions induced over .
\end{thmappdef}


For a one-to-one , the distribution  over  can be obtained by the standard change of variables formula, using the determinant of the Jacobian of . See \cite{ben1999change} for the case of a mapping  between spaces of different dimensions.



\begin{thmapplem}\label{lemma:smpl_alg3}
For all , :

\end{thmapplem}
\begin{proof}
Let  be the absolute of the determinant of the Jacobian of .

where equality (a) is by the change of variable formula. The proof is identical for .
\end{proof}






Let  be a loss function, e.g. the absolute loss or squared loss.
\begin{thmappdef}\label{def:perunitlossA}
Let  be a representation function.
Let  be an hypothesis defined over the representation space .
The expected loss for the unit and treatment pair  is:

\end{thmappdef}

\begin{thmappdef}\label{def:epfepcf}
The expected factual loss and counterfactual losses of  and  are, respectively:


\end{thmappdef}
When it is clear from the context, we will sometimes use  and  for the expected factual and counterfactual losses of an arbitrary function .

\begin{thmappdef}\label{def:decomploss}
The expected \emph{treated} and \emph{control} losses are:




\end{thmappdef}
The four losses above are simply the loss conditioned on either the control or treated set.  Let  be the proportion of treated in the population. We then have the immediate result:
\begin{thmapplem}\label{lem:epsdecopm}


\end{thmapplem}
The proof is immediate, noting that , and from the Definitions \ref{def:perunitlossA} and \ref{def:decomploss} of the losses.

\begin{thmappdef}\label{def:ipm}
Let  be a function family consisting of functions . For a pair of distributions ,  over , define the \emph{Integral Probability Metric}:

\end{thmappdef}
 defines a pseudo-metric on the space of probability functions over , and for sufficiently large function families,  is a proper metric \cite{muller1997integral}. Examples of sufficiently large functions families includes the set of bounded continuous functions, the set of -Lipschitz functions, and the set of unit norm functions in a universal Reproducing Norm Hilbert Space. The latter two give rise to the Wasserstein and Maximum Mean Discrepancy metrics, respectively \cite{gretton2012mmd,sriperumbudur2012empirical}. We note that for function families  such as the three mentioned above, for which , the absolute value can be omitted from definition \ref{def:ipm}.


\subsection{General IPM bound}


We now state and prove the most important technical lemma of this section.
\begin{thmapplem}[Lemma 1, main text]\label{lem:genA}
Let  be an invertible representation with  its inverse. Let  be defined as in Definition \ref{def:pphiA}. Let . Let  be a family of functions , and denote by  the integral probability metric induced by .  Let  be an hypothesis. Assume there exists a constant , such that for , the function . Then we have:

\end{thmapplem}

\begin{proof}
\allowdisplaybreaks

Equality \eqref{eq:usedef6} is by Definition \ref{def:decomploss} of the treated and control loss, equality \eqref{eq:usecov} is by the change of variables formula and Definition \ref{def:pphiA} of  and , inequality \eqref{proof:ineq} is by the premise that  for , and \eqref{eq:useipmdef} is by Definition \ref{def:ipm} of an IPM.
\end{proof}


The essential point in the proof of Lemma \ref{lem:genA} is inequality \ref{proof:ineq}. Note that on the l.h.s. of the inequality, we need to evaluate the expectations of  over  and  over . Both of these expectations are in general unavailable, since they require us to evaluate treatment outcomes on the control, and control outcomes on the treated. We therefore upper bound these unknowable quantities by taking a supremum over a function family which includes  and . The upper bound ignores most of the details of the outcome, and amounts to measuring a distance between two distributions we have samples from: the control and treated distribution. Note that for a randomized trial (i.e. when ) with we have that . Indeed, it is straightforward to show that in that case we actually have an equality: .


The crucial condition in Lemma \ref{lem:genA} is that the function  is in . In subsections \ref{subsec:wass} and \ref{subsec:mmd} below we look into two specific function families , and evaluate what does this inclusion condition entail, and in particular we will derive specific bounds for .



\begin{thmappdef}\label{def:m}
For  define:

\end{thmappdef}
Obviously for the treatment effect  we have .


Let  by an hypothesis, such that  for a representation  and hypothesis  defined over the output of .
\begin{thmappdef}\label{def:inditeerrA}
The treatment effect estimate for unit  is:

\end{thmappdef}


\begin{thmappdef}
 The expected Precision in Estimation of Heterogeneous Effect (PEHE) loss of  is:

\end{thmappdef}


\begin{thmappdef}\label{def:sigma2}
The expected variance of  with respect to a distribution :

We define:

\end{thmappdef}
If  are deterministic functions of , then .


We now show that  is upper bounded by  where  and  are w.r.t. to the squared loss. An analogous result can be obtained for the absolute loss, using mean absolute deviation. 

\begin{thmapplem}\label{lem:epsmloss}
For any function , and distribution  over :

where  and  are w.r.t. to the squared loss.
\end{thmapplem}
\begin{proof}
For simplicity we will prove for  and . The proof for  and  is identical.

where the equality \eqref{eq:epssigm} is by the Definition \ref{def:sigma2} of , and because the integral in \eqref{eq:expctzero} evaluates to zero, since .
\end{proof}

\begin{thmappthm}\label{thm:indtausqloss}
Let  be a one-to-one representation function, with inverse . Let  be defined as in Definition \ref{def:pphiA}. Let . Let  be a family of functions , and denote by  the integral probability metric induced by .  Let  be an hypothesis. Let the loss .  Assume there exists a constant , such that for , the functions .
We then have:

where  and  are with respect to the squared loss.
\end{thmappthm}

\begin{proof}
We will prove the first inequality, . The second inequality is then immediate by Lemma \ref{lem:genA}.
Recall that we denote  for .

where \eqref{eq:sqineq} is because , \eqref{eq:use:margt2sq} is because  and \eqref{eq:usesigmineq} is by Lemma \ref{lem:epsmloss} and Definition \ref{def:epfepcf} of the losses ,  and Definition \ref{def:sigma2} of .
Having established the first inequality in the Theorem statement, we now show the second.
We have by Lemma \ref{lem:genA} that:

We further have by Lemma \ref{lem:epsdecopm} that:

Therefore 

\end{proof}

The upper bound is in terms of the standard generalization error on the treated and control distributions separately. Note that in some cases we might have very different sample sizes for treated and control, and that will show up in the finite sample bounds of these generalization errors.

We also note that the upper bound can be easily adapted to the case of the absolute loss PEHE . In that case the upper bound in the Theorem will have a factor  instead of the  stated above, and the standard deviation  replaced by mean absolute deviation. The proof is straightforward where one simply applies the triangle inequality in inequality \eqref{eq:sqineq}.


We will now give specific upper bounds for the constant  in Theorem \ref{thm:indtausqloss}, using two function families  in the IPM: the family of -Lipschitz functions, and the family of -norm reproducing kernel Hilbert space functions. Each one will have different assumptions about the distribution  and about the representation  and hypothesis .

\subsection{The family of -Lipschitz functions}\label{subsec:wass}

For , a function  has Lipschitz constant  if for all , . If  is differentiable, then a sufficient condition for -Lipschitz constant is if  for all .

For simplicity's sake we assume throughout this subsection that the true labeling functions the densities  and the loss  are differentiable. However, this assumption could be relaxed to a mere Lipschitzness assumption.
\begin{thmappasmp}\label{assmp_f_lip}
There exists a constant  such that for all , , .
\end{thmappasmp}
Assumption \ref{assmp_f_lip} entails that each of the potential outcomes change smoothly as a function of the covariates (context) .

\begin{thmappasmp}\label{asmp:loss}
The loss function  is differentiable, and there exists a constant  such that  for . Additionally, there exists a constant  such that for all , .
\end{thmappasmp}
Assuming  is compact, loss functions which obey Assumption \ref{asmp:loss} include the log-loss, hinge-loss, absolute loss, and the squared loss.

When we let  in Definition \ref{def:ipm} be the family of -Lipschitz functions, we obtain the so-called \emph{-Wasserstein} distance between distributions, which we denote .
It is well known that  is indeed a metric between distributions \cite{villani2008optimal}.




\begin{thmappdef}\label{def:rcondA}
Let  be the Jacobian matrix of  at point , i.e. the matrix of the partial derivatives of . Let  and  denote respectively the largest and smallest singular values of a matrix .
Define .
\end{thmappdef}
It is an immediate result that .

\begin{thmappdef}
We will call a representation function  \emph{Jacobian-normalized} if .
\end{thmappdef}
Note that any non-constant representation function  can be Jacobian-normalized by a simple scalar multiplication.


\begin{thmapplem}\label{lem:lip}
Assume that  is a Jacobian-normalized representation, and let  be its inverse.
For , the Lipschitz constant of  is bounded by , where   is from Assumption \ref{assmp_f_lip}, and  as in Definition \ref{def:rcondA}.
\end{thmapplem}
\begin{proof}
Let  be the inverse of , which exists by the assumption that  is one-to-one. Let  be the Jacobian matrix of  evaluated at , and similarly let  be the Jacobian matrix of  evaluated at . Note that  for , since  is the identity function on .	Therefore for any  and :

where  and  are respectively the largest and smallest singular values of the matrix , i.e.  is the spectral norm of .


For  and , we have by the chain rule:

where inequality \eqref{eqn:matnorm} is by the matrix norm inequality, equality \eqref{eqn:invjac} is by \eqref{eqn:sigman2}, inequality \eqref{eqn:maxgrad} is by assumption \ref{assmp_f_lip} on the norms of the gradient of  w.r.t  , and inequality \eqref{eqn:ineq_vphi} is by Definition \ref{def:rcondA} of , the assumption that  is Jacobian-normalized, and noting that singular values are necessarily non-negative.



\end{proof}

\begin{thmapplem}\label{lem:errlip}
Under the conditions of Lemma \ref{lem:genA}, further assume that for ,  has gradients bounded by  as in \ref{assmp_f_lip}, that  has bounded gradient norm , that the loss  has bounded gradient norm , and that  is Jacobian-normalized. Then the Lipschitz constant of  is upper bounded by  for .
\end{thmapplem}
\begin{proof}
Using the chain rule, we have that:

where inequality \ref{lip_const_ineq1} is due to Assumption \ref{asmp:loss} and inequality \ref{lip_const_ineq2} is due to Lemma \ref{lem:lip}.
\end{proof}



\begin{thmapplem}\label{thm:wasA}
Let  be the marginal probability of treatment, and assume . Let  be a one-to-one, Jacobian-normalized representation function. Let  be the Lipschitz constant of the functions  on . Let  be the Lipschitz constant of the loss function , and  be as in Assumption \ref{asmp:loss}. Let  be an hypothesis with Lipschitz constant .
Then:

\end{thmapplem}

\begin{proof}
We will apply Lemma \ref{lem:genA} with . By Lemma \ref{lem:errlip}, we have that for , the function . Inequality \eqref{eq:thm_wasA} then holds as a special case of Lemma \ref{lem:genA}.
\end{proof}
\begin{thmappthm}Under the assumptions of Lemma \ref{thm:wasA}, using the squared loss for , we have:

\end{thmappthm}
\begin{proof}
Plug in the upper bound of Lemma \ref{thm:wasA} into the upper bound of Theorem \ref{thm:indtausqloss}.
\end{proof}


We examine the constant  in Theorem \ref{thm:wasA}. , the Lipschitz constant of  and , is not under our control and measures an aspect of the complexity of the true underlying functions we wish to approximate. The terms  and  depend on our choice of loss function and the size of the space . The term  comes from our assumption that the hypothesis  has norm . Note that smaller , while reducing the bound, might force the factual loss term  to be larger since a small  implies a less flexible . Finally, consider the term .
The assumption that  is normalized is rather natural, as we do not expect a certain scale from a representation. Furthermore, below we show that in fact the Wasserstein distance is positively homogeneous with respect to the representation . Therefore, in Lemma \ref{thm:wasA}, we can indeed assume that  is normalized. The specific choice of \emph{Jacobian-normalized} scaling yields what is in our opinion a more interpretable result in terms of the inverse condition number . For twice-differentiable ,  is minimized if and only if  is a linear orthogonal transformation \cite{mathover}. 

\begin{thmapplem}\label{lem:wassinvar}
The Wasserstein distance is positive homogeneous for scalar transformations of the underlying space. Let ,  be probability density functions defined over . For  and
 the mapping , let  and  be the distributions on  induced by . Then:

\end{thmapplem}

\begin{proof}
Following \cite{villani2008optimal,tabak2016preconditioning}, we use another characterization of the Wasserstein  distance. Let  be the set of mass preserving maps from  to itself which map the distribution  to the distribution . That is,  . We then have that:

It is known that the infimum in \eqref{eq:wass_def_M} is actually achievable \citep[Theorem 5.2]{villani2008optimal}. Denote by  the map achieving the infimum for  . Define , by , where .   maps  to , and we have that . Therefore  achieves the infimum for the pair , and we have that .
\end{proof}

\subsection{Functions in the unit ball of a RKHS}\label{subsec:mmd}

Let  be a reproducing kernel Hilbert space, with corresponding kernels , . We have for all  that   is its Hilbert space mapping, and similarly  for all .

Recall that the major condition in Lemma \ref{lem:genA} is that . The function space  we use here is .

We will focus on the case where  is the squared loss, and we will make the following two assumptions:

\begin{thmappasmp}\label{asmp:yinrkhs}
There exist  such that , i.e.
the mean potential outcome functions  are in .   Further assume that .
\end{thmappasmp}

\begin{thmappdef}\label{def:eta}
Define .  is the standard deviation of .
\end{thmappdef}

\begin{thmappasmp}\label{asmp:etainrkhs}
There exists  such that , i.e. the conditional standard deviation functions of  are in . Further assume that .
\end{thmappasmp}
\begin{thmappasmp}\label{asmp:phiinrkhs}
Let  be an invertible representation function, and let  be its inverse.
We assume there exists a bounded linear operator  such that . We further assume that the Hilbert-Schmidt norm (operator norm)  of  is bounded by .
\end{thmappasmp}

The two assumptions above amount to assuming that  can be represented as one-to-one linear map between the two Hilbert spaces  and .

Under Assumptions \ref{asmp:yinrkhs} and \ref{asmp:phiinrkhs} about , and , we have that , where  is the adjoint operator of  \cite{grunewalder2013smooth}.


\begin{thmapplem}\label{lem:mmdbound}
Let  be an hypothesis, and assume that there exist  such that , and such that .
Under Assumption \ref{asmp:yinrkhs} about , we have that  is in the tensor Hilbert space . Moreover, the norm of  in  is upper bounded by .
\end{thmapplem}
\begin{proof}
We first decompose  into a noise and mean fitting term, using :

where equality \eqref{eq:expctzero2} is by Definition \ref{def:eta} of , and because  by definition of .

Moving to , recall that , .
By linearity of the Hilbert space, we have that .
By a well known result \citep[Theorem 7.25]{steinwart2008support}, the product  lies in the tensor product space  , and is equal to . The norm of this function in  is . This is the general Hilbert space version of the fact that for a vector  one has that , where  is the matrix Frobenius norm, and  is the square of the standard Euclidean norm.
We therefore have a similar result for , using Assumption \ref{asmp:etainrkhs}: .  
The norm of this function in  is . 
Overall this leads us to conclude, using Equation \eqref{eq:mmddecomp} that .
Now we have, using \eqref{eq:mmddecomp}:

Inequality \eqref{eq:triineqmmd} is by the norms given above and the triangle inequality.
Inequality \eqref{eq:mmdineq1} is because for any Hilbert space , . Inequality \eqref{eq:mmdineq2} is by the definition of the operator norm. Equality \eqref{eq:mmdeq1} is because the norm of the adjoint operator is equal to the norm of the original operator, where we abused the notation  to mean both the norm of operators from  to  and vice-versa. Finally, inequality \eqref{eq:mmdineq3} is by Assumptions \ref{asmp:yinrkhs}, \ref{asmp:etainrkhs} and \ref{asmp:phiinrkhs}, and by the Lemma's premise on the norm of .
\end{proof}

\begin{thmapplem}\label{thm:mmdA}
Let  be the marginal probability of treatment, and assume . Assume the distribution of  conditioned on  follows Assumptions \ref{asmp:etainrkhs} with constant .
Let  be a one-to-one representation function which obeys Assumption \ref{asmp:phiinrkhs} with corresponding operator  with operator norm . Let the functions ,  obey Assumption \ref{asmp:yinrkhs}, with bounded Hilbert space norm  . Let  be an hypothesis, and assume that there exist  such that , such that . Assume that  and  are defined with respect to  being the squared loss. Then:

where  and  use the squared loss.
\end{thmapplem}
\begin{proof}
We will apply Lemma \ref{lem:genA} with . By Lemma \ref{lem:mmdbound}, we have that for  and  being the squared loss, . Inequality \eqref{eq:thm_mmdA} then holds as a special case of Lemma \ref{lem:genA}.
\end{proof}

\begin{thmappthm}
Under the assumptions of Lemma \ref{thm:mmdA}, using the squared loss for , we have:

\end{thmappthm}
\begin{proof}
Plug in the upper bound of Lemma \ref{thm:mmdA} into the upper bound of Theorem \ref{thm:indtausqloss}.
\end{proof}
 \section{Algorithmic details}\label{sec:appmodel}

We give details about the algorithms used in our framework. 



\subsection{Minimizing the Wasserstein distance}
In general, computing (and minimizing) the Wasserstein distance involves solving a linear program, which may be prohibitively expensive for many practical applications. \citet{cuturi2013sinkhorn} showed that an approximation based on entropic regularization can be obtained through the Sinkhorn-Knopp matrix scaling algorithm, at orders of magnitude faster speed. Dubbed Sinkhorn distances, the approximation is computed using a fixed-point iteration involving repeated multiplication with a kernel matrix . We can use the algorithm of \citet{cuturi2013sinkhorn} in our framework. See Algorithm~\ref{alg:wassgrad} for an overview of how to compute the gradient  in Algorithm~\ref{alg:model}. When computing , disregarding the gradient  amounts to minimizing an upper bound on the Sinkhorn transport. More advanced ideas for stochastic optimization of this distance have recently proposed by \citet{aude2016stochastic}, and might be used in future work.

\begin{algorithm}[tbp]
\caption{Computing the stochastic gradient of the Wasserstein distance}
\label{alg:wassgrad}
\begin{algorithmic}[1]
  \STATE \textbf{Input:} Factual  , representation network  with current weights by 
  \STATE Randomly sample a mini-batch with  treated and  control units \\
  
   \STATE Calculate the  pairwise distance matrix between all treatment and control pairs : \\
   
    \STATE Calculate the approximate optimal transport matrix  using Algorithm 3 of \citet{cuturi2014fast}, with input 
  \STATE Calculate the gradient:\\ 
  \vspace{0.2em}
\end{algorithmic}
\end{algorithm}



While our framework is agnostic to the parameterization of , our experiments focus on the case where  is a neural network. For convenience of implementation, we may represent the fixed-point iterations of the Sinkhorn algorithm as a recurrent neural network, where the states  evolve according to

Here,  is a kernel matrix corresponding to a metric such as the euclidean distance, , and  are the sizes of the control and treatment groups. In this way, we can minimize our entire objective with most of the frameworks commonly used for training neural networks, out of the box.

\subsection{Minimizing the maximum mean discrepancy}

The MMD of treatment populations in the representation , for a kernel  can be written as,





The linear maximum-mean discrepancy can be written as a distance between means. In the notation of Algorithm~\ref{alg:model},

Let

Then the gradient of the MMD with respect to  is,


 \section{Experimental details}\label{sec:appexp}

\subsection{Hyperparameter selection}
Standard methods for hyperparameter selection, such as cross-validation, are not generally applicable for estimating the PEHE loss since only one potential outcome is observed (unless the outcome is simulated). For real-world data, we may use the observed outcome  of the nearest neighbor  to  in the opposite treatment group,  as surrogate for the counterfactual outcome. We use this to define a nearest-neighbor approximation of the PEHE loss, . On IHDP, we use the objective value on the validation set for early stopping in CFR, and  for hyperparameter selection. On the Jobs dataset, we use the policy risk on the validation set.

See Table~\ref{tbl:hypparams} for a description of hyperparameters and search ranges.

\begin{table}[t!]
  \caption{\label{tbl:hypparams}Hyperparameters and ranges.}
  \begin{center}
      \begin{tabular}{ll}
        Parameter & Range \\ \hline
        Imbalance parameter,  &  \\
        Num. of representation layers &  \\
        Num. of hypothesis layers &  \\
        Dim. of representation layers &  \\
        Dim. of hypothesis layers &  \\
        Batch size &  \\
        \hline
      \end{tabular}
    \end{center}
\end{table}

\subsection{Learned representations}
Figure~\ref{fig:reps} show the representations learned by our CFR algorithm.




\begin{figure*}[]
  \centering
  \begin{subfigure}[b]{0.3\textwidth}
    \centering
    \includegraphics[width=0.90\columnwidth]{fig/rep_cfr.png}
    \caption{Original data}
  \end{subfigure}
  \begin{subfigure}[b]{0.3\textwidth}
    \centering
    \includegraphics[width=0.90\columnwidth]{fig/rep_cfr_mmd.png}
    \caption{Linear MMD}
  \end{subfigure}
  \begin{subfigure}[b]{0.3\textwidth}
    \centering
    \includegraphics[width=0.90\columnwidth]{fig/rep_cfr_wass.png}
    \caption{Wasserstein}
  \end{subfigure}
  \caption{\label{fig:reps}t-SNE visualizations of the balanced representations of IHDP learned by our algorithms CFR, CFR MMD and CFR Wass. We note that the nearest-neighbor like quality of the Wasserstein distance results in a strip-like representation, whereas the linear MMD results in a ball-like shape in regions where overlap is small.}
\end{figure*}

\subsection{Absolute error for increasingly imbalanced data}
Figure~\ref{fig:ihdp_abs_imb} shows the results of the same experiment as Figure 2 of the main paper, but in absolute terms.
\begin{figure}[t]
  \centering
  \includegraphics[width=0.90\columnwidth]{fig/Imb_AbsPEHEVsAlpha.pdf}\vspace{-1em}
  \caption{\label{fig:ihdp_abs_imb}Out-of-sample error in estimated ITE, as a function of IPM regularization parameter for CFR Wass, on 500 realizations of IHDP, with high (), medium and low (artificial) imbalance between control and treated. }
  \vspace{-1em}
\end{figure}



 
\end{document}
