
\documentclass{llncs}
\title{An Event Structure Model for Probabilistic Concurrent Kleene Algebra}
\author{Annabelle McIver\inst{1}, Tahiry Rabehaja\inst{1,2} and Georg Struth\inst{2}}
\institute{Department of Computing\thanks{This research has been supported by the Australia Research Council Discovery Grant DP1092464 and the iMQRS Grant
from Macquarie University.}\\
Macquarie University, Sydney, Australia \\
\email{\{annabelle.mciver,tahiry.rabehaja\}@mq.edu.au}
\and Department of Computer Science \\
University of Sheffield,
United Kingdom \\
\email{g.struth@dcs.shef.ac.uk}
}

\makeatletter
\newtheorem{rep@theorem}{\rep@title}
\newcommand{\newreptheorem}[2]{\newenvironment{rep#1}[1]{\def\rep@title{#2 \ref{##1}}\begin{rep@theorem}}{\end{rep@theorem}}}
\makeatother

\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{xy}
\xyoption{all}

\newcommand{\pBES}{\mathbf{pBES}}


\newcommand{\BES}{\mathbf{BES}}
\newcommand{\C}{\mathcal{C}}
\renewcommand{\L}{\mathcal{L}}
\newcommand{\D}{\mathbb{D}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\TT}{\mathcal{T}}
\newcommand{\EE}{\mathcal{E}}
\newcommand{\FF}{\mathcal{F}}
\newcommand{\G}{\mathcal{G}}
\newcommand{\PP}{\mathcal{P}}
\newcommand{\cfl}{\mathbf{cfl}}
\newcommand{\refby}{\sqsubseteq}
\newcommand{\prefix}{\trianglelefteq}
\newcommand{\init}{\mathbf{in}}
\newcommand{\<}{\langle}
\renewcommand{\>}{\rangle}
\newcommand{\cl}[1]{\langle #1\rangle}
\newcommand{\pc}[1]{{\ \oplus_{\!#1}\ }}
\newcommand{\supp}{\mathrm{supp}}
\newcommand{\PBES}{\mathbf{pBES}}
\newcommand{\ov}[1]{\overline{#1}}
\newcommand{\liftprefix}[2]{{#1}\ \!\overline{\prefix}^*#2}
\newcommand{\liftprefixt}[2]{{#1}\ \!\overline{\prefix}^*_\tau#2}

\newcommand{\exit}{\Phi}



\begin{document}
\maketitle
\begin{abstract}
We give a new true-concurrent model for probabilistic concurrent Kleene algebra. The model is based on probabilistic event structures, which combines ideas from Katoen's work on probabilistic concurrency and Varacca's probabilistic prime event structures. The event structures are compared with a true-concurrent version of Segala's probabilistic simulation. Finally, the algebraic properties of the model are summarised to the extent that they can be used to derive techniques such as probabilistic rely/guarantee inference rules.
\end{abstract}

\section{Introduction}

The use of probability in concurrent systems has provided solutions to many problems where non-probabilistic techniques would fail~\cite{Rab76}. However, the combination of probability and concurrency increases the complexity of any formal tool powerful enough to ensure the correctness of a system involving both features. It is then imperative that such a framework should be as simple as possible and the use of algebras in formal verifications is indeed a step in that direction. In this paper, we follow an algebraic approach in the style of Hoare et al's concurrent Kleene algebra (CKA) that is sound under a true-concurrent interpretation~\cite{Hoa09}. The algebraic laws model the interactions between probability, nondeterminism, concurrency and finite iteration operators. The structure produces an algebra which is an important mathematical tool for carrying out complex verification tasks and can be used to give robust proofs of concurrent systems, and in particular for verification techniques such as Jonesâ€™ rely/guarantee rules~\cite{Hoa09,Jon12}. 

We have previously developed an interleaving model for probabilistic concurrent Kleene algebra (pCKA) that aims to combine probability and concurrency in a single algebraic setting~\cite{Rab13}.  Starting from the same set of axioms, we present a novel true-concurrent model based on bundle event structures (BES)~\cite{Kat96,Lan92}. Our motivation is that the concurrency operator of event structures provides a more faithful interpretation of concurrency found in physical systems. In contrast, the parallel composition of automata fails to capture some fundamental properties such as refinement of actions~\cite{Gor97}. Indeed, we show that our semantics distinguishes processes that are equal in the interleaving case. Event structures were introduced by Winskel~\cite{Win86} and have been studied extensively by others~\cite{Kat96,Lan92,Gla03,Gla09}, refined to bundle event structures by Langerak~\cite{Lan92} and extended to account for probabilistic specifications by Katoen~\cite{Kat96}. Katoen concentrated on event structures for probabilistic process algebras but did not provide the framework needed to compare different event structures. In contrast, Varacca studied the semantics of probabilistic prime event structures (pPES) using valuations on the set of configurations~\cite{Var03}. It is well known that prime event structures are not rich enough to express  the right factorisation of sequential composition through nondeterminism. Our true-concurrent model for pCKA requires a bundle event structure framework extended with  probabilistic simulations over the ``configuration-trees".

Our main contribution is the development of a new model for pCKA endowed with a true-concurrent version of Segala's probabilistic simulation~\cite{Seg95}. To the best of our knowledge, this is the first extension of probabilistic  simulation to the true-concurrent setting though non probabilistic versions do exist in the literature~\cite{Che92,Maj98}. We also define an adequate weakening of Katoen's techniques for pBES so that they reduce to Varacca's definitions for PES.

The paper is organised as follows. In Section~\ref{background}, we provide the necessary background for bundle event structures. The algebraic operators are defined in Section~\ref{operations} where a particular care is needed for the construction of the binary Kleene star. Without probability, we argue that bundle event structures endowed with these operators and quotiented with the pomset language equivalence forms a concrete model for CKA. In Section~\ref{pBES}, we set out the necessary tools for constructing pBES. In Section~\ref{simulation}, we define the notion of probabilistic simulation on pBES. Section~\ref{pcka} is devoted to showing that the set of pBES endowed with the defined algebraic operators modulo probabilistic simulation satisfies the axioms of pCKA. All incomplete proofs are given in full in the appendix.


\section{Bundle Event Structures}\label{background}

Event structures provide a truly concurrent denotation for processes where an event is labelled by an action from a set . An event  may enable another event , that is,  cannot happen unless  has already happened. This relation, denoted by , is useful for sequential dependency. It is also possible that two events cannot happen simultaneously in a single run which usually occurs when there is a nondeterministic choice of events. This second relation is denoted by  and is extended to sets of events  such that  iff for all  and , if  then . Formally, we have the following definition.
\begin{definition}[\cite{Lan92}]\label{def:bes}
A bundle event structure  is a tuple  such that  is a set of events,  is an irreflexive and symmetric binary relation (the conflict relation),  is called a bundle relation where 

 is a labelling (partial) function and  is a set of events such that . Elements of  are called final events and  is the powerset of .
\end{definition}

In the bundle ,  is referred to as a bundle set and the event  is pointed by . Since  holds for every  such that , it follows that exactly one event in  must enable  and such a unique event is required for each bundle set pointing to  before it can happen. Given a set of events , we denote by  the set of events that are in conflict with some event in . A set  is called \textit{conflict free} if . Unlabelled events happen without any noticeable internal nor external observable outputs. They are only used as ``delimiters".

A (finite) sequence of events  from  is called an \emph{event trace} if for every  and every bundle relation , there exists  such that  and .

\begin{definition}[\cite{Lan92}]\label{def:configuration}
A configuration is a subset  such that  for 
some event trace  referred to as a linearisation of . The set of all configurations (reps. traces) of  is denoted by  (resp. ).
\end{definition}

In the sequel we will need to describe the causal dependencies between events in more detail. To do this we associate a partial order with each configuration. 

A \emph{labelled partial order} (lposet) is a tuple  where  is a poset and . Unlabelled events of a lposet  can be removed to obtain the sub-lposet  
such that  and where  and  are the respective restrictions of  and  to the set . 
A lposet  \textit{implements} another lposet  if there exists a label-preserving monotonic bijection  and we write  or simply  if no confusion arises ( stands for subsumption~\cite{Gis88}). 


Given an event trace  of a BES , we denote by  the reflexive transitive closure of the order   of events in that sequence i.e. . The tuple  is a lposet. Let . We generate a lposet  where  and  is restricted to . Intuitively, two events are incomparable iff neither has to happen before the other. 


The set of lposets of   is denoted , that is, . Given two bundle event structures  and , it is well known that  iff  iff ~\cite{Kat96,Lan92}. We say that  is a \emph{prefix} of , written , if  and  and . The next proposition shows that configurations inclusion characterises prefixing.

\begin{proposition}\label{pro:configuration-prefix}
Let  be a BES. If  and  then .
\end{proposition}

\section{Basic Operations on Bundle Event Structures}\label{operations}

A concurrent quantale is a particular kind of concurrent Kleene  algebra~\cite{Hoa09}. It is composed of two quantales that interact via the interchange law~(\ref{eq:interchange-law}). In this section, we show that the set   of bundle event structures endowed with the following operators and partial order forms a concurrent quantale.  This model is extended to capture probability in Section~\ref{pBES}. 
\subsubsection*{Basic BES:} we start by defining the basic BES corresponding to Deadlock, Skip and one step action.
\begin{itemize}
\item Deadlock is denoted by  and is associated with the BES .
\item Skip is denoted by  and is associated with .
\item Each  is associated with , denoted by .
\end{itemize}


We fix two BES   and  such that . This ensures that the disjoint union of two labelling functions is again a function. We define the set  such that  iff there is no  such that . Events in  are called initial events.

\subsubsection*{Concurrency, sequential composition and nondeterminism~\cite{Kat96}} are defined in Fig.~\ref{fig:operators}. The concurrent composition  is the disjoint union of  and  delimited by fresh ineffectual events. Notice there is no synchronisation in , this is because we are mainly interested in lock-free concurrencies in the style of~\cite{Hoa09,Jon12,Jon81,Din02}. A special event can however be introduced to force synchronisation~\cite{Kat96,Gor97} and most of the algebraic laws remain valid. For the sequential composition, new bundles of the form  for every  are added to make sure that all events of  precede all events of . For nondeterminism, the property  is imposed so that the occurrence of any initial event of  will block every events of  from happening (and symmetrically). The choice is resolved as soon as one event from  or  happens.

\begin{figure}[!ht]
\hspace{-2.5mm}\begin{minipage}{.5\linewidth}
\subsubsection{Concurrency} :\\

\begin{itemize}
\item set of events: ,
\item conflicts: ,
\item bundles: ,
\item labelling: ,
\item final events: .
 \end{itemize} 
 where .
\end{minipage}\hspace{5mm}
\begin{minipage}{.5\linewidth}
\subsubsection{Sequential composition}  :\\

\begin{itemize}
\item set of events: ,
\item conflicts: ,
\item bundles: ,
\item labelling : ,
\item final events: .
\end{itemize}
\end{minipage}

\subsubsection{Nondeterminism}  :
\begin{itemize}
\item set of events: ,
\item conflicts: ,
\item bundles: ,
\item labelling: ,
\item final events: .
\end{itemize}
where  is the symmetric closure.
\caption{Definitions of ,  and .}\label{fig:operators}
\end{figure}

\subsubsection{The Kleene star} is defined by constructing a complete partial order on the set of BES. We define the order , which is the sub-BES relation, such that 



We use the following binding precedence: . The probabilistic choice  (defined later) and  are unordered and are parsed using brackets.


\begin{proposition}\label{pro:omega-completeness}
 is an -complete partially ordered set, that is, any countable ascending chain has a least upper bound in .
\end{proposition}

\begin{proof}[Sketch]
The proof that  is a partial order amounts to checking reflexivity, antisymmetry and transitivity which is clear. As for -completeness, given a countable increasing sequence of BES , we construct a BES . We can show that  is indeed the least upper bound w.r.t  of the countable sequence .\qed
\end{proof}

Let  be two BES. The Kleene product of  by , denoted by , is the limit of the -increasing sequence of BES 
where adequate events renaming are needed to ensure that the sequence of BES are syntactically similar (see Fig.~\ref{fig:kleene-series} for a concrete example). Equivalently,  is the least fixed point of  in .
\begin{figure}
\begin{tiny}
\end{tiny}
An arrow  denotes a bundle relation and  is the conflict relation. The events  are labelled by  while the s are labelled by .
\caption{The first three terms in the construction of .}\label{fig:kleene-series}
\end{figure} 
The unary Kleene star is obtained as usual by . The main reason behind the use of the binary Kleene star~\cite{Fok94} is that the unary version introduces unwanted sequential compositions. For instance, in normal Kleene algebras, a while loop with body  is encoded as  where  (resp. ) is the event associated with the guard. Hence by the interchange law~(\ref{eq:interchange-law}),  can behave as  but we would assume that each  and the corresponding  are checked simultaneously. Hence, we interpret a while loop as .

For convenience, we denote each component of the above sequence by , , ,\dots. The following proposition ensures that these operators are well defined.

\begin{proposition}\label{pro:well-defined}
Let  be BES. Then for every   .
\end{proposition}

\begin{proof}
We have  and since , it follows that . The result is clear for the case of  and  because  and  where  is the fresh final event in the construction of . For the Kleene star, we have  (increasing union). Therefore, any pair of events   are mutually conflicting with respect to the conflict relation of . 
\qed
\end{proof}

We end this section by observing that  is a concurrent quantale where the operator  is redefined so that . Following Gischer~\cite{Gis88}, we define an order relation based on pomset language subsumption. Recall that a \emph{pomset} is an equivalence class of lposets w.r.t the equivalence relation generated by . For finite lposets  and , we have  and  iff  is isomorphic to ; hence our definition coincides with Gischer's. The equivalence class of a lposet  is denoted by the totally labelled lposet . The pomset language of a BES  is defined  by 
 
When a BES is considered modulo pomset language equivalence, we show that  and  are quantales, 
i.e., each structure is an idempotent
semiring, a complete lattice
under the natural order  iff  and 
the operator  distributes over arbitrary suprema and infinima. The interchange law~(\ref{eq:interchange-law}) is ensured by the subsumption property. The following proposition essentially follows from Gischer's results~\cite{Gis88}. In fact, Gischer proves that the axioms of CKA without the Kleene star completely axiomatise the pomset language equivalence.

\begin{proposition}\label{pro:cka}
For each , the structure  is a quantale under the pomset language equivalence.
\end{proposition}


\section{Probabilistic Bundle Event Structures}\label{pBES}

In this section, we adapt Katoen's and Varacca's works on probabilistic event structures~\cite{Kat96,Var03}. In particular, we refine the notions of \emph{cluster} and \emph{confusion freeness} which are necessary for the definition of probabilistic bundle event structures (pBES). We use the standard transformation of prime event structures into BES to ensure that our definitions properly generalise Varacca's.

\subsection{Immediate Conflict, Clusters and Confusion Free BES}

The key idea of probabilistic event structures is to use probability as a mechanism to resolve conflicts. However, not all conflicts can be resolved probabilistically~\cite{Kat96}. The cases where this occurs are referred to as confusions. A typical example of confusion is depicted by the first three events  and  of Fig~\ref{fig:example} where ,  and  hold allowing  and  to occur simultaneously in a single configuration. However, if the conflict  is resolved with a coin flip and if the result is , then  cannot be resolved probabilistically because it may produce . Following Varacca~\cite{Var03}, we start by characterising conflicts that may be resolved probabilistically.

\begin{definition}\label{def:immediate-conflict} 
Given a BES , two events  are in immediate conflict if  and there exists a configuration  such that  and  are again configurations. We write  when  and  are in immediate conflict.
\end{definition}

\begin{example}
In the BES of Fig.~\ref{fig:example},  and  are in immediate conflict because  and  are configurations. In fact, every conflicts in that BES are immediate. Notice that the conflict  is resolved  when  occurs. 
\begin{figure}[h!]

In this BES, the bundles are  and . The conflict relation is  and . Therefore,  and  are concurrent. An arrow  represents some part of a bundle (i.e.  is the completed bundle) and  represents a bundle.
\caption{Immediate conflict in a BES.}\label{fig:example}
\end{figure}
\end{example}


Events can be grouped into clusters of events that are pairwise in immediate conflict. More precisely, we define a cluster as follow.
\begin{definition}\label{def:cluster}
A partial cluster is a set of events  satisfying

A cluster is a maximal partial cluster (w.r.t inclusion).
\end{definition}


Given an event , the singleton  is a partial cluster. Therefore, there is always at least one cluster (i.e. maximal) containing  and we write  the intersection of all clusters containing . 

\begin{example}
In Fig.~\ref{fig:example},  and  are clusters and . 
\end{example}

\begin{proposition}
A partial cluster  is maximal (i.e. a cluster) iff

\end{proposition}

\begin{proof}
The forward implication follows from Definition~\ref{def:cluster} and maximality of .
Conversely, assume that  is a partial cluster satisfying the above property. Let  be a partial cluster such that  and . Then, for all ,  and 
 
because  is a partial cluster. By the hypothesis,  and hence .\qed
\end{proof}

As in Katoen's and Varacca's works, clusters are used to carry probability and they can be intuitively seen as providing a choice between events where the chosen event happens instantaneously. Notice that our notion of cluster is weaker than Katoen's original definition~\cite{Kat96}: the BES in Fig.~\ref{fig:not-katoen-cluster} contains three clusters ,  and  and only  satisfies Katoen's definition.\\
\begin{figure}[h!]

\caption{A BES where ,  and  are clusters.}\label{fig:not-katoen-cluster}
\end{figure}

\begin{definition}\label{def:confusion-free}
A BES  is confusion free if for all events , 
\begin{itemize} 
\item if  then , and
\item  if  and  for some configuration , then  for all events .
\end{itemize}
\end{definition}
The first property implies that  contains all events in immediate conflict with  and hence the confusion introduced by  and  in Fig.~\ref{fig:example} is avoided. The second property says that once one event in  is enabled then all events in  are also enabled. 
Hence, confusion freeness ensures that all conflicts in  can be resolved probabilistically regardless of the history. The proof of the following proposition is the same as for prime event structures~\cite{Var03}.

\begin{proposition}\label{pro:confusion-free-theorem}
For a confusion free BES , the set  defines a partition of . That is, the reflexive closure of  is an equivalence relation and the equivalence classes are of the form .
\end{proposition}

The second property of Definition~\ref{def:confusion-free} is usually hard to check. We give a static and simpler sufficient condition for confusion freeness.
\begin{proposition}\label{pro:confusion-free-simpler}
If a BES  satisfies 

then it is confusion free.
\end{proposition}

The second argument of the conjunction says that if some event in  is in conflict with an event  then all events in  are in conflict with .

\begin{proof}
Let  and  such that  and . Let  and  be a bundle of . We need to show that . By Definition~\ref{def:cluster},  is also a bundle and since  and  are configurations,  is again a linearisation of  for every linearisation   of . Therefore, . If  for some , then  by the hypothesis and hence , which is impossible because  is a configuration. Hence  is an event trace, that is, .\qed
\end{proof}

\begin{example}
Fig.~\ref{fig:not-katoen-cluster} depicts a confusion free BES that satisfies Proposition~\ref{pro:confusion-free-simpler}.
\end{example}

With confusion freeness, we are now able to define probability distributions supported by clusters. Recall that a probability distribution on the set  is a function  such that . We say that  is a \textit{probability distribution on } if  for some event .

\begin{definition}
A probabilistic BES is a tuple  where  is a confusion free BES and  is a set of probability distribution on  such that for every , there exists  such that .
\end{definition}

The intuition behind this definition is simple: if there is no  such that  then  is an impossible event and  it can be removed (this may affect any event  such that  for some ). Our approach differs from both Varacca's~\cite{Var03} and Katoen's~\cite{Kat96} in that nondeterminism is modelled concretely as a set of probabilistic choices. This approach will mainly contribute to the definition of the probabilistic choice operator  of Section~\ref{pcka}. For instance, the expression  does not have any meaning in Katoen's pBES, however, it will have a precise semantics in our case.


\section{Probabilistic Simulation on pBES}\label{simulation}

The weakest interpretation of  on pBES is the configuration distribution equivalence~\cite{Var03}. However, as in the interleaving case, that is not a congruence~\cite{Seg95}. We use probabilistic simulations which are based on the notion of lifting from~\cite{Den07a}. We denote by  the set of (discrete) probability distributions over the set . Given , we denote by  the point distribution concentrated at .

Let  be a relation. The lifting of  is a relation  such that  iff
\begin{itemize}
\item  where ,
\item for every , there exists  such that ,
\item .
\end{itemize}

Notice that the decomposition of  may not be unique. The main properties of lifting are summarised in the following proposition.

\begin{proposition}[\cite{Den07a}]\label{pro:lifting} 
Let  be a relation and . We have
\begin{itemize}
\item if  then ,
\item if  then there exists a collection of distributions   such that  and  .
\end{itemize}
\end{proposition}

Since the notion of configuration for a pBES  is independent of , we keep the notation  for the set of all finite configurations. An example of relation on  is given by the probabilistic prefixing. We say that  is a \textit{prefix} of , denoted (again) by , if there exists  such that  and . In particular, if ,  and  then .  

The relation  is lifted to  and the reflexive transitive closure of the lifted relation is denoted by . Probabilistic prefixing allows us to construct a \emph{configuration-tree} for every pBES. An example is depicted in Fig.~\ref{fig:configuration-tree}.
\begin{figure}[!ht]
\begin{tiny}

\end{tiny}
The dotted arrows with common source are parts of a probabilistic prefix relation (e.g. ). The events  are the delimiters introduced by .
\caption{The configurations-tree of the pBES  ( is defined later).}\label{fig:configuration-tree}
\end{figure}

To simplify the presentation, we restrict ourselves to BES satisfying  for every bundle , that is, no event is enabled by a final event. This allows a simpler presentation of the preservation of final events by a simulation. Notice that all BES constructed from the operators defined in this paper satisfy that property (details can be found in the appendix).

\begin{definition}\label{def:simulation}
A (probabilistic) simulation from  to  is a relation  such that
\begin{itemize}
\item ,
\item if  then for every , ,
\item if  and  then there exists  such that  and .
\item if  and  then for every  we have .
\end{itemize}
We write  if there is a simulation from  to .
\end{definition}
Indeed, Definition~\ref{def:simulation} is akin to probabilistic forward simulation on automata. The main difference is the use of the implementation relation  which holds iff there exists a label preserving monotonic bijection from  to . The implementation relation compares partially ordered configurations rather than totally ordered traces, hence, interferences between incomparable or concurrent events are allowed. Another consequence of this definition is that concurrent events can be linearised while preserving simulation.

\begin{proposition}\label{pro:preorder}
 is a preorder.
\end{proposition}

The proof is the same as in~\cite{Den07a}, hence, we provide only a sketch.

\begin{proof}[Sketch]
Reflexivity is clear by considering the relation  which is indeed a simulation. If  are probabilistic simulations from  to  and  to  respectively then we can show, using Proposition~\ref{pro:lifting} and a similar proof as in the interleaving case, that  is a probabilistic simulation from  to .\qed 
\end{proof}

A major difference from our previous work~\cite{Rab13} is that the event structure approach provides a truly concurrent interpretation of pCKA. The most notable benefit of using a true-concurrent model is substitution~\cite{Gor97,Gis88} where a single step event can be refined with another event structure after a concurrency operator has been applied. In the automata model, such a substitution must occur before the application of the concurrency operator to obtain the correct behaviour. Moreover, in interleaving, concurrency is related to the nondeterministic choice whereas here the two operators are orthogonal. 
\begin{example}
In Fig.~\ref{fig:concurrency}, it is shown that  but the converse does not hold. 
\end{example}
\begin{figure}[!ht]
\begin{tiny}

\end{tiny}
Since  nor , it is impossible to find a simulation from  to . In the configuration tree on the left, the order  is made explicit and primes are introduced for disjointness.
\caption{A simulation from  to . }\label{fig:concurrency}
\end{figure}

\section{Probabilistic Concurrent Kleene Algebra}\label{pcka}

In this section, we show that the set   endowed with a nondeterministic choice , a probabilistic choice , a sequential composition , a concurrent composition  and the binary Kleene star  satisfy the axioms of Fig.~\ref{fig:axioms}. These axioms are a combination of the basic algebraic laws of CKA~\cite{Hoa09} and pKA~\cite{Mci05}. 
\begin{figure}
\hspace{-1cm}\begin{minipage}{.5\linewidth}

\end{minipage}
\begin{minipage}{.57\linewidth}

\end{minipage}

\hspace{-1cm}\begin{minipage}{.5\linewidth}

\end{minipage}
\begin{minipage}{.57\linewidth}

\end{minipage}

\hspace{-1cm}\begin{minipage}{.5\linewidth}

\end{minipage}
\begin{minipage}{.57\linewidth}

\end{minipage}



\caption{Axioms of pCKA satisfied by  modulo probabilistic simulation. Here, we write a pBES simply with  instead of the tuple  and  in Equation~(\ref{eq:pc-assoc}) (the case  being a simplification of the left hand side).}\label{fig:axioms}
\end{figure}

We generate the pBES  and  from the basic BES. To simplify the notations, these basic  pBES are again denoted by  and . The other operators are defined as follows:

where  and  are the fresh events delimiting . Recall that  and  are assumed to be disjoint in these definitions. The probabilistic choice that chooses  with probability  and  with probability  is

where  iff:
\begin{itemize}
\item if  then  for some  and ,
\item else .
\end{itemize}

Intuitively, nondeterminism is resolved first by choosing a probability distribution, then a probabilistic choice is resolved based on that distribution. Indeed, the nondeterministic and probabilisic choices introduce clusters.  
\begin{example}
The BES  contains four clusters  and  where  are the delimiter events. It has a set of probability distributions . In contrast, the event structure  has a single cluster  with set of probability distributions .
\end{example}

To construct the binary Kleene star, we need the following partial order 

The proof that  is indeed -complete is essentially the same as in the standard case (Section~\ref{operations}). Hence the Kleene product  is again the limit of the increasing sequence of pBES:

More precisely,  where  and each set  is obtained from the construction of .

A BES is \textit{regular} if it is inductively defined with the operators of Section~\ref{operations}. 

\begin{proposition}\label{pro:confusion-free-regular}
A Regular BES is confusion free.
\end{proposition}

\begin{proof}[Sketch]
By induction on the structure of the BES.
\end{proof}

\begin{proposition}\label{pro:precongruence}
The order  is a precongruence i.e. for every pBES  and , if  then  (and symmetrically) for every . 
\end{proposition}

\begin{proof}[Sketch]
Let  be witnessed by a simulation  and  be any pBES. The congruence properties are proven by extending the simulation  to the events of . For instance, That  is deduced by showing that  is indeed a simulation. 

\qed
\end{proof}


The axioms~(\ref{eq:+-idem}-\ref{eq:seq-zero}) and~(\ref{eq:par-comm}-\ref{eq:+-dist-seq}) are proven using simulations akin to the interleaving case~\cite{Rab13,Den07a}. The existence of simulations that establishes axiom~(\ref{eq:par-unit})  is clear from the definition of  and . It follows from the axioms of  and Proposition~\ref{pro:precongruence} that  if and only if .

\begin{proposition}\label{pro:subdistributivity}
The axioms~(\ref{eq:+-subdist-seq},\ref{eq:pc-supdist-seq}) and (\ref{eq:+-subdist-par},\ref{eq:pc-supdist-par}) and the interchange law~(\ref{eq:interchange-law}) hold on  modulo probabilistic simulation.
\end{proposition}

\begin{proof}[Sketch]
These equations are proven by the usual simulation constructions.
\qed
\end{proof}

\begin{proposition}\label{pro:kleene-star}
The binary Kleene star satisfies the axioms~(\ref{eq:unfold}) and~(\ref{eq:induction}).
\end{proposition}
\begin{proof}[Sketch]
The first equation is proven using the standard simulation construction. For the second one, let  be a probabilistic simulation from  to . By monotonicity of  and , there exists a simulation  from  to , for every . Moreover, we can find a family of simulations such that  is the restriction of  to . Thus, we can consider the reunion  and show that it is indeed a simulation from  to . Hence, Equation~(\ref{eq:induction}) holds.\qed
\end{proof}

\begin{theorem}
The set  modulo probabilistic simulation forms a probabilistic concurrent Kleene algebra with a binary Kleene star.
\end{theorem}

\section{Conclusion}

We have constructed a truly concurrent model for probabilistic concurrent Kleene algebra using pBES. In the process, we also set out a notion of probabilistic simulation for these event structures. The semantics of pBES was defined by constructing the configuration-trees using prefixing and probabilistic simulations are exhibited when possible. Since the simulation distinguishes between concurrency and interleaving, we believe that it provides a suitable combination of nondeterminism, probability and true-concurrency.

Our main result is the soundness of pCKA axioms. The completeness of such an axiom system is still open. We believe that other axioms such as guarded tail recursion are needed to achieve a complete characterisation as in~\cite{Seg04}. Another interesting specialisation of this work is the labelling of events with one-step probabilistic programs. These however require further studies.

\bibliographystyle{splncs}
\bibliography{lpar19-paper69}

\newpage
\clearpage{}\section*{Appendix}

\renewenvironment{theorem}[2][Theorem]{\begin{trivlist}
\item[\hskip \labelsep {\bfseries #1}\hskip \labelsep {\bfseries #2}]}{\end{trivlist}}
\newenvironment{repproposition}[2][Proposition]{\begin{trivlist}
\item[\hskip \labelsep {\bfseries #1}\hskip \labelsep {\bfseries #2}]}{\end{trivlist}}

In this appendix, we denote event traces simply by the Greek letters  and  is the set of events occurring in the event trace . 

\subsection{Proof Complement for Proposition~\ref{pro:configuration-prefix}}



\begin{lemma}\label{pro:trace-restriction}
Let  and  such that , then the restriction  of  to events in  is an event trace.
\end{lemma}

\begin{proof}
Let ,  and . Let  and  be a bundle of . Since  is an event trace, there exists a even  such that  and . Since  is a configuration and , there exists  and . By definition, the bundle set  contains mutually conflicting events only and since  is conflict free, . Hence,  is an event trace.  \qed
\end{proof}

\begin{lemma}\label{pro:trace-extension}
Let  and  such that , for every trace event  such that  there exists a trace event  such that  and .
\end{lemma}

\begin{proof}
Let  be any event traces such that ,  and . Let  bet the concatenation of two sequences  where events in  are exactly those of  ordered with  and  is composed of events from  ordered again with . We now show that  is an event trace. That  is conflict free comes from the configuration . Let  be a bundle of  such that . Since  is a configuration,  and that element has to be ordered before  with respect to  because  contains mutually conflicting events so  contains exactly one event. That is,  is an event trace. As for , let  be a bundle and . Since  is a configuration, we have  and the sole event in that intersection is ordered before  in the event trace  because . Hence  is an event trace. 

Finally, let . With the same argument as before, we can show that  is an event trace and hence .\qed
\end{proof}

\begin{repproposition}{\ref{pro:configuration-prefix}.}
Let  be a BES, if ,  and  then .
\end{repproposition}

\begin{proof}
Let . Let us first show that . Let  such that  . Lemma~\ref{pro:trace-restriction} implies that  because every event trace for  restricts to an event trace for . For the converse inclusion, let  such that . Lemma~\ref{pro:trace-extension} implies that every event trace for  can be obtained as a restriction of some event trace for . Hence, . Therefore .

Let ,  and . It now suffices to show that . In fact, if , then there exists an event trace  as specified in the proof of Lemma~\ref{pro:trace-extension}, that is, ,  and . Therefore,  which contradict the fact that . \qed
\end{proof}

\subsection{Proof Complement for Proposition~\ref{pro:omega-completeness} and Properties of }

\begin{repproposition}{\ref{pro:omega-completeness}}
 is an -complete partially ordered set.
\end{repproposition}

\begin{proof}
Firstly, we prove that  is a partial order. It is clear that  is reflexive. To prove antisymmetry, Let  and , then . Let  is a bundle of . Since , we have  and hence  and  i.e. it is also a bundle of . The fact that  and  (resp.  and ) coincide follows directly from the definition. To prove transitivity, let  and . We need to prove that . It is clear that . Let   be a bundle of  and . Since , we have  and since , we obtain  and  is a bundle of . Since  and , we have  and  is a bundle of . The properties  and  and  follows from similar argument. Hence .

Secondly, let  be a countable increasing chain of BES and let  endowed with the following components:
\begin{itemize}
\item set of events: ,
\item conflict relation: ,
\item bundle relation: ,
\item labelling function: ,
\item final events: .
\end{itemize}
We show that  for all  and if  for all  then .

Let , we have  by construction. Let . Since , there exists  such that . There are two cases:
\begin{itemize}
\item if , then  and ,
\item if , then  and hence  i.e. .
\end{itemize}
A similar argument can be used to prove ,  and the relationship between bundles of  and .

Finally, let  for all . We need to show that . It is clear that  where  is the set of events of . 
\begin{itemize}
\item Let . By definition of , there exists  such that  and . Assume that , then . Since , we have  and hence . 
\item A similar argument can be used to prove  and .
\item It is clear that . Let  be a bundle of  and . There exists  such that  and since , we deduce that  and  is a bundle of . Hence,  is a bundle of .\qed
\end{itemize}
\end{proof}

\begin{proposition}\label{pro:prefix-trace}
Let  be two BES such that , then .
\end{proposition}

\begin{proof}
Let  such that  and let us show that . Let us write . By definition of an event trace, we have  for every bundle  in  and since  we also have  for every bundle  in . On the other hand, since  and  is an event trace of , we have  and therefore, .

Conversely, let , we need to show that . Let  be a bundle of  where . Since  and , we have  is a bundle of  and therefore . Moreover, since  and , we deduce that . Lastly, that  follows directly from the fact that  is an event trace. Hence, .\qed
\end{proof}

\begin{corollary}\label{cor:prefix-refinement}
if  then  and .
\end{corollary}

\begin{corollary}\label{cor:limit-lposet}
If  is a increasing family of BES with limit  then .
\end{corollary}

\begin{proof}
It is clear from Corollary~\ref{cor:prefix-refinement} that  and hence .

Conversely, let . By definition,  where . By construction, the set of events of  is  where each  is the set of events of the BES . Since  is a finite subset of  and , there exists  such that  and hence  follows from Proposition~\ref{pro:prefix-trace} (that is, the order  obtained from the BES  coincides with the order obtained from the BES ). \qed
\end{proof}

\subsection{Correspondence between our work, Varacca's and Katoen's}

In this subsection, given a PES  we denote by  and .

\begin{proposition}\label{pro:immediate-conflict}
Given an PES  and its corresponding BES , then for every ,  in  iff  in .
\end{proposition}

\begin{proof}
Let , then  and  are configurations. Since  and  are respectively maximal in these two configurations, we have  which satisfies Definition~\ref{def:immediate-conflict}.

Conversely, assume that  and . By definition of ,  and . Therefore,  is down-closed and does not contain any conflicting elements. Since ,  is not in conflict with any element of  and hence . Similarly, we prove that . \qed
\end{proof}

\begin{proposition}
A cluster in the sense of Katoen~\cite{Kat96} satisfies Definition~\ref{def:cluster}.
\end{proposition}

\begin{proof}
Let  be a cluster in the sense of Katoen's~\cite{Kat96} and . Let  be a configuration such that  is a configuration. Then for every bundle , we have  because  iff . Moreover,  else that elements should be in the cluster  and hence conflicting with event  too (this is impossible because  is a configuration). Therefore,  is a configuration and . 

The second property of partial clusters (events of a clusters are equally pointed) is found in Katoen's definition and it suffices to prove that  is maximal. Let  be a partial cluster such that  and . By definition of a partial cluster,  for every . Since  implies , we deduce that  because Katoen's cluster contains every event that is conflicting with all events in it.\qed
\end{proof}




\begin{proposition}\label{pro:cluster-cell}
Definition~\ref{def:cluster} coincides with Varacca's partial cells on PES~\cite{Var03}. In particular, a cluster corresponds to a cell on PES.
\end{proposition}

\begin{proof}
Let  be a PES and  its corresponding BES. 

Let  be a cluster of  as per Definition~\ref{def:cluster} and . We show that  is a cell. It follows directly from the definition of transformation that that  and . 

Conversely, let  be a cell of  and . It contains mutually immediate conflicting events by definition of a cell. Since, , we deduce that  implies  for every . \qed
\end{proof}

Remind that a PES is confusion free if and only if  is transitive and  implies .

\begin{proposition}
A PES is confusion free iff its corresponding BES is confusion free as per Definition~\ref{def:confusion-free}.
\end{proposition}

\begin{proof}
Let  be a PES and  its corresponding BES. 

Assume that  is a confusion free PES and  such that . Let  be a cluster such that . By definition of a confusion free PES,  implies  i.e.  and  are pointed by the same bundles. By transitivity of ,  for every  and therefore  by maximality of . Since that is true for every cluster containing , we have .

We now prove the property of Proposition~\ref{pro:confusion-free-simpler}. Let  such that . Since , there exists  such that  and  and . If  then  because the BES is confusion free (and hence  and  are pointed by the same bundle). Hence  by heredity of . Else if , then  because  is transitive. It follows that  by heredity of . 

Conversely, assume that  is a confusion free BES and  such that  and . The first property of confusion freeness implies that  and , that is,  and . Therefore,  holds in the PES  and whenever  holds in the BES , we have  i.e.  is confusion free.\qed
\end{proof}

\subsection{Complementary Proofs of the Algebraic Laws}

\begin{proposition}\label{pro:exit-maximal}
Let  be a regular BES. If a configuration  contains a final event i.e.  then it is maximal. 
\end{proposition}

\begin{proof}
We reason by structural induction. The claim holds for the basic BES. Let  be two BES satisfying the induction hypothesis. 

The case of  is clear because . 

For , let  and assume that  contains an exit event. Since all events in  occurs before any event of , we have  (Proposition~\ref{pro:prefix-trace}). Moreover, we show similarly that   and is maximal by induction hypothesis. Since  must at least contain one event from ,  necessarily contain an event from  and hence  is also maximal in . Therefore,  must be maximal in . 

For , let  and   be the fresh events introduced by the construction of . Here again, we have  and  and since  and  and , by induction hypothesis,  and  are maximal in  and  respectively and we deduce the maximality of .

For , if  then  for some  and we are back to the case of  and . \qed
\end{proof}

\begin{corollary}\label{pro:seq-maximal}
Let  be two regular BES, if  and  then  is maximal in .
\end{corollary}

\begin{repproposition}{\ref{pro:confusion-free-regular}}
Every regular BES is confusion free.
\end{repproposition}

\begin{proof}
We reason by structural induction on the structure of . It is clear that the basic BES are confusion free and the first property of confusion freeness follows directly from the fact that two events of , for  , are in immediate conflict if an only if they are in immediate conflict in  or ; or both belongs to  and we have  for every regular BES (resp. they are in immediate conflict in  for some ). Let us concentrate on the second property. Let  and  such that . Let .
\begin{itemize}
\item case : if  (or ) the we are done by induction hypothesis. Otherwise,  and we are done because .
\item case : then either  and  or  for some  and  and . The result follow by induction hypothesis.
\item case : we have  for some ,  and . If  then  and the result follows by induction hypothesis. Similarly for . If  then the result is trivial because  i.e. .
\item case : by construction, there exists  such that  is an event of . Since  is a configuration,  is necessary a configuration of (Corollary~\ref{pro:seq-maximal}). The result follows from the previous cases of  and  and the induction hypothesis.\qed
\end{itemize}
\end{proof}

\begin{repproposition}{\ref{pro:precongruence}.}
 is a precongruence i.e. for every pBES  and , if  then  (and symmetrically) for every .
\end{repproposition}

\begin{proof}
The case of  is clear. For , Let  be witnessed by a simulation  and  be any pBES. We construct a relation  such that  iff  and  where ,  and  and  are the delimiters introduced by . Let us show that  is indeed a simulation.

\begin{itemize}
\item That  is clear.
\item Let  such that  and . Since , we have  for every . Therefore,  for every .
\item Let  such that  and . Let us write . Assume that  in , then either the prefix relation is obtained from  or .
\begin{itemize}
\item If the step is made in  then 
 for some . In particular,  in  and since , there exists  such that  and . By definition of lifting, there exists , for each , such that  and . If  then we consider . By definition of , we have  for every  and Proposition~\ref{pro:lifting} implies that  and it is clear that .

\item If the step is made in  then  for some . As before, 
 and therefore  and  can be deduced using Proposition~\ref{pro:lifting}.
\end{itemize}
\item It is obvious that  preserves configuration final events.
\end{itemize}
The same simulation  can be used to prove monotonicity of  because . The only difference when .

For , we use Proposition~\ref{pro:kleene-star} (which is proved by direct simulation construction) and monotonicity of the other operators. Let , we remove the local probability for simplicity. Since , monotonicity of sequential composition implies . But , therefore we have  and by Axiom~(\ref{eq:induction}), we have .  The symmetric inequality follows from the left monotonicity of (). \qed
\end{proof}

\begin{repproposition}{\ref{pro:subdistributivity}}
The subdistributivity laws~(\ref{eq:+-subdist-seq},\ref{eq:pc-supdist-seq}) and (\ref{eq:+-subdist-par},\ref{eq:pc-supdist-par}) and the interchange law~(\ref{eq:interchange-law}) hold for regular pBES modulo probabilistic simulation.
\end{repproposition}

\begin{proof}
We give the complete proof for Equation~(\ref{eq:pc-supdist-par}) (Equation~(\ref{eq:pc-supdist-seq}) in a similar fashion) and~(\ref{eq:interchange-law}). Two copies of  are made for the distributed expression and the fresh events introduced by each  are respectively denoted by . We construct a relation 
 such that  if one of the following cases hold:
\begin{itemize}
\item  and ,
\item  such that  and ,
\item  such that  and ,
\end{itemize}
where  (resp. for ). We show that  is indeed a probabilistic simulation.
\begin{itemize}
\item It is clear that  because  and .
\item Let , in all three cases, we have  for all .
\item Let  and . By definition of ,  and , there are four cases.
\begin{itemize}
\item : since  for all , we have . Therefore,  and therefore   (the copies of ). Therefore, Proposition~\ref{pro:lifting} implies that  and .
\item : this implies that  then the result is clear. 
\item : as above.
\item  by definition of . By definition of ,  and since  is a configuration for every  (reps. for ), we have  and  by Definition of lifting.
\end{itemize}
\item Since the final events are respectively  and  for the left and right hand side, it is clear that  satisfies the last property of a simulation.
\end{itemize}
For Equation~(\ref{eq:interchange-law}), let us write  and  the respective events introduced as delimiters in  and . The delimiters of  are . We consider the relation  such that  iff . It then follows easily that the probabilistic relation  iff  is indeed a simulation.
\end{proof}

\begin{repproposition}{\ref{pro:kleene-star}}
The Kleene star satisfies equation~(\ref{eq:unfold}) and the equational  implication~(\ref{eq:induction}).
\end{repproposition}
\begin{proof}
Let  be a probabilistic simulation from  to . Again, we will leave the set of distributions  and  implicit in this proof. By hypothesis,  and ,   and simple induction shows that  and we denote such simulation by . Moreover, since , we can find a family of simulations such that  is the restriction of  to . Therefore, we consider the reunion  and show that it is indeed a simulation from  to .
\begin{itemize}
\item It is clear that .
\item Let . Since  and every  configurations in  are finite configurations,  for some  and we deduce that .
\item Let  and . Let  be some integer such that . There are two cases:
\begin{itemize}
\item if  then we are done because  is a probabilistic simulation.
\item if  then we have  because  is the restriction of  and we are done because  is a simulation. 
\end{itemize}
\item Let  and . Since  is a finite set,  for some  and the result follows form .\qed
\end{itemize}
\end{proof}
\clearpage{}

\end{document}