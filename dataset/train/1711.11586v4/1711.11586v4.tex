\documentclass{article}

\PassOptionsToPackage{sort&compress,numbers}{natbib}




\usepackage[final]{nips_2017}

\usepackage[utf8]{inputenc} \usepackage[T1]{fontenc}    \usepackage{hyperref}       \usepackage{url}            \usepackage{booktabs}       \usepackage{amsfonts}       \usepackage{nicefrac}       \usepackage{microtype}      \usepackage[pdftex]{graphicx}
\usepackage{dsfont}
\usepackage{subcaption}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{xspace}
\usepackage{enumitem}



\usepackage{color}
\definecolor{darkred}{RGB}{180,50,20}
\definecolor{darkgreen}{RGB}{20,180,50}
\definecolor{purple}{RGB}{90,20,90}
\definecolor{fr}{RGB}{60,125,161}
\newcommand{\ow}[1] {\emph{\textcolor{darkred}{OW: #1}}}
\newcommand{\es}[1] {\emph{\textcolor{darkgreen}{ES: #1}}}
\newcommand{\td}[1] {\emph{\textcolor{purple}{TD: #1}}}
\newcommand{\deepak}[1] {\emph{\textcolor{darkred}{DP: #1}}}
\newcommand{\rz}[1] {\emph{\textcolor{fr}{rz: #1}}}



\newcommand{\pp}{\texttt{pix2pix}\xspace}
\newcommand{\ppn}{\texttt{pix2pix+noise}\xspace}
\newcommand{\cinfogan}{\texttt{cLR-GAN}\xspace}
\newcommand{\cae}{\texttt{cAE-GAN}\xspace}
\newcommand{\cvaegan}{\texttt{cVAE-GAN}\xspace}
\newcommand{\cvaeganp}{\texttt{cVAE-GAN++}\xspace}
\newcommand{\bicycle}{\texttt{BicycleGAN}\xspace} \newcommand{\G}{G\xspace}
\newcommand{\D}{D\xspace}
\newcommand{\E}{E\xspace}
\newcommand{\A}{\mathbf{A}\xspace}
\newcommand{\B}{\mathbf{B}\xspace}
\newcommand{\Bh}{\widehat{\mathbf{B}}\xspace}
\newcommand{\z}{\mathbf{z}\xspace}
\newcommand{\zh}{\widehat{\mathbf{z}}\xspace}
\newif\ifsubmit
\submitfalse

\ifsubmit
\newcommand{\jy}[1]{}
\newcommand{\revjy}[1]{}
\else
\newcommand{\jy}[1]{\textcolor{blue}{JY: #1}}
\newcommand{\revjy}[1]{\textcolor{blue}{#1}}
\fi







\title{Toward Multimodal Image-to-Image Translation}





\author{
  Jun-Yan Zhu\\
  UC Berkeley\\
\And
  Richard Zhang\\
  UC Berkeley\\
  \And
  Deepak Pathak\\
  UC Berkeley\\
  \AND
  Trevor Darrell\\
  UC Berkeley\\
  \And
    Alexei A. Efros\\
    UC Berkeley\\
\And
  Oliver Wang\\
  Adobe Research\\
  \And
  Eli Shechtman\\
  Adobe Research\\
}


\begin{document}


\maketitle

\begin{abstract}
Many image-to-image translation problems are ambiguous, as a single input image may correspond to multiple possible outputs. In this work, we aim to model a \emph{distribution} of possible outputs in a conditional generative modeling setting.
The ambiguity of the mapping is distilled in a low-dimensional latent vector, which can be randomly sampled at test time.
A generator learns to map the given input, combined with this latent code, to the output.
We explicitly encourage the connection between output and the latent code to be invertible. This helps prevent a many-to-one mapping from the latent code to the output during training, also known as the problem of mode collapse, and produces more diverse results.
We explore several variants of this approach by employing different training objectives, network architectures, and methods of injecting the latent code. Our proposed method encourages bijective consistency between the latent encoding and output modes. 
We present a systematic comparison of our method and other variants on both perceptual realism and diversity.
\end{abstract} 
\section{Introduction}
Deep learning techniques have made rapid progress in conditional image generation. For example, networks have been used to inpaint missing image regions~\citep{pathakCVPR16context,yang2016high,isola2016image}, 
add color to grayscale images~\citep{iizuka2016let,larsson2016learning,zhang2016colorful,isola2016image}, and generate photorealistic images from sketches~\cite{sangkloy2017scribbler,isola2016image}.
However, most techniques in this space have focused on generating a \textit{single} result.
In this work, we model a \textit{distribution} of potential results, as many of these problems may be multimodal in nature. For example,
as seen in Figure~\ref{fig:teaser}, an image captured at night may look very different in the day, depending on cloud patterns and lighting conditions.
We pursue two main goals: producing results which are (1) perceptually realistic and (2) diverse, all while remaining faithful to the input.

Mapping from a high-dimensional input to a high-dimensional output distribution is challenging. A common approach to representing multimodality is learning a low-dimensional latent code, which should represent aspects of the possible outputs not contained in the input image. At inference time, a deterministic generator uses the input image, along with stochastically sampled latent codes, to produce randomly sampled outputs. A common problem in existing methods is~\textit{mode collapse}~\citep{goodfellow2016nips}, where only a small number of real samples get represented in the output.
We systematically study a family of solutions to this problem.

We start with the \pp framework~\citep{isola2016image}, which has previously been shown to produce high-quality results for various image-to-image translation tasks. The method trains a generator network, conditioned on the input image, with two losses: (1) a regression loss to produce similar output to the known paired ground truth image and (2) a learned discriminator loss to encourage realism. The authors note that trivially appending a randomly drawn latent code did not produce diverse results. Instead, we propose encouraging a bijection between the output and latent space. 
We not only perform the direct task of mapping the latent code (along with the input) to the output but also jointly learn an encoder from the output back to the latent space. 
This discourages two different latent codes from generating the same output (non-injective mapping).
During training, the learned encoder attempts to pass enough information to the generator to resolve any ambiguities regarding the output mode.
For example, when generating a day image from a night image, the latent vector may encode information about the sky color, lighting effects on the ground, and cloud patterns.  Composing the encoder and generator sequentially should result in the same image being recovered. The opposite should produce the same latent code.

\begin{figure}
\centering
\includegraphics[width=1.\linewidth]{imgs/teaser.pdf}
\vspace{-4mm}
\caption{\small Multimodal image-to-image translation using our proposed method: given an input image from one domain (night image of a scene), we aim to model a \textit{distribution} of potential outputs in the target domain (corresponding day images), producing both realistic and diverse results.}
\vspace{-4mm}
\label{fig:teaser}
\end{figure}


In this work, we instantiate this idea by exploring several objective functions, inspired by literature in unconditional generative modeling:
  \begin{itemize}[leftmargin=0.1in]
  
    \item \textbf{\cvaegan (Conditional Variational Autoencoder GAN)}:
    One approach is first encoding the ground truth image into the latent space, giving the generator a noisy ``peek" into the desired output. Using this, along with the input image, the generator should be able to reconstruct the specific output image. To ensure that random sampling can be used during inference time, the latent distribution is regularized using KL-divergence to be close to a standard normal distribution. This approach has been popularized in the unconditional setting by VAEs~\citep{kingma2013auto} and VAE-GANs~\citep{larsen2016vaegan}.
    
    \item \textbf{\cinfogan (Conditional Latent Regressor GAN)}: Another approach is to first provide a randomly drawn latent vector to the generator. In this case, the produced output may not necessarily look like the ground truth image, but it should look realistic. An encoder then attempts to recover the latent vector from the output image. This method could be seen as a conditional formulation of the ``latent regressor" model~\citep{donahue2016adversarial,dumoulin2016adversarially} and also related to InfoGAN~\citep{xi2016infogan}.
    
    \item \textbf{\bicycle}: Finally, we combine both these approaches to enforce the connection between latent encoding and output in both directions {\em jointly} and achieve improved performance. We show that our method can produce both diverse and visually appealing results across a wide range of image-to-image translation problems, significantly more diverse than other baselines, including naively adding noise in the \pp framework. In addition to the loss function, we study the performance with respect to several encoder networks, as well as different ways of injecting the latent code into the generator network. 
\end{itemize}

We perform a systematic evaluation of these variants by using humans to judge photorealism and a perceptual distance metric~\cite{zhang2018unreasonable} to assess output diversity. Code and data are available at \url{https://github.com/junyanz/BicycleGAN}. 
\begin{figure}
  \centering
  \includegraphics[width=1.\linewidth]{imgs/fig2.pdf}
\caption{\small \textbf{Overview}: (a) Test time usage of all the methods. To produce a sample output, a latent code  is first randomly sampled from a known distribution (e.g., a standard normal distribution). A generator  maps an input image  (blue) and the latent sample  to produce a output sample  (yellow). (b) \ppn~\citep{isola2016image} baseline, with an additional ground truth image  (brown) that corresponds to . (c)  \cvaegan (and \cae) starts from a ground truth target image  and encode it into the latent space. The generator then attempts to map the input image  along with a sampled  back into the original image . (d) \cinfogan randomly samples a latent code from a known distribution, uses it to map  into the output , and then tries to reconstruct the latent code from the output. (e) Our hybrid \bicycle method combines constraints in both directions.
}
\vspace{-5mm}
\label{fig:fig2}
\end{figure}

\section{Related Work}

\paragraph{Generative modeling}
Parametric modeling of the natural image distribution is a challenging problem. Classically, this problem has been tackled using restricted Boltzmann machines~\citep{smolensky1986information} and autoencoders~\citep{hinton2006reducing,vincent2008extracting}. 
Variational autoencoders~\citep{kingma2013auto} provide an effective approach for modeling stochasticity within the network by reparametrization of a latent distribution at training time.
A different approach is autoregressive models~\citep{efros1999texture,van2016pixel,oord2016conditional}, which are effective at modeling natural image statistics but are slow at inference time due to their sequential predictive nature.
Generative adversarial networks~\citep{goodfellow2014generative} overcome this issue by mapping random values from an easy-to-sample distribution (e.g., a low-dimensional Gaussian) to output images in a single feedforward pass of a network. During training, the samples are judged using a discriminator network, which distinguishes between samples from the target distribution and the generator network.
GANs have recently been very successful~\citep{denton2015deep,radford2015unsupervised,donahue2016adversarial,dumoulin2016adversarially,reed2016generative,zhao2016energy,zhu2016generative,arjovsky2017wgan,zhang2016stackgan,xi2016infogan}. Our method builds on the conditional version of VAE~\citep{kingma2013auto} and InfoGAN~\citep{xi2016infogan} or latent regressor~\citep{donahue2016adversarial,dumoulin2016adversarially} models by jointly optimizing their objectives. We revisit this connection in Section~\ref{sec:finalMethod}.

\paragraph{Conditional image generation} All of the methods defined above can be easily conditioned. While conditional VAEs~\citep{sohn2015cvae} and
autoregressive models~\citep{oord2016conditional,van2016pixel} have shown promise~\citep{walker2016uncertain,xue2016visual,guadarrama2017pixcolor}, image-to-image conditional GANs have lead to a substantial boost in the quality of the results. However, the quality has been attained at the expense of multimodality, as the generator learns to largely ignore the random noise vector when conditioned on a relevant context~\citep{pathakCVPR16context,sangkloy2017scribbler,xian2017texturegan,yang2016high,isola2016image,zhu2017unpaired}. 
In fact, it has even been shown that ignoring the noise leads to more stable training~\citep{mathieu2015deep,pathakCVPR16context,isola2016image}.

\paragraph{Explicitly-encoded multimodality}
One way to express multiple modes is to explicitly encode them, and provide them as an additional input in addition to the input image.
For example, color and shape scribbles and other interfaces were used as conditioning in iGAN~\citep{zhu2016generative}, pix2pix~\citep{isola2016image}, Scribbler~\citep{sangkloy2017scribbler} and interactive colorization~\citep{zhang2017real}. An effective option explored by concurrent work~\citep{ghosh2017multi, chen2017photographic,bansal2017pixelnn} is to use a mixture of models. Though able to produce multiple discrete answers, these methods are unable to produce continuous changes.
While there has been some degree of success for generating multimodal outputs in unconditional and text-conditional setups~\citep{goodfellow2014generative,nguyen2016plug,reed2016generative,dinh2016density,larsen2016vaegan}, conditional image-to-image generation is still far from achieving the same results, unless explicitly encoded as discussed above. 
In this work, we learn conditional image generation models for modeling multiple modes of output by enforcing tight connections between the latent and image spaces.
 
\section{Multimodal Image-to-Image Translation}
\label{sec:methods}
Our goal is to learn a multi-modal mapping between two image domains, for example, edges and photographs, or night and day images, etc. 
Consider the input domain , which is to be mapped to an output domain . 
During training, we are given a dataset of paired instances from these domains, , which is representative of a joint distribution .
It is important to note that there could be multiple plausible paired instances  that would correspond to an input instance , but the training dataset usually contains only one such pair.
However, given a new instance  during test time, our model should be able to generate a diverse set of output 's, corresponding to different modes in the distribution .

While conditional GANs have achieved success in image-to-image translation tasks~\citep{pathakCVPR16context,sangkloy2017scribbler,xian2017texturegan,yang2016high,isola2016image,zhu2017unpaired}, they are primarily limited to generating a deterministic output  given the input image . 
On the other hand, we would like to learn the mapping that could sample the output  from true conditional distribution given , and produce results which are both diverse and realistic.
To do so, we learn a low-dimensional latent space , which encapsulates the ambiguous aspects of the output mode which are not present in the input image. For example, a sketch of a shoe could map to a variety of colors and textures, which could get compressed in this latent code. We then learn a deterministic mapping  to the output. To enable stochastic sampling, we desire the latent code vector  to be drawn from some prior distribution ; we use a standard Gaussian distribution  in this work.

We first discuss a simple extension of existing methods and discuss its strengths and weakness, motivating the development of our proposed approach in the subsequent subsections.

\subsection{Baseline: \ppn ()}
The recently proposed \pp model~\citep{isola2016image} has shown high quality results in the image-to-image translation setting.
It uses conditional adversarial networks~\citep{goodfellow2014generative,mirza2014conditional} to help produce perceptually realistic results. GANs train a generator  and discriminator  by formulating their objective as an adversarial game. The discriminator attempts to differentiate between real images from the dataset and fake samples produced by the generator. Randomly drawn noise  is added to attempt to induce stochasticity.
We illustrate the formulation in Figure \ref{fig:fig2}(b) and describe it below.


To encourage the output of the generator to match the input as well as stabilize the training, we use an  loss between the output and the ground truth image.


The final loss function uses the GAN and  terms, balanced by . 


In this scenario, there is little incentive for the generator to make use of the noise vector which encodes random information.
Isola et al.~\citep{isola2016image} note that the noise was ignored by the generator in preliminary experiments and was removed from the final experiments.
This was consistent with observations made in the conditional settings by~\citep{pathakCVPR16context,mathieu2015deep}, as well as the mode collapse phenomenon observed in unconditional cases~\citep{salimans2016improved,goodfellow2016nips}.
In this paper, we explore different ways to explicitly enforce
the latent coding to
capture relevant information.

\subsection{Conditional Variational Autoencoder GAN: \cvaegan ()}
One way to force the latent code  to be ``useful" is to directly map the ground truth  to it using an encoding function .
The generator  then uses both the latent code and the input image  to synthesize the desired output .
The overall model can be easily understood as the reconstruction of , with latent encoding  concatenated with the paired  in the middle -- similar to an autoencoder~\citep{hinton2006reducing}. This interpretation is better shown in Figure \ref{fig:fig2}(c).

This approach has been successfully investigated in Variational Autoencoder~\citep{kingma2013auto} in the unconditional scenario without the adversarial objective. Extending it to conditional scenario, the distribution  of latent code  using the encoder  with a Gaussian assumption, . To reflect this, Equation \ref{eqn:Lgan} is modified to sampling  using the re-parameterization trick, allowing direct back-propagation~\citep{kingma2013auto}. 

We make the corresponding change in the  loss term in Equation \ref{eqn:L1} as well to obtain . Further, the latent distribution encoded by  is encouraged to be close to a random Gaussian to enable sampling at inference time, when  is not known.

where . This forms our \cvaegan objective, a conditional version of the VAE-GAN~\citep{larsen2016vaegan} as


As a baseline, we also consider the deterministic version of this approach, i.e., dropping KL-divergence and encoding .
We call it \cae and show a comparison in the experiments.
There is no guarantee in \cae on the distribution of the latent space , which makes the test-time sampling of  difficult. 

\subsection{Conditional Latent Regressor GAN: \cinfogan ()}
We explore another method of enforcing the generator network to utilize the latent code embedding , while staying close to the actual test time distribution , but from the latent code's perspective.
As shown in Figure \ref{fig:fig2}(d), we start from a 
randomly drawn latent code  and attempt to recover it with .
Note that the encoder  here is producing a point estimate for , whereas the encoder in the previous section was predicting a Gaussian distribution.


We also include the discriminator loss  (Equation \ref{eqn:Lgan}) on  to encourage the network to generate realistic results, and the full loss can be written as:


The  loss for the ground truth image  is not used. Since the noise vector is randomly drawn, the predicted  does not necessarily need to be close to the ground truth but does need to be realistic. The above objective bears similarity to the ``latent regressor" model~\citep{donahue2016adversarial,dumoulin2016adversarially,xi2016infogan}, where the generated sample  is encoded to generate a latent vector.

\subsection{Our Hybrid Model: \bicycle}
\label{sec:finalMethod}
We combine the \cvaegan and \cinfogan objectives in a hybrid model. For \cvaegan, the encoding is learned from real data, but a random latent code may not yield realistic images at test time -- the KL loss may not be well optimized. Perhaps more importantly, the adversarial classifier  does not have a chance to see results sampled from the prior during training. 
In \cinfogan, the latent space is easily sampled from a simple distribution, but the generator is trained without the benefit of seeing ground truth input-output pairs. We propose to train with constraints in both directions, aiming to take advantage of both cycles ( and ), hence the name \bicycle.

\vspace{-3mm}

where the hyper-parameters , , and  control the relative importance of each term. 

In the unconditional GAN setting, \citet{larsen2016vaegan} observe that using samples from both the prior  and encoded  distributions further improves results.
Hence, we also report one variant which is the full objective shown above (Equation~\ref{eq:L}), but without the reconstruction loss on the latent space . 
We call it \cvaeganp, as it is based on \cvaegan with an additional loss , which allows the discriminator to see randomly drawn samples from the prior.
\vspace{-2mm} 
\section{Implementation Details}
\label{sec:implementation}
The code and additional results are publicly available at \url{https://github.com/junyanz/BicycleGAN}. Please refer to our website for more details about the datasets, architectures, and training procedures.
\begin{figure}
\centering
\includegraphics[width=1.0\linewidth]{imgs/injectz.pdf}
\caption{\small \textbf{Alternatives for injecting {\bf z} into generator.} Latent code \textbf{z} is injected by spatial replication and concatenation into the generator network. We tried two alternatives, {\bf (left)} injecting into the input layer and {\bf (right)} every intermediate layer in the encoder.}
\vspace{-4mm}
\label{fig:addz}
\end{figure}

\paragraph{Network architecture} For generator , we use the U-Net~\citep{ronneberger2015u}, which contains an encoder-decoder architecture, with symmetric skip connections. The architecture has been shown to produce strong results in the unimodal image prediction setting when there is a spatial correspondence between input and output pairs. For discriminator , we use two PatchGAN discriminators~\citep{isola2016image} at different scales, which aims to predict real vs. fake for  and  overlapping image patches. For the encoder , we experiment with two networks: (1) \texttt{E\textsubscript{CNN}}: CNN with a few convolutional and downsampling layers and (2) \texttt{E\textsubscript{ResNet}}: a classifier with several residual blocks~\cite{he2016deep}.

\paragraph{Training details} We build our model on the Least Squares GANs (LSGANs) variant~\citep{mao2016least}, which uses a least-squares objective instead of a cross entropy loss. LSGANs produce high-quality results with stable training. We also find that not conditioning the discriminator  on input  leads to better results (also discussed in~\citep{pathakCVPR16context}), and hence choose to do the same for all methods. We set the parameters ,  and  in all our experiments. We tie the weights for the generators and encoders in the \cvaegan and \cinfogan models. For the encoder, only the predicted mean is used in \cinfogan. We observe that using two separate discriminators yields slightly better visual results compared to sharing weights. We only update  for the  loss  on the latent code (Equation \ref{eqn:L1_lacyc}), while keeping  fixed. We found optimizing  and  simultaneously for the loss would encourage  and  to hide the information of the latent code without learning meaningful modes.
We train our networks from scratch using Adam~\citep{kingma2014adam} with a batch size of  and with a learning rate of . We choose latent dimension  across all the datasets. 

{\bf Injecting the latent code  to generator}.
We explore two ways of propagating the latent code  to the output, as shown in Figure~\ref{fig:addz}: 
(1) \texttt{add\_to\_input}: we spatially replicate a -dimensional latent code  to an  tensor and concatenate it with the  input image and (2)~\texttt{add\_to\_all}: we add  to each intermediate layer of the network , after spatial replication to the appropriate sizes.

\vspace{-1mm} 
\begin{figure}
\centering
\includegraphics[width=1.\linewidth]{imgs/results_matrix.pdf}
\caption{\small \textbf{Example Results} We show example results of our hybrid model \bicycle. The left column shows the input. The second shows the ground truth output. The final four columns show randomly generated samples. We show results of our method on nightday, edgesshoes, edgeshandbags, and mapssatellites. Models and additional examples are available at \url{https://junyanz.github.io/BicycleGAN}.} 
\vspace{-2mm}
\label{fig:results}
\end{figure}

\begin{figure}
\centering
\hspace{\linewidth}
\includegraphics[width=\linewidth]{imgs/facades_comparison.pdf}
\caption{\small \textbf{Qualitative method comparison} We compare results on the labels  facades dataset across different methods. The \bicycle method produces results which are both realistic and diverse.}
\label{fig:resultsFacades}
\end{figure}

\section{Experiments}
\label{sec:exp}
\begin{figure}
  \centering
  \begin{minipage}[b]{0.54\linewidth}  
  \scalebox{0.92} {
  \begin{tabular}{l c c}
	& \textbf{Realism} & \textbf{Diversity} \\ \hline
	& AMT Fooling & LPIPS \\
	\textbf{Method} & Rate [\%] & Distance \\ \hline
	Random real images & 50.0\% & .262.007 \\ \hline
	\ppn~\citep{isola2016image} & 27.932.40 \% & .013.000 \\
	\cae & 13.641.80 \% & .204.002 \\
	\cvaegan & 24.932.27 \% & .096.001 \\
	\cvaeganp & 29.192.43 \% & .098.002 \\
	\cinfogan & 29.232.48 \% & \footnote{We found that \cinfogan resulted in severe mode collapse, resulting in  of the images producing the same result. Those images were omitted from this calculation.}.090.002 \\
	\bicycle & 34.332.69 \% & .110.002 \\ \hline
	\end{tabular} } \\
	
  \end{minipage}
  \begin{minipage}[b]{0.45\linewidth}
  \includegraphics[width=\linewidth]{imgs/real_div.pdf} 
  \end{minipage}
  \vspace{-4mm}
  \caption{\small \textbf{Realism vs Diversity}. We measure diversity using average LPIPS distance~\cite{zhang2018unreasonable}, and realism using a real vs. fake Amazon Mechanical Turk test on the Google maps  satellites task. The \ppn baseline produces little diversity. Using only \cae method produces large artifacts during sampling. The hybrid \bicycle method, which combines \cvaegan and \cinfogan, produces results which have higher realism while maintaining diversity.
  }
  \vspace{-5mm}
  \label{fig:real_vs_div}
\end{figure}


{\bf Datasets} We test our method on several image-to-image translation problems from prior work, including edges  photos~\citep{yu2014fine,zhu2016generative}, Google maps  satellite~\citep{isola2016image}, labels  images~\citep{Cordts2016Cityscapes}, and outdoor night  day images~\citep{Laffont14}. These problems are all one-to-many mappings. We train all the models on  images.


{\bf Methods} We evaluate the following models described in Section \ref{sec:methods}: \ppn, \cae, \cvaegan, \cvaeganp, \cinfogan, and our hybrid model \bicycle.

\subsection{Qualitative Evaluation}
\vspace{-1mm}
We show qualitative comparison results on Figure \ref{fig:resultsFacades}. We observe that \ppn typically produces a single realistic output, but does not produce any meaningful variation.
\cae adds variation to the output, but typically at a large cost to result quality. An example on facades is shown on Figure~\ref{fig:results}.

We observe more variation in the \cvaegan, as the latent space is encouraged to encode information about ground truth outputs. However, the space is not densely populated, so drawing random samples may cause artifacts in the output. The \cinfogan shows less variation in the output, and sometimes suffers from mode collapse. When combining these methods, however, in the hybrid method \bicycle, we observe results which are both diverse and realistic. Please see our website for a full set of results.

\vspace{-1mm}
\subsection{Quantitative Evaluation}
\vspace{-1mm}
We perform a quantitative analysis of the diversity, realism, and latent space distribution on our six variants and baselines. We quantitatively test the Google maps  satellites dataset.

{\bf Diversity} We compute the average distance of random samples in deep feature space. Pretrained networks have been used as a ``perceptual loss" in image generation applications~\citep{gatys2016image,johnson2016perceptual,dosovitskiy2016generating}, as well as a held-out ``validation" score in generative modeling, for example, assessing the semantic quality and diversity of a generative model~\citep{salimans2016improved} or the semantic accuracy of a grayscale colorization~\citep{zhang2016colorful}.

In Figure~\ref{fig:real_vs_div}, we show the diversity-score using the LPIPS metric proposed by~\cite{zhang2018unreasonable}\footnote{Learned Perceptual Image Patch Similarity (LPIPS) metric computes distance in AlexNet~\cite{krizhevsky2014one} feature space (\texttt{conv1-5}, pretrained on Imagenet~\citep{russakovsky2015imagenet}), with linear weights to better match human perceptual judgments.}. For each method, we compute the average distance between 1900 pairs of randomly generated output  images (sampled from 100 input  images). Random pairs of ground truth real images in the  domain produce an average variation of .262. As we are measuring samples  which correspond to a specific input , a system which stays faithful to the input should definitely not exceed this score.

The \pp system~\citep{isola2016image} produces a single point estimate. Adding noise to the system \ppn produces a small diversity score, confirming the finding in~\citep{isola2016image} that adding noise does not produce large variation. Using the \cae model to encode a ground truth image  into a latent code  does increase the variation. The \cvaegan, \cvaeganp, and \bicycle models all place explicit constraints on the latent space, and the \cinfogan model places an implicit constraint through sampling. These four methods all produce similar diversity scores. We note that high diversity scores may also indicate that unnatural images are being generated, causing meaningless variations. Next, we investigate the visual realism of our samples.

{\bf Perceptual Realism} To judge the visual realism of our results, we use human judgments, as proposed in~\citep{zhang2016colorful} and later used in~\citep{isola2016image,zhu2017unpaired}. The test sequentially presents a real and generated image to a human for 1 second each, in a random order, asks them to identify the fake, and measures the ``fooling" rate. Figure \ref{fig:real_vs_div}(left) shows the realism across methods. The \ppn model achieves high realism score, but without large diversity, as discussed in the previous section. 
The \cae helps produce diversity, but this comes at a large cost to the visual realism. Because the distribution of the learned latent space is unclear, random samples may be from unpopulated regions of the space. Adding the KL-divergence loss in the latent space, used in the \cvaegan model, recovers the visual realism. Furthermore, as expected, checking randomly drawn  vectors in the \cvaeganp model slightly increases realism. The \cinfogan, which draws  vectors from the predefined distribution randomly, produces similar realism and diversity scores. However, the \cinfogan model resulted in large mode collapse - approximately  of the outputs produced the same result, independent of the input image. The full hybrid \bicycle gets the best of both worlds, as it does not suffer from mode collapse and also has the highest realism score by a significant margin.  

\begin{table}
\begin{center}
 \begin{tabular}{l c c c c}
	Encoder & \texttt{E\textsubscript{ResNet}}  &  \texttt{E\textsubscript{ResNet}} &  \texttt{E\textsubscript{CNN}}  &  \texttt{E\textsubscript{CNN}} \\ \hline
	Injecting  & \texttt{add\_to\_all} &  \texttt{add\_to\_input} & \texttt{add\_to\_all} &  \texttt{add\_to\_input}\\ \hline
	labelphoto &  &  & &  \\
	map  satellite &    &  & &\\
    \hline
	\end{tabular}
		\caption{The encoding performance with respect to the different encoder architectures and methods of injecting . Here we report the reconstruction loss }.
			\label{tab:rec}
	\end{center}
\vspace{-10mm}
\end{table}

{\bf Encoder architecture} In \pp, ~\citet{isola2016image} conduct extensive ablation studies on discriminators and generators. Here we focus on the performance of two encoder architectures, \texttt{E\textsubscript{CNN}} and \texttt{E\textsubscript{ResNet}}, for our applications on the maps and facades datasets. We find that \texttt{E\textsubscript{ResNet}} better encodes the output image, regarding the image reconstruction loss  on validation datasets as shown in Table~\ref{tab:rec}. We use \texttt{E\textsubscript{ResNet}} in our final model.

{\bf Methods of injecting latent code} We evaluate two ways of injecting latent code : \texttt{add\_to\_input} and \texttt{add\_to\_all} (Section ~\ref{sec:implementation}), regarding the same reconstruction loss . Table~\ref{tab:rec} shows that two methods give similar performance. This indicates that the \texttt{U\_Net}~\cite{ronneberger2015u} can already propagate the information well to the output without the additional skip connections from . We use \texttt{add\_to\_all} method to inject noise in our final model.

\begin{figure}
  \centering
  \includegraphics[width=1.\linewidth]{imgs/nz_facades.pdf}
\vspace{-4mm}
\caption{Different label  facades results trained with varying length of the latent code . }
\label{fig:numberofz}
\vspace{-6mm}
\end{figure}


{\bf Latent code length} We study the \bicycle model results with respect to the varying number of dimensions of latent codes  in Figure~\ref{fig:numberofz}. A very low-dimensional latent code may limit the amount of diversity that can be expressed. On the contrary, a very high-dimensional latent code can potentially encode more information about an output image, at the cost of making sampling difficult. The optimal length of  largely depends on individual datasets and applications, and how much ambiguity there is in the output. 

\vspace{-2mm} 
\section{Conclusions}
\label{sec:conclusion}
\vspace{-2mm}

In conclusion, we have evaluated a few methods for combating the problem of mode collapse in the conditional image generation setting. We find that by combining multiple objectives for encouraging a bijective mapping between the latent and output spaces, we obtain results which are more realistic and diverse. We see many interesting avenues of future work, including directly enforcing a distribution in the latent space that encodes semantically meaningful attributes to allow for image-to-image transformations with user controllable parameters.
 
{\bf Acknowledgments}
\small We thank Phillip Isola and Tinghui Zhou for helpful discussions. 
This work was supported in part by Adobe Inc., DARPA, AFRL, DoD MURI award N000141110688, NSF awards IIS-1633310, IIS-1427425, IIS-1212798, the Berkeley Artificial Intelligence Research (BAIR) Lab, and hardware donations from NVIDIA. JYZ is supported by Facebook Graduate Fellowship, RZ by Adobe Research Fellowship, and DP by NVIDIA Graduate Fellowship. Much of this work was done while JYZ and RZ were Adobe Research interns.
 
\section*{Changelog}
\small
\textbf{v1} initial preprint release
\textbf{v2} NIPS camera ready. Added additional implementation details and related work. Replaced VGG-16 with LPIPS for diversity score. Miscellaneous changes to text.
\textbf{v3} Fixed a minor bug in computation of LPIPS score. Figure~\ref{fig:real_vs_div} updated; scores barely change.
\textbf{v4} Updated Adobe Research internship affiliation in acknowledgments.
 
\bibliographystyle{abbrvnat}
\bibliography{./main.bib}


\end{document}