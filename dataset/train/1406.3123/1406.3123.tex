





\documentclass[twocolumn,10pt]{IEEEtran}



\renewcommand{\baselinestretch}{1.0}

\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{enumerate}
\usepackage{paralist}
\usepackage{graphicx}
\usepackage{epstopdf}
\graphicspath{{Figures/}}
\usepackage{subfigure}
\usepackage{cite}
\usepackage{array}
\usepackage{booktabs}
\usepackage{comment}
\usepackage{cases}
\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage{mathrsfs} \usepackage{url}
\usepackage{amssymb}
\usepackage{amsthm} 

\usepackage{bigints} 



\usepackage[table]{xcolor}

\usepackage{ctable}



\usepackage{array}
\usepackage{ragged2e}
\newcolumntype{P}[1]{>{\RaggedRight\hspace{0pt}}p{#1}}
\newcolumntype{C}[1]{>{\centering\hspace{0pt}}p{#1}}




\newtheorem{theorem}{Theorem}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{statement}{Statement}
\newtheorem{remark}{Remark}



\newtheorem{appxlem}{Lemma}[section] 


\setcounter{theorem}{0}
\setcounter{statement}{0}
\setcounter{remark}{0}






\begin{document}

\title{Distributed Resource Allocation for Relay-Aided Device-to-Device Communication: A Message Passing Approach}
\author{Monowar Hasan and Ekram Hossain
\thanks{M. Hasan and E. Hossain are with the Department of Electrical and Computer Engineering, University of Manitoba, Winnipeg, Canada (emails:  monowar\_hasan@umanitoba.ca, Ekram.Hossain@umanitoba.ca).}} 

\maketitle



\begin{abstract}

Device-to-device (D2D) communication underlaying cellular wireless networks is a promising concept to improve user experience and resource utilization by allowing direct transmission between two cellular devices.  In this paper, performance of network-assisted D2D communication is investigated where D2D traffic is carried through relay nodes. Considering a multi-user and multi-relay network, we propose a distributed solution for resource allocation with a view to maximizing network sum-rate. An optimization problem is formulated for  radio resource allocation at the relays. The objective is to maximize end-to-end rate as well as satisfy the data rate requirements for cellular and D2D user equipments under total power constraint. Due to intractability of the resource allocation problem, we propose a solution approach using message passing technique  where each user equipment sends and receives information messages to/from the relay node in an iterative manner with the goal of achieving an optimal allocation. Therefore, the computational effort is distributed among all the user equipments and the corresponding relay node. The convergence and optimality of the proposed scheme are proved and a possible distributed implementation of the scheme in practical LTE-Advanced networks is outlined. The numerical results show that there is a distance threshold beyond which relay-aided D2D communication significantly improves network performance with a small increase in end-to-end delay when compared to direct communication between D2D peers.
\end{abstract}


\begin{IEEEkeywords}
Resource allocation, LTE-Advanced (LTE-A) networks, D2D communication, L3 relay, graphical model, max-sum message passing, factor graph.
\end{IEEEkeywords}


\section{Introduction} \label{sec:intro}


In recent years, new applications such as content distribution and location-aware advertisement underlaying cellular networks have drawn much attention to end-users and network providers. The emergence of such new applications brings D2D communication under intensive discussions in  academia, industry, and standardization bodies. The concept of D2D communication has been introduced to allow local peer-to-peer transmission among user equipments (UEs) bypassing the base station [e.g., eNB in a Long Term Evolution Advanced (LTE-A) network] to cope with high data rate services (i.e., video sharing, online gaming, proximity-aware social networking). D2D communication was first
proposed in \cite{d2d_first_relay} to enable multi-hop relaying in cellular networks. In addition to traditional local voice and data services, other potential D2D use-cases have been introduced in the literature such as peer-to-peer communication, local advertisement, multi-player gaming, data flooding \cite{d2d_example, d2d_example2, 3gpp:d2d_example}, multicasting \cite{d2d_example_multicast}, \cite{d2d_multicast}, video dissemination \cite{d2d_example_video, d2d_example_video2, d2d_inceremental_relay}, and machine-to-machine (M2M) communication \cite{d2d_m2m_1}.

Using local data transmissions, D2D communication offers the following advantages: \begin{inparaenum}[\itshape i\upshape)]  
\item extended coverage;
\item offloading users from cellular networks \cite{d2d_example_offload};
\item increased throughput and spectrum efficiency as well as improved energy efficiency \cite{d2d_energy}.
\end{inparaenum}
However, in a D2D-enabled network, a number of practical considerations may limit the advantages of D2D communication. In practice, setting up reliable direct links between the D2D UEs while satisfying the quality-of-service (QoS) requirements of both the traditional cellular UEs (CUEs) as well as the  D2D UEs is challenging due to the following reasons:  

\begin{enumerate} [\itshape i\upshape)]
\item \textit{Large distance:} the potential D2D UEs may not be in near proximity;
\item \textit{Poor propagation condition:}  the link quality between potential D2D UEs may not be favorable for direct communication;
\item \textit{Interference to and from CUEs:} in an underlay system, without an efficient power control mechanism, the D2D transmitters may cause severe interference to other receiving nodes. The D2D receivers may also experience interference from CUEs and/or eNB. One remedy to this problem is to partition the available spectrum (i.e., use overlay D2D communication). However, this can significantly reduce the spectrum utilization.
\end{enumerate} 

Network-assisted transmissions through relays could efficiently enhance the performance of D2D communication when the D2D UEs are too far away from each other or the quality of the channel between the UEs is not good enough for direct communication. Unlike the existing literature on D2D communication, in this paper, we consider relay-assisted D2D communication
underlaying LTE-A cellular networks where D2D UEs are served by the relay nodes. We utilize the self-backhauling configuration of LTE-A Layer-3 (L3) relay which enables it to perform operations similar to those of an eNB. We consider scenarios in which the potential D2D UEs are located in the same macrocell (i.e., office blocks or university areas, concert halls etc.); however, the proximity and link condition may not be favorable for direct communication. Therefore, they communicate via relays. The radio resources  (e.g., resource blocks [RBs] and power) at the relays are shared among the D2D communication links and the two-hop cellular links using these relays. 

The goal of this work is to design a practical resource allocation algorithm for network-assisted D2D communications. We show that the resource allocation problem can be converted to a \textit{max-sum message passing} (MP) problem over a graphical model. The MP algorithms have been recognized as powerful tools that can be used to solve many problems in signal processing, coding theory, machine learning, natural language processing and computer vision. When MP is applied to solve a problem, the messages represent probabilities (i.e., beliefs) exchanged with the goal of achieving optimal decisions. Analogously, in the context of the resource allocation problem  for relay-aided D2D communication, the MP strategy can be applied to pass messages between UEs and relays until a global allocation is obtained. The advantage of applying MP strategy in resource allocation is that it provides a low-complexity distributed solution and reduces the computation burden at the controller node. Motivated by the above fact, in this work, we apply the max-sum variation of the message passing technique to represent the resource allocation problem by a \textit{factor graph}. To this end, we propose a distributed solution approach with polynomial time-complexity and low signaling overhead. The main contributions of this paper can be summarized as follows:

\begin{itemize}

\item We model and analyze the performance of relay-assisted D2D communication. The problem of RB and power allocation at the relay nodes for the CUEs and D2D UEs is formulated. As opposed to most of the resource allocation schemes in the literature where only a single D2D link is considered, we consider multiple D2D links along with
multiple cellular links that are supported by the relay nodes.

\item We provide a novel solution technique using message passing. Utilizing message passing strategy, we provide a low-complexity distributed solution by which resource blocks and transmission power can be allocated in a distributed fashion.

\item We analyze the complexity and the optimality of the solution. To this end, we compare the performance of our relay-based D2D communication scheme with a direct D2D communication method and observe that relaying improves network performance for distant D2D peers without increasing the end-to-end delay significantly.
\end{itemize} 


The remainder of this paper is organized as follows. A review of
the existing work in the literature and motivation behind this work are presented in Section \ref{sec:related_works}. Followed by the system model and related assumptions in Section \ref{sec:sys_model}, we formulate the resource allocation problem in Section \ref{sec:RAP}. The message passing strategy to solve the resource allocation problem is introduced in Section \ref{sec:rap_mp} and a distributed solution is proposed in Section \ref{sec:distributed_sol}. The performance evaluation  results are presented in Section \ref{sec:performance}.  We conclude the paper in Section \ref{sec:conclusion}. The key mathematical notations used in the paper are listed in Table \ref{tab:notations_mp}.


\begin{table}[!t]
\renewcommand{\arraystretch}{1.3}
\caption{Mathematical Notations}
\label{tab:notations_mp}
\centering
\begin{tabular}{c|p{5.2cm}}
\hline
\bfseries Notation & \bfseries Physical interpretation\\
\hline\hline
 & Set of available RBs \\
\hline  & Set of relays \\
\hline , & Set of CUEs and D2D UEs, respectively \\
 & \\
\hline  & Set of UEs and total number of UEs served by relay , respectively \\
\hline   & A UE served by relay  \\
\hline  &  for UE  over RB  is first and second hop, respectively \\
\hline  & End-to-end data rate for  over RB  \\
\hline  & Data rate requirement for \\
\hline  & RB allocation indicator and actual transmit power for  over RB , respectively \\
\hline  & RB and power allocation vector\\
\hline  & Utility functions in factor graph dealing with optimization constraints \\
\hline  & Message from function node  to variable node  \\
\hline  & Message from  function node to any variable node   \\
\hline  & Marginal at variable node  in factor graph \\
\hline   & Normalize messages for UE  over RB  \\
\hline  & -th sorted element of  without considering the term  \\
\hline  & Node marginal for UE  over RB  \\
\hline  & Required number RB(s) for  to satisfy the rate requirement \\
\hline  & Absolute value of variable  \\
\hline  & End-to-end delay for two hop relay-aided communication \\
\hline 
\end{tabular}
\end{table}

\section{Related Work and Motivation} \label{sec:related_works}

Although resource allocation for D2D communication in orthogonal frequency-division multiple access (OFDMA)-based wireless networks is one of the active areas of research, only a very few work in the literature consider relays for D2D communication. A summary of related literature and comparison with our proposed scheme is presented in Table \ref{tab:summary}.



\begin{table*}[!t]
\renewcommand{\arraystretch}{1.3}
\caption{Summary of Related Work and Proposed Scheme}
\label{tab:summary}
\centering
\begin{tabular}{C{1.7cm}| P{2.7cm}| l| P{3.3cm}| p{2.0cm}| p{2.0cm} }
\hline
\bfseries Reference & \bfseries Problem focus & \bfseries Relay-aided & \bfseries Solution approach & \bfseries Solution type & \bfseries Optimality\\
\hline\hline
\cite{d2d_multicast} & Theoretical analysis, spectrum utilization & No & Iterative cluster partitioning & Centralized & Optimal \\
\cite{d2d_inceremental_relay} & Resource allocation & No & Proposed heuristic & Centralized & Suboptimal\\
\cite{zul-d2d} & Resource allocation & No & Proposed greedy heuristic & Centralized & Suboptimal\\
\cite{d2d_new_paper} & Resource allocation & No\textsuperscript{*} & Numerical optimization & Semi-distributed & Pareto optimal \\
 \cite{d2d_swarm} & Resource allocation, mode selection & No & Particle swarm optimization & Centralized & Suboptimal \\  
\cite{d2d_intf_graph} & Resource allocation & No & Interference graph coloring & Centralized & Suboptimal \\
\cite{phond-d2d} & Resource allocation & No & Column generation based greedy heuristic & Centralized & Suboptimal \\
\cite{le_d2d} & Resource allocation & No & Two-phase heuristic & Centralized & Suboptimal \\
\cite{d2d-rel-1} & Theoretical analysis, performance evaluation  & Yes & Statistical analysis  & Centralized & Optimal\\
\cite{d2d_relay_2} & Performance evaluation  & Yes & Heuristic, simulation  & Centralized & N/A\textsuperscript{\textdagger} \\
\cite{d2d_our_paper} & Resource allocation & Yes & Numerical optimization & Centralized & Asymptotically optimal \\
\hline
\textit{Proposed scheme} & Resource allocation & Yes & Max-sum message passing & Distributed & Asymptotically optimal \\
\hline
\multicolumn{6}{l}{\textsuperscript{*}\footnotesize{D2D UEs serve as relays to assist CUE-eNB communications.}} \\
\multicolumn{6}{l}{\textsuperscript{\textdagger}\footnotesize{No information is available.}} \\
\end{tabular}
\end{table*}



In \cite{zul-d2d}, a greedy heuristic-based resource allocation scheme is proposed for both uplink and downlink scenarios where a D2D pair shares the same resources with CUE only if the achieved  is greater than a given  requirement. A new spectrum sharing protocol for D2D communication overlaying a cellular network is proposed in \cite{d2d_new_paper}, which allows the D2D users to communicate bi-directionally while assisting the two-way communications between the eNB and the CUE. In \cite{d2d_swarm}, the mode selection and resource allocation problem for D2D communication underlaying cellular networks is investigated and the solution is obtained by particle swarm optimization. Through simulations, the authors show that the proposed scheme improves system performance compared to overlay D2D communication. In \cite{d2d_multicast}, D2D communication is proposed to improve the performance of multicast transmission among the members of a multicast group.  A graph-based resource allocation method for cellular networks with underlay D2D communication is proposed in \cite{d2d_intf_graph}. Due to the intractability of resource allocation problem, the authors propose a sub-optimal graph-based approach which accounts for interference and capacity of the network. A resource allocation scheme based on a column generation method is proposed in \cite{phond-d2d} to maximize the spectrum utilization by finding the minimum transmission length (i.e., time slots) for D2D links while protecting the cellular users from interference and guaranteeing QoS. 
A two-phase resource allocation scheme for cellular
network with underlaying D2D communication is proposed in \cite{le_d2d}. Due to -hardness of the optimal resource allocation problem, the author proposes a two-phase low-complexity sub-optimal solution where after performing optimal resource allocation for cellular users, a heuristic subchannel allocation scheme for D2D flows is applied which initiates the resource allocation from the flow with the minimum rate requirements. 

In \cite{d2d_inceremental_relay}, the authors  propose an incremental relay mode for D2D communication where D2D transmitters multicast to both the D2D receiver and BS. In case the D2D transmission fails, the BS retransmits
the multicast message to the D2D receiver. Although the base station receives a copy of the D2D message which is retransmitted in case of failure,  this incremental relay mode of communication consumes part of the downlink resources for retransmission and reduces spectrum utilization. In \cite{d2d-rel-1,  d2d_relay_2}, the maximum ergodic capacity and outage probability of cooperative relaying is investigated in relay-assisted D2D communication  considering power constraints at the eNB. The numerical results show that multi-hop relaying lowers the outage probability and improves cell edge capacity by reducing the effect of interference from the CUE. It is worth noting that most of the above cited works provide centralize solutions. Besides, in \cite{zul-d2d, d2d_new_paper, phond-d2d, d2d_swarm, d2d_multicast, d2d_intf_graph, le_d2d, d2d_inceremental_relay}, the effect of using relays in D2D communication is not studied. As a matter of fact, relaying mechanism explicitly in context of D2D communication has not been studied comprehensively in the literature. 

Taking the advantage of L3 relays supported by the 3GPP standard, in our earlier work \cite{d2d_our_paper}, we studied the performance of network-assisted D2D communication and showed that relay-aided D2D communication provides significant performance gain for long distance D2D links. However, the proposed solution in \cite{d2d_our_paper} is obtained in a centralized manner by a central controller (i.e., L3 relay). In this work, we develop a \textit{distributed solution} technique utilizing the MP strategy on a factor graph. Factor graph and other graphical modes have been used as powerful solution techniques to tackle a wide range of problems in various domains; however, they have not been commonly used in the context of resource allocation in cellular wireless networks. 

To the best of our knowledge, the MP scheme for resource allocation in wireless networks was first introduced in \cite{mp-icc-09} to minimize the transmission power in the uplink of a multi-carrier system. A resource allocation scheme based on MP is proposed in \cite{mp-dft} for DFT-Spread-OFDMA uplink communication. In \cite{mp-twireless}, the message passing approach is used to allocate resources to minimize the transmission power for both single and multiple transmission formats in an OFDMA-based cellular network. In \cite{cr-pgm-jsac}, a message passing algorithm is proposed for a cognitive radio network to find assignment of secondary users to detect primary users so that the best overall network performance is achieved in a computationally efficient manner. Different from the above works, to allocate radio resource efficiently in a relay-aided D2D communication scenario, we use the max-sum MP strategy in our problem domain and propose a distributed solution in order to maximize the spectrum utilization. To this end, we analyze the complexity of the proposed solution and prove its optimality and convergence. We also discuss the delay performance and present an approach for possible implementation of our proposed solution in the LTE-A network setup. 

\section{System Model and Assumptions} \label{sec:sys_model}

\subsection{Network Model}

Let us consider a D2D-enabled  cellular network with multiple relays as shown in Fig. \ref{fig:nw_diagram}. A relay node in LTE-A is connected to the radio access network (RAN) through a donor eNB with a wireless connection and serves  both the cellular UEs and D2D UEs. Let  denote the set of fixed-location Layer 3 (L3) relays\footnote{An L3 relay with self-backhauling configuration performs the same operation as an eNB except that it has a lower transmit power and a smaller cell size. It controls cell(s) and each cell has its own cell identity. The relay transmits its own control signals and the UEs receive scheduling information directly from the relay node \cite{relay-book-1}.} in the network. The system bandwidth is divided into  RBs denoted by . When the link condition between two D2D UEs is too poor for direct communication,  scheduling and resource allocation for the D2D UEs can be done in a relay node (i.e., L3 relay) and the D2D traffic can be transmitted through that relay. We refer to this as \textit{relay-aided D2D communication} which can be an efficient approach to provide a better QoS  (e.g., data rate) for communication between distant D2D UEs.

The CUEs and D2D UEs constitute set  and , respectively, where the pairs of D2D UEs are discovered during the D2D session setup. We assume that the CUEs are outside the coverage region of eNB and/or having bad channel condition, and therefore, CUE-eNB communications need to be supported by the relays. Besides, the direct communication between two D2D UEs  requires the assistance of a relay node. The UEs (i.e., both cellular and D2D UEs) assisted by relay  are denoted by . The set of UEs assisted by relay  is  such that , , and  .  In the second hop, there could be multiple relays transmitting to their associated D2D UEs. We assume that the relays transmit to the eNB using orthogonal channels and this scheduling of relays is done by the eNB\footnote{Scheduling of relay nodes by the eNB is out of the scope of this paper.}. According to our system model, taking the advantage of L3 relays, scheduling and resource allocation for the UEs is performed in the relay node to reduce the computational load at the eNB. 
 

\begin{figure}[!t]
\centering
\includegraphics[scale=0.60]{network-diagram.pdf}
\caption{A single cell with multiple relay nodes. We assume that the CUE-eNB links are unfavorable for direct communication and need the assistance of relays. The D2D UEs are also supported by the relay nodes due to long distance and/or poor link condition between peers. 
} 
\label{fig:nw_diagram}
\end{figure}

\subsection{Radio Propagation Model}

For modeling the  propagation channel, we consider distance-dependent path-loss and shadow fading; furthermore, the channel is assumed to  experience Rayleigh fading. In particular, we consider realistic 3GPP propagation environment\footnote{Any other propagation model for D2D communication can be used for the proposed resource allocation method.} presented in \cite{relay-book-2}. For example, UE-relay (and relay-D2D) link follows the following path-loss equation: 

where  is the distance between UE and relay in kilometer,  accounts for shadow fading and is modelled as a log-normal random variable, and  is an exponentially distributed random variable which represents the Rayleigh fading channel power gain. Similarly, the path-loss equation for relay-eNB link is expressed as  
where  is a log-normal random variable accounting for shadow fading. Hence given the distance , the link gain between any pair of network nodes  can be calculated as .

\subsection{Achievable Data Rate}

We denote by  the direct link gain between node  and  over RB . The interference link gain between relay (UE)   and UE (relay)  over RB  is denoted by   where UE (relay)  is not associated with relay (UE) .  The unit power  for the link between UE  and relay  using RB  in the first hop is given by

The unit power  for the link between relay  and eNB  for CUE  (i.e.,  ) in the second hop is as follows: 

Similarly, the unit power  for the link between relay  and receiving D2D UE for the D2D UEs  (i.e., ) in the second hop can be written as


In  (\ref{eq:SINR_1})--(\ref{eq:SINR_3}),  is the transmit power in the  link between  and  over RB , , where  is bandwidth of an RB, and  denotes thermal noise.   is the gain in the relay-eNB link and  is the gain in the link between relay  and receiving D2D UE corresponding to the D2D transmitter UE .

The achievable data rate\footnote{If there is no relay in the network, the achievable data rate for the UE  over RB  can be expressed as , where ,  is the channel gain between CUE-eNB link () or the channel gain between D2D UEs () and   denotes the set of UEs transmitting with same RB(s) as .} for  in the first hop can be expressed as  Similarly, the achievable data rate in the second hop is given by  Since we are considering a two hop communication approach, the end-to-end data rate for   on RB  is the half of minimum achievable data rate over two hops, i.e.,   


\section{Formulation of the Resource Allocation Problem} 
\label{sec:RAP}


For each relay, the objective of resource (i.e., RB and transmit power) allocation problem (RAP) is to obtain  the assignment of RB and power level to the UEs that maximizes the system capacity, which is defined as the minimum achievable data rate over two hops. The RB allocation indicator is denoted by a binary decision variable , where 


Hence, the objective of RAP is to obtain the RB and power allocation vectors for each relay , i.e., 
 and  respectively, which maximize the data rate. Let the maximum allowable transmit power for UE (relay) is  (). Let the QoS (i.e., data rate) requirements for UE  is denoted by  and  denotes the achievable sum-rate over allocated RB(s). Considering that the same RB(s) will be used by the relay in both the hops, the resource allocation problem for each relay  can be stated as follows:

\mathbf{(P1)} ~ \underset{x_{u_l}^{(n)}, P_{u_l, l}^{(n)}, P_{l, u_l}^{(n)}}{\operatorname{max}} ~ \sum_{u_l \in \mathcal{U}_l } &&  \sum_{n =1}^N   x_{u_l}^{(n)} R_{u_l}^{(n)}  \nonumber \\
\text{subject to} \quad \sum_{u_l \in \mathcal{U}_l} x_{u_l}^{(n)} ~ &&{\leq} ~ 1,  \quad ~~~\forall n \in \mathcal{N} \label{eq:con-bin} \\
\quad \sum_{n =1}^N x_{u_l}^{(n)} P_{u_l, l}^{(n)} ~ &&{\leq} ~ P_{u_l}^{max}, ~ \forall u_l \in \mathcal{U}_l \label{eq:con-pow-ue} \\
\quad \sum_{u_l \in \mathcal{U}_l } \sum_{n =1}^N x_{u_l}^{(n)} P_{l, u_l}^{(n)} ~ &&{\leq} ~ P_l^{max}  \label{eq:con-pow-rel} \\
\quad \sum_{u_l \in \mathcal{U}_l } x_{u_l}^{(n)} P_{u_l, l}^{(n)} g_{{u_l^*}, l, 1}^{(n)} ~ &&{\leq} ~ I_{th, 1}^{(n)},  ~~\forall n \in \mathcal{N} \label{eq:con-intf-1}\\
\quad \sum_{u_l \in \mathcal{U}_l } x_{u_l}^{(n)}  P_{l, u_l}^{(n)} g_{l, {u_l^*}, 2}^{(n)} ~ &&{\leq} ~ I_{th, 2}^{(n)}, ~~\forall n \in \mathcal{N} \label{eq:con-intf-2} \\
\quad R_{u_l}  ~ &&{\geq} ~ Q_{u_l}, \quad \forall u_l \in \mathcal{U}_l  \label{eq:con-QoS-cue}\\
\quad P_{u_l, l}^{(n)} ~ \geq ~ 0, ~~ P_{l, u_l}^{(n)} ~ &&{\geq} ~ 0,  \quad ~~~\forall n \in \mathcal{N}, u_l \in \mathcal{U}_l \label{eq:con-pow-0}

where the rate of  over RB  
 
the unit power   for the first hop,  and the unit power  for the second hop, \begin{numcases}{\gamma_{l, u_l, 2}^{(n)} = }
\frac{h_{l, eNB}^{(n)}}{I_{l, u_l,2}^{(n)} + \sigma^2}, &    \nonumber \\
\frac{h_{l, u_l}^{(n)}}{I_{l,u_l,2}^{(n)} + \sigma^2}, &   . \nonumber
\end{numcases}
In the above,  and  denote the interference received by  over RB  in the first and second hop, respectively, and are given as follows:
 
\begin{numcases}{I_{l,u_l,2}^{(n)} = }
\displaystyle \sum_{\substack{\forall u_j \in \lbrace \mathcal{D} \cap \mathcal{U}_j \rbrace, \\ j \neq l, j \in \mathcal{L}}} x_{u_j}^{(n)} P_{j, u_j}^{(n)} g_{j, eNB}^{(n)} , & \hspace{-2em}  \nonumber \\ 
\displaystyle \sum_{\substack{\forall u_j \in  \mathcal{U}_j, \\ j \neq l, j \in \mathcal{L}}} x_{u_j}^{(n)}  P_{j, u_j}^{(n)} g_{j, u_l}^{(n)}, & \hspace{-3em} . \nonumber   
\end{numcases} 

With the constraint in (\ref{eq:con-bin}), each RB is assigned to only one UE. With the constraints in (\ref{eq:con-pow-ue}) and (\ref{eq:con-pow-rel}), the transmit power is limited by the maximum power budget. The constraints in (\ref{eq:con-intf-1}) and (\ref{eq:con-intf-2}) limit the amount of interference introduced to the other relays and receiving D2D UEs in the first and second hop, respectively, to be less than some threshold. The constraint in (\ref{eq:con-QoS-cue}) ensures the minimum data rate requirements for the CUE and D2D UEs. The constraint in (\ref{eq:con-pow-0}) is the non-negativity condition for transmit power.

Similar to \cite{ref_user}, we apply the concept of reference node. As an example, in the first hop, each UE associated with relay node  chooses from among the neighbouring relays having the highest channel gain according to following equation:

and allocates the power level considering the interference threshold. Similarly, in the second hop, for each relay , the transmit power   will be adjusted accordingly considering interference introduced to receiving D2D UEs (associated with neighboring relays) according to 



From (\ref{eqn:e2e_rate}), the maximum rate for the UE  over RB  is achieved when . Therefore, the power allocated to relay node for the UE  can be expressed as a function of power at UE as  and the rate of  over RB  is given by 
  
Hence the problem  can be written as

 \mathbf{(P2)} 
\underset{x_{u_l}^{(n)}, P_{u_l, l}^{(n)}}{\operatorname{max}} ~ \sum_{u_l \in \mathcal{U}_l } \sum_{n =1}^N   \tfrac{1}{2}  x_{u_l}^{(n)}   B_{RB} \log_2  &&  \left(  1 +   P_{u_l, l}^{(n)} \gamma_{u_l, l, 1}^{(n)}   \right) \hspace{0.1em}   \nonumber \\
\text{subject to} \quad \sum_{u_l \in \mathcal{U}_l} x_{u_l}^{(n)} ~ &&{\leq} ~ 1, \quad ~~\forall n \hspace{-5em} \label{eq:con-bin-relx} \\
 \sum_{n =1}^N x_{u_l}^{(n)}  P_{u_l, l}^{(n)} ~ &&{\leq} ~ P_{u_l}^{max}, \forall u_l  \label{eq:con-pow-ue-relx} \\
 \sum_{u_l \in \mathcal{U}_l } \sum_{n =1}^N x_{u_l}^{(n)}  \tfrac{\gamma_{u_l, l, 1}^{(n)}}{\gamma_{l, u_l, 2}^{(n)}} P_{u_l, l}^{(n)} ~ &&{\leq} ~ P_l^{max} \label{eq:con-pow-rel-relx} \\
 \sum_{u_l \in \mathcal{U}_l } x_{u_l}^{(n)}  P_{u_l, l}^{(n)} g_{{u_l^*}, l, 1}^{(n)} ~ &&{\leq} ~ I_{th, 1}^{(n)}, ~\forall n \label{eq:con-intf-1-relx}\\
 \sum_{u_l \in \mathcal{U}_l } x_{u_l}^{(n)}  \tfrac{\gamma_{u_l, l, 1}^{(n)}}{\gamma_{l, u_l, 2}^{(n)}} P_{u_l, l}^{(n)} g_{l, {u_l^*}, 2}^{(n)} ~ &&{\leq} ~ I_{th, 2}^{(n)}, ~\forall n \label{eq:con-intf-2-relx} \\
\quad \sum_{n=1}^N \tfrac{1}{2}  x_{u_l}^{(n)} B_{RB} \log_2 \left(  1 + P_{u_l, l}^{(n)} \gamma_{u_l, l, 1}^{(n)} \right)  ~ &&{\geq} ~ Q_{u_l},   ~~\forall u_l   \label{eq:con-QoS-cue-relx}\\
\quad P_{u_l, l}^{(n)}  ~ &&{\geq} ~ 0, ~~ \forall n, u_l. \label{eq:con-pow-0-relx} 


\begin{remark}
\label{rem:MINLP}
The RAP formulation is a mixed-integer non-linear program (MINLP).  MINLP problems have the difficulties of both of their sub-classes, i.e., the combinatorial nature of mixed integer programs (MIPs) and the difficulty in solving nonlinear programs (NLPs). Since MIPs and NLPs are -complete, the RAP  is strongly  -hard.
\end{remark} 

In order to obtain a tractable solution for the RAP formulation, in the following, we utilize the MP strategy.

\section{Message Passing Approach to Solve the Resource Allocation Problem} \label{sec:rap_mp}

\subsection{MP Strategy for the Max-sum Problem} \label{sec:MP_intro}

Given the RAP formulation , we focus on the max-sum variant \cite{max-sum} of MP paradigm. Let us consider a generic function  where each variable  corresponds to a finite alphabet , i.e., . We concentrate on maximizing the function , i.e.,
 
That is,  represents the maximization over all possible combinations of the vector  where . The \textit{marginal} of  with respect to variable  is given by

where  denotes the maximization over all variables in  except variable . Let us decompose  into the summation of  functions
, i.e., , where  is a subset of elements of  and . Besides, let  denote the vector of  functions and  represent the subset of functions in  where the variable  appears.  Hence, (\ref{eq:marginal_1}) can be rewritten as


Utilizing any MP algorithm, the computation of marginals involves passing messages between nodes represented by a specific graphical model. Among different graphical models, in this work, we consider factor graph \cite{bp_factor_graph} to capture the structure of generic function . The factor graph consists of two different types of nodes, namely, function (or factor) nodes and variable nodes. A function node is connected with a variable node if and only if the variable appears in the corresponding function. Consequently, a factor graph contains two types of messages, i.e., message from factor nodes to variable nodes and vice-versa. According to the max-sum MP strategy, the message passed by any variable node , to any generic function node , is given as

Likewise, the message from factor node  to variable node  is given as follows:


When the factor graph is cycle free, it is represented as a tree (i.e., there is a unique path connecting any two nodes); hence, all the variable nodes can compute the marginals as

By invoking the general distributive law (i.e., ) \cite{mp_distributive}, the maximization in (\ref{eq:max_1}) can be computed as 

\subsection{Utility Functions}

\begin{figure}[!t]
\centering
\includegraphics[scale=0.70]{factorgraph.pdf}
\caption{An arbitrary factor graph representing MP formulation of the RAP. For ease of representation, the variables are denoted by circular nodes whereas the functions are denoted by square nodes. A variable node  is connected to the function nodes  and  if and only if the variable appears in the corresponding function.} 
\label{fig:factorgraph}
\end{figure}

In the following, we develop a joint RB and power allocation mechanism that leverages the dynamics of MP strategy. Compared to centralized optimization solutions, MP allows to distribute the computational burden of achieving a feasible resource allocation by exchanging information among UEs and the corresponding relay.

In order to solve RAP  using the MP scheme, we reformulate it as a utility maximization (i.e., cost minimization) problem and define the utility functions as in (\ref{eq:cost_function1}) and (\ref{eq:cost_function2}) where unfulfilled constraints result in infinite cost. Per RB constraints [i.e., (\ref{eq:con-bin-relx}), (\ref{eq:con-pow-rel-relx}), (\ref{eq:con-intf-1-relx}), (\ref{eq:con-intf-2-relx})] are incorporated in the utility function  as follows:

where . On the other hand, per UE constraints are incorporated in the utility function  which is the achievable rate of each UE only if the constraints in (\ref{eq:con-pow-ue-relx}) and (\ref{eq:con-QoS-cue-relx}) are satisfied, i.e., 


\subsection{MP Formulation for the Resource Allocation Problem}

Using the utility functions above, the RAP for each relay  can be rewritten as



By exploiting the concept  described in Section \ref{sec:MP_intro}, let us associate (\ref{eq:margin_RB}) with a factor graph as shown in Fig. \ref{fig:factorgraph}. Following an MP strategy, the variable and function nodes exchange messages along their connecting edges until the values of   are determined for . Let  be the marginalization of (\ref{eq:margin_RB}) with respect to  and given as


Let   and  denote
the message exchanged between  function nodes  and the connected variable nodes for . Similarly, 
and  denote the  exchanged messages between  function nodes  and variable nodes for . Let us consider a generic RB  in the factor graph. The square node in Fig. \ref{fig:factorgraph} corresponding  to  which is connected to all variable nodes  for . Hence from (\ref{eq:msg_fact_2_var}), the message to be delivered to the particular variable node  is obtained as follows:



Let us consider a generic user . As illustrated in Fig. \ref{fig:factorgraph}, the square nodes corresponding to function  in factor graph are connected to all variable nodes  for . Using (\ref{eq:msg_fact_2_var}) and (\ref{eq:cost_function2}),  the message from  function node  to any variable node  is given by (\ref{eq:message2}).

\begin{figure*}[!t]
\normalsize




\hrulefill
\vspace*{4pt}
\end{figure*}


From (\ref{eq:message1}) and (\ref{eq:message2}), the marginal   can be obtained as

Consequently, the RB allocation indicator for UE  over RB  is given by


From (\ref{eq:message1}) and (\ref{eq:message2}),  it can be noted that both the messages, i.e.,  and  solve a local optimization problem with respect to the allocation variable . It is worth noting that, in our system model,  each  function node  and corresponding variable nodes are located at the UE , while all  nodes are located at the relay. Hence, sending messages  from variable nodes to  function nodes (and vice-versa) requires actual transmission on the radio channel. However, the message exchanges between variable nodes and  function nodes  are performed locally at the UEs without actual transmission on the radio channel.

\subsection{An Effective Implementation of MP Strategy}

In a practical LTE-A system, since the exchange of messages actually involves effective transmissions over the channel, the MP scheme described in the preceding section might be limited by the signaling overhead  due to transfer of messages between relay and UEs. In the following, we observe that the amount of message signaling can be significantly reduced by some algebraic manipulations. Note that, the message  carries information regarding the use of RB  by UE  with transmission power , while  carries information regarding the lack of transmission on RB  by UE , i.e., . Hence, each UE eventually delivers a real-valued vector of two elements, i.e.,  Let  denote the required number of RB(s)\footnote{The calculation of  is given in \textbf{Appendix \ref{app:num_rb}}.} to satisfy the data rate requirement  for UE . Therefore, the constraint in (\ref{eq:con-QoS-cue-relx}) can be rewritten as 

Now, replacing the constraint in (\ref{eq:message2}) with that in (\ref{eq:new_qos}) and subtracting the constant term  from both sides of (\ref{eq:message2}), we obtain (\ref{eq:message_modified}). Let us introduce the normalized messages . It can be observed that the terms within the summation in (\ref{eq:message_modified}) are either  or  depending on whether the RB allocation indicator variable  is  or . 

\begin{figure*}[!t]
\normalsize




\hrulefill
\vspace*{4pt}
\end{figure*}

Given the above, the maximization is straightforward. For instance, consider the vector   and  be the -th sorted element of  without considering the term  so that  for . Hence, for , the maximum rate will be achieved if \cite{mp-twireless}

Similarly, for , the maximum is given by \cite{mp-twireless}

Since by definition  from (\ref{eq:msg_new_1}) and (\ref{eq:msg_new_2}), the normalized messages can be derived as follows:

where  and .  Note that the messages sent from UE  to RB  in factor graph is a scalar quantity. Similarly, the normalized messages from RB  to UE , i.e.,  becomes \cite{mp-twireless}
 

Note that, for any arbitrary graph, the allocation variables may keep oscillating and might not converge to any fixed point. In the context of loopy graphical models, by introducing a suitable weight, the messages in (\ref{eq:message_ue2rb}) and (\ref{eq:message_rb2ue}) perturb to a fixed point. Accordingly, (\ref{eq:message_ue2rb}) and (\ref{eq:message_rb2ue}) can be rewritten as \cite{min-sum-mp}
 \label{eq:message_ue2rb_weight}
  \psi_{u_l, l}^{(n)} = R_{u_l}^{(n)} - \omega \left\langle R_{u_l}^{(j)} + \psi_{u_l, l}^{(j)} \right\rangle_{\kappa_{u_l} \setminus n} + (1 - \omega) \left( R_{u_l}^{(n)} + \tilde{\psi}_{u_l, l}^{(n)} \right) 
 \label{eq:message_rb2ue_weight}
\tilde{\psi}_{u_l, l}^{(n)} = - \omega ~\underset{\substack{i \in \mathcal{U}_l, \\  i \neq u_l}}{\operatorname \max} ~~ \psi_{i, l}^{(n)} - (1 - \omega) \psi_{u_l, l}^{(n)}.

Note that, when , (\ref{eq:message_ue2rb_weight}) and (\ref{eq:message_rb2ue_weight}) reduce to the original formulation, i.e., (\ref{eq:message_ue2rb}) and (\ref{eq:message_rb2ue}), respectively. Thus the solution  can be easily obtained by calculating the node marginals for each UE-RB pair, i.e., for all  pair as follows:

Hence, from (\ref{eq:x_opt}), the optimal RB allocation can be computed as


\section{Distributed Solution for the Resource Allocation Problem} \label{sec:distributed_sol}

\subsection{Algorithm Development}

Once the optimal RB allocation is obtained, the transmission power of the UEs on assigned RB(s) is obtained as follows. We couple the classical generalized distributed constrained power control scheme (GDCPC) \cite{power_gdpc} with an autonomous power control method \cite{auto_pow_cr} which considers the data rate requirements of UEs while protecting other receiving nodes from interference. More specifically, at each iteration, the transmission power is updated using  (\ref{eq:pow_alloc_mp}) where  and  is obtained as 


\begin{figure*}[!t]
\normalsize



\hrulefill
\vspace*{4pt}
\end{figure*}


In (\ref{eq:power_p_tilde}),  is chosen arbitrarily within the range of  and  is given by


 Each relay independently performs the resource allocation and allocates
resources to the associated UEs. For completeness, the distributed joint RB and power allocation algorithm is summarized in \textbf{Algorithm \ref{alg:mp_rec_alloc}}. Since the L3 relays can perform the same operation as an eNB, these relays can communicate using the X2 interface
\cite{lte_arch} defined in the LTE-A specification. Therefore, the relays can obtain the channel state information through inter-relay message passing without increasing the overhead of signalling at the eNB.

\begin{algorithm*}
\caption{Allocation of RB and transmission power using message passing}
\label{alg:mp_rec_alloc}
\begin{algorithmic}[1]   


\STATE Estimate channel quality indicator (CQI) matrices from previous time slot.
\STATE Initialize  for .


\REPEAT 



\STATE Each UE  sends messages  to the relay  for each RB .

\STATE The relay  sends messages  to each associated UE  for .

\STATE Each UE  computes the marginals as  for  and reports to the corresponding relay. 

\STATE Each relay  calculates the RB and power allocation vector for each UE according to (\ref{eq:rb_alloc_mp}) and (\ref{eq:pow_alloc_mp}), respectively.

\STATE Calculate the aggregated achievable network rate as .   

\STATE Update .

\UNTIL  or the convergence criterion met (i.e., , where  is the  tolerance for convergence).

\STATE  Allocate resources (i.e., RB and transmit power) to the associated UEs for each relay. 

\end{algorithmic}
\end{algorithm*}

\begin{remark}
\label{rem:algo_bound}
Since  satisfies the binary constraints, and the optimal allocation   satisfies all the constraints in , for a sufficient number of available RBs, the solution obtained by {\normalfont \textbf{Algorithm \ref{alg:mp_rec_alloc}} } gives a lower bound on the solution of the original RAP .
\end{remark}


\subsection{Complexity Analysis}

If the algorithm requires  iterations to converge, it is easy to verify that the time complexity at each relay  is of . Similarly, considering a standard sorting algorithm (e.g., merge sort, heap sort) to generate the outputs  for  with a worst-case complexity of , the overall time complexity at each UE is . 



\subsection{Convergence of the Algorithm and Optimality of the Solution}

\begin{theorem}
\label{theorem:optimal-proof-mp}

If the algorithm converges to a fixed point message, this point follows the slackness condition of , and hence it becomes the optimal solution for the original resource allocation problem.

\end{theorem}
\begin{IEEEproof}
See \textbf{Appendix \ref{app:optimal-mp}}.
\end{IEEEproof}

\begin{theorem}
\label{theorem:converge}

The message passing algorithm converges to a solution with zero duality gap as the number of resource blocks goes to infinity, i.e., dual problem of  [e.g., , given by (\ref{eq:conv-mp2})] has the same optimal objective function value \cite{mp-dft}.
\end{theorem}
\begin{IEEEproof}
See \textbf{Appendix \ref{app:converge-mp}}.
\end{IEEEproof}

\subsection{End-to-End Delay for the Proposed Solution}


We measure the total end-to-end delay due to relaying for the proposed framework as follows \cite{delay_imt}:

where   is the time required to schedule the UEs and perform resource allocation,  is the decoding time at relay nodes before data packets are forwarded in second hop, and  is the sum of packet transmission time and propagation delay for hop . While calculating delay using  (\ref{eq:delay}), we assume that each scheduled UE is ready to transmit data and the waiting time before transmission is zero (i.e., there is no queuing delay).

\subsection{Implementation of Proposed Solution in a Practical LTE-A Scenario}

Let  and  denote the  message vectors for UE . These messages can be mapped into standard LTE-A scheduling control messages as illustrated in Fig. \ref{fig:mp_signal}. In an LTE-A system, UEs periodically sense the physical uplink control channel (PUCCH) and transmit known sequences using sounding reference signal (SRS). After reception of scheduling request (SR) from UEs, an L3 relay performs scheduling and resource allocation. After scheduling, the L3 relay allocates RB(s) and informs to the UEs by sending scheduling grant (SG) through  physical downlink control channel (PDCCH). Once the allocation of RB(s) is received, the UEs periodically send the buffer status report (BSR) using PUCCH to the relay in order to update the resource requirement, and in response, the relay sends back an acknowledgment (ACK) in physical hybrid-ARQ indicator channel (PHICH). Considering the above scenario, our proposed message passing approach can be implemented by incorporating  messages in SR and BSR, and  messages in SG and ACK control signals, respectively.


\begin{figure}[!t]
\centering
\includegraphics[width=1.7in]{mp_signal.pdf}
\caption{Possible implementation of the MP scheme in an LTE-A system.} 
\label{fig:mp_signal}
\end{figure}


\section{Performance Evaluation} \label{sec:performance}

\subsection{Simulation Setup}

In order to evaluate the performance of the proposed resource allocation scheme, we develop an event-driven simulator. All the simulations are performed in MATLAB environment. The simulator focuses on capturing the medium access control (MAC) layer behavior of the LTE-A network. We simulate a single three-sectored cell in a rectangular area of , where the eNB is located in the center of the cell and three relays are deployed in the network, i.e., one relay in each sector. The CUEs are uniformly distributed within the relay cell. The D2D transmitters and receivers are uniformly distributed within a radius  while keeping a distance  between peers as shown in Fig. \ref{fig:d2d_position}.  Both  and  are varied as  simulation parameters. We consider a snapshot model to obtain the network performance, where all the network parameters remain constant during a simulation run. 




\begin{figure}[!h t b]
\centering
\includegraphics[width=1.7in]{d2d_dist.pdf}
\caption{D2D UEs are uniformly distributed within the radius  while keeping distance  between peers.} 
\label{fig:d2d_position}
\end{figure}


\begin{table}[!t]
\renewcommand{\arraystretch}{1.3}
\caption{Simulation Parameters}
\label{tab:sim_param}
\centering
\begin{tabular}{l|l}
\hline
\bfseries Parameter & \bfseries Values\\
\hline\hline
Cell layout & Hexagonal grid, -sector sites \\
Carrier frequency &  GHz \\
System bandwidth &  MHz \\
Total number of available RBs &  \\
MAC frame duration &  msec \\
Scheduling time &  msec \\
Packet size &  bytes \\
Relay cell radius &  meter\\
Distance between eNB and relays &  meter\\
Minimum distance between UE and relay &  meter\\
Total power available at each relay &  dBm \\
Total power available at UE &  dBm \\
Rate requirement for cellular UEs &  Kbps \\
Rate requirement for D2D UEs &  Kbps \\
Standard deviation of shadow fading: \\
 \hspace{5em} for relay-eNB links &  dB \\
 \hspace{5em} for UE-relay links &  dB \\
Noise power spectral density &  dBm/Hz \\
\hline
\end{tabular}
\end{table}

In our simulations, we assume ,  is set to  dBm, and interference threshold is  for all the RBs. The simulation parameters  are listed in Table \ref{tab:sim_param}. The simulation results are averaged over different realizations of  UE locations and channel gains.

\subsection{Results} \label{sec:numerical_results}

\subsubsection{Convergence} 

\begin{figure}
\centering
\includegraphics[scale=0.50]{convergence_plot}
\caption{Convergence behavior of the proposed algorithm with different number of UEs:  , .}
\label{fig:convergence_mp}
\end{figure}

In Fig. \ref{fig:convergence_mp}, we depict the convergence behavior of the proposed algorithm. In particular, we show the average achievable data
rate versus the number of iterations. The average achievable rate  for UEs is calculated as  where  is the achievable data rate for UE . Note that the higher
the number of users, the lower the average data rate.

\subsubsection{Performance of relay-aided D2D communication}

We compare the performance of the proposed scheme with the underlay D2D communication scheme presented in \cite{zul-d2d}. In this  \textit{reference scheme}, an RB allocated to CUE can be shared with at most one D2D-link. The D2D UEs share the same RB(s) (allocated to CUE using \textbf{Algorithm \ref{alg:mp_rec_alloc}}) and communicate directly between peers \textit{without} relay if the data rate requirements for both CUE and D2D UEs are satisfied; otherwise, the D2D UEs refrain from transmission on that particular time slot.


\begin{figure}
\centering
\includegraphics[scale=0.50]{rate_prop_ref_80_5_3}
\caption{Average achievable data rate for both the proposed and reference schemes with varying distance between D2D UEs: number of CUE,   and number of D2D pairs,   (i.e.,  CUE and  D2D-pairs are assisted by each relay, and hence  for each relay).   is considered . } 
\label{fig:rate_05_03_mp}
\end{figure}

\begin{figure*}
\centering
\subfigure[]{\includegraphics[scale=0.50]{gain_prop_ref_80_5_3_stem}
\label{fig:gain_05_03_mp}}
\hfil 
\subfigure[]{\includegraphics[scale=0.50]{gain_prop_ref_80_5_3_compare}
\label{fig:gain_05_03_mp_compare}} 
\caption{(a)  Gain in aggregated achievable data rate and (b) Comparing gain with asymptotic upper bound using  the similar setup of Fig. \ref{fig:rate_05_03_mp}. There is a critical distance, beyond which relaying of D2D traffic provides significant performance gain.}
\label{fig:rate_gain_mp}
\end{figure*}

\begin{enumerate}[(i)]
\item \textit{Average achievable data rate vs. distance between D2D UEs:} The average achievable data rate of D2D UEs for both the proposed and reference schemes is illustrated in Fig. \ref{fig:rate_05_03_mp}. Although the reference scheme outperforms when the distance between D2D UEs is small (i.e., ), our proposed approach, which uses relays for D2D traffic, can greatly improve the data rate especially when the distance increases. This is due to the fact that when the distance increases, the performance of direct communication deteriorates due to increased signal attenuation. Besides, when the D2D UEs share resources with only one CUE, the spectrum may not be utilized efficiently, and therefore, the achievable rate decreases. As a result, the gap between the achievable rate with our proposed algorithm and that with the reference scheme becomes wider when the distance increases.

\item \textit{Gain in aggregated achievable data vs. varying distance between D2D UEs:} The gain in terms of aggregated achievable data rate is shown in Fig. \ref{fig:gain_05_03_mp}. We calculate the rate gain as follows: 
 
where  and   denote the aggregated data rate for the D2D UEs in the proposed scheme and the reference scheme, respectively. In Fig. \ref{fig:gain_05_03_mp_compare}, we compare the rate gain with the asymptotic upper bound\footnote{The asymptotic upper bound is obtained through relaxing the constraint that an RB is used by only one UE by using the time-sharing factor \cite{relax-con-1}. Thus  represents the sharing factor where each  denotes the portion of time that RB  is assigned to UE  and satisfies the constraint . For details refer to \cite{d2d_our_paper}.}. The figures show that, compared to direct communication, with the increasing distance between D2D UEs, relaying provides considerable gain in terms of achievable data rate and hence spectrum utilization. In addition, our proposed distributed solution performs nearly close to the upper bound.

\item \textit{Effect of relay-UE distance and distance between D2D UEs on rate gain:} The performance gain in terms of the achievable aggregated data rate under different relay-D2D UE distance is shown in Fig. \ref{fig:rel_var_mp}. It is clear from the figure that, even for relatively large relay-D2D UE distances, e.g.,  m, relaying D2D traffic provides considerable rate gain for distant D2D UEs.


\item \textit{Effect of number of D2D UEs and distance between D2D UEs on rate gain:} We vary the number of D2D UEs and plot the rate gain in Fig. \ref{fig:scal} to observe the performance of our proposed scheme in a dense network. The figure suggests that even in a moderately dense situation (e.g., ) our proposed method provides a higher rate compared to direct communication between distant D2D UEs.


\item \textit{Impact of  relaying on delay:} In Fig. \ref{fig:delay}, we show results on the delay performance of the proposed relay-aided D2D communication approach. In particular, we observe the empirical complementary cumulative distribution function (CCDF)\footnote{The empirical CCDF of delay is defined as  where  is the total number of distance observations (e.g., UE-relay distance for the proposed scheme and the distance between D2D UEs for the reference scheme, respectively) used in the simulation,  is the end-to-end delay at -th distance observation, and   represents the -axis values in Fig. \ref{fig:delay}. The indicator function  outputs  if the condition  is satisfied and  otherwise.} for both the proposed scheme (which uses relay for D2D communication) and reference scheme (where D2D UEs communicate without relay). Note that in the reference scheme, the delay for one hop communication is given by . The variation in end-to-end delay is experienced due to variation in achievable data rate and propagation delay at different values of  and . From this figure it can be observed that the relay-aided D2D communication increases the end-to-end delay. However,  this increase (e.g., ) of delay would be acceptable for many D2D applications.




\end{enumerate}

\begin{figure}[h t b]
\centering
\includegraphics[scale=0.50]{gain_prop_ref_rel_varied}
\caption{Effect of relay distance on rate gain: ,  . For every , there is a distance threshold (i.e., upper side of the lightly shaded surface) beyond which relaying provides significant gain in terms of aggregated achievable rate.} 
\label{fig:rel_var_mp}
\end{figure}


\begin{figure}[h t b]
\centering
\includegraphics[scale=0.50]{scalability}
\caption{Effect of number of D2D UEs on rate gain: , . The upper position of lightly shaded surface illustrates the positive gain in terms of aggregated achievable rate.}
\label{fig:scal}
\end{figure}

\begin{figure}[h t b]
\centering
\includegraphics[scale=0.50]{e2e_delay}
\caption{End-to-end delay for the proposed and reference scheme where ,  . We vary the distances  and  from  to  with  interval. The decoding delay at a relay node is assumed to be  (obtained from \cite{delay_imt}).}
\label{fig:delay}
\end{figure} 


\section{Conclusion} \label{sec:conclusion}

We have presented a comprehensive resource allocation
framework for relay-assisted D2D communication. Due to the -hardness of original resource allocation problem, we have utilized the max-sum message passing strategy and presented a low-complexity distributed solution based on the message passing approach.  The convergence and optimality of the proposed scheme have been proved. The performance of the proposed method has been evaluated through simulations and we have observed that after a distance margin, relaying of D2D traffic improves system performance and provides a better data rate to the D2D UEs at the cost of a small increase in end-to-end delay.
In the context of D2D communication, most of the resource allocation problems are formulated under the assumption that the potential D2D UEs have already been discovered. However, to develop a complete D2D communication framework, this work can be extended considering D2D discovery along with resource allocation. In addition, due to time-varying and random nature of wireless channel, the link gain uncertainties for resource allocation in such relay-aided D2D communication is worth investigating.










\appendices
\numberwithin{equation}{section} 

\section{Required number of RB(s) for a given QoS requirement} 
\label{app:num_rb}


Let  and  denote the instantaneous and average  for the UE  over RB .  In order to determine the required number of RB(s) for a given data rate requirement for any UE, we need to derive the probability distribution of   \cite{lee_qos}. Note that, the channel gain due to Rayleigh fading and log-normal shadowing can be approximated by a single log-normal distribution \cite{pdf_lognormal-1, pdf_lognormal}. In addition, the sum of random variables having log-normal distribution can be represented by a single log-normal distribution \cite{sum_lognormal}. Therefore,  can be approximated by a log-normal random
variable whose mean and standard deviation can be calculated
as shown in \cite{pdf_lognormal}. Hence the average rate achieved by UE   over RB  can be written as (\ref{eq:rate_pdf}) where  and  are the probability density function and probability distribution function of , respectively.



\begin{figure*}[!t]
\normalsize




\hrulefill
\vspace*{4pt}
\end{figure*}

Now, let  be the minimum rate achieved by UE . In order to maintain the data rate requirement, we can derive the following inequality\footnote{Similar to \cite{lee_qos}, we assume that the long-term channel gains on different RBs are same, and hence, the average rates achieved by a particular UE on different RBs are the same.}: 

where by  we explicitly describe the dependence of the minimum achievable rate   on the number of  UEs . Therefore, the minimum number of required RBs is given by




\section{Proof of Theorem \ref{theorem:optimal-proof-mp}} 
\label{app:optimal-mp}

\begin{figure*}[!t]
\normalsize




\hrulefill
\vspace*{4pt}
\end{figure*}

Let us rearrange the Lagrangian of   defined by (\ref{eq:lagrange-1-mp}) as follows:

where  denote the leftover terms involving Lagrange multipliers, i.e., . From above we can derive the following lemma:

\begin{appxlem} \label{lemma:slackness}
The slackness conditions for  are 

where  involves the terms with Lagrange multipliers for .
\end{appxlem}
\begin{IEEEproof}
By Weierstrass' theorem (Appendix A.2, Proposition A.8 in \cite{nonlinear_book_mp}) the dual function can be calculated by (\ref{eq:conv-mp2}).



\begin{figure*}[!t]
\normalsize




\hrulefill
\vspace*{4pt}
\end{figure*}

Therefore, if  has an optimal solution, its dual has an optimal solution, i.e., 

Hence, 

Since  is an optimal allocation, from (\ref{eq:mp_dual_opt}) we obtain

In addition, since , (\ref{eq:mp_dual_opt2}) becomes

Now, if , we have 
\end{IEEEproof}

From (\ref{eq:rb_alloc_mp}), at each iteration, each UE  can distinguish between two different subsets of RBs by sorting the marginals in an increasing order. Let us define  the first subset  given by the first  RBs in the ordered list of marginals where the second subset  is given by the last  of the list. Accordingly, we can have the following lemma:
\begin{appxlem} \label{lemma:con-mp-2}
At convergence,  ~ for .
\end{appxlem}
\begin{IEEEproof}
See \cite{min-sum-mp}. 
\end{IEEEproof}

From  \textbf{Lemma \ref{lemma:slackness}} and \textbf{\ref{lemma:con-mp-2}}, it can be noted that, the inequality  implies the slackness condition (\ref{eq:slackness-mp}) by imposing  and ; hence, the proof of \textbf{Theorem \ref{theorem:optimal-proof-mp}} follows.


\section{Proof of Theorem \ref{theorem:converge}} 
\label{app:converge-mp}


From \cite{large-rb-dual} and Proposition 4 of \cite{mp-convergence-proof},  there must exist a non-overlapping binary valued feasible allocation even after relaxation when the number of RBs tends to infinity. Since in our problem the number of RBs is sufficiently large, the messages converge to a fixed point and we can conclude that the LP relaxation of , i.e.,  achieves the same optimal objective value. Thus, directly following the theorem of integer programming duality (i.e., if the primal problem has an optimal solution, then the dual also has an optimal one) for any finite , the optimal objective value of  lies between  and its LP relaxation.






\bibliographystyle{IEEEtran}



\begin{thebibliography}{10}
\providecommand{\url}[1]{#1}
\csname url@samestyle\endcsname
\providecommand{\newblock}{\relax}
\providecommand{\bibinfo}[2]{#2}
\providecommand{\BIBentrySTDinterwordspacing}{\spaceskip=0pt\relax}
\providecommand{\BIBentryALTinterwordstretchfactor}{4}
\providecommand{\BIBentryALTinterwordspacing}{\spaceskip=\fontdimen2\font plus
\BIBentryALTinterwordstretchfactor\fontdimen3\font minus
  \fontdimen4\font\relax}
\providecommand{\BIBforeignlanguage}[2]{{\expandafter\ifx\csname l@#1\endcsname\relax
\typeout{** WARNING: IEEEtran.bst: No hyphenation pattern has been}\typeout{** loaded for the language `#1'. Using the pattern for}\typeout{** the default language instead.}\else
\language=\csname l@#1\endcsname
\fi
#2}}
\providecommand{\BIBdecl}{\relax}
\BIBdecl

\bibitem{d2d_first_relay}
Y.-D. Lin and Y.-C. Hsu, ``Multihop cellular: a new architecture for wireless
  communications,'' in \emph{Annual Joint Conference of the IEEE Computer and
  Communications Societies (INFOCOM)}, vol.~3, 2000, pp. 1273--1282.

\bibitem{d2d_example}
L.~Lei, Z.~Zhong, C.~Lin, and X.~Shen, ``{Operator controlled device-to-device
  communications in LTE-advanced networks},'' \emph{IEEE Wireless
  Communications}, vol.~19, no.~3, pp. 96--104, 2012.

\bibitem{d2d_example2}
M.~Corson, R.~Laroia, J.~Li, V.~Park, T.~Richardson, and G.~Tsirtsis, ``Toward
  proximity-aware internetworking,'' \emph{IEEE Wireless Communications},
  vol.~17, no.~6, pp. 26--33, 2010.

\bibitem{3gpp:d2d_example}
``{Technical specification group services and system aspects; Feasibility study
  for proximity services (ProSe), release 12},'' 3rd Generation Partnership
  Project, Tech. Rep. 3GPP TR 22.803 V12.2.0, June 2013.

\bibitem{d2d_example_multicast}
J.~Du, W.~Zhu, J.~Xu, Z.~Li, and H.~Wang, ``{A compressed HARQ feedback for
  device-to-device multicast communications},'' in \emph{IEEE Vehicular
  Technology Conference (VTC Fall)}, 2012, pp. 1--5.

\bibitem{d2d_multicast}
B.~Zhou, H.~Hu, S.-Q. Huang, and H.-H. Chen, ``Intracluster device-to-device
  relay algorithm with optimal resource utilization,'' \emph{IEEE Transactions
  on Vehicular Technology}, vol.~62, no.~5, pp. 2315--2326, 2013.

\bibitem{d2d_example_video}
K.~Doppler, M.~Rinne, C.~Wijting, C.~Ribeiro, and K.~Hugl, ``{Device-to-device
  communication as an underlay to LTE-advanced networks},'' \emph{IEEE
  Communications Magazine}, vol.~47, no.~12, pp. 42--49, 2009.

\bibitem{d2d_example_video2}
N.~Golrezaei, A.~Molisch, and A.~Dimakis, ``Base-station assisted
  device-to-device communications for high-throughput wireless video
  networks,'' in \emph{IEEE International Conference on Communications (ICC)},
  2012, pp. 7077--7081.

\bibitem{d2d_inceremental_relay}
J.~Li, M.~Lei, and F.~Gao, ``{Device-to-device (D2D) communication in MU-MIMO
  cellular networks},'' in \emph{IEEE Global Communications Conference
  (GLOBECOM)}, 2012, pp. 3583--3587.

\bibitem{d2d_m2m_1}
N.~K. Pratas and P.~Popovski, ``{Low-rate machine-type communication via
  wireless device-to-device (D2D) links},'' \emph{Submitted to JSAC
  ``Device-to-Device Communications in Cellular Networks''}, 2013, arXiv
  preprint, \url{http://arxiv.org/abs/1305.6783}.

\bibitem{d2d_example_offload}
X.~Bao, U.~Lee, I.~Rimac, and R.~R. Choudhury, ``Dataspotting: offloading
  cellular traffic via managed device-to-device data transfer at data spots,''
  \emph{ACM SIGMOBILE Mobile Computing and Communications Review}, vol.~14,
  no.~3, pp. 37--39, Dec. 2010.

\bibitem{d2d_energy}
F.~Wang, C.~Xu, L.~Song, Z.~Han, and B.~Zhang, ``Energy-efficient radio
  resource and power allocation for device-to-device communication underlaying
  cellular networks,'' in \emph{International Conference on Wireless
  Communications Signal Processing (WCSP)}, 2012, pp. 1--6.

\bibitem{zul-d2d}
M.~Zulhasnine, C.~Huang, and A.~Srinivasan, ``{Efficient resource allocation
  for device-to-device communication underlaying LTE network},'' in \emph{2010
  IEEE 6th International Conference on Wireless and Mobile Computing,
  Networking and Communications (WiMob)}, 2010, pp. 368--375.

\bibitem{d2d_new_paper}
Y.~Pei and Y.-C. Liang, ``{Resource allocation for device-to-device
  communications overlaying two-way cellular networks},'' \emph{IEEE
  Transactions on Wireless Communications}, vol.~12, no.~7, pp. 3611--3621,
  2013.

\bibitem{d2d_swarm}
L.~Su, Y.~Ji, P.~Wang, and F.~Liu, ``{Resource allocation using particle swarm
  optimization for D2D communication underlay of cellular networks},'' in
  \emph{IEEE Wireless Communications and Networking Conference (WCNC),}, 2013,
  pp. 129--133.

\bibitem{d2d_intf_graph}
R.~Zhang, X.~Cheng, L.~Yang, and B.~Jiao, ``Interference-aware graph based
  resource sharing for device-to-device communications underlaying cellular
  networks,'' in \emph{IEEE Wireless Communications and Networking Conference
  (WCNC)}, 2013, pp. 140--145.

\bibitem{phond-d2d}
P.~Phunchongharn, E.~Hossain, and D.~I. Kim, ``Resource allocation for
  device-to-device communications underlaying LTE-Advanced networks,''
  \emph{IEEE Wireless Communications}, vol.~20, no.~4, pp. 91--100, 2013.

\bibitem{le_d2d}
L.~B. Le, ``Fair resource allocation for device-to-device communications in
  wireless cellular networks,'' in \emph{IEEE Global Communications Conference
  (GLOBECOM)}, 2012, pp. 5451--5456.

\bibitem{d2d-rel-1}
D.~Lee, S.-I. Kim, J.~Lee, and J.~Heo, ``{Performance of multihop
  decode-and-forward relaying assisted device-to-device communication
  underlaying cellular networks},'' in \emph{International Symposium on
  Information Theory and its Applications (ISITA), 2012}, 2012, pp. 455--459.

\bibitem{d2d_relay_2}
K.~Vanganuru, S.~Ferrante, and G.~Sternberg, ``{System capacity and coverage of
  a cellular network with D2D mobile relays},'' in \emph{Military
  Communications Conference (MILCOM), 2012}, 2012, pp. 1--6.

\bibitem{d2d_our_paper}
M.~Hasan and E.~Hossain, ``Resource allocation for network-integrated
  device-to-device communications using smart relays,'' in \emph{IEEE Global
  Communications Conference Workshops (GC Wkshps)}, 2013, pp. 597--602.

\bibitem{mp-icc-09}
A.~Abrardo, P.~Detti, and M.~Moretti, ``Message passing resource allocation for
  the uplink of multicarrier systems,'' in \emph{IEEE International Conference
  on Communications (ICC)}, 2009, pp. 1--6.

\bibitem{mp-dft}
K.~Yang, N.~Prasad, and X.~Wang, ``{A message-passing approach to distributed
  resource allocation in uplink DFT-Spread-OFDMA systems},'' \emph{IEEE
  Transactions on Communications}, vol.~59, no.~4, pp. 1099--1113, 2011.

\bibitem{mp-twireless}
A.~Abrardo, M.~Belleschi, P.~Detti, and M.~Moretti, ``Message passing resource
  allocation for the uplink of multi-carrier multi-format systems,'' \emph{IEEE
  Transactions on Wireless Communications}, vol.~11, no.~1, pp. 130--141, 2012.

\bibitem{cr-pgm-jsac}
Y.~Liang, L.~Lai, and J.~Halloran, ``Distributed cognitive radio network
  management via algorithms in probabilistic graphical models,'' \emph{IEEE
  Journal on Selected Areas in Communications}, vol.~29, no.~2, pp. 338--348,
  2011.

\bibitem{relay-book-1}
D.~I. Kim, W.~Choi, H.~Seo, and B.-H. Kim, ``{Partial information relaying and
  relaying in 3GPP LTE},'' in \emph{{Cooperative Cellular Wireless
  Networks}}.\hskip 1em plus 0.5em minus 0.4em\relax Cambridge University
  Press, 2011.

\bibitem{relay-book-2}
Y.~Yuan, ``{LTE-A relay scenarios and evaluation methodology},'' in
  \emph{LTE-Advanced Relay Technology and Standardization}.\hskip 1em plus
  0.5em minus 0.4em\relax Springer, 2013, pp. 9--38.

\bibitem{ref_user}
K.~Son, S.~Lee, Y.~Yi, and S.~Chong, ``{REFIM: A practical interference
  management in heterogeneous wireless access networks},'' \emph{IEEE Journal
  on Selected Areas in Communications}, vol.~29, no.~6, pp. 1260--1272, 2011.

\bibitem{max-sum}
A.~Rogers, A.~Farinelli, R.~Stranders, and N.~R. Jennings, ``{Bounded
  approximate decentralised coordination via the max-sum algorithm},''
  \emph{Artificial Intelligence}, vol. 175, no.~2, pp. 730--759, 2011.

\bibitem{bp_factor_graph}
J.~S. Yedidia, W.~T. Freeman, and Y.~Weiss, ``Understanding belief propagation
  and its generalizations,'' in \emph{Exploring artificial intelligence in the
  new millennium}, G.~Lakemeyer and B.~Nebel, Eds.\hskip 1em plus 0.5em minus
  0.4em\relax San Francisco, CA, USA: Morgan Kaufmann Publishers Inc., 2003,
  pp. 239--269.

\bibitem{mp_distributive}
S.~Aji and R.~McEliece, ``{The generalized distributive law},'' \emph{IEEE
  Transactions on Information Theory}, vol.~46, no.~2, pp. 325--343, 2000.

\bibitem{min-sum-mp}
A.~Abrardo, M.~Belleschi, P.~Detti, and M.~Moretti, ``A min-sum approach for
  resource allocation in communication systems,'' in \emph{IEEE International
  Conference on Communications (ICC)}, 2011, pp. 1--6.

\bibitem{power_gdpc}
F.~Berggren, R.~Jantti, and S.-L. Kim, ``A generalized algorithm for
  constrained power control with capability of temporary removal,'' \emph{IEEE
  Transactions on Vehicular Technology}, vol.~50, no.~6, pp. 1604--1612, 2001.

\bibitem{auto_pow_cr}
S.~Im, H.~Jeon, and H.~Lee, ``Autonomous distributed power control for
  cognitive radio networks,'' in \emph{IEEE Vehicular Technology Conference
  (VTC-Fall)}, 2008, pp. 1--5.

\bibitem{lte_arch}
{Alcatel-Lucent}, ``{The LTE network architecture},'' December 2009, {White
  Paper}.

\bibitem{delay_imt}
D.~Schultz, R.~Pabst, and B.~Walke, ``Analytical estimation of packet delays in
  relay-based imt-advanced networks,'' in \emph{IEEE Vehicular Technology
  Conference (VTC Spring)}, 2008, pp. 2411--2415.

\bibitem{relax-con-1}
Z.~Shen, J.~Andrews, and B.~Evans, ``{Adaptive resource allocation in multiuser
  OFDM systems with proportional rate constraints},'' \emph{IEEE Transactions
  on Wireless Communications}, vol.~4, no.~6, pp. 2726--2737, 2005.

\bibitem{lee_qos}
L.~B. Le, D.~Niyato, E.~Hossain, D.~I. Kim, and D.~T. Hoang, ``{QoS-aware and
  energy-efficient resource management in OFDMA femtocells},'' \emph{IEEE
  Transactions on Wireless Communications}, vol.~12, no.~1, pp. 180--194, 2013.

\bibitem{pdf_lognormal-1}
A.~M.~d. Turkmani, ``{Probability of error for M-branch macroscopic selection
  diversity},'' \emph{IEE Proceedings I Communications, Speech and Vision},
  vol. 139, no.~1, pp. 71--78, 1992.

\bibitem{pdf_lognormal}
H.~Fu and D.~I. Kim, ``{Analysis of throughput and fairness with downlink
  scheduling in WCDMA networks},'' \emph{IEEE Transactions on Wireless
  Communications}, vol.~5, no.~8, pp. 2164--2174, 2006.

\bibitem{sum_lognormal}
N.~Mehta, J.~Wu, A.~Molisch, and J.~Zhang, ``Approximating a sum of random
  variables with a lognormal,'' \emph{IEEE Transactions on Wireless
  Communications}, vol.~6, no.~7, pp. 2690--2699, 2007.

\bibitem{nonlinear_book_mp}
D.~P. Bertsekas, \emph{{Nonlinear Programming}}, 2nd~ed.\hskip 1em plus 0.5em
  minus 0.4em\relax Athena Scientific, 1999.

\bibitem{large-rb-dual}
W.~Yu and R.~Lui, ``{Dual methods for nonconvex spectrum optimization of
  multicarrier systems},'' \emph{IEEE Transactions on Communications}, vol.~54,
  no.~7, pp. 1310--1322, 2006.

\bibitem{mp-convergence-proof}
K.~Yang, N.~Prasad, and X.~Wang, ``{An auction approach to resource allocation
  in uplink OFDMA systems},'' \emph{IEEE Transactions on Signal Processing},
  vol.~57, no.~11, pp. 4482--4496, 2009.

\end{thebibliography}

\begin{IEEEbiography} [{\includegraphics[width=1in,height=1.25in,clip,keepaspectratio]{monowar.jpg}}]
{Monowar Hasan} (S'13)  received his B.Sc. degree in Computer Science and Engineering from Bangladesh University of Engineering and Technology (BUET), Dhaka, in 2012. He is currently working toward his M.Sc. degree in the Department of Electrical and Computer Engineering at the University of Manitoba, Winnipeg, Canada. He has been awarded the University of Manitoba Graduate Fellowship. His current research interests include internet of things, software defined networks and resource allocation in mobile cloud computing. He serves as a reviewer for several major IEEE journals and conferences.

\end{IEEEbiography}

\begin{IEEEbiography} [{\includegraphics[width=1in,height=1.25in,clip,keepaspectratio]{ekram.jpg}}]
{Ekram Hossain} (S'98-M'01-SM'06)  
is a Professor (since March 2010) in the Department of Electrical and Computer Engineering at University of Manitoba, Winnipeg, Canada. He received his Ph.D. in Electrical Engineering from University of Victoria, Canada, in 2001. Dr. Hossain's current research interests include design, analysis, and optimization of wireless/mobile communications networks, cognitive radio systems, and network economics.  He has authored/edited several books in these areas (http://home.cc.umanitoba.ca/hossaina). His research has been widely cited in the literature (more than 7000 citations in
Google Scholar with an h-index of 42 until January 2014). Dr. Hossain  serves as the Editor-in-Chief for the {\em IEEE Communications Surveys and Tutorials}  and an Editor for {\em IEEE Journal on Selected Areas in Communications - Cognitive Radio Series} and {\em IEEE Wireless Communications}.  Also, he is a member of the IEEE Press Editorial Board. Previously, he served as the Area Editor for the {\em IEEE Transactions on Wireless Communications} in the area of  ``Resource Management and Multiple Access'' from 2009-2011 and an Editor for the IEEE Transactions on Mobile Computing from 2007-2012. He is also a member of the IEEE Press Editorial Board. Dr. Hossain has won several research awards including the University of Manitoba Merit Award in 2010 (for Research and Scholarly Activities), the 2011 IEEE Communications Society Fred Ellersick Prize Paper Award, and the IEEE Wireless Communications and Networking Conference 2012 (WCNC'12) Best Paper Award. He is a Distinguished Lecturer of the IEEE Communications Society (2012-2015). Dr. Hossain is a registered Professional Engineer in the province of Manitoba, Canada. 
\end{IEEEbiography}


\end{document}
