\documentclass{article}

\PassOptionsToPackage{numbers, compress}{natbib}
\usepackage{amsmath,amssymb,graphicx,color,algorithm,algpseudocode,booktabs,bm,relsize,enumitem,multirow,amsthm,subfigure,epsfig}
\usepackage[final]{nips_2018}





\usepackage{hyperref}       \usepackage{url}            \usepackage{nicefrac}       



\iftrue \newcommand{\cutsectionup}{\vspace*{0in}}
        \newcommand{\cutsectiondown}{\vspace*{-0.05in}}

        \newcommand{\cutsubsectionup}{\vspace*{-0.05in}}
        \newcommand{\cutsubsectiondown}{\vspace*{-0.04in}}

        \newcommand{\cutsubsubsectionup}{\vspace*{-0.05in}}
        \newcommand{\cutsubsubsectiondown}{\vspace*{-0.05in}}

        \newcommand{\cutparagraphup}{\vspace*{-0in}}
        \newcommand{\cutparagraphdown}{\vspace*{-0in}}

        \newcommand{\cuthalfcaptionup}{\vspace*{-0.15in}}
        \newcommand{\cuthalfcaptiondown}{\vspace*{-0.25in}}

        \newcommand{\cutcaptionup}{\vspace*{-0.1in}}
        \newcommand{\cutcaptiondown}{\vspace*{-0.15in}}

        \newcommand{\cuthalftablecaptionup}{\vspace*{-0in}}
        \newcommand{\cuthalftablecaptiondown}{\vspace*{-0.1in}}

        \newcommand{\cuttablecaptionup}{\vspace*{-0in}}
        \newcommand{\cuttablecaptiondown}{\vspace*{-0.1in}}

        \newcommand{\cutequationup}{\vspace*{-0.05in}}
        \newcommand{\cutequationdown}{\vspace*{-0in}}

        \newcommand{\cuttableup}{\vspace*{-0in}}
        \newcommand{\cuttabledown}{\vspace*{-0.21in}}
        
        \newcommand{\cutabstractup}{\vspace*{-0.12in}}
        \newcommand{\cutabstractdown}{\vspace*{-0.3in}}

        \newcommand{\cutalgorithmup}{\vspace*{-0in}}
        \newcommand{\cutalgorithmdown}{\vspace*{-0.1in}}

        \newcommand{\cut}{{\vspace*{-0.02in}}}
        \newcommand{\cutmore}{{\vspace*{-0.06in}}}
        \newcommand{\negcut}{}
\else \newcommand{\cutsectionup}{}
        \newcommand{\cutsectiondown}{}

        \newcommand{\cutsubsectionup}{}
        \newcommand{\cutsubsectiondown}{}

        \newcommand{\cutsubsubsectionup}{}
        \newcommand{\cutsubsubsectiondown}{}

        \newcommand{\cutparagraphup}{}
        \newcommand{\cutparagraphdown}{}

        \newcommand{\cuthalfcaptionup}{}
        \newcommand{\cuthalfcaptiondown}{}

        \newcommand{\cutcaptionup}{}
        \newcommand{\cutcaptiondown}{}

        \newcommand{\cutequationup}{}
        \newcommand{\cutequationdown}{}

        \newcommand{\cuttableup}{}
        \newcommand{\cuttabledown}{}

        \newcommand{\cutabstractup}{}
        \newcommand{\cutabstractdown}{}

        \newcommand{\cutalgorithmup}{}
        \newcommand{\cutalgorithmdown}{}

        \newcommand{\cut}{}
        \newcommand{\cutmore}{}
        \newcommand{\negcut}{}
\fi


\newcommand{\addparagraphup}{\vspace*{0.01in}}



\title{A Simple Unified Framework for Detecting Out-of-Distribution Samples and Adversarial Attacks}




\author{
Kimin Lee, Kibok Lee, Honglak Lee, Jinwoo Shin\\
Korea Advanced Institute of Science and Technology (KAIST)\\
University of Michigan\\
Google Brain\\
AItrics\\
}

\begin{document}


\maketitle

\begin{abstract}
Detecting test samples drawn sufficiently far away from the training distribution statistically
or adversarially is a fundamental requirement for deploying a good classifier in many real-world machine learning applications. 
However, deep neural networks with the softmax classifier are known to produce highly overconfident posterior distributions even for such abnormal samples.
In this paper, we propose a simple yet effective method for detecting
any abnormal samples, which is applicable to any pre-trained softmax neural classifier. We obtain the class conditional Gaussian distributions with respect to (low- and upper-level) features of the deep models under Gaussian discriminant analysis, which result in a confidence score based on the Mahalanobis distance.
While most prior methods have been evaluated for detecting either out-of-distribution or adversarial samples, but not both,
the proposed method achieves the state-of-the-art performances for both cases 
in our experiments.
Moreover, we found that our proposed method is more robust in harsh cases, e.g., when the training dataset has noisy labels or small number of samples.
Finally, we show that the proposed method enjoys broader usage by applying it to class-incremental learning:
whenever out-of-distribution samples are detected, our classification rule can incorporate new classes well without further training deep models.
\end{abstract}

\section{Introduction} \label{sec:intro}


Deep neural networks (DNNs) have achieved high accuracy on many classification tasks, 
e.g., speech recognition \citep{amodei2016deep}, object detection \citep{girshick2015fast} and image classification \citep{he2016deep}.
However, measuring the predictive uncertainty still remains a challenging problem \citep{lee2017training,liang2017principled}.
Obtaining well-calibrated predictive uncertainty is indispensable since it could be useful in many machine learning applications (e.g., active learning \citep{gal2017deep} and novelty detection \citep{lee2018hierarchical}) as well as when deploying DNNs in real-world systems \citep{amodei2016concrete}, e.g., self-driving cars and secure authentication system \citep{evtimov2017robust,sharif2016accessorize}.

The predictive uncertainty of DNNs is closely related to the problem of detecting abnormal samples
that are drawn far away from in-distribution (i.e., distribution of training samples) statistically or adversarially.
For detecting out-of-distribution (OOD) samples,
recent works have utilized the confidence from the posterior distribution \citep{hendrycks2016baseline, liang2017principled}.
For example, \citet{hendrycks2016baseline} proposed the maximum value of posterior distribution from the classifier as a baseline method, and it is improved by processing the input and output of DNNs \citep{liang2017principled}. 
For detecting adversarial samples,
confidence scores were proposed 
based on density estimators to characterize them in feature spaces of DNNs \citep{feinman2017detecting}.
More recently, \citet{ma2018characterizing} proposed the local intrinsic dimensionality (LID) and empirically showed that the characteristics of test samples can be estimated effectively using the LID.
However, most prior works on this line typically do not evaluate both OOD and adversarial samples.
To best of our knowledge, no universal detector is known to work well on both tasks.

\noindent {\bf Contribution.} 
In this paper, we propose a simple yet effective method, which is applicable to 
any pre-trained softmax neural classifier (without re-training) for detecting
abnormal test samples including OOD and adversarial ones.
Our high-level idea is to measure the probability density of test sample on feature spaces of DNNs utilizing the concept of a ``generative'' (distance-based) classifier. Specifically, 
we assume that pre-trained features can be fitted well by a class-conditional Gaussian distribution
since its posterior distribution can be shown to be equivalent to the softmax classifier under Gaussian discriminant analysis (see Section \ref{sec:main_results_score} for our justification). 
Under this assumption, 
we define the confidence score using the Mahalanobis distance with respect to the closest class-conditional distribution, where its parameters are chosen as empirical class means and tied empirical covariance of training samples.
To the contrary of conventional beliefs, we found that using the corresponding generative classifier does not sacrifice the softmax classification accuracy.
Perhaps surprisingly, its confidence score
outperforms softmax-based ones very strongly across multiple other tasks: detecting OOD samples, detecting adversarial samples and class-incremental learning.

We demonstrate the effectiveness of the proposed method using deep convolutional neural networks,
such as DenseNet \citep{huang2017densely} and ResNet \citep{he2016deep} trained for image classification tasks on various datasets including CIFAR \citep{krizhevsky2009learning}, SVHN \citep{netzer2011reading}, ImageNet \citep{deng2009imagenet} and LSUN \citep{yu2015lsun}.
First, for the problem of detecting OOD samples, the proposed method 
outperforms the current state-of-the-art method, ODIN \citep{liang2017principled}, 
in all tested cases.
In particular, compared to ODIN,
our method improves the true negative rate (TNR), i.e., the fraction of detected OOD (e.g., LSUN) samples,
from  to  on ResNet when 95\% of in-distribution (e.g., CIFAR-100) samples are correctly detected.
Next, for the problem of detecting adversarial samples, e.g., generated by four attack methods such as FGSM \citep{goodfellow2014explaining}, BIM \citep{kurakin2016adversarial}, DeepFool \citep{moosavi2016deepfool} and CW \citep{carlini2017adversarial},
our method outperforms the state-of-the-art detection measure, LID \citep{ma2018characterizing}.
In particular, compared to LID,
ours improves the TNR of CW from  to  on ResNet when 95\% of normal CIFAR-10 samples are correctly detected.

We also found that our proposed method is more robust in the choice of its hyperparameters as well as against extreme scenarios, e.g., when the training dataset has 
some noisy, random labels or a small number of data samples.
In particular, \citet{liang2017principled} tune the hyperparameters of ODIN using validation sets of OOD samples, which is often impossible since the knowledge about OOD samples is not accessible a priori.
We show that hyperparameters of
the proposed method can be tuned only using in-distribution (training) samples, while maintaining its performance. We further show that the proposed method tuned on a simple attack, i.e., FGSM, can be used to detect other more complex attacks such as BIM, DeepFool and CW.



Finally, we apply our method to class-incremental learning \citep{rebuffi2017icarl}: new classes are added progressively to a pre-trained classifier.
Since the new class samples are drawn from an out-of-training distribution,
it is natural to expect that one can classify them using our proposed metric without re-training the deep models.
Motivated by this,
we present a simple method which accommodates a new class at any time by simply computing the class mean of the new class and updating the tied covariance of all classes.
We show that the proposed method outperforms other baseline methods,
such as Euclidean distance-based classifier and re-trained softmax classifier.
This evidences that our approach have a potential to apply to many other related machine learning tasks, such as active learning \citep{gal2017deep}, ensemble learning \citep{lee2017confident} and few-shot learning~\citep{vinyals2016matching}.


\section{{Mahalanobis distance-based score} from generative classifier} \label{sec:main_results}


Given deep neural networks (DNNs) with the softmax classifier,
we propose a simple yet effective method for detecting abnormal samples such as out-of-distribution (OOD) and adversarial ones.
We first present the proposed confidence score based on an induced generative classifier under Gaussian discriminant analysis (GDA),
and then introduce additional techniques to improve its performance.
We also discuss how the confidence score is applicable to incremental learning.

\begin{figure} [t] \centering
\subfigure[Visualization by t-SNE]
{
\includegraphics[width=0.31\textwidth]{tsne_resnet_c10.pdf} \label{fig:tsne_res}} 
\,
\subfigure[Classification accuracy]
{
\includegraphics[width=0.31\textwidth]{ACC_ResNet.pdf} \label{fig:test_acc}}
\,
\subfigure[ROC curve]
{
\includegraphics[width=0.31\textwidth]{ROC_RES_CIFAR10_IMAGE.pdf} \label{fig:roc_curve}}
\caption{
Experimental results under the ResNet with 34 layers.
(a) Visualization of final features from ResNet trained on CIFAR-10 by t-SNE, where the colors of points indicate the classes of the corresponding objects. (b) Classification test set accuracy of ResNet on CIFAR-10, CIFAR-100 and SVHN datasets. (c) Receiver operating characteristic (ROC) curves: the x-axis and y-axis represent the false positive rate (FPR) and true positive rate (TPR), respectively.}
\label{fig:justification}
\end{figure}



\subsection{Why Mahalanobis distance-based score?} \label{sec:main_results_score}

{\bf Derivation of generative classifiers from softmax ones.}
Let  be an input and  be its label.
Suppose that
a pre-trained softmax neural classifier is given:

where  and  are the weight and the bias of the softmax classifier for class , and  denotes the output of the penultimate layer of DNNs.
Then, without any modification on the pre-trained softmax neural classifier,
we obtain a generative classifier assuming that a class-conditional distribution follows the multivariate Gaussian distribution.
Specifically, 
we define  class-conditional Gaussian distributions with a tied covariance : 

where  is the mean of multivariate Gaussian distribution of class .
Here, our approach is based on a simple theoretical connection between GDA and the softmax classifier: the posterior distribution defined by the generative classifier under GDA with tied covariance assumption is equivalent to the softmax classifier (see the supplementary material for more details).
Therefore, the pre-trained features of the softmax neural classifier  might also follow the class-conditional Gaussian distribution.

To estimate the parameters of the generative classifier from the pre-trained softmax neural classifier,
we compute the empirical class mean and covariance of training samples :

where  is the number of training samples with label .
This is equivalent to fitting the class-conditional Gaussian distributions with a tied covariance to training samples under the maximum likelihood estimator.


{\bf Mahalanobis distance-based confidence score.}
Using the above induced class-conditional Gaussian distributions, 
we define the confidence score  using the Mahalanobis distance between test sample  and the closest class-conditional Gaussian distribution, i.e.,

Note that this metric corresponds to measuring the log of the
probability densities of the test sample.
Here, we remark that abnormal samples can be characterized better in the representation space of DNNs, rather than the ``label-overfitted'' output space of softmax-based posterior distribution used in the prior works \cite{hendrycks2016baseline, liang2017principled} for detecting them.
It is because a confidence measure obtained from the posterior distribution can show high confidence even for abnormal samples that lie far away from the softmax decision boundary.
\citet{feinman2017detecting} and \citet{ma2018characterizing} process the DNN features for detecting adversarial samples in a sense, but do not utilize the Mahalanobis distance-based metric, i.e., they only utilize the Euclidean distance in their scores.
In this paper,
we show that Mahalanobis distance is significantly more effective than
the Euclidean distance in various tasks. 

{\bf Experimental supports for generative classifiers.}
To evaluate our hypothesis that trained features of DNNs support the assumption of GDA, 
we measure the classification accuracy as follows: 
We remark that this corresponds to predicting a class label using the posterior distribution from generative classifier with the uniform class prior.
Interestingly, 
we found that the softmax accuracy (red bar) is also achieved by the Mahalanobis distance-based classifier (blue bar),
while conventional knowledge is
that a generative classifier trained from scratch typically performs much worse than
a discriminative classifier such as softmax. For visual interpretation,
Figure \ref{fig:tsne_res} presents embeddings of final features from CIFAR-10 test samples constructed by t-SNE \citep{maaten2008visualizing}, where the colors of points indicate the classes of the corresponding objects.
One can observe that all ten classes are clearly separated in the embedding space, 
which supports our intuition.
In addition,
we also show that Mahalanobis distance-based metric can be very useful in detecting out-of-distribution samples.
For evaluation, we obtain the receiver operating characteristic (ROC) curve using a simple threshold-based detector
by computing the confidence score  on a test sample  and decide it as positive (i.e., in-distribution) if  is above some threshold.
The Euclidean distance, which only utilizes the empirical class means, is considered for comparison.
We train ResNet on CIFAR-10, and TinyImageNet dataset \citep{deng2009imagenet} is used for an out-of-distribution.
As shown in Figure \ref{fig:roc_curve}, 
the Mahalanobis distance-based metric (blue bar) performs better than Euclidean one (green bar) and the maximum value of the softmax distribution (red bar).





\begin{algorithm}[t]
\caption{Computing the Mahalanobis distance-based confidence score.} \label{alg:computing_mahalanobis}
\begin{algorithmic}
\State {\bf Input:} Test sample , weights of logistic regression detector , noise  and parameters of Gaussian distributions 
\vspace{0.05in}
\hrule
\vspace{0.05in}
\State Initialize score vectors: 
\For{each layer }
\State Find the closest class: 
\State Add small noise to test sample:  
\State  Computing confidence score: 
\EndFor
\State \Return Confidence score for test sample {}
\end{algorithmic}
\end{algorithm}


\begin{figure} [t] \centering
\subfigure[TinyImageNet]
{
\includegraphics[width=0.22\textwidth]{DenseNet_low_feature_C10_IMAGE.pdf} \label{fig:low_dense_c10_svhn}} 
\,
\subfigure[LSUN]
{
\includegraphics[width=0.22\textwidth]{DenseNet_low_feature_C10_LSUN.pdf} \label{fig:low_dense_c10_lsun}}
\,
\subfigure[SVHN]
{
\includegraphics[width=0.22\textwidth]{DenseNet_low_feature_C10_SVHN.pdf} \label{fig:low_dense_c10_image}}
\,
\subfigure[DeepFool]
{
\includegraphics[width=0.22\textwidth]{DenseNet_low_feature_C10_DeepFool.pdf} \label{fig:low_dense_c10_deepfool}}
\caption{AUROC (\%) of threshold-based detector using the confidence score in \eqref{eq:mahalanobis} computed at different basic blocks of DenseNet trained on CIFAR-10 dataset. We measure the detection performance using (a) TinyImageNet, (b) LSUN, (c) SVHN and (d) adversarial (DeepFool) samples.}
\label{fig:low_layer_dense}
\end{figure}

\subsection{Calibration techniques}


{\bf Input pre-processing.}
To make in- and out-of-distribution samples more separable, we consider adding a small controlled noise to a test sample.
Specifically, for each test sample , we calculate the pre-processed sample  by adding the small perturbations as follows:

where  is a magnitude of noise and  is the index of the closest class.
Next, we measure the confidence score using the pre-processed sample.
We remark that the noise is generated to increase the proposed confidence score \eqref{eq:mahalanobis} unlike adversarial attacks \citep{goodfellow2014explaining}.
In our experiments,
such perturbation can have stronger effect on separating the in- and out-of-distribution samples.
We remark that similar input pre-processing was studied in \citep{liang2017principled}, where the perturbations are added to increase the softmax score of the predicted label.
However, our method is different in that the noise is generated to increase the proposed metric.

{\bf Feature ensemble.}
To further improve the performance,
we consider measuring and combining the confidence scores
from not only the final features but also the other low-level features in DNNs.
Formally, given training data, we extract the -th hidden features of DNNs, denoted by , and compute their empirical class means and tied covariances, i.e.,  and . Then, for each test sample , we measure the confidence score from the -th layer using the formula in \eqref{eq:mahalanobis}.
One can expect that this simple but natural scheme can bring an extra gain in obtaining a better calibrated score by extracting more input-specific information from the low-level features.
We measure the area under ROC (AUROC) curves of the threshold-based detector using the confidence score in \eqref{eq:mahalanobis} computed at different basic blocks of DenseNet \citep{huang2017densely} trained on CIFAR-10 dataset, where the overall trends on ResNet are similar.
Figure \ref{fig:low_layer_dense} shows the performance on various
OOD samples such as {SVHN \citep{netzer2011reading}, LSUN \citep{yu2015lsun}, TinyImageNet 
and adversarial samples generated by DeepFool \citep{moosavi2016deepfool}}, 
where the dimensions of the intermediate features are reduced using average pooling (see Section \ref{sec:exp} for more details).
As shown in Figure \ref{fig:low_layer_dense},
the confidence scores computed at low-level features often provide better calibrated ones compared to final features (e.g., LSUN, TinyImageNet and DeepFool).
To further improve the performance,
we design a feature ensemble method as described in Algorithm \ref{alg:computing_mahalanobis}.
We first extract the confidence scores from all layers, and then integrate them by weighted averaging: , where  and  is the confidence score at the -th layer and its weight, respectively.
In our experiments, following similar strategies in \citep{ma2018characterizing}, we choose the weight of each layer  by training a logistic regression detector using validation samples.
We remark that such weighted averaging of confidence scores can prevent the degradation on the overall performance even in the case when the confidence scores from some layers are not effective: the trained weights (using validation) would be nearly zero for those ineffective layers.

\begin{algorithm}[t]
\caption{Updating Mahalanobis distance-based classifier for class-incremental learning.} \label{alg:update_mahalanobis}
\begin{algorithmic}
\State {\bf Input:} set of samples from a new class , mean and covariance of observed classes 
\vspace{0.05in}
\hrule
\vspace{0.05in}
\State Compute the new class mean: 
\State Compute the covariance of the new class: 
\State Update the shared covariance: 
\State \Return Mean and covariance of all classes 
\end{algorithmic}
\end{algorithm}


\subsection{Class-incremental learning using Mahalanobis distance-based score}\label{sec:incrementalsetup}

{
As a natural extension, we also show that the Mahalanobis distance-based confidence score can be utilized in class-incremental learning tasks \citep{rebuffi2017icarl}:
a classifier pre-trained on base classes is progressively updated whenever a new class with corresponding samples occurs.
This task is known to be challenging since one has to deal with catastrophic forgetting \citep{mccloskey1989catastrophic} with a limited memory.
To this end, recent works have been toward developing new training methods which involve a generative model or data sampling, but adopting such training
methods might incur expensive back-and-forth costs.
Based on the proposed confidence score, we develop a simple classification method without the usage of complicated training methods.
To do this, we first assume that the classifier is well pre-trained with a certain amount of base classes, where
the assumption is quite reasonable in many practical scenarios.\footnote{For example, state-of-the-art CNNs trained on large-scale image dataset are off-the-shelf \citep{he2016deep, huang2017densely}, so they are a starting point in many computer vision tasks \citep{girshick2015fast, lee2018hierarchical, mensink2013distance}.}
In this case, one can expect that not only the classifier can detect OOD samples well, but also might be good for discriminating new classes, as the representation learned with the base classes can characterize new ones.
Motivated by this, 
we present a Mahalanobis distance-based classifier based on \eqref{eq:classification},
which tries to accommodate a new class by simply computing and updating the class mean and covariance, as described in Algorithm~\ref{alg:update_mahalanobis}.}
The class-incremental adaptation of our confidence score shows its potential to be applied to a wide range of new applications in the future.






\section{Experimental results} \label{sec:exp}


In this section, we demonstrate the effectiveness of the proposed method using deep convolutional neural networks such as DenseNet \citep{huang2017densely} and ResNet \citep{he2016deep} on various vision datasets: CIFAR \citep{krizhevsky2009learning}, SVHN \citep{netzer2011reading}, ImageNet \citep{deng2009imagenet} and LSUN \citep{yu2015lsun}.
Due to the space limitation, we provide the more detailed experimental setups and results in the supplementary material. Our code is available at \url{https://github.com/pokaxpoka/deep_Mahalanobis_detector}.


\begin{table}[t]
\centering
\resizebox{\columnwidth}{!}{
\begin{tabular}{ccccccccccc}
\toprule
\begin{tabular}[c]{@{}c@{}} Method \end{tabular}
&\begin{tabular}[c]{@{}c@{}}Feature\\ ensemble \end{tabular}
&\begin{tabular}[c]{@{}c@{}}Input \\pre-processing \end{tabular}
& \begin{tabular}[c]{@{}c@{}}TNR \\at TPR 95\% \end{tabular}
& \begin{tabular}[c]{@{}c@{}}AUROC \end{tabular} 
& \begin{tabular}[c]{@{}c@{}}Detection \\accuracy \end{tabular} 
& \begin{tabular}[c]{@{}c@{}}AUPR \\in \end{tabular} 
& \begin{tabular}[c]{@{}c@{}}AUPR \\out \end{tabular} \\\midrule
Baseline \citep{hendrycks2016baseline} & - & - 
& 32.47 & 89.88 & 85.06 & 85.40 & 93.96 \\ \midrule
ODIN \citep{liang2017principled} & - & - 
& 86.55 & 96.65 & 91.08 & 92.54 & 98.52 \\ \midrule
\multirow{4}{*}{\begin{tabular}[c]{@{}c@{}} Mahalanobis \\ (ours) \end{tabular}}& - & - 
& 54.51 & 93.92 & 89.13 & 91.56 & 95.95 \\
& - & \checkmark 
& 92.26 & 98.30 & 93.72 & 96.01 & 99.28 \\
& \checkmark & - 
& 91.45 & 98.37 & 93.55 & 96.43 & 99.35 \\
& \checkmark & \checkmark 
& {\bf 96.42} & {\bf 99.14} & {\bf 95.75} & {\bf 98.26} & {\bf  99.60} \\ \bottomrule
\end{tabular}}
\vspace{0.1in}
\caption{Contribution of each proposed method on distinguishing in- and out-of-distribution test set
data. We measure the detection performance using ResNet trained on CIFAR-10, when SVHN dataset is used as OOD. All values are percentages and the best results are indicated in bold.}
\label{tbl:out_contribution}
\end{table}

\subsection{Detecting out-of-distribution samples}

{\bf Setup.} For the problem of detecting out-of-distribution (OOD) samples,
we train DenseNet with 100 layers and ResNet with 34 layers for classifying CIFAR-10, CIFAR-100 and SVHN datasets.
The dataset used in training is the in-distribution (positive) dataset and the others are considered as OOD (negative).
We only use test datasets for evaluation.
In addition, 
the TinyImageNet (i.e., subset of ImageNet dataset) and LSUN datasets are also tested as OOD.
For evaluation, 
we use a threshold-based detector which measures some confidence score of the test sample, and then classifies the test sample as in-distribution if the confidence score is above some threshold.
We measure the following metrics:
the true negative rate (TNR) at 95\% true positive rate (TPR),
the area under the receiver operating characteristic curve (AUROC),
the area under the precision-recall curve (AUPR), and
the detection accuracy.
For comparison, we consider the baseline method \citep{hendrycks2016baseline}, 
which defines a confidence score as a maximum value of the posterior distribution, and the state-of-the-art ODIN \citep{liang2017principled}, which defines the confidence score as a maximum value of the processed posterior distribution.



For our method, we extract the confidence scores from every end of dense (or residual) block of DenseNet (or ResNet).
The size of feature maps on each convolutional layers is reduced by average pooling for computational efficiency: , where  is the number of channels and  is the spatial dimension.
As shown in Algorithm \ref{alg:computing_mahalanobis}, 
the output of the logistic regression detector is used as the final confidence score in our case.
All hyperparameters are tuned on a separate validation set, which consists of 1,000 images from each in- and out-of-distribution pair.
Similar to \citet{ma2018characterizing}, the weights of logistic regression detector are trained using nested cross validation within the validation set, where the class label is assigned positive for in-distribution samples and assigned negative for OOD samples.
Since one might not have OOD validation datasets in practice,
we also consider tuning the hyperparameters using in-distribution (positive) samples and corresponding adversarial (negative) samples generated by FGSM \citep{goodfellow2014explaining}.


{\bf Contribution by each technique and comparison with ODIN.} 
Table \ref{tbl:out_contribution} validates the contributions of our suggested techniques under the comparison with the baseline method and ODIN. 
We measure the detection performance using ResNet trained on CIFAR-10, when SVHN dataset is used as OOD.
We incrementally apply our techniques to see the stepwise improvement by each component.
One can note that our method significantly outperforms the baseline method without feature ensembles and input pre-processing.
This implies that our method can characterize the OOD samples very effectively compared to the posterior distribution. 
By utilizing the feature ensemble and input pre-processing,
the detection performance are further improved compared to that of ODIN.
The left-hand column of Table \ref{tbl:OOD_total} reports the detection performance with ODIN for all in- and out-of-distribution dataset pairs.
Our method outperforms the baseline and ODIN for all tested cases.
In particular, our method improves the TNR, i.e., the fraction of detected LSUN samples, compared to ODIN:  using DenseNet, when 95\% of CIFAR-100 samples are correctly detected.




\begin{table}[t]
\centering
\resizebox{\columnwidth}{!}{
\begin{tabular}{ccccc|ccc}
\toprule
     \multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} In-dist \\ (model) \end{tabular}}                           &     \multirow{3}{*}{OOD}                                 & \multicolumn{3}{c|}{Validation on OOD samples} & \multicolumn{3}{c}{Validation on adversarial samples} \\
 &  & TNR at TPR 95\%        & AUROC        & Detection acc.       & TNR at TPR 95\%        & AUROC        & Detection acc.       \\ \cline{3-8} 
                                &                                      & \multicolumn{3}{c|}{Baseline \citep{hendrycks2016baseline} / ODIN \citep{liang2017principled} / Mahalanobis (ours)}              & \multicolumn{3}{c}{Baseline \citep{hendrycks2016baseline} / ODIN \citep{liang2017principled} / Mahalanobis (ours)}               \\ \midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} CIFAR-10 \DenseNet) \end{tabular}}   
&  SVHN         
& \multicolumn{1}{c}{26.7 / 70.6 / {\bf 82.5}}
& \multicolumn{1}{c}{82.7 / 93.8 / {\bf 97.2}}
& \multicolumn{1}{c|}{75.6 / 86.6 / {\bf 91.5}}                
& \multicolumn{1}{c}{26.7 / 39.8 / {\bf 62.2}}
& \multicolumn{1}{c}{82.7 / 88.2 / {\bf 91.8}}
& \multicolumn{1}{c}{75.6 / 80.7 / {\bf 84.6}} \\
&  TinyImageNet 
& \multicolumn{1}{c}{17.6 / 42.6 / {\bf 86.6}}
& \multicolumn{1}{c}{71.7 / 85.2 / {\bf 97.4}}
& \multicolumn{1}{c|}{65.7 / 77.0 / {\bf 92.2}}
& \multicolumn{1}{c}{17.6 / 43.2 / {\bf 87.2}}
& \multicolumn{1}{c}{71.7 / 85.3 / {\bf 97.0}}
& \multicolumn{1}{c}{65.7 / 77.2 / {\bf 91.8}} \\
&  LSUN         
& \multicolumn{1}{c}{16.7 / 41.2 / {\bf 91.4}}
& \multicolumn{1}{c}{70.8 / 85.5 / {\bf 98.0}}
& \multicolumn{1}{c|}{64.9 / 77.1 / {\bf 93.9}}
& \multicolumn{1}{c}{16.7 / 42.1 / {\bf 91.4}}
& \multicolumn{1}{c}{70.8 / 85.7 / {\bf 97.9}}
& \multicolumn{1}{c}{64.9 / 77.3 / {\bf 93.8}} \\  \midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} SVHN \ResNet) \end{tabular}}     
&  SVHN         
& \multicolumn{1}{c}{32.5 / 86.6 / {\bf 96.4}}
& \multicolumn{1}{c}{89.9 / 96.7 / {\bf 99.1}}
& \multicolumn{1}{c|}{85.1 / 91.1 / {\bf 95.8}}            
& \multicolumn{1}{c}{32.5 / 40.3 / {\bf 75.8}}
& \multicolumn{1}{c}{89.9 / 86.5 / {\bf 95.5}}
& \multicolumn{1}{c}{85.1 / 77.8 / {\bf 89.1}}\\
&  TinyImageNet 
& \multicolumn{1}{c}{44.7 / 72.5 / {\bf 97.1}}
& \multicolumn{1}{c}{91.0 / 94.0 / {\bf 99.5}}
& \multicolumn{1}{c|}{85.1 / 86.5 / {\bf 96.3}}  
& \multicolumn{1}{c}{44.7 / 69.6 / {\bf 95.5}}
& \multicolumn{1}{c}{91.0 / 93.9 / {\bf 99.0}}
& \multicolumn{1}{c}{85.1 / 86.0 / {\bf 95.4}} \\
&  LSUN         
& \multicolumn{1}{c}{45.4 / 73.8 / {\bf 98.9}}
& \multicolumn{1}{c}{91.0 / 94.1 / {\bf 99.7}}
& \multicolumn{1}{c|}{85.3 / 86.7 / {\bf 97.7}}              
& \multicolumn{1}{c}{45.4 / 70.0 / {\bf 98.1}}
& \multicolumn{1}{c}{91.0 / 93.7 / {\bf 99.5}}
& \multicolumn{1}{c}{85.3 / 85.8 / {\bf 97.2}}
\\ \midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} CIFAR-100 \ResNet) \end{tabular}}  
&  CIFAR-10     
& \multicolumn{1}{c}{78.3 / 79.8 / {\bf 98.4}}
& \multicolumn{1}{c}{92.9 / 92.1 / {\bf 99.3}}
& \multicolumn{1}{c|}{90.0 / 89.4 / {\bf 96.9}}          
& \multicolumn{1}{c}{78.3 / 79.8 / {\bf 94.1}}
& \multicolumn{1}{c}{92.9 / 92.1 / {\bf 97.6}}
& \multicolumn{1}{c}{90.0 / 89.4 / {\bf 94.6}} \\
&  TinyImageNet 
& \multicolumn{1}{c}{79.0 / 82.1 / {\bf 99.9}}
& \multicolumn{1}{c}{93.5 / 92.0 / {\bf 99.9}}
& \multicolumn{1}{c|}{90.4 / 89.4 / {\bf 99.1}}      
& \multicolumn{1}{c}{79.0 / 80.5 / {\bf 99.2}}
& \multicolumn{1}{c}{93.5 / 92.9 / {\bf 99.3}}
& \multicolumn{1}{c}{90.4 / 90.1 / {\bf 98.8}} \\
&  LSUN         
& \multicolumn{1}{c}{74.3 / 77.3 / {\bf 99.9}}
& \multicolumn{1}{c}{91.6 / 89.4 / {\bf 99.9}}
& \multicolumn{1}{c|}{89.0 / 87.2 / {\bf 99.5}}           
& \multicolumn{1}{c}{74.3 / 76.3 / {\bf 99.9}}
& \multicolumn{1}{c}{91.6 / 90.7 / {\bf 99.9}}
& \multicolumn{1}{c}{89.0 / 88.2 / {\bf 99.5}} \\ \bottomrule
\end{tabular}}
\vspace{+0.05in}
\caption{Distinguishing in- and out-of-distribution test set data for image classification under various validation setups. All values are percentages and the best results are indicated in bold.}
\label{tbl:OOD_total}
\end{table}

\begin{figure*} [t] \centering\setlength{\tabcolsep}{0cm}
\subfigure[Small number of training data]
{
\begin{tabular}{@{}cccc@{}}
    \includegraphics[width=.24\textwidth]{ResNet_C10_SVHN_SMALL.pdf} 
    \includegraphics[width=.24\textwidth]{ResNet_C10_IMAGE_SMALL.pdf} 
\end{tabular}\label{fig:resnet_c10_small_label}} 
\,
\subfigure[Training data with random labels]
{\begin{tabular}{@{}cccc@{}}
    \includegraphics[width=.24\textwidth]{ResNet_C10_Noise_Label_SVHN.pdf} 
    \includegraphics[width=.24\textwidth]{ResNet_C10_Noise_Label_IMAGE.pdf} 
\end{tabular}\label{fig:resnet_c10_noise_label}}
\caption{Comparison of AUROC (\%) under extreme scenarios: (a) small number of training data, where the x-axis represents the number of training data. (b) Random label is assigned to training data, where the x-axis represents the percentage of training data with random label.}
\label{fig:resnet_c10_small}
\end{figure*}

{\bf Comparison of robustness.}
In order to evaluate the robustness of our method,
we measure the detection performance when all hyperparameters are tuned only using in-distribution and adversarial samples generated by FGSM \citep{goodfellow2014explaining}.
As shown in the right-hand column of Table \ref{tbl:OOD_total},
ODIN is working poorly compared to the baseline method in some cases (e.g., DenseNet trained on SVHN), while our method still outperforms the baseline and ODIN consistently.
We remark that our method validated without OOD but adversarial samples even outperforms ODIN validated with OOD.
We also verify the robustness of our method under various training setups. Since our method utilizes empirical class mean and covariance of training samples, there is a caveat such that it can be affected by the properties of training data. 
In order to verify the robustness,
we measure the detection performance when we train ResNet by varying the number of training data and assigning random label to training data on CIFAR-10 dataset.
As shown in Figure \ref{fig:resnet_c10_small}, 
our method (blue bar) maintains high detection performances even for small number of training data or noisy one, while baseline (red bar) and ODIN (yellow bar) do not.
Finally, we remark that our method using softmax neural classifier trained by standard cross entropy loss typically outperforms the ODIN using softmax neural classifier trained by confidence loss \citep{lee2017training} which involves jointly training a generator and a classifier to calibrate the posterior distribution even though training such model is computationally more expensive (see the supplementary material for more details).


\subsection{Detecting adversarial samples} \label{sec:exp_adv}


{\bf Setup.} For the problem of detecting adversarial samples, 
we train DenseNet and ResNet for classifying CIFAR-10, CIFAR-100 and SVHN datasets, 
and the corresponding test dataset is used as the positive samples to measure the performance.
We use adversarial images as the negative samples generated by the following attack methods: 
FGSM \citep{goodfellow2014explaining}, BIM \citep{kurakin2016adversarial}, DeepFool \citep{moosavi2016deepfool} and CW \citep{carlini2017adversarial}, where the detailed explanations can be found in the supplementary material.
For comparison, 
we use a logistic regression detector based on combinations of kernel density (KD) \citep{feinman2017detecting} and predictive uncertainty (PU), i.e., maximum value of posterior distribution.
We also compare the state-of-the-art local intrinsic dimensionality (LID) scores \citep{ma2018characterizing}.
Following the similar strategies in \citep{feinman2017detecting, ma2018characterizing},
we randomly choose 10\% of original test samples for training the logistic regression detectors and the remaining test samples are used for evaluation.
Using nested cross-validation within the training set, all hyper-parameters are tuned.


\begin{table}[t]
\centering
\resizebox{\columnwidth}{!}{
\begin{tabular}{ccc|cccc|cccc}
\toprule
\multirow{2}{*}{\begin{tabular}[c]{@{}c@{}} Model \end{tabular}}&\multirow{2}{*}{\begin{tabular}[c]{@{}c@{}} Dataset \\ (model) \end{tabular}}&\multirow{2}{*}{Score}&\multicolumn{4}{c|}{Detection of known attack} &\multicolumn{4}{c}{Detection of unknown attack} \\
& && FGSM & BIM & DeepFool & CW & FGSM (seen) & BIM & DeepFool & CW \\ \midrule
\multirow{9}{*}{\begin{tabular}[c]{@{}c@{}} DenseNet  \end{tabular}} &\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} CIFAR-10  \end{tabular}} 
& KD+PU \citep{feinman2017detecting} 
& 85.96 & 96.80 & 68.05 & 58.72 
& 85.96 & 3.10 & 68.34 & 53.21  \\
&&LID \citep{ma2018characterizing} 
& 98.20 & 99.74 & {\bf 85.14} & 80.05 
& 98.20 & 94.55 & 70.86 & 71.50  \\
&&Mahalanobis (ours) 
& {\bf 99.94} & {\bf 99.78} & 83.41 & {\bf 87.31} 
& {\bf 99.94} & {\bf 99.51} & {\bf 83.42} & {\bf 87.95}  \\ \cline{2-11} 
&\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} CIFAR-100  \end{tabular}} 
& KD+PU \citep{feinman2017detecting} 
& 90.13 & 89.69 & 68.29 & 57.51
& 90.13 & 66.86 & 65.30 & 58.08 \\
&&LID \citep{ma2018characterizing}
& 99.35 & 98.17 & 70.17 & 73.37
& 99.35 & 68.62 & 69.68 & 72.36  \\
&&Mahalanobis (ours) 
& {\bf 99.86} & {\bf 99.17} & {\bf 77.57} & {\bf 87.05} 
& {\bf 99.86} & {\bf 98.27} & {\bf 75.63} & {\bf 86.20}  \\ \cline{2-11} 
&\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} SVHN  \end{tabular}} 
& KD+PU \citep{feinman2017detecting} 
& 86.95 & 82.06 & 89.51 & 85.68
& 86.95 & 83.28 & 84.38 & 82.94 \\
&&LID \citep{ma2018characterizing}
& 99.35 & 94.87 & 91.79 & 94.70 
& 99.35 & 92.21 & 80.14 & 85.09   \\
&&Mahalanobis (ours) 
& {\bf 99.85} & {\bf 99.28} & {\bf 95.10} & {\bf 97.03} 
& {\bf 99.85} & {\bf 99.12} & {\bf 93.47} & {\bf 96.95} \\ \midrule
\multirow{9}{*}{\begin{tabular}[c]{@{}c@{}} ResNet  \end{tabular}} 
&\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} CIFAR-10  \end{tabular}} 
& KD+PU \citep{feinman2017detecting} 
& 81.21 & 82.28 & 81.07 & 55.93
& 83.51 & 16.16 & 76.80 & 56.30\\
&&LID \citep{ma2018characterizing} 
& 99.69 & 96.28 & 88.51 & 82.23
& 99.69 & 95.38 & 71.86 & 77.53 \\
&&Mahalanobis (ours) 
& {\bf 99.94} & {\bf 99.57} & {\bf 91.57} & {\bf 95.84}
& {\bf 99.94} & {\bf 98.91} & {\bf 78.06} & {\bf 93.90} \\ \cline{2-11} 
&\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} CIFAR-100  \end{tabular}} 
& KD+PU \citep{feinman2017detecting} 
& 89.90 & 83.67 & 80.22 & 77.37
& 89.90 & 68.85 & 57.78 & 73.72  \\
&&LID \citep{ma2018characterizing}
& 98.73 & 96.89 & 71.95 & 78.67
& 98.73 & 55.82 & 63.15 & 75.03 \\
&&Mahalanobis (ours) 
& {\bf 99.77} & {\bf 96.90} & {\bf 85.26} & {\bf 91.77}
& {\bf 99.77} & {\bf 96.38} & {\bf 81.95} & {\bf 90.96} \\ \cline{2-11} 
&\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} SVHN  \end{tabular}} 
& KD+PU \citep{feinman2017detecting} 
& 82.67 & 66.19 & 89.71 & 76.57
& 82.67 & 43.21 & {\bf 84.30}  & 67.85  \\
&&LID \citep{ma2018characterizing}
& 97.86 & 90.74 & 92.40 & 88.24 
& 97.86 & 84.88 & 67.28 & 76.58  \\
&&Mahalanobis (ours) 
& {\bf 99.62} & {\bf 97.15} & {\bf 95.73} & {\bf 92.15}
& {\bf 99.62} & {\bf 95.39} & 72.20 & {\bf 86.73} \\\bottomrule
\end{tabular}}
\vspace{+0.05in}
\caption{Comparison of AUROC (\%) under various validation setups. 
For evaluation on unknown attack, FGSM samples denoted by ``seen'' are used for validation.
For our method, we use both feature ensemble and input pre-processing. The best results are indicated in bold.}
\label{tbl:adv_total}
\end{table}

{\bf Comparison with LID and generalization analysis.}
The left-hand column of Table \ref{tbl:adv_total} reports the AUROC score of a logistic regression detectors for all normal and adversarial pairs.
One can note that the proposed method outperforms all tested methods in most cases.
In particular, 
ours improves the AUROC of LID from  to  when we detect CW samples using ResNet trained on the CIFAR-10 dataset.
Similar to \citep{ma2018characterizing}, 
we also evaluate whether the proposed method is tuned on a simple attack can be generalized to detect other more complex attacks.
To this end, we measure the detection performance when we train the logistic regression detector using samples generated by FGSM.
As shown in the right-hand column of Table \ref{tbl:adv_total},
our method trained on FGSM can accurately detect much more complex attacks such as BIM, DeepFool and CW.
Even though LID can also generalize well, our method still outperforms it in most cases.
A natural question that arises is whether the LID can be useful in detecting OOD samples. We indeed compare the performance of our method with that of LID in the supplementary material, where our method still outperforms LID in all tested case.




\subsection{Class-incremental learning}

{\bf Setup.} 
For the task of class-incremental learning, we train ResNet with 34 layers for classifying CIFAR-100 and downsampled ImageNet~\citep{chrabaszcz2017downsampled}.
As described in Section \ref{sec:incrementalsetup}, we assume that a classifier is pre-trained on a certain amount of base classes and new classes with corresponding datasets are incrementally provided one by one.
Specifically, we test two different scenarios:
in the first scenario, half of CIFAR-100 classes are bases classes and the rest are new classes.
In the second scenario, all classes in CIFAR-100 are considered to be base classes and 100 of ImageNet classes are new classes.
All scenarios are tested five times and then averaged.
Class splits are randomly generated for each trial.
For comparison, we consider a softmax classifier, which is fine-tuned whenever new class data come in, and a Euclidean classifier \citep{mensink2013distance}, which tries to accommodate a new class by only computing the class mean.
For the softmax classifier,
we only update the softmax layer to achieve near-zero cost training \citep{mensink2013distance}, and follow the memory management in \citet{rebuffi2017icarl}:
a small number of samples from old classes are kept in the limited memory, where the size of the memory is matched with that for keeping the parameters for Mahalanobis distance-based classifier.
Namely, the number of old exemplars kept for training the softmax classifier is chosen as the sum of the number of learned classes and the dimension ( in our experiments) of the hidden features. For evaluation, similar to \citep{lee2018hierarchical}, we first draw base-new class accuracy curve by adjusting an additional bias to the new class scores, and measure the area under curve (AUC) since averaging base and new class accuracy may cause an imbalanced measure of the performance between base and new classes.



\begin{figure*} [t] \centering\setlength{\tabcolsep}{0cm}
\subfigure[Base: half of CIFAR-100 / New: the other half]
{
\begin{tabular}{@{}cccc@{}}
    \includegraphics[width=.24\textwidth]{c50_c50_history.pdf} 
    \includegraphics[width=.24\textwidth]{c50_c50_roc.pdf} 
\end{tabular}\label{fig:incremental_c50_c50}} 
\subfigure[Base: CIFAR-100 / New: ImageNet]
{
\begin{tabular}{@{}cccc@{}}
    \includegraphics[width=.24\textwidth]{c100_IMAGE_history.pdf} 
    \includegraphics[width=.24\textwidth]{c100_IMAGE_roc.pdf} 
\end{tabular}\label{fig:incremental_c100_c10}} 
\caption{Experimental results of class-incremental learning on CIFAR-100 and ImageNet datasets.
In each experiment,
we report (left) AUC with respect to the number of learned classes and, 
(right) the base-new class accuracy curve after the last new classes is added.}
\label{fig:incremental}
\end{figure*}

{\bf Comparison with other classifiers.}
Figure~\ref{fig:incremental} compares the incremental learning performance of methods in terms of AUC in the two scenarios mentioned above.
In each sub-figure, AUC with respect to the number of learned classes (left) and the base-new class accuracy curve after the last new classes is added (right) are drawn.
Our proposed Mahalanobis distance-based classifier outperforms the other methods by a significant margin, as the number of new classes increases,
although there is a crossing in the right figure of Figure \ref{fig:incremental_c100_c10} in small regimes (due to the catastrophic forgetting issue).
In particular, the AUC of our proposed method is
40.0\% (22.1\%), which is better than
32.7\% (15.6\%) of the softmax classifier and
32.9\% (17.1\%) of the Euclidean distance classifier after all new classes are added in the first (second) experiment.
We also report the experimental results in the supplementary material for the case when classes of CIFAR-100 are base classes and those of CIFAR-10 are new classes, where the overall trend is similar.
The experimental results additionally demonstrate the superiority of our confidence score, compared to other plausible ones.









\section{Conclusion} \label{sec:conclusion}

In this paper, we propose a simple yet effective method for detecting abnormal test samples including both out-of-distribution and adversarial ones.
In essence, our main idea is inducing a generative classifier under LDA assumption, and defining new confidence score based on it.
With calibration techniques such as input pre-processing and feature ensemble, 
our method performs very strongly across multiple tasks: detecting out-of-distribution samples, detecting adversarial attacks and class-incremental learning.
We also found that our proposed method is more robust in the choice of its hyperparameters as well as against extreme scenarios, e.g., when the training dataset has some noisy, random labels or a small number of data samples.
We believe that our approach have a potential to apply to many other related machine learning tasks, e.g., 
active learning \citep{gal2017deep}, ensemble learning \citep{lee2017confident} and few-shot learning~\citep{vinyals2016matching}.


\subsubsection*{Acknowledgements} 
This work was supported in part by Institute for Information \& communications Technology Promotion (IITP) grant funded by the Korea government (MSIT) (No.R0132-15-1005, Content visual browsing technology in the online and offline environments), National Research Council of Science \& Technology (NST) grant by the Korea government (MSIP) (No. CRC-15-05-ETRI), DARPA Explainable AI (XAI) program \#313498, Sloan Research Fellowship, and Kwanjeong Educational Foundation Scholarship.


\bibliography{icml_main}
\bibliographystyle{icml2018}
\appendix


\onecolumn
\clearpage
\begin{center}{\bf {\LARGE Supplementary Material:}}
\end{center}
\begin{center}{\bf {\Large A Simple Unified Framework for Detecting Out-of-Distribution Samples and Adversarial Attacks}}
\end{center}

\section{Preliminaries for Gaussian discriminant analysis} \label{sec:preliminaries}

In this section, we describe the basic concept of the discriminative and generative classifier \citep{murphy2012machine}.
Formally, denote the random variable of the input and label as  and , respectively.
For the classification task,
the discriminative classifier directly defines a posterior distribution , i.e., learning a direct mapping between input  and label . A popular model for discriminative classifier is softmax classifier which defines the posterior distribution as follows:
 
where  and  are weights and bias for a class , respectively. 
\iffalse
\textcolor{blue}{
We remark that the softmax classifier with DNNs has become a standard in various classification tasks \citep{he2016deep, amodei2016deep} since it shows the state-of-the-art performance.}
\fi
In contrast to the discriminative classifier, the generative classifier defines the class conditional distribution  and class prior  in order to indirectly define the posterior distribution by specifying the joint distribution .
Gaussian discriminant analysis (GDA) is a popular method to define the generative classifier by assuming that
the class conditional distribution follows the multivariate Gaussian distribution and the class prior follows Bernoulli distribution:

where  and  are the mean and covariance of multivariate Gaussian distribution, and  is the unnormalized prior for class .
This classifier has been studied in various machine learning areas (e.g., semi-supervised learning \citep{lasserre2006principled} and incremental learning \citep{rebuffi2017icarl}).

In this paper, we focus on the special case of GDA, also known as the linear discriminant analysis (LDA). In addition to Gaussian assumption, LDA further assumes that all classes share the same covariance matrix, i.e., . 
Since the quadratic term is canceled out with this assumption,
the posterior distribution of generative classifier can be represented as follows:

One can note that the above form of posterior distribution is equivalent to the softmax classifier by considering  and  as weight and bias of it, respectively. This implies that  might be fitted in Gaussian distribution during training a softmax classifier.

\section{Experimental setup} \label{appendix:exp_setup}

In this section, we describe detailed explanation about all the experiments described in Section \ref{sec:exp}.

\subsection{Experimental setups in detecting out-of-distribution} \label{appendix:exp_setup_OOD}


{\bf Detailed model architecture and training.}
We consider two state-of-the-art neural network architectures: DenseNet \citep{huang2017densely} and ResNet \citep{he2016deep}.
For DenseNet, our model follows the same setup as in \citet{huang2017densely}: 100 layers, growth rate  and dropout rate 0.
Also, we use ResNet with 34 layers and dropout rate 0.\footnote{ResNet architecture is available at \url{https://github.com/kuangliu/pytorch-cifar}.}
The softmax classifier is used, and each model is trained by minimizing the cross-entropy loss using SGD with Nesterov momentum. 
Specifically, we train DenseNet for 300 epochs with batch size 64 and momentum 0.9. 
For ResNet, we train it for 200 epochs with batch size 128 and momentum 0.9. 
The learning rate starts at 0.1 and is dropped by a factor of 10 at 50\% and 75\% of the training progress, respectively.
The test set errors of DenseNet and ResNet on CIFAR-10, CIFAR-100 and SVHN are reported in Table \ref{tbl:adv_static}.


\noindent {\bf Datasets.} 
We train DenseNet and ResNet for classifying CIFAR-10 (or 100) and SVHN datasets: the former consists of 50,000 training and 10,000 test
images with 10 (or 100) image classes, and the latter consists of 73,257 training and 26,032 test images with 10 digits.\footnote{We do not use the extra SVHN dataset for training.} 
The corresponding test dataset is used as the in-distribution (positive) samples to measure the performance. 
We use realistic images as the out-of-distribution (negative) samples: the TinyImageNet consists of 10,000 test images with 200 image classes from a subset of ImageNet images. The LSUN consists of 10,000 test images of 10 different scenes. We downsample each image of TinyImageNet and LSUN to size .\footnote{LSUN and TinyImageNet datasets are available at \url{https://github.com/ShiyuLiang/odin-pytorch}.}

{\bf Tested methods.}
In this paper, 
we consider the baseline method \citep{hendrycks2016baseline} and ODIN \citep{liang2017principled} for comparison.
The confidence score in \citet{hendrycks2016baseline} is a maximum value of softmax posterior distribution, i.e., .
The key idea of ODIN is the temperature scaling which is defined as follows:

where  is the temperature scaling parameter and  is final feature vector of deep neural networks.
For each data , ODIN first calculates the pre-processed image  by adding the small perturbations as follows:

where  is a magnitude of noise and  is the predicted label.
Next, ODIN feeds the pre-processed data into the classifier, computes the maximum value of scaled predictive distribution, i.e., , and classifies it as positive (i.e., in-distribution) if the confidence score is above some threshold .
For ODIN, the perturbation noise  is chosen from , and the temperature  is chosen from .

{\bf Hyper parameters for our method.} 
There are two hyper parameters in our method: the magnitude of noise in \eqref{eq:input_pre} and layer indexes for feature ensemble.
For all experiments, we extract the confidence scores from every end of dense (or residual) block of DenseNet (or ResNet).
The size of feature maps on each convolutional layers is reduced by average pooling for computational efficiency: , where  is the number of channels and  is the spatial dimension.
The magnitude of noise in \eqref{eq:input_pre} is chosen from . 

{\bf Performance metrics.} For evaluation, we measure the following metrics to measure the effectiveness of the confidence scores in distinguishing in- and out-of-distribution images.
\begin{itemize}
\item {\bf True negative rate (TNR) at 95\% true positive rate (TPR).} Let TP, TN, FP, and FN denote true positive, true negative, false positive and false negative, respectively. We measure TNR = TN / (FP+TN), when TPR = TP / (TP+FN) is 95\%. 
\item {\bf Area under the receiver operating characteristic curve (AUROC).} The ROC curve is a graph plotting TPR against the false positive rate = FP / (FP+TN) by varying a threshold. 
\item {\bf Area under the precision-recall curve (AUPR).} The PR curve is a graph plotting the precision = TP / (TP+FP) against recall = TP / (TP+FN) by varying a threshold. AUPR-IN (or -OUT) is AUPR where in- (or out-of-) distribution samples are specified as positive.
\item {\bf Detection accuracy.} This metric corresponds to the maximum classification probability over all possible thresholds :

where  is a confident score. 
We assume that both positive and negative examples have equal probability of appearing in the test set, i.e., . 
\end{itemize}
Note that AUROC, AUPR and detection accuracy are threshold-independent evaluation metrics.

\subsection{Experimental setups in detecting adversarial samples} \label{appendix:exp_setup_adver}

{\bf Adversarial attacks.} For the problem of detecting adversarial samples, we consider the following attack methods: fast gradient sign method (FGSM) \citep{goodfellow2014explaining}, basic iterative method (BIM) \citep{kurakin2016adversarial}, DeepFool \citep{moosavi2016deepfool} and Carlini-Wagner (CW) \citep{carlini2017adversarial}. 
The FGSM directly perturbs normal input in the direction of the loss gradient. 
Formally, non-targeted adversarial examples are constructed as

where  is a magnitude of noise,  is the ground truth label and  is a loss function to measure the distance between the prediction and the ground truth.
The BIM is an iterative version of FGSM, which applies FGSM multiple times with a smaller step size.
Formally, non-targeted adversarial examples are constructed as

where  means we clip the resulting image to be within the -ball of .
DeepFool works by finding the closest adversarial examples with geometric formulas. CW is an optimization-based method which arguably the most effective method.
Formally, non-targeted adversarial examples are constructed as

where  is penalty parameter and  is a metric to quantify the distance between an original image and its adversarial counterpart.
However, compared
to FGSM and BIM, this method is much slower in practice.
For all experiments,  distance is used as a constraint. We used the library from FaceBook \citep{guo2017countering} for generating adversarial samples.\footnote{The code is available at \url{https://github.com/facebookresearch/adversarial_image_defenses}.} Table \ref{tbl:adv_static} tatistics of adversarial attacks including the  mean perturbation and classification accuracy on adversarial attacks.


\begin{table}[t]
\centering
\begin{tabular}{cc|cccccccccccc}
\toprule
 & & \multicolumn{2}{c|}{CIFAR-10} & \multicolumn{2}{c|}{CIFAR-100} & \multicolumn{2}{c}{SVHN}\\
&     &  & \multicolumn{1}{l|}{Acc.} &  & \multicolumn{1}{l|}{Acc.} &      & Acc.    \\ \midrule
\multirow{5}{*}{DenseNet} &Clean   
& 0 & \multicolumn{1}{c|}{95.19\%}  
& 0 & \multicolumn{1}{c|}{77.63\%}  
& 0 & 96.38\%      
\\ 
&FGSM
& 0.21  & \multicolumn{1}{c|}{20.04\%}  
& 0.21 & \multicolumn{1}{c|}{4.86\%}  
& 0.21 & 56.27\%   
\\
&BIM
& 0.22 & \multicolumn{1}{c|}{0.00\%}  
& 0.22 & \multicolumn{1}{c|}{0.02\%}  
& 0.22 & 0.67\%      
\\
&DeepFool 
& 0.30 & \multicolumn{1}{c|}{0.23\%}  
& 0.25 & \multicolumn{1}{c|}{0.23\%}  
& 0.57 & 0.50\%       
\\
&CW 
& 0.05 & \multicolumn{1}{c|}{0.10\%}  
& 0.03 & \multicolumn{1}{c|}{0.16\%}  
& 0.12 &  0.54\%
\\\midrule
\multirow{5}{*}{ResNet} &Clean   
& 0  & \multicolumn{1}{c|}{93.67\%}  
& 0  & \multicolumn{1}{c|}{78.34\%}  
& 0  & 96.68\%
\\ 
&FGSM
& 0.25  & \multicolumn{1}{c|}{23.98\%}  
& 0.25 & \multicolumn{1}{c|}{11.67\%}  
& 0.25 & 49.33\%
\\
&BIM
& 0.26 & \multicolumn{1}{c|}{0.02\%}  
& 0.26  & \multicolumn{1}{c|}{0.21\%}  
& 0.26 & 2.37\%  
\\
&DeepFool 
& 0.36 & \multicolumn{1}{c|}{0.33\%}  
& 0.27 & \multicolumn{1}{c|}{0.37\%}  
& 0.62 &  13.20\%     
\\
&CW 
& 0.08  & \multicolumn{1}{c|}{0.00\%}  
& 0.08 & \multicolumn{1}{c|}{0.01\%}  
& 0.15 & 0.04\% 
\\\bottomrule
\end{tabular}
\vspace{0.1in}
\caption{The  mean perturbation and classification accuracy on clean and adversarial samples.}
\label{tbl:adv_static}
\end{table}

\iffalse
\begin{table}[t]
\centering
\begin{tabular}{cc|cccccccccccc}
\toprule
 & & \multicolumn{2}{c|}{CIFAR-10} & \multicolumn{2}{c|}{CIFAR-100} & \multicolumn{2}{c}{SVHN}\\
&     &  & \multicolumn{1}{l|}{Acc.} &  & \multicolumn{1}{l|}{Acc.} &      & Acc.    \\ \midrule
\multirow{5}{*}{DenseNet} &Clean   
& 0 & \multicolumn{1}{c|}{95.19\%}  
& 0 & \multicolumn{1}{c|}{77.63\%}  
& 0 & 96.38\%      
\\ 
&FGSM
& 0.21  & \multicolumn{1}{c|}{20.04\%}  
& 0.21 & \multicolumn{1}{c|}{4.86\%}  
& 0.21 & 56.27\%   
\\
&BIM
& 0.49 & \multicolumn{1}{c|}{0.00\%}  
& 0.49 & \multicolumn{1}{c|}{0.00\%}  
& 0.49 & 0.00\%      
\\
&DeepFool 
& 0.37 & \multicolumn{1}{c|}{0.28\%}  
& 2.21 & \multicolumn{1}{c|}{0.48\%}  
& 0.83 & 0.59\%       
\\
&CW 
& 0.05 & \multicolumn{1}{c|}{0.10\%}  
& 0.04 & \multicolumn{1}{c|}{0.16\%}  
& 0.12 &  0.54\%
\\\midrule
\multirow{5}{*}{ResNet} &Clean   
& 0  & \multicolumn{1}{c|}{93.67\%}  
& 0  & \multicolumn{1}{c|}{78.34\%}  
& 0  & 96.68\%
\\ 
&FGSM
& 0.25  & \multicolumn{1}{c|}{23.98\%}  
& 0.25 & \multicolumn{1}{c|}{11.67\%}  
& 0.25 & 49.33 \%
\\
&BIM
& 0.61 & \multicolumn{1}{c|}{0.00\%}  
& 0.61  & \multicolumn{1}{c|}{0.00\%}  
& 0.61 & 0.01\%  
\\
&DeepFool 
& 1.46 & \multicolumn{1}{c|}{0.55\%}  
& 4.01 & \multicolumn{1}{c|}{0.87\%}  
& 2.95 &  1.55\%     
\\
&CW 
& 0.09  & \multicolumn{1}{c|}{0.00\%}  
& 0.10 & \multicolumn{1}{c|}{0.00\%}  
& 0.16 & 0.04\% 
\\\bottomrule
\end{tabular}
\vspace{0.1in}
\caption{\textcolor{red}{new}The  mean perturbation and classification accuracy on clean and adversarial samples.}
\label{tbl:adv_static}
\end{table}
\fi


{\bf Tested methods.} \citet{ma2018characterizing} proposed to characterize adversarial subspaces by using local intrinsic dimensionality (LID). Given a test sample ,
LID is defined as follows:

where  denotes the distance between  and its -th nearest neighbor within a sample of points drawn from in-distribution, and  denotes the maximum distance among  nearest neighbors.
We commonly extract the LID scores from every end of dense (or residual) block of DenseNet (or ResNet) similar to ours.
Given test sample  and the set  of training samples with label ,
the Gaussian kernel density with bandwidth  is defined as follows:

where .
For LID and KD, we used the library from \citet{ma2018characterizing}.

{\bf Hyper-parameters and training.} Following the similar strategies in \citep{feinman2017detecting, ma2018characterizing},
we randomly choose 10\% of original test samples for training the logistic regression detectors and the remaining test samples are used for evaluation.
The training sets consists of three types of examples: adversarial, normal and noisy.
Here, noisy examples are generated by adding random noise to normal examples.
Using nested cross validation within the training set, all hyper-parameters including the bandwidth parameter for KD, the number of nearest neighbors for LID, and input noise for our method are tuned. 
Specifically, the value of  is chosen from  with respect to a minibatch of size 100, and the bandwidth was chosen from .
The magnitude of noise in \eqref{eq:input_pre} is chosen from . 

\section{More experimental results} \label{appendix:exp_results}

In this section, we provide more experimental results.


\subsection{Robustness of our method in detecting adversarial samples} \label{appendix:robust_lid}

In order to verify the robustness, we measure the detection performance when we train ResNet by varying the number of training data and assigning random label to training data on CIFAR-10 dataset. As shown in Figure \ref{fig:resnet_c10_small_adv}, our method (blue bar) outperforms LID (green bar) for all experiments.

\begin{figure*} [t] \centering
\subfigure[Small training data: the x-axis represents the number of training data]
{
\begin{tabular}{@{}cccc@{}}
\includegraphics[width=0.9\textwidth]{legend_small_adv.pdf}\vspace{-0.1in} \\
  \includegraphics[width=.24\textwidth]{ResNet_C10_FGSM_SMALL.pdf} 
  \includegraphics[width=.24\textwidth]{ResNet_C10_BIM_SMALL.pdf} 
  \includegraphics[width=.24\textwidth]{ResNet_C10_DeepFool_SMAL.pdf} 
  \includegraphics[width=.24\textwidth]{ResNet_C10_CW_SMAL.pdf} 
\end{tabular}\label{fig:resnet_c10_small_label_adv}} 
\vspace{-0.1in}
\,
\subfigure[Noisy training data: the x-axis represents the percentage of training data with random label]
{\begin{tabular}{@{}cccc@{}}
  \includegraphics[width=.24\textwidth]{ResNet_C10_Noise_Label_FGSM.pdf} 
  \includegraphics[width=.24\textwidth]{ResNet_C10_Noise_Label_BIM.pdf} 
  \includegraphics[width=.24\textwidth]{ResNet_C10_Noise_Label_DeepFool.pdf} 
  \includegraphics[width=.24\textwidth]{ResNet_C10_Noise_Label_CWL2.pdf} 
\end{tabular}\label{fig:resnet_c10_noise_label_adv}}
\vspace{-0.1in}
\caption{Comparison of AUROC (\%) under different training data. To evaluate the robustness of proposed method, we train ResNet (a) by varying the number of training data and (b) assigning random label to training data on CIFAR-10 dataset.}
\label{fig:resnet_c10_small_adv}
\end{figure*}



\begin{figure*} [t] \centering\setlength{\tabcolsep}{0cm}
\subfigure[Base: CIFAR-100 / New: CIFAR-10]
{
\begin{tabular}{@{}cccc@{}}
  \includegraphics[width=.24\textwidth]{c100_c10_history.pdf} 
  \includegraphics[width=.24\textwidth]{c100_c10_roc.pdf} 
\end{tabular}\label{fig:increddal}} 
\caption{Experimental results of class-incremental learning on CIFAR-100 and CIFAR-10 datasets.
We report (left) AUC with respect to the number of learned classes and, 
(right) the base-new class accuracy curve after the last new classes is added.}
\label{fig:increme}
\end{figure*}

\subsection{Class-incremental learning} \label{appendix:LIfddfOD}

Figure \ref{fig:increme} compares the AUCs of tested methods when CIFAR-100 is pre-trained and CIFAR-10 is used as new classes.
Our proposed Mahalanobis distance-based classifier outperforms the other methods by a significant margin, as the number of new classes increases.
The AUC of our proposed method is
47.7\%, which is better than
41.0\% of the softmax classifier and
43.0\% of the Euclidean distance classifier after all new classes are added.



\subsection{Experimental results on joint confidence loss} \label{sec:joint_conf_loss}


In addition, we remark that the proposed detector using softmax neural classifier trained by standard cross entropy loss typically outperforms the ODIN detector using softmax neural classifier trained by confidence loss \citep{lee2017confident} which involves jointly training a generator and a classifier to calibrate the posterior distribution. Also, our detector provides further improvement if one use it with model trained by confidence loss. In other words, our proposed method can improve any pre-trained softmax neural classifier.



\begin{figure*} [h] \centering
\subfigure[In-distribution: CIFAR-10]
{
\begin{tabular}{@{}cccc@{}}
\includegraphics[width=0.9\textwidth]{legend_odin_nips.pdf} \\
  \includegraphics[width=.32\textwidth]{T_VGG_CIFAR_SVHN.pdf} 
  \includegraphics[width=.32\textwidth]{T_VGG_CIFAR_IMAGE.pdf} 
  \includegraphics[width=.32\textwidth]{T_VGG_CIFAR_LSUN.pdf}
\end{tabular}\label{fignew:a}} 
\vspace{-0.1in}
\,
\subfigure[In-distribution: SVHN]
{\begin{tabular}{@{}cccc@{}}
  \includegraphics[width=.32\textwidth]{T_VGG_SVHN_CIFAR.pdf} 
  \includegraphics[width=.32\textwidth]{T_VGG_SVHN_IMAGE.pdf} 
  \includegraphics[width=.32\textwidth]{T_VGG_SVHN_LSUN.pdf} 
\end{tabular}\label{fignew:b}}
\vspace{-0.1in}
\caption{
Performances of the baseline detector \citep{hendrycks2016baseline}, ODIN detector \citep{liang2017principled} and Mahalanobis detector under various training losses.}
\label{fignew}
\end{figure*}



\subsection{Comparison with ODIN} \label{sec:full}

\begin{table}[h] 
\centering
\resizebox{0.93\columnwidth}{!}{
\begin{tabular}{@{}ccclclclll@{}}
\toprule
\multirow{2}{*}{\begin{tabular}[c]{@{}c@{}} In-dist \\ (model) \end{tabular}}
 & \multirow{2}{*}{\begin{tabular}[c]{@{}c@{}} Out-of-dist\end{tabular}}
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} TNR at TPR 95\% \end{tabular}}
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} AUROC \end{tabular}}
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} Detection accuracy \end{tabular}} 
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} AUPR in \end{tabular}} 
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} AUPR out \end{tabular}} \\\cline{3-7}  
\multicolumn{1}{c}{} & \multicolumn{1}{c}{} & \multicolumn{5}{c}{ Baseline \citep{hendrycks2016baseline} / ODIN \citep{liang2017principled} / Mahalanobis (ours)} \\ \midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} CIFAR-10 \DenseNet) \end{tabular}} 
& \multicolumn{1}{c}{SVHN} 
& \multicolumn{1}{c}{26.7 / 70.6 / {\bf 82.5}}
& \multicolumn{1}{c}{82.7 / 93.8 / {\bf 97.2}}
& \multicolumn{1}{c}{75.6 / 86.6 / {\bf 91.5}}
& \multicolumn{1}{c}{74.3 / 87.1 / {\bf 94.8}}
& \multicolumn{1}{c}{91.0 / 97.3 / {\bf 98.8}}\\
& \multicolumn{1}{c}{TinyImageNet} 
& \multicolumn{1}{c}{17.6 / 42.6 / {\bf 86.6}}
& \multicolumn{1}{c}{71.7 / 85.2 / {\bf 97.4}}
& \multicolumn{1}{c}{65.7 / 77.0 / {\bf 92.2}}
& \multicolumn{1}{c}{74.2 / 85.6 / {\bf 97.6}}
& \multicolumn{1}{c}{69.0 / 84.5 / {\bf 97.2}}\\
& \multicolumn{1}{c}{LSUN} 
& \multicolumn{1}{c}{16.7 / 41.2 / {\bf 91.4}}
& \multicolumn{1}{c}{70.8 / 85.5 / {\bf 98.0}}
& \multicolumn{1}{c}{64.9 / 77.1 / {\bf 93.9}}
& \multicolumn{1}{c}{74.1 / 86.4 / {\bf 98.2}}
& \multicolumn{1}{c}{67.9 / 84.2 / {\bf 97.5}}\\ \midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} SVHN \ResNet) \end{tabular}} 
& \multicolumn{1}{c}{SVHN} 
& \multicolumn{1}{c}{32.5 / 86.6 / {\bf 96.4}}
& \multicolumn{1}{c}{89.9 / 96.7 / {\bf 99.1}}
& \multicolumn{1}{c}{85.1 / 91.1 / {\bf 95.8}}
& \multicolumn{1}{c}{85.4 / 92.5 / {\bf 98.3}}
& \multicolumn{1}{c}{94.0 / 98.5 / {\bf 99.6}}\\
& \multicolumn{1}{c}{TinyImageNet} 
& \multicolumn{1}{c}{44.7 / 72.5 / {\bf 97.1}}
& \multicolumn{1}{c}{91.0 / 94.0 / {\bf 99.5}}
& \multicolumn{1}{c}{85.1 / 86.5 / {\bf 96.3}}
& \multicolumn{1}{c}{92.5 / 94.2 / {\bf 99.5}}
& \multicolumn{1}{c}{88.4 / 94.1 / {\bf 99.5}}\\
& \multicolumn{1}{c}{LSUN} 
& \multicolumn{1}{c}{45.4 / 73.8 / {\bf 98.9}}
& \multicolumn{1}{c}{91.0 / 94.1 / {\bf 99.7}}
& \multicolumn{1}{c}{85.3 / 86.7 / {\bf 97.7}}
& \multicolumn{1}{c}{92.5 / 94.2 / {\bf 99.7}}
& \multicolumn{1}{c}{88.6 / 94.3 / {\bf 99.7}}\\ \midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} CIFAR-100 \ResNet) \end{tabular}} 
& \multicolumn{1}{c}{CIFAR-10} 
& \multicolumn{1}{c}{78.3 / 79.8 / {\bf 98.4}}
& \multicolumn{1}{c}{92.9 / 92.1 / {\bf 99.3}}
& \multicolumn{1}{c}{90.0 / 89.4 / {\bf 96.9}}
& \multicolumn{1}{c}{95.1 / 94.0 / {\bf 99.7}}
& \multicolumn{1}{c}{85.7 / 86.8 / {\bf 97.0}}\\
& \multicolumn{1}{c}{TinyImageNet} 
& \multicolumn{1}{c}{79.0 / 82.1 / {\bf 99.9}}
& \multicolumn{1}{c}{93.5 / 92.0 / {\bf 99.9}}
& \multicolumn{1}{c}{90.4 / 89.4 / {\bf 99.1}}
& \multicolumn{1}{c}{95.7 / 93.9 / {\bf 99.9}}
& \multicolumn{1}{c}{86.2 / 88.1 / {\bf 99.1}}\\
& \multicolumn{1}{c}{LSUN} 
& \multicolumn{1}{c}{74.3 / 77.3 / {\bf 99.9}}
& \multicolumn{1}{c}{91.6 / 89.4 / {\bf 99.9}}
& \multicolumn{1}{c}{89.0 / 87.2 / {\bf 99.5}}
& \multicolumn{1}{c}{94.2 / 92.1 / {\bf 99.9}}
& \multicolumn{1}{c}{84.0 / 85.5 / {\bf 99.1}}\\ 
\bottomrule
\end{tabular}}
\vspace{+0.02in}
\caption{Distinguishing in- and out-of-distribution test set data for image classification.
We tune the hyper-parameters using validation set of in- and out-of-distributions. 
All values are percentages and the best results are indicated in bold.}
\label{tbl:out_main}
\end{table}


\begin{table}[h] 
\centering
\resizebox{0.93\columnwidth}{!}{
\begin{tabular}{@{}ccclclclll@{}}
\toprule
\multirow{2}{*}{\begin{tabular}[c]{@{}c@{}} In-dist \\ (model) \end{tabular}}
 & \multirow{2}{*}{\begin{tabular}[c]{@{}c@{}} Out-of-dist\end{tabular}}
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} TNR at TPR 95\% \end{tabular}}
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} AUROC \end{tabular}}
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} Detection accuracy \end{tabular}} 
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} AUPR in \end{tabular}} 
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} AUPR out \end{tabular}} \\\cline{3-7}  
\multicolumn{1}{c}{} & \multicolumn{1}{c}{} & \multicolumn{5}{c}{ Baseline \citep{hendrycks2016baseline} / ODIN \citep{liang2017principled} / Mahalanobis (ours)} \\ \midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} CIFAR-10 \DenseNet) \end{tabular}} 
& \multicolumn{1}{c}{SVHN} 
& \multicolumn{1}{c}{26.7 / 39.8 / {\bf 62.2}}
& \multicolumn{1}{c}{82.7 / 88.2 / {\bf 91.8}}
& \multicolumn{1}{c}{75.6 / 80.7 / {\bf 84.6}}
& \multicolumn{1}{c}{74.3 / 80.8 / {\bf 82.6}}
& \multicolumn{1}{c}{91.0 / 94.0 / {\bf 95.8}}\\
& \multicolumn{1}{c}{TinyImageNet} 
& \multicolumn{1}{c}{17.6 / 43.2 / {\bf 87.2}}
& \multicolumn{1}{c}{71.7 / 85.3 / {\bf 97.0}}
& \multicolumn{1}{c}{65.7 / 77.2 / {\bf 91.8}}
& \multicolumn{1}{c}{74.2 / 85.8 / {\bf 96.2}}
& \multicolumn{1}{c}{69.0 / 84.7 / {\bf 97.1}}\\
& \multicolumn{1}{c}{LSUN} 
& \multicolumn{1}{c}{16.7 / 42.1 / {\bf 91.4}}
& \multicolumn{1}{c}{70.8 / 85.7 / {\bf 97.9}}
& \multicolumn{1}{c}{64.9 / 77.3 / {\bf 93.8}}
& \multicolumn{1}{c}{74.1 / 86.7 / {\bf 98.1}}
& \multicolumn{1}{c}{67.9 / 84.6 / {\bf 97.6}}\\ \midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} SVHN \ResNet) \end{tabular}} 
& \multicolumn{1}{c}{SVHN} 
& \multicolumn{1}{c}{32.5 / 40.3 / {\bf 75.8}}
& \multicolumn{1}{c}{89.9 / 86.5 / {\bf 95.5}}
& \multicolumn{1}{c}{85.1 / 77.8 / {\bf 89.1}}
& \multicolumn{1}{c}{85.4 / 77.8 / {\bf 91.0}}
& \multicolumn{1}{c}{94.0 / 93.7 / {\bf 98.0}}\\
& \multicolumn{1}{c}{TinyImageNet} 
& \multicolumn{1}{c}{44.7 / 69.6 / {\bf 95.5}}
& \multicolumn{1}{c}{91.0 / 93.9 / {\bf 99.0}}
& \multicolumn{1}{c}{85.1 / 86.0 / {\bf 95.4}}
& \multicolumn{1}{c}{92.5 / 94.3 / {\bf 98.6}}
& \multicolumn{1}{c}{88.4 / 93.7 / {\bf 99.1}}\\
& \multicolumn{1}{c}{LSUN} 
& \multicolumn{1}{c}{45.4 / 70.0 / {\bf 98.1}}
& \multicolumn{1}{c}{91.0 / 93.7 / {\bf 99.5}}
& \multicolumn{1}{c}{85.3 / 85.8 / {\bf 97.2}}
& \multicolumn{1}{c}{92.5 / 94.1 / {\bf 99.5}}
& \multicolumn{1}{c}{88.6 / 93.6 / {\bf 99.5}}\\ \midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} CIFAR-100 \ResNet) \end{tabular}} 
& \multicolumn{1}{c}{CIFAR-10} 
& \multicolumn{1}{c}{78.3 / 79.8 / {\bf 94.1}}
& \multicolumn{1}{c}{92.9 / 92.1 / {\bf 97.6}}
& \multicolumn{1}{c}{90.0 / 89.4 / {\bf 94.6}}
& \multicolumn{1}{c}{95.1 / 94.0 / {\bf 98.1}}
& \multicolumn{1}{c}{85.7 / 86.8 / {\bf 94.7}}\\
& \multicolumn{1}{c}{TinyImageNet} 
& \multicolumn{1}{c}{79.0 / 80.5 / {\bf 99.2}}
& \multicolumn{1}{c}{93.5 / 92.9 / {\bf 99.3}}
& \multicolumn{1}{c}{90.4 / 90.1 / {\bf 98.8}}
& \multicolumn{1}{c}{95.7 / 94.8 / {\bf 98.8}}
& \multicolumn{1}{c}{86.2 / 87.5 / {\bf 98.3}}\\
& \multicolumn{1}{c}{LSUN} 
& \multicolumn{1}{c}{74.3 / 76.3 / {\bf 99.9}}
& \multicolumn{1}{c}{91.6 / 90.7 / {\bf 99.9}}
& \multicolumn{1}{c}{89.0 / 88.2 / {\bf 99.5}}
& \multicolumn{1}{c}{94.2 / 93.0 / {\bf 99.9}}
& \multicolumn{1}{c}{84.0 / 85.0 / {\bf 98.8}}\\ 
\bottomrule
\end{tabular}}
\vspace{+0.02in}
\caption{Distinguishing in- and out-of-distribution test set data for image classification when we tune the hyper-parameters of ODIN and our method only using in-distribution and adversarial (FGSM) samples. All values are percentages and boldface values indicate relative the better results.}
\label{tbl:out_val_out_candidate3}
\end{table}





\subsection{LID for detecting out-of-distribution samples} \label{appendix:LID_OOD}


Figure \ref{fig:odin_lid_our_resnet} and \ref{fig:odin_lid_our_densenet} shows the performance of the ODIN \citep{liang2017principled}, LID \citep{ma2018characterizing} and Mahalanobis detector for each in- and out-of-distribution pair. We remark that the proposed method outperforms all tested methods.

\begin{figure*} [h] \centering
\subfigure[In-distribution: CIFAR-10]
{
\begin{tabular}{@{}cccc@{}}
\includegraphics[width=0.9\textwidth]{legend.pdf}\vspace{-0.1in} \\
  \includegraphics[width=.28\textwidth]{ResNet_C10_SVHN.pdf} 
  \includegraphics[width=.28\textwidth]{ResNet_C10_LSUN.pdf} 
  \includegraphics[width=.28\textwidth]{ResNet_C10_IMAGE.pdf} 
\end{tabular}\label{fig:odin_lid_our_resnet_c10}} 
\vspace{-0.1in}
\,
\subfigure[In-distribution: CIFAR-100]
{\begin{tabular}{@{}cccc@{}}
  \includegraphics[width=.28\textwidth]{ResNet_C100_SVHN.pdf} 
  \includegraphics[width=.28\textwidth]{ResNet_C100_LSUN.pdf} 
  \includegraphics[width=.28\textwidth]{ResNet_C100_IMAGE.pdf} 
\end{tabular}\label{fig:odin_lid_our_resnet_c100}}
\,
\subfigure[In-distribution: SVHN]
{\begin{tabular}{@{}cccc@{}}
  \includegraphics[width=.28\textwidth]{ResNet_SVHN_C10.pdf} 
  \includegraphics[width=.28\textwidth]{ResNet_SVHN_LSUN.pdf} 
  \includegraphics[width=.28\textwidth]{ResNet_SVHN_IMAGE.pdf} 
\end{tabular}\label{fig:odin_lid_our_resnet_svhn}}
\vspace{-0.1in}
\caption{Distinguishing in- and out-of-distribution test set data for image classification using ResNet.}
\label{fig:odin_lid_our_resnet}
\end{figure*}

\begin{figure*} [h] \centering
\subfigure[In-distribution: CIFAR-10]
{
\begin{tabular}{@{}cccc@{}}
\includegraphics[width=0.9\textwidth]{legend.pdf}\vspace{-0.1in} \\
  \includegraphics[width=.28\textwidth]{DenseNet_C10_SVHN.pdf} 
  \includegraphics[width=.28\textwidth]{DenseNet_C10_LSUN.pdf} 
  \includegraphics[width=.28\textwidth]{DenseNet_C10_IMAGE.pdf} 
\end{tabular}\label{fig:odin_lid_our_densenet_c10}} 
\vspace{-0.1in}
\,
\subfigure[In-distribution: CIFAR-100]
{\begin{tabular}{@{}cccc@{}}
  \includegraphics[width=.28\textwidth]{DenseNet_C100_SVHN.pdf} 
  \includegraphics[width=.28\textwidth]{DenseNet_C100_LSUN.pdf} 
  \includegraphics[width=.28\textwidth]{DenseNet_C100_IMAGE.pdf} 
\end{tabular}\label{fig:odin_lid_our_densenet_c100}}
\,
\subfigure[In-distribution: SVHN]
{\begin{tabular}{@{}cccc@{}}
  \includegraphics[width=.28\textwidth]{DenseNet_SVHN_C10.pdf} 
  \includegraphics[width=.28\textwidth]{DenseNet_SVHN_LSUN.pdf} 
  \includegraphics[width=.28\textwidth]{DenseNet_SVHN_IMAGE.pdf} 
\end{tabular}\label{fig:odin_lid_our_densenet_svhn}}
\vspace{-0.1in}
\caption{Distinguishing in- and out-of-distribution test set data for image classification using DenseNet.}
\label{fig:odin_lid_our_densenet}
\end{figure*}




\section{Evaluation on ImageNet dataset}

In this section, we verify the performance of the proposed method using the ImageNet 2012 classification dataset \citep{deng2009imagenet} that consists of 1000 classes. The models
are trained on the 1.28 million training images, and evaluated on the 50k validation images. For all experiments, we use the pre-trained ResNet \citep{he2016deep} which is available at \url{https://github.com/pytorch/vision/blob/master/torchvision/models/resnet.py}. First, we measure the classification accuracy of generative classifier from the pre-trained model as follows: 

where  is an empirical class prior.
We remark that this corresponds to predicting a class label using the posterior distribution from generative with LDA assumption.
Table \ref{tbl:acc_imagenet} shows the top-1 classification accuracy on ImageNet 2012 dataset.
One can note that the proposed generative classifier can perform reasonably well even though the softmax classifier outperforms it in all cases.
However, we remark that the gap between them is decreasing as the training accuracy increases, i.e., the pre-trained model learned more strong representations.




\begin{table}[h]
\centering
\begin{tabular}{cccccccc}
\toprule
Model  & \begin{tabular}[c]{@{}c@{}} Softmax (training) \end{tabular}
 & \begin{tabular}[c]{@{}c@{}} Softmax (validation) \end{tabular} 
 & \begin{tabular}[c]{@{}c@{}} Generative (validation) \end{tabular} \\ \midrule
\multirow{1}{*}{\begin{tabular}[c]{@{}c@{}}ResNet (101 layers)\end{tabular}} & 86.55 & 75.66 & 73.49 \\
\multirow{1}{*}{\begin{tabular}[c]{@{}c@{}}ResNet (18 layers)\end{tabular}} & 69.06 & 68.69 & 63.32 \\
 \bottomrule
\end{tabular}
\vspace{+0.1in}
\caption{Top-1 accuracy (\%) of ResNets on ImageNet 2012 dataset.}
\label{tbl:acc_imagenet}
\end{table}


Next, we also evaluate the detection performance of the Mahalanobis distance-based detector on ImageNet 2012 dataset using ResNets with 18 layers.
For evaluation, we consider the problem of detecting adversarial samples generated by FGSM \citep{goodfellow2014explaining} and BIM \citep{kurakin2016adversarial}. 
Similar to Section \ref{sec:exp_adv}, 
we extract the confidence scores from every end of residual block of ResNet. Figure \ref{fig:imagenet_resnet18_FGSM} and \ref{fig:imagenet_resnet18_BIM} show the performance of various detectors.
One can note that the proposed Mahalanobis distance-based detector outperforms all tested methods including LID. 
These results imply that our method can be working well for the large-scale datasets. 



\begin{figure} [t] \centering
\vspace{-0.1in}
\subfigure[FGSM]
{
\includegraphics[width=0.22\textwidth]{ResNet18_IMAGE_ADV_FGSM.pdf} \label{fig:imagenet_resnet18_FGSM}} 
\,
\subfigure[BIM]
{
\includegraphics[width=0.22\textwidth]{ResNet18_IMAGE_ADV_BIM.pdf} \label{fig:imagenet_resnet18_BIM}}
\,
\subfigure[Scenario 1]
{
\includegraphics[width=0.22\textwidth]{ResNet_Garbae_Scenario_1.pdf} \label{fig:garbage_s1}}
\,
\subfigure[Scenario 2]
{
\includegraphics[width=0.22\textwidth]{ResNet_Garbae_Scenario_2.pdf} \label{fig:garbage_s2}}
\cutcaptionup
\caption{(a)/(b) Distinguishing clean and adversarial samples using ResNet with 18 layers on ImageNet 2012 validation set. (c)/(d) Distinguishing clean and garbage samples using ResNet 18 layers trained on CIFAR-10 dataset.}
\cutcaptiondown
\vspace{+0.05in}
\label{fig:imagenet_resnet18}
\end{figure}



\begin{figure*} [t] \centering
  \includegraphics[width=1.0\textwidth]{Generated_samples.pdf} 
\caption{The generated garbage sample and its target class.}
\label{fig:garbage}
\end{figure*}

\section{Adaptive attacks against Mahalanobis distance-based detector}

In this section, we evaluate the robustness of our method by generating the garbage images which may fool the Mahalanobis distance-based detector in a white-box setting, i.e., one can access to the parameters of the classifier and that of the Mahalanobis distance-based detector.
Here, we remark that accessing the parameters of the Mahalanobis distance-based detector, i.e., sample means and covariance, is not mild assumption since the information about training data is required to compute them.
To attack our method, we generate a garbage images  by minimizing the Mahalanobis distance as follows:

where  is a target class.
We test two different scenarios using ResNet with 34 layers trained on CIFAR-10 dataset.
In the first scenario, 
we generate the garbage images only using a penultimate layer of DNNs. In the second scenario, we attack every end of residual block of ResNet.
Figure \ref{fig:garbage} shows the generated samples by minimizing the Mahalanobis distance.
Even though the generated sample looks like the random noise,
it successfully fools the pre-trained classifier, i.e., it is classified as the target class.
We measure the detection performance of the baseline \citep{hendrycks2016baseline}, ODIN \citep{liang2017principled}, LID \citep{ma2018characterizing} and the proposed Mahalanobis distance-based detector.
As shown in Figure \ref{fig:garbage_s1} and \ref{fig:garbage_s2},
our method can distinguish CIFAR-10 test and garbage images for both scenarios better than the tested methods.
In particular, we remark that the input pre-processing is very useful in detecting such garbage samples.
These results imply that our proposed method is robust to the attacks.

\iffalse
\subsection{Adaptive attack: optimization-based adversarial attack}

Formally, we generate an adversarial examples as follows:

where  is the label corresponding to the second largest output of the classifier,  is penalty parameter and  is a metric to quantify the distance between an original image and its adversarial counterpart.
\fi

\section{Hybrid inference of generative and discriminative classifiers}

In this paper, we show that the generative classifier can be very useful in characterizing the abnormal samples such as OOD and adversarial samples.
Here, a caveat is that the generative classifier might degrade the classification performance.
In order to handle this issue, 
we introduce a hybrid inference of generative and discriminative classifiers.
Given a generative classifier with GDA assumptions, 
the posterior distribution of generative classifier via Bayes rule is given as:

To match this with a standard softmax classifier's weights,
the parameters of the generative classifier have to satisfy the following conditions:

where  and  are weights and bias for a class , respectively. 
Using the empirical covariance  as shown in \eqref{eq:empirical_mean},
one can induce the parameters of another generative classifier which has same decision boundary with the softmax classifier as follows:

Here, we normalize the  to satisfy . 
Then, using this generative classifier, 
we define new hybrid posterior distribution which combines the softmax- and sample-based generative classifiers:

where  is a hyper-parameter. 
This hybrid model can be interpreted as ensemble of softmax and generative classifiers, and one can expect that it can improve the classification performance.
Table \ref{tbl:classification_acc} compares the classification accuracy of softmax, generative and hybrid classifiers.
One can note that the hybrid model improves the classification accuracy, where we determine the optimal tuning parameter between the two objectives using the validation set.
We also remark that such hybrid model can be useful in detecting the abnormal samples, where we pursue these tasks in the future.

\begin{table}[h]
\centering
\begin{tabular}{cccccccc}
\toprule
Model & Dataset & \begin{tabular}[c]{@{}c@{}} Softmax \end{tabular}
 & \begin{tabular}[c]{@{}c@{}} Generative \end{tabular} 
 & \begin{tabular}[c]{@{}c@{}} Hybrid \end{tabular} \\ \midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}}DenseNet\end{tabular}}&CIFAR-10 
& 95.16 & 94.76 & 95.00 \\
& CIFAR-100  & 77.64 & 74.01 & 77.71  \\ 
& SVHN &96.42 & 96.32 & 96.34 \\ \midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} ResNet\end{tabular}} &CIFAR-10 
& 93.61 & 94.13 & 94.11 \\
&CIFAR-100  & 78.08 & 77.86 & 77.96  \\
&SVHN & 96.62 & 96.58 & 96.59 \\ \bottomrule
\end{tabular}
\vspace{+0.1in}
\caption{Classification test set accuracy (\%) of DenseNet and ResNet on CIFAR-10, CIFAR-100 and SVHN datasets.}
\label{tbl:classification_acc}
\end{table}

\iffalse
\section{Comparison with Euclidean distance}

\begin{table}[h] 
\centering
\resizebox{0.93\columnwidth}{!}{
\begin{tabular}{@{}ccclclclll@{}}
\toprule
\multirow{2}{*}{\begin{tabular}[c]{@{}c@{}} In-dist \\ (model) \end{tabular}}
 & \multirow{2}{*}{\begin{tabular}[c]{@{}c@{}} Out-of-dist\end{tabular}}
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} TNR at TPR 95\% \end{tabular}}
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} AUROC \end{tabular}}
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} Detection accuracy \end{tabular}} 
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} AUPR in \end{tabular}} 
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} AUPR out \end{tabular}} \\\cline{3-7}  
\multicolumn{1}{c}{} & \multicolumn{1}{c}{} & \multicolumn{5}{c}{ Euclidean / Mahalanobis (ours)} \\ \midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} CIFAR-10 \DenseNet) \end{tabular}} 
& \multicolumn{1}{c}{SVHN} 
& \multicolumn{1}{c}{  / {\bf 82.1}}& \multicolumn{1}{c}{  / {\bf 97.2}}& \multicolumn{1}{c}{  / {\bf 91.4}}& \multicolumn{1}{c}{   / {\bf 93.9}}& \multicolumn{1}{c}{  / {\bf 99.0}}\\
& \multicolumn{1}{c}{TinyImageNet} 
& \multicolumn{1}{c}{  / {\bf 86.6}}& \multicolumn{1}{c}{  / {\bf 97.3}}& \multicolumn{1}{c}{  / {\bf 92.0}}& \multicolumn{1}{c}{  / {\bf 97.6}}& \multicolumn{1}{c}{  / {\bf 97.0}}\\
& \multicolumn{1}{c}{LSUN} 
& \multicolumn{1}{c}{  / {\bf 91.2}}& \multicolumn{1}{c}{ / {\bf 97.8}}& \multicolumn{1}{c}{ / {\bf 93.8}}& \multicolumn{1}{c}{  / {\bf 98.1}}& \multicolumn{1}{c}{  / {\bf 97.2}}\\ \midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} SVHN \ResNet) \end{tabular}} 
& \multicolumn{1}{c}{SVHN} 
& \multicolumn{1}{c}{  / {\bf 97.4}}& \multicolumn{1}{c}{  / {\bf 99.2}}& \multicolumn{1}{c}{  / {\bf 96.2}}& \multicolumn{1}{c}{  / {\bf 98.3}}& \multicolumn{1}{c}{  / {\bf 99.7}}\\
& \multicolumn{1}{c}{TinyImageNet} 
& \multicolumn{1}{c}{ 94.1 / {\bf 97.8}}& \multicolumn{1}{c}{ 98.8 / {\bf 99.5}}& \multicolumn{1}{c}{ 94.6 / {\bf 96.8}}& \multicolumn{1}{c}{  98.7/ {\bf 99.5}}& \multicolumn{1}{c}{ 98.9 / {\bf 99.5}}\\
& \multicolumn{1}{c}{LSUN} 
& \multicolumn{1}{c}{ 97.4 / {\bf 99.3}}& \multicolumn{1}{c}{ 99.4 / {\bf 99.8}}& \multicolumn{1}{c}{ 96.6 / {\bf 98.2}}& \multicolumn{1}{c}{ 99.2 / {\bf 99.8}}& \multicolumn{1}{c}{ 99.5/ {\bf 99.7}}\\
\midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} CIFAR-100 \ResNet) \end{tabular}} 
& \multicolumn{1}{c}{CIFAR-10} 
& \multicolumn{1}{c}{ 95.7 / {\bf 98.6}}& \multicolumn{1}{c}{ 98.8 / {\bf 99.3}}& \multicolumn{1}{c}{ 95.4 / {\bf 97.0}}& \multicolumn{1}{c}{ 99.6  / {\bf 99.7}}& \multicolumn{1}{c}{ 96.0 / {\bf 97.0}}\\
& \multicolumn{1}{c}{TinyImageNet} 
& \multicolumn{1}{c}{ 98.5 / {\bf 99.9}}& \multicolumn{1}{c}{ 99.5 / {\bf 99.9}}& \multicolumn{1}{c}{ 97.1 / {\bf 99.1}}& \multicolumn{1}{c}{  99.8 / {\bf 99.9}}& \multicolumn{1}{c}{ 98.0 / {\bf 99.2}}\\
& \multicolumn{1}{c}{LSUN} 
& \multicolumn{1}{c}{  98.2/ {\bf 99.9}}& \multicolumn{1}{c}{ 99.4 / {\bf 99.9}}& \multicolumn{1}{c}{ 96.8 / {\bf 99.5}}& \multicolumn{1}{c}{ 99.8 / {\bf 99.9}}& \multicolumn{1}{c}{ 97.3 / {\bf 99.1}}\\ 
\bottomrule
\end{tabular}}
\vspace{+0.02in}
\caption{
Distinguishing in- and out-of-distribution test set data for image classification.
We use the feature ensemble and input pre-processing for all cases. We tune the hyper-parameters using validation set of in- and out-of-distributions. All values are percentages and the best results are indicated in bold.}
\label{tbl:ED_vs_Ours}
\end{table}
\fi
\iffalse
\begin{table}[h] 
\centering
\resizebox{0.93\columnwidth}{!}{
\begin{tabular}{@{}ccclclclll@{}}
\toprule
\multirow{2}{*}{\begin{tabular}[c]{@{}c@{}} Model \end{tabular}}
 & \multirow{2}{*}{\begin{tabular}[c]{@{}c@{}} In-dist\end{tabular}}
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} TNR at TPR 95\% \end{tabular}}
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} AUROC \end{tabular}}
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} Detection accuracy \end{tabular}} 
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} AUPR in \end{tabular}} 
& \multicolumn{1}{c}{\begin{tabular}[c]{@{}c@{}} AUPR out \end{tabular}} \\\cline{3-7}  
\multicolumn{1}{c}{} & \multicolumn{1}{c}{} & \multicolumn{5}{c}{ Euclidean / Mahalanobis (ours)} \\ \midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} DenseNet \end{tabular}} 
& \multicolumn{1}{c}{CIFAR-10} 
& \multicolumn{1}{c}{ 91.8 / {\bf 91.2}}& \multicolumn{1}{c}{ 98.3 / {\bf 98.2}}& \multicolumn{1}{c}{ 93.6 / {\bf 93.5}}& \multicolumn{1}{c}{ 94.1 / {\bf 95.8}}& \multicolumn{1}{c}{  99.6 / {\bf 99.4}}\\
& \multicolumn{1}{c}{CIFAR-100} 
& \multicolumn{1}{c}{ 83.1 / {\bf 95.3}}& \multicolumn{1}{c}{ 96.4 / {\bf 99.0}}& \multicolumn{1}{c}{ 90.6 / {\bf 95.3}}& \multicolumn{1}{c}{ 87.8 / {\bf 98.9}}& \multicolumn{1}{c}{ 99.2 / {\bf 98.9}}\\
& \multicolumn{1}{c}{SVHN} 
& \multicolumn{1}{c}{ 92.9 / {\bf 97.5}}& \multicolumn{1}{c}{ 98.3 / {\bf 99.3}}& \multicolumn{1}{c}{ 94.3 / {\bf 96.5}}& \multicolumn{1}{c}{ 98.4 / {\bf 99.3}}& \multicolumn{1}{c}{ 98.1 / {\bf 99.2}}\\
\midrule
\multirow{3}{*}{\begin{tabular}[c]{@{}c@{}} ResNet \end{tabular}} 
& \multicolumn{1}{c}{CIFAR-10} 
& \multicolumn{1}{c}{ 95.7 / {\bf 98.6}}& \multicolumn{1}{c}{ 98.8 / {\bf 99.3}}& \multicolumn{1}{c}{ 95.4 / {\bf 97.0}}& \multicolumn{1}{c}{ 99.6  / {\bf 99.7}}& \multicolumn{1}{c}{ 96.0 / {\bf 97.0}}\\
93.269 98.577 94.246 94.321 99.686
& \multicolumn{1}{c}{CIFAR-100} 
& \multicolumn{1}{c}{ 98.5 / {\bf 99.9}}& \multicolumn{1}{c}{ 99.5 / {\bf 99.9}}& \multicolumn{1}{c}{ 97.1 / {\bf 99.1}}& \multicolumn{1}{c}{  99.8 / {\bf 99.9}}& \multicolumn{1}{c}{ 98.0 / {\bf 99.2}}\\
69.388 88.950 85.973 46.710 97.547
& \multicolumn{1}{c}{SVHN} 
& \multicolumn{1}{c}{  98.2/ {\bf 99.9}}& \multicolumn{1}{c}{ 99.4 / {\bf 99.9}}& \multicolumn{1}{c}{ 96.8 / {\bf 99.5}}& \multicolumn{1}{c}{ 99.8 / {\bf 99.9}}& \multicolumn{1}{c}{ 97.3 / {\bf 99.1}}\\ 
99.411 99.737 97.881 99.723 99.637
\bottomrule
\end{tabular}}
\vspace{+0.02in}
\caption{
Distinguishing in- and out-of-distribution test set data when the all Images dataset is used as out-of-distribution.
We use the feature ensemble and input pre-processing for all cases. We tune the hyper-parameters using validation set of in- and out-of-distributions. All values are percentages and the best results are indicated in bold.}
\label{tbl:ED_vs_Ours}
\end{table}
\fi

\end{document}
